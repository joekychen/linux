<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › base › power › domain.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>domain.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/base/power/domain.c - Common code related to device power domains.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Rafael J. Wysocki &lt;rjw@sisk.pl&gt;, Renesas Electronics Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPLv2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/pm_domain.h&gt;</span>
<span class="cp">#include &lt;linux/pm_qos.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#define GENPD_DEV_CALLBACK(genpd, type, callback, dev)		\</span>
<span class="cp">({								\</span>
<span class="cp">	type (*__routine)(struct device *__d); 			\</span>
<span class="cp">	type __ret = (type)0;					\</span>
<span class="cp">								\</span>
<span class="cp">	__routine = genpd-&gt;dev_ops.callback; 			\</span>
<span class="cp">	if (__routine) {					\</span>
<span class="cp">		__ret = __routine(dev); 			\</span>
<span class="cp">	} else {						\</span>
<span class="cp">		__routine = dev_gpd_data(dev)-&gt;ops.callback;	\</span>
<span class="cp">		if (__routine) 					\</span>
<span class="cp">			__ret = __routine(dev);			\</span>
<span class="cp">	}							\</span>
<span class="cp">	__ret;							\</span>
<span class="cp">})</span>

<span class="cp">#define GENPD_DEV_TIMED_CALLBACK(genpd, type, callback, dev, field, name)	\</span>
<span class="cp">({										\</span>
<span class="cp">	ktime_t __start = ktime_get();						\</span>
<span class="cp">	type __retval = GENPD_DEV_CALLBACK(genpd, type, callback, dev);		\</span>
<span class="cp">	s64 __elapsed = ktime_to_ns(ktime_sub(ktime_get(), __start));		\</span>
<span class="cp">	struct gpd_timing_data *__td = &amp;dev_gpd_data(dev)-&gt;td;			\</span>
<span class="cp">	if (!__retval &amp;&amp; __elapsed &gt; __td-&gt;field) {				\</span>
<span class="cp">		__td-&gt;field = __elapsed;					\</span>
<span class="cp">		dev_warn(dev, name &quot; latency exceeded, new value %lld ns\n&quot;,	\</span>
<span class="cp">			__elapsed);						\</span>
<span class="cp">		genpd-&gt;max_off_time_changed = true;				\</span>
<span class="cp">		__td-&gt;constraint_changed = true;				\</span>
<span class="cp">	}									\</span>
<span class="cp">	__retval;								\</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">gpd_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">gpd_list_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="nf">dev_to_genpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pd_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_stop_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_TIMED_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">stop_latency_ns</span><span class="p">,</span> <span class="s">&quot;stop&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_start_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_TIMED_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">start_latency_ns</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_save_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_TIMED_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">save_state</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">save_state_latency_ns</span><span class="p">,</span> <span class="s">&quot;state save&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_restore_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_TIMED_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">restore_state</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">restore_state_latency_ns</span><span class="p">,</span>
					<span class="s">&quot;state restore&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">genpd_sd_counter_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genpd_sd_counter_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genpd_acquire_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for the domain to transition into either the active,</span>
<span class="cm">	 * or the power off state.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_ACTIVE</span>
		    <span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">schedule</span><span class="p">();</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genpd_release_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genpd_set_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">resume_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_genpd_poweron - Restore power to a given PM domain and its masters.</span>
<span class="cm"> * @genpd: PM domain to power up.</span>
<span class="cm"> *</span>
<span class="cm"> * Restore power to @genpd and all of its masters so that it is possible to</span>
<span class="cm"> * resume a device belonging to it.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_genpd_poweron</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpd_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the domain&#39;s master is being waited for, we have to wait too. */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_WAIT_MASTER</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">schedule</span><span class="p">();</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_ACTIVE</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genpd_set_active</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The list is guaranteed not to change while the loop below is being</span>
<span class="cm">	 * executed, unless one of the masters&#39; .power_on() callbacks fiddles</span>
<span class="cm">	 * with it.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">slave_links</span><span class="p">,</span> <span class="n">slave_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genpd_sd_counter_inc</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_WAIT_MASTER</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_genpd_poweron</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The &quot;wait for parent&quot; status is guaranteed not to change</span>
<span class="cm">		 * while the master is powering on.</span>
<span class="cm">		 */</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">;</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd_sd_counter_dec</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ktime_t</span> <span class="n">time_start</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
		<span class="n">s64</span> <span class="n">elapsed_ns</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_on</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">elapsed_ns</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">(),</span> <span class="n">time_start</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elapsed_ns</span> <span class="o">&gt;</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_on_latency_ns</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_on_latency_ns</span> <span class="o">=</span> <span class="n">elapsed_ns</span><span class="p">;</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Power-on latency exceeded, &quot;</span>
					<span class="s">&quot;new value %lld ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">elapsed_ns</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">genpd_set_active</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">list_for_each_entry_continue_reverse</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">slave_links</span><span class="p">,</span> <span class="n">slave_node</span><span class="p">)</span>
		<span class="n">genpd_sd_counter_dec</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_poweron - Restore power to a given PM domain and its masters.</span>
<span class="cm"> * @genpd: PM domain to power up.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_genpd_poweron</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__pm_genpd_poweron</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_dev_pm_qos_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">gpd_data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">generic_pm_domain_data</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">pdd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span> <span class="o">?</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">.</span><span class="n">constraint_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">genpd</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODATA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_genpd_save_device - Save the pre-suspend state of a device.</span>
<span class="cm"> * @pdd: Domain data of the device to save the state of.</span>
<span class="cm"> * @genpd: PM domain the device belongs to.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pm_genpd_save_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span> <span class="o">=</span> <span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">need_restore</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">genpd_start_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">genpd_save_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">genpd_stop_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">need_restore</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_genpd_restore_device - Restore the pre-suspend state of a device.</span>
<span class="cm"> * @pdd: Domain data of the device to restore the state of.</span>
<span class="cm"> * @genpd: PM domain the device belongs to.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pm_genpd_restore_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span> <span class="o">=</span> <span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">need_restore</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">genpd_start_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">genpd_restore_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">genpd_stop_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">need_restore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * genpd_abort_poweroff - Check if a PM domain power off should be aborted.</span>
<span class="cm"> * @genpd: PM domain to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Return true if a PM domain&#39;s status changed to GPD_STATE_ACTIVE during</span>
<span class="cm"> * a &quot;power off&quot; operation, which means that a &quot;power on&quot; has occured in the</span>
<span class="cm"> * meantime, or if its resume_count field is different from zero, which means</span>
<span class="cm"> * that one of its devices has been resumed in the meantime.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">genpd_abort_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_WAIT_MASTER</span>
		<span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_ACTIVE</span> <span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">resume_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * genpd_queue_power_off_work - Queue up the execution of pm_genpd_poweroff().</span>
<span class="cm"> * @genpd: PM domait to power off.</span>
<span class="cm"> *</span>
<span class="cm"> * Queue up the execution of pm_genpd_poweroff() unless it&#39;s already been done</span>
<span class="cm"> * before.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">genpd_queue_power_off_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off_work</span><span class="p">))</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">pm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_poweroff - Remove power from a given PM domain.</span>
<span class="cm"> * @genpd: PM domain to power down.</span>
<span class="cm"> *</span>
<span class="cm"> * If all of the @genpd&#39;s devices have been suspended and all of its subdomains</span>
<span class="cm"> * have been powered down, run the runtime suspend callbacks provided by all of</span>
<span class="cm"> * the @genpd&#39;s devices&#39; drivers and remove power from @genpd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpd_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">not_suspended</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">start:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do not try to power off the domain in the following situations:</span>
<span class="cm">	 * (1) The domain is already in the &quot;power off&quot; state.</span>
<span class="cm">	 * (2) The domain is waiting for its master to power up.</span>
<span class="cm">	 * (3) One of the domain&#39;s devices is being resumed right now.</span>
<span class="cm">	 * (4) System suspend is in progress.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span>
	    <span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_WAIT_MASTER</span>
	    <span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">resume_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">not_suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pdd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span> <span class="o">||</span> <span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">))</span>
			<span class="n">not_suspended</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">not_suspended</span> <span class="o">&gt;</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">in_progress</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Another instance of pm_genpd_poweroff() is executing</span>
<span class="cm">		 * callbacks, so tell it to start over and return.</span>
<span class="cm">		 */</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_REPEAT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gov</span> <span class="o">&amp;&amp;</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gov</span><span class="o">-&gt;</span><span class="n">power_down_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gov</span><span class="o">-&gt;</span><span class="n">power_down_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_BUSY</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>

	<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">pdd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
			<span class="n">__pm_genpd_save_device</span><span class="p">(</span><span class="n">pdd</span><span class="p">,</span> <span class="n">genpd</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">genpd_abort_poweroff</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd_set_active</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_REPEAT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ktime_t</span> <span class="n">time_start</span><span class="p">;</span>
		<span class="n">s64</span> <span class="n">elapsed_ns</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">time_start</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * If sd_count &gt; 0 at this point, one of the subdomains hasn&#39;t</span>
<span class="cm">		 * managed to call pm_genpd_poweron() for the master yet after</span>
<span class="cm">		 * incrementing it.  In that case pm_genpd_poweron() will wait</span>
<span class="cm">		 * for us to drop the lock, so we can call .power_off() and let</span>
<span class="cm">		 * the pm_genpd_poweron() restore power for us (this shouldn&#39;t</span>
<span class="cm">		 * happen very often).</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd_set_active</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">elapsed_ns</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">(),</span> <span class="n">time_start</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elapsed_ns</span> <span class="o">&gt;</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off_latency_ns</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off_latency_ns</span> <span class="o">=</span> <span class="n">elapsed_ns</span><span class="p">;</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Power-off latency exceeded, &quot;</span>
					<span class="s">&quot;new value %lld ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">elapsed_ns</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">slave_links</span><span class="p">,</span> <span class="n">slave_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genpd_sd_counter_dec</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
		<span class="n">genpd_queue_power_off_work</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * genpd_power_off_work_fn - Power off PM domain whose subdomain count is 0.</span>
<span class="cm"> * @work: Work structure used for scheduling the execution of this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">genpd_power_off_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">generic_pm_domain</span><span class="p">,</span> <span class="n">power_off_work</span><span class="p">);</span>

	<span class="n">genpd_acquire_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">pm_genpd_poweroff</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_runtime_suspend - Suspend a device belonging to I/O PM domain.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out a runtime suspend of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a PM domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">stop_ok</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">might_sleep_if</span><span class="p">(</span><span class="o">!</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_irq_safe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">stop_ok</span> <span class="o">=</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gov</span> <span class="o">?</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gov</span><span class="o">-&gt;</span><span class="n">stop_ok</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stop_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">genpd_stop_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If power.irq_safe is set, this routine will be run with interrupts</span>
<span class="cm">	 * off, so it can&#39;t use mutexes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">in_progress</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pm_genpd_poweroff</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">in_progress</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_runtime_resume - Resume a device belonging to I/O PM domain.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out a runtime resume of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a PM domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">might_sleep_if</span><span class="p">(</span><span class="o">!</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_irq_safe</span><span class="p">);</span>

	<span class="cm">/* If power.irq_safe, the PM domain is never powered off. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__pm_genpd_poweron</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_BUSY</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">resume_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If current is the powering off task, we have been called</span>
<span class="cm">		 * reentrantly from one of the device callbacks, so we should</span>
<span class="cm">		 * not wait.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span> <span class="o">||</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">schedule</span><span class="p">();</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">__pm_genpd_restore_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">,</span> <span class="n">genpd</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">resume_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">genpd_set_active</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">genpd_start_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_poweroff_unused - Power off all PM domains with no devices in use.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_genpd_poweroff_unused</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_list_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpd_list</span><span class="p">,</span> <span class="n">gpd_list_node</span><span class="p">)</span>
		<span class="n">genpd_queue_power_off_work</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">genpd_dev_pm_qos_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">genpd_power_off_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#define pm_genpd_runtime_suspend	NULL</span>
<span class="cp">#define pm_genpd_runtime_resume		NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM_RUNTIME */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">genpd_dev_active_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">active_wakeup</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_suspend_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">suspend</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_suspend_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">suspend_late</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_resume_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">resume_early</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_resume_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">resume</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_freeze_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">freeze</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_freeze_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">freeze_late</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_thaw_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">thaw_early</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">genpd_thaw_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GENPD_DEV_CALLBACK</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">thaw</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_sync_poweroff - Synchronously power off a PM domain and its masters.</span>
<span class="cm"> * @genpd: PM domain to power off, if possible.</span>
<span class="cm"> *</span>
<span class="cm"> * Check if the given PM domain can be powered off (during system suspend or</span>
<span class="cm"> * hibernation) and do that if so.  Also, in that case propagate to its masters.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is only called in &quot;noirq&quot; stages of system power transitions,</span>
<span class="cm"> * so it need not acquire locks (all of the &quot;noirq&quot; callbacks are executed</span>
<span class="cm"> * sequentially, so it is guaranteed that it will never run twice in parallel).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_genpd_sync_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpd_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspended_count</span> <span class="o">!=</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">device_count</span>
	    <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">)</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">slave_links</span><span class="p">,</span> <span class="n">slave_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genpd_sd_counter_dec</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
		<span class="n">pm_genpd_sync_poweroff</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * resume_needed - Check whether to resume a device before system suspend.</span>
<span class="cm"> * @dev: Device to check.</span>
<span class="cm"> * @genpd: PM domain the device belongs to.</span>
<span class="cm"> *</span>
<span class="cm"> * There are two cases in which a device that can wake up the system from sleep</span>
<span class="cm"> * states should be resumed by pm_genpd_prepare(): (1) if the device is enabled</span>
<span class="cm"> * to wake up the system and it has to remain active for this purpose while the</span>
<span class="cm"> * system is in the sleep state and (2) if the device is not enabled to wake up</span>
<span class="cm"> * the system from sleep states and it generally doesn&#39;t generate wakeup signals</span>
<span class="cm"> * by itself (those signals are generated on its behalf by other parts of the</span>
<span class="cm"> * system).  In the latter case it may be necessary to reconfigure the device&#39;s</span>
<span class="cm"> * wakeup settings during system suspend, because it may have been set up to</span>
<span class="cm"> * signal remote wakeup from the system&#39;s working state as needed by runtime PM.</span>
<span class="cm"> * Return &#39;true&#39; in either of the above cases.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">resume_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">active_wakeup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">active_wakeup</span> <span class="o">=</span> <span class="n">genpd_dev_active_wakeup</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">active_wakeup</span> <span class="o">:</span> <span class="o">!</span><span class="n">active_wakeup</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_prepare - Start power transition of a device in a PM domain.</span>
<span class="cm"> * @dev: Device to start the transition of.</span>
<span class="cm"> *</span>
<span class="cm"> * Start a power transition of a device (during a system-wide power transition)</span>
<span class="cm"> * under the assumption that its pm_domain field points to the domain member of</span>
<span class="cm"> * an object of type struct generic_pm_domain representing a PM domain</span>
<span class="cm"> * consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a wakeup request is pending for the device, it should be woken up</span>
<span class="cm">	 * at this point and a system wakeup event should be reported if it&#39;s</span>
<span class="cm">	 * set up to wake up the system from sleep states.</span>
<span class="cm">	 */</span>
	<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_runtime_barrier</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pm_wakeup_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_wakeup_pending</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resume_needed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">genpd</span><span class="p">))</span>
		<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">genpd_acquire_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspended_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">=</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The PM domain must be in the GPD_STATE_ACTIVE state at this point,</span>
<span class="cm">	 * so pm_genpd_poweron() will return immediately, but if the device</span>
<span class="cm">	 * is suspended (e.g. it&#39;s been stopped by genpd_stop_dev()), we need</span>
<span class="cm">	 * to make it operational.</span>
<span class="cm">	 */</span>
	<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__pm_runtime_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_generic_prepare</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_suspend - Suspend a device belonging to an I/O PM domain.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> *</span>
<span class="cm"> * Suspend a device under the assumption that its pm_domain field points to the</span>
<span class="cm"> * domain member of an object of type struct generic_pm_domain representing</span>
<span class="cm"> * a PM domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_suspend_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_suspend_late - Late suspend of a device from an I/O PM domain.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out a late suspend of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a PM domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_suspend_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_suspend_late</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_suspend_noirq - Completion of suspend of device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> *</span>
<span class="cm"> * Stop the device and remove power from the domain if all devices in it have</span>
<span class="cm"> * been stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_suspend_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">||</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wakeup_path</span> <span class="o">&amp;&amp;</span> <span class="n">genpd_dev_active_wakeup</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">genpd_stop_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since all of the &quot;noirq&quot; callbacks are executed sequentially, it is</span>
<span class="cm">	 * guaranteed that this function will never run twice in parallel for</span>
<span class="cm">	 * the same PM domain, so it is not necessary to use locking here.</span>
<span class="cm">	 */</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspended_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pm_genpd_sync_poweroff</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_resume_noirq - Start of resume of device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> *</span>
<span class="cm"> * Restore power to the device&#39;s PM domain, if necessary, and start the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_resume_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">||</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wakeup_path</span> <span class="o">&amp;&amp;</span> <span class="n">genpd_dev_active_wakeup</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since all of the &quot;noirq&quot; callbacks are executed sequentially, it is</span>
<span class="cm">	 * guaranteed that this function will never run twice in parallel for</span>
<span class="cm">	 * the same PM domain, so it is not necessary to use locking here.</span>
<span class="cm">	 */</span>
	<span class="n">pm_genpd_poweron</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspended_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd_start_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_resume_early - Early resume of a device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out an early resume of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a power domain consisting of I/O</span>
<span class="cm"> * devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_resume_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_resume_early</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_resume - Resume of device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> *</span>
<span class="cm"> * Resume a device under the assumption that its pm_domain field points to the</span>
<span class="cm"> * domain member of an object of type struct generic_pm_domain representing</span>
<span class="cm"> * a power domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_resume_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_freeze - Freezing a device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to freeze.</span>
<span class="cm"> *</span>
<span class="cm"> * Freeze a device under the assumption that its pm_domain field points to the</span>
<span class="cm"> * domain member of an object of type struct generic_pm_domain representing</span>
<span class="cm"> * a power domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_freeze_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_freeze_late - Late freeze of a device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to freeze.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out a late freeze of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a power domain consisting of I/O</span>
<span class="cm"> * devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_freeze_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_freeze_late</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_freeze_noirq - Completion of freezing a device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to freeze.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out a late freeze of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a power domain consisting of I/O</span>
<span class="cm"> * devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_freeze_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">||</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span> <span class="o">?</span>
		<span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_stop_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_thaw_noirq - Early thaw of device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to thaw.</span>
<span class="cm"> *</span>
<span class="cm"> * Start the device, unless power has been removed from the domain already</span>
<span class="cm"> * before the system transition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_thaw_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">||</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span> <span class="o">?</span>
		<span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_start_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_thaw_early - Early thaw of device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to thaw.</span>
<span class="cm"> *</span>
<span class="cm"> * Carry out an early thaw of a device under the assumption that its</span>
<span class="cm"> * pm_domain field points to the domain member of an object of type</span>
<span class="cm"> * struct generic_pm_domain representing a power domain consisting of I/O</span>
<span class="cm"> * devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_thaw_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_thaw_early</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_thaw - Thaw a device belonging to an I/O power domain.</span>
<span class="cm"> * @dev: Device to thaw.</span>
<span class="cm"> *</span>
<span class="cm"> * Thaw a device under the assumption that its pm_domain field points to the</span>
<span class="cm"> * domain member of an object of type struct generic_pm_domain representing</span>
<span class="cm"> * a power domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_thaw_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_restore_noirq - Start of restore of device in an I/O PM domain.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> *</span>
<span class="cm"> * Make sure the domain will be in the same power state as before the</span>
<span class="cm"> * hibernation the system is resuming from and start the device if necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_restore_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since all of the &quot;noirq&quot; callbacks are executed sequentially, it is</span>
<span class="cm">	 * guaranteed that this function will never run twice in parallel for</span>
<span class="cm">	 * the same PM domain, so it is not necessary to use locking here.</span>
<span class="cm">	 *</span>
<span class="cm">	 * At this point suspended_count == 0 means we are being run for the</span>
<span class="cm">	 * first time for the given domain in the present cycle.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspended_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The boot kernel might put the domain into arbitrary state,</span>
<span class="cm">		 * so make it appear as powered off to pm_genpd_poweron(), so</span>
<span class="cm">		 * that it tries to power it on in case it was really off.</span>
<span class="cm">		 */</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the domain was off before the hibernation, make</span>
<span class="cm">			 * sure it will be off going forward.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">)</span>
				<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_genpd_poweron</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">genpd_start_dev</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_complete - Complete power transition of a device in a power domain.</span>
<span class="cm"> * @dev: Device to complete the transition of.</span>
<span class="cm"> *</span>
<span class="cm"> * Complete a power transition of a device (during a system-wide power</span>
<span class="cm"> * transition) under the assumption that its pm_domain field points to the</span>
<span class="cm"> * domain member of an object of type struct generic_pm_domain representing</span>
<span class="cm"> * a power domain consisting of I/O devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_genpd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">run_complete</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">genpd</span> <span class="o">=</span> <span class="n">dev_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">run_complete</span> <span class="o">=</span> <span class="o">!</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">suspend_power_off</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">run_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_generic_complete</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define pm_genpd_prepare		NULL</span>
<span class="cp">#define pm_genpd_suspend		NULL</span>
<span class="cp">#define pm_genpd_suspend_late		NULL</span>
<span class="cp">#define pm_genpd_suspend_noirq		NULL</span>
<span class="cp">#define pm_genpd_resume_early		NULL</span>
<span class="cp">#define pm_genpd_resume_noirq		NULL</span>
<span class="cp">#define pm_genpd_resume			NULL</span>
<span class="cp">#define pm_genpd_freeze			NULL</span>
<span class="cp">#define pm_genpd_freeze_late		NULL</span>
<span class="cp">#define pm_genpd_freeze_noirq		NULL</span>
<span class="cp">#define pm_genpd_thaw_early		NULL</span>
<span class="cp">#define pm_genpd_thaw_noirq		NULL</span>
<span class="cp">#define pm_genpd_thaw			NULL</span>
<span class="cp">#define pm_genpd_restore_noirq		NULL</span>
<span class="cp">#define pm_genpd_complete		NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM_SLEEP */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * __pm_genpd_add_device - Add a device to an I/O PM domain.</span>
<span class="cm"> * @genpd: PM domain to add the device to.</span>
<span class="cm"> * @dev: Device to be added.</span>
<span class="cm"> * @td: Set of PM QoS timing parameters to attach to the device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_genpd_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">gpd_timing_data</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">genpd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gpd_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gpd_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpd_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">genpd_dev_pm_qos_notifier</span><span class="p">;</span>
	<span class="n">dev_pm_qos_add_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>

	<span class="n">genpd_acquire_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pdd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">device_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dev_pm_get_subsys_data</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">need_restore</span> <span class="o">=</span> <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span>
		<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">td</span> <span class="o">=</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">.</span><span class="n">constraint_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">.</span><span class="n">effective_constraint_ns</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="n">dev_pm_qos_remove_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gpd_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_genpd_of_add_device - Add a device to an I/O PM domain.</span>
<span class="cm"> * @genpd_node: Device tree node pointer representing a PM domain to which the</span>
<span class="cm"> *   the device is added to.</span>
<span class="cm"> * @dev: Device to be added.</span>
<span class="cm"> * @td: Set of PM QoS timing parameters to attach to the device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_genpd_of_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">genpd_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">gpd_timing_data</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">gpd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">genpd_node</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gpd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpd_list</span><span class="p">,</span> <span class="n">gpd_list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpd</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">==</span> <span class="n">genpd_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">genpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_list_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">genpd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__pm_genpd_add_device</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_remove_device - Remove a device from an I/O PM domain.</span>
<span class="cm"> * @genpd: PM domain to remove the device from.</span>
<span class="cm"> * @dev: Device to be removed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_genpd_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">genpd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
	    <span class="o">||</span>  <span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span>
	    <span class="o">||</span>  <span class="n">pd_to_genpd</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="o">!=</span> <span class="n">genpd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">genpd_acquire_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">prepared_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">device_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pdd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">;</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdd</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">gpd_data</span> <span class="o">=</span> <span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pdd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="n">dev_pm_qos_remove_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gpd_data</span><span class="p">);</span>
	<span class="n">dev_pm_put_subsys_data</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_dev_always_on - Set/unset the &quot;always on&quot; flag for a given device.</span>
<span class="cm"> * @dev: Device to set/unset the flag for.</span>
<span class="cm"> * @val: The new value of the device&#39;s &quot;always on&quot; flag.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_genpd_dev_always_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_subsys_data</span> <span class="o">*</span><span class="n">psd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">psd</span> <span class="o">=</span> <span class="n">dev_to_psd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psd</span> <span class="o">&amp;&amp;</span> <span class="n">psd</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">)</span>
		<span class="n">to_gpd_data</span><span class="p">(</span><span class="n">psd</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">always_on</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_genpd_dev_always_on</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_dev_need_restore - Set/unset the device&#39;s &quot;need restore&quot; flag.</span>
<span class="cm"> * @dev: Device to set/unset the flag for.</span>
<span class="cm"> * @val: The new value of the device&#39;s &quot;need restore&quot; flag.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_genpd_dev_need_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_subsys_data</span> <span class="o">*</span><span class="n">psd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">psd</span> <span class="o">=</span> <span class="n">dev_to_psd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psd</span> <span class="o">&amp;&amp;</span> <span class="n">psd</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">)</span>
		<span class="n">to_gpd_data</span><span class="p">(</span><span class="n">psd</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">need_restore</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_genpd_dev_need_restore</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_add_subdomain - Add a subdomain to an I/O PM domain.</span>
<span class="cm"> * @genpd: Master PM domain to add the subdomain to.</span>
<span class="cm"> * @subdomain: Subdomain to be added.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_genpd_add_subdomain</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">subdomain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpd_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">genpd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">subdomain</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

 <span class="nl">start:</span>
	<span class="n">genpd_acquire_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_POWER_OFF</span>
	    <span class="o">&amp;&amp;</span> <span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span>
	    <span class="o">&amp;&amp;</span>  <span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">master_links</span><span class="p">,</span> <span class="n">master_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">==</span> <span class="n">subdomain</span> <span class="o">&amp;&amp;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">==</span> <span class="n">genpd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">link</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">genpd</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">master_links</span><span class="p">);</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="n">subdomain</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">slave_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">slave_links</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span>
		<span class="n">genpd_sd_counter_inc</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_remove_subdomain - Remove a subdomain from an I/O PM domain.</span>
<span class="cm"> * @genpd: Master PM domain to remove the subdomain from.</span>
<span class="cm"> * @subdomain: Subdomain to be removed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_genpd_remove_subdomain</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">subdomain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpd_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">genpd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">subdomain</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

 <span class="nl">start:</span>
	<span class="n">genpd_acquire_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">master_links</span><span class="p">,</span> <span class="n">master_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">!=</span> <span class="n">subdomain</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_POWER_OFF</span>
		    <span class="o">&amp;&amp;</span> <span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">master_node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">slave_node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span>
			<span class="n">genpd_sd_counter_dec</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subdomain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">genpd_release_lock</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_add_callbacks - Add PM domain callbacks to a given device.</span>
<span class="cm"> * @dev: Device to add the callbacks to.</span>
<span class="cm"> * @ops: Set of callbacks to add.</span>
<span class="cm"> * @td: Timing data to add to the device along with the callbacks (optional).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_genpd_add_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpd_dev_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">gpd_timing_data</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_pm_lock</span><span class="p">();</span>

	<span class="n">pdd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span> <span class="o">=</span> <span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">);</span>

		<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span>
			<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">td</span> <span class="o">=</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_pm_unlock</span><span class="p">();</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_genpd_add_callbacks</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_genpd_remove_callbacks - Remove PM domain callbacks from a given device.</span>
<span class="cm"> * @dev: Device to remove the callbacks from.</span>
<span class="cm"> * @clear_td: If set, clear the device&#39;s timing data too.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_genpd_remove_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clear_td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_domain_data</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_pm_lock</span><span class="p">();</span>

	<span class="n">pdd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">subsys_data</span><span class="o">-&gt;</span><span class="n">domain_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">generic_pm_domain_data</span> <span class="o">*</span><span class="n">gpd_data</span> <span class="o">=</span> <span class="n">to_gpd_data</span><span class="p">(</span><span class="n">pdd</span><span class="p">);</span>

		<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gpd_dev_ops</span><span class="p">){</span> <span class="mi">0</span> <span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear_td</span><span class="p">)</span>
			<span class="n">gpd_data</span><span class="o">-&gt;</span><span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gpd_timing_data</span><span class="p">){</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_pm_unlock</span><span class="p">();</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_genpd_remove_callbacks</span><span class="p">);</span>

<span class="cm">/* Default device callbacks for generic PM domains. */</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_save_state - Default &quot;save device state&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_save_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">save_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">pm</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_suspend</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_restore_state - Default PM domians &quot;restore device state&quot;.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_restore_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">restore_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">pm</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_resume</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_suspend - Default &quot;device suspend&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_suspend_late - Default &quot;late device suspend&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_suspend_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend_late</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_suspend_late</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_resume_early - Default &quot;early device resume&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_resume_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">resume_early</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_resume_early</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_resume - Default &quot;device resume&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">resume</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_freeze - Default &quot;device freeze&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">freeze</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_freeze</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_freeze_late - Default &quot;late device freeze&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_freeze_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">freeze_late</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_freeze_late</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_thaw_early - Default &quot;early device thaw&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_thaw_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">thaw_early</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_thaw_early</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_default_thaw - Default &quot;device thaw&quot; for PM domians.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_genpd_default_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">__dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">thaw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cb</span> <span class="o">?</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">pm_generic_thaw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_PM_SLEEP */</span><span class="cp"></span>

<span class="cp">#define pm_genpd_default_suspend	NULL</span>
<span class="cp">#define pm_genpd_default_suspend_late	NULL</span>
<span class="cp">#define pm_genpd_default_resume_early	NULL</span>
<span class="cp">#define pm_genpd_default_resume		NULL</span>
<span class="cp">#define pm_genpd_default_freeze		NULL</span>
<span class="cp">#define pm_genpd_default_freeze_late	NULL</span>
<span class="cp">#define pm_genpd_default_thaw_early	NULL</span>
<span class="cp">#define pm_genpd_default_thaw		NULL</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_PM_SLEEP */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * pm_genpd_init - Initialize a generic I/O PM domain object.</span>
<span class="cm"> * @genpd: PM domain object to initialize.</span>
<span class="cm"> * @gov: PM domain governor to associate with the domain (may be NULL).</span>
<span class="cm"> * @is_off: Initial value of the domain&#39;s power_is_off field.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_genpd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dev_power_governor</span> <span class="o">*</span><span class="n">gov</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">genpd</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">master_links</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">slave_links</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gov</span> <span class="o">=</span> <span class="n">gov</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off_work</span><span class="p">,</span> <span class="n">genpd_power_off_work_fn</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">sd_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">is_off</span> <span class="o">?</span> <span class="n">GPD_STATE_POWER_OFF</span> <span class="o">:</span> <span class="n">GPD_STATE_ACTIVE</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">status_wait_queue</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">poweroff_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">resume_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">device_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_ns</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">max_off_time_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">pm_genpd_runtime_suspend</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">pm_genpd_runtime_resume</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">runtime_idle</span> <span class="o">=</span> <span class="n">pm_generic_runtime_idle</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">pm_genpd_prepare</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pm_genpd_suspend</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend_late</span> <span class="o">=</span> <span class="n">pm_genpd_suspend_late</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend_noirq</span> <span class="o">=</span> <span class="n">pm_genpd_suspend_noirq</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">resume_noirq</span> <span class="o">=</span> <span class="n">pm_genpd_resume_noirq</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">resume_early</span> <span class="o">=</span> <span class="n">pm_genpd_resume_early</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pm_genpd_resume</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">pm_genpd_freeze</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">freeze_late</span> <span class="o">=</span> <span class="n">pm_genpd_freeze_late</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">freeze_noirq</span> <span class="o">=</span> <span class="n">pm_genpd_freeze_noirq</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">thaw_noirq</span> <span class="o">=</span> <span class="n">pm_genpd_thaw_noirq</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">thaw_early</span> <span class="o">=</span> <span class="n">pm_genpd_thaw_early</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">pm_genpd_thaw</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">poweroff</span> <span class="o">=</span> <span class="n">pm_genpd_suspend</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">poweroff_late</span> <span class="o">=</span> <span class="n">pm_genpd_suspend_late</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">poweroff_noirq</span> <span class="o">=</span> <span class="n">pm_genpd_suspend_noirq</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">restore_noirq</span> <span class="o">=</span> <span class="n">pm_genpd_restore_noirq</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">restore_early</span> <span class="o">=</span> <span class="n">pm_genpd_resume_early</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">pm_genpd_resume</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">pm_genpd_complete</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">save_state</span> <span class="o">=</span> <span class="n">pm_genpd_default_save_state</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">restore_state</span> <span class="o">=</span> <span class="n">pm_genpd_default_restore_state</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pm_genpd_default_suspend</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">suspend_late</span> <span class="o">=</span> <span class="n">pm_genpd_default_suspend_late</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">resume_early</span> <span class="o">=</span> <span class="n">pm_genpd_default_resume_early</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pm_genpd_default_resume</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">pm_genpd_default_freeze</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">freeze_late</span> <span class="o">=</span> <span class="n">pm_genpd_default_freeze_late</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">thaw_early</span> <span class="o">=</span> <span class="n">pm_genpd_default_thaw_early</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">pm_genpd_default_thaw</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">genpd</span><span class="o">-&gt;</span><span class="n">gpd_list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpd_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpd_list_lock</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
