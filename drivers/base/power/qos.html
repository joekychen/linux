<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › base › power › qos.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qos.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Devices PM QoS constraints management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This module exposes the interface to kernel space for specifying</span>
<span class="cm"> * per-device PM QoS dependencies. It provides infrastructure for registration</span>
<span class="cm"> * of:</span>
<span class="cm"> *</span>
<span class="cm"> * Dependents on a QoS value : register requests</span>
<span class="cm"> * Watchers of QoS value : get notified when target QoS value changes</span>
<span class="cm"> *</span>
<span class="cm"> * This QoS design is best effort based. Dependents register their QoS needs.</span>
<span class="cm"> * Watchers register to keep track of the current QoS needs of the system.</span>
<span class="cm"> * Watchers can register different types of notification callbacks:</span>
<span class="cm"> *  . a per-device notification callback using the dev_pm_qos_*_notifier API.</span>
<span class="cm"> *    The notification chain data is stored in the per-device constraint</span>
<span class="cm"> *    data struct.</span>
<span class="cm"> *  . a system-wide notification callback using the dev_pm_qos_*_global_notifier</span>
<span class="cm"> *    API. The notification chain data is stored in a static variable.</span>
<span class="cm"> *</span>
<span class="cm"> * Note about the per-device constraint data struct allocation:</span>
<span class="cm"> * . The per-device constraints data struct ptr is tored into the device</span>
<span class="cm"> *    dev_pm_info.</span>
<span class="cm"> * . To minimize the data usage by the per-device constraints, the data struct</span>
<span class="cm"> *   is only allocated at the first call to dev_pm_qos_add_request.</span>
<span class="cm"> * . The data is later free&#39;d when the device is removed from the system.</span>
<span class="cm"> *  . A global mutex protects the constraints users from the data being</span>
<span class="cm"> *     allocated and free&#39;d.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pm_qos.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &quot;power.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

<span class="k">static</span> <span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">dev_pm_notifiers</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __dev_pm_qos_read_value - Get PM QoS constraint for a given device.</span>
<span class="cm"> * @dev: Device to get the PM QoS constraint value for.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine must be called with dev-&gt;power.lock held.</span>
<span class="cm"> */</span>
<span class="n">s32</span> <span class="nf">__dev_pm_qos_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">c</span> <span class="o">?</span> <span class="n">pm_qos_read_value</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_read_value - Get PM QoS constraint for a given device (locked).</span>
<span class="cm"> * @dev: Device to get the PM QoS constraint value for.</span>
<span class="cm"> */</span>
<span class="n">s32</span> <span class="nf">dev_pm_qos_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dev_pm_qos_read_value</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * apply_constraint</span>
<span class="cm"> * @req: constraint request to apply</span>
<span class="cm"> * @action: action to perform add/update/remove, of type enum pm_qos_req_action</span>
<span class="cm"> * @value: defines the qos request</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function to update the constraints list using the PM QoS core</span>
<span class="cm"> * code and if needed call the per-device and the global notification</span>
<span class="cm"> * callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_constraint</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">pm_qos_req_action</span> <span class="n">action</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">curr_value</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_qos_update_target</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Call the global callbacks if needed */</span>
		<span class="n">curr_value</span> <span class="o">=</span> <span class="n">pm_qos_read_value</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">);</span>
		<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_notifiers</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">curr_value</span><span class="p">,</span>
					     <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dev_pm_qos_constraints_allocate</span>
<span class="cm"> * @dev: device to allocate data for</span>
<span class="cm"> *</span>
<span class="cm"> * Called at the first call to add_request, for constraint data allocation</span>
<span class="cm"> * Must be called with the dev_pm_qos_mtx mutex held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_pm_qos_constraints_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blocking_notifier_head</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BLOCKING_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

	<span class="n">plist_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">target_value</span> <span class="o">=</span> <span class="n">PM_QOS_DEV_LAT_DEFAULT_VALUE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">PM_QOS_DEV_LAT_DEFAULT_VALUE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM_QOS_MIN</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">notifiers</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_constraints_init - Initalize device&#39;s PM QoS constraints pointer.</span>
<span class="cm"> * @dev: target device</span>
<span class="cm"> *</span>
<span class="cm"> * Called from the device PM subsystem during device insertion under</span>
<span class="cm"> * device_pm_lock().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dev_pm_qos_constraints_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_constraints_destroy</span>
<span class="cm"> * @dev: target device</span>
<span class="cm"> *</span>
<span class="cm"> * Called from the device PM subsystem on device removal under device_pm_lock().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dev_pm_qos_constraints_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device&#39;s PM QoS resume latency limit has been exposed to user</span>
<span class="cm">	 * space, it has to be hidden at this point.</span>
<span class="cm">	 */</span>
	<span class="n">dev_pm_qos_hide_latency_limit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_INVALID</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Flush the constraints list for the device */</span>
	<span class="n">plist_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update constraints list and call the notification</span>
<span class="cm">		 * callbacks if needed</span>
<span class="cm">		 */</span>
		<span class="n">apply_constraint</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PM_QOS_REMOVE_REQ</span><span class="p">,</span> <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">notifiers</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_add_request - inserts new qos request into the list</span>
<span class="cm"> * @dev: target device for the constraint</span>
<span class="cm"> * @req: pointer to a preallocated handle</span>
<span class="cm"> * @value: defines the qos request</span>
<span class="cm"> *</span>
<span class="cm"> * This function inserts a new entry in the device constraints list of</span>
<span class="cm"> * requested qos performance characteristics. It recomputes the aggregate</span>
<span class="cm"> * QoS expectations of parameters and initializes the dev_pm_qos_request</span>
<span class="cm"> * handle.  Caller needs to save this handle for later use in updates and</span>
<span class="cm"> * removal.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the aggregated constraint value has changed,</span>
<span class="cm"> * 0 if the aggregated constraint value has not changed,</span>
<span class="cm"> * -EINVAL in case of wrong parameters, -ENOMEM if there&#39;s not enough memory</span>
<span class="cm"> * to allocate for data structures, -ENODEV if the device has just been removed</span>
<span class="cm"> * from the system.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_add_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			   <span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="cm">/*guard against callers passing in null */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">dev_pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		 <span class="s">&quot;%s() called for already added request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The device has been removed from the system. */</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Allocate the constraints data on the first call to</span>
<span class="cm">			 * add_request, i.e. only if the data is not already</span>
<span class="cm">			 * allocated and if the device has not been removed.</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_pm_qos_constraints_allocate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">apply_constraint</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PM_QOS_ADD_REQ</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_add_request</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_update_request - modifies an existing qos request</span>
<span class="cm"> * @req : handle to list element holding a dev_pm_qos request to use</span>
<span class="cm"> * @new_value: defines the qos request</span>
<span class="cm"> *</span>
<span class="cm"> * Updates an existing dev PM qos request along with updating the</span>
<span class="cm"> * target value.</span>
<span class="cm"> *</span>
<span class="cm"> * Attempts are made to make this code callable on hot code paths.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the aggregated constraint value has changed,</span>
<span class="cm"> * 0 if the aggregated constraint value has not changed,</span>
<span class="cm"> * -EINVAL in case of wrong parameters, -ENODEV if the device has been</span>
<span class="cm"> * removed from the system</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_update_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="n">s32</span> <span class="n">new_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="cm">/*guard against callers passing in null */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">dev_pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		 <span class="s">&quot;%s() called for unknown object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">prio</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">apply_constraint</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PM_QOS_UPDATE_REQ</span><span class="p">,</span>
					       <span class="n">new_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Return if the device has been removed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_update_request</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_remove_request - modifies an existing qos request</span>
<span class="cm"> * @req: handle to request list element</span>
<span class="cm"> *</span>
<span class="cm"> * Will remove pm qos request from the list of constraints and</span>
<span class="cm"> * recompute the current target value. Call this on slow code paths.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the aggregated constraint value has changed,</span>
<span class="cm"> * 0 if the aggregated constraint value has not changed,</span>
<span class="cm"> * -EINVAL in case of wrong parameters, -ENODEV if the device has been</span>
<span class="cm"> * removed from the system</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_remove_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="cm">/*guard against callers passing in null */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">dev_pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		 <span class="s">&quot;%s() called for unknown object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">apply_constraint</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PM_QOS_REMOVE_REQ</span><span class="p">,</span>
				       <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Return if the device has been removed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_remove_request</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_add_notifier - sets notification entry for changes to target value</span>
<span class="cm"> * of per-device PM QoS constraints</span>
<span class="cm"> *</span>
<span class="cm"> * @dev: target device for the constraint</span>
<span class="cm"> * @notifier: notifier block managed by caller.</span>
<span class="cm"> *</span>
<span class="cm"> * Will register the notifier into a notification chain that gets called</span>
<span class="cm"> * upon changes to the target value for the device.</span>
<span class="cm"> *</span>
<span class="cm"> * If the device&#39;s constraints object doesn&#39;t exist when this routine is called,</span>
<span class="cm"> * it will be created (or error code will be returned if that fails).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_add_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">PM_EVENT_INVALID</span> <span class="o">?</span>
			<span class="n">dev_pm_qos_constraints_allocate</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">notifiers</span><span class="p">,</span> <span class="n">notifier</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_add_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_remove_notifier - deletes notification for changes to target value</span>
<span class="cm"> * of per-device PM QoS constraints</span>
<span class="cm"> *</span>
<span class="cm"> * @dev: target device for the constraint</span>
<span class="cm"> * @notifier: notifier block to be removed.</span>
<span class="cm"> *</span>
<span class="cm"> * Will remove the notifier from the notification chain that gets called</span>
<span class="cm"> * upon changes to the target value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_remove_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>

	<span class="cm">/* Silently return if the constraints object is not present. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">notifiers</span><span class="p">,</span>
				<span class="n">notifier</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_qos_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_remove_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_add_global_notifier - sets notification entry for changes to</span>
<span class="cm"> * target value of the PM QoS constraints for any device</span>
<span class="cm"> *</span>
<span class="cm"> * @notifier: notifier block managed by caller.</span>
<span class="cm"> *</span>
<span class="cm"> * Will register the notifier into a notification chain that gets called</span>
<span class="cm"> * upon changes to the target value for any device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_add_global_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_notifiers</span><span class="p">,</span> <span class="n">notifier</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_add_global_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_remove_global_notifier - deletes notification for changes to</span>
<span class="cm"> * target value of PM QoS constraints for any device</span>
<span class="cm"> *</span>
<span class="cm"> * @notifier: notifier block to be removed.</span>
<span class="cm"> *</span>
<span class="cm"> * Will remove the notifier from the notification chain that gets called</span>
<span class="cm"> * upon changes to the target value for any device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_remove_global_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_pm_notifiers</span><span class="p">,</span> <span class="n">notifier</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_remove_global_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_add_ancestor_request - Add PM QoS request for device&#39;s ancestor.</span>
<span class="cm"> * @dev: Device whose ancestor to add the request for.</span>
<span class="cm"> * @req: Pointer to the preallocated handle.</span>
<span class="cm"> * @value: Constraint latency value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_add_ancestor_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ancestor</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ancestor</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ancestor</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span><span class="p">)</span>
		<span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">dev_pm_qos_add_request</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_add_ancestor_request</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__dev_pm_qos_drop_user_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_pm_qos_remove_request</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">pq_req</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">pq_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_expose_latency_limit - Expose PM QoS latency limit to user space.</span>
<span class="cm"> * @dev: Device whose PM QoS latency limit is to be exposed to user space.</span>
<span class="cm"> * @value: Initial value of the latency limit.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dev_pm_qos_expose_latency_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_is_registered</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">pq_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_pm_qos_add_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">pq_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_qos_sysfs_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">__dev_pm_qos_drop_user_request</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_expose_latency_limit</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * dev_pm_qos_hide_latency_limit - Hide PM QoS latency limit from user space.</span>
<span class="cm"> * @dev: Device whose PM QoS latency limit is to be hidden from user space.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dev_pm_qos_hide_latency_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">pq_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_qos_sysfs_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">__dev_pm_qos_drop_user_request</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dev_pm_qos_hide_latency_limit</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM_RUNTIME */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
