<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › base › power › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/base/power/main.c - Where the driver meets power management.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 Patrick Mochel</span>
<span class="cm"> * Copyright (c) 2003 Open Source Development Lab</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPLv2</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * The driver model core calls device_pm_add() when a device is registered.</span>
<span class="cm"> * This will initialize the embedded device_pm_info object in the device</span>
<span class="cm"> * and add it to the list of power-controlled devices. sysfs entries for</span>
<span class="cm"> * controlling device power management will also be added.</span>
<span class="cm"> *</span>
<span class="cm"> * A separate list is used for keeping track of power info, because the power</span>
<span class="cm"> * domain dependencies may differ from the ancestral dependencies that the</span>
<span class="cm"> * subsystem list maintains.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/resume-trace.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/async.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>

<span class="cp">#include &quot;../base.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pm_callback_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The entries in the dpm_list list are in a depth first order, simply</span>
<span class="cm"> * because children are guaranteed to be discovered after parents, and</span>
<span class="cm"> * are inserted at the back of the list on discovery.</span>
<span class="cm"> *</span>
<span class="cm"> * Since device_pm_add() may be called with a device lock held,</span>
<span class="cm"> * we must never try to acquire a device lock while holding</span>
<span class="cm"> * dpm_list_mutex.</span>
<span class="cm"> */</span>

<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dpm_list</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dpm_prepared_list</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dpm_suspended_list</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dpm_late_early_list</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">dpm_noirq_list</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">suspend_stats</span> <span class="n">suspend_stats</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
<span class="k">static</span> <span class="n">pm_message_t</span> <span class="n">pm_transition</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">async_error</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_init - Initialize the PM-related part of a device object.</span>
<span class="cm"> * @dev: Device object being initialized.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_prepared</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wakeup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pm_runtime_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_lock - Lock the list of active devices used by the PM core.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_unlock - Unlock the list of active devices used by the PM core.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_unlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_add - Add a device to the PM core&#39;s list of active devices.</span>
<span class="cm"> * @dev: Device to add to the list.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PM: Adding info for %s:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_prepared</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;parent %s should not be sleeping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">));</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_list</span><span class="p">);</span>
	<span class="n">dev_pm_qos_constraints_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_remove - Remove a device from the PM core&#39;s list of active devices.</span>
<span class="cm"> * @dev: Device to be removed from the list.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PM: Removing info for %s:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">dev_pm_qos_constraints_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">device_wakeup_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_move_before - Move device in the PM core&#39;s list of active devices.</span>
<span class="cm"> * @deva: Device to move in dpm_list.</span>
<span class="cm"> * @devb: Device @deva should come before.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_move_before</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">deva</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PM: Moving %s:%s before %s:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">deva</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">deva</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">deva</span><span class="p">),</span>
		 <span class="n">devb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">devb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">devb</span><span class="p">));</span>
	<span class="cm">/* Delete deva from dpm_list and reinsert before devb. */</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deva</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devb</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_move_after - Move device in the PM core&#39;s list of active devices.</span>
<span class="cm"> * @deva: Device to move in dpm_list.</span>
<span class="cm"> * @devb: Device @deva should come after.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_move_after</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">deva</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PM: Moving %s:%s after %s:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">deva</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">deva</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">deva</span><span class="p">),</span>
		 <span class="n">devb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">devb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">devb</span><span class="p">));</span>
	<span class="cm">/* Delete deva from dpm_list and reinsert after devb. */</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deva</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devb</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_move_last - Move device to end of the PM core&#39;s list of devices.</span>
<span class="cm"> * @dev: Device to move in dpm_list.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">device_pm_move_last</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PM: Moving %s:%s to end of list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;No Bus&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ktime_t</span> <span class="nf">initcall_debug_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">calltime</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initcall_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;calling  %s+ @ %i, parent: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">?</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;none&quot;</span><span class="p">);</span>
		<span class="n">calltime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">calltime</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">initcall_debug_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="n">calltime</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">delta</span><span class="p">,</span> <span class="n">rettime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initcall_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rettime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">ktime_sub</span><span class="p">(</span><span class="n">rettime</span><span class="p">,</span> <span class="n">calltime</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;call %s+ returned %d after %Ld usecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">error</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_wait - Wait for a PM operation to complete.</span>
<span class="cm"> * @dev: Device to wait for.</span>
<span class="cm"> * @async: If unset, wait only if the device&#39;s power.async_suspend flag is set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpm_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">async</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async</span> <span class="o">||</span> <span class="p">(</span><span class="n">pm_async_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">async_suspend</span><span class="p">))</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpm_wait_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">async_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dpm_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">bool</span> <span class="o">*</span><span class="p">)</span><span class="n">async_ptr</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpm_wait_for_children</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">async</span><span class="p">)</span>
<span class="p">{</span>
       <span class="n">device_for_each_child</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async</span><span class="p">,</span> <span class="n">dpm_wait_fn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_op - Return the PM operation appropriate for given PM event.</span>
<span class="cm"> * @ops: PM operations to choose from.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pm_callback_t</span> <span class="nf">pm_op</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SUSPEND</span>
	<span class="k">case</span> <span class="n">PM_EVENT_SUSPEND</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESUME</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUSPEND */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HIBERNATE_CALLBACKS</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_QUIESCE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">freeze</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_HIBERNATE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">poweroff</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_THAW</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_RECOVER</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">thaw</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESTORE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">restore</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HIBERNATE_CALLBACKS */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_late_early_op - Return the PM operation appropriate for given PM event.</span>
<span class="cm"> * @ops: PM operations to choose from.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Runtime PM is disabled for @dev while this function is being executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pm_callback_t</span> <span class="nf">pm_late_early_op</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
				      <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SUSPEND</span>
	<span class="k">case</span> <span class="n">PM_EVENT_SUSPEND</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">suspend_late</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESUME</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">resume_early</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUSPEND */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HIBERNATE_CALLBACKS</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_QUIESCE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">freeze_late</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_HIBERNATE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">poweroff_late</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_THAW</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_RECOVER</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">thaw_early</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESTORE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">restore_early</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HIBERNATE_CALLBACKS */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_noirq_op - Return the PM operation appropriate for given PM event.</span>
<span class="cm"> * @ops: PM operations to choose from.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver of @dev will not receive interrupts while this function is being</span>
<span class="cm"> * executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pm_callback_t</span> <span class="nf">pm_noirq_op</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SUSPEND</span>
	<span class="k">case</span> <span class="n">PM_EVENT_SUSPEND</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">suspend_noirq</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESUME</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">resume_noirq</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUSPEND */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HIBERNATE_CALLBACKS</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_QUIESCE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">freeze_noirq</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_HIBERNATE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">poweroff_noirq</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_THAW</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_RECOVER</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">thaw_noirq</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESTORE</span>:
		<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">restore_noirq</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HIBERNATE_CALLBACKS */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pm_verb</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_EVENT_SUSPEND</span>:
		<span class="k">return</span> <span class="s">&quot;suspend&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESUME</span>:
		<span class="k">return</span> <span class="s">&quot;resume&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:
		<span class="k">return</span> <span class="s">&quot;freeze&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_QUIESCE</span>:
		<span class="k">return</span> <span class="s">&quot;quiesce&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_HIBERNATE</span>:
		<span class="k">return</span> <span class="s">&quot;hibernate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_THAW</span>:
		<span class="k">return</span> <span class="s">&quot;thaw&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RESTORE</span>:
		<span class="k">return</span> <span class="s">&quot;restore&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_RECOVER</span>:
		<span class="k">return</span> <span class="s">&quot;recover&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;(unknown PM event)&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_dev_dbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">pm_verb</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">),</span>
		<span class="p">((</span><span class="n">state</span><span class="p">.</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">PM_EVENT_SLEEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">?</span>
		<span class="s">&quot;, may wakeup&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_dev_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PM: Device %s failed to %s%s: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">pm_verb</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">),</span> <span class="n">info</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpm_show_time</span><span class="p">(</span><span class="n">ktime_t</span> <span class="n">starttime</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">calltime</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">usecs64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usecs</span><span class="p">;</span>

	<span class="n">calltime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="n">usecs64</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">calltime</span><span class="p">,</span> <span class="n">starttime</span><span class="p">));</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">usecs64</span><span class="p">,</span> <span class="n">NSEC_PER_USEC</span><span class="p">);</span>
	<span class="n">usecs</span> <span class="o">=</span> <span class="n">usecs64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PM: %s%s%s of devices complete after %ld.%03ld msecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">info</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pm_verb</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">),</span>
		<span class="n">usecs</span> <span class="o">/</span> <span class="n">USEC_PER_MSEC</span><span class="p">,</span> <span class="n">usecs</span> <span class="o">%</span> <span class="n">USEC_PER_MSEC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpm_run_callback</span><span class="p">(</span><span class="n">pm_callback_t</span> <span class="n">cb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">calltime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">calltime</span> <span class="o">=</span> <span class="n">initcall_debug_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pm_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">suspend_report_result</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">initcall_debug_report</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">calltime</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------- Resume routines -------------------------*/</span>

<span class="cm">/**</span>
<span class="cm"> * device_resume_noirq - Execute an &quot;early resume&quot; callback for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver of @dev will not receive interrupts while this function is being</span>
<span class="cm"> * executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_resume_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_callback_t</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">TRACE_DEVICE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TRACE_RESUME</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq class &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq bus &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">dpm_run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">TRACE_RESUME</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_resume_noirq - Execute &quot;noirq resume&quot; callbacks for all devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Call the &quot;noirq&quot; resume handlers for all devices in dpm_noirq_list and</span>
<span class="cm"> * enable device drivers to receive interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpm_resume_noirq</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_noirq_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_noirq_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_late_early_list</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_resume_noirq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_resume_noirq</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_RESUME_NOIRQ</span><span class="p">);</span>
			<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot; noirq&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">dpm_show_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;noirq&quot;</span><span class="p">);</span>
	<span class="n">resume_device_irqs</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_resume_early - Execute an &quot;early resume&quot; callback for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Runtime PM is disabled for @dev while this function is being executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_resume_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_callback_t</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">TRACE_DEVICE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TRACE_RESUME</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;early power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;early type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;early class &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;early bus &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;early driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">dpm_run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">TRACE_RESUME</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_resume_early - Execute &quot;early resume&quot; callbacks for all devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dpm_resume_early</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_late_early_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_late_early_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_suspended_list</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_resume_early</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_resume_early</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_RESUME_EARLY</span><span class="p">);</span>
			<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot; early&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">dpm_show_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;early&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_resume_start - Execute &quot;noirq&quot; and &quot;early&quot; device callbacks.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dpm_resume_start</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dpm_resume_noirq</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dpm_resume_early</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dpm_resume_start</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * device_resume - Execute &quot;resume&quot; callbacks for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> * @async: If true, the device is being resumed asynchronously.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">async</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_callback_t</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">put</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">TRACE_DEVICE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TRACE_RESUME</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">dpm_wait</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">async</span><span class="p">);</span>
	<span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a fib.  But we&#39;ll allow new children to be added below</span>
<span class="cm">	 * a resumed device, even if the device hasn&#39;t been completed yet.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_prepared</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_suspended</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Unlock</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">put</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;class &quot;</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">Driver</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;legacy class &quot;</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">End</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;bus &quot;</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;legacy bus &quot;</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">End</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">Driver:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">End:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">dpm_run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

 <span class="nl">Unlock:</span>
	<span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">TRACE_RESUME</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put</span><span class="p">)</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">async_resume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">async_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">device_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_transition</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_transition</span><span class="p">,</span> <span class="s">&quot; async&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">async_suspend</span> <span class="o">&amp;&amp;</span> <span class="n">pm_async_enabled</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pm_trace_is_enabled</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_resume - Execute &quot;resume&quot; callbacks for non-sysdev devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Execute the appropriate &quot;resume&quot; callback for all devices whose status</span>
<span class="cm"> * indicates that they are suspended.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dpm_resume</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">pm_transition</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">async_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_suspended_list</span><span class="p">,</span> <span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_async</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">async_schedule</span><span class="p">(</span><span class="n">async_resume</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_suspended_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_suspended_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_async</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">device_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_resume</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_RESUME</span><span class="p">);</span>
				<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
				<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_prepared_list</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">async_synchronize_full</span><span class="p">();</span>
	<span class="n">dpm_show_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_complete - Complete a PM transition for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;completing power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;completing type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;completing class &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;completing bus &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;completing driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_complete - Complete a PM transition for all non-sysdev devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Execute the -&gt;complete() callbacks for all devices whose PM status is not</span>
<span class="cm"> * DPM_ON (this allows new devices to be registered).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dpm_complete</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_prepared_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_prepared_list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_prepared</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">device_complete</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_resume_end - Execute &quot;resume&quot; callbacks and complete system transition.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Execute &quot;resume&quot; callbacks for all devices and complete the PM transition of</span>
<span class="cm"> * the system.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dpm_resume_end</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dpm_resume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dpm_complete</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dpm_resume_end</span><span class="p">);</span>


<span class="cm">/*------------------------- Suspend routines -------------------------*/</span>

<span class="cm">/**</span>
<span class="cm"> * resume_event - Return a &quot;resume&quot; message for given &quot;suspend&quot; sleep state.</span>
<span class="cm"> * @sleep_state: PM message representing a sleep state.</span>
<span class="cm"> *</span>
<span class="cm"> * Return a PM message representing the resume event corresponding to given</span>
<span class="cm"> * sleep state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pm_message_t</span> <span class="nf">resume_event</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">sleep_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sleep_state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_EVENT_SUSPEND</span>:
		<span class="k">return</span> <span class="n">PMSG_RESUME</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_QUIESCE</span>:
		<span class="k">return</span> <span class="n">PMSG_RECOVER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_HIBERNATE</span>:
		<span class="k">return</span> <span class="n">PMSG_RESTORE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PMSG_ON</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_suspend_noirq - Execute a &quot;late suspend&quot; callback for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver of @dev will not receive interrupts while this function is being</span>
<span class="cm"> * executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_suspend_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_callback_t</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq class &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq bus &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;noirq driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_noirq_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dpm_run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_suspend_noirq - Execute &quot;noirq suspend&quot; callbacks for all devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Prevent device drivers from receiving interrupts and call the &quot;noirq&quot; suspend</span>
<span class="cm"> * handlers for all non-sysdev devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpm_suspend_noirq</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">suspend_device_irqs</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_late_early_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_late_early_list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_suspend_noirq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot; noirq&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_suspend_noirq</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_SUSPEND_NOIRQ</span><span class="p">);</span>
			<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_noirq_list</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pm_wakeup_pending</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dpm_resume_noirq</span><span class="p">(</span><span class="n">resume_event</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">dpm_show_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;noirq&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_suspend_late - Execute a &quot;late suspend&quot; callback for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Runtime PM is disabled for @dev while this function is being executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_suspend_late</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_callback_t</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;late power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;late type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;late class &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;late bus &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;late driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_late_early_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dpm_run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_suspend_late - Execute &quot;late suspend&quot; callbacks for all devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dpm_suspend_late</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_suspended_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_suspended_list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_suspend_late</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot; late&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_suspend_late</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_SUSPEND_LATE</span><span class="p">);</span>
			<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_late_early_list</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pm_wakeup_pending</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dpm_resume_early</span><span class="p">(</span><span class="n">resume_event</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">dpm_show_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;late&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_suspend_end - Execute &quot;late&quot; and &quot;noirq&quot; device suspend callbacks.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dpm_suspend_end</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">dpm_suspend_late</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span> <span class="o">?</span> <span class="o">:</span> <span class="n">dpm_suspend_noirq</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dpm_suspend_end</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * legacy_suspend - Execute a legacy (bus or class) suspend callback for device.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> * @cb: Suspend callback to execute.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">legacy_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">calltime</span><span class="p">;</span>

	<span class="n">calltime</span> <span class="o">=</span> <span class="n">initcall_debug_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">suspend_report_result</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">initcall_debug_report</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">calltime</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_suspend - Execute &quot;suspend&quot; callbacks for given device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> * @async: If true, the device is being suspended asynchronously.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">async</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_callback_t</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dpm_wait_for_children</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">async</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async_error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Complete</span><span class="p">;</span>

	<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_runtime_barrier</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pm_wakeup_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_wakeup_pending</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">async_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Run</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Run</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;class &quot;</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">Run</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;legacy class &quot;</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">legacy_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">End</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;bus &quot;</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;legacy bus &quot;</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">legacy_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">End</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">Run:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">pm_op</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">dpm_run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

 <span class="nl">End:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_suspended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wakeup_path</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wakeup_path</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

 <span class="nl">Complete:</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">async_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__pm_runtime_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">async_suspend</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">async_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">__device_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_transition</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_transition</span><span class="p">,</span> <span class="s">&quot; async&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_async_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">async_suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">async_schedule</span><span class="p">(</span><span class="n">async_suspend</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">__device_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_transition</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_suspend - Execute &quot;suspend&quot; callbacks for all non-sysdev devices.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dpm_suspend</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">pm_transition</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">async_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_prepared_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_prepared_list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">dpm_save_failed_dev</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_suspended_list</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async_error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="n">async_synchronize_full</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">async_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_suspend</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_SUSPEND</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dpm_show_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * device_prepare - Prepare a device for system power transition.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Execute the -&gt;prepare() callback(s) for given device.  No new children of the</span>
<span class="cm"> * device may be registered after this function has returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wakeup_path</span> <span class="o">=</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;preparing power domain &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">prepare</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;preparing type &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;preparing class &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;preparing bus &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="s">&quot;preparing driver &quot;</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">suspend_report_result</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_prepare - Prepare all non-sysdev devices for a system PM transition.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Execute the -&gt;prepare() callback(s) for all devices.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dpm_prepare</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">dpm_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_prepare</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PM: Device %s not prepared &quot;</span>
				<span class="s">&quot;for power transition: code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">is_prepared</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpm_prepared_list</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpm_list_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dpm_suspend_start - Prepare devices for PM transition and suspend them.</span>
<span class="cm"> * @state: PM transition of the system being carried out.</span>
<span class="cm"> *</span>
<span class="cm"> * Prepare all non-sysdev devices for system PM transition and execute &quot;suspend&quot;</span>
<span class="cm"> * callbacks for them.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dpm_suspend_start</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">dpm_prepare</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">suspend_stats</span><span class="p">.</span><span class="n">failed_prepare</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dpm_save_failed_step</span><span class="p">(</span><span class="n">SUSPEND_PREPARE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">dpm_suspend</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dpm_suspend_start</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__suspend_report_result</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s(): %pF returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__suspend_report_result</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * device_pm_wait_for_dev - Wait for suspend/resume of a device to complete.</span>
<span class="cm"> * @dev: Device to wait for.</span>
<span class="cm"> * @subordinate: Device that needs to wait for @dev.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">device_pm_wait_for_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">subordinate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dpm_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">async_suspend</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">async_error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">device_pm_wait_for_dev</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
