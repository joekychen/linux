<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rapidio › rio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RapidIO interconnect services</span>
<span class="cm"> * (RapidIO Interconnect Specification, http://www.rapidio.org)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 MontaVista Software, Inc.</span>
<span class="cm"> * Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Integrated Device Technology, Inc.</span>
<span class="cm"> * Alex Bounine &lt;alexandre.bounine@idt.com&gt;</span>
<span class="cm"> * - Added Port-Write/Error Management initialization and handling</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/rio.h&gt;</span>
<span class="cp">#include &lt;linux/rio_drv.h&gt;</span>
<span class="cp">#include &lt;linux/rio_ids.h&gt;</span>
<span class="cp">#include &lt;linux/rio_regs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;rio.h&quot;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rio_mports</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">next_portid</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * rio_local_get_device_id - Get the base/extended device id for a port</span>
<span class="cm"> * @port: RIO master port from which to get the deviceid</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the base/extended device id from the local device</span>
<span class="cm"> * implementing the master port. Returns the 8/16-bit device</span>
<span class="cm"> * id.</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="nf">rio_local_get_device_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_DID_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">RIO_GET_DID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span> <span class="n">result</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_request_inb_mbox - request inbound mailbox service</span>
<span class="cm"> * @mport: RIO master port from which to allocate the mailbox resource</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @mbox: Mailbox number to claim</span>
<span class="cm"> * @entries: Number of entries in inbound mailbox queue</span>
<span class="cm"> * @minb: Callback to execute when inbound message is received</span>
<span class="cm"> *</span>
<span class="cm"> * Requests ownership of an inbound mailbox resource and binds</span>
<span class="cm"> * a callback function to the resource. Returns %0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_request_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">minb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span> <span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">slot</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_inb_mbox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_init_mbox_res</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>

		<span class="cm">/* Make sure this mailbox isn&#39;t in use */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span>
		     <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_INB_MBOX_RESOURCE</span><span class="p">],</span>
				      <span class="n">res</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

		<span class="cm">/* Hook the inbound message callback */</span>
		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">mcback</span> <span class="o">=</span> <span class="n">minb</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_inb_mbox</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_inb_mbox - release inbound mailbox message service</span>
<span class="cm"> * @mport: RIO master port from which to release the mailbox resource</span>
<span class="cm"> * @mbox: Mailbox number to release</span>
<span class="cm"> *</span>
<span class="cm"> * Releases ownership of an inbound mailbox resource. Returns 0</span>
<span class="cm"> * if the request has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_release_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_inb_mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_inb_mbox</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>

		<span class="cm">/* Release the mailbox resource */</span>
		<span class="k">return</span> <span class="n">release_resource</span><span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_request_outb_mbox - request outbound mailbox service</span>
<span class="cm"> * @mport: RIO master port from which to allocate the mailbox resource</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @mbox: Mailbox number to claim</span>
<span class="cm"> * @entries: Number of entries in outbound mailbox queue</span>
<span class="cm"> * @moutb: Callback to execute when outbound message is sent</span>
<span class="cm"> *</span>
<span class="cm"> * Requests ownership of an outbound mailbox resource and binds</span>
<span class="cm"> * a callback function to the resource. Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_request_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">moutb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span> <span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_outb_mbox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_init_mbox_res</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>

		<span class="cm">/* Make sure this outbound mailbox isn&#39;t in use */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span>
		     <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_OUTB_MBOX_RESOURCE</span><span class="p">],</span>
				      <span class="n">res</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

		<span class="cm">/* Hook the inbound message callback */</span>
		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">mcback</span> <span class="o">=</span> <span class="n">moutb</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_outb_mbox</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_outb_mbox - release outbound mailbox message service</span>
<span class="cm"> * @mport: RIO master port from which to release the mailbox resource</span>
<span class="cm"> * @mbox: Mailbox number to release</span>
<span class="cm"> *</span>
<span class="cm"> * Releases ownership of an inbound mailbox resource. Returns 0</span>
<span class="cm"> * if the request has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_release_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_outb_mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_outb_mbox</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>

		<span class="cm">/* Release the mailbox resource */</span>
		<span class="k">return</span> <span class="n">release_resource</span><span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_setup_inb_dbell - bind inbound doorbell callback</span>
<span class="cm"> * @mport: RIO master port to bind the doorbell callback</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @res: Doorbell message resource</span>
<span class="cm"> * @dinb: Callback to execute when doorbell is received</span>
<span class="cm"> *</span>
<span class="cm"> * Adds a doorbell resource/callback pair into a port&#39;s</span>
<span class="cm"> * doorbell event list. Returns 0 if the request has been</span>
<span class="cm"> * satisfied.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_setup_inb_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dinb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span> <span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dst</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">info</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dbell</span> <span class="o">*</span><span class="n">dbell</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dbell</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dbell</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dinb</span> <span class="o">=</span> <span class="n">dinb</span><span class="p">;</span>
	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">dbells</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_request_inb_dbell - request inbound doorbell message service</span>
<span class="cm"> * @mport: RIO master port from which to allocate the doorbell resource</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @start: Doorbell info range start</span>
<span class="cm"> * @end: Doorbell info range end</span>
<span class="cm"> * @dinb: Callback to execute when doorbell is received</span>
<span class="cm"> *</span>
<span class="cm"> * Requests ownership of an inbound doorbell resource and binds</span>
<span class="cm"> * a callback function to the resource. Returns 0 if the request</span>
<span class="cm"> * has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_request_inb_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">start</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">end</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dinb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span> <span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">src</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">dst</span><span class="p">,</span> <span class="n">u16</span> <span class="n">info</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_init_dbell_res</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="cm">/* Make sure these doorbells aren&#39;t in use */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span>
		     <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_DOORBELL_RESOURCE</span><span class="p">],</span>
				      <span class="n">res</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Hook the doorbell callback */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rio_setup_inb_dbell</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">dinb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_inb_dbell - release inbound doorbell message service</span>
<span class="cm"> * @mport: RIO master port from which to release the doorbell resource</span>
<span class="cm"> * @start: Doorbell info range start</span>
<span class="cm"> * @end: Doorbell info range end</span>
<span class="cm"> *</span>
<span class="cm"> * Releases ownership of an inbound doorbell resource and removes</span>
<span class="cm"> * callback from the doorbell event list. Returns 0 if the request</span>
<span class="cm"> * has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_release_inb_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">u16</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dbell</span> <span class="o">*</span><span class="n">dbell</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">dbells</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If we can&#39;t find an exact match, fail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delete from list */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="cm">/* Release the doorbell resource */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">release_resource</span><span class="p">(</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>

	<span class="cm">/* Free the doorbell event */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dbell</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_request_outb_dbell - request outbound doorbell message range</span>
<span class="cm"> * @rdev: RIO device from which to allocate the doorbell resource</span>
<span class="cm"> * @start: Doorbell message range start</span>
<span class="cm"> * @end: Doorbell message range end</span>
<span class="cm"> *</span>
<span class="cm"> * Requests ownership of a doorbell message range. Returns a resource</span>
<span class="cm"> * if the request has been satisfied or %NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="nf">rio_request_outb_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">start</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_init_dbell_res</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="cm">/* Make sure these doorbells aren&#39;t in use */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_DOORBELL_RESOURCE</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
		    <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_outb_dbell - release outbound doorbell message range</span>
<span class="cm"> * @rdev: RIO device from which to release the doorbell resource</span>
<span class="cm"> * @res: Doorbell resource to be freed</span>
<span class="cm"> *</span>
<span class="cm"> * Releases ownership of a doorbell message range. Returns 0 if the</span>
<span class="cm"> * request has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_release_outb_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">release_resource</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_request_inb_pwrite - request inbound port-write message service</span>
<span class="cm"> * @rdev: RIO device to which register inbound port-write callback routine</span>
<span class="cm"> * @pwcback: Callback routine to execute when port-write is received</span>
<span class="cm"> *</span>
<span class="cm"> * Binds a port-write callback function to the RapidIO device.</span>
<span class="cm"> * Returns 0 if the request has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_request_inb_pwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pwcback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">rio_pw_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">step</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pwcback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pwcback</span> <span class="o">=</span> <span class="n">pwcback</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_request_inb_pwrite</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_inb_pwrite - release inbound port-write message service</span>
<span class="cm"> * @rdev: RIO device which registered for inbound port-write callback</span>
<span class="cm"> *</span>
<span class="cm"> * Removes callback from the rio_dev structure. Returns 0 if the request</span>
<span class="cm"> * has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_release_inb_pwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pwcback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pwcback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_release_inb_pwrite</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rio_mport_get_physefb - Helper function that returns register offset</span>
<span class="cm"> *                      for Physical Layer Extended Features Block.</span>
<span class="cm"> * @port: Master port to issue transaction</span>
<span class="cm"> * @local: Indicate a local master port or remote device access</span>
<span class="cm"> * @destid: Destination ID of the device</span>
<span class="cm"> * @hopcount: Number of switch hops to the device</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">rio_mport_get_physefb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ftr_header</span><span class="p">;</span>

	<span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">rio_mport_get_efb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ext_ftr_ptr</span><span class="p">)</span>  <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span>
			<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ext_ftr_ptr</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ftr_header</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
						 <span class="n">ext_ftr_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftr_header</span><span class="p">);</span>

		<span class="n">ftr_header</span> <span class="o">=</span> <span class="n">RIO_GET_BLOCK_ID</span><span class="p">(</span><span class="n">ftr_header</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ftr_header</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_ID_V13P</span>:
		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_REC_ID_V13P</span>:
		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_FREE_ID_V13P</span>:
		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_ID</span>:
		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_REC_ID</span>:
		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_FREE_ID</span>:
		<span class="k">case</span> <span class="n">RIO_EFB_SER_EP_FREC_ID</span>:

			<span class="k">return</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">rio_mport_get_efb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
						<span class="n">hopcount</span><span class="p">,</span> <span class="n">ext_ftr_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_get_comptag - Begin or continue searching for a RIO device by component tag</span>
<span class="cm"> * @comp_tag: RIO component tag to match</span>
<span class="cm"> * @from: Previous RIO device found in search, or %NULL for new search</span>
<span class="cm"> *</span>
<span class="cm"> * Iterates through the list of known RIO devices. If a RIO device is</span>
<span class="cm"> * found with a matching @comp_tag, a pointer to its device</span>
<span class="cm"> * structure is returned. Otherwise, %NULL is returned. A new search</span>
<span class="cm"> * is initiated by passing %NULL to the @from argument. Otherwise, if</span>
<span class="cm"> * @from is not %NULL, searches continue from next device on the global</span>
<span class="cm"> * list.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="nf">rio_get_comptag</span><span class="p">(</span><span class="n">u32</span> <span class="n">comp_tag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">from</span> <span class="o">?</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">global_list</span><span class="p">.</span><span class="n">next</span> <span class="o">:</span> <span class="n">rio_devices</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rio_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_dev_g</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">comp_tag</span> <span class="o">==</span> <span class="n">comp_tag</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_set_port_lockout - Sets/clears LOCKOUT bit (RIO EM 1.3) for a switch port.</span>
<span class="cm"> * @rdev: Pointer to RIO device control structure</span>
<span class="cm"> * @pnum: Switch port number to set LOCKOUT bit</span>
<span class="cm"> * @lock: Operation : set (=1) or clear (=0)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_set_port_lockout</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_CTL_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">regval</span> <span class="o">|=</span> <span class="n">RIO_PORT_N_CTL_LOCKOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RIO_PORT_N_CTL_LOCKOUT</span><span class="p">;</span>

	<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_CTL_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
				  <span class="n">regval</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_chk_dev_route - Validate route to the specified device.</span>
<span class="cm"> * @rdev:  RIO device failed to respond</span>
<span class="cm"> * @nrdev: Last active device on the route to rdev</span>
<span class="cm"> * @npnum: nrdev&#39;s port number on the route to rdev</span>
<span class="cm"> *</span>
<span class="cm"> * Follows a route to the specified RIO device to determine the last available</span>
<span class="cm"> * device (and corresponding RIO port) on the route.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_chk_dev_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">**</span><span class="n">nrdev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">npnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p_port</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Find switch with failed RIO link */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">pef</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_SWITCH</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">RIO_DEV_ID_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">p_port</span> <span class="o">=</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_port</span> <span class="o">!=</span> <span class="n">RIO_INVALID_ROUTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: link failed on [%s]-P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rio_name</span><span class="p">(</span><span class="n">prev</span><span class="p">),</span> <span class="n">p_port</span><span class="p">);</span>
		<span class="o">*</span><span class="n">nrdev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="o">*</span><span class="n">npnum</span> <span class="o">=</span> <span class="n">p_port</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: failed to trace route to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_mport_chk_dev_access - Validate access to the specified device.</span>
<span class="cm"> * @mport: Master port to send transactions</span>
<span class="cm"> * @destid: Device destination ID in network</span>
<span class="cm"> * @hopcount: Number of hops into the network</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rio_mport_chk_dev_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					<span class="n">RIO_DEV_ID_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RIO_MAX_CHK_RETRY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_chk_dev_access - Validate access to the specified device.</span>
<span class="cm"> * @rdev: Pointer to RIO device control structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_chk_dev_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rio_mport_chk_dev_access</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_get_input_status - Sends a Link-Request/Input-Status control symbol and</span>
<span class="cm"> *                        returns link-response (if requested).</span>
<span class="cm"> * @rdev: RIO devive to issue Input-status command</span>
<span class="cm"> * @pnum: Device port number to issue the command</span>
<span class="cm"> * @lnkresp: Response from a link partner</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_get_input_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">lnkresp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">checkcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lnkresp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read from link maintenance response register</span>
<span class="cm">		 * to clear valid bit */</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_MNT_RSP_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue Input-status command */</span>
	<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_MNT_REQ_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
		<span class="n">RIO_MNT_REQ_CMD_IS</span><span class="p">);</span>

	<span class="cm">/* Exit if the response is not expected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lnkresp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">checkcount</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">checkcount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_MNT_RSP_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_MNT_RSP_RVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">lnkresp</span> <span class="o">=</span> <span class="n">regval</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_clr_err_stopped - Clears port Error-stopped states.</span>
<span class="cm"> * @rdev: Pointer to RIO device control structure</span>
<span class="cm"> * @pnum: Switch port number to clear errors</span>
<span class="cm"> * @err_status: port error status (if 0 reads register from device)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_clr_err_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">nextdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">nextdev</span><span class="p">[</span><span class="n">pnum</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">far_ackid</span><span class="p">,</span> <span class="n">far_linkstat</span><span class="p">,</span> <span class="n">near_ackid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">err_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_status</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ERR_STS_PW_OUT_ES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: servicing Output Error-Stopped state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send a Link-Request/Input-Status control symbol</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rio_get_input_status</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: Input-status response timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rd_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: SP%d Input-status response=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pnum</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="n">far_ackid</span> <span class="o">=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_MNT_RSP_ASTAT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">far_linkstat</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_MNT_RSP_LSTAT</span><span class="p">;</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ACK_STS_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: SP%d_ACK_STS_CSR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="n">near_ackid</span> <span class="o">=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ACK_INBOUND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: SP%d far_ackID=0x%02x far_linkstat=0x%02x&quot;</span> \
			 <span class="s">&quot; near_ackID=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pnum</span><span class="p">,</span> <span class="n">far_ackid</span><span class="p">,</span> <span class="n">far_linkstat</span><span class="p">,</span> <span class="n">near_ackid</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If required, synchronize ackIDs of near and</span>
<span class="cm">		 * far sides.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">far_ackid</span> <span class="o">!=</span> <span class="p">((</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ACK_OUTSTAND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">far_ackid</span> <span class="o">!=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ACK_OUTBOUND</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Align near outstanding/outbound ackIDs with</span>
<span class="cm">			 * far inbound.</span>
<span class="cm">			 */</span>
			<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ACK_STS_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
				<span class="p">(</span><span class="n">near_ackid</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">far_ackid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">far_ackid</span><span class="p">);</span>
			<span class="cm">/* Align far outstanding/outbound ackIDs with</span>
<span class="cm">			 * near inbound.</span>
<span class="cm">			 */</span>
			<span class="n">far_ackid</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nextdev</span><span class="p">)</span>
				<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">nextdev</span><span class="p">,</span>
					<span class="n">nextdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span>
					<span class="n">RIO_PORT_N_ACK_STS_CSR</span><span class="p">(</span><span class="n">RIO_GET_PORT_NUM</span><span class="p">(</span><span class="n">nextdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">)),</span>
					<span class="p">(</span><span class="n">far_ackid</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">near_ackid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">near_ackid</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: Invalid nextdev pointer (NULL)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">rd_err:</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">err_status</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: SP%d_ERR_STS_CSR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">err_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err_status</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ERR_STS_PW_INP_ES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nextdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: servicing Input Error-Stopped state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rio_get_input_status</span><span class="p">(</span><span class="n">nextdev</span><span class="p">,</span>
				     <span class="n">RIO_GET_PORT_NUM</span><span class="p">(</span><span class="n">nextdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">pnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">err_status</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_EM: SP%d_ERR_STS_CSR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">err_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIO_PORT_N_ERR_STS_PW_OUT_ES</span> <span class="o">|</span>
			      <span class="n">RIO_PORT_N_ERR_STS_PW_INP_ES</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_inb_pwrite_handler - process inbound port-write message</span>
<span class="cm"> * @pw_msg: pointer to inbound port-write message</span>
<span class="cm"> *</span>
<span class="cm"> * Processes an inbound port-write message. Returns 0 if the request</span>
<span class="cm"> * has been satisfied.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_inb_pwrite_handler</span><span class="p">(</span><span class="k">union</span> <span class="n">rio_pw_msg</span> <span class="o">*</span><span class="n">pw_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">err_status</span><span class="p">,</span> <span class="n">em_perrdet</span><span class="p">,</span> <span class="n">em_ltlerrdet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">portnum</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_get_comptag</span><span class="p">((</span><span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">em</span><span class="p">.</span><span class="n">comptag</span> <span class="o">&amp;</span> <span class="n">RIO_CTAG_UDEVID</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Device removed or enumeration error */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: %s No matching device for CTag 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">em</span><span class="p">.</span><span class="n">comptag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: Port-Write message from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG_PW</span>
	<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;0x%02x: %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				 <span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Call an external service function (if such is registered</span>
<span class="cm">	 * for this device). This may be the service for endpoints that send</span>
<span class="cm">	 * device-specific port-write messages. End-point messages expected</span>
<span class="cm">	 * to be handled completely by EP specific device driver.</span>
<span class="cm">	 * For switches rc==0 signals that no standard processing required.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pwcback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pwcback</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">pw_msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">portnum</span> <span class="o">=</span> <span class="n">pw_msg</span><span class="o">-&gt;</span><span class="n">em</span><span class="p">.</span><span class="n">is_port</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="cm">/* Check if device and route to it are functional:</span>
<span class="cm">	 * Sometimes devices may send PW message(s) just before being</span>
<span class="cm">	 * powered down (or link being lost).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_chk_dev_access</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: device access failed - get link partner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Scan route to the device and identify failed link.</span>
<span class="cm">		 * This will replace device and port reported in PW message.</span>
<span class="cm">		 * PW message should not be used after this point.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rio_chk_dev_route</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">portnum</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO: Route trace for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pw_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For End-point devices processing stops here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pef</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_SWITCH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO_PW: Bad switch initialization for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process the port-write notification from switch</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">em_handle</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">em_handle</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>

	<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">portnum</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">err_status</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_PW: SP%d_ERR_STS_CSR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="n">err_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_status</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ERR_STS_PORT_OK</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">portnum</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">portnum</span><span class="p">);</span>
			<span class="n">rio_set_port_lockout</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* Schedule Insertion Service */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_PW: Device Insertion on [%s]-P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">portnum</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Clear error-stopped states (if reported).</span>
<span class="cm">		 * Depending on the link partner state, two attempts</span>
<span class="cm">		 * may be needed for successful recovery.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIO_PORT_N_ERR_STS_PW_OUT_ES</span> <span class="o">|</span>
				  <span class="n">RIO_PORT_N_ERR_STS_PW_INP_ES</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rio_clr_err_stopped</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="n">err_status</span><span class="p">))</span>
				<span class="n">rio_clr_err_stopped</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span> <span class="cm">/* if (err_status &amp; RIO_PORT_N_ERR_STS_PORT_UNINIT) */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">portnum</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">portnum</span><span class="p">);</span>
			<span class="n">rio_set_port_lockout</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span>
					<span class="n">RIO_PORT_N_ACK_STS_CSR</span><span class="p">(</span><span class="n">portnum</span><span class="p">),</span>
				<span class="n">RIO_PORT_N_ACK_CLEAR</span><span class="p">);</span>

			<span class="cm">/* Schedule Extraction Service */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_PW: Device Extraction on [%s]-P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">portnum</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span> <span class="o">+</span> <span class="n">RIO_EM_PN_ERR_DETECT</span><span class="p">(</span><span class="n">portnum</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">em_perrdet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em_perrdet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_PW: RIO_EM_P%d_ERR_DETECT=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">portnum</span><span class="p">,</span> <span class="n">em_perrdet</span><span class="p">);</span>
		<span class="cm">/* Clear EM Port N Error Detect CSR */</span>
		<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span> <span class="o">+</span> <span class="n">RIO_EM_PN_ERR_DETECT</span><span class="p">(</span><span class="n">portnum</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span> <span class="o">+</span> <span class="n">RIO_EM_LTL_ERR_DETECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em_ltlerrdet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em_ltlerrdet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_PW: RIO_EM_LTL_ERR_DETECT=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">em_ltlerrdet</span><span class="p">);</span>
		<span class="cm">/* Clear EM L/T Layer Error Detect CSR */</span>
		<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span> <span class="o">+</span> <span class="n">RIO_EM_LTL_ERR_DETECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear remaining error bits and Port-Write Pending bit */</span>
	<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">portnum</span><span class="p">),</span>
			<span class="n">err_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_inb_pwrite_handler</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rio_mport_get_efb - get pointer to next extended features block</span>
<span class="cm"> * @port: Master port to issue transaction</span>
<span class="cm"> * @local: Indicate a local master port or remote device access</span>
<span class="cm"> * @destid: Destination ID of the device</span>
<span class="cm"> * @hopcount: Number of switch hops to the device</span>
<span class="cm"> * @from: Offset of  current Extended Feature block header (if 0 starts</span>
<span class="cm"> * from	ExtFeaturePtr)</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">rio_mport_get_efb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span>
			<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ASM_INFO_CAR</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
						 <span class="n">RIO_ASM_INFO_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">RIO_EXT_FTR_PTR_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span>
			<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
						 <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RIO_GET_BLOCK_ID</span><span class="p">(</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_mport_get_feature - query for devices&#39; extended features</span>
<span class="cm"> * @port: Master port to issue transaction</span>
<span class="cm"> * @local: Indicate a local master port or remote device access</span>
<span class="cm"> * @destid: Destination ID of the device</span>
<span class="cm"> * @hopcount: Number of switch hops to the device</span>
<span class="cm"> * @ftr: Extended feature code</span>
<span class="cm"> *</span>
<span class="cm"> * Tell if a device supports a given RapidIO capability.</span>
<span class="cm"> * Returns the offset of the requested extended feature</span>
<span class="cm"> * block within the device&#39;s RIO configuration space or</span>
<span class="cm"> * 0 in case the device does not support it.  Possible</span>
<span class="cm"> * values for @ftr:</span>
<span class="cm"> *</span>
<span class="cm"> * %RIO_EFB_PAR_EP_ID		LP/LVDS EP Devices</span>
<span class="cm"> *</span>
<span class="cm"> * %RIO_EFB_PAR_EP_REC_ID	LP/LVDS EP Recovery Devices</span>
<span class="cm"> *</span>
<span class="cm"> * %RIO_EFB_PAR_EP_FREE_ID	LP/LVDS EP Free Devices</span>
<span class="cm"> *</span>
<span class="cm"> * %RIO_EFB_SER_EP_ID		LP/Serial EP Devices</span>
<span class="cm"> *</span>
<span class="cm"> * %RIO_EFB_SER_EP_REC_ID	LP/Serial EP Recovery Devices</span>
<span class="cm"> *</span>
<span class="cm"> * %RIO_EFB_SER_EP_FREE_ID	LP/Serial EP Free Devices</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">rio_mport_get_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ftr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">asm_info</span><span class="p">,</span> <span class="n">ext_ftr_ptr</span><span class="p">,</span> <span class="n">ftr_header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span>
		<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ASM_INFO_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asm_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					 <span class="n">RIO_ASM_INFO_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asm_info</span><span class="p">);</span>

	<span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">asm_info</span> <span class="o">&amp;</span> <span class="n">RIO_EXT_FTR_PTR_MASK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ext_ftr_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span>
			<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ext_ftr_ptr</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ftr_header</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
						 <span class="n">ext_ftr_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ftr_header</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RIO_GET_BLOCK_ID</span><span class="p">(</span><span class="n">ftr_header</span><span class="p">)</span> <span class="o">==</span> <span class="n">ftr</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">RIO_GET_BLOCK_PTR</span><span class="p">(</span><span class="n">ftr_header</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_get_asm - Begin or continue searching for a RIO device by vid/did/asm_vid/asm_did</span>
<span class="cm"> * @vid: RIO vid to match or %RIO_ANY_ID to match all vids</span>
<span class="cm"> * @did: RIO did to match or %RIO_ANY_ID to match all dids</span>
<span class="cm"> * @asm_vid: RIO asm_vid to match or %RIO_ANY_ID to match all asm_vids</span>
<span class="cm"> * @asm_did: RIO asm_did to match or %RIO_ANY_ID to match all asm_dids</span>
<span class="cm"> * @from: Previous RIO device found in search, or %NULL for new search</span>
<span class="cm"> *</span>
<span class="cm"> * Iterates through the list of known RIO devices. If a RIO device is</span>
<span class="cm"> * found with a matching @vid, @did, @asm_vid, @asm_did, the reference</span>
<span class="cm"> * count to the device is incrememted and a pointer to its device</span>
<span class="cm"> * structure is returned. Otherwise, %NULL is returned. A new search</span>
<span class="cm"> * is initiated by passing %NULL to the @from argument. Otherwise, if</span>
<span class="cm"> * @from is not %NULL, searches continue from next device on the global</span>
<span class="cm"> * list. The reference count for @from is always decremented if it is</span>
<span class="cm"> * not %NULL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="nf">rio_get_asm</span><span class="p">(</span><span class="n">u16</span> <span class="n">vid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">did</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">asm_vid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">asm_did</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">from</span> <span class="o">?</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">global_list</span><span class="p">.</span><span class="n">next</span> <span class="o">:</span> <span class="n">rio_devices</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rio_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_dev_g</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vid</span> <span class="o">==</span> <span class="n">RIO_ANY_ID</span> <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">vid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">did</span> <span class="o">==</span> <span class="n">RIO_ANY_ID</span> <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span> <span class="o">==</span> <span class="n">did</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">asm_vid</span> <span class="o">==</span> <span class="n">RIO_ANY_ID</span> <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asm_vid</span> <span class="o">==</span> <span class="n">asm_vid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">asm_did</span> <span class="o">==</span> <span class="n">RIO_ANY_ID</span> <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asm_did</span> <span class="o">==</span> <span class="n">asm_did</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="nl">exit:</span>
	<span class="n">rio_dev_put</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_dev_get</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_get_device - Begin or continue searching for a RIO device by vid/did</span>
<span class="cm"> * @vid: RIO vid to match or %RIO_ANY_ID to match all vids</span>
<span class="cm"> * @did: RIO did to match or %RIO_ANY_ID to match all dids</span>
<span class="cm"> * @from: Previous RIO device found in search, or %NULL for new search</span>
<span class="cm"> *</span>
<span class="cm"> * Iterates through the list of known RIO devices. If a RIO device is</span>
<span class="cm"> * found with a matching @vid and @did, the reference count to the</span>
<span class="cm"> * device is incrememted and a pointer to its device structure is returned.</span>
<span class="cm"> * Otherwise, %NULL is returned. A new search is initiated by passing %NULL</span>
<span class="cm"> * to the @from argument. Otherwise, if @from is not %NULL, searches</span>
<span class="cm"> * continue from next device on the global list. The reference count for</span>
<span class="cm"> * @from is always decremented if it is not %NULL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="nf">rio_get_device</span><span class="p">(</span><span class="n">u16</span> <span class="n">vid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">did</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rio_get_asm</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">RIO_ANY_ID</span><span class="p">,</span> <span class="n">RIO_ANY_ID</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_std_route_add_entry - Add switch route table entry using standard</span>
<span class="cm"> *   registers defined in RIO specification rev.1.3</span>
<span class="cm"> * @mport: Master port to issue transaction</span>
<span class="cm"> * @destid: Destination ID of the device</span>
<span class="cm"> * @hopcount: Number of switch hops to the device</span>
<span class="cm"> * @table: routing table ID (global or port-specific)</span>
<span class="cm"> * @route_destid: destID entry in the RT</span>
<span class="cm"> * @route_port: destination port for specified destID</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_std_route_add_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">table</span><span class="p">,</span> <span class="n">u16</span> <span class="n">route_destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">route_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="n">RIO_GLOBAL_TABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				<span class="n">RIO_STD_RTE_CONF_DESTID_SEL_CSR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">route_destid</span><span class="p">);</span>
		<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				<span class="n">RIO_STD_RTE_CONF_PORT_SEL_CSR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">route_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_std_route_get_entry - Read switch route table entry (port number)</span>
<span class="cm"> *   associated with specified destID using standard registers defined in RIO</span>
<span class="cm"> *   specification rev.1.3</span>
<span class="cm"> * @mport: Master port to issue transaction</span>
<span class="cm"> * @destid: Destination ID of the device</span>
<span class="cm"> * @hopcount: Number of switch hops to the device</span>
<span class="cm"> * @table: routing table ID (global or port-specific)</span>
<span class="cm"> * @route_destid: destID entry in the RT</span>
<span class="cm"> * @route_port: returned destination port for specified destID</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_std_route_get_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">table</span><span class="p">,</span> <span class="n">u16</span> <span class="n">route_destid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">route_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="n">RIO_GLOBAL_TABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				<span class="n">RIO_STD_RTE_CONF_DESTID_SEL_CSR</span><span class="p">,</span> <span class="n">route_destid</span><span class="p">);</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				<span class="n">RIO_STD_RTE_CONF_PORT_SEL_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

		<span class="o">*</span><span class="n">route_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_std_route_clr_table - Clear swotch route table using standard registers</span>
<span class="cm"> *   defined in RIO specification rev.1.3.</span>
<span class="cm"> * @mport: Master port to issue transaction</span>
<span class="cm"> * @destid: Destination ID of the device</span>
<span class="cm"> * @hopcount: Number of switch hops to the device</span>
<span class="cm"> * @table: routing table ID (global or port-specific)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rio_std_route_clr_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_destid</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">pef</span><span class="p">,</span> <span class="n">id_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ext_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_sel</span> <span class="o">=</span> <span class="n">RIO_INVALID_ROUTE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="n">RIO_GLOBAL_TABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					 <span class="n">RIO_PEF_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pef</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
						 <span class="n">RIO_SWITCH_RT_LIMIT</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">max_destid</span><span class="p">);</span>
			<span class="n">max_destid</span> <span class="o">&amp;=</span> <span class="n">RIO_RT_MAX_DESTID</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pef</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_EXT_RT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext_cfg</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">id_inc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">port_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">RIO_INVALID_ROUTE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">RIO_INVALID_ROUTE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">RIO_INVALID_ROUTE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">RIO_INVALID_ROUTE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_destid</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					<span class="n">RIO_STD_RTE_CONF_DESTID_SEL_CSR</span><span class="p">,</span>
					<span class="n">ext_cfg</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					<span class="n">RIO_STD_RTE_CONF_PORT_SEL_CSR</span><span class="p">,</span>
					<span class="n">port_sel</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">id_inc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rio_chan_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Check that DMA device belongs to the right MPORT */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span> <span class="o">==</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_mport</span><span class="p">,</span> <span class="n">dma</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_request_dma - request RapidIO capable DMA channel that supports</span>
<span class="cm"> *   specified target RapidIO device.</span>
<span class="cm"> * @rdev: RIO device control structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to allocated DMA channel or NULL if failed.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="nf">rio_request_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dchan</span><span class="p">;</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">dchan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">rio_chan_filter</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dchan</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_request_dma</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_dma - release specified DMA channel</span>
<span class="cm"> * @dchan: DMA channel to release</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rio_release_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">dchan</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_release_dma</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rio_dma_prep_slave_sg - RapidIO specific wrapper</span>
<span class="cm"> *   for device_prep_slave_sg callback defined by DMAENGINE.</span>
<span class="cm"> * @rdev: RIO device control structure</span>
<span class="cm"> * @dchan: DMA channel to configure</span>
<span class="cm"> * @data: RIO specific data descriptor</span>
<span class="cm"> * @direction: DMA data transfer direction (TO or FROM the device)</span>
<span class="cm"> * @flags: dmaengine defined flags</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes RapidIO capable DMA channel for the specified data transfer.</span>
<span class="cm"> * Uses DMA channel private extension to pass information related to remote</span>
<span class="cm"> * target RIO device.</span>
<span class="cm"> * Returns pointer to DMA transaction descriptor or NULL if failed.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">rio_dma_prep_slave_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dma_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dma_ext</span> <span class="n">rio_ext</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dchan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_prep_slave_sg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: prep_rio_sg == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rio_ext</span><span class="p">.</span><span class="n">destid</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">;</span>
	<span class="n">rio_ext</span><span class="p">.</span><span class="n">rio_addr_u</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rio_addr_u</span><span class="p">;</span>
	<span class="n">rio_ext</span><span class="p">.</span><span class="n">rio_addr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rio_addr</span><span class="p">;</span>
	<span class="n">rio_ext</span><span class="p">.</span><span class="n">wr_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wr_type</span><span class="p">;</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="n">dmaengine_prep_rio_sg</span><span class="p">(</span><span class="n">dchan</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
					<span class="n">direction</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_ext</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_dma_prep_slave_sg</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_RAPIDIO_DMA_ENGINE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_fixup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rio_get_device</span><span class="p">(</span><span class="n">RIO_ANY_ID</span><span class="p">,</span> <span class="n">RIO_ANY_ID</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_fixup_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rio_init_mports</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_mports</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rio_enum_mport</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rio_disc_mport</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rio_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall_sync</span><span class="p">(</span><span class="n">rio_init_mports</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hdids</span><span class="p">[</span><span class="n">RIO_MAX_MPORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_get_hdid</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">hdids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">RIO_MAX_MPORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hdids</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_hdid_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdids</span><span class="p">),</span> <span class="n">hdids</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;riohdid=&quot;</span><span class="p">,</span> <span class="n">rio_hdid_setup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rio_register_mport</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_portid</span> <span class="o">&gt;=</span> <span class="n">RIO_MAX_MPORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO: reached specified max number of mports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">next_portid</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span> <span class="o">=</span> <span class="n">rio_get_hdid</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_mports</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_local_get_device_id</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_get_device</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_get_asm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_request_inb_dbell</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_release_inb_dbell</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_request_outb_dbell</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_release_outb_dbell</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_request_inb_mbox</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_release_inb_mbox</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_request_outb_mbox</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rio_release_outb_mbox</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
