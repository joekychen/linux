<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rapidio › rio-scan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rio-scan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RapidIO enumeration and discovery support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 MontaVista Software, Inc.</span>
<span class="cm"> * Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Integrated Device Technology, Inc.</span>
<span class="cm"> * Alex Bounine &lt;alexandre.bounine@idt.com&gt;</span>
<span class="cm"> * - Added Port-Write/Error Management initialization and handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Sysgo AG</span>
<span class="cm"> * Thomas Moll &lt;thomas.moll@sysgo.com&gt;</span>
<span class="cm"> * - Added Input- Output- enable functionality, to allow full communication</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/rio.h&gt;</span>
<span class="cp">#include &lt;linux/rio_drv.h&gt;</span>
<span class="cp">#include &lt;linux/rio_ids.h&gt;</span>
<span class="cp">#include &lt;linux/rio_regs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;rio.h&quot;</span>

<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rio_devices</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rio_switches</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rio_enum_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rio_init_em</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>

<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">rio_global_list_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">next_destid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">next_net</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">next_comptag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rio_enum_timer</span> <span class="o">=</span>
<span class="n">TIMER_INITIALIZER</span><span class="p">(</span><span class="n">rio_enum_timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rio_mport_phys_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RIO_EFB_PAR_EP_ID</span><span class="p">,</span>
	<span class="n">RIO_EFB_PAR_EP_REC_ID</span><span class="p">,</span>
	<span class="n">RIO_EFB_SER_EP_ID</span><span class="p">,</span>
	<span class="n">RIO_EFB_SER_EP_REC_ID</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * rio_get_device_id - Get the base/extended device id for a device</span>
<span class="cm"> * @port: RIO master port</span>
<span class="cm"> * @destid: Destination ID of device</span>
<span class="cm"> * @hopcount: Hopcount to device</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the base/extended device id from a device. Returns the</span>
<span class="cm"> * 8/16-bit device ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">rio_get_device_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_DID_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RIO_GET_DID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_set_device_id - Set the base/extended device id for a device</span>
<span class="cm"> * @port: RIO master port</span>
<span class="cm"> * @destid: Destination ID of device</span>
<span class="cm"> * @hopcount: Hopcount to device</span>
<span class="cm"> * @did: Device ID value to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Writes the base/extended device id from a device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_set_device_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u16</span> <span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_DID_CSR</span><span class="p">,</span>
				  <span class="n">RIO_SET_DID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span> <span class="n">did</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_local_set_device_id - Set the base/extended device id for a port</span>
<span class="cm"> * @port: RIO master port</span>
<span class="cm"> * @did: Device ID value to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Writes the base/extended device id from a device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_local_set_device_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rio_local_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_DID_CSR</span><span class="p">,</span> <span class="n">RIO_SET_DID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span>
				<span class="n">did</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_clear_locks- Release all host locks and signal enumeration complete</span>
<span class="cm"> * @port: Master port to issue transaction</span>
<span class="cm"> *</span>
<span class="cm"> * Marks the component tag CSR on each device with the enumeration</span>
<span class="cm"> * complete flag. When complete, it then release the host locks on</span>
<span class="cm"> * each device. Returns 0 on success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_clear_locks</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Release host device id locks */</span>
	<span class="n">rio_local_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span>
				  <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
	<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;RIO: badness when releasing host lock on master port, result %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">result</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_devices</span><span class="p">,</span> <span class="n">global_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span>
				    <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;RIO: badness when releasing host lock on vid %4.4x did %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Mark device as discovered and enable master */</span>
		<span class="n">rio_read_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_GEN_CTL_CSR</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">RIO_PORT_GEN_DISCOVERED</span> <span class="o">|</span> <span class="n">RIO_PORT_GEN_MASTER</span><span class="p">;</span>
		<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_GEN_CTL_CSR</span><span class="p">,</span>
				    <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_enum_host- Set host lock and initialize host destination ID</span>
<span class="cm"> * @port: Master port to issue transaction</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the local host master port lock and destination ID register</span>
<span class="cm"> * with the host device ID value. The host device ID value is provided</span>
<span class="cm"> * by the platform. Returns %0 on success or %-1 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_enum_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* Set master port host device id lock */</span>
	<span class="n">rio_local_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span>
				  <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>

	<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set master port destid and init destid ctr */</span>
	<span class="n">rio_local_set_device_id</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_destid</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span>
		<span class="n">next_destid</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_device_has_destid- Test if a device contains a destination ID register</span>
<span class="cm"> * @port: Master port to issue transaction</span>
<span class="cm"> * @src_ops: RIO device source operations</span>
<span class="cm"> * @dst_ops: RIO device destination operations</span>
<span class="cm"> *</span>
<span class="cm"> * Checks the provided @src_ops and @dst_ops for the necessary transaction</span>
<span class="cm"> * capabilities that indicate whether or not a device will implement a</span>
<span class="cm"> * destination ID register. Returns 1 if true or 0 if false.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_device_has_destid</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_ops</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">dst_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">RIO_OPS_READ</span> <span class="o">|</span> <span class="n">RIO_OPS_WRITE</span> <span class="o">|</span> <span class="n">RIO_OPS_ATOMIC_TST_SWP</span> <span class="o">|</span> <span class="n">RIO_OPS_ATOMIC_INC</span> <span class="o">|</span> <span class="n">RIO_OPS_ATOMIC_DEC</span> <span class="o">|</span> <span class="n">RIO_OPS_ATOMIC_SET</span> <span class="o">|</span> <span class="n">RIO_OPS_ATOMIC_CLR</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">((</span><span class="n">src_ops</span> <span class="o">|</span> <span class="n">dst_ops</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_release_dev- Frees a RIO device struct</span>
<span class="cm"> * @dev: LDM device associated with a RIO device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the RIO device struct associated a RIO device struct.</span>
<span class="cm"> * The RIO device struct is freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">to_rio_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_is_switch- Tests if a RIO device has switch capabilities</span>
<span class="cm"> * @rdev: RIO device</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the RIO device Processing Element Features register</span>
<span class="cm"> * contents and tests for switch capabilities. Returns 1 if</span>
<span class="cm"> * the device is a switch or 0 if it is not a switch.</span>
<span class="cm"> * The RIO device struct is freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_is_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pef</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_SWITCH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_switch_init - Sets switch operations for a particular vendor switch</span>
<span class="cm"> * @rdev: RIO device</span>
<span class="cm"> * @do_enum: Enumeration/Discovery mode flag</span>
<span class="cm"> *</span>
<span class="cm"> * Searches the RIO switch ops table for known switch types. If the vid</span>
<span class="cm"> * and did match a switch table entry, then call switch initialization</span>
<span class="cm"> * routine to setup switch-specific routines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_switch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_enum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_switch_ops</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">__start_rio_switch_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_switch_ops</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">__end_rio_switch_ops</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">did</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: calling init routine for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">init_hook</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">do_enum</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cur</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pef</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_STD_RT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: adding STD routing ops for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">add_entry</span> <span class="o">=</span> <span class="n">rio_std_route_add_entry</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">get_entry</span> <span class="o">=</span> <span class="n">rio_std_route_get_entry</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">clr_table</span> <span class="o">=</span> <span class="n">rio_std_route_clr_table</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">add_entry</span> <span class="o">||</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">get_entry</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RIO: missing routing ops for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_add_device- Adds a RIO device to the device model</span>
<span class="cm"> * @rdev: RIO device</span>
<span class="cm"> *</span>
<span class="cm"> * Adds the RIO device to the global device list and adds the RIO</span>
<span class="cm"> * device to the RIO device list.  Creates the generic sysfs nodes</span>
<span class="cm"> * for an RIO device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rio_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">global_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_devices</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_global_list_lock</span><span class="p">);</span>

	<span class="n">rio_create_sysfs_dev_files</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_enable_rx_tx_port - enable input receiver and output transmitter of</span>
<span class="cm"> * given port</span>
<span class="cm"> * @port: Master port associated with the RIO network</span>
<span class="cm"> * @local: local=1 select local port otherwise a far device is reached</span>
<span class="cm"> * @destid: Destination ID of the device to check host bit</span>
<span class="cm"> * @hopcount: Number of hops to reach the target</span>
<span class="cm"> * @port_num: Port (-number on switch) to enable on a far end device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 or 1 from on General Control Command and Status Register</span>
<span class="cm"> * (EXT_PTR+0x3C)</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rio_enable_rx_tx_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">local</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_num</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_RAPIDIO_ENABLE_RX_TX_PORTS</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* enable rx input tx output port</span>
<span class="cm">	*/</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rio_enable_rx_tx_port(local = %d, destid = %d, hopcount = &quot;</span>
		 <span class="s">&quot;%d, port_num = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">port_num</span><span class="p">);</span>

	<span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">rio_mport_get_physefb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ext_ftr_ptr</span> <span class="o">+</span>
				<span class="n">RIO_PORT_N_CTL_CSR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
		<span class="n">ext_ftr_ptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_CTL_CSR</span><span class="p">(</span><span class="n">port_num</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_CTL_P_TYP_SER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* serial */</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">|</span> <span class="n">RIO_PORT_N_CTL_EN_RX_SER</span>
				<span class="o">|</span> <span class="n">RIO_PORT_N_CTL_EN_TX_SER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* parallel */</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">|</span> <span class="n">RIO_PORT_N_CTL_EN_RX_PAR</span>
				<span class="o">|</span> <span class="n">RIO_PORT_N_CTL_EN_TX_PAR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_local_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ext_ftr_ptr</span> <span class="o">+</span>
					  <span class="n">RIO_PORT_N_CTL_CSR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">regval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
		    <span class="n">ext_ftr_ptr</span> <span class="o">+</span> <span class="n">RIO_PORT_N_CTL_CSR</span><span class="p">(</span><span class="n">port_num</span><span class="p">),</span> <span class="n">regval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_setup_device- Allocates and sets up a RIO device</span>
<span class="cm"> * @net: RIO network</span>
<span class="cm"> * @port: Master port to send transactions</span>
<span class="cm"> * @destid: Current destination ID</span>
<span class="cm"> * @hopcount: Current hopcount</span>
<span class="cm"> * @do_enum: Enumeration/Discovery mode flag</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a RIO device and configures fields based on configuration</span>
<span class="cm"> * space contents. If device has a destination ID register, a destination</span>
<span class="cm"> * ID is either assigned in enumeration mode or read from configuration</span>
<span class="cm"> * space in discovery mode.  If the device has switch capabilities, then</span>
<span class="cm"> * a switch is allocated and configured appropriately. Returns a pointer</span>
<span class="cm"> * to a RIO device on success or NULL on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">rio_setup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_enum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_switch</span> <span class="o">*</span><span class="n">rswitch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">rdid</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swpinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				     <span class="n">RIO_PEF_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIO_PEF_SWITCH</span> <span class="o">|</span> <span class="n">RIO_PEF_MULTIPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					 <span class="n">RIO_SWP_INFO_CAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swpinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_SWITCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RIO_GET_TOTAL_PORTS</span><span class="p">(</span><span class="n">swpinfo</span><span class="p">)</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">nextdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rswitch</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pef</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span> <span class="o">=</span> <span class="n">swpinfo</span><span class="p">;</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_DEV_ID_CAR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_DEV_INFO_CAR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">device_rev</span><span class="p">);</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_ASM_ID_CAR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asm_did</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asm_vid</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_ASM_INFO_CAR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asm_rev</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pef</span> <span class="o">&amp;</span> <span class="n">RIO_PEF_EXT_FEATURES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">efptr</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">=</span> <span class="n">rio_mport_get_physefb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
							 <span class="n">hopcount</span><span class="p">);</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span> <span class="o">=</span> <span class="n">rio_mport_get_feature</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
						<span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_EFB_ERR_MGMNT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_SRC_OPS_CAR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">src_ops</span><span class="p">);</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_DST_OPS_CAR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dst_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_enum</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Assign component tag to device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_comptag</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO: Component Tag Counter Overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					  <span class="n">RIO_COMPONENT_TAG_CSR</span><span class="p">,</span> <span class="n">next_comptag</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">comp_tag</span> <span class="o">=</span> <span class="n">next_comptag</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					 <span class="n">RIO_COMPONENT_TAG_CSR</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">comp_tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rio_device_has_destid</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">src_ops</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dst_ops</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_enum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rio_set_device_id</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">next_destid</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">=</span> <span class="n">next_destid</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_destid</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span>
				<span class="n">next_destid</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">=</span> <span class="n">rio_get_device_id</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">);</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Switch device has an associated destID which</span>
<span class="cm">		 * will be adjusted later</span>
<span class="cm">		 */</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">=</span> <span class="n">destid</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span> <span class="o">=</span> <span class="n">hopcount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If a PE has both switch and other functions, show it as a switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_is_switch</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rswitch</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="p">;</span>
		<span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">switchid</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">comp_tag</span> <span class="o">&amp;</span> <span class="n">RIO_CTAG_UDEVID</span><span class="p">;</span>
		<span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="o">*</span>
					<span class="n">RIO_MAX_ROUTE_ENTRIES</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="cm">/* Initialize switch route table */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rdid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rdid</span> <span class="o">&lt;</span> <span class="n">RIO_MAX_ROUTE_ENTRIES</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">);</span>
				<span class="n">rdid</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">rdid</span><span class="p">]</span> <span class="o">=</span> <span class="n">RIO_INVALID_ROUTE</span><span class="p">;</span>
		<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%02x:s:%04x&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			     <span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">switchid</span><span class="p">);</span>
		<span class="n">rio_switch_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">do_enum</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_enum</span> <span class="o">&amp;&amp;</span> <span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">clr_table</span><span class="p">)</span>
			<span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">clr_table</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					   <span class="n">RIO_GLOBAL_TABLE</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_switches</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_enum</span><span class="p">)</span>
			<span class="cm">/*Enable Input Output Port (transmitter reviever)*/</span>
			<span class="n">rio_enable_rx_tx_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%02x:e:%04x&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rio_bus_type</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rio_bus</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">rio_release_dev</span><span class="p">;</span>
	<span class="n">rio_dev_get</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dst_ops</span> <span class="o">&amp;</span> <span class="n">RIO_DST_OPS_DOORBELL</span><span class="p">)</span>
		<span class="n">rio_init_dbell_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_DOORBELL_RESOURCE</span><span class="p">],</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rio_add_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rswitch</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_sport_is_active- Tests if a switch port has an active connection.</span>
<span class="cm"> * @port: Master port to send transaction</span>
<span class="cm"> * @destid: Associated destination ID for switch</span>
<span class="cm"> * @hopcount: Hopcount to reach switch</span>
<span class="cm"> * @sport: Switch port number</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the port error status CSR for a particular switch port to</span>
<span class="cm"> * determine if the port has an active link.  Returns</span>
<span class="cm"> * %RIO_PORT_N_ERR_STS_PORT_OK if the port is active or %0 if it is</span>
<span class="cm"> * inactive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_sport_is_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>

	<span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">rio_mport_get_efb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ext_ftr_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					 <span class="n">ext_ftr_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">RIO_GET_BLOCK_ID</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">==</span> <span class="n">RIO_EFB_SER_EP_FREE_ID</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">RIO_EFB_SER_EP_FREE_ID_V13P</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">RIO_EFB_SER_EP_FREC_ID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ext_ftr_ptr</span> <span class="o">=</span> <span class="n">rio_mport_get_efb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
						<span class="n">ext_ftr_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_ftr_ptr</span><span class="p">)</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
					 <span class="n">ext_ftr_ptr</span> <span class="o">+</span>
					 <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">sport</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ERR_STS_PORT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_lock_device - Acquires host device lock for specified device</span>
<span class="cm"> * @port: Master port to send transaction</span>
<span class="cm"> * @destid: Destination ID for device/switch</span>
<span class="cm"> * @hopcount: Hopcount to reach switch</span>
<span class="cm"> * @wait_ms: Max wait time in msec (0 = no timeout)</span>
<span class="cm"> *</span>
<span class="cm"> * Attepts to acquire host device lock for specified device</span>
<span class="cm"> * Returns 0 if device lock acquired or EINVAL if timeout expires.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_lock_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Attempt to acquire device lock */</span>
	<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				  <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				 <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_ms</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tcnt</span> <span class="o">==</span> <span class="n">wait_ms</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: timeout when locking device %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Delay a bit */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Try to acquire device lock again */</span>
		<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">hopcount</span><span class="p">,</span>
			<span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">hopcount</span><span class="p">,</span>
			<span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_unlock_device - Releases host device lock for specified device</span>
<span class="cm"> * @port: Master port to send transaction</span>
<span class="cm"> * @destid: Destination ID for device/switch</span>
<span class="cm"> * @hopcount: Hopcount to reach switch</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if device lock released or EINVAL if fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_unlock_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* Release device lock */</span>
	<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
				  <span class="n">hopcount</span><span class="p">,</span>
				  <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span>
				  <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
		<span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: badness when releasing device lock %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_route_add_entry- Add a route entry to a switch routing table</span>
<span class="cm"> * @rdev: RIO device</span>
<span class="cm"> * @table: Routing table ID</span>
<span class="cm"> * @route_destid: Destination ID to be routed</span>
<span class="cm"> * @route_port: Port number to be routed</span>
<span class="cm"> * @lock: lock switch device flag</span>
<span class="cm"> *</span>
<span class="cm"> * Calls the switch specific add_entry() method to add a route entry</span>
<span class="cm"> * on a switch. The route table can be specified using the @table</span>
<span class="cm"> * argument if a switch has per port routing tables or the normal</span>
<span class="cm"> * use is to specific all tables (or the global table) by passing</span>
<span class="cm"> * %RIO_GLOBAL_TABLE in @table. Returns %0 on success or %-EINVAL</span>
<span class="cm"> * on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_route_add_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
		    <span class="n">u16</span> <span class="n">table</span><span class="p">,</span> <span class="n">u16</span> <span class="n">route_destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">route_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rio_lock_device</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
				     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">add_entry</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
				      <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
				      <span class="n">route_destid</span><span class="p">,</span> <span class="n">route_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">rio_unlock_device</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_route_get_entry- Read a route entry in a switch routing table</span>
<span class="cm"> * @rdev: RIO device</span>
<span class="cm"> * @table: Routing table ID</span>
<span class="cm"> * @route_destid: Destination ID to be routed</span>
<span class="cm"> * @route_port: Pointer to read port number into</span>
<span class="cm"> * @lock: lock switch device flag</span>
<span class="cm"> *</span>
<span class="cm"> * Calls the switch specific get_entry() method to read a route entry</span>
<span class="cm"> * in a switch. The route table can be specified using the @table</span>
<span class="cm"> * argument if a switch has per port routing tables or the normal</span>
<span class="cm"> * use is to specific all tables (or the global table) by passing</span>
<span class="cm"> * %RIO_GLOBAL_TABLE in @table. Returns %0 on success or %-EINVAL</span>
<span class="cm"> * on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rio_route_get_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">table</span><span class="p">,</span>
		    <span class="n">u16</span> <span class="n">route_destid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">route_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rio_lock_device</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
				     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">get_entry</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
				      <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
				      <span class="n">route_destid</span><span class="p">,</span> <span class="n">route_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">rio_unlock_device</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_get_host_deviceid_lock- Reads the Host Device ID Lock CSR on a device</span>
<span class="cm"> * @port: Master port to send transaction</span>
<span class="cm"> * @hopcount: Number of hops to the device</span>
<span class="cm"> *</span>
<span class="cm"> * Used during enumeration to read the Host Device ID Lock CSR on a</span>
<span class="cm"> * RIO device. Returns the value of the lock register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">rio_get_host_deviceid_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span> <span class="n">hopcount</span><span class="p">,</span>
				 <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_enum_peer- Recursively enumerate a RIO network through a master port</span>
<span class="cm"> * @net: RIO network being enumerated</span>
<span class="cm"> * @port: Master port to send transactions</span>
<span class="cm"> * @hopcount: Number of hops into the network</span>
<span class="cm"> * @prev: Previous RIO device connected to the enumerated one</span>
<span class="cm"> * @prev_port: Port on previous RIO device</span>
<span class="cm"> *</span>
<span class="cm"> * Recursively enumerates a RIO network.  Transactions are sent via the</span>
<span class="cm"> * master port passed in @port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rio_enum_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prev_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_destid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw_destid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw_inport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">destid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rio_mport_chk_dev_access</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
			<span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span> <span class="n">hopcount</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: device access check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rio_get_host_deviceid_lock</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">)</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: PE already discovered by this host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Already discovered by this host. Add it as another</span>
<span class="cm">		 * link to the existing device.</span>
<span class="cm">		 */</span>
		<span class="n">rio_mport_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
				<span class="n">hopcount</span><span class="p">,</span> <span class="n">RIO_COMPONENT_TAG_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_get_comptag</span><span class="p">((</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="n">rio_is_switch</span><span class="p">(</span><span class="n">prev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: redundant path to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">nextdev</span><span class="p">[</span><span class="n">prev_port</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Attempt to acquire device lock */</span>
	<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
				  <span class="n">hopcount</span><span class="p">,</span>
				  <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">rio_get_host_deviceid_lock</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">))</span>
	       <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Delay a bit */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Attempt to acquire device lock again */</span>
		<span class="n">rio_mport_write_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
					  <span class="n">hopcount</span><span class="p">,</span>
					  <span class="n">RIO_HOST_DID_LOCK_CSR</span><span class="p">,</span>
					  <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rio_get_host_deviceid_lock</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span>
		    <span class="s">&quot;RIO: PE locked by a higher priority host...retreating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup new RIO device */</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_setup_device</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
					<span class="n">hopcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add device to the global and bus/net specific list. */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="n">rio_is_switch</span><span class="p">(</span><span class="n">prev</span><span class="p">))</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">nextdev</span><span class="p">[</span><span class="n">prev_port</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rio_is_switch</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sw_inport</span> <span class="o">=</span> <span class="n">RIO_GET_PORT_NUM</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">);</span>
		<span class="n">rio_route_add_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span>
				    <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">,</span> <span class="n">sw_inport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_inport</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">destid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">destid</span> <span class="o">&lt;</span> <span class="n">next_destid</span><span class="p">;</span> <span class="n">destid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">destid</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rio_route_add_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span>
					    <span class="n">destid</span><span class="p">,</span> <span class="n">sw_inport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">destid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_inport</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span>
		    <span class="s">&quot;RIO: found %s (vid %4.4x did %4.4x) with %d ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">,</span>
		    <span class="n">RIO_GET_TOTAL_PORTS</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">));</span>
		<span class="n">sw_destid</span> <span class="o">=</span> <span class="n">next_destid</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">port_num</span> <span class="o">&lt;</span> <span class="n">RIO_GET_TOTAL_PORTS</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">);</span>
		     <span class="n">port_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*Enable Input Output Port (transmitter reviever)*/</span>
			<span class="n">rio_enable_rx_tx_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
					      <span class="n">hopcount</span><span class="p">,</span> <span class="n">port_num</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sw_inport</span> <span class="o">==</span> <span class="n">port_num</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">port_num</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cur_destid</span> <span class="o">=</span> <span class="n">next_destid</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rio_sport_is_active</span>
			    <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span> <span class="n">hopcount</span><span class="p">,</span>
			     <span class="n">port_num</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span>
				    <span class="s">&quot;RIO: scanning device on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">port_num</span><span class="p">);</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">port_num</span><span class="p">);</span>
				<span class="n">rio_route_add_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span>
						<span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
						<span class="n">port_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rio_enum_peer</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">hopcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						  <span class="n">rdev</span><span class="p">,</span> <span class="n">port_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

				<span class="cm">/* Update routing tables */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">next_destid</span> <span class="o">&gt;</span> <span class="n">cur_destid</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">destid</span> <span class="o">=</span> <span class="n">cur_destid</span><span class="p">;</span>
					     <span class="n">destid</span> <span class="o">&lt;</span> <span class="n">next_destid</span><span class="p">;</span> <span class="n">destid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">destid</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="n">rio_route_add_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
								    <span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span>
								    <span class="n">destid</span><span class="p">,</span>
								    <span class="n">port_num</span><span class="p">,</span>
								    <span class="mi">0</span><span class="p">);</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span>
						    <span class="n">route_table</span><span class="p">[</span><span class="n">destid</span><span class="p">]</span> <span class="o">=</span>
						    <span class="n">port_num</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* If switch supports Error Management,</span>
<span class="cm">				 * set PORT_LOCKOUT bit for unused port</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span><span class="p">)</span>
					<span class="n">rio_set_port_lockout</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">port_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">port_ok</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">port_num</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Direct Port-write messages to the enumeratiing host */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">src_ops</span> <span class="o">&amp;</span> <span class="n">RIO_SRC_OPS_PORT_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rio_write_config_32</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span> <span class="o">+</span> <span class="n">RIO_EM_PW_TGT_DEVID</span><span class="p">,</span>
					<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">rio_init_em</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="cm">/* Check for empty switch */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_destid</span> <span class="o">==</span> <span class="n">sw_destid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next_destid</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_destid</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">)</span>
				<span class="n">next_destid</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">=</span> <span class="n">sw_destid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: found %s (vid %4.4x did %4.4x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_enum_complete- Tests if enumeration of a network is complete</span>
<span class="cm"> * @port: Master port to send transaction</span>
<span class="cm"> *</span>
<span class="cm"> * Tests the PGCCSR discovered bit for non-zero value (enumeration</span>
<span class="cm"> * complete flag). Return %1 if enumeration is complete or %0 if</span>
<span class="cm"> * enumeration is incomplete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_enum_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">+</span> <span class="n">RIO_PORT_GEN_CTL_CSR</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_GEN_DISCOVERED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_disc_peer- Recursively discovers a RIO network through a master port</span>
<span class="cm"> * @net: RIO network being discovered</span>
<span class="cm"> * @port: Master port to send transactions</span>
<span class="cm"> * @destid: Current destination ID in network</span>
<span class="cm"> * @hopcount: Number of hops into the network</span>
<span class="cm"> * @prev: previous rio_dev</span>
<span class="cm"> * @prev_port: previous port number</span>
<span class="cm"> *</span>
<span class="cm"> * Recursively discovers a RIO network.  Transactions are sent via the</span>
<span class="cm"> * master port passed in @port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">rio_disc_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
	      <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prev_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span> <span class="n">route_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ndestid</span><span class="p">;</span>

	<span class="cm">/* Setup new RIO device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rio_setup_device</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Add device to the global and bus/net specific list. */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="n">rio_is_switch</span><span class="p">(</span><span class="n">prev</span><span class="p">))</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">nextdev</span><span class="p">[</span><span class="n">prev_port</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rio_is_switch</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Associated destid is how we accessed this switch */</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">=</span> <span class="n">destid</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span>
		    <span class="s">&quot;RIO: found %s (vid %4.4x did %4.4x) with %d ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">,</span>
		    <span class="n">RIO_GET_TOTAL_PORTS</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">port_num</span> <span class="o">&lt;</span> <span class="n">RIO_GET_TOTAL_PORTS</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">);</span>
		     <span class="n">port_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RIO_GET_PORT_NUM</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">)</span> <span class="o">==</span> <span class="n">port_num</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rio_sport_is_active</span>
			    <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">port_num</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span>
				    <span class="s">&quot;RIO: scanning device on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">port_num</span><span class="p">);</span>

				<span class="n">rio_lock_device</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">ndestid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				     <span class="n">ndestid</span> <span class="o">&lt;</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">);</span>
				     <span class="n">ndestid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rio_route_get_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
							    <span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span>
							    <span class="n">ndestid</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">route_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">route_port</span> <span class="o">==</span> <span class="n">port_num</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ndestid</span> <span class="o">==</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">rio_unlock_device</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rio_disc_peer</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ndestid</span><span class="p">,</span>
					<span class="n">hopcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">port_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: found %s (vid %4.4x did %4.4x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rio_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_mport_is_active- Tests if master port link is active</span>
<span class="cm"> * @port: Master port to test</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the port error status CSR for the master port to</span>
<span class="cm"> * determine if the port has an active link.  Returns</span>
<span class="cm"> * %RIO_PORT_N_ERR_STS_PORT_OK if the  master port is active</span>
<span class="cm"> * or %0 if it is inactive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rio_mport_is_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_ftr_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">rio_mport_phys_table</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ext_ftr_ptr</span> <span class="o">=</span>
		     <span class="n">rio_mport_get_feature</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">entry</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*++</span><span class="n">entry</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_ftr_ptr</span><span class="p">)</span>
		<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ext_ftr_ptr</span> <span class="o">+</span>
					 <span class="n">RIO_PORT_N_ERR_STS_CSR</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="n">RIO_PORT_N_ERR_STS_PORT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_alloc_net- Allocate and configure a new RIO network</span>
<span class="cm"> * @port: Master port associated with the RIO network</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a RIO network structure, initializes per-network</span>
<span class="cm"> * list heads, and adds the associated master port to the</span>
<span class="cm"> * network list of associated master ports. Returns a</span>
<span class="cm"> * RIO network pointer on success or %NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rio_net</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">rio_alloc_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_net</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mports</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nnode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mports</span><span class="p">);</span>
		<span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">net</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">next_net</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">net</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_update_route_tables- Updates route tables in switches</span>
<span class="cm"> * @port: Master port associated with the RIO network</span>
<span class="cm"> *</span>
<span class="cm"> * For each enumerated device, ensure that each switch in a system</span>
<span class="cm"> * has correct routing entries. Add routes for devices that where</span>
<span class="cm"> * unknown dirung the first enumeration pass through the switch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_update_route_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">swrdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_switch</span> <span class="o">*</span><span class="n">rswitch</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sport</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">destid</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_devices</span><span class="p">,</span> <span class="n">global_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">destid</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rswitch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_switches</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rio_is_switch</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span>	<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span> <span class="o">==</span> <span class="n">rswitch</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RIO_INVALID_ROUTE</span> <span class="o">==</span> <span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">destid</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">swrdev</span> <span class="o">=</span> <span class="n">sw_to_rio_dev</span><span class="p">(</span><span class="n">rswitch</span><span class="p">);</span>

				<span class="cm">/* Skip if destid ends in empty switch*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">swrdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">==</span> <span class="n">destid</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">sport</span> <span class="o">=</span> <span class="n">RIO_GET_PORT_NUM</span><span class="p">(</span><span class="n">swrdev</span><span class="o">-&gt;</span><span class="n">swpinfo</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">add_entry</span><span class="p">)</span>	<span class="p">{</span>
					<span class="n">rio_route_add_entry</span><span class="p">(</span><span class="n">swrdev</span><span class="p">,</span>
						<span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span>
						<span class="n">sport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">destid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sport</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_init_em - Initializes RIO Error Management (for switches)</span>
<span class="cm"> * @rdev: RIO device</span>
<span class="cm"> *</span>
<span class="cm"> * For each enumerated switch, call device-specific error management</span>
<span class="cm"> * initialization routine (if supplied by the switch driver).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_init_em</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_is_switch</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">em_efptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">em_init</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">em_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_pw_enable - Enables/disables port-write handling by a master port</span>
<span class="cm"> * @port: Master port associated with port-write handling</span>
<span class="cm"> * @enable:  1=enable,  0=disable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_pw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwenable</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwenable</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_enum_mport- Start enumeration through a master port</span>
<span class="cm"> * @mport: Master port to send transactions</span>
<span class="cm"> *</span>
<span class="cm"> * Starts the enumeration process. If somebody has enumerated our</span>
<span class="cm"> * master port device, then give up. If not and we have an active</span>
<span class="cm"> * link, then start recursive peer enumeration. Returns %0 if</span>
<span class="cm"> * enumeration succeeds or %-EBUSY if enumeration fails.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rio_enum_mport</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RIO: enumerate master port %d, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">mport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* If somebody else enumerated our master port device, bail. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_enum_host</span><span class="p">(</span><span class="n">mport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;RIO: master port %d device has been enumerated by a remote host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mport</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If master port has an active link, allocate net and enum peers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_mport_is_active</span><span class="p">(</span><span class="n">mport</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">net</span> <span class="o">=</span> <span class="n">rio_alloc_net</span><span class="p">(</span><span class="n">mport</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RIO: failed to allocate new net</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable Input Output Port (transmitter reviever) */</span>
		<span class="n">rio_enable_rx_tx_port</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Set component tag for host */</span>
		<span class="n">rio_local_write_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">RIO_COMPONENT_TAG_CSR</span><span class="p">,</span>
					  <span class="n">next_comptag</span><span class="o">++</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rio_enum_peer</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* A higher priority host won enumeration, bail. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;RIO: master port %d device has lost enumeration to a remote host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mport</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">rio_clear_locks</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rio_update_route_tables</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
		<span class="n">rio_clear_locks</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
		<span class="n">rio_pw_enable</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RIO: master port %d link inactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mport</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_build_route_tables- Generate route tables from switch route entries</span>
<span class="cm"> *</span>
<span class="cm"> * For each switch device, generate a route table by copying existing</span>
<span class="cm"> * route entries from the switch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_build_route_tables</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sport</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rio_devices</span><span class="p">,</span> <span class="n">global_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rio_is_switch</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rio_lock_device</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RIO_MAX_ROUTE_ENTRIES</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">);</span>
			     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rio_route_get_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					<span class="n">RIO_GLOBAL_TABLE</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sport</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rswitch</span><span class="o">-&gt;</span><span class="n">route_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sport</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rio_unlock_device</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hport</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hopcount</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_enum_timeout- Signal that enumeration timed out</span>
<span class="cm"> * @data: Address of timeout flag.</span>
<span class="cm"> *</span>
<span class="cm"> * When the enumeration complete timer expires, set a flag that</span>
<span class="cm"> * signals to the discovery process that enumeration did not</span>
<span class="cm"> * complete in a sane amount of time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rio_enum_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enumeration timed out, set flag */</span>
	<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rio_disc_mport- Start discovery through a master port</span>
<span class="cm"> * @mport: Master port to send transactions</span>
<span class="cm"> *</span>
<span class="cm"> * Starts the discovery process. If we have an active link,</span>
<span class="cm"> * then wait for the signal that enumeration is complete.</span>
<span class="cm"> * When enumeration completion is signaled, start recursive</span>
<span class="cm"> * peer discovery. Returns %0 if discovery succeeds or %-EBUSY</span>
<span class="cm"> * on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rio_disc_mport</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enum_timeout_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RIO: discover master port %d, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">mport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* If master port has an active link, allocate net and discover peers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rio_mport_is_active</span><span class="p">(</span><span class="n">mport</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">net</span> <span class="o">=</span> <span class="n">rio_alloc_net</span><span class="p">(</span><span class="n">mport</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RIO: Failed to allocate new net</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: wait for enumeration complete...&quot;</span><span class="p">);</span>

		<span class="n">rio_enum_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
		    <span class="n">jiffies</span> <span class="o">+</span> <span class="n">CONFIG_RAPIDIO_DISC_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">rio_enum_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">enum_timeout_flag</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_enum_timer</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rio_enum_complete</span><span class="p">(</span><span class="n">mport</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">enum_timeout_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_enum_timer</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">timeout</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio_enum_timer</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Read DestID assigned by enumerator */</span>
		<span class="n">rio_local_read_config_32</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">RIO_DID_CSR</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>
		<span class="n">mport</span><span class="o">-&gt;</span><span class="n">host_deviceid</span> <span class="o">=</span> <span class="n">RIO_GET_DID</span><span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span>
						   <span class="n">mport</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rio_disc_peer</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mport</span><span class="p">,</span> <span class="n">RIO_ANY_DESTID</span><span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">),</span>
					<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;RIO: master port %d device has failed discovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mport</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rio_build_route_tables</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">timeout:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="nl">bail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
