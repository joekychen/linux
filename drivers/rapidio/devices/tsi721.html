<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rapidio › devices › tsi721.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tsi721.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RapidIO mport driver for Tsi721 PCIExpress-to-SRIO bridge</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2011 Integrated Device Technology, Inc.</span>
<span class="cm"> * Alexandre Bounine &lt;alexandre.bounine@idt.com&gt;</span>
<span class="cm"> * Chul Kim &lt;chul.kim@idt.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> * Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/rio.h&gt;</span>
<span class="cp">#include &lt;linux/rio_drv.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &quot;tsi721.h&quot;</span>

<span class="cp">#define DEBUG_PW	</span><span class="cm">/* Inbound Port-Write debugging */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tsi721_omsg_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tsi721_imsg_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_lcread - read from local SREP config space</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @data: Value to be read into</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a local SREP space read. Returns %0 on</span>
<span class="cm"> * success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_lcread</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* only 32-bit access is supported */</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_lcwrite - write into local SREP config space</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @data: Value to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a local write into SREP configuration space. Returns %0 on</span>
<span class="cm"> * success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_lcwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* only 32-bit access is supported */</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_maint_dma - Helper function to generate RapidIO maintenance</span>
<span class="cm"> *                    transactions using designated Tsi721 DMA channel.</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> * @sys_size: RapdiIO transport system size</span>
<span class="cm"> * @destid: Destination ID of transaction</span>
<span class="cm"> * @hopcount: Number of hops to target device</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @data: Location to be read from or write into</span>
<span class="cm"> * @do_wr: Operation flag (1 == MAINT_WR)</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a RapidIO maintenance transaction (Read or Write).</span>
<span class="cm"> * Returns %0 on success and %-EINVAL or %-EFAULT on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_maint_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sys_size</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_BASE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">ch_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tsi721_dma_desc</span> <span class="o">*</span><span class="n">bd_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rd_count</span><span class="p">,</span> <span class="n">swr_ptr</span><span class="p">,</span> <span class="n">ch_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op</span> <span class="o">=</span> <span class="n">do_wr</span> <span class="o">?</span> <span class="n">MAINT_WR</span> <span class="o">:</span> <span class="n">MAINT_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RIO_MAINT_SPACE_SZ</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bd_ptr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">bd_base</span><span class="p">;</span>

	<span class="n">rd_count</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DRDCNT</span><span class="p">);</span>

	<span class="cm">/* Initialize DMA descriptor */</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">DTYPE2</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">op</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="n">destid</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bcount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">sys_size</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">raddr_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">hopcount</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">raddr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_wr</span><span class="p">)</span>
		<span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32p</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Start DMA operation */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rd_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>	<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DWRCNT</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DWRCNT</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Wait until DMA transfer is finished */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ch_stat</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_STS</span><span class="p">))</span>
							<span class="o">&amp;</span> <span class="n">TSI721_DMAC_STS_RUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s : DMA[%d] read timeout ch_status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">ch_id</span><span class="p">,</span> <span class="n">ch_stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wr</span><span class="p">)</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch_stat</span> <span class="o">&amp;</span> <span class="n">TSI721_DMAC_STS_ABORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If DMA operation aborted due to error,</span>
<span class="cm">		 * reinitialize DMA channel</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : DMA ABORT ch_stat=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ch_stat</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OP=%d : destid=%x hc=%x off=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">do_wr</span> <span class="o">?</span> <span class="n">MAINT_WR</span> <span class="o">:</span> <span class="n">MAINT_RD</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_INT_ALL</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_INT</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_CTL_INIT</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_CTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DWRCNT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wr</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wr</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">bd_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update descriptor status FIFO RD pointer.</span>
<span class="cm">	 * NOTE: Skipping check and clear FIFO entries because we are waiting</span>
<span class="cm">	 * for transfer to be completed.</span>
<span class="cm">	 */</span>
	<span class="n">swr_ptr</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DSWP</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">swr_ptr</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DSRP</span><span class="p">);</span>
<span class="nl">err_out:</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_cread_dma - Generate a RapidIO maintenance read transaction</span>
<span class="cm"> *                    using Tsi721 BDMA engine.</span>
<span class="cm"> * @mport: RapidIO master port control structure</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @destid: Destination ID of transaction</span>
<span class="cm"> * @hopcount: Number of hops to target device</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @val: Location to be read into</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a RapidIO maintenance read transaction.</span>
<span class="cm"> * Returns %0 on success and %-EINVAL or %-EFAULT on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_cread_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tsi721_maint_dma</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				<span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_cwrite_dma - Generate a RapidIO maintenance write transaction</span>
<span class="cm"> *                     using Tsi721 BDMA engine</span>
<span class="cm"> * @mport: RapidIO master port control structure</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @destid: Destination ID of transaction</span>
<span class="cm"> * @hopcount: Number of hops to target device</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @val: Value to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a RapidIO maintenance write transaction.</span>
<span class="cm"> * Returns %0 on success and %-EINVAL or %-EFAULT on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_cwrite_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tsi721_maint_dma</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span>
				<span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_pw_handler - Tsi721 inbound port-write interrupt handler</span>
<span class="cm"> * @mport: RapidIO master port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Handles inbound port-write interrupts. Copies PW message from an internal</span>
<span class="cm"> * buffer into PW message FIFO and schedules deferred routine to process</span>
<span class="cm"> * queued messages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tsi721_pw_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pw_stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pw_buf</span><span class="p">[</span><span class="n">TSI721_RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>


	<span class="n">pw_stat</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pw_stat</span> <span class="o">&amp;</span> <span class="n">TSI721_RIO_PW_RX_STAT_PW_VAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pw_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_CAPT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">pw_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_CAPT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">pw_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_CAPT</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">pw_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_CAPT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

		<span class="cm">/* Queue PW message (if there is room in FIFO),</span>
<span class="cm">		 * otherwise discard it.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TSI721_RIO_PW_MSG_SIZE</span><span class="p">)</span>
			<span class="n">kfifo_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">,</span> <span class="n">pw_buf</span><span class="p">,</span>
						<span class="n">TSI721_RIO_PW_MSG_SIZE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_discard_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear pending PW interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_RIO_PW_RX_STAT_PW_DISC</span> <span class="o">|</span> <span class="n">TSI721_RIO_PW_RX_STAT_PW_VAL</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_STAT</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_pw_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsi721_device</span><span class="p">,</span>
						    <span class="n">pw_work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">msg_buffer</span><span class="p">[</span><span class="n">RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span> <span class="cm">/* Use full size PW message</span>
<span class="cm">							buffer for RIO layer */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process port-write messages</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">kfifo_out_spinlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_buffer</span><span class="p">,</span>
			 <span class="n">TSI721_RIO_PW_MSG_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Process one message */</span>
<span class="cp">#ifdef DEBUG_PW</span>
		<span class="p">{</span>
		<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s : Port-Write Message:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;0x%02x: %08x %08x %08x %08x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">msg_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">msg_buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="n">msg_buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">msg_buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Pass the port-write message to RIO core for processing */</span>
		<span class="n">rio_inb_pwrite_handler</span><span class="p">((</span><span class="k">union</span> <span class="n">rio_pw_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_buffer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_pw_enable - enable/disable port-write interface init</span>
<span class="cm"> * @mport: Master port implementing the port write unit</span>
<span class="cm"> * @enable:    1=enable; 0=disable port-write message handling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_pw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_INT_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">|=</span> <span class="n">TSI721_RIO_EM_INT_ENABLE_PW_RX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI721_RIO_EM_INT_ENABLE_PW_RX</span><span class="p">;</span>

	<span class="cm">/* Clear pending PW interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_RIO_PW_RX_STAT_PW_DISC</span> <span class="o">|</span> <span class="n">TSI721_RIO_PW_RX_STAT_PW_VAL</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_RX_STAT</span><span class="p">);</span>
	<span class="cm">/* Update enable bits */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_INT_ENABLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_dsend - Send a RapidIO doorbell</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapidIO interface</span>
<span class="cm"> * @destid: Destination ID of target device</span>
<span class="cm"> * @data: 16-bit info field of RapidIO doorbell</span>
<span class="cm"> *</span>
<span class="cm"> * Sends a RapidIO doorbell message. Always returns %0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_dsend</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(((</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span><span class="p">)</span> <span class="o">?</span> <span class="n">RIO_TT_CODE_16</span> <span class="o">:</span> <span class="n">RIO_TT_CODE_8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">destid</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Send Doorbell 0x%04x to destID 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">destid</span><span class="p">);</span>
	<span class="n">iowrite16be</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">odb_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_dbell_handler - Tsi721 doorbell interrupt handler</span>
<span class="cm"> * @mport: RapidIO master port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Handles inbound doorbell interrupts. Copies doorbell entry from an internal</span>
<span class="cm"> * buffer into DB message FIFO and schedules deferred  routine to process</span>
<span class="cm"> * queued DBs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tsi721_dbell_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>

	<span class="cm">/* Disable IDB interrupts */</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINTE</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI721_SR_CHINT_IDBQRCV</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">regval</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINTE</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_db_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsi721_device</span><span class="p">,</span>
						    <span class="n">idb_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dbell</span> <span class="o">*</span><span class="n">dbell</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wr_ptr</span><span class="p">,</span> <span class="n">rd_ptr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">idb_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">msg</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">idb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process queued inbound doorbells</span>
<span class="cm">	 */</span>
	<span class="n">mport</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">;</span>

	<span class="n">wr_ptr</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_WP</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">))</span> <span class="o">%</span> <span class="n">IDB_QSIZE</span><span class="p">;</span>
	<span class="n">rd_ptr</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_RP</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">))</span> <span class="o">%</span> <span class="n">IDB_QSIZE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">wr_ptr</span> <span class="o">!=</span> <span class="n">rd_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idb_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">TSI721_IDB_ENTRY_SIZE</span> <span class="o">*</span> <span class="n">rd_ptr</span><span class="p">));</span>
		<span class="n">rd_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rd_ptr</span> <span class="o">%=</span> <span class="n">IDB_QSIZE</span><span class="p">;</span>
		<span class="n">idb</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="o">*</span><span class="n">idb_entry</span><span class="p">;</span>
		<span class="o">*</span><span class="n">idb_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Process one doorbell */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">dbells</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">DBELL_INF</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">DBELL_INF</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dinb</span><span class="p">(</span><span class="n">mport</span><span class="p">,</span> <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">DBELL_SID</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">),</span>
				    <span class="n">DBELL_TID</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">),</span> <span class="n">DBELL_INF</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;spurious inb doorbell, sid %2.2x tid %2.2x&quot;</span>
				<span class="s">&quot; info %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DBELL_SID</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">),</span>
				<span class="n">DBELL_TID</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">),</span> <span class="n">DBELL_INF</span><span class="p">(</span><span class="n">idb</span><span class="p">.</span><span class="n">bytes</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rd_ptr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IDB_QSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_RP</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="cm">/* Re-enable IDB interrupts */</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINTE</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="n">TSI721_SR_CHINT_IDBQRCV</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">regval</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINTE</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_irqhandler - Tsi721 interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @ptr: Pointer to interrupt-specific data (mport structure)</span>
<span class="cm"> *</span>
<span class="cm"> * Handles Tsi721 interrupts signaled using MSI and INTA. Checks reported</span>
<span class="cm"> * interrupt events and calls an event-specific handler(s).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi721_irqhandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_int</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_ch_int</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ch_inte</span><span class="p">;</span>

	<span class="n">dev_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_int</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">dev_ch_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_int</span> <span class="o">&amp;</span> <span class="n">TSI721_DEV_INT_SR2PC_CH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Service SR2PC Channel interrupts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_SR2PC_CHAN</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Service Inbound Doorbell interrupt */</span>
			<span class="n">intval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span>
						<span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="n">TSI721_SR_CHINT_IDBQRCV</span><span class="p">)</span>
				<span class="n">tsi721_dbell_handler</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Unsupported SR_CH_INT %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intval</span><span class="p">);</span>

			<span class="cm">/* Clear interrupts */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">intval</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
			<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_int</span> <span class="o">&amp;</span> <span class="n">TSI721_DEV_INT_SMSG_CH</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Service channel interrupts from Messaging Engine</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_IMSG_CHAN_M</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Inbound Msg */</span>
			<span class="cm">/* Disable signaled OB MSG Channel interrupts */</span>
			<span class="n">ch_inte</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
			<span class="n">ch_inte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_IMSG_CHAN_M</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">ch_inte</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Process Inbound Message interrupt for each MBOX</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">RIO_MAX_MBOX</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_IMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">)))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">tsi721_imsg_handler</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_OMSG_CHAN_M</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Outbound Msg */</span>
			<span class="cm">/* Disable signaled OB MSG Channel interrupts */</span>
			<span class="n">ch_inte</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
			<span class="n">ch_inte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_OMSG_CHAN_M</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">ch_inte</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Process Outbound Message interrupts for each MBOX</span>
<span class="cm">			 */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">RIO_MAX_MBOX</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_OMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">)))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">tsi721_omsg_handler</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_int</span> <span class="o">&amp;</span> <span class="n">TSI721_DEV_INT_SRIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Service SRIO MAC interrupts */</span>
		<span class="n">intval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_INT_STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="n">TSI721_RIO_EM_INT_STAT_PW_RX</span><span class="p">)</span>
			<span class="n">tsi721_pw_handler</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_int</span> <span class="o">&amp;</span> <span class="n">TSI721_DEV_INT_BDMA_CH</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_BDMA_CHAN_M</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;IRQ from DMA channel 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_ch_int</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">TSI721_DMA_MAXCH</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_INT_BDMA_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">)))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">tsi721_bdma_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdma</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_interrupts_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">;</span>

	<span class="cm">/* Enable IDB interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_SR_CHINT_ALL</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_SR_CHINT_IDBQRCV</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINTE</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="cm">/* Enable SRIO MAC interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_RIO_EM_DEV_INT_EN_INT</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_DEV_INT_EN</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts from channels in use */</span>
<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">TSI721_INT_SR2PC_CHAN</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">TSI721_INT_BDMA_CHAN_M</span> <span class="o">&amp;</span>
		 <span class="o">~</span><span class="n">TSI721_INT_BDMA_CHAN</span><span class="p">(</span><span class="n">TSI721_DMACH_MAINT</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">TSI721_INT_SR2PC_CHAN</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span>
		<span class="n">intr</span> <span class="o">=</span> <span class="n">TSI721_DEV_INT_SRIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">intr</span> <span class="o">=</span> <span class="n">TSI721_DEV_INT_SR2PC_CH</span> <span class="o">|</span> <span class="n">TSI721_DEV_INT_SRIO</span> <span class="o">|</span>
			<span class="n">TSI721_DEV_INT_SMSG_CH</span> <span class="o">|</span> <span class="n">TSI721_DEV_INT_BDMA_CH</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_INTE</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_INTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="cm">/**</span>
<span class="cm"> * tsi721_omsg_msix - MSI-X interrupt handler for outbound messaging</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @ptr: Pointer to interrupt-specific data (mport structure)</span>
<span class="cm"> *</span>
<span class="cm"> * Handles outbound messaging interrupts signaled using MSI-X.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi721_omsg_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbox</span><span class="p">;</span>

	<span class="n">mbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span><span class="p">].</span><span class="n">vector</span><span class="p">)</span> <span class="o">%</span> <span class="n">RIO_MAX_MBOX</span><span class="p">;</span>
	<span class="n">tsi721_omsg_handler</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_imsg_msix - MSI-X interrupt handler for inbound messaging</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @ptr: Pointer to interrupt-specific data (mport structure)</span>
<span class="cm"> *</span>
<span class="cm"> * Handles inbound messaging interrupts signaled using MSI-X.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi721_imsg_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbox</span><span class="p">;</span>

	<span class="n">mbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span><span class="p">].</span><span class="n">vector</span><span class="p">)</span> <span class="o">%</span> <span class="n">RIO_MAX_MBOX</span><span class="p">;</span>
	<span class="n">tsi721_imsg_handler</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mbox</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_srio_msix - Tsi721 MSI-X SRIO MAC interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @ptr: Pointer to interrupt-specific data (mport structure)</span>
<span class="cm"> *</span>
<span class="cm"> * Handles Tsi721 interrupts from SRIO MAC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi721_srio_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srio_int</span><span class="p">;</span>

	<span class="cm">/* Service SRIO MAC interrupts */</span>
	<span class="n">srio_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_INT_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srio_int</span> <span class="o">&amp;</span> <span class="n">TSI721_RIO_EM_INT_STAT_PW_RX</span><span class="p">)</span>
		<span class="n">tsi721_pw_handler</span><span class="p">((</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_sr2pc_ch_msix - Tsi721 MSI-X SR2PC Channel interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @ptr: Pointer to interrupt-specific data (mport structure)</span>
<span class="cm"> *</span>
<span class="cm"> * Handles Tsi721 interrupts from SR2PC Channel.</span>
<span class="cm"> * NOTE: At this moment services only one SR2PC channel associated with inbound</span>
<span class="cm"> * doorbells.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi721_sr2pc_ch_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sr_ch_int</span><span class="p">;</span>

	<span class="cm">/* Service Inbound DB interrupt from SR2PC channel */</span>
	<span class="n">sr_ch_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr_ch_int</span> <span class="o">&amp;</span> <span class="n">TSI721_SR_CHINT_IDBQRCV</span><span class="p">)</span>
		<span class="n">tsi721_dbell_handler</span><span class="p">((</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>

	<span class="cm">/* Clear interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">sr_ch_int</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="cm">/* Read back to ensure that interrupt was cleared */</span>
	<span class="n">sr_ch_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINT</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_request_msix - register interrupt service for MSI-X mode.</span>
<span class="cm"> * @mport: RapidIO master port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Registers MSI-X interrupt service routines for interrupts that are active</span>
<span class="cm"> * immediately after mport initialization. Messaging interrupt service routines</span>
<span class="cm"> * should be registered during corresponding open requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_request_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">tsi721_sr2pc_ch_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_PWRX</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">tsi721_srio_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_PWRX</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_enable_msix - Attempts to enable MSI-X support for Tsi721.</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Configures MSI-X support for Tsi721. Supports only an exact number</span>
<span class="cm"> * of requested vectors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">TSI721_MSIX_SR2PC_IDBQ_RCV</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">);</span>
	<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_PWRX</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">TSI721_MSIX_SRIO_MAC_INT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize MSI-X entries for Messaging Engine:</span>
<span class="cm">	 * this driver supports four RIO mailboxes (inbound and outbound)</span>
<span class="cm">	 * NOTE: Inbound message MBOX 0...4 use IB channels 4...7. Therefore</span>
<span class="cm">	 * offset +4 is added to IB MBOX number.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RIO_MAX_MBOX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span>
					<span class="n">TSI721_MSIX_IMSG_DQ_RCV</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span>
					<span class="n">TSI721_MSIX_IMSG_INT</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span>
					<span class="n">TSI721_MSIX_OMSG_DONE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span>
					<span class="n">TSI721_MSIX_OMSG_INT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize MSI-X entries for Block DMA Engine:</span>
<span class="cm">	 * this driver supports XXX DMA channels</span>
<span class="cm">	 * (one is reserved for SRIO maintenance transactions)</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI721_DMA_CHNUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span>
					<span class="n">TSI721_MSIX_DMACH_DONE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span>
					<span class="n">TSI721_MSIX_DMACH_INT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RAPIDIO_DMA_ENGINE */</span><span class="cp"></span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">entries</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Only %d MSI-X vectors available, &quot;</span>
				 <span class="s">&quot;not using MSI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to enable MSI-X (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy MSI-X vector information into tsi721 private structure</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IDB</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span>
		 <span class="n">DRV_NAME</span> <span class="s">&quot;-idb@pci:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_PWRX</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_PWRX</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_PWRX</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span>
		 <span class="n">DRV_NAME</span> <span class="s">&quot;-pwrx@pci:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RIO_MAX_MBOX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span>
				<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			 <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;-imbr%d@pci:%s&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span>
				<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			 <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;-imbi%d@pci:%s&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span>
				<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			 <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;-ombd%d@pci:%s&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span>
				<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			 <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;-ombi%d@pci:%s&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI721_DMA_CHNUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span>
				<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_DONE</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			 <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;-dmad%d@pci:%s&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span>
				<span class="n">entries</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_DMA0_INT</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			 <span class="n">IRQ_DEVICE_NAME_MAX</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;-dmai%d@pci:%s&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RAPIDIO_DMA_ENGINE */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tsi721_request_msix</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tsi721_irqhandler</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">DRV_NAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unable to allocate interrupt, Error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_init_pc2sr_mapping - initializes outbound (PCIe-&gt;SRIO)</span>
<span class="cm"> * translation regions.</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Disables SREP translation regions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_init_pc2sr_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable all PC2SR translation windows */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI721_OBWIN_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBWINLB</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_init_sr2pc_mapping - initializes inbound (SRIO-&gt;PCIe)</span>
<span class="cm"> * translation regions.</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Disables inbound windows.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_init_sr2pc_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable all SR2PC inbound windows */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI721_IBWIN_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBWINLB</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_port_write_init - Inbound port write interface init</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes inbound port write handler.</span>
<span class="cm"> * Returns %0 on success or %-ENOMEM on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_port_write_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_discard_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_work</span><span class="p">,</span> <span class="n">tsi721_pw_dpc</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">,</span>
			<span class="n">TSI721_RIO_PW_MSG_SIZE</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PW FIFO allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use reliable port-write capture mode */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_RIO_PW_CTL_PWC_REL</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_PW_CTL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_doorbell_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Outbound Doorbells do not require any setup.</span>
<span class="cm">	 * Tsi721 uses dedicated PCI BAR1 to generate doorbells.</span>
<span class="cm">	 * That BAR1 was mapped during the probe routine.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Initialize Inbound Doorbell processing DPC and queue */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">db_discard_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_work</span><span class="p">,</span> <span class="n">tsi721_db_dpc</span><span class="p">);</span>

	<span class="cm">/* Allocate buffer for inbound doorbells queue */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span> <span class="o">=</span> <span class="n">dma_zalloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">IDB_QSIZE</span> <span class="o">*</span> <span class="n">TSI721_IDB_ENTRY_SIZE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Allocated IDB buffer @ %p (phys = %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_dma</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_IDQ_SIZE_VAL</span><span class="p">(</span><span class="n">IDB_QSIZE</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_SIZE</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_BASEU</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_dma</span> <span class="o">&amp;</span> <span class="n">TSI721_IDQ_BASEL_ADDR</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_BASEL</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>
	<span class="cm">/* Enable accepting all inbound doorbells */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_MASK</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_IDQ_INIT</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_CTL</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IDQ_RP</span><span class="p">(</span><span class="n">IDB_QUEUE</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_doorbell_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Free buffer allocated for inbound doorbell queue */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IDB_QSIZE</span> <span class="o">*</span> <span class="n">TSI721_IDB_ENTRY_SIZE</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_dma</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">idb_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_bdma_maint_init - Initialize maintenance request BDMA channel.</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize BDMA channel allocated for RapidIO maintenance read/write</span>
<span class="cm"> * request generation</span>
<span class="cm"> * Returns %0 on success or %-ENOMEM on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_bdma_maint_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_dma_desc</span> <span class="o">*</span><span class="n">bd_ptr</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="o">*</span><span class="n">sts_ptr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">bd_phys</span><span class="p">,</span> <span class="n">sts_phys</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sts_size</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">bd_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Init Block DMA Engine for Maintenance requests, CH%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">TSI721_DMACH_MAINT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize DMA channel for maintenance requests</span>
<span class="cm">	 */</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">ch_id</span> <span class="o">=</span> <span class="n">TSI721_DMACH_MAINT</span><span class="p">;</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_BASE</span><span class="p">(</span><span class="n">TSI721_DMACH_MAINT</span><span class="p">);</span>

	<span class="cm">/* Allocate space for DMA descriptors */</span>
	<span class="n">bd_ptr</span> <span class="o">=</span> <span class="n">dma_zalloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">bd_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_desc</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">bd_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">bd_num</span> <span class="o">=</span> <span class="n">bd_num</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">bd_phys</span> <span class="o">=</span> <span class="n">bd_phys</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">bd_base</span> <span class="o">=</span> <span class="n">bd_ptr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA descriptors @ %p (phys = %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bd_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bd_phys</span><span class="p">);</span>

	<span class="cm">/* Allocate space for descriptor status FIFO */</span>
	<span class="n">sts_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">bd_num</span> <span class="o">&gt;=</span> <span class="n">TSI721_DMA_MINSTSSZ</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">bd_num</span> <span class="o">:</span> <span class="n">TSI721_DMA_MINSTSSZ</span><span class="p">;</span>
	<span class="n">sts_size</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">sts_size</span><span class="p">);</span>
	<span class="n">sts_ptr</span> <span class="o">=</span> <span class="n">dma_zalloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">sts_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_sts</span><span class="p">),</span>
				     <span class="o">&amp;</span><span class="n">sts_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sts_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Free space allocated for DMA descriptors */</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">bd_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_desc</span><span class="p">),</span>
				  <span class="n">bd_ptr</span><span class="p">,</span> <span class="n">bd_phys</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">bd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">sts_phys</span> <span class="o">=</span> <span class="n">sts_phys</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">sts_base</span> <span class="o">=</span> <span class="n">sts_ptr</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">.</span><span class="n">sts_size</span> <span class="o">=</span> <span class="n">sts_size</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;desc status FIFO @ %p (phys = %llx) size=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sts_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sts_phys</span><span class="p">,</span> <span class="n">sts_size</span><span class="p">);</span>

	<span class="cm">/* Initialize DMA descriptors ring */</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">bd_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">type_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DTYPE3</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">bd_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_phys</span> <span class="o">&amp;</span>
						 <span class="n">TSI721_DMAC_DPTRL_MASK</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">bd_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Setup DMA descriptor pointers */</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>	<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DPTRH</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_phys</span> <span class="o">&amp;</span> <span class="n">TSI721_DMAC_DPTRL_MASK</span><span class="p">),</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DPTRL</span><span class="p">);</span>

	<span class="cm">/* Setup descriptor status FIFO */</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">sts_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DSBH</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">sts_phys</span> <span class="o">&amp;</span> <span class="n">TSI721_DMAC_DSBL_MASK</span><span class="p">),</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DSBL</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_DSSZ_SIZE</span><span class="p">(</span><span class="n">sts_size</span><span class="p">),</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_DSSZ</span><span class="p">);</span>

	<span class="cm">/* Clear interrupt bits */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_INT_ALL</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_INT</span><span class="p">);</span>

	<span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_INT</span><span class="p">);</span>

	<span class="cm">/* Toggle DMA channel initialization */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_CTL_INIT</span><span class="p">,</span>	<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_CTL</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_CTL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_bdma_maint_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ch_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi721_bdma_maint</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_BASE</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">ch_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">bd_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if DMA channel still running */</span>
	<span class="n">ch_stat</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_stat</span> <span class="o">&amp;</span> <span class="n">TSI721_DMAC_STS_RUN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Put DMA channel into init state */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_CTL_INIT</span><span class="p">,</span>	<span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_CTL</span><span class="p">);</span>

	<span class="cm">/* Free space allocated for DMA descriptors */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">bd_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_desc</span><span class="p">),</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">bd_base</span><span class="p">,</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">);</span>
	<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">bd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free space allocated for status FIFO */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">sts_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_sts</span><span class="p">),</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">sts_base</span><span class="p">,</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">sts_phys</span><span class="p">);</span>
	<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">sts_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enable Inbound Messaging Interrupts */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tsi721_imsg_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">inte_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inte_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear pending Inbound Messaging interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">inte_mask</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Enable Inbound Messaging interrupts */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span> <span class="o">|</span> <span class="n">inte_mask</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Finished if we are in MSI-X mode */</span>

	<span class="cm">/*</span>
<span class="cm">	 * For MSI and INTA interrupt signalling we need to enable next levels</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enable Device Channel Interrupt */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span> <span class="o">|</span> <span class="n">TSI721_INT_IMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disable Inbound Messaging Interrupts */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tsi721_imsg_interrupt_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">inte_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inte_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear pending Inbound Messaging interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">inte_mask</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Disable Inbound Messaging interrupts */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">rval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">inte_mask</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Finished if we are in MSI-X mode */</span>

	<span class="cm">/*</span>
<span class="cm">	 * For MSI and INTA interrupt signalling we need to disable next levels</span>
<span class="cm">	 */</span>

	<span class="cm">/* Disable Device Channel Interrupt */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI721_INT_IMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable Outbound Messaging interrupts */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tsi721_omsg_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">inte_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inte_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear pending Outbound Messaging interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">inte_mask</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Enable Outbound Messaging channel interrupts */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span> <span class="o">|</span> <span class="n">inte_mask</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Finished if we are in MSI-X mode */</span>

	<span class="cm">/*</span>
<span class="cm">	 * For MSI and INTA interrupt signalling we need to enable next levels</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enable Device Channel Interrupt */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span> <span class="o">|</span> <span class="n">TSI721_INT_OMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disable Outbound Messaging interrupts */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tsi721_omsg_interrupt_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">inte_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inte_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear pending Outbound Messaging interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">inte_mask</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Disable Outbound Messaging interrupts */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">rval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">inte_mask</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Finished if we are in MSI-X mode */</span>

	<span class="cm">/*</span>
<span class="cm">	 * For MSI and INTA interrupt signalling we need to disable next levels</span>
<span class="cm">	 */</span>

	<span class="cm">/* Disable Device Channel Interrupt */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI721_INT_OMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_add_outb_message - Add message to the Tsi721 outbound message queue</span>
<span class="cm"> * @mport: Master port with outbound message queue</span>
<span class="cm"> * @rdev: Target of outbound message</span>
<span class="cm"> * @mbox: Outbound mailbox</span>
<span class="cm"> * @buffer: Message to add to outbound queue</span>
<span class="cm"> * @len: Length of message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tsi721_add_outb_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi721_omsg_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_slot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">len</span> <span class="o">&gt;</span> <span class="n">TSI721_MSG_MAX_SIZE</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tx_slot</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">tx_slot</span><span class="p">;</span>

	<span class="cm">/* Copy copy message into transfer buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Build descriptor associated with buffer */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">].</span><span class="n">type_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">DTYPE4</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">|</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_slot</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">].</span><span class="n">type_id</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TSI721_OMD_IOF</span><span class="p">);</span>

	<span class="n">desc</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">].</span><span class="n">msg_info</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mbox</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="mh">0xe</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff8</span><span class="p">));</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">].</span><span class="n">bufptr_lo</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_phys</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">].</span><span class="n">bufptr_hi</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_phys</span><span class="p">[</span><span class="n">tx_slot</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">wr_count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Go to next descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">tx_slot</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Move through the ring link descriptor at the end */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">wr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Set new write count value */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">wr_count</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DWRCNT</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DWRCNT</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_omsg_handler - Outbound Message Interrupt Handler</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> * @ch:   number of OB MSG channel to service</span>
<span class="cm"> *</span>
<span class="cm"> * Services channel interrupts from outbound messaging engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_omsg_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">omsg_int</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">omsg_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omsg_int</span> <span class="o">&amp;</span> <span class="n">TSI721_OBDMAC_INT_ST_FULL</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;OB MBOX%d: Status FIFO is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omsg_int</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI721_OBDMAC_INT_DONE</span> <span class="o">|</span> <span class="n">TSI721_OBDMAC_INT_IOF_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">srd_ptr</span><span class="p">;</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">sts_ptr</span><span class="p">,</span> <span class="n">last_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tx_slot</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Find last successfully processed descriptor</span>
<span class="cm">		 */</span>

		<span class="cm">/* Check and clear descriptor status FIFO entries */</span>
		<span class="n">srd_ptr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">sts_rdptr</span><span class="p">;</span>
		<span class="n">sts_ptr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">sts_base</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">srd_ptr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sts_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">sts_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prev_ptr</span> <span class="o">=</span> <span class="n">last_ptr</span><span class="p">;</span>
				<span class="n">last_ptr</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sts_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">sts_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="o">++</span><span class="n">srd_ptr</span><span class="p">;</span>
			<span class="n">srd_ptr</span> <span class="o">%=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">sts_size</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">srd_ptr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last_ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_sts_update</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">sts_rdptr</span> <span class="o">=</span> <span class="n">srd_ptr</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">srd_ptr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DSRP</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">mcback</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_sts_update</span><span class="p">;</span>

		<span class="cm">/* Inform upper layer about transfer completion */</span>

		<span class="n">tx_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_ptr</span> <span class="o">-</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">omd_phys</span><span class="p">)</span><span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_omsg_desc</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if this is a Link Descriptor (LD).</span>
<span class="cm">		 * If yes, ignore LD and use descriptor processed</span>
<span class="cm">		 * before LD.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_slot</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_ptr</span><span class="p">)</span>
				<span class="n">tx_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_ptr</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">omd_phys</span><span class="p">)</span><span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_omsg_desc</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">no_sts_update</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Move slot index to the next message to be sent */</span>
		<span class="o">++</span><span class="n">tx_slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_slot</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
			<span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tx_slot</span> <span class="o">&gt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">mcback</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
				<span class="n">tx_slot</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">no_sts_update:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omsg_int</span> <span class="o">&amp;</span> <span class="n">TSI721_OBDMAC_INT_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* Outbound message operation aborted due to error,</span>
<span class="cm">		* reinitialize OB MSG channel</span>
<span class="cm">		*/</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OB MSG ABORT ch_stat=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_STS</span><span class="p">(</span><span class="n">ch</span><span class="p">)));</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_OBDMAC_INT_ERROR</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_OBDMAC_CTL_INIT</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_CTL</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
		<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_CTL</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

		<span class="cm">/* Inform upper level to clear all pending tx slots */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">mcback</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">mcback</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_slot</span><span class="p">);</span>
		<span class="cm">/* Synch tx_slot tracking */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_slot</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DRDCNT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
		<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DRDCNT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">wr_count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">tx_slot</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">sts_rdptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear channel interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">omsg_int</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ch_inte</span><span class="p">;</span>

		<span class="cm">/* Re-enable channel interrupts */</span>
		<span class="n">ch_inte</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
		<span class="n">ch_inte</span> <span class="o">|=</span> <span class="n">TSI721_INT_OMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">ch_inte</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_open_outb_mbox - Initialize Tsi721 outbound mailbox</span>
<span class="cm"> * @mport: Master port implementing Outbound Messaging Engine</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @mbox: Mailbox to open</span>
<span class="cm"> * @entries: Number of entries in the outbound mailbox ring</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_open_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi721_omsg_desc</span> <span class="o">*</span><span class="n">bd_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="n">TSI721_OMSGD_MIN_RING_SIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">TSI721_OMSGD_RING_SIZE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">entries</span><span class="p">))</span> <span class="o">||</span> <span class="n">mbox</span> <span class="o">&gt;=</span> <span class="n">RIO_MAX_MBOX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_rdptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Outbound Msg Buffer allocation based on</span>
<span class="cm">	   the number of maximum descriptor entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">dma_alloc_coherent</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TSI721_MSG_BUFFER_SIZE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to allocate OB MSG data buffer for&quot;</span>
				<span class="s">&quot; MBOX%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Outbound message descriptor allocation */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_omsg_desc</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unable to allocate OB MSG descriptor memory &quot;</span>
			<span class="s">&quot;for MBOX%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Outbound message descriptor status FIFO allocation */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_size</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_base</span> <span class="o">=</span> <span class="n">dma_zalloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_size</span> <span class="o">*</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_sts</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unable to allocate OB MSG descriptor status FIFO &quot;</span>
			<span class="s">&quot;for MBOX%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure Outbound Messaging Engine</span>
<span class="cm">	 */</span>

	<span class="cm">/* Setup Outbound Message descriptor pointer */</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DPTRH</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span> <span class="o">&amp;</span>
					<span class="n">TSI721_OBDMAC_DPTRL_MASK</span><span class="p">),</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DPTRL</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>

	<span class="cm">/* Setup Outbound Message descriptor status FIFO */</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DSBH</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_phys</span> <span class="o">&amp;</span>
					<span class="n">TSI721_OBDMAC_DSBL_MASK</span><span class="p">),</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DSBL</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_DSSZ_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_size</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">TSI721_OBDMAC_DSSZ</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>

	<span class="cm">/* Enable interrupts */</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Request interrupt service if we are in MSI-X mode */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">tsi721_omsg_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to allocate MSI-X interrupt for &quot;</span>
				<span class="s">&quot;OBOX%d-DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_stat</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">tsi721_omsg_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to allocate MSI-X interrupt for &quot;</span>
				<span class="s">&quot;MBOX%d-INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_stat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

	<span class="n">tsi721_omsg_interrupt_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">TSI721_OBDMAC_INT_ALL</span><span class="p">);</span>

	<span class="cm">/* Initialize Outbound Message descriptors ring */</span>
	<span class="n">bd_ptr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span><span class="p">;</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">entries</span><span class="p">].</span><span class="n">type_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DTYPE5</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">entries</span><span class="p">].</span><span class="n">msg_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">entries</span><span class="p">].</span><span class="n">next_lo</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span> <span class="o">&amp;</span>
		<span class="n">TSI721_OBDMAC_DPTRL_MASK</span><span class="p">);</span>
	<span class="n">bd_ptr</span><span class="p">[</span><span class="n">entries</span><span class="p">].</span><span class="n">next_hi</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">wr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Initialize Outbound Message engine */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_OBDMAC_CTL_INIT</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_CTL</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_DWRCNT</span><span class="p">(</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="nl">out_stat:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_sts</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="nl">out_desc:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_omsg_desc</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out_buf:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">TSI721_MSG_BUFFER_SIZE</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_close_outb_mbox - Close Tsi721 outbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the outbound message unit</span>
<span class="cm"> * @mbox: Mailbox to close</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_close_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable Interrupts */</span>

	<span class="n">tsi721_omsg_interrupt_disable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">TSI721_OBDMAC_INT_ALL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_DONE</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_OMB0_INT</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

	<span class="cm">/* Free OMSG Descriptor Status FIFO */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_dma_sts</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">sts_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free OMSG descriptors */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_omsg_desc</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free message buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">TSI721_MSG_BUFFER_SIZE</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">omsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">omq_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_imsg_handler - Inbound Message Interrupt Handler</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> * @ch: inbound message channel number to service</span>
<span class="cm"> *</span>
<span class="cm"> * Services channel interrupts from inbound messaging engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_imsg_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mbox</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">imsg_int</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">imsg_int</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imsg_int</span> <span class="o">&amp;</span> <span class="n">TSI721_IBDMAC_INT_SRTO</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IB MBOX%d SRIO timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mbox</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imsg_int</span> <span class="o">&amp;</span> <span class="n">TSI721_IBDMAC_INT_PC_ERROR</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IB MBOX%d PCIe error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mbox</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imsg_int</span> <span class="o">&amp;</span> <span class="n">TSI721_IBDMAC_INT_FQ_LOW</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;IB MBOX%d IB free queue low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>

	<span class="cm">/* Clear IB channel interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">imsg_int</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* If an IB Msg is received notify the upper layer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imsg_int</span> <span class="o">&amp;</span> <span class="n">TSI721_IBDMAC_INT_DQ_RCV</span> <span class="o">&amp;&amp;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">mcback</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">mcback</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ch_inte</span><span class="p">;</span>

		<span class="cm">/* Re-enable channel interrupts */</span>
		<span class="n">ch_inte</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
		<span class="n">ch_inte</span> <span class="o">|=</span> <span class="n">TSI721_INT_IMSG_CHAN</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">ch_inte</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_open_inb_mbox - Initialize Tsi721 inbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the Inbound Messaging Engine</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @mbox: Mailbox to open</span>
<span class="cm"> * @entries: Number of entries in the inbound mailbox ring</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_open_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">mbox</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">free_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="n">TSI721_IMSGD_MIN_RING_SIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="n">TSI721_IMSGD_RING_SIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">entries</span><span class="p">))</span> <span class="o">||</span> <span class="n">mbox</span> <span class="o">&gt;=</span> <span class="n">RIO_MAX_MBOX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize IB Messaging Ring */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">desc_rdptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">fq_wrptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Allocate buffers for incoming messages */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">entries</span> <span class="o">*</span> <span class="n">TSI721_MSG_BUFFER_SIZE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_phys</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate buffers for IB MBOX%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for circular free list */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">entries</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_phys</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate free queue for IB MBOX%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for Inbound message descriptors */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_imsg_desc</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate descriptor memory for IB MBOX%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mbox</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill free buffer pointer list */</span>
	<span class="n">free_ptr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_phys</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">i</span> <span class="o">*</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * For mapping of inbound SRIO Messages into appropriate queues we need</span>
<span class="cm">	 * to set Inbound Device ID register in the messaging engine. We do it</span>
<span class="cm">	 * once when first inbound mailbox is requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_IMSGID_SET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">host_deviceid</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IB_DEVID</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TSI721_IMSGID_SET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure Inbound Messaging channel (ch = mbox + 4)</span>
<span class="cm">	 */</span>

	<span class="cm">/* Setup Inbound Message free queue */</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_FQBH</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_phys</span> <span class="o">&amp;</span>
			<span class="n">TSI721_IBDMAC_FQBL_MASK</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">TSI721_IBDMAC_FQBL</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_DSSZ_SIZE</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_FQSZ</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Setup Inbound Message descriptor queue */</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_DQBH</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_phys</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">TSI721_IBDMAC_DQBL_MASK</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">+</span><span class="n">TSI721_IBDMAC_DQBL</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_DMAC_DSSZ_SIZE</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_DQSZ</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Enable interrupts */</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Request interrupt service if we are in MSI-X mode */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">tsi721_imsg_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to allocate MSI-X interrupt for &quot;</span>
				<span class="s">&quot;IBOX%d-DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_desc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">tsi721_imsg_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">irq_name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to allocate MSI-X interrupt for &quot;</span>
				<span class="s">&quot;IBOX%d-INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_desc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

	<span class="n">tsi721_imsg_interrupt_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">TSI721_IBDMAC_INT_ALL</span><span class="p">);</span>

	<span class="cm">/* Initialize Inbound Message Engine */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_IBDMAC_CTL_INIT</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_CTL</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_CTL</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">fq_wrptr</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_FQWP</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="nl">out_desc:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_imsg_desc</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="nl">out_dma:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out_buf:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="n">TSI721_MSG_BUFFER_SIZE</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_close_inb_mbox - Shut down Tsi721 inbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the Inbound Messaging Engine</span>
<span class="cm"> * @mbox: Mailbox to close</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_close_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">mbox</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">])</span> <span class="cm">/* mbox isn&#39;t initialized yet */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable Inbound Messaging Engine */</span>

	<span class="cm">/* Disable Interrupts */</span>
	<span class="n">tsi721_imsg_interrupt_disable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">TSI721_OBDMAC_INT_MASK</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TSI721_USING_MSIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_RCV</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">[</span><span class="n">TSI721_VECT_IMB0_INT</span> <span class="o">+</span> <span class="n">mbox</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

	<span class="cm">/* Clear Inbound Buffer Queue */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_slot</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">rx_slot</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">rx_slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free memory allocated for message buffers */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="n">TSI721_MSG_BUFFER_SIZE</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free memory allocated for free pointr list */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free memory allocated for RX descriptors */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_imsg_desc</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_phys</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_add_inb_buffer - Add buffer to the Tsi721 inbound message queue</span>
<span class="cm"> * @mport: Master port implementing the Inbound Messaging Engine</span>
<span class="cm"> * @mbox: Inbound mailbox number</span>
<span class="cm"> * @buf: Buffer to add to inbound queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_add_inb_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rx_slot</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">rx_slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">rx_slot</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Error adding inbound buffer %d, buffer exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rx_slot</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">rx_slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">rx_slot</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_get_inb_message - Fetch inbound message from the Tsi721 MSG Queue</span>
<span class="cm"> * @mport: Master port implementing the Inbound Messaging Engine</span>
<span class="cm"> * @mbox: Inbound mailbox number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to the message on success or NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tsi721_get_inb_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi721_imsg_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_slot</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rx_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_phys</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">free_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">mbox</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msg_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_init</span><span class="p">[</span><span class="n">mbox</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imd_base</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">desc_rdptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">msg_info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSI721_IMD_HO</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rx_slot</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">rx_slot</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">rx_slot</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rx_slot</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
			<span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_phys</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bufptr_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bufptr_lo</span><span class="p">);</span>

	<span class="n">rx_virt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_base</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">rx_phys</span> <span class="o">-</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">buf_phys</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">rx_slot</span><span class="p">];</span>
	<span class="n">msg_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">msg_info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TSI721_IMD_BCOUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msg_size</span> <span class="o">=</span> <span class="n">RIO_MAX_MSG_SIZE</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rx_virt</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imq_base</span><span class="p">[</span><span class="n">rx_slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">msg_info</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">TSI721_IMD_HO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">desc_rdptr</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">desc_rdptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">desc_rdptr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_DQRP</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Return free buffer into the pointer list */</span>
	<span class="n">free_ptr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">imfq_base</span><span class="p">;</span>
	<span class="n">free_ptr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">fq_wrptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rx_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">fq_wrptr</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">fq_wrptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">imsg_ring</span><span class="p">[</span><span class="n">mbox</span><span class="p">].</span><span class="n">fq_wrptr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_FQWP</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_messages_init - Initialization of Messaging Engine</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Configures Tsi721 messaging engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi721_messages_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ch</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SMSG_ECC_LOG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RETRY_GEN_CNT</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RETRY_RX_CNT</span><span class="p">);</span>

	<span class="cm">/* Set SRIO Message Request/Response Timeout */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_RQRPTO_VAL</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RQRPTO</span><span class="p">);</span>

	<span class="cm">/* Initialize Inbound Messaging Engine Registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">TSI721_IMSG_CHNUM</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear interrupt bits */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_IBDMAC_INT_MASK</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INT</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
		<span class="cm">/* Clear Status */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_STS</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_SMSG_ECC_COR_LOG_MASK</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SMSG_ECC_COR_LOG</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">TSI721_SMSG_ECC_NCOR_MASK</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SMSG_ECC_NCOR</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_disable_ints - disables all device interrupts</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi721_disable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="cm">/* Disable all device level interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all Device Channel interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEV_CHAN_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all Inbound Msg Channel interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">TSI721_IMSG_CHNUM</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_IBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Disable all Outbound Msg Channel interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">TSI721_OMSG_CHNUM</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_OBDMAC_INTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Disable all general messaging interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SMSG_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all BDMA Channel interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">TSI721_DMA_MAXCH</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DMAC_BASE</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">+</span> <span class="n">TSI721_DMAC_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all general BDMA interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_BDMA_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all SRIO Channel interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">TSI721_SRIO_MAXCH</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR_CHINTE</span><span class="p">(</span><span class="n">ch</span><span class="p">));</span>

	<span class="cm">/* Disable all general SR2PC interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_SR2PC_GEN_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all PC2SR interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_PC2SR_INTE</span><span class="p">);</span>

	<span class="cm">/* Disable all I2C interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_I2C_INT_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Disable SRIO MAC interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_INT_ENABLE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_RIO_EM_DEV_INT_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tsi721_setup_mport - Setup Tsi721 as RapidIO subsystem master port</span>
<span class="cm"> * @priv: pointer to tsi721 private data</span>
<span class="cm"> *</span>
<span class="cm"> * Configures Tsi721 as RapidIO master port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tsi721_setup_mport</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_ops</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for rio_ops</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">lcread</span> <span class="o">=</span> <span class="n">tsi721_lcread</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">lcwrite</span> <span class="o">=</span> <span class="n">tsi721_lcwrite</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">cread</span> <span class="o">=</span> <span class="n">tsi721_cread_dma</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">cwrite</span> <span class="o">=</span> <span class="n">tsi721_cwrite_dma</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">dsend</span> <span class="o">=</span> <span class="n">tsi721_dsend</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_inb_mbox</span> <span class="o">=</span> <span class="n">tsi721_open_inb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_inb_mbox</span> <span class="o">=</span> <span class="n">tsi721_close_inb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_outb_mbox</span> <span class="o">=</span> <span class="n">tsi721_open_outb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_outb_mbox</span> <span class="o">=</span> <span class="n">tsi721_close_outb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_outb_message</span> <span class="o">=</span> <span class="n">tsi721_add_outb_message</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_inb_buffer</span> <span class="o">=</span> <span class="n">tsi721_add_inb_buffer</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_inb_message</span> <span class="o">=</span> <span class="n">tsi721_get_inb_message</span><span class="p">;</span>

	<span class="n">mport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for mport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mport</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">mport</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mport</span><span class="o">-&gt;</span><span class="n">sys_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* small system */</span>
	<span class="n">mport</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">RIO_PHY_SERIAL</span><span class="p">;</span>
	<span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">mport</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mport</span> <span class="o">=</span> <span class="n">mport</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">dbells</span><span class="p">);</span>

	<span class="n">rio_init_dbell_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_DOORBELL_RESOURCE</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">rio_init_mbox_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_INB_MBOX_RESOURCE</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rio_init_mbox_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_OUTB_MBOX_RESOURCE</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Tsi721 mport&quot;</span><span class="p">);</span>

	<span class="cm">/* Hook up interrupt handler */</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tsi721_enable_msix</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TSI721_USING_MSIX</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TSI721_USING_MSI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;MSI/MSI-X is not available. Using legacy INTx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tsi721_request_irq</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsi721_interrupts_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwenable</span> <span class="o">=</span> <span class="n">tsi721_pw_enable</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get assigned PCI IRQ &quot;</span>
			<span class="s">&quot;vector %02X err=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
	<span class="n">tsi721_register_dma</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Enable SRIO link */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEVCTL</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">TSI721_DEVCTL_SRBOOT_CMPL</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">TSI721_DEVCTL</span><span class="p">);</span>

	<span class="n">rio_register_mport</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">host_deviceid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">RIO_PORT_GEN_HOST</span> <span class="o">|</span> <span class="n">RIO_PORT_GEN_MASTER</span> <span class="o">|</span>
			  <span class="n">RIO_PORT_GEN_DISCOVERED</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">+</span> <span class="n">RIO_PORT_GEN_CTL_CSR</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">+</span> <span class="n">RIO_PORT_GEN_CTL_CSR</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tsi721_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi721_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi721_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clean</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_STD_RESOURCE_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;res[%d] @ 0x%llx (0x%lx, 0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Verify BAR configuration</span>
<span class="cm">	 */</span>

	<span class="cm">/* BAR_0 (registers) must be 512KB+ in 32-bit address space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span> <span class="o">||</span>
	    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TSI721_REG_SPACE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Missing or misconfigured CSR BAR0, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BAR_1 (outbound doorbells) must be 16MB+ in 32-bit address space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span> <span class="o">||</span>
	    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TSI721_DB_WIN_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Missing or misconfigured Doorbell BAR1, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * BAR_2 and BAR_4 (outbound translation) must be in 64-bit PCIe address</span>
<span class="cm">	 * space.</span>
<span class="cm">	 * NOTE: BAR_2 and BAR_4 are not used by this version of driver.</span>
<span class="cm">	 * It may be a good idea to keep them disabled using HW configuration</span>
<span class="cm">	 * to save PCI memory space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Outbound BAR2 is not used but enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Outbound BAR4 is not used but enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot obtain PCI resources, &quot;</span>
			<span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unable to map device registers space, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">odb_base</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">odb_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unable to map outbound doorbells space, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_bars</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure DMA attributes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to set DMA mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unmap_bars</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to set consistent DMA mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to set consistent DMA mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Clear &quot;no snoop&quot; and &quot;relaxed ordering&quot; bits, use default MRRS. */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_EXP_DEVCTL_READRQ</span> <span class="o">|</span> <span class="n">PCI_EXP_DEVCTL_RELAX_EN</span> <span class="o">|</span>
		    <span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SZ_SHIFT</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>

	<span class="cm">/* Adjust PCIe completion timeout. */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL2</span><span class="p">,</span> <span class="n">regval</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXUP: correct offsets of MSI-X tables in the MSI-X Capability Block</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TSI721_PCIECFG_EPCTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TSI721_PCIECFG_MSIXTBL</span><span class="p">,</span>
						<span class="n">TSI721_MSIXTBL_OFFSET</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TSI721_PCIECFG_MSIXPBA</span><span class="p">,</span>
						<span class="n">TSI721_MSIXPBA_OFFSET</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TSI721_PCIECFG_EPCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* End of FIXUP */</span>

	<span class="n">tsi721_disable_ints</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">tsi721_init_pc2sr_mapping</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">tsi721_init_sr2pc_mapping</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tsi721_bdma_maint_init</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BDMA initialization failed, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap_bars</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tsi721_doorbell_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_bdma</span><span class="p">;</span>

	<span class="n">tsi721_port_write_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tsi721_messages_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_consistent</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tsi721_setup_mport</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_consistent</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_consistent:</span>
	<span class="n">tsi721_doorbell_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_free_bdma:</span>
	<span class="n">tsi721_bdma_maint_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_unmap_bars:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">odb_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">odb_base</span><span class="p">);</span>
<span class="nl">err_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_clear_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_clean:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tsi721_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_IDT</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TSI721</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tsi721_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tsi721_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tsi721&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tsi721_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tsi721_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tsi721_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi721_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tsi721_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi721_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">tsi721_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
