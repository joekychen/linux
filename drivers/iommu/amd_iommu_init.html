<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › iommu › amd_iommu_init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>amd_iommu_init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2007-2010 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Author: Joerg Roedel &lt;joerg.roedel@amd.com&gt;</span>
<span class="cm"> *         Leo Duran &lt;leo.duran@amd.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>
<span class="cp">#include &lt;linux/amd-iommu.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/pci-direct.h&gt;</span>
<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/gart.h&gt;</span>
<span class="cp">#include &lt;asm/x86_init.h&gt;</span>
<span class="cp">#include &lt;asm/iommu_table.h&gt;</span>

<span class="cp">#include &quot;amd_iommu_proto.h&quot;</span>
<span class="cp">#include &quot;amd_iommu_types.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * definitions for the ACPI scanning code</span>
<span class="cm"> */</span>
<span class="cp">#define IVRS_HEADER_LENGTH 48</span>

<span class="cp">#define ACPI_IVHD_TYPE                  0x10</span>
<span class="cp">#define ACPI_IVMD_TYPE_ALL              0x20</span>
<span class="cp">#define ACPI_IVMD_TYPE                  0x21</span>
<span class="cp">#define ACPI_IVMD_TYPE_RANGE            0x22</span>

<span class="cp">#define IVHD_DEV_ALL                    0x01</span>
<span class="cp">#define IVHD_DEV_SELECT                 0x02</span>
<span class="cp">#define IVHD_DEV_SELECT_RANGE_START     0x03</span>
<span class="cp">#define IVHD_DEV_RANGE_END              0x04</span>
<span class="cp">#define IVHD_DEV_ALIAS                  0x42</span>
<span class="cp">#define IVHD_DEV_ALIAS_RANGE            0x43</span>
<span class="cp">#define IVHD_DEV_EXT_SELECT             0x46</span>
<span class="cp">#define IVHD_DEV_EXT_SELECT_RANGE       0x47</span>

<span class="cp">#define IVHD_FLAG_HT_TUN_EN_MASK        0x01</span>
<span class="cp">#define IVHD_FLAG_PASSPW_EN_MASK        0x02</span>
<span class="cp">#define IVHD_FLAG_RESPASSPW_EN_MASK     0x04</span>
<span class="cp">#define IVHD_FLAG_ISOC_EN_MASK          0x08</span>

<span class="cp">#define IVMD_FLAG_EXCL_RANGE            0x08</span>
<span class="cp">#define IVMD_FLAG_UNITY_MAP             0x01</span>

<span class="cp">#define ACPI_DEVFLAG_INITPASS           0x01</span>
<span class="cp">#define ACPI_DEVFLAG_EXTINT             0x02</span>
<span class="cp">#define ACPI_DEVFLAG_NMI                0x04</span>
<span class="cp">#define ACPI_DEVFLAG_SYSMGT1            0x10</span>
<span class="cp">#define ACPI_DEVFLAG_SYSMGT2            0x20</span>
<span class="cp">#define ACPI_DEVFLAG_LINT0              0x40</span>
<span class="cp">#define ACPI_DEVFLAG_LINT1              0x80</span>
<span class="cp">#define ACPI_DEVFLAG_ATSDIS             0x10000000</span>

<span class="cm">/*</span>
<span class="cm"> * ACPI table definitions</span>
<span class="cm"> *</span>
<span class="cm"> * These data structures are laid over the table to parse the important values</span>
<span class="cm"> * out of it.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * structure describing one IOMMU in the ACPI table. Typically followed by one</span>
<span class="cm"> * or more ivhd_entrys.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ivhd_header</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cap_ptr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mmio_phys</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_seg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * A device entry describing which devices a specific IOMMU translates and</span>
<span class="cm"> * which requestor ids they use.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ivhd_entry</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * An AMD IOMMU memory definition structure. It defines things like exclusion</span>
<span class="cm"> * ranges for devices and regions that should be unity mapped.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ivmd_header</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aux</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">resv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">range_start</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">range_length</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="n">bool</span> <span class="n">amd_iommu_dump</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">amd_iommu_detected</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">__initdata</span> <span class="n">amd_iommu_disabled</span><span class="p">;</span>

<span class="n">u16</span> <span class="n">amd_iommu_last_bdf</span><span class="p">;</span>			<span class="cm">/* largest PCI device id we have</span>
<span class="cm">					   to handle */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">amd_iommu_unity_map</span><span class="p">);</span>		<span class="cm">/* a list of required unity mappings</span>
<span class="cm">					   we find in ACPI */</span>
<span class="n">bool</span> <span class="n">amd_iommu_unmap_flush</span><span class="p">;</span>		<span class="cm">/* if true, flush on every unmap */</span>

<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">amd_iommu_list</span><span class="p">);</span>		<span class="cm">/* list of all AMD IOMMUs in the</span>
<span class="cm">					   system */</span>

<span class="cm">/* Array to assign indices to IOMMUs*/</span>
<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">amd_iommus</span><span class="p">[</span><span class="n">MAX_IOMMUS</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">amd_iommus_present</span><span class="p">;</span>

<span class="cm">/* IOMMUs have a non-present cache? */</span>
<span class="n">bool</span> <span class="n">amd_iommu_np_cache</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">amd_iommu_iotlb_sup</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="n">u32</span> <span class="n">amd_iommu_max_pasids</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

<span class="n">bool</span> <span class="n">amd_iommu_v2_present</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="n">bool</span> <span class="n">amd_iommu_force_isolation</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The ACPI table parsing functions set this variable on an error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">amd_iommu_init_err</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * List of protection domains - used during resume</span>
<span class="cm"> */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">amd_iommu_pd_list</span><span class="p">);</span>
<span class="n">spinlock_t</span> <span class="n">amd_iommu_pd_lock</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to the device table which is shared by all AMD IOMMUs</span>
<span class="cm"> * it is indexed by the PCI device id or the HT unit id and contains</span>
<span class="cm"> * information about the domain the device belongs to as well as the</span>
<span class="cm"> * page table root pointer.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dev_table_entry</span> <span class="o">*</span><span class="n">amd_iommu_dev_table</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The alias table is a driver specific data structure which contains the</span>
<span class="cm"> * mappings of the PCI device ids to the actual requestor ids on the IOMMU.</span>
<span class="cm"> * More than one device can share the same requestor id.</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="o">*</span><span class="n">amd_iommu_alias_table</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The rlookup table is used to find the IOMMU which is responsible</span>
<span class="cm"> * for a specific device. It is also indexed by the PCI device id.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">**</span><span class="n">amd_iommu_rlookup_table</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * AMD IOMMU allows up to 2^16 differend protection domains. This is a bitmap</span>
<span class="cm"> * to know which ones are already in use.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">amd_iommu_pd_alloc_bitmap</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">dev_table_size</span><span class="p">;</span>	<span class="cm">/* size of the device table */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">alias_table_size</span><span class="p">;</span>	<span class="cm">/* size of the alias table */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">rlookup_table_size</span><span class="p">;</span>	<span class="cm">/* size if the rlookup table */</span>

<span class="cm">/*</span>
<span class="cm"> * This function flushes all internal caches of</span>
<span class="cm"> * the IOMMU used by this driver.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iommu_flush_all_caches</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">amd_iommu_enable_interrupts</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_last_devid</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&gt;</span> <span class="n">amd_iommu_last_bdf</span><span class="p">)</span>
		<span class="n">amd_iommu_last_bdf</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">tbl_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">entry_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span> <span class="o">+</span>
			 <span class="n">get_order</span><span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">amd_iommu_last_bdf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Access to l1 and l2 indexed register spaces */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">iommu_read_l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u16</span> <span class="n">l1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span> <span class="o">|</span> <span class="n">l1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_write_l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u16</span> <span class="n">l1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span> <span class="o">|</span> <span class="n">l1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">));</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span> <span class="o">|</span> <span class="n">l1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">iommu_read_l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_write_l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * AMD IOMMU MMIO register space handling functions</span>
<span class="cm"> *</span>
<span class="cm"> * These functions are used to program the IOMMU device registers in</span>
<span class="cm"> * MMIO space required for that driver.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * This function set the exclusion range in the IOMMU. DMA accesses to the</span>
<span class="cm"> * exclusion range are passed through untranslated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_set_exclusion_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">start</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">exclusion_start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">exclusion_length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">exclusion_start</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">start</span> <span class="o">|</span> <span class="n">MMIO_EXCL_ENABLE_MASK</span><span class="p">;</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EXCL_BASE_OFFSET</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EXCL_LIMIT_OFFSET</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Programs the physical address of the device table into the IOMMU hardware */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_set_device_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">amd_iommu_dev_table</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev_table_size</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_DEV_TABLE_OFFSET</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Generic functions to enable/disable certain features of the IOMMU. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_feature_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CONTROL_OFFSET</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CONTROL_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_feature_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CONTROL_OFFSET</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CONTROL_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_set_inv_tlb_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CONTROL_OFFSET</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTRL_INV_TO_MASK</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_INV_TIMEOUT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CTRL_INV_TO_MASK</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CONTROL_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Function to enable the hardware */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">feat_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;PreF&quot;</span><span class="p">,</span> <span class="s">&quot;PPR&quot;</span><span class="p">,</span> <span class="s">&quot;X2APIC&quot;</span><span class="p">,</span> <span class="s">&quot;NX&quot;</span><span class="p">,</span> <span class="s">&quot;GT&quot;</span><span class="p">,</span> <span class="s">&quot;[5]&quot;</span><span class="p">,</span>
		<span class="s">&quot;IA&quot;</span><span class="p">,</span> <span class="s">&quot;GA&quot;</span><span class="p">,</span> <span class="s">&quot;HE&quot;</span><span class="p">,</span> <span class="s">&quot;PC&quot;</span><span class="p">,</span> <span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AMD-Vi: Enabling IOMMU at %s cap 0x%hx&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_CAP_EFR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; extended features: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">feat_str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iommu_feature</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">feat_str</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_IOMMU_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable command buffer */</span>
	<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_CMDBUF_EN</span><span class="p">);</span>

	<span class="cm">/* Disable event logging and event interrupts */</span>
	<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_EVT_INT_EN</span><span class="p">);</span>
	<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_EVT_LOG_EN</span><span class="p">);</span>

	<span class="cm">/* Disable IOMMU hardware itself */</span>
	<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_IOMMU_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mapping and unmapping functions for the IOMMU MMIO space. Each AMD IOMMU in</span>
<span class="cm"> * the system has one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">iommu_map_mmio_space</span><span class="p">(</span><span class="n">u64</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MMIO_REGION_LENGTH</span><span class="p">,</span> <span class="s">&quot;amd_iommu&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;AMD-Vi: Can not reserve memory region %llx for mmio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">address</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;AMD-Vi: This is a BIOS bug. Please contact your hardware vendor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MMIO_REGION_LENGTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">iommu_unmap_mmio_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_phys</span><span class="p">,</span> <span class="n">MMIO_REGION_LENGTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * The functions below belong to the first pass of AMD IOMMU ACPI table</span>
<span class="cm"> * parsing. In this pass we try to find out the highest device id this</span>
<span class="cm"> * code has to handle. Upon this information the size of the shared data</span>
<span class="cm"> * structures is determined later.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * This function calculates the length of a given IVHD entry</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ivhd_entry_length</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">ivhd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x04</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">ivhd</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function reads the last device id the IOMMU has to handle from the PCI</span>
<span class="cm"> * capability header for this IOMMU</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">find_last_devid_on_pci</span><span class="p">(</span><span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cap</span><span class="p">;</span>

	<span class="n">cap</span> <span class="o">=</span> <span class="n">read_pci_config</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">cap_ptr</span><span class="o">+</span><span class="n">MMIO_RANGE_OFFSET</span><span class="p">);</span>
	<span class="n">update_last_devid</span><span class="p">(</span><span class="n">calc_devid</span><span class="p">(</span><span class="n">MMIO_GET_BUS</span><span class="p">(</span><span class="n">cap</span><span class="p">),</span> <span class="n">MMIO_GET_LD</span><span class="p">(</span><span class="n">cap</span><span class="p">)));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * After reading the highest device id from the IOMMU PCI capability header</span>
<span class="cm"> * this function looks if there is a higher device id defined in the ACPI table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">find_last_devid_from_ivhd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivhd_entry</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">+=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">find_last_devid_on_pci</span><span class="p">(</span><span class="n">PCI_BUS</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
			<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
			<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">cap_ptr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivhd_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_SELECT</span>:
		<span class="k">case</span> <span class="n">IVHD_DEV_RANGE_END</span>:
		<span class="k">case</span> <span class="n">IVHD_DEV_ALIAS</span>:
		<span class="k">case</span> <span class="n">IVHD_DEV_EXT_SELECT</span>:
			<span class="cm">/* all the above subfield types refer to device ids */</span>
			<span class="n">update_last_devid</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">ivhd_entry_length</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Iterate over all IVHD entries in the ACPI table and find the highest device</span>
<span class="cm"> * id which we need to handle. This is the first of three functions which parse</span>
<span class="cm"> * the ACPI table. So we check the checksum here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">find_last_devid_acpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate checksum here so we don&#39;t need to do it when</span>
<span class="cm">	 * we actually parse the table</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ACPI table corrupt */</span>
		<span class="n">amd_iommu_init_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">IVRS_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">+=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACPI_IVHD_TYPE</span>:
			<span class="n">find_last_devid_from_ivhd</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * The following functions belong the the code path which parses the ACPI table</span>
<span class="cm"> * the second time. In this ACPI parsing iteration we allocate IOMMU specific</span>
<span class="cm"> * data structures, initialize the device/alias/rlookup table and also</span>
<span class="cm"> * basically initialize the hardware.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Allocates the command buffer. This buffer is per AMD IOMMU. We can</span>
<span class="cm"> * write commands to that buffer later and the IOMMU will execute them</span>
<span class="cm"> * asynchronously</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">alloc_command_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cmd_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
			<span class="n">get_order</span><span class="p">(</span><span class="n">CMD_BUFFER_SIZE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf_size</span> <span class="o">=</span> <span class="n">CMD_BUFFER_SIZE</span> <span class="o">|</span> <span class="n">CMD_BUFFER_UNINITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cmd_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function resets the command buffer if the IOMMU stopped fetching</span>
<span class="cm"> * commands from it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">amd_iommu_reset_cmd_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_CMDBUF_EN</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CMD_HEAD_OFFSET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CMD_TAIL_OFFSET</span><span class="p">);</span>

	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_CMDBUF_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function writes the command buffer address to the hardware and</span>
<span class="cm"> * enables it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_enable_command_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">|=</span> <span class="n">MMIO_CMD_SIZE_512</span><span class="p">;</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_CMD_BUF_OFFSET</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>

	<span class="n">amd_iommu_reset_cmd_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_BUFFER_UNINITIALIZED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_command_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_BUFFER_UNINITIALIZED</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/* allocates the memory where the IOMMU will log its events to */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">alloc_event_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
						<span class="n">get_order</span><span class="p">(</span><span class="n">EVT_BUFFER_SIZE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf_size</span> <span class="o">=</span> <span class="n">EVT_BUFFER_SIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_enable_event_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span><span class="p">)</span> <span class="o">|</span> <span class="n">EVT_LEN_MASK</span><span class="p">;</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EVT_BUF_OFFSET</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>

	<span class="cm">/* set head and tail to zero manually */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EVT_HEAD_OFFSET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EVT_TAIL_OFFSET</span><span class="p">);</span>

	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_EVT_LOG_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_event_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">EVT_BUFFER_SIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* allocates the memory where the IOMMU will log its events to */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">alloc_ppr_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
						<span class="n">get_order</span><span class="p">(</span><span class="n">PPR_LOG_SIZE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_enable_ppr_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span><span class="p">)</span> <span class="o">|</span> <span class="n">PPR_LOG_SIZE_512</span><span class="p">;</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_PPR_LOG_OFFSET</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>

	<span class="cm">/* set head and tail to zero manually */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_PPR_HEAD_OFFSET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_PPR_TAIL_OFFSET</span><span class="p">);</span>

	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_PPFLOG_EN</span><span class="p">);</span>
	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_PPR_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_ppr_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">PPR_LOG_SIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_enable_gt</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu_feature</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">FEATURE_GT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_GT_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sets a specific bit in the device table entry. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dev_entry_bit</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_bit</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">amd_iommu_dev_table</span><span class="p">[</span><span class="n">devid</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dev_entry_bit</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_bit</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">amd_iommu_dev_table</span><span class="p">[</span><span class="n">devid</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">_bit</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">_bit</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">amd_iommu_apply_erratum_63</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sysmgt</span><span class="p">;</span>

	<span class="n">sysmgt</span> <span class="o">=</span> <span class="n">get_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_SYSMGT1</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">get_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_SYSMGT2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysmgt</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_IW</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Writes the specific IOMMU for a device into the rlookup table */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">set_iommu_for_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="n">u16</span> <span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_iommu_rlookup_table</span><span class="p">[</span><span class="n">devid</span><span class="p">]</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function takes the device specific flags read from the ACPI</span>
<span class="cm"> * table and sets up the device table entry with that information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">set_dev_entry_from_acpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span>
					   <span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ext_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_INITPASS</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_INIT_PASS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_EXTINT</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_EINT_PASS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_NMI</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_NMI_PASS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_SYSMGT1</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_SYSMGT1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_SYSMGT2</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_SYSMGT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_LINT0</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_LINT0_PASS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_DEVFLAG_LINT1</span><span class="p">)</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_LINT1_PASS</span><span class="p">);</span>

	<span class="n">amd_iommu_apply_erratum_63</span><span class="p">(</span><span class="n">devid</span><span class="p">);</span>

	<span class="n">set_iommu_for_device</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">devid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reads the device exclusion range from ACPI and initialize IOMMU with</span>
<span class="cm"> * it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">set_device_exclusion_range</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivmd_header</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">amd_iommu_rlookup_table</span><span class="p">[</span><span class="n">devid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IVMD_FLAG_EXCL_RANGE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We only can configure exclusion ranges per IOMMU, not</span>
<span class="cm">		 * per device. But we can enable the exclusion range per</span>
<span class="cm">		 * device. This is done here</span>
<span class="cm">		 */</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_EX</span><span class="p">);</span>
		<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">exclusion_start</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">range_start</span><span class="p">;</span>
		<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">exclusion_length</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">range_length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function reads some important data from the IOMMU PCI space and</span>
<span class="cm"> * initializes the driver data structure with it. It reads the hardware</span>
<span class="cm"> * capabilities and the first/last device entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_iommu_from_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap_ptr</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">range</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cap_ptr</span> <span class="o">+</span> <span class="n">MMIO_CAP_HDR_OFFSET</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cap_ptr</span> <span class="o">+</span> <span class="n">MMIO_RANGE_OFFSET</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">range</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cap_ptr</span> <span class="o">+</span> <span class="n">MMIO_MISC_OFFSET</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">misc</span><span class="p">);</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">first_device</span> <span class="o">=</span> <span class="n">calc_devid</span><span class="p">(</span><span class="n">MMIO_GET_BUS</span><span class="p">(</span><span class="n">range</span><span class="p">),</span>
					 <span class="n">MMIO_GET_FD</span><span class="p">(</span><span class="n">range</span><span class="p">));</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">last_device</span> <span class="o">=</span> <span class="n">calc_devid</span><span class="p">(</span><span class="n">MMIO_GET_BUS</span><span class="p">(</span><span class="n">range</span><span class="p">),</span>
					<span class="n">MMIO_GET_LD</span><span class="p">(</span><span class="n">range</span><span class="p">));</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_msi_num</span> <span class="o">=</span> <span class="n">MMIO_MSI_NUM</span><span class="p">(</span><span class="n">misc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_CAP_IOTLB</span><span class="p">)))</span>
		<span class="n">amd_iommu_iotlb_sup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* read extended feature bits */</span>
	<span class="n">low</span>  <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EXT_FEATURES</span><span class="p">);</span>
	<span class="n">high</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">MMIO_EXT_FEATURES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu_feature</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">FEATURE_GT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">glxval</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pasids</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">shift</span><span class="p">;</span>

		<span class="n">shift</span>   <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">FEATURE_PASID_MASK</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">&gt;&gt;=</span> <span class="n">FEATURE_PASID_SHIFT</span><span class="p">;</span>
		<span class="n">pasids</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>

		<span class="n">amd_iommu_max_pasids</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">amd_iommu_max_pasids</span><span class="p">,</span> <span class="n">pasids</span><span class="p">);</span>

		<span class="n">glxval</span>   <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">FEATURE_GLXVAL_MASK</span><span class="p">;</span>
		<span class="n">glxval</span> <span class="o">&gt;&gt;=</span> <span class="n">FEATURE_GLXVAL_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_max_glx_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">amd_iommu_max_glx_val</span> <span class="o">=</span> <span class="n">glxval</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">amd_iommu_max_glx_val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">amd_iommu_max_glx_val</span><span class="p">,</span> <span class="n">glxval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu_feature</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">FEATURE_GT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">iommu_feature</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">FEATURE_PPR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">is_iommu_v2</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">amd_iommu_v2_present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_rd890_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some rd890 systems may not be fully reconfigured by the BIOS, so</span>
<span class="cm">	 * it&#39;s necessary for us to store this information so it can be</span>
<span class="cm">	 * reprogrammed on resume</span>
<span class="cm">	 */</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_addr_lo</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_addr_hi</span><span class="p">);</span>

	<span class="cm">/* Low bit locks writes to configuration space */</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_addr_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x12</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_l1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iommu_read_l1</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x83</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_l2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">iommu_read_l2</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Takes a pointer to an AMD IOMMU entry in the ACPI table and</span>
<span class="cm"> * initializes the hardware and our data structures with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_iommu_from_acpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devid_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devid_to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_i</span><span class="p">,</span> <span class="n">ext_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">alias</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivhd_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First save the recommended feature enable bits from ACPI</span>
<span class="cm">	 */</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">acpi_flags</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Done. Now parse the device entries</span>
<span class="cm">	 */</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivhd_header</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">+=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>


	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivhd_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_ALL</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_ALL</span><span class="se">\t\t\t</span><span class="s"> first devid: %02x:%02x.%x&quot;</span>
				    <span class="s">&quot; last device %02x:%02x.%x flags: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">first_device</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">first_device</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">first_device</span><span class="p">),</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">last_device</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">last_device</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">last_device</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">dev_i</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">first_device</span><span class="p">;</span>
					<span class="n">dev_i</span> <span class="o">&lt;=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">last_device</span><span class="p">;</span> <span class="o">++</span><span class="n">dev_i</span><span class="p">)</span>
				<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">dev_i</span><span class="p">,</span>
							<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_SELECT</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_SELECT</span><span class="se">\t\t\t</span><span class="s"> devid: %02x:%02x.%x &quot;</span>
				    <span class="s">&quot;flags: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

			<span class="n">devid</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_SELECT_RANGE_START</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_SELECT_RANGE_START</span><span class="se">\t</span><span class="s"> &quot;</span>
				    <span class="s">&quot;devid: %02x:%02x.%x flags: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

			<span class="n">devid_start</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">ext_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">alias</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_ALIAS</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_ALIAS</span><span class="se">\t\t\t</span><span class="s"> devid: %02x:%02x.%x &quot;</span>
				    <span class="s">&quot;flags: %02x devid_to: %02x:%02x.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

			<span class="n">devid</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="n">devid_to</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">devid</span>   <span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">devid_to</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">amd_iommu_alias_table</span><span class="p">[</span><span class="n">devid</span><span class="p">]</span> <span class="o">=</span> <span class="n">devid_to</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_ALIAS_RANGE</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_ALIAS_RANGE</span><span class="se">\t\t</span><span class="s"> &quot;</span>
				    <span class="s">&quot;devid: %02x:%02x.%x flags: %02x &quot;</span>
				    <span class="s">&quot;devid_to: %02x:%02x.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

			<span class="n">devid_start</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">devid_to</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ext_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">alias</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_EXT_SELECT</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_EXT_SELECT</span><span class="se">\t\t</span><span class="s"> devid: %02x:%02x.%x &quot;</span>
				    <span class="s">&quot;flags: %02x ext: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">);</span>

			<span class="n">devid</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
						<span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_EXT_SELECT_RANGE</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_EXT_SELECT_RANGE</span><span class="se">\t</span><span class="s"> devid: &quot;</span>
				    <span class="s">&quot;%02x:%02x.%x flags: %02x ext: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">);</span>

			<span class="n">devid_start</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">ext_flags</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">;</span>
			<span class="n">alias</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVHD_DEV_RANGE_END</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;  DEV_RANGE_END</span><span class="se">\t\t</span><span class="s"> devid: %02x:%02x.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">));</span>

			<span class="n">devid</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">dev_i</span> <span class="o">=</span> <span class="n">devid_start</span><span class="p">;</span> <span class="n">dev_i</span> <span class="o">&lt;=</span> <span class="n">devid</span><span class="p">;</span> <span class="o">++</span><span class="n">dev_i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">amd_iommu_alias_table</span><span class="p">[</span><span class="n">dev_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">devid_to</span><span class="p">;</span>
					<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span>
						<span class="n">devid_to</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">ext_flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">set_dev_entry_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">dev_i</span><span class="p">,</span>
							<span class="n">flags</span><span class="p">,</span> <span class="n">ext_flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">ivhd_entry_length</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initializes the device-&gt;iommu mapping for the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_iommu_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">first_device</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">last_device</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">set_iommu_for_device</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_iommu_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_command_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="n">free_event_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="n">free_ppr_log</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="n">iommu_unmap_mmio_space</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_iommu_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">for_each_iommu_safe</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">free_iommu_one</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function clues the initialization function for one IOMMU</span>
<span class="cm"> * together and also allocates the command buffer and programs the</span>
<span class="cm"> * hardware. It does NOT enable the IOMMU. This is done afterwards.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_iommu_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Add IOMMU to internal data structures */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amd_iommu_list</span><span class="p">);</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">index</span>             <span class="o">=</span> <span class="n">amd_iommus_present</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_IOMMUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;AMD-Vi: System has more IOMMUs than supported by this driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Index is fine - add IOMMU to the array */</span>
	<span class="n">amd_iommus</span><span class="p">[</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy data from ACPI table entry to the iommu struct</span>
<span class="cm">	 */</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">PCI_BUS</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">root_pdev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
						<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cap_ptr</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">pci_seg</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pci_seg</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_phys</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">mmio_phys</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">iommu_map_mmio_space</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">mmio_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf</span> <span class="o">=</span> <span class="n">alloc_command_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span> <span class="o">=</span> <span class="n">alloc_event_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">evt_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">int_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">init_iommu_from_pci</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="n">init_iommu_from_acpi</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">init_iommu_devices</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu_feature</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">FEATURE_PPR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span> <span class="o">=</span> <span class="n">alloc_ppr_log</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_CAP_NPCACHE</span><span class="p">))</span>
		<span class="n">amd_iommu_np_cache</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Iterates over all IOMMU entries in the ACPI table, allocates the</span>
<span class="cm"> * IOMMU structure and initializes it with init_iommu_one()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_iommu_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">+=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">IVRS_HEADER_LENGTH</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivhd_header</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACPI_IVHD_TYPE</span>:

			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;device: %02x:%02x.%01x cap: %04x &quot;</span>
				    <span class="s">&quot;seg: %d flags: %01x info %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span>
				    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cap_ptr</span><span class="p">,</span>
				    <span class="n">h</span><span class="o">-&gt;</span><span class="n">pci_seg</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
			<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;       mmio-addr: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">h</span><span class="o">-&gt;</span><span class="n">mmio_phys</span><span class="p">);</span>

			<span class="n">iommu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">amd_iommu_init_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">init_iommu_one</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">amd_iommu_init_err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * The following functions initialize the MSI interrupts for all IOMMUs</span>
<span class="cm"> * in the system. Its a bit challenging because there could be multiple</span>
<span class="cm"> * IOMMUs per PCI BDF but we can call pci_enable_msi(x) only once per</span>
<span class="cm"> * pci_dev.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iommu_setup_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
				 <span class="n">amd_iommu_int_handler</span><span class="p">,</span>
				 <span class="n">amd_iommu_int_thread</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;AMD-Vi&quot;</span><span class="p">,</span>
				 <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">int_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iommu_init_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">int_enabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enable_faults</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iommu_setup_msi</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">enable_faults:</span>
	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_EVT_INT_EN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ppr_log</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_PPFINT_EN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * The next functions belong to the third pass of parsing the ACPI</span>
<span class="cm"> * table. In this last pass the memory mapping requirements are</span>
<span class="cm"> * gathered (like exclusion and unity mapping reanges).</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_unity_maps</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unity_map_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amd_iommu_unity_map</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called when we find an exclusion range definition in ACPI */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_exclusion_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivmd_header</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_IVMD_TYPE</span>:
		<span class="n">set_device_exclusion_range</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_IVMD_TYPE_ALL</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">amd_iommu_last_bdf</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">set_device_exclusion_range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_IVMD_TYPE_RANGE</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">set_device_exclusion_range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called for unity map ACPI definition */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_unity_map_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivmd_header</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unity_map_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_IVMD_TYPE</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;IVMD_TYPEi</span><span class="se">\t\t\t</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_start</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_end</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_IVMD_TYPE_ALL</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;IVMD_TYPE_ALL</span><span class="se">\t\t</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_end</span> <span class="o">=</span> <span class="n">amd_iommu_last_bdf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_IVMD_TYPE_RANGE</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;IVMD_TYPE_RANGE</span><span class="se">\t\t</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_start</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_end</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">address_start</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">range_start</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">address_end</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">address_start</span> <span class="o">+</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">range_length</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">prot</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DUMP_printk</span><span class="p">(</span><span class="s">&quot;%s devid_start: %02x:%02x.%x devid_end: %02x:%02x.%x&quot;</span>
		    <span class="s">&quot; range_start: %016llx range_end: %016llx flags: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
		    <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_start</span><span class="p">),</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_start</span><span class="p">),</span>
		    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_start</span><span class="p">),</span> <span class="n">PCI_BUS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_end</span><span class="p">),</span>
		    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_end</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">devid_end</span><span class="p">),</span>
		    <span class="n">e</span><span class="o">-&gt;</span><span class="n">address_start</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">address_end</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amd_iommu_unity_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* iterates over all memory definitions we find in the ACPI table */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_memory_definitions</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivmd_header</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">+=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">IVRS_HEADER_LENGTH</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivmd_header</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IVMD_FLAG_EXCL_RANGE</span><span class="p">)</span>
			<span class="n">init_exclusion_range</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IVMD_FLAG_UNITY_MAP</span><span class="p">)</span>
			<span class="n">init_unity_map_range</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Init the device table to not allow DMA access for devices and</span>
<span class="cm"> * suppress all page faults</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_device_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">devid</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devid</span> <span class="o">&lt;=</span> <span class="n">amd_iommu_last_bdf</span><span class="p">;</span> <span class="o">++</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_VALID</span><span class="p">);</span>
		<span class="n">set_dev_entry_bit</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_ENTRY_TRANSLATION</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_init_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">acpi_flags</span> <span class="o">&amp;</span> <span class="n">IVHD_FLAG_HT_TUN_EN_MASK</span> <span class="o">?</span>
		<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_HT_TUN_EN</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_HT_TUN_EN</span><span class="p">);</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">acpi_flags</span> <span class="o">&amp;</span> <span class="n">IVHD_FLAG_PASSPW_EN_MASK</span> <span class="o">?</span>
		<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_PASSPW_EN</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_PASSPW_EN</span><span class="p">);</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">acpi_flags</span> <span class="o">&amp;</span> <span class="n">IVHD_FLAG_RESPASSPW_EN_MASK</span> <span class="o">?</span>
		<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_RESPASSPW_EN</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_RESPASSPW_EN</span><span class="p">);</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">acpi_flags</span> <span class="o">&amp;</span> <span class="n">IVHD_FLAG_ISOC_EN_MASK</span> <span class="o">?</span>
		<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_ISOC_EN</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">iommu_feature_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_ISOC_EN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * make IOMMU memory accesses cache coherent</span>
<span class="cm">	 */</span>
	<span class="n">iommu_feature_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CONTROL_COHERENT_EN</span><span class="p">);</span>

	<span class="cm">/* Set IOTLB invalidation timeout to 1s */</span>
	<span class="n">iommu_set_inv_tlb_timeout</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">CTRL_INV_TO_1S</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_apply_resume_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_feature_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">root_pdev</span><span class="p">;</span>

	<span class="cm">/* RD890 BIOSes may not have completely reconfigured the iommu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_rd890_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, we need to ensure that the iommu is enabled. This is</span>
<span class="cm">	 * controlled by a register in the northbridge</span>
<span class="cm">	 */</span>

	<span class="cm">/* Select Northbridge indirect register 0x75 and enable writing */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x75</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_feature_control</span><span class="p">);</span>

	<span class="cm">/* Enable the iommu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc_feature_control</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="n">ioc_feature_control</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Restore the iommu BAR */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			       <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_addr_lo</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
			       <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_addr_hi</span><span class="p">);</span>

	<span class="cm">/* Restore the l1 indirect regs for each of the 6 l1s */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x12</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">iommu_write_l1</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_l1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>

	<span class="cm">/* Restore the l2 indirect regs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x83</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iommu_write_l2</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_l2</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Lock PCI setup registers */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">cap_ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			       <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">stored_addr_lo</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function finally enables all IOMMUs found in the system after</span>
<span class="cm"> * they have been initialized</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_iommus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>

	<span class="n">for_each_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iommu_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_init_flags</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_set_device_table</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_enable_command_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_enable_event_buffer</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_enable_ppr_log</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_enable_gt</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_set_exclusion_range</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_enable</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="n">iommu_flush_all_caches</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_iommus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>

	<span class="n">for_each_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="p">)</span>
		<span class="n">iommu_disable</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Suspend/Resume support</span>
<span class="cm"> * disable suspend until real resume implemented</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_iommu_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>

	<span class="n">for_each_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="p">)</span>
		<span class="n">iommu_apply_resume_quirks</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>

	<span class="cm">/* re-load the hardware */</span>
	<span class="n">enable_iommus</span><span class="p">();</span>

	<span class="n">amd_iommu_enable_interrupts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_iommu_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable IOMMUs to go out of the way for BIOS */</span>
	<span class="n">disable_iommus</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">amd_iommu_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">amd_iommu_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">amd_iommu_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">free_on_init_error</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_iommu_uninit_devices</span><span class="p">();</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">amd_iommu_pd_alloc_bitmap</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">(</span><span class="n">MAX_DOMAIN_ID</span><span class="o">/</span><span class="mi">8</span><span class="p">));</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">amd_iommu_rlookup_table</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">(</span><span class="n">rlookup_table_size</span><span class="p">));</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">amd_iommu_alias_table</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">(</span><span class="n">alias_table_size</span><span class="p">));</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">amd_iommu_dev_table</span><span class="p">,</span>
		   <span class="n">get_order</span><span class="p">(</span><span class="n">dev_table_size</span><span class="p">));</span>

	<span class="n">free_iommu_all</span><span class="p">();</span>

	<span class="n">free_unity_maps</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_GART_IOMMU</span>
	<span class="cm">/*</span>
<span class="cm">	 * We failed to initialize the AMD IOMMU - try fallback to GART</span>
<span class="cm">	 * if possible.</span>
<span class="cm">	 */</span>
	<span class="n">gart_iommu_init</span><span class="p">();</span>

<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the hardware init function for AMD IOMMU in the system.</span>
<span class="cm"> * This function is called either from amd_iommu_init or from the interrupt</span>
<span class="cm"> * remapping setup code.</span>
<span class="cm"> *</span>
<span class="cm"> * This function basically parses the ACPI table for AMD IOMMU (IVRS)</span>
<span class="cm"> * three times:</span>
<span class="cm"> *</span>
<span class="cm"> *	1 pass) Find the highest PCI device id the driver has to handle.</span>
<span class="cm"> *		Upon this information the size of the data structures is</span>
<span class="cm"> *		determined that needs to be allocated.</span>
<span class="cm"> *</span>
<span class="cm"> *	2 pass) Initialize the data structures just allocated with the</span>
<span class="cm"> *		information in the ACPI table about available AMD IOMMUs</span>
<span class="cm"> *		in the system. It also maps the PCI devices in the</span>
<span class="cm"> *		system to specific IOMMUs</span>
<span class="cm"> *</span>
<span class="cm"> *	3 pass) After the basic data structures are allocated and</span>
<span class="cm"> *		initialized we update them with information about memory</span>
<span class="cm"> *		remapping requirements parsed out of the ACPI table in</span>
<span class="cm"> *		this last pass.</span>
<span class="cm"> *</span>
<span class="cm"> * After everything is set up the IOMMUs are enabled and the necessary</span>
<span class="cm"> * hotplug and suspend notifiers are registered.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">amd_iommu_init_hardware</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amd_iommu_detected</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_dev_table</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware already initialized */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First parse ACPI tables to find the largest Bus/Dev/Func</span>
<span class="cm">	 * we need to handle. Upon this information the shared data</span>
<span class="cm">	 * structures for the IOMMUs in the system will be allocated</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_table_parse</span><span class="p">(</span><span class="s">&quot;IVRS&quot;</span><span class="p">,</span> <span class="n">find_last_devid_acpi</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev_table_size</span>     <span class="o">=</span> <span class="n">tbl_size</span><span class="p">(</span><span class="n">DEV_TABLE_ENTRY_SIZE</span><span class="p">);</span>
	<span class="n">alias_table_size</span>   <span class="o">=</span> <span class="n">tbl_size</span><span class="p">(</span><span class="n">ALIAS_TABLE_ENTRY_SIZE</span><span class="p">);</span>
	<span class="n">rlookup_table_size</span> <span class="o">=</span> <span class="n">tbl_size</span><span class="p">(</span><span class="n">RLOOKUP_TABLE_ENTRY_SIZE</span><span class="p">);</span>

	<span class="cm">/* Device table - directly used by all IOMMUs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">amd_iommu_dev_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
				      <span class="n">get_order</span><span class="p">(</span><span class="n">dev_table_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_dev_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Alias table - map PCI Bus/Dev/Func to Bus/Dev/Func the</span>
<span class="cm">	 * IOMMU see for that device</span>
<span class="cm">	 */</span>
	<span class="n">amd_iommu_alias_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span>
			<span class="n">get_order</span><span class="p">(</span><span class="n">alias_table_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_alias_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="cm">/* IOMMU rlookup table - find the IOMMU for a specific device */</span>
	<span class="n">amd_iommu_rlookup_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span>
			<span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
			<span class="n">get_order</span><span class="p">(</span><span class="n">rlookup_table_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_rlookup_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">amd_iommu_pd_alloc_bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span>
					    <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
					    <span class="n">get_order</span><span class="p">(</span><span class="n">MAX_DOMAIN_ID</span><span class="o">/</span><span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_pd_alloc_bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="cm">/* init the device table */</span>
	<span class="n">init_device_table</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * let all alias entries point to itself</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">amd_iommu_last_bdf</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">amd_iommu_alias_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * never allocate domain 0 because its used as the non-allocated and</span>
<span class="cm">	 * error value placeholder</span>
<span class="cm">	 */</span>
	<span class="n">amd_iommu_pd_alloc_bitmap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd_iommu_pd_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * now the data structures are allocated and basically initialized</span>
<span class="cm">	 * start the real acpi table scan</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_table_parse</span><span class="p">(</span><span class="s">&quot;IVRS&quot;</span><span class="p">,</span> <span class="n">init_iommu_all</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_init_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_table_parse</span><span class="p">(</span><span class="s">&quot;IVRS&quot;</span><span class="p">,</span> <span class="n">init_memory_definitions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_init_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_devices</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">enable_iommus</span><span class="p">();</span>

	<span class="n">amd_iommu_init_notifier</span><span class="p">();</span>

	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd_iommu_syscore_ops</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free:</span>
	<span class="n">free_on_init_error</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_iommu_enable_interrupts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iommu_init_msi</span><span class="p">(</span><span class="n">iommu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the core init function for AMD IOMMU hardware in the system.</span>
<span class="cm"> * This function is called from the generic x86 DMA layer initialization</span>
<span class="cm"> * code.</span>
<span class="cm"> *</span>
<span class="cm"> * The function calls amd_iommu_init_hardware() to setup and enable the</span>
<span class="cm"> * IOMMU hardware if this has not happened yet. After that the driver</span>
<span class="cm"> * registers for the DMA-API and for the IOMMU-API as necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amd_iommu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_hardware</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_enable_interrupts</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu_pass_through</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_passthrough</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">amd_iommu_init_dma_ops</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">amd_iommu_init_api</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iommu_pass_through</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_unmap_flush</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AMD-Vi: IO/TLB flush on unmap enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AMD-Vi: Lazy IO/TLB flushing enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x86_platform</span><span class="p">.</span><span class="n">iommu_shutdown</span> <span class="o">=</span> <span class="n">disable_iommus</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free:</span>
	<span class="n">disable_iommus</span><span class="p">();</span>

	<span class="n">free_on_init_error</span><span class="p">();</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Early detect code. This code runs at IOMMU detection time in the DMA</span>
<span class="cm"> * layer. It just looks if there is an IVRS ACPI table to detect AMD</span>
<span class="cm"> * IOMMUs</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_amd_iommu_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">amd_iommu_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_iommu</span> <span class="o">||</span> <span class="p">(</span><span class="n">iommu_detected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gart_iommu_aperture</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd_iommu_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_table_parse</span><span class="p">(</span><span class="s">&quot;IVRS&quot;</span><span class="p">,</span> <span class="n">early_amd_iommu_detect</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iommu_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">amd_iommu_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">x86_init</span><span class="p">.</span><span class="n">iommu</span><span class="p">.</span><span class="n">iommu_init</span> <span class="o">=</span> <span class="n">amd_iommu_init</span><span class="p">;</span>

		<span class="cm">/* Make sure ACS will be enabled */</span>
		<span class="n">pci_request_acs</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Parsing functions for the AMD IOMMU specific kernel command line</span>
<span class="cm"> * options.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_amd_iommu_dump</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_iommu_dump</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_amd_iommu_options</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span> <span class="o">++</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;fullflush&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">amd_iommu_unmap_flush</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">amd_iommu_disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;force_isolation&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">amd_iommu_force_isolation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;amd_iommu_dump&quot;</span><span class="p">,</span> <span class="n">parse_amd_iommu_dump</span><span class="p">);</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;amd_iommu=&quot;</span><span class="p">,</span> <span class="n">parse_amd_iommu_options</span><span class="p">);</span>

<span class="n">IOMMU_INIT_FINISH</span><span class="p">(</span><span class="n">amd_iommu_detect</span><span class="p">,</span>
		  <span class="n">gart_iommu_hole_init</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">amd_iommu_v2_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">amd_iommu_v2_present</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">amd_iommu_v2_supported</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
