<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › clk › mxs › clk-imx23.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>clk-imx23.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * The code contained herein is licensed under the GNU General Public</span>
<span class="cm"> * License. You may obtain a copy of the GNU General Public License</span>
<span class="cm"> * Version 2 or later at the following locations:</span>
<span class="cm"> *</span>
<span class="cm"> * http://www.opensource.org/licenses/gpl-license.html</span>
<span class="cm"> * http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/clkdev.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;mach/common.h&gt;</span>
<span class="cp">#include &lt;mach/mx23.h&gt;</span>
<span class="cp">#include &quot;clk.h&quot;</span>

<span class="cp">#define DIGCTRL			MX23_IO_ADDRESS(MX23_DIGCTL_BASE_ADDR)</span>
<span class="cp">#define CLKCTRL			MX23_IO_ADDRESS(MX23_CLKCTRL_BASE_ADDR)</span>
<span class="cp">#define PLLCTRL0		(CLKCTRL + 0x0000)</span>
<span class="cp">#define CPU			(CLKCTRL + 0x0020)</span>
<span class="cp">#define HBUS			(CLKCTRL + 0x0030)</span>
<span class="cp">#define XBUS			(CLKCTRL + 0x0040)</span>
<span class="cp">#define XTAL			(CLKCTRL + 0x0050)</span>
<span class="cp">#define PIX			(CLKCTRL + 0x0060)</span>
<span class="cp">#define SSP			(CLKCTRL + 0x0070)</span>
<span class="cp">#define GPMI			(CLKCTRL + 0x0080)</span>
<span class="cp">#define SPDIF			(CLKCTRL + 0x0090)</span>
<span class="cp">#define EMI			(CLKCTRL + 0x00a0)</span>
<span class="cp">#define SAIF			(CLKCTRL + 0x00c0)</span>
<span class="cp">#define TV			(CLKCTRL + 0x00d0)</span>
<span class="cp">#define ETM			(CLKCTRL + 0x00e0)</span>
<span class="cp">#define FRAC			(CLKCTRL + 0x00f0)</span>
<span class="cp">#define CLKSEQ			(CLKCTRL + 0x0110)</span>

<span class="cp">#define BP_CPU_INTERRUPT_WAIT	12</span>
<span class="cp">#define BP_CLKSEQ_BYPASS_SAIF	0</span>
<span class="cp">#define BP_CLKSEQ_BYPASS_SSP	5</span>
<span class="cp">#define BP_SAIF_DIV_FRAC_EN	16</span>
<span class="cp">#define BP_FRAC_IOFRAC		24</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">clk_misc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Gate off cpu clock in WFI for power saving */</span>
	<span class="n">__mxs_setl</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BP_CPU_INTERRUPT_WAIT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">);</span>

	<span class="cm">/* Clear BYPASS for SAIF */</span>
	<span class="n">__mxs_clrl</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BP_CLKSEQ_BYPASS_SAIF</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">);</span>

	<span class="cm">/* SAIF has to use frac div for functional operation */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">SAIF</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BP_SAIF_DIV_FRAC_EN</span><span class="p">;</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">SAIF</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Source ssp clock from ref_io than ref_xtal,</span>
<span class="cm">	 * as ref_xtal only provides 24 MHz as maximum.</span>
<span class="cm">	 */</span>
	<span class="n">__mxs_clrl</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BP_CLKSEQ_BYPASS_SSP</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 480 MHz seems too high to be ssp clock source directly,</span>
<span class="cm">	 * so set frac to get a 288 MHz ref_io.</span>
<span class="cm">	 */</span>
	<span class="n">__mxs_clrl</span><span class="p">(</span><span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="n">BP_FRAC_IOFRAC</span><span class="p">,</span> <span class="n">FRAC</span><span class="p">);</span>
	<span class="n">__mxs_setl</span><span class="p">(</span><span class="mi">30</span> <span class="o">&lt;&lt;</span> <span class="n">BP_FRAC_IOFRAC</span><span class="p">,</span> <span class="n">FRAC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">uart_lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;duart&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;mxs-auart.0&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;mxs-auart.1&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;8006c000.serial&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;8006e000.serial&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80070000.serial&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">hbus_lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;imx23-dma-apbh&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80004000.dma-apbh&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">xbus_lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;duart&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="s">&quot;apb_pclk&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80070000.serial&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="s">&quot;apb_pclk&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;imx23-dma-apbx&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80024000.dma-apbx&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">ssp_lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;imx23-mmc.0&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;imx23-mmc.1&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80010000.ssp&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80034000.ssp&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">lcdif_lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;imx23-fb&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;80030000.lcdif&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">gpmi_lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;imx23-gpmi-nand&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;8000c000.gpmi&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sel_pll</span><span class="p">[]</span>  <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sel_cpu</span><span class="p">[]</span>  <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ref_cpu&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sel_pix</span><span class="p">[]</span>  <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ref_pix&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sel_io</span><span class="p">[]</span>   <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ref_io&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cpu_sels</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;cpu_pll&quot;</span><span class="p">,</span> <span class="s">&quot;cpu_xtal&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">emi_sels</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;emi_pll&quot;</span><span class="p">,</span> <span class="s">&quot;emi_xtal&quot;</span><span class="p">,</span> <span class="p">};</span>

<span class="k">enum</span> <span class="n">imx23_clk</span> <span class="p">{</span>
	<span class="n">ref_xtal</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="n">ref_cpu</span><span class="p">,</span> <span class="n">ref_emi</span><span class="p">,</span> <span class="n">ref_pix</span><span class="p">,</span> <span class="n">ref_io</span><span class="p">,</span> <span class="n">saif_sel</span><span class="p">,</span>
	<span class="n">lcdif_sel</span><span class="p">,</span> <span class="n">gpmi_sel</span><span class="p">,</span> <span class="n">ssp_sel</span><span class="p">,</span> <span class="n">emi_sel</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">etm_sel</span><span class="p">,</span> <span class="n">cpu_pll</span><span class="p">,</span>
	<span class="n">cpu_xtal</span><span class="p">,</span> <span class="n">hbus</span><span class="p">,</span> <span class="n">xbus</span><span class="p">,</span> <span class="n">lcdif_div</span><span class="p">,</span> <span class="n">ssp_div</span><span class="p">,</span> <span class="n">gpmi_div</span><span class="p">,</span> <span class="n">emi_pll</span><span class="p">,</span>
	<span class="n">emi_xtal</span><span class="p">,</span> <span class="n">etm_div</span><span class="p">,</span> <span class="n">saif_div</span><span class="p">,</span> <span class="n">clk32k_div</span><span class="p">,</span> <span class="n">rtc</span><span class="p">,</span> <span class="n">adc</span><span class="p">,</span> <span class="n">spdif_div</span><span class="p">,</span>
	<span class="n">clk32k</span><span class="p">,</span> <span class="n">dri</span><span class="p">,</span> <span class="n">pwm</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">uart</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="n">gpmi</span><span class="p">,</span> <span class="n">spdif</span><span class="p">,</span> <span class="n">emi</span><span class="p">,</span> <span class="n">saif</span><span class="p">,</span>
	<span class="n">lcdif</span><span class="p">,</span> <span class="n">etm</span><span class="p">,</span> <span class="n">usb</span><span class="p">,</span> <span class="n">usb_pwr</span><span class="p">,</span>
	<span class="n">clk_max</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clks</span><span class="p">[</span><span class="n">clk_max</span><span class="p">];</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">imx23_clk</span> <span class="n">clks_init_on</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">cpu</span><span class="p">,</span> <span class="n">hbus</span><span class="p">,</span> <span class="n">xbus</span><span class="p">,</span> <span class="n">emi</span><span class="p">,</span> <span class="n">uart</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">mx23_clocks_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">clk_misc_init</span><span class="p">();</span>

	<span class="n">clks</span><span class="p">[</span><span class="n">ref_xtal</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_fixed</span><span class="p">(</span><span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="mi">24000000</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">pll</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_pll</span><span class="p">(</span><span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">PLLCTRL0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">480000000</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ref_cpu</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_ref</span><span class="p">(</span><span class="s">&quot;ref_cpu&quot;</span><span class="p">,</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="n">FRAC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ref_emi</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_ref</span><span class="p">(</span><span class="s">&quot;ref_emi&quot;</span><span class="p">,</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="n">FRAC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_ref</span><span class="p">(</span><span class="s">&quot;ref_pix&quot;</span><span class="p">,</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="n">FRAC</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ref_io</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_ref</span><span class="p">(</span><span class="s">&quot;ref_io&quot;</span><span class="p">,</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="n">FRAC</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">saif_sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;saif_sel&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sel_pll</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sel_pll</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">lcdif_sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;lcdif_sel&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sel_pix</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sel_pix</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">gpmi_sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;gpmi_sel&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sel_io</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sel_io</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ssp_sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;ssp_sel&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sel_io</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sel_io</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">emi_sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;emi_sel&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">emi_sels</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">emi_sels</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cpu_sels</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cpu_sels</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">etm_sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_mux</span><span class="p">(</span><span class="s">&quot;etm_sel&quot;</span><span class="p">,</span> <span class="n">CLKSEQ</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sel_cpu</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sel_cpu</span><span class="p">));</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">cpu_pll</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;cpu_pll&quot;</span><span class="p">,</span> <span class="s">&quot;ref_cpu&quot;</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">cpu_xtal</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;cpu_xtal&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">hbus</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;hbus&quot;</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">HBUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">xbus</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;xbus&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">XBUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">lcdif_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;lcdif_div&quot;</span><span class="p">,</span> <span class="s">&quot;lcdif_sel&quot;</span><span class="p">,</span> <span class="n">PIX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ssp_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;ssp_div&quot;</span><span class="p">,</span> <span class="s">&quot;ssp_sel&quot;</span><span class="p">,</span> <span class="n">SSP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">gpmi_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;gpmi_div&quot;</span><span class="p">,</span> <span class="s">&quot;gpmi_sel&quot;</span><span class="p">,</span> <span class="n">GPMI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">emi_pll</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;emi_pll&quot;</span><span class="p">,</span> <span class="s">&quot;ref_emi&quot;</span><span class="p">,</span> <span class="n">EMI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">emi_xtal</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;emi_xtal&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">EMI</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">etm_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_div</span><span class="p">(</span><span class="s">&quot;etm_div&quot;</span><span class="p">,</span> <span class="s">&quot;etm_sel&quot;</span><span class="p">,</span> <span class="n">ETM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">saif_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_frac</span><span class="p">(</span><span class="s">&quot;saif_div&quot;</span><span class="p">,</span> <span class="s">&quot;saif_sel&quot;</span><span class="p">,</span> <span class="n">SAIF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">clk32k_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_fixed_factor</span><span class="p">(</span><span class="s">&quot;clk32k_div&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">750</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">rtc</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_fixed_factor</span><span class="p">(</span><span class="s">&quot;rtc&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">768</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">adc</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_fixed_factor</span><span class="p">(</span><span class="s">&quot;adc&quot;</span><span class="p">,</span> <span class="s">&quot;clk32k&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">spdif_div</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_fixed_factor</span><span class="p">(</span><span class="s">&quot;spdif_div&quot;</span><span class="p">,</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">clk32k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;clk32k&quot;</span><span class="p">,</span> <span class="s">&quot;clk32k_div&quot;</span><span class="p">,</span> <span class="n">XTAL</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">dri</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;dri&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">XTAL</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">pwm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;pwm&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">XTAL</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;filt&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">XTAL</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">uart</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;uart&quot;</span><span class="p">,</span> <span class="s">&quot;ref_xtal&quot;</span><span class="p">,</span> <span class="n">XTAL</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">ssp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;ssp&quot;</span><span class="p">,</span> <span class="s">&quot;ssp_div&quot;</span><span class="p">,</span> <span class="n">SSP</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">gpmi</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;gpmi&quot;</span><span class="p">,</span> <span class="s">&quot;gpmi_div&quot;</span><span class="p">,</span> <span class="n">GPMI</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">spdif</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;spdif&quot;</span><span class="p">,</span> <span class="s">&quot;spdif_div&quot;</span><span class="p">,</span> <span class="n">SPDIF</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">emi</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;emi&quot;</span><span class="p">,</span> <span class="s">&quot;emi_sel&quot;</span><span class="p">,</span> <span class="n">EMI</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">saif</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;saif&quot;</span><span class="p">,</span> <span class="s">&quot;saif_div&quot;</span><span class="p">,</span> <span class="n">SAIF</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">lcdif</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;lcdif&quot;</span><span class="p">,</span> <span class="s">&quot;lcdif_div&quot;</span><span class="p">,</span> <span class="n">PIX</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">etm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;etm&quot;</span><span class="p">,</span> <span class="s">&quot;etm_div&quot;</span><span class="p">,</span> <span class="n">ETM</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">usb</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxs_clk_gate</span><span class="p">(</span><span class="s">&quot;usb&quot;</span><span class="p">,</span> <span class="s">&quot;usb_pwr&quot;</span><span class="p">,</span> <span class="n">DIGCTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clks</span><span class="p">[</span><span class="n">usb_pwr</span><span class="p">]</span> <span class="o">=</span> <span class="n">clk_register_gate</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;usb_pwr&quot;</span><span class="p">,</span> <span class="s">&quot;pll&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PLLCTRL0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mxs_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;i.MX23 clk %d: register failed with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="n">clk_register_clkdev</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">clk32k</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;timrot&quot;</span><span class="p">);</span>
	<span class="n">clk_register_clkdevs</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">hbus</span><span class="p">],</span> <span class="n">hbus_lookups</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hbus_lookups</span><span class="p">));</span>
	<span class="n">clk_register_clkdevs</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">xbus</span><span class="p">],</span> <span class="n">xbus_lookups</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xbus_lookups</span><span class="p">));</span>
	<span class="n">clk_register_clkdevs</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">uart</span><span class="p">],</span> <span class="n">uart_lookups</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart_lookups</span><span class="p">));</span>
	<span class="n">clk_register_clkdevs</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">ssp</span><span class="p">],</span> <span class="n">ssp_lookups</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ssp_lookups</span><span class="p">));</span>
	<span class="n">clk_register_clkdevs</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">gpmi</span><span class="p">],</span> <span class="n">gpmi_lookups</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gpmi_lookups</span><span class="p">));</span>
	<span class="n">clk_register_clkdevs</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">lcdif</span><span class="p">],</span> <span class="n">lcdif_lookups</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lcdif_lookups</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clks_init_on</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">clks</span><span class="p">[</span><span class="n">clks_init_on</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>

	<span class="n">mxs_timer_init</span><span class="p">(</span><span class="n">MX23_INT_TIMER0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
