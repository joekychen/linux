<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › edac › i5400_edac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>i5400_edac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel 5400 class Memory Controllers kernel module (Seaburg)</span>
<span class="cm"> *</span>
<span class="cm"> * This file may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 by:</span>
<span class="cm"> *	 Ben Woodard &lt;woodard@redhat.com&gt;</span>
<span class="cm"> *	 Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Red Hat Inc. http://www.redhat.com</span>
<span class="cm"> *</span>
<span class="cm"> * Forked and adapted from the i5000_edac driver which was</span>
<span class="cm"> * written by Douglas Thompson Linux Networx &lt;norsk5@xmission.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This module is based on the following document:</span>
<span class="cm"> *</span>
<span class="cm"> * Intel 5400 Chipset Memory Controller Hub (MCH) - Datasheet</span>
<span class="cm"> * 	http://developer.intel.com/design/chipsets/datashts/313070.htm</span>
<span class="cm"> *</span>
<span class="cm"> * This Memory Controller manages DDR2 FB-DIMMs. It has 2 branches, each with</span>
<span class="cm"> * 2 channels operating in lockstep no-mirror mode. Each channel can have up to</span>
<span class="cm"> * 4 dimm&#39;s, each with up to 8GB.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/edac.h&gt;</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>

<span class="cp">#include &quot;edac_core.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Alter this version for the I5400 module when modifications are made</span>
<span class="cm"> */</span>
<span class="cp">#define I5400_REVISION    &quot; Ver: 1.0.0&quot;</span>

<span class="cp">#define EDAC_MOD_STR      &quot;i5400_edac&quot;</span>

<span class="cp">#define i5400_printk(level, fmt, arg...) \</span>
<span class="cp">	edac_printk(level, &quot;i5400&quot;, fmt, ##arg)</span>

<span class="cp">#define i5400_mc_printk(mci, level, fmt, arg...) \</span>
<span class="cp">	edac_mc_chipset_printk(mci, level, &quot;i5400&quot;, fmt, ##arg)</span>

<span class="cm">/* Limits for i5400 */</span>
<span class="cp">#define MAX_BRANCHES		2</span>
<span class="cp">#define CHANNELS_PER_BRANCH	2</span>
<span class="cp">#define DIMMS_PER_CHANNEL	4</span>
<span class="cp">#define	MAX_CHANNELS		(MAX_BRANCHES * CHANNELS_PER_BRANCH)</span>

<span class="cm">/* Device 16,</span>
<span class="cm"> * Function 0: System Address</span>
<span class="cm"> * Function 1: Memory Branch Map, Control, Errors Register</span>
<span class="cm"> * Function 2: FSB Error Registers</span>
<span class="cm"> *</span>
<span class="cm"> * All 3 functions of Device 16 (0,1,2) share the SAME DID and</span>
<span class="cm"> * uses PCI_DEVICE_ID_INTEL_5400_ERR for device 16 (0,1,2),</span>
<span class="cm"> * PCI_DEVICE_ID_INTEL_5400_FBD0 and PCI_DEVICE_ID_INTEL_5400_FBD1</span>
<span class="cm"> * for device 21 (0,1).</span>
<span class="cm"> */</span>

	<span class="cm">/* OFFSETS for Function 0 */</span>
<span class="cp">#define		AMBASE			0x48 </span><span class="cm">/* AMB Mem Mapped Reg Region Base */</span><span class="cp"></span>
<span class="cp">#define		MAXCH			0x56 </span><span class="cm">/* Max Channel Number */</span><span class="cp"></span>
<span class="cp">#define		MAXDIMMPERCH		0x57 </span><span class="cm">/* Max DIMM PER Channel Number */</span><span class="cp"></span>

	<span class="cm">/* OFFSETS for Function 1 */</span>
<span class="cp">#define		TOLM			0x6C</span>
<span class="cp">#define		REDMEMB			0x7C</span>
<span class="cp">#define			REC_ECC_LOCATOR_ODD(x)	((x) &amp; 0x3fe00) </span><span class="cm">/* bits [17:9] indicate ODD, [8:0]  indicate EVEN */</span><span class="cp"></span>
<span class="cp">#define		MIR0			0x80</span>
<span class="cp">#define		MIR1			0x84</span>
<span class="cp">#define		AMIR0			0x8c</span>
<span class="cp">#define		AMIR1			0x90</span>

	<span class="cm">/* Fatal error registers */</span>
<span class="cp">#define		FERR_FAT_FBD		0x98	</span><span class="cm">/* also called as FERR_FAT_FB_DIMM at datasheet */</span><span class="cp"></span>
<span class="cp">#define			FERR_FAT_FBDCHAN (3&lt;&lt;28)	</span><span class="cm">/* channel index where the highest-order error occurred */</span><span class="cp"></span>

<span class="cp">#define		NERR_FAT_FBD		0x9c</span>
<span class="cp">#define		FERR_NF_FBD		0xa0	</span><span class="cm">/* also called as FERR_NFAT_FB_DIMM at datasheet */</span><span class="cp"></span>

	<span class="cm">/* Non-fatal error register */</span>
<span class="cp">#define		NERR_NF_FBD		0xa4</span>

	<span class="cm">/* Enable error mask */</span>
<span class="cp">#define		EMASK_FBD		0xa8</span>

<span class="cp">#define		ERR0_FBD		0xac</span>
<span class="cp">#define		ERR1_FBD		0xb0</span>
<span class="cp">#define		ERR2_FBD		0xb4</span>
<span class="cp">#define		MCERR_FBD		0xb8</span>

	<span class="cm">/* No OFFSETS for Device 16 Function 2 */</span>

<span class="cm">/*</span>
<span class="cm"> * Device 21,</span>
<span class="cm"> * Function 0: Memory Map Branch 0</span>
<span class="cm"> *</span>
<span class="cm"> * Device 22,</span>
<span class="cm"> * Function 0: Memory Map Branch 1</span>
<span class="cm"> */</span>

	<span class="cm">/* OFFSETS for Function 0 */</span>
<span class="cp">#define AMBPRESENT_0	0x64</span>
<span class="cp">#define AMBPRESENT_1	0x66</span>
<span class="cp">#define MTR0		0x80</span>
<span class="cp">#define MTR1		0x82</span>
<span class="cp">#define MTR2		0x84</span>
<span class="cp">#define MTR3		0x86</span>

	<span class="cm">/* OFFSETS for Function 1 */</span>
<span class="cp">#define NRECFGLOG		0x74</span>
<span class="cp">#define RECFGLOG		0x78</span>
<span class="cp">#define NRECMEMA		0xbe</span>
<span class="cp">#define NRECMEMB		0xc0</span>
<span class="cp">#define NRECFB_DIMMA		0xc4</span>
<span class="cp">#define NRECFB_DIMMB		0xc8</span>
<span class="cp">#define NRECFB_DIMMC		0xcc</span>
<span class="cp">#define NRECFB_DIMMD		0xd0</span>
<span class="cp">#define NRECFB_DIMME		0xd4</span>
<span class="cp">#define NRECFB_DIMMF		0xd8</span>
<span class="cp">#define REDMEMA			0xdC</span>
<span class="cp">#define RECMEMA			0xf0</span>
<span class="cp">#define RECMEMB			0xf4</span>
<span class="cp">#define RECFB_DIMMA		0xf8</span>
<span class="cp">#define RECFB_DIMMB		0xec</span>
<span class="cp">#define RECFB_DIMMC		0xf0</span>
<span class="cp">#define RECFB_DIMMD		0xf4</span>
<span class="cp">#define RECFB_DIMME		0xf8</span>
<span class="cp">#define RECFB_DIMMF		0xfC</span>

<span class="cm">/*</span>
<span class="cm"> * Error indicator bits and masks</span>
<span class="cm"> * Error masks are according with Table 5-17 of i5400 datasheet</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">error_mask</span> <span class="p">{</span>
	<span class="n">EMASK_M1</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">,</span>  <span class="cm">/* Memory Write error on non-redundant retry */</span>
	<span class="n">EMASK_M2</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="cm">/* Memory or FB-DIMM configuration CRC read error */</span>
	<span class="n">EMASK_M3</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span>  <span class="cm">/* Reserved */</span>
	<span class="n">EMASK_M4</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">,</span>  <span class="cm">/* Uncorrectable Data ECC on Replay */</span>
	<span class="n">EMASK_M5</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">,</span>  <span class="cm">/* Aliased Uncorrectable Non-Mirrored Demand Data ECC */</span>
	<span class="n">EMASK_M6</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">,</span>  <span class="cm">/* Unsupported on i5400 */</span>
	<span class="n">EMASK_M7</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">,</span>  <span class="cm">/* Aliased Uncorrectable Resilver- or Spare-Copy Data ECC */</span>
	<span class="n">EMASK_M8</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">,</span>  <span class="cm">/* Aliased Uncorrectable Patrol Data ECC */</span>
	<span class="n">EMASK_M9</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">,</span>  <span class="cm">/* Non-Aliased Uncorrectable Non-Mirrored Demand Data ECC */</span>
	<span class="n">EMASK_M10</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">,</span>  <span class="cm">/* Unsupported on i5400 */</span>
	<span class="n">EMASK_M11</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="cm">/* Non-Aliased Uncorrectable Resilver- or Spare-Copy Data ECC  */</span>
	<span class="n">EMASK_M12</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="cm">/* Non-Aliased Uncorrectable Patrol Data ECC */</span>
	<span class="n">EMASK_M13</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">,</span> <span class="cm">/* Memory Write error on first attempt */</span>
	<span class="n">EMASK_M14</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">,</span> <span class="cm">/* FB-DIMM Configuration Write error on first attempt */</span>
	<span class="n">EMASK_M15</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">,</span> <span class="cm">/* Memory or FB-DIMM configuration CRC read error */</span>
	<span class="n">EMASK_M16</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">,</span> <span class="cm">/* Channel Failed-Over Occurred */</span>
	<span class="n">EMASK_M17</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">,</span> <span class="cm">/* Correctable Non-Mirrored Demand Data ECC */</span>
	<span class="n">EMASK_M18</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">,</span> <span class="cm">/* Unsupported on i5400 */</span>
	<span class="n">EMASK_M19</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">18</span><span class="p">,</span> <span class="cm">/* Correctable Resilver- or Spare-Copy Data ECC */</span>
	<span class="n">EMASK_M20</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">19</span><span class="p">,</span> <span class="cm">/* Correctable Patrol Data ECC */</span>
	<span class="n">EMASK_M21</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">,</span> <span class="cm">/* FB-DIMM Northbound parity error on FB-DIMM Sync Status */</span>
	<span class="n">EMASK_M22</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">21</span><span class="p">,</span> <span class="cm">/* SPD protocol Error */</span>
	<span class="n">EMASK_M23</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">22</span><span class="p">,</span> <span class="cm">/* Non-Redundant Fast Reset Timeout */</span>
	<span class="n">EMASK_M24</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="p">,</span> <span class="cm">/* Refresh error */</span>
	<span class="n">EMASK_M25</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">,</span> <span class="cm">/* Memory Write error on redundant retry */</span>
	<span class="n">EMASK_M26</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">25</span><span class="p">,</span> <span class="cm">/* Redundant Fast Reset Timeout */</span>
	<span class="n">EMASK_M27</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">26</span><span class="p">,</span> <span class="cm">/* Correctable Counter Threshold Exceeded */</span>
	<span class="n">EMASK_M28</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">,</span> <span class="cm">/* DIMM-Spare Copy Completed */</span>
	<span class="n">EMASK_M29</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">,</span> <span class="cm">/* DIMM-Isolation Completed */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Names to translate bit error into something useful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">error_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Memory Write error on non-redundant retry&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Memory or FB-DIMM configuration CRC read error&quot;</span><span class="p">,</span>
	<span class="cm">/* Reserved */</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Uncorrectable Data ECC on Replay&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Aliased Uncorrectable Non-Mirrored Demand Data ECC&quot;</span><span class="p">,</span>
	<span class="cm">/* M6 Unsupported on i5400 */</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Aliased Uncorrectable Resilver- or Spare-Copy Data ECC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Aliased Uncorrectable Patrol Data ECC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Non-Aliased Uncorrectable Non-Mirrored Demand Data ECC&quot;</span><span class="p">,</span>
	<span class="cm">/* M10 Unsupported on i5400 */</span>
	<span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Non-Aliased Uncorrectable Resilver- or Spare-Copy Data ECC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Non-Aliased Uncorrectable Patrol Data ECC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Memory Write error on first attempt&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FB-DIMM Configuration Write error on first attempt&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Memory or FB-DIMM configuration CRC read error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Channel Failed-Over Occurred&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Correctable Non-Mirrored Demand Data ECC&quot;</span><span class="p">,</span>
	<span class="cm">/* M18 Unsupported on i5400 */</span>
	<span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Correctable Resilver- or Spare-Copy Data ECC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Correctable Patrol Data ECC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FB-DIMM Northbound parity error on FB-DIMM Sync Status&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;SPD protocol Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Non-Redundant Fast Reset Timeout&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Refresh error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Memory Write error on redundant retry&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Redundant Fast Reset Timeout&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Correctable Counter Threshold Exceeded&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DIMM-Spare Copy Completed&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DIMM-Isolation Completed&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Fatal errors */</span>
<span class="cp">#define ERROR_FAT_MASK		(EMASK_M1 | \</span>
<span class="cp">				 EMASK_M2 | \</span>
<span class="cp">				 EMASK_M23)</span>

<span class="cm">/* Correctable errors */</span>
<span class="cp">#define ERROR_NF_CORRECTABLE	(EMASK_M27 | \</span>
<span class="cp">				 EMASK_M20 | \</span>
<span class="cp">				 EMASK_M19 | \</span>
<span class="cp">				 EMASK_M18 | \</span>
<span class="cp">				 EMASK_M17 | \</span>
<span class="cp">				 EMASK_M16)</span>
<span class="cp">#define ERROR_NF_DIMM_SPARE	(EMASK_M29 | \</span>
<span class="cp">				 EMASK_M28)</span>
<span class="cp">#define ERROR_NF_SPD_PROTOCOL	(EMASK_M22)</span>
<span class="cp">#define ERROR_NF_NORTH_CRC	(EMASK_M21)</span>

<span class="cm">/* Recoverable errors */</span>
<span class="cp">#define ERROR_NF_RECOVERABLE	(EMASK_M26 | \</span>
<span class="cp">				 EMASK_M25 | \</span>
<span class="cp">				 EMASK_M24 | \</span>
<span class="cp">				 EMASK_M15 | \</span>
<span class="cp">				 EMASK_M14 | \</span>
<span class="cp">				 EMASK_M13 | \</span>
<span class="cp">				 EMASK_M12 | \</span>
<span class="cp">				 EMASK_M11 | \</span>
<span class="cp">				 EMASK_M9  | \</span>
<span class="cp">				 EMASK_M8  | \</span>
<span class="cp">				 EMASK_M7  | \</span>
<span class="cp">				 EMASK_M5)</span>

<span class="cm">/* uncorrectable errors */</span>
<span class="cp">#define ERROR_NF_UNCORRECTABLE	(EMASK_M4)</span>

<span class="cm">/* mask to all non-fatal errors */</span>
<span class="cp">#define ERROR_NF_MASK		(ERROR_NF_CORRECTABLE   | \</span>
<span class="cp">				 ERROR_NF_UNCORRECTABLE | \</span>
<span class="cp">				 ERROR_NF_RECOVERABLE   | \</span>
<span class="cp">				 ERROR_NF_DIMM_SPARE    | \</span>
<span class="cp">				 ERROR_NF_SPD_PROTOCOL  | \</span>
<span class="cp">				 ERROR_NF_NORTH_CRC)</span>

<span class="cm">/*</span>
<span class="cm"> * Define error masks for the several registers</span>
<span class="cm"> */</span>

<span class="cm">/* Enable all fatal and non fatal errors */</span>
<span class="cp">#define ENABLE_EMASK_ALL	(ERROR_FAT_MASK | ERROR_NF_MASK)</span>

<span class="cm">/* mask for fatal error registers */</span>
<span class="cp">#define FERR_FAT_MASK ERROR_FAT_MASK</span>

<span class="cm">/* masks for non-fatal error register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">to_nf_mask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">EMASK_M29</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">from_nf_ferr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">EMASK_M29</span><span class="p">)</span> <span class="o">|</span>		<span class="cm">/* Bit 28 */</span>
	       <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* Bits 0 to 27 */</span>
<span class="p">};</span>

<span class="cp">#define FERR_NF_MASK		to_nf_mask(ERROR_NF_MASK)</span>
<span class="cp">#define FERR_NF_CORRECTABLE	to_nf_mask(ERROR_NF_CORRECTABLE)</span>
<span class="cp">#define FERR_NF_DIMM_SPARE	to_nf_mask(ERROR_NF_DIMM_SPARE)</span>
<span class="cp">#define FERR_NF_SPD_PROTOCOL	to_nf_mask(ERROR_NF_SPD_PROTOCOL)</span>
<span class="cp">#define FERR_NF_NORTH_CRC	to_nf_mask(ERROR_NF_NORTH_CRC)</span>
<span class="cp">#define FERR_NF_RECOVERABLE	to_nf_mask(ERROR_NF_RECOVERABLE)</span>
<span class="cp">#define FERR_NF_UNCORRECTABLE	to_nf_mask(ERROR_NF_UNCORRECTABLE)</span>

<span class="cm">/* Defines to extract the vaious fields from the</span>
<span class="cm"> *	MTRx - Memory Technology Registers</span>
<span class="cm"> */</span>
<span class="cp">#define MTR_DIMMS_PRESENT(mtr)		((mtr) &amp; (1 &lt;&lt; 10))</span>
<span class="cp">#define MTR_DIMMS_ETHROTTLE(mtr)	((mtr) &amp; (1 &lt;&lt; 9))</span>
<span class="cp">#define MTR_DRAM_WIDTH(mtr)		(((mtr) &amp; (1 &lt;&lt; 8)) ? 8 : 4)</span>
<span class="cp">#define MTR_DRAM_BANKS(mtr)		(((mtr) &amp; (1 &lt;&lt; 6)) ? 8 : 4)</span>
<span class="cp">#define MTR_DRAM_BANKS_ADDR_BITS(mtr)	((MTR_DRAM_BANKS(mtr) == 8) ? 3 : 2)</span>
<span class="cp">#define MTR_DIMM_RANK(mtr)		(((mtr) &gt;&gt; 5) &amp; 0x1)</span>
<span class="cp">#define MTR_DIMM_RANK_ADDR_BITS(mtr)	(MTR_DIMM_RANK(mtr) ? 2 : 1)</span>
<span class="cp">#define MTR_DIMM_ROWS(mtr)		(((mtr) &gt;&gt; 2) &amp; 0x3)</span>
<span class="cp">#define MTR_DIMM_ROWS_ADDR_BITS(mtr)	(MTR_DIMM_ROWS(mtr) + 13)</span>
<span class="cp">#define MTR_DIMM_COLS(mtr)		((mtr) &amp; 0x3)</span>
<span class="cp">#define MTR_DIMM_COLS_ADDR_BITS(mtr)	(MTR_DIMM_COLS(mtr) + 10)</span>

<span class="cm">/* This applies to FERR_NF_FB-DIMM as well as FERR_FAT_FB-DIMM */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">extract_fbdchan_indx</span><span class="p">(</span><span class="n">u32</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EDAC_DEBUG</span>
<span class="cm">/* MTR NUMROW */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">numrow_toString</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;8,192 - 13 rows&quot;</span><span class="p">,</span>
	<span class="s">&quot;16,384 - 14 rows&quot;</span><span class="p">,</span>
	<span class="s">&quot;32,768 - 15 rows&quot;</span><span class="p">,</span>
	<span class="s">&quot;65,536 - 16 rows&quot;</span>
<span class="p">};</span>

<span class="cm">/* MTR NUMCOL */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">numcol_toString</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;1,024 - 10 columns&quot;</span><span class="p">,</span>
	<span class="s">&quot;2,048 - 11 columns&quot;</span><span class="p">,</span>
	<span class="s">&quot;4,096 - 12 columns&quot;</span><span class="p">,</span>
	<span class="s">&quot;reserved&quot;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* Device name and register DID (Device ID) */</span>
<span class="k">struct</span> <span class="n">i5400_dev_info</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ctl_name</span><span class="p">;</span>	<span class="cm">/* name for this device */</span>
	<span class="n">u16</span> <span class="n">fsb_mapping_errors</span><span class="p">;</span>	<span class="cm">/* DID for the branchmap,control */</span>
<span class="p">};</span>

<span class="cm">/* Table of devices attributes supported by this driver */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i5400_dev_info</span> <span class="n">i5400_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ctl_name</span> <span class="o">=</span> <span class="s">&quot;I5400&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fsb_mapping_errors</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_5400_ERR</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i5400_dimm_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">megabytes</span><span class="p">;</span>		<span class="cm">/* size, 0 means not present  */</span>
<span class="p">};</span>

<span class="cm">/* driver private data structure */</span>
<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">system_address</span><span class="p">;</span>		<span class="cm">/* 16.0 */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">branchmap_werrors</span><span class="p">;</span>	<span class="cm">/* 16.1 */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">fsb_error_regs</span><span class="p">;</span>		<span class="cm">/* 16.2 */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">branch_0</span><span class="p">;</span>		<span class="cm">/* 21.0 */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">branch_1</span><span class="p">;</span>		<span class="cm">/* 22.0 */</span>

	<span class="n">u16</span> <span class="n">tolm</span><span class="p">;</span>				<span class="cm">/* top of low memory */</span>
	<span class="n">u64</span> <span class="n">ambase</span><span class="p">;</span>				<span class="cm">/* AMB BAR */</span>

	<span class="n">u16</span> <span class="n">mir0</span><span class="p">,</span> <span class="n">mir1</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">b0_mtr</span><span class="p">[</span><span class="n">DIMMS_PER_CHANNEL</span><span class="p">];</span>	<span class="cm">/* Memory Technlogy Reg */</span>
	<span class="n">u16</span> <span class="n">b0_ambpresent0</span><span class="p">;</span>			<span class="cm">/* Branch 0, Channel 0 */</span>
	<span class="n">u16</span> <span class="n">b0_ambpresent1</span><span class="p">;</span>			<span class="cm">/* Brnach 0, Channel 1 */</span>

	<span class="n">u16</span> <span class="n">b1_mtr</span><span class="p">[</span><span class="n">DIMMS_PER_CHANNEL</span><span class="p">];</span>	<span class="cm">/* Memory Technlogy Reg */</span>
	<span class="n">u16</span> <span class="n">b1_ambpresent0</span><span class="p">;</span>			<span class="cm">/* Branch 1, Channel 8 */</span>
	<span class="n">u16</span> <span class="n">b1_ambpresent1</span><span class="p">;</span>			<span class="cm">/* Branch 1, Channel 1 */</span>

	<span class="cm">/* DIMM information matrix, allocating architecture maximums */</span>
	<span class="k">struct</span> <span class="n">i5400_dimm_info</span> <span class="n">dimm_info</span><span class="p">[</span><span class="n">DIMMS_PER_CHANNEL</span><span class="p">][</span><span class="n">MAX_CHANNELS</span><span class="p">];</span>

	<span class="cm">/* Actual values for this controller */</span>
	<span class="kt">int</span> <span class="n">maxch</span><span class="p">;</span>				<span class="cm">/* Max channels */</span>
	<span class="kt">int</span> <span class="n">maxdimmperch</span><span class="p">;</span>			<span class="cm">/* Max DIMMs per channel */</span>
<span class="p">};</span>

<span class="cm">/* I5400 MCH error information retrieved from Hardware */</span>
<span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="p">{</span>
	<span class="cm">/* These registers are always read from the MC */</span>
	<span class="n">u32</span> <span class="n">ferr_fat_fbd</span><span class="p">;</span>	<span class="cm">/* First Errors Fatal */</span>
	<span class="n">u32</span> <span class="n">nerr_fat_fbd</span><span class="p">;</span>	<span class="cm">/* Next Errors Fatal */</span>
	<span class="n">u32</span> <span class="n">ferr_nf_fbd</span><span class="p">;</span>	<span class="cm">/* First Errors Non-Fatal */</span>
	<span class="n">u32</span> <span class="n">nerr_nf_fbd</span><span class="p">;</span>	<span class="cm">/* Next Errors Non-Fatal */</span>

	<span class="cm">/* These registers are input ONLY if there was a Recoverable Error */</span>
	<span class="n">u32</span> <span class="n">redmemb</span><span class="p">;</span>		<span class="cm">/* Recoverable Mem Data Error log B */</span>
	<span class="n">u16</span> <span class="n">recmema</span><span class="p">;</span>		<span class="cm">/* Recoverable Mem Error log A */</span>
	<span class="n">u32</span> <span class="n">recmemb</span><span class="p">;</span>		<span class="cm">/* Recoverable Mem Error log B */</span>

	<span class="cm">/* These registers are input ONLY if there was a Non-Rec Error */</span>
	<span class="n">u16</span> <span class="n">nrecmema</span><span class="p">;</span>		<span class="cm">/* Non-Recoverable Mem log A */</span>
	<span class="n">u16</span> <span class="n">nrecmemb</span><span class="p">;</span>		<span class="cm">/* Non-Recoverable Mem log B */</span>

<span class="p">};</span>

<span class="cm">/* note that nrec_rdwr changed from NRECMEMA to NRECMEMB between the 5000 and</span>
<span class="cm">   5400 better to use an inline function than a macro in this case */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nrec_bank</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmema</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nrec_rank</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmema</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nrec_buf_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmema</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nrec_rdwr</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmemb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* This applies to both NREC and REC string so it can be used with nrec_rdwr</span>
<span class="cm">   and rec_rdwr */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rdwr_str</span><span class="p">(</span><span class="kt">int</span> <span class="n">rdwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rdwr</span> <span class="o">?</span> <span class="s">&quot;Write&quot;</span> <span class="o">:</span> <span class="s">&quot;Read&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nrec_cas</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmemb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nrec_ras</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmemb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rec_bank</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmema</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rec_rank</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmema</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rec_rdwr</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmemb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rec_cas</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmemb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rec_ras</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmemb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edac_pci_ctl_info</span> <span class="o">*</span><span class="n">i5400_pci</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_get_error_info	Retrieve the hardware error information from</span>
<span class="cm"> *				the hardware and cache it in the &#39;info&#39;</span>
<span class="cm"> *				structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_get_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="cm">/* read in the 1st FATAL error register */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">FERR_FAT_FBD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Mask only the bits that the doc says are valid</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">FERR_FAT_FBDCHAN</span> <span class="o">|</span> <span class="n">FERR_FAT_MASK</span><span class="p">);</span>

	<span class="cm">/* If there is an error, then read in the</span>
<span class="cm">	   NEXT FATAL error register and the Memory Error Log Register A</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">FERR_FAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_fat_fbd</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

		<span class="cm">/* harvest the various error data we need */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">NERR_FAT_FBD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nerr_fat_fbd</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">NRECMEMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmema</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">NRECMEMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmemb</span><span class="p">);</span>

		<span class="cm">/* Clear the error bits, by writing them back */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">FERR_FAT_FBD</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_fat_fbd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nerr_fat_fbd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmema</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nrecmemb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read in the 1st NON-FATAL error register */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">FERR_NF_FBD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

	<span class="cm">/* If there is an error, then read in the 1st NON-FATAL error</span>
<span class="cm">	 * register as well */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">FERR_NF_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_nf_fbd</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

		<span class="cm">/* harvest the various error data we need */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">NERR_NF_FBD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nerr_nf_fbd</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">RECMEMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmema</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">RECMEMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recmemb</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">REDMEMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">redmemb</span><span class="p">);</span>

		<span class="cm">/* Clear the error bits, by writing them back */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span>
				<span class="n">FERR_NF_FBD</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_nf_fbd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nerr_nf_fbd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">recmema</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">recmemb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">redmemb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i5400_proccess_non_recoverable_info(struct mem_ctl_info *mci,</span>
<span class="cm"> * 					struct i5400_error_info *info,</span>
<span class="cm"> * 					int handle_errors);</span>
<span class="cm"> *</span>
<span class="cm"> *	handle the Intel FATAL and unrecoverable errors, if any</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_proccess_non_recoverable_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">allErrors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="n">EDAC_MC_LABEL_LEN</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">90</span> <span class="o">+</span> <span class="mi">80</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">branch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rdwr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ras</span><span class="p">,</span> <span class="n">cas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errnum</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">hw_event_mc_err_type</span> <span class="n">tp_event</span> <span class="o">=</span> <span class="n">HW_EVENT_ERR_UNCORRECTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allErrors</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* if no error, return now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allErrors</span> <span class="o">&amp;</span>  <span class="n">ERROR_FAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;FATAL&quot;</span><span class="p">;</span>
		<span class="n">tp_event</span> <span class="o">=</span> <span class="n">HW_EVENT_ERR_FATAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">allErrors</span> <span class="o">&amp;</span> <span class="n">FERR_NF_UNCORRECTABLE</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;NON-FATAL uncorrected&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;NON-FATAL recoverable&quot;</span><span class="p">;</span>

	<span class="cm">/* ONLY ONE of the possible error bits will be set, as per the docs */</span>

	<span class="n">branch</span> <span class="o">=</span> <span class="n">extract_fbdchan_indx</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_fat_fbd</span><span class="p">);</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">branch</span><span class="p">;</span>

	<span class="cm">/* Use the NON-Recoverable macros to extract data */</span>
	<span class="n">bank</span> <span class="o">=</span> <span class="n">nrec_bank</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rank</span> <span class="o">=</span> <span class="n">nrec_rank</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">buf_id</span> <span class="o">=</span> <span class="n">nrec_buf_id</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rdwr</span> <span class="o">=</span> <span class="n">nrec_rdwr</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">ras</span> <span class="o">=</span> <span class="n">nrec_ras</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">cas</span> <span class="o">=</span> <span class="n">nrec_cas</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">DIMM= %d  Channels= %d,%d  (Branch= %d &quot;</span>
		<span class="s">&quot;DRAM Bank= %d Buffer ID = %d rdwr= %s ras= %d cas= %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rank</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span>
		<span class="n">buf_id</span><span class="p">,</span> <span class="n">rdwr_str</span><span class="p">(</span><span class="n">rdwr</span><span class="p">),</span> <span class="n">ras</span><span class="p">,</span> <span class="n">cas</span><span class="p">);</span>

	<span class="cm">/* Only 1 bit will be on */</span>
	<span class="n">errnum</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">allErrors</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error_name</span><span class="p">));</span>

	<span class="cm">/* Form out message */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
		 <span class="s">&quot;Bank=%d Buffer ID = %d RAS=%d CAS=%d Err=0x%lx (%s)&quot;</span><span class="p">,</span>
		 <span class="n">bank</span><span class="p">,</span> <span class="n">buf_id</span><span class="p">,</span> <span class="n">ras</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span> <span class="n">allErrors</span><span class="p">,</span> <span class="n">error_name</span><span class="p">[</span><span class="n">errnum</span><span class="p">]);</span>

	<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">tp_event</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span>
			     <span class="n">rdwr</span> <span class="o">?</span> <span class="s">&quot;Write error&quot;</span> <span class="o">:</span> <span class="s">&quot;Read error&quot;</span><span class="p">,</span>
			     <span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i5400_process_fatal_error_info(struct mem_ctl_info *mci,</span>
<span class="cm"> * 				struct i5400_error_info *info,</span>
<span class="cm"> * 				int handle_errors);</span>
<span class="cm"> *</span>
<span class="cm"> *	handle the Intel NON-FATAL errors, if any</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_process_nonfatal_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="n">EDAC_MC_LABEL_LEN</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">90</span> <span class="o">+</span> <span class="mi">80</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">allErrors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">branch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rdwr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ras</span><span class="p">,</span> <span class="n">cas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errnum</span><span class="p">;</span>

	<span class="cm">/* mask off the Error bits that are possible */</span>
	<span class="n">allErrors</span> <span class="o">=</span> <span class="n">from_nf_ferr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_nf_fbd</span> <span class="o">&amp;</span> <span class="n">FERR_NF_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allErrors</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* if no error, return now */</span>

	<span class="cm">/* ONLY ONE of the possible error bits will be set, as per the docs */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allErrors</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ERROR_NF_UNCORRECTABLE</span> <span class="o">|</span> <span class="n">ERROR_NF_RECOVERABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i5400_proccess_non_recoverable_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">allErrors</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Correctable errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">allErrors</span> <span class="o">&amp;</span> <span class="n">ERROR_NF_CORRECTABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Corrected bits= 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allErrors</span><span class="p">);</span>

		<span class="n">branch</span> <span class="o">=</span> <span class="n">extract_fbdchan_indx</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_nf_fbd</span><span class="p">);</span>

		<span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REC_ECC_LOCATOR_ODD</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">redmemb</span><span class="p">))</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Convert channel to be based from zero, instead of</span>
<span class="cm">		 * from branch base of 0 */</span>
		<span class="n">channel</span> <span class="o">+=</span> <span class="n">branch</span><span class="p">;</span>

		<span class="n">bank</span> <span class="o">=</span> <span class="n">rec_bank</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">rank</span> <span class="o">=</span> <span class="n">rec_rank</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">rdwr</span> <span class="o">=</span> <span class="n">rec_rdwr</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">ras</span> <span class="o">=</span> <span class="n">rec_ras</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">cas</span> <span class="o">=</span> <span class="n">rec_cas</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* Only 1 bit will be on */</span>
		<span class="n">errnum</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">allErrors</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error_name</span><span class="p">));</span>

		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">DIMM= %d Channel= %d  (Branch %d &quot;</span>
			<span class="s">&quot;DRAM Bank= %d rdwr= %s ras= %d cas= %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rank</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span>
			<span class="n">rdwr_str</span><span class="p">(</span><span class="n">rdwr</span><span class="p">),</span> <span class="n">ras</span><span class="p">,</span> <span class="n">cas</span><span class="p">);</span>

		<span class="cm">/* Form out message */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
			 <span class="s">&quot;Corrected error (Branch=%d DRAM-Bank=%d RDWR=%s &quot;</span>
			 <span class="s">&quot;RAS=%d CAS=%d, CE Err=0x%lx (%s))&quot;</span><span class="p">,</span>
			 <span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">rdwr_str</span><span class="p">(</span><span class="n">rdwr</span><span class="p">),</span> <span class="n">ras</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span>
			 <span class="n">allErrors</span><span class="p">,</span> <span class="n">error_name</span><span class="p">[</span><span class="n">errnum</span><span class="p">]);</span>

		<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">HW_EVENT_ERR_CORRECTED</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">channel</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span>
				     <span class="n">rdwr</span> <span class="o">?</span> <span class="s">&quot;Write error&quot;</span> <span class="o">:</span> <span class="s">&quot;Read error&quot;</span><span class="p">,</span>
				     <span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Miscellaneous errors */</span>
	<span class="n">errnum</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">allErrors</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error_name</span><span class="p">));</span>

	<span class="n">branch</span> <span class="o">=</span> <span class="n">extract_fbdchan_indx</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_nf_fbd</span><span class="p">);</span>

	<span class="n">i5400_mc_printk</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">KERN_EMERG</span><span class="p">,</span>
			<span class="s">&quot;Non-Fatal misc error (Branch=%d Err=%#lx (%s))&quot;</span><span class="p">,</span>
			<span class="n">branch</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">allErrors</span><span class="p">,</span> <span class="n">error_name</span><span class="p">[</span><span class="n">errnum</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_process_error_info	Process the error info that is</span>
<span class="cm"> *	in the &#39;info&#39; structure, previously retrieved from hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_process_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>	<span class="n">u32</span> <span class="n">allErrors</span><span class="p">;</span>

	<span class="cm">/* First handle any fatal errors that occurred */</span>
	<span class="n">allErrors</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ferr_fat_fbd</span> <span class="o">&amp;</span> <span class="n">FERR_FAT_MASK</span><span class="p">);</span>
	<span class="n">i5400_proccess_non_recoverable_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">allErrors</span><span class="p">);</span>

	<span class="cm">/* now handle any non-fatal errors that occurred */</span>
	<span class="n">i5400_process_nonfatal_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_clear_error	Retrieve any error from the hardware</span>
<span class="cm"> *				but do NOT process that error.</span>
<span class="cm"> *				Used for &#39;clearing&#39; out of previous errors</span>
<span class="cm"> *				Called by the Core module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_clear_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">i5400_get_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_check_error	Retrieve and process errors reported by the</span>
<span class="cm"> *				hardware. Called by the Core module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_check_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_error_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">debugf4</span><span class="p">(</span><span class="s">&quot;MC%d: %s: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">mc_idx</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">i5400_get_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">i5400_process_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_put_devices	&#39;put&#39; all the devices that we have</span>
<span class="cm"> *				reserved via &#39;get&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_put_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="cm">/* Decrement usage count for devices */</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_get_devices	Find and perform &#39;get&#39; operation on the MCH&#39;s</span>
<span class="cm"> *			device/functions we want to reference for this driver</span>
<span class="cm"> *</span>
<span class="cm"> *			Need to &#39;get&#39; device 16 func 1 and func 2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5400_get_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Attempt to &#39;get&#39; the MCH register we want */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				      <span class="n">PCI_DEVICE_ID_INTEL_5400_ERR</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* End of list, leave */</span>
			<span class="n">i5400_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;&#39;system address,Process Bus&#39; &quot;</span>
				<span class="s">&quot;device not found:&quot;</span>
				<span class="s">&quot;vendor 0x%x device 0x%x ERR func 1 &quot;</span>
				<span class="s">&quot;(broken BIOS?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				<span class="n">PCI_DEVICE_ID_INTEL_5400_ERR</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Store device 16 func 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				      <span class="n">PCI_DEVICE_ID_INTEL_5400_ERR</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* End of list, leave */</span>
			<span class="n">i5400_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;&#39;system address,Process Bus&#39; &quot;</span>
				<span class="s">&quot;device not found:&quot;</span>
				<span class="s">&quot;vendor 0x%x device 0x%x ERR func 2 &quot;</span>
				<span class="s">&quot;(broken BIOS?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				<span class="n">PCI_DEVICE_ID_INTEL_5400_ERR</span><span class="p">);</span>

			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Store device 16 func 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;System Address, processor bus- PCI Bus ID: %s  %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_name</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">system_address</span><span class="p">),</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">system_address</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">system_address</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;Branchmap, control and errors - PCI Bus ID: %s  %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_name</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">),</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;FSB Error Regs - PCI Bus ID: %s  %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_name</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span><span class="p">),</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				       <span class="n">PCI_DEVICE_ID_INTEL_5400_FBD0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i5400_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;MC: &#39;BRANCH 0&#39; device not found:&quot;</span>
			<span class="s">&quot;vendor 0x%x device 0x%x Func 0 (broken BIOS?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_5400_FBD0</span><span class="p">);</span>

		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If this device claims to have more than 2 channels then</span>
<span class="cm">	 * fetch Branch 1&#39;s information</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span> <span class="o">&lt;</span> <span class="n">CHANNELS_PER_BRANCH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				       <span class="n">PCI_DEVICE_ID_INTEL_5400_FBD1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i5400_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;MC: &#39;BRANCH 1&#39; device not found:&quot;</span>
			<span class="s">&quot;vendor 0x%x device 0x%x Func 0 &quot;</span>
			<span class="s">&quot;(broken BIOS?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
			<span class="n">PCI_DEVICE_ID_INTEL_5400_FBD1</span><span class="p">);</span>

		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">fsb_error_regs</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	determine_amb_present</span>
<span class="cm"> *</span>
<span class="cm"> *		the information is contained in DIMMS_PER_CHANNEL different</span>
<span class="cm"> *		registers determining which of the DIMMS_PER_CHANNEL requires</span>
<span class="cm"> *              knowing which channel is in question</span>
<span class="cm"> *</span>
<span class="cm"> *	2 branches, each with 2 channels</span>
<span class="cm"> *		b0_ambpresent0 for channel &#39;0&#39;</span>
<span class="cm"> *		b0_ambpresent1 for channel &#39;1&#39;</span>
<span class="cm"> *		b1_ambpresent0 for channel &#39;2&#39;</span>
<span class="cm"> *		b1_ambpresent1 for channel &#39;3&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">determine_amb_present_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">amb_present</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="n">CHANNELS_PER_BRANCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">amb_present</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_ambpresent1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">amb_present</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_ambpresent0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">amb_present</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">amb_present</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">amb_present</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * determine_mtr(pvt, dimm, channel)</span>
<span class="cm"> *</span>
<span class="cm"> * return the proper MTR register as determine by the dimm and desired channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">determine_mtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dimm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mtr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/* There is one MTR for each slot pair of FB-DIMMs,</span>
<span class="cm">	   Each slot pair may be at branch 0 or branch 1.</span>
<span class="cm">	 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">dimm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">DIMMS_PER_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;ERROR: trying to access an invalid dimm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dimm</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="n">CHANNELS_PER_BRANCH</span><span class="p">)</span>
		<span class="n">mtr</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_mtr</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">mtr</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_mtr</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">mtr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_mtr</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot_row</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ans</span><span class="p">;</span>

	<span class="n">ans</span> <span class="o">=</span> <span class="n">MTR_DIMMS_PRESENT</span><span class="p">(</span><span class="n">mtr</span><span class="p">);</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">MTR%d=0x%x:  DIMMs are %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_row</span><span class="p">,</span> <span class="n">mtr</span><span class="p">,</span>
		<span class="n">ans</span> <span class="o">?</span> <span class="s">&quot;Present&quot;</span> <span class="o">:</span> <span class="s">&quot;NOT Present&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ans</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">WIDTH: x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MTR_DRAM_WIDTH</span><span class="p">(</span><span class="n">mtr</span><span class="p">));</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">ELECTRICAL THROTTLING is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">MTR_DIMMS_ETHROTTLE</span><span class="p">(</span><span class="n">mtr</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">NUMBANK: %d bank(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MTR_DRAM_BANKS</span><span class="p">(</span><span class="n">mtr</span><span class="p">));</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">NUMRANK: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MTR_DIMM_RANK</span><span class="p">(</span><span class="n">mtr</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;double&quot;</span> <span class="o">:</span> <span class="s">&quot;single&quot;</span><span class="p">);</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">NUMROW: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numrow_toString</span><span class="p">[</span><span class="n">MTR_DIMM_ROWS</span><span class="p">(</span><span class="n">mtr</span><span class="p">)]);</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">NUMCOL: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numcol_toString</span><span class="p">[</span><span class="n">MTR_DIMM_COLS</span><span class="p">(</span><span class="n">mtr</span><span class="p">)]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dimm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">i5400_dimm_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mtr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">amb_present_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addrBits</span><span class="p">;</span>

	<span class="n">mtr</span> <span class="o">=</span> <span class="n">determine_mtr</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">dimm</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MTR_DIMMS_PRESENT</span><span class="p">(</span><span class="n">mtr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">amb_present_reg</span> <span class="o">=</span> <span class="n">determine_amb_present_reg</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

		<span class="cm">/* Determine if there is a DIMM present in this DIMM slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amb_present_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dimm</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Start with the number of bits for a Bank</span>
<span class="cm">			 * on the DRAM */</span>
			<span class="n">addrBits</span> <span class="o">=</span> <span class="n">MTR_DRAM_BANKS_ADDR_BITS</span><span class="p">(</span><span class="n">mtr</span><span class="p">);</span>
			<span class="cm">/* Add thenumber of ROW bits */</span>
			<span class="n">addrBits</span> <span class="o">+=</span> <span class="n">MTR_DIMM_ROWS_ADDR_BITS</span><span class="p">(</span><span class="n">mtr</span><span class="p">);</span>
			<span class="cm">/* add the number of COLUMN bits */</span>
			<span class="n">addrBits</span> <span class="o">+=</span> <span class="n">MTR_DIMM_COLS_ADDR_BITS</span><span class="p">(</span><span class="n">mtr</span><span class="p">);</span>
			<span class="cm">/* add the number of RANK bits */</span>
			<span class="n">addrBits</span> <span class="o">+=</span> <span class="n">MTR_DIMM_RANK</span><span class="p">(</span><span class="n">mtr</span><span class="p">);</span>

			<span class="n">addrBits</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* add 64 bits per DIMM */</span>
			<span class="n">addrBits</span> <span class="o">-=</span> <span class="mi">20</span><span class="p">;</span>	<span class="cm">/* divide by 2^^20 */</span>
			<span class="n">addrBits</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 8 bits per bytes */</span>

			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">megabytes</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">addrBits</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	calculate_dimm_size</span>
<span class="cm"> *</span>
<span class="cm"> *	also will output a DIMM matrix map, if debug is enabled, for viewing</span>
<span class="cm"> *	how the DIMMs are populated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">calculate_dimm_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_dimm_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dimm</span><span class="p">,</span> <span class="n">max_dimms</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">space</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">branch</span><span class="p">;</span>

	<span class="cm">/* ================= Generate some debug output ================= */</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">mem_buffer</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i5400_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;MC: %s:%s() kmalloc() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Scan all the actual DIMMS</span>
<span class="cm">	 * and calculate the information for each DIMM</span>
<span class="cm">	 * Start with the highest dimm first, to display it first</span>
<span class="cm">	 * and work toward the 0th dimm</span>
<span class="cm">	 */</span>
	<span class="n">max_dimms</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxdimmperch</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dimm</span> <span class="o">=</span> <span class="n">max_dimms</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dimm</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dimm</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* on an odd dimm, first output a &#39;boundary&#39; marker,</span>
<span class="cm">		 * then reset the message buffer  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dimm</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;---------------------------&quot;</span>
					<span class="s">&quot;-------------------------------&quot;</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_buffer</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">mem_buffer</span><span class="p">;</span>
			<span class="n">space</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;dimm %2d    &quot;</span><span class="p">,</span> <span class="n">dimm</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">dimm_info</span><span class="p">[</span><span class="n">dimm</span><span class="p">][</span><span class="n">channel</span><span class="p">];</span>
			<span class="n">handle_channel</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">dimm</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dinfo</span><span class="p">);</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;%4d MB   | &quot;</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">megabytes</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_buffer</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">mem_buffer</span><span class="p">;</span>
		<span class="n">space</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Output the last bottom &#39;boundary&#39; marker */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;---------------------------&quot;</span>
			<span class="s">&quot;-------------------------------&quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_buffer</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">mem_buffer</span><span class="p">;</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="cm">/* now output the &#39;channel&#39; labels */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;           &quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;channel %d | &quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_buffer</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">mem_buffer</span><span class="p">;</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;           &quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">branch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">branch</span> <span class="o">&lt;</span> <span class="n">MAX_BRANCHES</span><span class="p">;</span> <span class="n">branch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="s">&quot;       branch %d       | &quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* output the last message and free buffer */</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mem_buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_get_mc_regs	read in the necessary registers and</span>
<span class="cm"> *				cache locally</span>
<span class="cm"> *</span>
<span class="cm"> *			Fills in the private data members</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_get_mc_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actual_tolm</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_row</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxdimmperch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">way0</span><span class="p">,</span> <span class="n">way1</span><span class="p">;</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">system_address</span><span class="p">,</span> <span class="n">AMBASE</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ambase</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">system_address</span><span class="p">,</span> <span class="n">AMBASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ambase</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">maxdimmperch</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxdimmperch</span><span class="p">;</span>
	<span class="n">maxch</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span><span class="p">;</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;AMBASE= 0x%lx  MAXCH= %d  MAX-DIMM-Per-CH= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ambase</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxdimmperch</span><span class="p">);</span>

	<span class="cm">/* Get the Branch Map regs */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">TOLM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">tolm</span><span class="p">);</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">tolm</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">TOLM (number of 256M regions) =%u (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">tolm</span><span class="p">,</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">tolm</span><span class="p">);</span>

	<span class="n">actual_tolm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="mi">1000l</span> <span class="o">*</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">tolm</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="mi">28</span><span class="p">));</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;Actual TOLM byte addr=%u.%03u GB (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">actual_tolm</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">actual_tolm</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">tolm</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">MIR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir0</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">MIR1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir1</span><span class="p">);</span>

	<span class="cm">/* Get the MIR[0-1] regs */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir0</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="n">way0</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir0</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">way1</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir0</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MIR0: limit= 0x%x  WAY1= %u  WAY0= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">way1</span><span class="p">,</span> <span class="n">way0</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">way0</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir1</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">way1</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mir1</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MIR1: limit= 0x%x  WAY1= %u  WAY0= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">way1</span><span class="p">,</span> <span class="n">way0</span><span class="p">);</span>

	<span class="cm">/* Get the set of MTR[0-3] regs by each branch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">slot_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot_row</span> <span class="o">&lt;</span> <span class="n">DIMMS_PER_CHANNEL</span><span class="p">;</span> <span class="n">slot_row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">where</span> <span class="o">=</span> <span class="n">MTR0</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot_row</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

		<span class="cm">/* Branch 0 set of MTR registers */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]);</span>

		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MTR%d where=0x%x B0 value=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_row</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span> <span class="o">&lt;</span> <span class="n">CHANNELS_PER_BRANCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Branch 1 set of MTR registers */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]);</span>
		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MTR%d where=0x%x B1 value=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_row</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Read and dump branch 0&#39;s MTRs */</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Memory Technology Registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;   Branch 0:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">slot_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot_row</span> <span class="o">&lt;</span> <span class="n">DIMMS_PER_CHANNEL</span><span class="p">;</span> <span class="n">slot_row</span><span class="o">++</span><span class="p">)</span>
		<span class="n">decode_mtr</span><span class="p">(</span><span class="n">slot_row</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span><span class="p">,</span> <span class="n">AMBPRESENT_0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_ambpresent0</span><span class="p">);</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">AMB-Branch 0-present0 0x%x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_ambpresent0</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_0</span><span class="p">,</span> <span class="n">AMBPRESENT_1</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_ambpresent1</span><span class="p">);</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">AMB-Branch 0-present1 0x%x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b0_ambpresent1</span><span class="p">);</span>

	<span class="cm">/* Only if we have 2 branchs (4 channels) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span> <span class="o">&lt;</span> <span class="n">CHANNELS_PER_BRANCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Read and dump  branch 1&#39;s MTRs */</span>
		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;   Branch 1:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">slot_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot_row</span> <span class="o">&lt;</span> <span class="n">DIMMS_PER_CHANNEL</span><span class="p">;</span> <span class="n">slot_row</span><span class="o">++</span><span class="p">)</span>
			<span class="n">decode_mtr</span><span class="p">(</span><span class="n">slot_row</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_mtr</span><span class="p">[</span><span class="n">slot_row</span><span class="p">]);</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span><span class="p">,</span> <span class="n">AMBPRESENT_0</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent0</span><span class="p">);</span>
		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">AMB-Branch 1-present0 0x%x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent0</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branch_1</span><span class="p">,</span> <span class="n">AMBPRESENT_1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent1</span><span class="p">);</span>
		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">AMB-Branch 1-present1 0x%x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">b1_ambpresent1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Go and determine the size of each DIMM and place in an</span>
<span class="cm">	 * orderly matrix */</span>
	<span class="n">calculate_dimm_size</span><span class="p">(</span><span class="n">pvt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_init_dimms	Initialize the &#39;dimms&#39; table within</span>
<span class="cm"> *				the mci control	structure with the</span>
<span class="cm"> *				addressing of memory.</span>
<span class="cm"> *</span>
<span class="cm"> *	return:</span>
<span class="cm"> *		0	success</span>
<span class="cm"> *		1	no actual memory found on this MC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5400_init_dimms</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dimm_info</span> <span class="o">*</span><span class="n">dimm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ndimms</span><span class="p">,</span> <span class="n">channel_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_dimms</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size_mb</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">channel</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="n">channel_count</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span><span class="p">;</span>
	<span class="n">max_dimms</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxdimmperch</span><span class="p">;</span>

	<span class="n">ndimms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: remove  pvt-&gt;dimm_info[slot][channel] and use the 3</span>
<span class="cm">	 * layers here.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	     <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtr</span> <span class="o">=</span> <span class="n">determine_mtr</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

			<span class="cm">/* if no DIMMS on this slot, continue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MTR_DIMMS_PRESENT</span><span class="p">(</span><span class="n">mtr</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">dimm</span> <span class="o">=</span> <span class="n">EDAC_DIMM_PTR</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">dimms</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">n_layers</span><span class="p">,</span>
				       <span class="n">channel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">channel</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

			<span class="n">size_mb</span> <span class="o">=</span>  <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">dimm_info</span><span class="p">[</span><span class="n">slot</span><span class="p">][</span><span class="n">channel</span><span class="p">].</span><span class="n">megabytes</span><span class="p">;</span>

			<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s: dimm%zd (branch %d channel %d slot %d): %d.%03d GB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dimm</span> <span class="o">-</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">dimms</span><span class="p">,</span>
				<span class="n">channel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">channel</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
				<span class="n">size_mb</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">size_mb</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">size_mb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">grain</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">MTR_DRAM_WIDTH</span><span class="p">(</span><span class="n">mtr</span><span class="p">)</span> <span class="o">?</span> <span class="n">DEV_X8</span> <span class="o">:</span> <span class="n">DEV_X4</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">mtype</span> <span class="o">=</span> <span class="n">MEM_FB_DDR2</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * The eccc mechanism is SDDC (aka SECC), with</span>
<span class="cm">			 * is similar to Chipkill.</span>
<span class="cm">			 */</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">edac_mode</span> <span class="o">=</span> <span class="n">MTR_DRAM_WIDTH</span><span class="p">(</span><span class="n">mtr</span><span class="p">)</span> <span class="o">?</span>
					  <span class="n">EDAC_S8ECD8ED</span> <span class="o">:</span> <span class="n">EDAC_S4ECD4ED</span><span class="p">;</span>
			<span class="n">ndimms</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When just one memory is provided, it should be at location (0,0,0).</span>
<span class="cm">	 * With such single-DIMM mode, the SDCC algorithm degrades to SECDEC+.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndimms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dimms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">edac_mode</span> <span class="o">=</span> <span class="n">EDAC_SECDED</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ndimms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_enable_error_reporting</span>
<span class="cm"> *			Turn on the memory reporting features of the hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5400_enable_error_reporting</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fbd_error_mask</span><span class="p">;</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="cm">/* Read the FBD Error Mask Register */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">EMASK_FBD</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">fbd_error_mask</span><span class="p">);</span>

	<span class="cm">/* Enable with a &#39;0&#39; */</span>
	<span class="n">fbd_error_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ENABLE_EMASK_ALL</span><span class="p">);</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">branchmap_werrors</span><span class="p">,</span> <span class="n">EMASK_FBD</span><span class="p">,</span>
			<span class="n">fbd_error_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_probe1	Probe for ONE instance of device to see if it is</span>
<span class="cm"> *			present.</span>
<span class="cm"> *	return:</span>
<span class="cm"> *		0 for FOUND a device</span>
<span class="cm"> *		&lt; 0 for error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5400_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i5400_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edac_mc_layer</span> <span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_idx</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i5400_devs</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: %s: %s(), pdev bus %u dev=0x%x fn=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="cm">/* We only are looking for func 0 of the set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate a new MC control structure</span>
<span class="cm">	 *</span>
<span class="cm">	 * This drivers uses the DIMM slot as &quot;csrow&quot; and the rest as &quot;channel&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_BRANCH</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">MAX_BRANCHES</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_CHANNEL</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">CHANNELS_PER_BRANCH</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_SLOT</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">DIMMS_PER_CHANNEL</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="n">layers</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pvt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: %s: %s(): mci = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mci</span><span class="p">);</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>	<span class="cm">/* record ptr  to the generic device */</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">system_address</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>	<span class="cm">/* Record this device in our private */</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxch</span> <span class="o">=</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">maxdimmperch</span> <span class="o">=</span> <span class="n">DIMMS_PER_CHANNEL</span><span class="p">;</span>

	<span class="cm">/* &#39;get&#39; the pci devices we want to reserve for our use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i5400_get_devices</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">dev_idx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="cm">/* Time to get serious */</span>
	<span class="n">i5400_get_mc_regs</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>	<span class="cm">/* retrieve the hardware registers */</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mc_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mtype_cap</span> <span class="o">=</span> <span class="n">MEM_FLAG_FB_DDR2</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_ctl_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_name</span> <span class="o">=</span> <span class="s">&quot;i5400_edac.c&quot;</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_ver</span> <span class="o">=</span> <span class="n">I5400_REVISION</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span> <span class="o">=</span> <span class="n">i5400_devs</span><span class="p">[</span><span class="n">dev_idx</span><span class="p">].</span><span class="n">ctl_name</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_page_to_phys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Set the function pointer to an actual operation function */</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_check</span> <span class="o">=</span> <span class="n">i5400_check_error</span><span class="p">;</span>

	<span class="cm">/* initialize the MC control structure &#39;dimms&#39; table</span>
<span class="cm">	 * with the mapping and control information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i5400_init_dimms</span><span class="p">(</span><span class="n">mci</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: Setting mci-&gt;edac_cap to EDAC_FLAG_NONE</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;    because i5400_init_dimms() returned nonzero &quot;</span>
			<span class="s">&quot;value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span><span class="p">;</span>	<span class="cm">/* no dimms found */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;MC: Enable error reporting now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i5400_enable_error_reporting</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* add this new MC control structure to EDAC&#39;s list of MCs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edac_mc_add_mc</span><span class="p">(</span><span class="n">mci</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: %s: %s(): failed edac_mc_add_mc()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* FIXME: perhaps some code should go here that disables error</span>
<span class="cm">		 * reporting if we just enabled it</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i5400_clear_error</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="cm">/* allocating generic PCI control info */</span>
	<span class="n">i5400_pci</span> <span class="o">=</span> <span class="n">edac_pci_create_generic_ctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EDAC_MOD_STR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i5400_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s(): Unable to create PCI control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s(): PCI error report via EDAC not setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Error exit unwinding stack */</span>
<span class="nl">fail1:</span>

	<span class="n">i5400_put_devices</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

<span class="nl">fail0:</span>
	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_init_one	constructor for one instance of device</span>
<span class="cm"> *</span>
<span class="cm"> * 	returns:</span>
<span class="cm"> *		negative on error</span>
<span class="cm"> *		count (&gt;= 0)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">i5400_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: %s: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* wake up device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* now probe and enable the device */</span>
	<span class="k">return</span> <span class="n">i5400_probe1</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_remove_one	destructor for one instance of device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">i5400_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;%s: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i5400_pci</span><span class="p">)</span>
		<span class="n">edac_pci_release_generic_ctl</span><span class="p">(</span><span class="n">i5400_pci</span><span class="p">);</span>

	<span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_del_mc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mci</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* retrieve references to resources, and free those resources */</span>
	<span class="n">i5400_put_devices</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	pci_device_id	table for which devices we are looking for</span>
<span class="cm"> *</span>
<span class="cm"> *	The &quot;E500P&quot; device is the first device supported.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">i5400_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_5400_ERR</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>			<span class="cm">/* 0 terminated list. */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">i5400_pci_tbl</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_driver	pci_driver structure for this module</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">i5400_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i5400_edac&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">i5400_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">i5400_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">i5400_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_init		Module entry function</span>
<span class="cm"> *			Try to initialize this module for its devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i5400_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pci_rc</span><span class="p">;</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MC: %s: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Ensure that the OPSTATE is set correctly for POLL or NMI */</span>
	<span class="n">opstate_init</span><span class="p">();</span>

	<span class="n">pci_rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i5400_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pci_rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">pci_rc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i5400_exit()	Module exit function</span>
<span class="cm"> *			Unregister the driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">i5400_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MC: %s: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i5400_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">i5400_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">i5400_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Woodard &lt;woodard@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Red Hat Inc. (http://www.redhat.com)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MC Driver for Intel I5400 memory controllers - &quot;</span>
		   <span class="n">I5400_REVISION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">edac_op_state</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">edac_op_state</span><span class="p">,</span> <span class="s">&quot;EDAC Error Reporting state: 0=Poll,1=NMI&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
