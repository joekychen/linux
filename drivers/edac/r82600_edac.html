<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › edac › r82600_edac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>r82600_edac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Radisys 82600 Embedded chipset Memory Controller kernel module</span>
<span class="cm"> * (C) 2005 EADS Astrium</span>
<span class="cm"> * This file may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Tim Small &lt;tim@buttersideup.com&gt;, based on work by Thayne</span>
<span class="cm"> * Harbaugh, Dan Hollis &lt;goemon at anime dot net&gt; and others.</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: edac_r82600.c,v 1.1.2.6 2005/10/05 00:43:44 dsp_llnl Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Written with reference to 82600 High Integration Dual PCI System</span>
<span class="cm"> * Controller Data Book:</span>
<span class="cm"> * www.radisys.com/files/support_downloads/007-01277-0002.82600DataBook.pdf</span>
<span class="cm"> * references to this document given in []</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/edac.h&gt;</span>
<span class="cp">#include &quot;edac_core.h&quot;</span>

<span class="cp">#define R82600_REVISION	&quot; Ver: 2.0.2&quot;</span>
<span class="cp">#define EDAC_MOD_STR	&quot;r82600_edac&quot;</span>

<span class="cp">#define r82600_printk(level, fmt, arg...) \</span>
<span class="cp">	edac_printk(level, &quot;r82600&quot;, fmt, ##arg)</span>

<span class="cp">#define r82600_mc_printk(mci, level, fmt, arg...) \</span>
<span class="cp">	edac_mc_chipset_printk(mci, level, &quot;r82600&quot;, fmt, ##arg)</span>

<span class="cm">/* Radisys say &quot;The 82600 integrates a main memory SDRAM controller that</span>
<span class="cm"> * supports up to four banks of memory. The four banks can support a mix of</span>
<span class="cm"> * sizes of 64 bit wide (72 bits with ECC) Synchronous DRAM (SDRAM) DIMMs,</span>
<span class="cm"> * each of which can be any size from 16MB to 512MB. Both registered (control</span>
<span class="cm"> * signals buffered) and unbuffered DIMM types are supported. Mixing of</span>
<span class="cm"> * registered and unbuffered DIMMs as well as mixing of ECC and non-ECC DIMMs</span>
<span class="cm"> * is not allowed. The 82600 SDRAM interface operates at the same frequency as</span>
<span class="cm"> * the CPU bus, 66MHz, 100MHz or 133MHz.&quot;</span>
<span class="cm"> */</span>

<span class="cp">#define R82600_NR_CSROWS 4</span>
<span class="cp">#define R82600_NR_CHANS  1</span>
<span class="cp">#define R82600_NR_DIMMS  4</span>

<span class="cp">#define R82600_BRIDGE_ID  0x8200</span>

<span class="cm">/* Radisys 82600 register addresses - device 0 function 0 - PCI bridge */</span>
<span class="cp">#define R82600_DRAMC	0x57	</span><span class="cm">/* Various SDRAM related control bits</span>
<span class="cm">				 * all bits are R/W</span>
<span class="cm">				 *</span>
<span class="cm">				 * 7    SDRAM ISA Hole Enable</span>
<span class="cm">				 * 6    Flash Page Mode Enable</span>
<span class="cm">				 * 5    ECC Enable: 1=ECC 0=noECC</span>
<span class="cm">				 * 4    DRAM DIMM Type: 1=</span>
<span class="cm">				 * 3    BIOS Alias Disable</span>
<span class="cm">				 * 2    SDRAM BIOS Flash Write Enable</span>
<span class="cm">				 * 1:0  SDRAM Refresh Rate: 00=Disabled</span>
<span class="cm">				 *          01=7.8usec (256Mbit SDRAMs)</span>
<span class="cm">				 *          10=15.6us 11=125usec</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="cp">#define R82600_SDRAMC	0x76	</span><span class="cm">/* &quot;SDRAM Control Register&quot;</span>
<span class="cm">				 * More SDRAM related control bits</span>
<span class="cm">				 * all bits are R/W</span>
<span class="cm">				 *</span>
<span class="cm">				 * 15:8 Reserved.</span>
<span class="cm">				 *</span>
<span class="cm">				 * 7:5  Special SDRAM Mode Select</span>
<span class="cm">				 *</span>
<span class="cm">				 * 4    Force ECC</span>
<span class="cm">				 *</span>
<span class="cm">				 *        1=Drive ECC bits to 0 during</span>
<span class="cm">				 *          write cycles (i.e. ECC test mode)</span>
<span class="cm">				 *</span>
<span class="cm">				 *        0=Normal ECC functioning</span>
<span class="cm">				 *</span>
<span class="cm">				 * 3    Enhanced Paging Enable</span>
<span class="cm">				 *</span>
<span class="cm">				 * 2    CAS# Latency 0=3clks 1=2clks</span>
<span class="cm">				 *</span>
<span class="cm">				 * 1    RAS# to CAS# Delay 0=3 1=2</span>
<span class="cm">				 *</span>
<span class="cm">				 * 0    RAS# Precharge     0=3 1=2</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="cp">#define R82600_EAP	0x80	</span><span class="cm">/* ECC Error Address Pointer Register</span>
<span class="cm">				 *</span>
<span class="cm">				 * 31    Disable Hardware Scrubbing (RW)</span>
<span class="cm">				 *        0=Scrub on corrected read</span>
<span class="cm">				 *        1=Don&#39;t scrub on corrected read</span>
<span class="cm">				 *</span>
<span class="cm">				 * 30:12 Error Address Pointer (RO)</span>
<span class="cm">				 *        Upper 19 bits of error address</span>
<span class="cm">				 *</span>
<span class="cm">				 * 11:4  Syndrome Bits (RO)</span>
<span class="cm">				 *</span>
<span class="cm">				 * 3     BSERR# on multibit error (RW)</span>
<span class="cm">				 *        1=enable 0=disable</span>
<span class="cm">				 *</span>
<span class="cm">				 * 2     NMI on Single Bit Eror (RW)</span>
<span class="cm">				 *        1=NMI triggered by SBE n.b. other</span>
<span class="cm">				 *          prerequeists</span>
<span class="cm">				 *        0=NMI not triggered</span>
<span class="cm">				 *</span>
<span class="cm">				 * 1     MBE (R/WC)</span>
<span class="cm">				 *        read 1=MBE at EAP (see above)</span>
<span class="cm">				 *        read 0=no MBE, or SBE occurred first</span>
<span class="cm">				 *        write 1=Clear MBE status (must also</span>
<span class="cm">				 *          clear SBE)</span>
<span class="cm">				 *        write 0=NOP</span>
<span class="cm">				 *</span>
<span class="cm">				 * 1     SBE (R/WC)</span>
<span class="cm">				 *        read 1=SBE at EAP (see above)</span>
<span class="cm">				 *        read 0=no SBE, or MBE occurred first</span>
<span class="cm">				 *        write 1=Clear SBE status (must also</span>
<span class="cm">				 *          clear MBE)</span>
<span class="cm">				 *        write 0=NOP</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="cp">#define R82600_DRBA	0x60	</span><span class="cm">/* + 0x60..0x63 SDRAM Row Boundary Address</span>
<span class="cm">				 *  Registers</span>
<span class="cm">				 *</span>
<span class="cm">				 * 7:0  Address lines 30:24 - upper limit of</span>
<span class="cm">				 * each row [p57]</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">r82600_error_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">eapr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">disable_hardware_scrub</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edac_pci_ctl_info</span> <span class="o">*</span><span class="n">r82600_pci</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r82600_get_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">r82600_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_EAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="cm">/* Clear error to allow next error to be reported [p.62] */</span>
		<span class="n">pci_write_bits32</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_EAP</span><span class="p">,</span>
				 <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
				 <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="cm">/* Clear error to allow next error to be reported [p.62] */</span>
		<span class="n">pci_write_bits32</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_EAP</span><span class="p">,</span>
				 <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
				 <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r82600_process_error_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">r82600_error_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">handle_errors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error_found</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eapaddr</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">syndrome</span><span class="p">;</span>

	<span class="n">error_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* bits 30:12 store the upper 19 bits of the 32 bit error address */</span>
	<span class="n">eapaddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
	<span class="cm">/* Syndrome in bits 11:4 [p.62]       */</span>
	<span class="n">syndrome</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="cm">/* the R82600 reports at less than page *</span>
<span class="cm">	 * granularity (upper 19 bits only)     */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">eapaddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* CE? */</span>
		<span class="n">error_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">handle_errors</span><span class="p">)</span>
			<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">HW_EVENT_ERR_CORRECTED</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span>
					     <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syndrome</span><span class="p">,</span>
					     <span class="n">edac_mc_find_csrow_by_page</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					     <span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">eapr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* UE? */</span>
		<span class="n">error_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">handle_errors</span><span class="p">)</span>
			<span class="cm">/* 82600 doesn&#39;t give enough info */</span>
			<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">HW_EVENT_ERR_UNCORRECTED</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span>
					     <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">edac_mc_find_csrow_by_page</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					     <span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error_found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r82600_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r82600_error_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;MC%d: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">mc_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">r82600_get_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">r82600_process_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ecc_enabled</span><span class="p">(</span><span class="n">u8</span> <span class="n">dramcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dramcr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r82600_init_csrows</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">dramcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">csrow_info</span> <span class="o">*</span><span class="n">csrow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dimm_info</span> <span class="o">*</span><span class="n">dimm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drbar</span><span class="p">;</span>		<span class="cm">/* SDRAM Row Boundary Address Register */</span>
	<span class="n">u32</span> <span class="n">row_high_limit</span><span class="p">,</span> <span class="n">row_high_limit_last</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_sdram</span><span class="p">,</span> <span class="n">ecc_on</span><span class="p">,</span> <span class="n">row_base</span><span class="p">;</span>

	<span class="n">ecc_on</span> <span class="o">=</span> <span class="n">ecc_enabled</span><span class="p">(</span><span class="n">dramcr</span><span class="p">);</span>
	<span class="n">reg_sdram</span> <span class="o">=</span> <span class="n">dramcr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">row_high_limit_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">nr_csrows</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csrow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">csrows</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">dimm</span> <span class="o">=</span> <span class="n">csrow</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dimm</span><span class="p">;</span>

		<span class="cm">/* find the DRAM Chip Select Base address and mask */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_DRBA</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbar</span><span class="p">);</span>

		<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;%s() Row=%d DRBA = %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">drbar</span><span class="p">);</span>

		<span class="n">row_high_limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">drbar</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
<span class="cm">/*		row_high_limit = ((u32)drbar &lt;&lt; 24) | 0xffffffUL; */</span>

		<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;%s() Row=%d, Boundary Address=%#0x, Last = %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row_high_limit</span><span class="p">,</span> <span class="n">row_high_limit_last</span><span class="p">);</span>

		<span class="cm">/* Empty row [p.57] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">row_high_limit</span> <span class="o">==</span> <span class="n">row_high_limit_last</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">row_base</span> <span class="o">=</span> <span class="n">row_high_limit_last</span><span class="p">;</span>

		<span class="n">csrow</span><span class="o">-&gt;</span><span class="n">first_page</span> <span class="o">=</span> <span class="n">row_base</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">csrow</span><span class="o">-&gt;</span><span class="n">last_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">row_high_limit</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">csrow</span><span class="o">-&gt;</span><span class="n">last_page</span> <span class="o">-</span> <span class="n">csrow</span><span class="o">-&gt;</span><span class="n">first_page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Error address is top 19 bits - so granularity is      *</span>
<span class="cm">		 * 14 bits                                               */</span>
		<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">grain</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">mtype</span> <span class="o">=</span> <span class="n">reg_sdram</span> <span class="o">?</span> <span class="n">MEM_RDDR</span> <span class="o">:</span> <span class="n">MEM_DDR</span><span class="p">;</span>
		<span class="cm">/* FIXME - check that this is unknowable with this chipset */</span>
		<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">DEV_UNKNOWN</span><span class="p">;</span>

		<span class="cm">/* Mode is global on 82600 */</span>
		<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">edac_mode</span> <span class="o">=</span> <span class="n">ecc_on</span> <span class="o">?</span> <span class="n">EDAC_SECDED</span> <span class="o">:</span> <span class="n">EDAC_NONE</span><span class="p">;</span>
		<span class="n">row_high_limit_last</span> <span class="o">=</span> <span class="n">row_high_limit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r82600_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edac_mc_layer</span> <span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">dramcr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eapr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scrub_disabled</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sdram_refresh_rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r82600_error_info</span> <span class="n">discard</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_DRAMC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dramcr</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_EAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eapr</span><span class="p">);</span>
	<span class="n">scrub_disabled</span> <span class="o">=</span> <span class="n">eapr</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
	<span class="n">sdram_refresh_rate</span> <span class="o">=</span> <span class="n">dramcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s(): sdram refresh rate = %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">sdram_refresh_rate</span><span class="p">);</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;%s(): DRAMC register = %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dramcr</span><span class="p">);</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_CHIP_SELECT</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">R82600_NR_CSROWS</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_CHANNEL</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">R82600_NR_CHANS</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="n">layers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;%s(): mci = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mci</span><span class="p">);</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mtype_cap</span> <span class="o">=</span> <span class="n">MEM_FLAG_RDDR</span> <span class="o">|</span> <span class="n">MEM_FLAG_DDR</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_ctl_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span> <span class="o">|</span> <span class="n">EDAC_FLAG_EC</span> <span class="o">|</span> <span class="n">EDAC_FLAG_SECDED</span><span class="p">;</span>
	<span class="cm">/* FIXME try to work out if the chip leads have been used for COM2</span>
<span class="cm">	 * instead on this board? [MA6?] MAYBE:</span>
<span class="cm">	 */</span>

	<span class="cm">/* On the R82600, the pins for memory bits 72:65 - i.e. the   *</span>
<span class="cm">	 * EC bits are shared with the pins for COM2 (!), so if COM2  *</span>
<span class="cm">	 * is enabled, we assume COM2 is wired up, and thus no EDAC   *</span>
<span class="cm">	 * is possible.                                               */</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span> <span class="o">|</span> <span class="n">EDAC_FLAG_EC</span> <span class="o">|</span> <span class="n">EDAC_FLAG_SECDED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecc_enabled</span><span class="p">(</span><span class="n">dramcr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scrub_disabled</span><span class="p">)</span>
			<span class="n">debugf3</span><span class="p">(</span><span class="s">&quot;%s(): mci = %p - Scrubbing disabled! EAP: &quot;</span>
				<span class="s">&quot;%#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span> <span class="n">eapr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span><span class="p">;</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_name</span> <span class="o">=</span> <span class="n">EDAC_MOD_STR</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_ver</span> <span class="o">=</span> <span class="n">R82600_REVISION</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span> <span class="o">=</span> <span class="s">&quot;R82600&quot;</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_check</span> <span class="o">=</span> <span class="n">r82600_check</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_page_to_phys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">r82600_init_csrows</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">dramcr</span><span class="p">);</span>
	<span class="n">r82600_get_error_info</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard</span><span class="p">);</span>	<span class="cm">/* clear counters */</span>

	<span class="cm">/* Here we assume that we will never see multiple instances of this</span>
<span class="cm">	 * type of memory controller.  The ID is therefore hardcoded to 0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edac_mc_add_mc</span><span class="p">(</span><span class="n">mci</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugf3</span><span class="p">(</span><span class="s">&quot;%s(): failed edac_mc_add_mc()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get this far and it&#39;s successful */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_hardware_scrub</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugf3</span><span class="p">(</span><span class="s">&quot;%s(): Disabling Hardware Scrub (scrub on error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">pci_write_bits32</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">R82600_EAP</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* allocating generic PCI control info */</span>
	<span class="n">r82600_pci</span> <span class="o">=</span> <span class="n">edac_pci_create_generic_ctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EDAC_MOD_STR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r82600_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s(): Unable to create PCI control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s(): PCI error report via EDAC not setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">debugf3</span><span class="p">(</span><span class="s">&quot;%s(): success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns count (&gt;= 0), or negative on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">r82600_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* don&#39;t need to call pci_enable_device() */</span>
	<span class="k">return</span> <span class="n">r82600_probe1</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">r82600_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r82600_pci</span><span class="p">)</span>
		<span class="n">edac_pci_release_generic_ctl</span><span class="p">(</span><span class="n">r82600_pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_del_mc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">r82600_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_RADISYS</span><span class="p">,</span> <span class="n">R82600_BRIDGE_ID</span><span class="p">)</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="mi">0</span><span class="p">,</span>
	 <span class="p">}</span>			<span class="cm">/* 0 terminated list. */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">r82600_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">r82600_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">EDAC_MOD_STR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">r82600_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">r82600_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">r82600_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">r82600_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
       <span class="cm">/* Ensure that the OPSTATE is set correctly for POLL or NMI */</span>
       <span class="n">opstate_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r82600_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">r82600_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r82600_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">r82600_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">r82600_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Tim Small &lt;tim@buttersideup.com&gt; - WPAD Ltd. &quot;</span>
		<span class="s">&quot;on behalf of EADS Astrium&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MC support for Radisys 82600 memory controllers&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">disable_hardware_scrub</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_hardware_scrub</span><span class="p">,</span>
		 <span class="s">&quot;If set, disable the chipset&#39;s automatic scrub for CEs&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">edac_op_state</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">edac_op_state</span><span class="p">,</span> <span class="s">&quot;EDAC Error Reporting state: 0=Poll,1=NMI&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
