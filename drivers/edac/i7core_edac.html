<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › edac › i7core_edac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>i7core_edac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Intel i7 core/Nehalem Memory Controller kernel module</span>
<span class="cm"> *</span>
<span class="cm"> * This driver supports the memory controllers found on the Intel</span>
<span class="cm"> * processor families i7core, i7core 7xx/8xx, i5core, Xeon 35xx,</span>
<span class="cm"> * Xeon 55xx and Xeon 56xx also known as Nehalem, Nehalem-EP, Lynnfield</span>
<span class="cm"> * and Westmere-EP.</span>
<span class="cm"> *</span>
<span class="cm"> * This file may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License version 2 only.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009-2010 by:</span>
<span class="cm"> *	 Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Red Hat Inc. http://www.redhat.com</span>
<span class="cm"> *</span>
<span class="cm"> * Forked and adapted from the i5400_edac driver</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the following public Intel datasheets:</span>
<span class="cm"> * Intel Core i7 Processor Extreme Edition and Intel Core i7 Processor</span>
<span class="cm"> * Datasheet, Volume 2:</span>
<span class="cm"> *	http://download.intel.com/design/processor/datashts/320835.pdf</span>
<span class="cm"> * Intel Xeon Processor 5500 Series Datasheet Volume 2</span>
<span class="cm"> *	http://www.intel.com/Assets/PDF/datasheet/321322.pdf</span>
<span class="cm"> * also available at:</span>
<span class="cm"> * 	http://www.arrownac.com/manufacturers/intel/s/nehalem/5500-datasheet-v2.pdf</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/edac.h&gt;</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;asm/mce.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &quot;edac_core.h&quot;</span>

<span class="cm">/* Static vars */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">i7core_edac_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">i7core_edac_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">probed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_pci_fixup</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_pci_fixup</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_pci_fixup</span><span class="p">,</span> <span class="s">&quot;Enable PCI fixup to seek for hidden devices&quot;</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * This is used for Nehalem-EP and Nehalem-EX devices, where the non-core</span>
<span class="cm"> * registers start at bus 255, and are not reported by BIOS.</span>
<span class="cm"> * We currently find devices with only 2 sockets. In order to support more QPI</span>
<span class="cm"> * Quick Path Interconnect, just increment this number.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_SOCKET_BUSES	2</span>


<span class="cm">/*</span>
<span class="cm"> * Alter this version for the module when modifications are made</span>
<span class="cm"> */</span>
<span class="cp">#define I7CORE_REVISION    &quot; Ver: 1.0.0&quot;</span>
<span class="cp">#define EDAC_MOD_STR      &quot;i7core_edac&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Debug macros</span>
<span class="cm"> */</span>
<span class="cp">#define i7core_printk(level, fmt, arg...)			\</span>
<span class="cp">	edac_printk(level, &quot;i7core&quot;, fmt, ##arg)</span>

<span class="cp">#define i7core_mc_printk(mci, level, fmt, arg...)		\</span>
<span class="cp">	edac_mc_chipset_printk(mci, level, &quot;i7core&quot;, fmt, ##arg)</span>

<span class="cm">/*</span>
<span class="cm"> * i7core Memory Controller Registers</span>
<span class="cm"> */</span>

	<span class="cm">/* OFFSETS for Device 0 Function 0 */</span>

<span class="cp">#define MC_CFG_CONTROL	0x90</span>
  <span class="cp">#define MC_CFG_UNLOCK		0x02</span>
  <span class="cp">#define MC_CFG_LOCK		0x00</span>

	<span class="cm">/* OFFSETS for Device 3 Function 0 */</span>

<span class="cp">#define MC_CONTROL	0x48</span>
<span class="cp">#define MC_STATUS	0x4c</span>
<span class="cp">#define MC_MAX_DOD	0x64</span>

<span class="cm">/*</span>
<span class="cm"> * OFFSETS for Device 3 Function 4, as indicated on Xeon 5500 datasheet:</span>
<span class="cm"> * http://www.arrownac.com/manufacturers/intel/s/nehalem/5500-datasheet-v2.pdf</span>
<span class="cm"> */</span>

<span class="cp">#define MC_TEST_ERR_RCV1	0x60</span>
  <span class="cp">#define DIMM2_COR_ERR(r)			((r) &amp; 0x7fff)</span>

<span class="cp">#define MC_TEST_ERR_RCV0	0x64</span>
  <span class="cp">#define DIMM1_COR_ERR(r)			(((r) &gt;&gt; 16) &amp; 0x7fff)</span>
  <span class="cp">#define DIMM0_COR_ERR(r)			((r) &amp; 0x7fff)</span>

<span class="cm">/* OFFSETS for Device 3 Function 2, as indicated on Xeon 5500 datasheet */</span>
<span class="cp">#define MC_SSRCONTROL		0x48</span>
  <span class="cp">#define SSR_MODE_DISABLE	0x00</span>
  <span class="cp">#define SSR_MODE_ENABLE	0x01</span>
  <span class="cp">#define SSR_MODE_MASK		0x03</span>

<span class="cp">#define MC_SCRUB_CONTROL	0x4c</span>
  <span class="cp">#define STARTSCRUB		(1 &lt;&lt; 24)</span>
  <span class="cp">#define SCRUBINTERVAL_MASK    0xffffff</span>

<span class="cp">#define MC_COR_ECC_CNT_0	0x80</span>
<span class="cp">#define MC_COR_ECC_CNT_1	0x84</span>
<span class="cp">#define MC_COR_ECC_CNT_2	0x88</span>
<span class="cp">#define MC_COR_ECC_CNT_3	0x8c</span>
<span class="cp">#define MC_COR_ECC_CNT_4	0x90</span>
<span class="cp">#define MC_COR_ECC_CNT_5	0x94</span>

<span class="cp">#define DIMM_TOP_COR_ERR(r)			(((r) &gt;&gt; 16) &amp; 0x7fff)</span>
<span class="cp">#define DIMM_BOT_COR_ERR(r)			((r) &amp; 0x7fff)</span>


	<span class="cm">/* OFFSETS for Devices 4,5 and 6 Function 0 */</span>

<span class="cp">#define MC_CHANNEL_DIMM_INIT_PARAMS 0x58</span>
  <span class="cp">#define THREE_DIMMS_PRESENT		(1 &lt;&lt; 24)</span>
  <span class="cp">#define SINGLE_QUAD_RANK_PRESENT	(1 &lt;&lt; 23)</span>
  <span class="cp">#define QUAD_RANK_PRESENT		(1 &lt;&lt; 22)</span>
  <span class="cp">#define REGISTERED_DIMM		(1 &lt;&lt; 15)</span>

<span class="cp">#define MC_CHANNEL_MAPPER	0x60</span>
  <span class="cp">#define RDLCH(r, ch)		((((r) &gt;&gt; (3 + (ch * 6))) &amp; 0x07) - 1)</span>
  <span class="cp">#define WRLCH(r, ch)		((((r) &gt;&gt; (ch * 6)) &amp; 0x07) - 1)</span>

<span class="cp">#define MC_CHANNEL_RANK_PRESENT 0x7c</span>
  <span class="cp">#define RANK_PRESENT_MASK		0xffff</span>

<span class="cp">#define MC_CHANNEL_ADDR_MATCH	0xf0</span>
<span class="cp">#define MC_CHANNEL_ERROR_MASK	0xf8</span>
<span class="cp">#define MC_CHANNEL_ERROR_INJECT	0xfc</span>
  <span class="cp">#define INJECT_ADDR_PARITY	0x10</span>
  <span class="cp">#define INJECT_ECC		0x08</span>
  <span class="cp">#define MASK_CACHELINE	0x06</span>
  <span class="cp">#define MASK_FULL_CACHELINE	0x06</span>
  <span class="cp">#define MASK_MSB32_CACHELINE	0x04</span>
  <span class="cp">#define MASK_LSB32_CACHELINE	0x02</span>
  <span class="cp">#define NO_MASK_CACHELINE	0x00</span>
  <span class="cp">#define REPEAT_EN		0x01</span>

	<span class="cm">/* OFFSETS for Devices 4,5 and 6 Function 1 */</span>

<span class="cp">#define MC_DOD_CH_DIMM0		0x48</span>
<span class="cp">#define MC_DOD_CH_DIMM1		0x4c</span>
<span class="cp">#define MC_DOD_CH_DIMM2		0x50</span>
  <span class="cp">#define RANKOFFSET_MASK	((1 &lt;&lt; 12) | (1 &lt;&lt; 11) | (1 &lt;&lt; 10))</span>
  <span class="cp">#define RANKOFFSET(x)		((x &amp; RANKOFFSET_MASK) &gt;&gt; 10)</span>
  <span class="cp">#define DIMM_PRESENT_MASK	(1 &lt;&lt; 9)</span>
  <span class="cp">#define DIMM_PRESENT(x)	(((x) &amp; DIMM_PRESENT_MASK) &gt;&gt; 9)</span>
  <span class="cp">#define MC_DOD_NUMBANK_MASK		((1 &lt;&lt; 8) | (1 &lt;&lt; 7))</span>
  <span class="cp">#define MC_DOD_NUMBANK(x)		(((x) &amp; MC_DOD_NUMBANK_MASK) &gt;&gt; 7)</span>
  <span class="cp">#define MC_DOD_NUMRANK_MASK		((1 &lt;&lt; 6) | (1 &lt;&lt; 5))</span>
  <span class="cp">#define MC_DOD_NUMRANK(x)		(((x) &amp; MC_DOD_NUMRANK_MASK) &gt;&gt; 5)</span>
  <span class="cp">#define MC_DOD_NUMROW_MASK		((1 &lt;&lt; 4) | (1 &lt;&lt; 3) | (1 &lt;&lt; 2))</span>
  <span class="cp">#define MC_DOD_NUMROW(x)		(((x) &amp; MC_DOD_NUMROW_MASK) &gt;&gt; 2)</span>
  <span class="cp">#define MC_DOD_NUMCOL_MASK		3</span>
  <span class="cp">#define MC_DOD_NUMCOL(x)		((x) &amp; MC_DOD_NUMCOL_MASK)</span>

<span class="cp">#define MC_RANK_PRESENT		0x7c</span>

<span class="cp">#define MC_SAG_CH_0	0x80</span>
<span class="cp">#define MC_SAG_CH_1	0x84</span>
<span class="cp">#define MC_SAG_CH_2	0x88</span>
<span class="cp">#define MC_SAG_CH_3	0x8c</span>
<span class="cp">#define MC_SAG_CH_4	0x90</span>
<span class="cp">#define MC_SAG_CH_5	0x94</span>
<span class="cp">#define MC_SAG_CH_6	0x98</span>
<span class="cp">#define MC_SAG_CH_7	0x9c</span>

<span class="cp">#define MC_RIR_LIMIT_CH_0	0x40</span>
<span class="cp">#define MC_RIR_LIMIT_CH_1	0x44</span>
<span class="cp">#define MC_RIR_LIMIT_CH_2	0x48</span>
<span class="cp">#define MC_RIR_LIMIT_CH_3	0x4C</span>
<span class="cp">#define MC_RIR_LIMIT_CH_4	0x50</span>
<span class="cp">#define MC_RIR_LIMIT_CH_5	0x54</span>
<span class="cp">#define MC_RIR_LIMIT_CH_6	0x58</span>
<span class="cp">#define MC_RIR_LIMIT_CH_7	0x5C</span>
<span class="cp">#define MC_RIR_LIMIT_MASK	((1 &lt;&lt; 10) - 1)</span>

<span class="cp">#define MC_RIR_WAY_CH		0x80</span>
  <span class="cp">#define MC_RIR_WAY_OFFSET_MASK	(((1 &lt;&lt; 14) - 1) &amp; ~0x7)</span>
  <span class="cp">#define MC_RIR_WAY_RANK_MASK		0x7</span>

<span class="cm">/*</span>
<span class="cm"> * i7core structs</span>
<span class="cm"> */</span>

<span class="cp">#define NUM_CHANS 3</span>
<span class="cp">#define MAX_DIMMS 3		</span><span class="cm">/* Max DIMMS per channel */</span><span class="cp"></span>
<span class="cp">#define MAX_MCR_FUNC  4</span>
<span class="cp">#define MAX_CHAN_FUNC 3</span>

<span class="k">struct</span> <span class="n">i7core_info</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">mc_control</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">mc_status</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">max_dod</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ch_map</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">i7core_inject</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">enable</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">section</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">eccmask</span><span class="p">;</span>

	<span class="cm">/* Error address mask */</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dimm</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i7core_channel</span> <span class="p">{</span>
	<span class="n">bool</span>		<span class="n">is_3dimms_present</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">is_single_4rank</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">has_4rank</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">dimms</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pci_id_descr</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">optional</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pci_id_table</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_descr</span>	<span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">n_devs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">socket</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">**</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">n_devs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span>	<span class="o">*</span><span class="n">mci</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pci_noncore</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pci_mcr</span><span class="p">[</span><span class="n">MAX_MCR_FUNC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">NUM_CHANS</span><span class="p">][</span><span class="n">MAX_CHAN_FUNC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i7core_info</span>	<span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_inject</span>	<span class="n">inject</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_channel</span>	<span class="n">channel</span><span class="p">[</span><span class="n">NUM_CHANS</span><span class="p">];</span>

	<span class="kt">int</span>		<span class="n">ce_count_available</span><span class="p">;</span>

			<span class="cm">/* ECC corrected errors counts per udimm */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">udimm_ce_count</span><span class="p">[</span><span class="n">MAX_DIMMS</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="n">MAX_DIMMS</span><span class="p">];</span>
			<span class="cm">/* ECC corrected errors counts per rdimm */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">rdimm_ce_count</span><span class="p">[</span><span class="n">NUM_CHANS</span><span class="p">][</span><span class="n">MAX_DIMMS</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">NUM_CHANS</span><span class="p">][</span><span class="n">MAX_DIMMS</span><span class="p">];</span>

	<span class="n">bool</span>		<span class="n">is_registered</span><span class="p">,</span> <span class="n">enable_scrub</span><span class="p">;</span>

	<span class="cm">/* Fifo double buffers */</span>
	<span class="k">struct</span> <span class="n">mce</span>		<span class="n">mce_entry</span><span class="p">[</span><span class="n">MCE_LOG_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mce</span>		<span class="n">mce_outentry</span><span class="p">[</span><span class="n">MCE_LOG_LEN</span><span class="p">];</span>

	<span class="cm">/* Fifo in/out counters */</span>
	<span class="kt">unsigned</span>		<span class="n">mce_in</span><span class="p">,</span> <span class="n">mce_out</span><span class="p">;</span>

	<span class="cm">/* Count indicator to show errors not got */</span>
	<span class="kt">unsigned</span>		<span class="n">mce_overrun</span><span class="p">;</span>

	<span class="cm">/* DCLK Frequency used for computing scrub rate */</span>
	<span class="kt">int</span>			<span class="n">dclk_freq</span><span class="p">;</span>

	<span class="cm">/* Struct to control EDAC polling */</span>
	<span class="k">struct</span> <span class="n">edac_pci_ctl_info</span> <span class="o">*</span><span class="n">i7core_pci</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PCI_DESCR(device, function, device_id)	\</span>
<span class="cp">	.dev = (device),			\</span>
<span class="cp">	.func = (function),			\</span>
<span class="cp">	.dev_id = (device_id)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_descr</span> <span class="n">pci_dev_descr_i7core_nehalem</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Memory controller */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MCR</span><span class="p">)</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_TAD</span><span class="p">)</span>  <span class="p">},</span>
			<span class="cm">/* Exists only for RDIMM */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_RAS</span><span class="p">),</span> <span class="p">.</span><span class="n">optional</span> <span class="o">=</span> <span class="mi">1</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_TEST</span><span class="p">)</span> <span class="p">},</span>

		<span class="cm">/* Channel 0 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH0_CTRL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH0_ADDR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH0_RANK</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH0_TC</span><span class="p">)</span>   <span class="p">},</span>

		<span class="cm">/* Channel 1 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH1_CTRL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH1_ADDR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH1_RANK</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH1_TC</span><span class="p">)</span>   <span class="p">},</span>

		<span class="cm">/* Channel 2 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH2_CTRL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH2_ADDR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH2_RANK</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_MC_CH2_TC</span><span class="p">)</span>   <span class="p">},</span>

		<span class="cm">/* Generic Non-core registers */</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the PCI device on i7core and on Xeon 35xx (8086:2c41)</span>
<span class="cm">	 * On Xeon 55xx, however, it has a different id (8086:2c40). So,</span>
<span class="cm">	 * the probing code needs to test for the other address in case of</span>
<span class="cm">	 * failure of this one</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_NONCORE</span><span class="p">)</span>  <span class="p">},</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_descr</span> <span class="n">pci_dev_descr_lynnfield</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MCR</span><span class="p">)</span>         <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TAD</span><span class="p">)</span>      <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TEST</span><span class="p">)</span>     <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_CTRL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_ADDR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_RANK</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_TC</span><span class="p">)</span>   <span class="p">},</span>

	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_CTRL</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_ADDR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_RANK</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_TC</span><span class="p">)</span>   <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the PCI device has an alternate address on some</span>
<span class="cm">	 * processors like Core i7 860</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE</span><span class="p">)</span>     <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_descr</span> <span class="n">pci_dev_descr_i7core_westmere</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Memory controller */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MCR_REV2</span><span class="p">)</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TAD_REV2</span><span class="p">)</span>  <span class="p">},</span>
			<span class="cm">/* Exists only for RDIMM */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_RAS_REV2</span><span class="p">),</span> <span class="p">.</span><span class="n">optional</span> <span class="o">=</span> <span class="mi">1</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TEST_REV2</span><span class="p">)</span> <span class="p">},</span>

		<span class="cm">/* Channel 0 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_CTRL_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_ADDR_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_RANK_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_TC_REV2</span><span class="p">)</span>   <span class="p">},</span>

		<span class="cm">/* Channel 1 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_CTRL_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_ADDR_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_RANK_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_TC_REV2</span><span class="p">)</span>   <span class="p">},</span>

		<span class="cm">/* Channel 2 */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_CTRL_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_ADDR_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_RANK_REV2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_TC_REV2</span><span class="p">)</span>   <span class="p">},</span>

		<span class="cm">/* Generic Non-core registers */</span>
	<span class="p">{</span> <span class="n">PCI_DESCR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE_REV2</span><span class="p">)</span>  <span class="p">},</span>

<span class="p">};</span>

<span class="cp">#define PCI_ID_TABLE_ENTRY(A) { .descr=A, .n_devs = ARRAY_SIZE(A) }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_table</span> <span class="n">pci_dev_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI_ID_TABLE_ENTRY</span><span class="p">(</span><span class="n">pci_dev_descr_i7core_nehalem</span><span class="p">),</span>
	<span class="n">PCI_ID_TABLE_ENTRY</span><span class="p">(</span><span class="n">pci_dev_descr_lynnfield</span><span class="p">),</span>
	<span class="n">PCI_ID_TABLE_ENTRY</span><span class="p">(</span><span class="n">pci_dev_descr_i7core_westmere</span><span class="p">),</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>			<span class="cm">/* 0 terminated list. */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	pci_device_id	table for which devices we are looking for</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">i7core_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_X58_HUB_MGMT</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_QPI_LINK0</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>			<span class="cm">/* 0 terminated list. */</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			Ancillary status routines</span>
<span class="cm"> ****************************************************************************/</span>

	<span class="cm">/* MC_CONTROL bits */</span>
<span class="cp">#define CH_ACTIVE(pvt, ch)	((pvt)-&gt;info.mc_control &amp; (1 &lt;&lt; (8 + ch)))</span>
<span class="cp">#define ECCx8(pvt)		((pvt)-&gt;info.mc_control &amp; (1 &lt;&lt; 1))</span>

	<span class="cm">/* MC_STATUS bits */</span>
<span class="cp">#define ECC_ENABLED(pvt)	((pvt)-&gt;info.mc_status &amp; (1 &lt;&lt; 4))</span>
<span class="cp">#define CH_DISABLED(pvt, ch)	((pvt)-&gt;info.mc_status &amp; (1 &lt;&lt; ch))</span>

	<span class="cm">/* MC_MAX_DOD read functions */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">numdimms</span><span class="p">(</span><span class="n">u32</span> <span class="n">dimms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dimms</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">numrank</span><span class="p">(</span><span class="n">u32</span> <span class="n">rank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">ranks</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">};</span>

	<span class="k">return</span> <span class="n">ranks</span><span class="p">[</span><span class="n">rank</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">numbank</span><span class="p">(</span><span class="n">u32</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">banks</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">};</span>

	<span class="k">return</span> <span class="n">banks</span><span class="p">[</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">numrow</span><span class="p">(</span><span class="n">u32</span> <span class="n">row</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">rows</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">numcol</span><span class="p">(</span><span class="n">u32</span> <span class="n">col</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">cols</span><span class="p">[</span><span class="n">col</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="nf">get_i7core_dev</span><span class="p">(</span><span class="n">u8</span> <span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_edac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">==</span> <span class="n">socket</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i7core_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="nf">alloc_i7core_dev</span><span class="p">(</span><span class="n">u8</span> <span class="n">socket</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_table</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">;</span>

	<span class="n">i7core_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i7core_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i7core_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">*</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">n_devs</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">;</span>
	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">n_devs</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">n_devs</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_edac_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i7core_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_i7core_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			Memory check routines</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dimm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">edac_type</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mem_type</span> <span class="n">mtype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dimm_info</span> <span class="o">*</span><span class="n">dimm</span><span class="p">;</span>

	<span class="cm">/* Get data from the MC register, function 0 */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Device 3 function 0 reads */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mc_control</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mc_status</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_MAX_DOD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_CHANNEL_MAPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ch_map</span><span class="p">);</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;QPI %d control=0x%08x status=0x%08x dod=0x%08x map=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mc_control</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mc_status</span><span class="p">,</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ch_map</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ECC_ENABLED</span><span class="p">(</span><span class="n">pvt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;ECC enabled with x%d SDCC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ECCx8</span><span class="p">(</span><span class="n">pvt</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ECCx8</span><span class="p">(</span><span class="n">pvt</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">EDAC_S8ECD8ED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">EDAC_S4ECD4ED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;ECC disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">EDAC_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: need to handle the error codes */</span>
	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;DOD Max limits: DIMMS: %d, %d-ranked, %d-banked &quot;</span>
		<span class="s">&quot;x%x x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">numdimms</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span><span class="p">),</span>
		<span class="n">numrank</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">numbank</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
		<span class="n">numrow</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">),</span>
		<span class="n">numcol</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_dod</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CHANS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">dimm_dod</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CH_ACTIVE</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Channel %i is not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CH_DISABLED</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Channel %i is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Devices 4-6 function 0 */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">MC_CHANNEL_DIMM_INIT_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">THREE_DIMMS_PRESENT</span><span class="p">)</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_3dimms_present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SINGLE_QUAD_RANK_PRESENT</span><span class="p">)</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_single_4rank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">QUAD_RANK_PRESENT</span><span class="p">)</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">has_4rank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">REGISTERED_DIMM</span><span class="p">)</span>
			<span class="n">mtype</span> <span class="o">=</span> <span class="n">MEM_RDDR3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mtype</span> <span class="o">=</span> <span class="n">MEM_DDR3</span><span class="p">;</span>

		<span class="cm">/* Devices 4-6 function 1 */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">MC_DOD_CH_DIMM0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dimm_dod</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">MC_DOD_CH_DIMM1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dimm_dod</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">MC_DOD_CH_DIMM2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dimm_dod</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Ch%d phy rd%d, wr%d (0x%08x): &quot;</span>
			<span class="s">&quot;%s%s%s%cDIMMs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span>
			<span class="n">RDLCH</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ch_map</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">WRLCH</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ch_map</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="n">data</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_3dimms_present</span> <span class="o">?</span> <span class="s">&quot;3DIMMS &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_3dimms_present</span> <span class="o">?</span> <span class="s">&quot;SINGLE_4R &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">has_4rank</span> <span class="o">?</span> <span class="s">&quot;HAS_4R &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">REGISTERED_DIMM</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;U&#39;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">banks</span><span class="p">,</span> <span class="n">ranks</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">npages</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DIMM_PRESENT</span><span class="p">(</span><span class="n">dimm_dod</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">dimm</span> <span class="o">=</span> <span class="n">EDAC_DIMM_PTR</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">dimms</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">n_layers</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">banks</span> <span class="o">=</span> <span class="n">numbank</span><span class="p">(</span><span class="n">MC_DOD_NUMBANK</span><span class="p">(</span><span class="n">dimm_dod</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
			<span class="n">ranks</span> <span class="o">=</span> <span class="n">numrank</span><span class="p">(</span><span class="n">MC_DOD_NUMRANK</span><span class="p">(</span><span class="n">dimm_dod</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
			<span class="n">rows</span> <span class="o">=</span> <span class="n">numrow</span><span class="p">(</span><span class="n">MC_DOD_NUMROW</span><span class="p">(</span><span class="n">dimm_dod</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
			<span class="n">cols</span> <span class="o">=</span> <span class="n">numcol</span><span class="p">(</span><span class="n">MC_DOD_NUMCOL</span><span class="p">(</span><span class="n">dimm_dod</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>

			<span class="cm">/* DDR3 has 8 I/O banks */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">*</span> <span class="n">banks</span> <span class="o">*</span> <span class="n">ranks</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>

			<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">dimm %d %d Mb offset: %x, &quot;</span>
				<span class="s">&quot;bank: %d, rank: %d, row: %#x, col: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">j</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">RANKOFFSET</span><span class="p">(</span><span class="n">dimm_dod</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span>
				<span class="n">banks</span><span class="p">,</span> <span class="n">ranks</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">);</span>

			<span class="n">npages</span> <span class="o">=</span> <span class="n">MiB_TO_PAGES</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">npages</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">banks</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">DEV_X4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">DEV_X8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">DEV_X16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">DEV_UNKNOWN</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">snprintf</span><span class="p">(</span><span class="n">dimm</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dimm</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">),</span>
				 <span class="s">&quot;CPU#%uChannel#%u_DIMM#%u&quot;</span><span class="p">,</span>
				 <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">grain</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">edac_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">mtype</span> <span class="o">=</span> <span class="n">mtype</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SAG_CH_7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[%i] DIVBY3</span><span class="se">\t</span><span class="s">REMOVED</span><span class="se">\t</span><span class="s">OFFSET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%#x</span><span class="se">\t</span><span class="s">%#x</span><span class="se">\t</span><span class="s">%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span>
				<span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			Error insertion routines</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/* The i7core has independent error injection features per channel.</span>
<span class="cm">   However, to have a simpler code, we don&#39;t allow enabling error injection</span>
<span class="cm">   on more than one channel.</span>
<span class="cm">   Also, since a change at an inject parameter will be applied only at enable,</span>
<span class="cm">   we&#39;re disabling error injection on all write calls to the sysfs nodes that</span>
<span class="cm">   controls the error code injection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">disable_inject</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">MC_CHANNEL_ERROR_INJECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i7core inject inject.section</span>
<span class="cm"> *</span>
<span class="cm"> *	accept and store error injection inject.section value</span>
<span class="cm"> *	bit 0 - refers to the lower 32-byte half cacheline</span>
<span class="cm"> *	bit 1 - refers to the upper 32-byte half cacheline</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_section_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">disable_inject</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">section</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_section_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">section</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i7core inject.type</span>
<span class="cm"> *</span>
<span class="cm"> *	accept and store error injection inject.section value</span>
<span class="cm"> *	bit 0 - repeat enable - Enable error repetition</span>
<span class="cm"> *	bit 1 - inject ECC error</span>
<span class="cm"> *	bit 2 - inject parity error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_type_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">disable_inject</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i7core_inject_inject.eccmask_store</span>
<span class="cm"> *</span>
<span class="cm"> * The type of error (UE/CE) will depend on the inject.eccmask value:</span>
<span class="cm"> *   Any bits set to a 1 will flip the corresponding ECC bit</span>
<span class="cm"> *   Correctable errors can be injected by flipping 1 bit or the bits within</span>
<span class="cm"> *   a symbol pair (2 consecutive aligned 8-bit pairs - i.e. 7:0 and 15:8 or</span>
<span class="cm"> *   23:16 and 31:24). Flipping bits in two symbol pairs will cause an</span>
<span class="cm"> *   uncorrectable error to be injected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_eccmask_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">disable_inject</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">eccmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_eccmask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">eccmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i7core_addrmatch</span>
<span class="cm"> *</span>
<span class="cm"> * The type of error (UE/CE) will depend on the inject.eccmask value:</span>
<span class="cm"> *   Any bits set to a 1 will flip the corresponding ECC bit</span>
<span class="cm"> *   Correctable errors can be injected by flipping 1 bit or the bits within</span>
<span class="cm"> *   a symbol pair (2 consecutive aligned 8-bit pairs - i.e. 7:0 and 15:8 or</span>
<span class="cm"> *   23:16 and 31:24). Flipping bits in two symbol pairs will cause an</span>
<span class="cm"> *   uncorrectable error to be injected.</span>
<span class="cm"> */</span>

<span class="cp">#define DECLARE_ADDR_MATCH(param, limit)			\</span>
<span class="cp">static ssize_t i7core_inject_store_##param(			\</span>
<span class="cp">		struct mem_ctl_info *mci,			\</span>
<span class="cp">		const char *data, size_t count)			\</span>
<span class="cp">{								\</span>
<span class="cp">	struct i7core_pvt *pvt;					\</span>
<span class="cp">	long value;						\</span>
<span class="cp">	int rc;							\</span>
<span class="cp">								\</span>
<span class="cp">	debugf1(&quot;%s()\n&quot;, __func__);				\</span>
<span class="cp">	pvt = mci-&gt;pvt_info;					\</span>
<span class="cp">								\</span>
<span class="cp">	if (pvt-&gt;inject.enable)					\</span>
<span class="cp">		disable_inject(mci);				\</span>
<span class="cp">								\</span>
<span class="cp">	if (!strcasecmp(data, &quot;any&quot;) || !strcasecmp(data, &quot;any\n&quot;))\</span>
<span class="cp">		value = -1;					\</span>
<span class="cp">	else {							\</span>
<span class="cp">		rc = strict_strtoul(data, 10, &amp;value);		\</span>
<span class="cp">		if ((rc &lt; 0) || (value &gt;= limit))		\</span>
<span class="cp">			return -EIO;				\</span>
<span class="cp">	}							\</span>
<span class="cp">								\</span>
<span class="cp">	pvt-&gt;inject.param = value;				\</span>
<span class="cp">								\</span>
<span class="cp">	return count;						\</span>
<span class="cp">}								\</span>
<span class="cp">								\</span>
<span class="cp">static ssize_t i7core_inject_show_##param(			\</span>
<span class="cp">		struct mem_ctl_info *mci,			\</span>
<span class="cp">		char *data)					\</span>
<span class="cp">{								\</span>
<span class="cp">	struct i7core_pvt *pvt;					\</span>
<span class="cp">								\</span>
<span class="cp">	pvt = mci-&gt;pvt_info;					\</span>
<span class="cp">	debugf1(&quot;%s() pvt=%p\n&quot;, __func__, pvt);		\</span>
<span class="cp">	if (pvt-&gt;inject.param &lt; 0)				\</span>
<span class="cp">		return sprintf(data, &quot;any\n&quot;);			\</span>
<span class="cp">	else							\</span>
<span class="cp">		return sprintf(data, &quot;%d\n&quot;, pvt-&gt;inject.param);\</span>
<span class="cp">}</span>

<span class="cp">#define ATTR_ADDR_MATCH(param)					\</span>
<span class="cp">	{							\</span>
<span class="cp">		.attr = {					\</span>
<span class="cp">			.name = #param,				\</span>
<span class="cp">			.mode = (S_IRUGO | S_IWUSR)		\</span>
<span class="cp">		},						\</span>
<span class="cp">		.show  = i7core_inject_show_##param,		\</span>
<span class="cp">		.store = i7core_inject_store_##param,		\</span>
<span class="cp">	}</span>

<span class="n">DECLARE_ADDR_MATCH</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">DECLARE_ADDR_MATCH</span><span class="p">(</span><span class="n">dimm</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">DECLARE_ADDR_MATCH</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">DECLARE_ADDR_MATCH</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
<span class="n">DECLARE_ADDR_MATCH</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
<span class="n">DECLARE_ADDR_MATCH</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_and_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">read</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;setting pci %02x:%02x.%x reg=%02x value=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Error during set pci %02x:%02x.%x reg=%02x &quot;</span>
		<span class="s">&quot;write=%08x. Read=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">read</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine prepares the Memory Controller for error injection.</span>
<span class="cm"> * The error will be injected when some process tries to write to the</span>
<span class="cm"> * memory that matches the given criteria.</span>
<span class="cm"> * The criteria can be set in terms of a mask where dimm, rank, bank, page</span>
<span class="cm"> * and col can be specified.</span>
<span class="cm"> * A -1 value for any of the mask items will make the MCU to ignore</span>
<span class="cm"> * that matching criteria for error injection.</span>
<span class="cm"> *</span>
<span class="cm"> * It should be noticed that the error will only happen after a write operation</span>
<span class="cm"> * on a memory that matches the condition. if REPEAT_EN is not enabled at</span>
<span class="cm"> * inject mask, then it will produce just one error. Otherwise, it will repeat</span>
<span class="cm"> * until the injectmask would be cleaned.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: This routine assumes that MAXNUMDIMMS value of MC_MAX_DOD</span>
<span class="cm"> *    is reliable enough to check if the MC is using the</span>
<span class="cm"> *    three channels. However, this is not clear at the datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">injectmask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">rc</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">disable_inject</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sets pvt-&gt;inject.dimm mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">dimm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">41</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">].</span><span class="n">dimms</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">dimm</span> <span class="o">&amp;</span> <span class="mh">0x3LL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">35</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">dimm</span> <span class="o">&amp;</span> <span class="mh">0x1LL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">36</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sets pvt-&gt;inject.rank mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">].</span><span class="n">dimms</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">rank</span> <span class="o">&amp;</span> <span class="mh">0x1LL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">34</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">rank</span> <span class="o">&amp;</span> <span class="mh">0x3LL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">34</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sets pvt-&gt;inject.bank mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">bank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">39</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="mh">0x15LL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>

	<span class="cm">/* Sets pvt-&gt;inject.page mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">page</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">38</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">page</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>

	<span class="cm">/* Sets pvt-&gt;inject.column mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">col</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">37</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">col</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * bit    0: REPEAT_EN</span>
<span class="cm">	 * bits 1-2: MASK_HALF_CACHELINE</span>
<span class="cm">	 * bit    3: INJECT_ECC</span>
<span class="cm">	 * bit    4: INJECT_ADDR_PARITY</span>
<span class="cm">	 */</span>

	<span class="n">injectmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">section</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Unlock writes to registers - this register is write only */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span><span class="p">,</span>
			       <span class="n">MC_CFG_CONTROL</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="n">write_and_test</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">MC_CHANNEL_ADDR_MATCH</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">write_and_test</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">MC_CHANNEL_ADDR_MATCH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">32L</span><span class="p">);</span>

	<span class="n">write_and_test</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">MC_CHANNEL_ERROR_MASK</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">eccmask</span><span class="p">);</span>

	<span class="n">write_and_test</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">MC_CHANNEL_ERROR_INJECT</span><span class="p">,</span> <span class="n">injectmask</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is something undocumented, based on my tests</span>
<span class="cm">	 * Without writing 8 to this register, errors aren&#39;t injected. Not sure</span>
<span class="cm">	 * why.</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span><span class="p">,</span>
			       <span class="n">MC_CFG_CONTROL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Error inject addr match 0x%016llx, ecc 0x%08x,&quot;</span>
		<span class="s">&quot; inject 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mask</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">eccmask</span><span class="p">,</span> <span class="n">injectmask</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i7core_inject_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">injectmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">MC_CHANNEL_ERROR_INJECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">injectmask</span><span class="p">);</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Inject error read: 0x%018x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">injectmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">injectmask</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DECLARE_COUNTER(param)					\</span>
<span class="cp">static ssize_t i7core_show_counter_##param(			\</span>
<span class="cp">		struct mem_ctl_info *mci,			\</span>
<span class="cp">		char *data)					\</span>
<span class="cp">{								\</span>
<span class="cp">	struct i7core_pvt *pvt = mci-&gt;pvt_info;			\</span>
<span class="cp">								\</span>
<span class="cp">	debugf1(&quot;%s() \n&quot;, __func__);				\</span>
<span class="cp">	if (!pvt-&gt;ce_count_available || (pvt-&gt;is_registered))	\</span>
<span class="cp">		return sprintf(data, &quot;data unavailable\n&quot;);	\</span>
<span class="cp">	return sprintf(data, &quot;%lu\n&quot;,				\</span>
<span class="cp">			pvt-&gt;udimm_ce_count[param]);		\</span>
<span class="cp">}</span>

<span class="cp">#define ATTR_COUNTER(param)					\</span>
<span class="cp">	{							\</span>
<span class="cp">		.attr = {					\</span>
<span class="cp">			.name = __stringify(udimm##param),	\</span>
<span class="cp">			.mode = (S_IRUGO | S_IWUSR)		\</span>
<span class="cp">		},						\</span>
<span class="cp">		.show  = i7core_show_counter_##param		\</span>
<span class="cp">	}</span>

<span class="n">DECLARE_COUNTER</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">DECLARE_COUNTER</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">DECLARE_COUNTER</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Sysfs struct</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mcidev_sysfs_attribute</span> <span class="n">i7core_addrmatch_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATTR_ADDR_MATCH</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span>
	<span class="n">ATTR_ADDR_MATCH</span><span class="p">(</span><span class="n">dimm</span><span class="p">),</span>
	<span class="n">ATTR_ADDR_MATCH</span><span class="p">(</span><span class="n">rank</span><span class="p">),</span>
	<span class="n">ATTR_ADDR_MATCH</span><span class="p">(</span><span class="n">bank</span><span class="p">),</span>
	<span class="n">ATTR_ADDR_MATCH</span><span class="p">(</span><span class="n">page</span><span class="p">),</span>
	<span class="n">ATTR_ADDR_MATCH</span><span class="p">(</span><span class="n">col</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* End of list */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mcidev_sysfs_group</span> <span class="n">i7core_inject_addrmatch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;inject_addrmatch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mcidev_attr</span> <span class="o">=</span> <span class="n">i7core_addrmatch_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mcidev_sysfs_attribute</span> <span class="n">i7core_udimm_counters_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATTR_COUNTER</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="n">ATTR_COUNTER</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">ATTR_COUNTER</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mcidev_sysfs_group</span> <span class="n">i7core_udimm_counters</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;all_channel_counts&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mcidev_attr</span> <span class="o">=</span> <span class="n">i7core_udimm_counters_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mcidev_sysfs_attribute</span> <span class="n">i7core_sysfs_rdimm_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_section&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_section_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_section_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_type&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_type_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_type_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_eccmask&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_eccmask_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_eccmask_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i7core_inject_addrmatch</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_enable&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_enable_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_enable_store</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* End of list */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mcidev_sysfs_attribute</span> <span class="n">i7core_sysfs_udimm_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_section&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_section_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_section_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_type&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_type_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_type_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_eccmask&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_eccmask_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_eccmask_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i7core_inject_addrmatch</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;inject_enable&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">i7core_inject_enable_show</span><span class="p">,</span>
		<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">i7core_inject_enable_store</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">grp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i7core_udimm_counters</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* End of list */</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">	Device initialization routines: put/get, init/exit</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_put_all_devices	&#39;put&#39; all the devices that we have</span>
<span class="cm"> *				reserved via &#39;get&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_put_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="n">__FILE__</span> <span class="s">&quot;: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">n_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Removing dev %02x:%02x.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_put_all_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_edac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i7core_put_devices</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>
		<span class="n">free_i7core_dev</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">i7core_xeon_pci_fixup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_table</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On Xeon 55xx, the Intel Quick Path Arch Generic Non-core pci buses</span>
<span class="cm">	 * aren&#39;t announced by acpi. So, we need to use a legacy scan probing</span>
<span class="cm">	 * to detect them</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">table</span> <span class="o">&amp;&amp;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SOCKET_BUSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pcibios_scan_specific_bus</span><span class="p">(</span><span class="mi">255</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">table</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">i7core_pci_lastbus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">last_bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">pci_find_next_bus</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Found bus %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">&gt;</span> <span class="n">last_bus</span><span class="p">)</span>
			<span class="n">last_bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Last bus %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">last_bus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_get_all_devices	Find and perform &#39;get&#39; operation on the MCH&#39;s</span>
<span class="cm"> *			device/functions we want to reference for this driver</span>
<span class="cm"> *</span>
<span class="cm"> *			Need to &#39;get&#39; device 16 func 1 and func 2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i7core_get_onedevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">**</span><span class="n">prev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">devno</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">last_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_descr</span> <span class="o">*</span><span class="n">dev_descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">[</span><span class="n">devno</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">socket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
			      <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * On Xeon 55xx, the Intel QuickPath Arch Generic Non-core regs</span>
<span class="cm">	 * is at addr 8086:2c40, instead of 8086:2c41. So, we need</span>
<span class="cm">	 * to probe for the alternate address in case of failure</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_NONCORE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				      <span class="n">PCI_DEVICE_ID_INTEL_I7_NONCORE_ALT</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				      <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE_ALT</span><span class="p">,</span>
				      <span class="o">*</span><span class="n">prev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">optional</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
			<span class="s">&quot;Device not found: dev %02x.%d PCI ID %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
			<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>

		<span class="cm">/* End of list, leave */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">socket</span> <span class="o">=</span> <span class="n">last_bus</span> <span class="o">-</span> <span class="n">bus</span><span class="p">;</span>

	<span class="n">i7core_dev</span> <span class="o">=</span> <span class="n">get_i7core_dev</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i7core_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i7core_dev</span> <span class="o">=</span> <span class="n">alloc_i7core_dev</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i7core_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="n">devno</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Duplicated device for &quot;</span>
			<span class="s">&quot;dev %02x:%02x.%d PCI ID %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bus</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
			<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">||</span>
			<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Device PCI ID %04x:%04x &quot;</span>
			<span class="s">&quot;has dev %02x:%02x.%d instead of dev %02x:%02x.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span>
			<span class="n">bus</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
			<span class="n">bus</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Be sure that the device is enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Couldn&#39;t enable &quot;</span>
			<span class="s">&quot;dev %02x:%02x.%d PCI ID %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bus</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
			<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Detected socket %d dev %02x:%02x.%d PCI ID %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">socket</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">dev_descr</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As stated on drivers/pci/search.c, the reference count for</span>
<span class="cm">	 * @from is always decremented if it is not %NULL. So, as we need</span>
<span class="cm">	 * to get all devices up to null, we need to do a get for the device</span>
<span class="cm">	 */</span>
	<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i7core_get_all_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">last_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_id_table</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">pci_dev_table</span><span class="p">;</span>

	<span class="n">last_bus</span> <span class="o">=</span> <span class="n">i7core_pci_lastbus</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">table</span> <span class="o">&amp;&amp;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">n_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">i7core_get_onedevice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
							  <span class="n">last_bus</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">i</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">n_devs</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">i7core_put_all_devices</span><span class="p">();</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">table</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mci_bind_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">family</span><span class="p">;</span>

	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">is_registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">n_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">func</span> <span class="o">&gt;</span> <span class="n">MAX_MCR_FUNC</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">NUM_CHANS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">func</span> <span class="o">&gt;</span> <span class="n">MAX_CHAN_FUNC</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_ch</span><span class="p">[</span><span class="n">slot</span> <span class="o">-</span> <span class="mi">4</span><span class="p">][</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

			<span class="cm">/* Detect the processor family */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_NONCORE</span>:
				<span class="n">family</span> <span class="o">=</span> <span class="s">&quot;Xeon 35xx/ i7core&quot;</span><span class="p">;</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE_ALT</span>:
				<span class="n">family</span> <span class="o">=</span> <span class="s">&quot;i7-800/i5-700&quot;</span><span class="p">;</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE</span>:
				<span class="n">family</span> <span class="o">=</span> <span class="s">&quot;Xeon 34xx&quot;</span><span class="p">;</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_I7_NONCORE_ALT</span>:
				<span class="n">family</span> <span class="o">=</span> <span class="s">&quot;Xeon 55xx&quot;</span><span class="p">;</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE_REV2</span>:
				<span class="n">family</span> <span class="o">=</span> <span class="s">&quot;Xeon 56xx / i7-900&quot;</span><span class="p">;</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">family</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Detected a processor type %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">family</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;Associated fn %d.%d, dev = %p, socket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
			<span class="n">pdev</span><span class="p">,</span> <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
			<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">is_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Device %d, function %d &quot;</span>
		      <span class="s">&quot;is out of the expected range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			Error check routines</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_rdimm_update_errcount</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">int</span> <span class="n">dimm</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">int</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">add</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">HW_EVENT_ERR_CORRECTED</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">chan</span><span class="p">,</span> <span class="n">dimm</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_rdimm_update_ce_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">int</span> <span class="n">new0</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">int</span> <span class="n">new1</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">int</span> <span class="n">new2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">add0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">add1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">add2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Updates CE counters if it is not the first time here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ce_count_available</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Updates CE counters */</span>

		<span class="n">add2</span> <span class="o">=</span> <span class="n">new2</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">add1</span> <span class="o">=</span> <span class="n">new1</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">add0</span> <span class="o">=</span> <span class="n">new0</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">add2</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">add1</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">add0</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ce_count_available</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Store the new values */</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new2</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new1</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">rdimm_last_ce_count</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new0</span><span class="p">;</span>

	<span class="cm">/*updated the edac core */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i7core_rdimm_update_errcount</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">add0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i7core_rdimm_update_errcount</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">add1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i7core_rdimm_update_errcount</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">add2</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_rdimm_check_mc_ecc_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">new0</span><span class="p">,</span> <span class="n">new1</span><span class="p">,</span> <span class="n">new2</span><span class="p">;</span>

	<span class="cm">/*Read DEV 3: FUN 2:  MC_COR_ECC_CNT regs directly*/</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">MC_COR_ECC_CNT_0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rcv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">MC_COR_ECC_CNT_1</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rcv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">MC_COR_ECC_CNT_2</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rcv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">MC_COR_ECC_CNT_3</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rcv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">MC_COR_ECC_CNT_4</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rcv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">MC_COR_ECC_CNT_5</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rcv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugf3</span><span class="p">(</span><span class="s">&quot;MC_COR_ECC_CNT%d = 0x%x; MC_COR_ECC_CNT%d = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="cm">/*if the channel has 3 dimms*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dimms</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new0</span> <span class="o">=</span> <span class="n">DIMM_BOT_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">new1</span> <span class="o">=</span> <span class="n">DIMM_TOP_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">new2</span> <span class="o">=</span> <span class="n">DIMM_BOT_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">new0</span> <span class="o">=</span> <span class="n">DIMM_TOP_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
					<span class="n">DIMM_BOT_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">new1</span> <span class="o">=</span> <span class="n">DIMM_TOP_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
					<span class="n">DIMM_BOT_COR_ERR</span><span class="p">(</span><span class="n">rcv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">new2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i7core_rdimm_update_ce_count</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">new0</span><span class="p">,</span> <span class="n">new1</span><span class="p">,</span> <span class="n">new2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This function is based on the device 3 function 4 registers as described on:</span>
<span class="cm"> * Intel Xeon Processor 5500 Series Datasheet Volume 2</span>
<span class="cm"> *	http://www.intel.com/Assets/PDF/datasheet/321322.pdf</span>
<span class="cm"> * also available at:</span>
<span class="cm"> * 	http://www.arrownac.com/manufacturers/intel/s/nehalem/5500-datasheet-v2.pdf</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_udimm_check_mc_ecc_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv1</span><span class="p">,</span> <span class="n">rcv0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new0</span><span class="p">,</span> <span class="n">new1</span><span class="p">,</span> <span class="n">new2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;%s MCR registers not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Corrected test errors */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">MC_TEST_ERR_RCV1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcv1</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">MC_TEST_ERR_RCV0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcv0</span><span class="p">);</span>

	<span class="cm">/* Store the new values */</span>
	<span class="n">new2</span> <span class="o">=</span> <span class="n">DIMM2_COR_ERR</span><span class="p">(</span><span class="n">rcv1</span><span class="p">);</span>
	<span class="n">new1</span> <span class="o">=</span> <span class="n">DIMM1_COR_ERR</span><span class="p">(</span><span class="n">rcv0</span><span class="p">);</span>
	<span class="n">new0</span> <span class="o">=</span> <span class="n">DIMM0_COR_ERR</span><span class="p">(</span><span class="n">rcv0</span><span class="p">);</span>

	<span class="cm">/* Updates CE counters if it is not the first time here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ce_count_available</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Updates CE counters */</span>
		<span class="kt">int</span> <span class="n">add0</span><span class="p">,</span> <span class="n">add1</span><span class="p">,</span> <span class="n">add2</span><span class="p">;</span>

		<span class="n">add2</span> <span class="o">=</span> <span class="n">new2</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">add1</span> <span class="o">=</span> <span class="n">new1</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">add0</span> <span class="o">=</span> <span class="n">new0</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">add2</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_ce_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">add1</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_ce_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">add0</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_ce_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add0</span> <span class="o">|</span> <span class="n">add1</span> <span class="o">|</span> <span class="n">add2</span><span class="p">)</span>
			<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;New Corrected error(s): &quot;</span>
				      <span class="s">&quot;dimm0: +%d, dimm1: +%d, dimm2 +%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">add0</span><span class="p">,</span> <span class="n">add1</span><span class="p">,</span> <span class="n">add2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">ce_count_available</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Store the new values */</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new2</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new1</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">udimm_last_ce_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * According with tables E-11 and E-12 of chapter E.3.3 of Intel 64 and IA-32</span>
<span class="cm"> * Architectures Software Developer’s Manual Volume 3B.</span>
<span class="cm"> * Nehalem are defined as family 0x06, model 0x1a</span>
<span class="cm"> *</span>
<span class="cm"> * The MCA registers used here are the following ones:</span>
<span class="cm"> *     struct mce field	MCA Register</span>
<span class="cm"> *     m-&gt;status	MSR_IA32_MC8_STATUS</span>
<span class="cm"> *     m-&gt;addr		MSR_IA32_MC8_ADDR</span>
<span class="cm"> *     m-&gt;misc		MSR_IA32_MC8_MISC</span>
<span class="cm"> * In the case of Nehalem, the error information is masked at .status and .misc</span>
<span class="cm"> * fields</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_mce_output_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">mce</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="o">*</span><span class="n">optype</span><span class="p">,</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">hw_event_mc_err_type</span> <span class="n">tp_event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1ff0000l</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">uncorrected_error</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mcgstatus</span> <span class="o">&amp;</span> <span class="mi">1ll</span> <span class="o">&lt;&lt;</span> <span class="mi">61</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ripv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mcgstatus</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">optypenum</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">core_err_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">38</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dimm</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">syndrome</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errnum</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uncorrected_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ripv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;FATAL&quot;</span><span class="p">;</span>
			<span class="n">tp_event</span> <span class="o">=</span> <span class="n">HW_EVENT_ERR_FATAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;NON_FATAL&quot;</span><span class="p">;</span>
			<span class="n">tp_event</span> <span class="o">=</span> <span class="n">HW_EVENT_ERR_UNCORRECTED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;CORRECTED&quot;</span><span class="p">;</span>
		<span class="n">tp_event</span> <span class="o">=</span> <span class="n">HW_EVENT_ERR_CORRECTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optypenum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">optype</span> <span class="o">=</span> <span class="s">&quot;generic undef request&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">optype</span> <span class="o">=</span> <span class="s">&quot;read error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">optype</span> <span class="o">=</span> <span class="s">&quot;write error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">optype</span> <span class="o">=</span> <span class="s">&quot;addr/cmd error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">optype</span> <span class="o">=</span> <span class="s">&quot;scrubbing error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">optype</span> <span class="o">=</span> <span class="s">&quot;reserved&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">errnum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;read ECC error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">17</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;RAS ECC error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;write parity error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">19</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;redundacy loss&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">20</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;reserved&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">21</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;memory range error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;RTID out of range&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">23</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;address parity error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;byte enable parity error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="s">&quot;count=%d %s&quot;</span><span class="p">,</span> <span class="n">core_err_cnt</span><span class="p">,</span> <span class="n">optype</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call the helper to output message</span>
<span class="cm">	 * FIXME: what to do if core_err_cnt &gt; 1? Currently, it generates</span>
<span class="cm">	 * only one event</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uncorrected_error</span> <span class="o">||</span> <span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">is_registered</span><span class="p">)</span>
		<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">tp_event</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span>
				     <span class="n">m</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
				     <span class="n">m</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">,</span>
				     <span class="n">syndrome</span><span class="p">,</span>
				     <span class="n">channel</span><span class="p">,</span> <span class="n">dimm</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				     <span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_check_error	Retrieve and process errors reported by the</span>
<span class="cm"> *				hardware. Called by the Core module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_check_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mce</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MCE first step: Copy all mce errors into a temporary buffer</span>
<span class="cm">	 * We use a double buffering here, to reduce the risk of</span>
<span class="cm">	 * losing an error.</span>
<span class="cm">	 */</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_out</span> <span class="o">+</span> <span class="n">MCE_LOG_LEN</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span><span class="p">)</span>
		<span class="o">%</span> <span class="n">MCE_LOG_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_ce_error</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_outentry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">MCE_LOG_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">l</span> <span class="o">=</span> <span class="n">MCE_LOG_LEN</span> <span class="o">-</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_entry</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">m</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_entry</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_overrun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Lost %d memory errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_overrun</span><span class="p">);</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_overrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * MCE second step: parse errors and display</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">i7core_mce_output_error</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_outentry</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, let&#39;s increment CE error counts</span>
<span class="cm">	 */</span>
<span class="nl">check_ce_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">is_registered</span><span class="p">)</span>
		<span class="n">i7core_udimm_check_mc_ecc_err</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i7core_rdimm_check_mc_ecc_err</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i7core_mce_check_error	Replicates mcelog routine to get errors</span>
<span class="cm"> *				This routine simply queues mcelog errors, and</span>
<span class="cm"> *				return. The error itself should be handled later</span>
<span class="cm"> *				by i7core_check_error.</span>
<span class="cm"> * WARNING: As this routine should be called at NMI time, extra care should</span>
<span class="cm"> * be taken to avoid deadlocks, and to be as fast as possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i7core_mce_check_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mce</span> <span class="o">*</span><span class="n">mce</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mce</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>

	<span class="n">i7_dev</span> <span class="o">=</span> <span class="n">get_i7core_dev</span><span class="p">(</span><span class="n">mce</span><span class="o">-&gt;</span><span class="n">socketid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i7_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>

	<span class="n">mci</span> <span class="o">=</span> <span class="n">i7_dev</span><span class="o">-&gt;</span><span class="n">mci</span><span class="p">;</span>
	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Just let mcelog handle it if the error is</span>
<span class="cm">	 * outside the memory controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">mce</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="cm">/* Bank 8 registers are the only ones that we know how to handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mce</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MCE_LOG_LEN</span> <span class="o">==</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_overrun</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy memory error at the ringbuffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_entry</span><span class="p">[</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_out</span><span class="p">],</span> <span class="n">mce</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mce</span><span class="p">));</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">mce_out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MCE_LOG_LEN</span><span class="p">;</span>

	<span class="cm">/* Handle fatal errors immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mce</span><span class="o">-&gt;</span><span class="n">mcgstatus</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">i7core_check_error</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="cm">/* Advise mcelog that the errors were handled */</span>
	<span class="k">return</span> <span class="n">NOTIFY_STOP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">i7_mce_dec</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">i7core_mce_check_error</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">memdev_dmi_entry</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phys_mem_array_handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mem_err_info_handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">total_width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">form</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device_set</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device_locator</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bank_locator</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">memory_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type_detail</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">manufacturer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">serial_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">asset_tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">part_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">attributes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">extended_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">conf_mem_clk_speed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">));</span>


<span class="cm">/*</span>
<span class="cm"> * Decode the DRAM Clock Frequency, be paranoid, make sure that all</span>
<span class="cm"> * memory devices show the same speed, and if they don&#39;t then consider</span>
<span class="cm"> * all speeds to be invalid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_dclk</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_header</span> <span class="o">*</span><span class="n">dh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dclk_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">dclk_freq</span> <span class="o">=</span> <span class="n">_dclk_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dmi_mem_clk_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dclk_freq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMI_ENTRY_MEM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">memdev_dmi_entry</span> <span class="o">*</span><span class="n">memdev_dmi_entry</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">memdev_dmi_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">dh</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">conf_mem_clk_speed_offset</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">conf_mem_clk_speed</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">speed_offset</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

		<span class="cm">/* Check that a DIMM is present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Pick the configured speed if it&#39;s available, otherwise</span>
<span class="cm">		 * pick the DIMM speed, or we don&#39;t have a speed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">conf_mem_clk_speed_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dmi_mem_clk_speed</span> <span class="o">=</span>
				<span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">conf_mem_clk_speed</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">speed_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dmi_mem_clk_speed</span> <span class="o">=</span> <span class="n">memdev_dmi_entry</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dclk_freq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dclk_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First pass, speed was 0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmi_mem_clk_speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Set speed if a valid speed is read */</span>
				<span class="o">*</span><span class="n">dclk_freq</span> <span class="o">=</span> <span class="n">dmi_mem_clk_speed</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Otherwise we don&#39;t have a valid speed */</span>
				<span class="o">*</span><span class="n">dclk_freq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dclk_freq</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			   <span class="o">*</span><span class="n">dclk_freq</span> <span class="o">!=</span> <span class="n">dmi_mem_clk_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we have a speed, check that all DIMMS are the same</span>
<span class="cm">			 * speed, otherwise set the speed as invalid.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">dclk_freq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The default DCLK frequency is used as a fallback if we</span>
<span class="cm"> * fail to find anything reliable in the DMI. The value</span>
<span class="cm"> * is taken straight from the datasheet.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_DCLK_FREQ 800</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dclk_freq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dclk_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dmi_walk</span><span class="p">(</span><span class="n">decode_dclk</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dclk_freq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dclk_freq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DEFAULT_DCLK_FREQ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dclk_freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set_sdram_scrub_rate		This routine sets byte/sec bandwidth scrub rate</span>
<span class="cm"> *				to hardware according to SCRUBINTERVAL formula</span>
<span class="cm"> *				found in datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sdram_scrub_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_scrub</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_ssr</span><span class="p">;</span>

	<span class="cm">/* Get data from the MC register, function 2 */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SCRUB_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_scrub</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_bw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Prepare to disable petrol scrub */</span>
		<span class="n">dw_scrub</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STARTSCRUB</span><span class="p">;</span>
		<span class="cm">/* Stop the patrol scrub engine */</span>
		<span class="n">write_and_test</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SCRUB_CONTROL</span><span class="p">,</span>
			       <span class="n">dw_scrub</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCRUBINTERVAL_MASK</span><span class="p">);</span>

		<span class="cm">/* Get current status of scrub rate and set bit to disable */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SSRCONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_ssr</span><span class="p">);</span>
		<span class="n">dw_ssr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSR_MODE_MASK</span><span class="p">;</span>
		<span class="n">dw_ssr</span> <span class="o">|=</span> <span class="n">SSR_MODE_DISABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">cache_line_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">freq_dclk_mhz</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">dclk_freq</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">scrub_interval</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Translate the desired scrub rate to a register value and</span>
<span class="cm">		 * program the corresponding register value.</span>
<span class="cm">		 */</span>
		<span class="n">scrub_interval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">freq_dclk_mhz</span> <span class="o">*</span>
			<span class="n">cache_line_size</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">scrub_interval</span><span class="p">,</span> <span class="n">new_bw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scrub_interval</span> <span class="o">||</span> <span class="n">scrub_interval</span> <span class="o">&gt;</span> <span class="n">SCRUBINTERVAL_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">dw_scrub</span> <span class="o">=</span> <span class="n">SCRUBINTERVAL_MASK</span> <span class="o">&amp;</span> <span class="n">scrub_interval</span><span class="p">;</span>

		<span class="cm">/* Start the patrol scrub engine */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SCRUB_CONTROL</span><span class="p">,</span>
				       <span class="n">STARTSCRUB</span> <span class="o">|</span> <span class="n">dw_scrub</span><span class="p">);</span>

		<span class="cm">/* Get current status of scrub rate and set bit to enable */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SSRCONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_ssr</span><span class="p">);</span>
		<span class="n">dw_ssr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSR_MODE_MASK</span><span class="p">;</span>
		<span class="n">dw_ssr</span> <span class="o">|=</span> <span class="n">SSR_MODE_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Disable or enable scrubbing */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SSRCONTROL</span><span class="p">,</span> <span class="n">dw_ssr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">new_bw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_sdram_scrub_rate		This routine convert current scrub rate value</span>
<span class="cm"> *				into byte/sec bandwidth according to</span>
<span class="cm"> *				SCRUBINTERVAL formula found in datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_sdram_scrub_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cache_line_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">freq_dclk_mhz</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">dclk_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">scrub_rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scrubval</span><span class="p">;</span>

	<span class="cm">/* Get data from the MC register, function 2 */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_mcr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Get current scrub control data */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MC_SCRUB_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scrubval</span><span class="p">);</span>

	<span class="cm">/* Mask highest 8-bits to 0 */</span>
	<span class="n">scrubval</span> <span class="o">&amp;=</span>  <span class="n">SCRUBINTERVAL_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scrubval</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Calculate scrub rate value into byte/sec bandwidth */</span>
	<span class="n">scrub_rate</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">freq_dclk_mhz</span> <span class="o">*</span>
		<span class="mi">1000000</span> <span class="o">*</span> <span class="n">cache_line_size</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">scrub_rate</span><span class="p">,</span> <span class="n">scrubval</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scrub_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_sdram_scrub_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pci_lock</span><span class="p">;</span>

	<span class="cm">/* Unlock writes to pci registers */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span><span class="p">,</span> <span class="n">MC_CFG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_lock</span><span class="p">);</span>
	<span class="n">pci_lock</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span><span class="p">,</span> <span class="n">MC_CFG_CONTROL</span><span class="p">,</span>
			       <span class="n">pci_lock</span> <span class="o">|</span> <span class="n">MC_CFG_UNLOCK</span><span class="p">);</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">set_sdram_scrub_rate</span> <span class="o">=</span> <span class="n">set_sdram_scrub_rate</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">get_sdram_scrub_rate</span> <span class="o">=</span> <span class="n">get_sdram_scrub_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_sdram_scrub_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pci_lock</span><span class="p">;</span>

	<span class="cm">/* Lock writes to pci registers */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span><span class="p">,</span> <span class="n">MC_CFG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_lock</span><span class="p">);</span>
	<span class="n">pci_lock</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">pci_noncore</span><span class="p">,</span> <span class="n">MC_CFG_CONTROL</span><span class="p">,</span>
			       <span class="n">pci_lock</span> <span class="o">|</span> <span class="n">MC_CFG_LOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_pci_ctl_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_pci</span> <span class="o">=</span> <span class="n">edac_pci_create_generic_ctl</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">EDAC_MOD_STR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_pci</span><span class="p">))</span>
		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span>
			      <span class="s">&quot;Unable to setup PCI error report via EDAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_pci_ctl_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_pci</span><span class="p">))</span>
		<span class="n">edac_pci_release_generic_ctl</span><span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_pci</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;Couldn&#39;t find mem_ctl_info for socket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_pci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i7core_unregister_mci</span><span class="p">(</span><span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span> <span class="o">=</span> <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mci</span> <span class="o">||</span> <span class="o">!</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: &quot;</span> <span class="n">__FILE__</span> <span class="s">&quot;: %s(): dev = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find mci handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: &quot;</span> <span class="n">__FILE__</span> <span class="s">&quot;: %s(): mci = %p, dev = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable scrubrate setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span><span class="p">)</span>
		<span class="n">disable_sdram_scrub_setting</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="cm">/* Disable EDAC polling */</span>
	<span class="n">i7core_pci_ctl_release</span><span class="p">(</span><span class="n">pvt</span><span class="p">);</span>

	<span class="cm">/* Remove MC sysfs nodes */</span>
	<span class="n">edac_mc_del_mc</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">debugf1</span><span class="p">(</span><span class="s">&quot;%s: free mci struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span><span class="p">);</span>
	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">mci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i7core_register_mci</span><span class="p">(</span><span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_pvt</span> <span class="o">*</span><span class="n">pvt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edac_mc_layer</span> <span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* allocate a new MC control structure */</span>

	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_CHANNEL</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">NUM_CHANS</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_SLOT</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">MAX_DIMMS</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_alloc</span><span class="p">(</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="n">layers</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pvt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mci</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: &quot;</span> <span class="n">__FILE__</span> <span class="s">&quot;: %s(): mci = %p, dev = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pvt</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pvt</span><span class="p">));</span>

	<span class="cm">/* Associates i7core_dev and mci for future usage */</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">i7core_dev</span> <span class="o">=</span> <span class="n">i7core_dev</span><span class="p">;</span>
	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">mci</span> <span class="o">=</span> <span class="n">mci</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: how to handle RDDR3 at MCI level? It is possible to have</span>
<span class="cm">	 * Mixed RDDR3/UDDR3 with Nehalem, provided that they are on different</span>
<span class="cm">	 * memory channels</span>
<span class="cm">	 */</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mtype_cap</span> <span class="o">=</span> <span class="n">MEM_FLAG_DDR3</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_ctl_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_NONE</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_name</span> <span class="o">=</span> <span class="s">&quot;i7core_edac.c&quot;</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_ver</span> <span class="o">=</span> <span class="n">I7CORE_REVISION</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;i7 core #%d&quot;</span><span class="p">,</span>
				  <span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_page_to_phys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Store pci devices at mci for faster access */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mci_bind_devs</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i7core_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">is_registered</span><span class="p">)</span>
		<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mc_driver_sysfs_attributes</span> <span class="o">=</span> <span class="n">i7core_sysfs_rdimm_attrs</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mc_driver_sysfs_attributes</span> <span class="o">=</span> <span class="n">i7core_sysfs_udimm_attrs</span><span class="p">;</span>

	<span class="cm">/* Get dimm basic config */</span>
	<span class="n">get_dimm_config</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="cm">/* record ptr to the generic device */</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* Set the function pointer to an actual operation function */</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_check</span> <span class="o">=</span> <span class="n">i7core_check_error</span><span class="p">;</span>

	<span class="cm">/* Enable scrubrate setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvt</span><span class="o">-&gt;</span><span class="n">enable_scrub</span><span class="p">)</span>
		<span class="n">enable_sdram_scrub_setting</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="cm">/* add this new MC control structure to EDAC&#39;s list of MCs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">edac_mc_add_mc</span><span class="p">(</span><span class="n">mci</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">debugf0</span><span class="p">(</span><span class="s">&quot;MC: &quot;</span> <span class="n">__FILE__</span>
			<span class="s">&quot;: %s(): failed edac_mc_add_mc()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* FIXME: perhaps some code should go here that disables error</span>
<span class="cm">		 * reporting if we just enabled it</span>
<span class="cm">		 */</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default error mask is any memory */</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">dimm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">bank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">inject</span><span class="p">.</span><span class="n">col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* allocating generic PCI control info */</span>
	<span class="n">i7core_pci_ctl_create</span><span class="p">(</span><span class="n">pvt</span><span class="p">);</span>

	<span class="cm">/* DCLK for scrub rate setting */</span>
	<span class="n">pvt</span><span class="o">-&gt;</span><span class="n">dclk_freq</span> <span class="o">=</span> <span class="n">get_dclk_freq</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span><span class="p">);</span>
	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
	<span class="n">i7core_dev</span><span class="o">-&gt;</span><span class="n">mci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_probe	Probe for ONE instance of device to see if it is</span>
<span class="cm"> *			present.</span>
<span class="cm"> *	return:</span>
<span class="cm"> *		0 for FOUND a device</span>
<span class="cm"> *		&lt; 0 for error code</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">i7core_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">;</span>

	<span class="cm">/* get the pci devices we want to reserve for our use */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * All memory controllers are allocated at the first pass.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">probed</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">probed</span><span class="o">++</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">i7core_get_all_devices</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_edac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i7core_register_mci</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Nehalem-EX uses a different memory controller. However, as the</span>
<span class="cm">	 * memory controller is not visible on some Nehalem/Nehalem-EP, we</span>
<span class="cm">	 * need to indirectly probe via a X58 PCI device. The same devices</span>
<span class="cm">	 * are found on (some) Nehalem-EX. So, on those machines, the</span>
<span class="cm">	 * probe routine needs to return -ENODEV, as the actual Memory</span>
<span class="cm">	 * Controller registers won&#39;t be detected.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
		      <span class="s">&quot;Driver loaded, %d memory controller(s) found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">count</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail1:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_edac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">i7core_unregister_mci</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>

	<span class="n">i7core_put_all_devices</span><span class="p">();</span>
<span class="nl">fail0:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_remove	destructor for one instance of device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">i7core_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i7core_dev</span> <span class="o">*</span><span class="n">i7core_dev</span><span class="p">;</span>

	<span class="n">debugf0</span><span class="p">(</span><span class="n">__FILE__</span> <span class="s">&quot;: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * we have a trouble here: pdev value for removal will be wrong, since</span>
<span class="cm">	 * it will point to the X58 register used to detect that the machine</span>
<span class="cm">	 * is a Nehalem or upper design. However, due to the way several PCI</span>
<span class="cm">	 * devices are grouped together to provide MC functionality, we need</span>
<span class="cm">	 * to use a different method for releasing the devices</span>
<span class="cm">	 */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">probed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i7core_edac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">i7core_unregister_mci</span><span class="p">(</span><span class="n">i7core_dev</span><span class="p">);</span>

	<span class="cm">/* Release PCI resources */</span>
	<span class="n">i7core_put_all_devices</span><span class="p">();</span>

	<span class="n">probed</span><span class="o">--</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_edac_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">i7core_pci_tbl</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_driver	pci_driver structure for this module</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">i7core_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;i7core_edac&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">i7core_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">i7core_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">i7core_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_init		Module entry function</span>
<span class="cm"> *			Try to initialize this module for its devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i7core_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pci_rc</span><span class="p">;</span>

	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MC: &quot;</span> <span class="n">__FILE__</span> <span class="s">&quot;: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Ensure that the OPSTATE is set correctly for POLL or NMI */</span>
	<span class="n">opstate_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_pci_fixup</span><span class="p">)</span>
		<span class="n">i7core_xeon_pci_fixup</span><span class="p">(</span><span class="n">pci_dev_table</span><span class="p">);</span>

	<span class="n">pci_rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mce_register_decode_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7_mce_dec</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i7core_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to register device with error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">pci_rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	i7core_exit()	Module exit function</span>
<span class="cm"> *			Unregister the driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">i7core_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;MC: &quot;</span> <span class="n">__FILE__</span> <span class="s">&quot;: %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7core_driver</span><span class="p">);</span>
	<span class="n">mce_unregister_decode_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i7_mce_dec</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">i7core_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">i7core_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mauro Carvalho Chehab &lt;mchehab@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Red Hat Inc. (http://www.redhat.com)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MC Driver for Intel i7 Core memory controllers - &quot;</span>
		   <span class="n">I7CORE_REVISION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">edac_op_state</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">edac_op_state</span><span class="p">,</span> <span class="s">&quot;EDAC Error Reporting state: 0=Poll,1=NMI&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
