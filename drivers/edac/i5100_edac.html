<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › edac › i5100_edac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>i5100_edac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel 5100 Memory Controllers kernel module</span>
<span class="cm"> *</span>
<span class="cm"> * This file may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License.</span>
<span class="cm"> *</span>
<span class="cm"> * This module is based on the following document:</span>
<span class="cm"> *</span>
<span class="cm"> * Intel 5100X Chipset Memory Controller Hub (MCH) - Datasheet</span>
<span class="cm"> *      http://download.intel.com/design/chipsets/datashts/318378.pdf</span>
<span class="cm"> *</span>
<span class="cm"> * The intel 5100 has two independent channels. EDAC core currently</span>
<span class="cm"> * can not reflect this configuration so instead the chip-select</span>
<span class="cm"> * rows for each respective channel are laid out one after another,</span>
<span class="cm"> * the first half belonging to channel 0, the second half belonging</span>
<span class="cm"> * to channel 1.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is for DDR2 DIMMs, and it uses chip select to select among the</span>
<span class="cm"> * several ranks. However, instead of showing memories as ranks, it outputs</span>
<span class="cm"> * them as DIMM&#39;s. An internal table creates the association between ranks</span>
<span class="cm"> * and DIMM&#39;s.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/edac.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>

<span class="cp">#include &quot;edac_core.h&quot;</span>

<span class="cm">/* register addresses */</span>

<span class="cm">/* device 16, func 1 */</span>
<span class="cp">#define I5100_MC		0x40	</span><span class="cm">/* Memory Control Register */</span><span class="cp"></span>
<span class="cp">#define 	I5100_MC_SCRBEN_MASK	(1 &lt;&lt; 7)</span>
<span class="cp">#define 	I5100_MC_SCRBDONE_MASK	(1 &lt;&lt; 4)</span>
<span class="cp">#define I5100_MS		0x44	</span><span class="cm">/* Memory Status Register */</span><span class="cp"></span>
<span class="cp">#define I5100_SPDDATA		0x48	</span><span class="cm">/* Serial Presence Detect Status Reg */</span><span class="cp"></span>
<span class="cp">#define I5100_SPDCMD		0x4c	</span><span class="cm">/* Serial Presence Detect Command Reg */</span><span class="cp"></span>
<span class="cp">#define I5100_TOLM		0x6c	</span><span class="cm">/* Top of Low Memory */</span><span class="cp"></span>
<span class="cp">#define I5100_MIR0		0x80	</span><span class="cm">/* Memory Interleave Range 0 */</span><span class="cp"></span>
<span class="cp">#define I5100_MIR1		0x84	</span><span class="cm">/* Memory Interleave Range 1 */</span><span class="cp"></span>
<span class="cp">#define I5100_AMIR_0		0x8c	</span><span class="cm">/* Adjusted Memory Interleave Range 0 */</span><span class="cp"></span>
<span class="cp">#define I5100_AMIR_1		0x90	</span><span class="cm">/* Adjusted Memory Interleave Range 1 */</span><span class="cp"></span>
<span class="cp">#define I5100_FERR_NF_MEM	0xa0	</span><span class="cm">/* MC First Non Fatal Errors */</span><span class="cp"></span>
<span class="cp">#define		I5100_FERR_NF_MEM_M16ERR_MASK	(1 &lt;&lt; 16)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M15ERR_MASK	(1 &lt;&lt; 15)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M14ERR_MASK	(1 &lt;&lt; 14)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M12ERR_MASK	(1 &lt;&lt; 12)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M11ERR_MASK	(1 &lt;&lt; 11)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M10ERR_MASK	(1 &lt;&lt; 10)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M6ERR_MASK	(1 &lt;&lt; 6)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M5ERR_MASK	(1 &lt;&lt; 5)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M4ERR_MASK	(1 &lt;&lt; 4)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_M1ERR_MASK	(1 &lt;&lt; 1)</span>
<span class="cp">#define		I5100_FERR_NF_MEM_ANY_MASK	\</span>
<span class="cp">			(I5100_FERR_NF_MEM_M16ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M15ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M14ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M12ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M11ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M10ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M6ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M5ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M4ERR_MASK | \</span>
<span class="cp">			I5100_FERR_NF_MEM_M1ERR_MASK)</span>
<span class="cp">#define	I5100_NERR_NF_MEM	0xa4	</span><span class="cm">/* MC Next Non-Fatal Errors */</span><span class="cp"></span>
<span class="cp">#define I5100_EMASK_MEM		0xa8	</span><span class="cm">/* MC Error Mask Register */</span><span class="cp"></span>

<span class="cm">/* device 21 and 22, func 0 */</span>
<span class="cp">#define I5100_MTR_0	0x154	</span><span class="cm">/* Memory Technology Registers 0-3 */</span><span class="cp"></span>
<span class="cp">#define I5100_DMIR	0x15c	</span><span class="cm">/* DIMM Interleave Range */</span><span class="cp"></span>
<span class="cp">#define	I5100_VALIDLOG	0x18c	</span><span class="cm">/* Valid Log Markers */</span><span class="cp"></span>
<span class="cp">#define	I5100_NRECMEMA	0x190	</span><span class="cm">/* Non-Recoverable Memory Error Log Reg A */</span><span class="cp"></span>
<span class="cp">#define	I5100_NRECMEMB	0x194	</span><span class="cm">/* Non-Recoverable Memory Error Log Reg B */</span><span class="cp"></span>
<span class="cp">#define	I5100_REDMEMA	0x198	</span><span class="cm">/* Recoverable Memory Data Error Log Reg A */</span><span class="cp"></span>
<span class="cp">#define	I5100_REDMEMB	0x19c	</span><span class="cm">/* Recoverable Memory Data Error Log Reg B */</span><span class="cp"></span>
<span class="cp">#define	I5100_RECMEMA	0x1a0	</span><span class="cm">/* Recoverable Memory Error Log Reg A */</span><span class="cp"></span>
<span class="cp">#define	I5100_RECMEMB	0x1a4	</span><span class="cm">/* Recoverable Memory Error Log Reg B */</span><span class="cp"></span>
<span class="cp">#define I5100_MTR_4	0x1b0	</span><span class="cm">/* Memory Technology Registers 4,5 */</span><span class="cp"></span>

<span class="cm">/* bit field accessors */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_mc_scrben</span><span class="p">(</span><span class="n">u32</span> <span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_mc_errdeten</span><span class="p">(</span><span class="n">u32</span> <span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_mc_scrbdone</span><span class="p">(</span><span class="n">u32</span> <span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_spddata_rdo</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_spddata_sbe</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_spddata_busy</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_spddata_data</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_spdcmd_create</span><span class="p">(</span><span class="n">u32</span> <span class="n">dti</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ckovrd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ba</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="p">((</span><span class="n">dti</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">ckovrd</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>            <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">sa</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>   <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">ba</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>   <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_tolm_tolm</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mir_limit</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mir_way1</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mir_way0</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_ferr_nf_mem_chan_indx</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_ferr_nf_mem_any</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">I5100_FERR_NF_MEM_ANY_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nerr_nf_mem_any</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_ferr_nf_mem_any</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_dmir_limit</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_dmir_rank</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mtr_present</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mtr_ethrottle</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mtr_width</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mtr_numbank</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mtr_numrow</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">i5100_mtr_numcol</span><span class="p">(</span><span class="n">u16</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_validlog_redmemvalid</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_validlog_recmemvalid</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_validlog_nrecmemvalid</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nrecmema_merr</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nrecmema_bank</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nrecmema_rank</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nrecmema_dm_buf_id</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nrecmemb_cas</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_nrecmemb_ras</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_redmemb_ecc_locator</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_recmema_merr</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_nrecmema_merr</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_recmema_bank</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_nrecmema_bank</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_recmema_rank</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_nrecmema_rank</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_recmema_dm_buf_id</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_nrecmema_dm_buf_id</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_recmemb_cas</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_nrecmemb_cas</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">i5100_recmemb_ras</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i5100_nrecmemb_ras</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* some generic limits */</span>
<span class="cp">#define I5100_MAX_RANKS_PER_CHAN	6</span>
<span class="cp">#define I5100_CHANNELS			    2</span>
<span class="cp">#define I5100_MAX_RANKS_PER_DIMM	4</span>
<span class="cp">#define I5100_DIMM_ADDR_LINES		(6 - 3)	</span><span class="cm">/* 64 bits / 8 bits per byte */</span><span class="cp"></span>
<span class="cp">#define I5100_MAX_DIMM_SLOTS_PER_CHAN	4</span>
<span class="cp">#define I5100_MAX_RANK_INTERLEAVE	4</span>
<span class="cp">#define I5100_MAX_DMIRS			5</span>
<span class="cp">#define I5100_SCRUB_REFRESH_RATE	(5 * 60 * HZ)</span>

<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="p">{</span>
	<span class="cm">/* ranks on each dimm -- 0 maps to not present -- obtained via SPD */</span>
	<span class="kt">int</span> <span class="n">dimm_numrank</span><span class="p">[</span><span class="n">I5100_CHANNELS</span><span class="p">][</span><span class="n">I5100_MAX_DIMM_SLOTS_PER_CHAN</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * mainboard chip select map -- maps i5100 chip selects to</span>
<span class="cm">	 * DIMM slot chip selects.  In the case of only 4 ranks per</span>
<span class="cm">	 * channel, the mapping is fairly obvious but not unique.</span>
<span class="cm">	 * we map -1 -&gt; NC and assume both channels use the same</span>
<span class="cm">	 * map...</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">dimm_csmap</span><span class="p">[</span><span class="n">I5100_MAX_DIMM_SLOTS_PER_CHAN</span><span class="p">][</span><span class="n">I5100_MAX_RANKS_PER_DIMM</span><span class="p">];</span>

	<span class="cm">/* memory interleave range */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u64</span>	 <span class="n">limit</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">way</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">mir</span><span class="p">[</span><span class="n">I5100_CHANNELS</span><span class="p">];</span>

	<span class="cm">/* adjusted memory interleave range register */</span>
	<span class="kt">unsigned</span> <span class="n">amir</span><span class="p">[</span><span class="n">I5100_CHANNELS</span><span class="p">];</span>

	<span class="cm">/* dimm interleave range */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">rank</span><span class="p">[</span><span class="n">I5100_MAX_RANK_INTERLEAVE</span><span class="p">];</span>
		<span class="n">u64</span>	 <span class="n">limit</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">dmir</span><span class="p">[</span><span class="n">I5100_CHANNELS</span><span class="p">][</span><span class="n">I5100_MAX_DMIRS</span><span class="p">];</span>

	<span class="cm">/* memory technology registers... */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">present</span><span class="p">;</span>	<span class="cm">/* 0 or 1 */</span>
		<span class="kt">unsigned</span> <span class="n">ethrottle</span><span class="p">;</span>	<span class="cm">/* 0 or 1 */</span>
		<span class="kt">unsigned</span> <span class="n">width</span><span class="p">;</span>		<span class="cm">/* 4 or 8 bits  */</span>
		<span class="kt">unsigned</span> <span class="n">numbank</span><span class="p">;</span>	<span class="cm">/* 2 or 3 lines */</span>
		<span class="kt">unsigned</span> <span class="n">numrow</span><span class="p">;</span>	<span class="cm">/* 13 .. 16 lines */</span>
		<span class="kt">unsigned</span> <span class="n">numcol</span><span class="p">;</span>	<span class="cm">/* 11 .. 12 lines */</span>
	<span class="p">}</span> <span class="n">mtr</span><span class="p">[</span><span class="n">I5100_CHANNELS</span><span class="p">][</span><span class="n">I5100_MAX_RANKS_PER_CHAN</span><span class="p">];</span>

	<span class="n">u64</span> <span class="n">tolm</span><span class="p">;</span>		<span class="cm">/* top of low memory in bytes */</span>
	<span class="kt">unsigned</span> <span class="n">ranksperchan</span><span class="p">;</span>	<span class="cm">/* number of ranks per channel */</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">mc</span><span class="p">;</span>	<span class="cm">/* device 16 func 1 */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">ch0mm</span><span class="p">;</span>	<span class="cm">/* device 21 func 0 */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">ch1mm</span><span class="p">;</span>	<span class="cm">/* device 22 func 0 */</span>

	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">i5100_scrubbing</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scrub_enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* map a rank/chan to a slot number on the mainboard */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5100_rank_to_slot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I5100_MAX_DIMM_SLOTS_PER_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">numrank</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_numrank</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numrank</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">rank</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">chan</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">i5100_err_msg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">merrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 0 */</span>
		<span class="s">&quot;uncorrectable data ECC on replay&quot;</span><span class="p">,</span> <span class="cm">/* 1 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 2 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 3 */</span>
		<span class="s">&quot;aliased uncorrectable demand data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 4 */</span>
		<span class="s">&quot;aliased uncorrectable spare-copy data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 5 */</span>
		<span class="s">&quot;aliased uncorrectable patrol data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 6 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 7 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 8 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 9 */</span>
		<span class="s">&quot;non-aliased uncorrectable demand data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 10 */</span>
		<span class="s">&quot;non-aliased uncorrectable spare-copy data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 11 */</span>
		<span class="s">&quot;non-aliased uncorrectable patrol data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 12 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 13 */</span>
		<span class="s">&quot;correctable demand data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 14 */</span>
		<span class="s">&quot;correctable spare-copy data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 15 */</span>
		<span class="s">&quot;correctable patrol data ECC&quot;</span><span class="p">,</span> <span class="cm">/* 16 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 17 */</span>
		<span class="s">&quot;SPD protocol error&quot;</span><span class="p">,</span> <span class="cm">/* 18 */</span>
		<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="cm">/* 19 */</span>
		<span class="s">&quot;spare copy initiated&quot;</span><span class="p">,</span> <span class="cm">/* 20 */</span>
		<span class="s">&quot;spare copy completed&quot;</span><span class="p">,</span> <span class="cm">/* 21 */</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">merrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">merrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="s">&quot;none&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* convert csrow index into a rank (per channel -- 0..5) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5100_csrow_to_rank</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csrow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">csrow</span> <span class="o">%</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ranksperchan</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* convert csrow index into a channel (0..1) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5100_csrow_to_chan</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">csrow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">csrow</span> <span class="o">/</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ranksperchan</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5100_handle_ce</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">bank</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">rank</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">syndrome</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">cas</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">ras</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">detail</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="cm">/* Form out message */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">detail</span><span class="p">),</span>
		 <span class="s">&quot;bank %u, cas %u, ras %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bank</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span> <span class="n">ras</span><span class="p">);</span>

	<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">HW_EVENT_ERR_CORRECTED</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syndrome</span><span class="p">,</span>
			     <span class="n">chan</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">msg</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5100_handle_ue</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">bank</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">rank</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">syndrome</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">cas</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">ras</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">detail</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="cm">/* Form out message */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">detail</span><span class="p">),</span>
		 <span class="s">&quot;bank %u, cas %u, ras %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bank</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span> <span class="n">ras</span><span class="p">);</span>

	<span class="n">edac_mc_handle_error</span><span class="p">(</span><span class="n">HW_EVENT_ERR_UNCORRECTED</span><span class="p">,</span> <span class="n">mci</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syndrome</span><span class="p">,</span>
			     <span class="n">chan</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">msg</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5100_read_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">ferr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nerr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">?</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch1mm</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch0mm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">syndrome</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ecc_loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">merr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bank</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rank</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cas</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ras</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_VALIDLOG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i5100_validlog_redmemvalid</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_REDMEMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">syndrome</span> <span class="o">=</span> <span class="n">dw2</span><span class="p">;</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_REDMEMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">ecc_loc</span> <span class="o">=</span> <span class="n">i5100_redmemb_ecc_locator</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i5100_validlog_recmemvalid</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_RECMEMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">merr</span> <span class="o">=</span> <span class="n">i5100_recmema_merr</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="n">i5100_recmema_bank</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">rank</span> <span class="o">=</span> <span class="n">i5100_recmema_rank</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_RECMEMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">cas</span> <span class="o">=</span> <span class="n">i5100_recmemb_cas</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">ras</span> <span class="o">=</span> <span class="n">i5100_recmemb_ras</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>

		<span class="cm">/* FIXME:  not really sure if this is what merr is...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">merr</span><span class="p">)</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">i5100_err_msg</span><span class="p">(</span><span class="n">ferr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">i5100_err_msg</span><span class="p">(</span><span class="n">nerr</span><span class="p">);</span>

		<span class="n">i5100_handle_ce</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">syndrome</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span> <span class="n">ras</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i5100_validlog_nrecmemvalid</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_NRECMEMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">merr</span> <span class="o">=</span> <span class="n">i5100_nrecmema_merr</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="n">i5100_nrecmema_bank</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">rank</span> <span class="o">=</span> <span class="n">i5100_nrecmema_rank</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_NRECMEMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">cas</span> <span class="o">=</span> <span class="n">i5100_nrecmemb_cas</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>
		<span class="n">ras</span> <span class="o">=</span> <span class="n">i5100_nrecmemb_ras</span><span class="p">(</span><span class="n">dw2</span><span class="p">);</span>

		<span class="cm">/* FIXME:  not really sure if this is what merr is...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">merr</span><span class="p">)</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">i5100_err_msg</span><span class="p">(</span><span class="n">ferr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">i5100_err_msg</span><span class="p">(</span><span class="n">nerr</span><span class="p">);</span>

		<span class="n">i5100_handle_ue</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">syndrome</span><span class="p">,</span> <span class="n">cas</span><span class="p">,</span> <span class="n">ras</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_VALIDLOG</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5100_check_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dw2</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_FERR_NF_MEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i5100_ferr_nf_mem_any</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_NERR_NF_MEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw2</span><span class="p">);</span>

		<span class="n">i5100_read_log</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i5100_ferr_nf_mem_chan_indx</span><span class="p">(</span><span class="n">dw</span><span class="p">),</span>
			       <span class="n">i5100_ferr_nf_mem_any</span><span class="p">(</span><span class="n">dw</span><span class="p">),</span>
			       <span class="n">i5100_nerr_nf_mem_any</span><span class="p">(</span><span class="n">dw2</span><span class="p">));</span>

		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_NERR_NF_MEM</span><span class="p">,</span> <span class="n">dw2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_FERR_NF_MEM</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The i5100 chipset will scrub the entire memory once, then</span>
<span class="cm"> * set a done bit. Continuous scrubbing is achieved by enqueing</span>
<span class="cm"> * delayed work to a workqueue, checking every few minutes if</span>
<span class="cm"> * the scrubbing has completed and if so reinitiating it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i5100_refresh_scrubbing</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">i5100_scrubbing</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
							    <span class="k">struct</span> <span class="n">delayed_work</span><span class="p">,</span>
							    <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">i5100_scrubbing</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">i5100_priv</span><span class="p">,</span>
					       <span class="n">i5100_scrubbing</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scrub_enable</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i5100_mc_scrbdone</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dw</span> <span class="o">|=</span> <span class="n">I5100_MC_SCRBEN_MASK</span><span class="p">;</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">),</span>
				      <span class="n">I5100_SCRUB_REFRESH_RATE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * The bandwidth is based on experimentation, feel free to refine it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5100_set_scrub_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scrub_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dw</span> <span class="o">|=</span> <span class="n">I5100_MC_SCRBEN_MASK</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">),</span>
				      <span class="n">I5100_SCRUB_REFRESH_RATE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scrub_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I5100_MC_SCRBEN_MASK</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>

	<span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">5900000</span> <span class="o">*</span> <span class="n">i5100_mc_scrben</span><span class="p">(</span><span class="n">dw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bandwidth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5100_get_scrub_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">5900000</span> <span class="o">*</span> <span class="n">i5100_mc_scrben</span><span class="p">(</span><span class="n">dw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">pci_get_device_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">vendor</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="n">device</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">func</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__devinit</span> <span class="nf">i5100_npages</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">csrow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">chan_rank</span> <span class="o">=</span> <span class="n">i5100_csrow_to_rank</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">csrow</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">i5100_csrow_to_chan</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">csrow</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">addr_lines</span><span class="p">;</span>

	<span class="cm">/* dimm present? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">chan_rank</span><span class="p">].</span><span class="n">present</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0ULL</span><span class="p">;</span>

	<span class="n">addr_lines</span> <span class="o">=</span>
		<span class="n">I5100_DIMM_ADDR_LINES</span> <span class="o">+</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">chan_rank</span><span class="p">].</span><span class="n">numcol</span> <span class="o">+</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">chan_rank</span><span class="p">].</span><span class="n">numrow</span> <span class="o">+</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">chan_rank</span><span class="p">].</span><span class="n">numbank</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">addr_lines</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">i5100_init_mtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">mms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch0mm</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch1mm</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I5100_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">mms</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">I5100_MAX_RANKS_PER_CHAN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">addr</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">I5100_MTR_0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">:</span>
					  <span class="n">I5100_MTR_4</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">present</span> <span class="o">=</span> <span class="n">i5100_mtr_present</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">ethrottle</span> <span class="o">=</span> <span class="n">i5100_mtr_ethrottle</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i5100_mtr_width</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">numbank</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i5100_mtr_numbank</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">numrow</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">+</span> <span class="n">i5100_mtr_numrow</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">numcol</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">i5100_mtr_numcol</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: make this into a real i2c adapter (so that dimm-decode</span>
<span class="cm"> * will work)?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i5100_read_spd_byte</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">et</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_SPDDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i5100_spddata_busy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_SPDCMD</span><span class="p">,</span>
			       <span class="n">i5100_spdcmd_create</span><span class="p">(</span><span class="mh">0xa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">slot</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* wait up to 100ms */</span>
	<span class="n">et</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">I5100_SPDDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i5100_spddata_busy</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i5100_spddata_rdo</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">||</span> <span class="n">i5100_spddata_sbe</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">byte</span> <span class="o">=</span> <span class="n">i5100_spddata_data</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill dimm chip select map</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME:</span>
<span class="cm"> *   o not the only way to may chip selects to dimm slots</span>
<span class="cm"> *   o investigate if there is some way to obtain this map from the bios</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">i5100_init_dimm_csmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I5100_MAX_DIMM_SLOTS_PER_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">I5100_MAX_RANKS_PER_DIMM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* default NC */</span>
	<span class="p">}</span>

	<span class="cm">/* only 2 chip selects per slot... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ranksperchan</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_csmap</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">i5100_init_dimm_layout</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I5100_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">I5100_MAX_DIMM_SLOTS_PER_CHAN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">rank</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i5100_read_spd_byte</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_numrank</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dimm_numrank</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i5100_init_dimm_csmap</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">i5100_init_interleaving</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">mms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch0mm</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch1mm</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_TOLM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tolm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">i5100_tolm_tolm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_MIR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">i5100_mir_limit</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">way</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i5100_mir_way1</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">way</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i5100_mir_way0</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_MIR1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">i5100_mir_limit</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">way</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i5100_mir_way1</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">way</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i5100_mir_way0</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_AMIR_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">amir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_AMIR_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">amir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I5100_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">mms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">I5100_DMIR</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmir</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">i5100_dmir_limit</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">I5100_MAX_RANKS_PER_DIMM</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmir</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">rank</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">i5100_dmir_rank</span><span class="p">(</span><span class="n">dw</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i5100_init_mtr</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">i5100_init_csrows</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">tot_dimms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dimm_info</span> <span class="o">*</span><span class="n">dimm</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span> <span class="o">=</span> <span class="n">i5100_npages</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">i5100_csrow_to_chan</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">i5100_csrow_to_rank</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npages</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dimm</span> <span class="o">=</span> <span class="n">EDAC_DIMM_PTR</span><span class="p">(</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">dimms</span><span class="p">,</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">n_layers</span><span class="p">,</span>
			       <span class="n">chan</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">npages</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">grain</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtr</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">rank</span><span class="p">].</span><span class="n">width</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">DEV_X4</span> <span class="o">:</span> <span class="n">DEV_X8</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">mtype</span> <span class="o">=</span> <span class="n">MEM_RDDR2</span><span class="p">;</span>
			<span class="n">dimm</span><span class="o">-&gt;</span><span class="n">edac_mode</span> <span class="o">=</span> <span class="n">EDAC_SECDED</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">dimm</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dimm</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">),</span>
				<span class="s">&quot;DIMM%u&quot;</span><span class="p">,</span>
				<span class="n">i5100_rank_to_slot</span><span class="p">(</span><span class="n">mci</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">rank</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">debugf2</span><span class="p">(</span><span class="s">&quot;dimm channel %d, rank %d, size %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">PAGES_TO_MiB</span><span class="p">(</span><span class="n">npages</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">i5100_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edac_mc_layer</span> <span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">ch0mm</span><span class="p">,</span> <span class="o">*</span><span class="n">ch1mm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ranksperch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ECC enabled? */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i5100_mc_errdeten</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;i5100_edac: ECC not enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* figure out how many ranks, from strapped state of 48GB_Mode input */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_MS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="n">ranksperch</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">dw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* enable error reporting... */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_EMASK_MEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="n">dw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I5100_FERR_NF_MEM_ANY_MASK</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_EMASK_MEM</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>

	<span class="cm">/* device 21, func 0, Channel 0 Memory Map, Error Flag/Mask, etc... */</span>
	<span class="n">ch0mm</span> <span class="o">=</span> <span class="n">pci_get_device_func</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				    <span class="n">PCI_DEVICE_ID_INTEL_5100_21</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch0mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">ch0mm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_ch0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* device 22, func 0, Channel 1 Memory Map, Error Flag/Mask, etc... */</span>
	<span class="n">ch1mm</span> <span class="o">=</span> <span class="n">pci_get_device_func</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
				    <span class="n">PCI_DEVICE_ID_INTEL_5100_22</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch1mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_disable_ch0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">ch1mm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_ch1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_CHANNEL</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EDAC_MC_LAYER_SLOT</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">ranksperch</span><span class="p">;</span>
	<span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">is_virt_csrow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="n">layers</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_disable_ch1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ranksperchan</span> <span class="o">=</span> <span class="n">ranksperch</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch0mm</span> <span class="o">=</span> <span class="n">ch0mm</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch1mm</span> <span class="o">=</span> <span class="n">ch1mm</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">),</span> <span class="n">i5100_refresh_scrubbing</span><span class="p">);</span>

	<span class="cm">/* If scrubbing was already enabled by the bios, start maintaining it */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">I5100_MC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i5100_mc_scrben</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scrub_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">),</span>
				      <span class="n">I5100_SCRUB_REFRESH_RATE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i5100_init_dimm_layout</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mci</span><span class="p">);</span>
	<span class="n">i5100_init_interleaving</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mci</span><span class="p">);</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mtype_cap</span> <span class="o">=</span> <span class="n">MEM_FLAG_FB_DDR2</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_ctl_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_SECDED</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_cap</span> <span class="o">=</span> <span class="n">EDAC_FLAG_SECDED</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_name</span> <span class="o">=</span> <span class="s">&quot;i5100_edac.c&quot;</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">mod_ver</span> <span class="o">=</span> <span class="s">&quot;not versioned&quot;</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_name</span> <span class="o">=</span> <span class="s">&quot;i5100&quot;</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">ctl_page_to_phys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">edac_check</span> <span class="o">=</span> <span class="n">i5100_check_error</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">set_sdram_scrub_rate</span> <span class="o">=</span> <span class="n">i5100_set_scrub_rate</span><span class="p">;</span>
	<span class="n">mci</span><span class="o">-&gt;</span><span class="n">get_sdram_scrub_rate</span> <span class="o">=</span> <span class="n">i5100_get_scrub_rate</span><span class="p">;</span>

	<span class="n">i5100_init_csrows</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

	<span class="cm">/* this strange construction seems to be in every driver, dunno why */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">edac_op_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EDAC_OPSTATE_POLL</span>:
	<span class="k">case</span> <span class="n">EDAC_OPSTATE_NMI</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">edac_op_state</span> <span class="o">=</span> <span class="n">EDAC_OPSTATE_POLL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edac_mc_add_mc</span><span class="p">(</span><span class="n">mci</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail_scrub</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">bail_scrub:</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scrub_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">));</span>
	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>

<span class="nl">bail_disable_ch1:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">ch1mm</span><span class="p">);</span>

<span class="nl">bail_ch1:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ch1mm</span><span class="p">);</span>

<span class="nl">bail_disable_ch0:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">ch0mm</span><span class="p">);</span>

<span class="nl">bail_ch0:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">ch0mm</span><span class="p">);</span>

<span class="nl">bail_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">bail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">i5100_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_ctl_info</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i5100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mci</span> <span class="o">=</span> <span class="n">edac_mc_del_mc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mci</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">mci</span><span class="o">-&gt;</span><span class="n">pvt_info</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scrub_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i5100_scrubbing</span><span class="p">));</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch0mm</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch1mm</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch0mm</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ch1mm</span><span class="p">);</span>

	<span class="n">edac_mc_free</span><span class="p">(</span><span class="n">mci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">i5100_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Device 16, Function 0, Channel 0 Memory Map, Error Flag/Mask, ... */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_5100_16</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">i5100_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">i5100_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_BASENAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">i5100_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">i5100_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">i5100_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i5100_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pci_rc</span><span class="p">;</span>

	<span class="n">pci_rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i5100_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pci_rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">pci_rc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">i5100_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i5100_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">i5100_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">i5100_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span>
    <span class="p">(</span><span class="s">&quot;Arthur Jones &lt;ajones@riverbed.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MC Driver for Intel I5100 memory controllers&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
