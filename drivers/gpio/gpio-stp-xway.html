<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpio › gpio-stp-xway.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>gpio-stp-xway.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> *  by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2012 John Crispin &lt;blogic@openwrt.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>

<span class="cp">#include &lt;lantiq_soc.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The Serial To Parallel (STP) is found on MIPS based Lantiq socs. It is a</span>
<span class="cm"> * peripheral controller used to drive external shift register cascades. At most</span>
<span class="cm"> * 3 groups of 8 bits can be driven. The hardware is able to allow the DSL modem</span>
<span class="cm"> * to drive the 2 LSBs of the cascade automatically.</span>
<span class="cm"> */</span>

<span class="cm">/* control register 0 */</span>
<span class="cp">#define XWAY_STP_CON0		0x00</span>
<span class="cm">/* control register 1 */</span>
<span class="cp">#define XWAY_STP_CON1		0x04</span>
<span class="cm">/* data register 0 */</span>
<span class="cp">#define XWAY_STP_CPU0		0x08</span>
<span class="cm">/* data register 1 */</span>
<span class="cp">#define XWAY_STP_CPU1		0x0C</span>
<span class="cm">/* access register */</span>
<span class="cp">#define XWAY_STP_AR		0x10</span>

<span class="cm">/* software or hardware update select bit */</span>
<span class="cp">#define XWAY_STP_CON_SWU	BIT(31)</span>

<span class="cm">/* automatic update rates */</span>
<span class="cp">#define XWAY_STP_2HZ		0</span>
<span class="cp">#define XWAY_STP_4HZ		BIT(23)</span>
<span class="cp">#define XWAY_STP_8HZ		BIT(24)</span>
<span class="cp">#define XWAY_STP_10HZ		(BIT(24) | BIT(23))</span>
<span class="cp">#define XWAY_STP_SPEED_MASK	(0xf &lt;&lt; 23)</span>

<span class="cm">/* clock source for automatic update */</span>
<span class="cp">#define XWAY_STP_UPD_FPI	BIT(31)</span>
<span class="cp">#define XWAY_STP_UPD_MASK	(BIT(31) | BIT(30))</span>

<span class="cm">/* let the adsl core drive the 2 LSBs */</span>
<span class="cp">#define XWAY_STP_ADSL_SHIFT	24</span>
<span class="cp">#define XWAY_STP_ADSL_MASK	0x3</span>

<span class="cm">/* 2 groups of 3 bits can be driven by the phys */</span>
<span class="cp">#define XWAY_STP_PHY_MASK	0x3</span>
<span class="cp">#define XWAY_STP_PHY1_SHIFT	27</span>
<span class="cp">#define XWAY_STP_PHY2_SHIFT	15</span>

<span class="cm">/* STP has 3 groups of 8 bits */</span>
<span class="cp">#define XWAY_STP_GROUP0		BIT(0)</span>
<span class="cp">#define XWAY_STP_GROUP1		BIT(1)</span>
<span class="cp">#define XWAY_STP_GROUP2		BIT(2)</span>
<span class="cp">#define XWAY_STP_GROUP_MASK	(0x7)</span>

<span class="cm">/* Edge configuration bits */</span>
<span class="cp">#define XWAY_STP_FALLING	BIT(26)</span>
<span class="cp">#define XWAY_STP_EDGE_MASK	BIT(26)</span>

<span class="cp">#define xway_stp_r32(m, reg)		__raw_readl(m + reg)</span>
<span class="cp">#define xway_stp_w32(m, val, reg)	__raw_writel(val, m + reg)</span>
<span class="cp">#define xway_stp_w32_mask(m, clear, set, reg) \</span>
<span class="cp">		ltq_w32((ltq_r32(m + reg) &amp; ~(clear)) | (set), \</span>
<span class="cp">		m + reg)</span>

<span class="k">struct</span> <span class="n">xway_stp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span> <span class="n">gc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edge</span><span class="p">;</span>	<span class="cm">/* rising or falling edge triggered shift register */</span>
	<span class="n">u16</span> <span class="n">shadow</span><span class="p">;</span>	<span class="cm">/* shadow the shift registers state */</span>
	<span class="n">u8</span> <span class="n">groups</span><span class="p">;</span>	<span class="cm">/* we can drive 1-3 groups of 8bit each */</span>
	<span class="n">u8</span> <span class="n">dsl</span><span class="p">;</span>		<span class="cm">/* the 2 LSBs can be driven by the dsl core */</span>
	<span class="n">u8</span> <span class="n">phy1</span><span class="p">;</span>	<span class="cm">/* 3 bits can be driven by phy1 */</span>
	<span class="n">u8</span> <span class="n">phy2</span><span class="p">;</span>	<span class="cm">/* 3 bits can be driven by phy2 */</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>	<span class="cm">/* mask out the hw driven bits in gpio_request */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * xway_stp_set() - gpio_chip-&gt;set - set gpios.</span>
<span class="cm"> * @gc:     Pointer to gpio_chip device structure.</span>
<span class="cm"> * @gpio:   GPIO signal number.</span>
<span class="cm"> * @val:    Value to be written to specified signal.</span>
<span class="cm"> *</span>
<span class="cm"> * Set the shadow value and call ltq_ebu_apply.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xway_stp_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xway_stp</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xway_stp</span><span class="p">,</span> <span class="n">gc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">xway_stp_w32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">,</span> <span class="n">XWAY_STP_CPU0</span><span class="p">);</span>
	<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XWAY_STP_CON_SWU</span><span class="p">,</span> <span class="n">XWAY_STP_CON0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xway_stp_dir_out() - gpio_chip-&gt;dir_out - set gpio direction.</span>
<span class="cm"> * @gc:     Pointer to gpio_chip device structure.</span>
<span class="cm"> * @gpio:   GPIO signal number.</span>
<span class="cm"> * @val:    Value to be written to specified signal.</span>
<span class="cm"> *</span>
<span class="cm"> * Same as xway_stp_set, always returns 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xway_stp_dir_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xway_stp_set</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xway_stp_request() - gpio_chip-&gt;request</span>
<span class="cm"> * @gc:     Pointer to gpio_chip device structure.</span>
<span class="cm"> * @gpio:   GPIO signal number.</span>
<span class="cm"> *</span>
<span class="cm"> * We mask out the HW driven pins</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xway_stp_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xway_stp</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xway_stp</span><span class="p">,</span> <span class="n">gc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">gpio</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIO %d is driven by hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xway_stp_hw_init() - Configure the STP unit and enable the clock gate</span>
<span class="cm"> * @virt: pointer to the remapped register range</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xway_stp_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">xway_stp</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sane defaults */</span>
	<span class="n">xway_stp_w32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XWAY_STP_AR</span><span class="p">);</span>
	<span class="n">xway_stp_w32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XWAY_STP_CPU0</span><span class="p">);</span>
	<span class="n">xway_stp_w32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XWAY_STP_CPU1</span><span class="p">);</span>
	<span class="n">xway_stp_w32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">XWAY_STP_CON_SWU</span><span class="p">,</span> <span class="n">XWAY_STP_CON0</span><span class="p">);</span>
	<span class="n">xway_stp_w32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XWAY_STP_CON1</span><span class="p">);</span>

	<span class="cm">/* apply edge trigger settings for the shift register */</span>
	<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">XWAY_STP_EDGE_MASK</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">edge</span><span class="p">,</span> <span class="n">XWAY_STP_CON0</span><span class="p">);</span>

	<span class="cm">/* apply led group settings */</span>
	<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">XWAY_STP_GROUP_MASK</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">,</span> <span class="n">XWAY_STP_CON1</span><span class="p">);</span>

	<span class="cm">/* tell the hardware which pins are controlled by the dsl modem */</span>
	<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span>
			<span class="n">XWAY_STP_ADSL_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">XWAY_STP_ADSL_SHIFT</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsl</span> <span class="o">&lt;&lt;</span> <span class="n">XWAY_STP_ADSL_SHIFT</span><span class="p">,</span>
			<span class="n">XWAY_STP_CON0</span><span class="p">);</span>

	<span class="cm">/* tell the hardware which pins are controlled by the phys */</span>
	<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span>
			<span class="n">XWAY_STP_PHY_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">XWAY_STP_PHY1_SHIFT</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy1</span> <span class="o">&lt;&lt;</span> <span class="n">XWAY_STP_PHY1_SHIFT</span><span class="p">,</span>
			<span class="n">XWAY_STP_CON0</span><span class="p">);</span>
	<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span>
			<span class="n">XWAY_STP_PHY_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">XWAY_STP_PHY2_SHIFT</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy2</span> <span class="o">&lt;&lt;</span> <span class="n">XWAY_STP_PHY2_SHIFT</span><span class="p">,</span>
			<span class="n">XWAY_STP_CON1</span><span class="p">);</span>

	<span class="cm">/* mask out the hw driven bits in gpio_request */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsl</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we have pins that are driven by hw, we need to tell the stp what</span>
<span class="cm">	 * clock to use as a timer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">)</span>
		<span class="n">xway_stp_w32_mask</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">XWAY_STP_UPD_MASK</span><span class="p">,</span>
			<span class="n">XWAY_STP_UPD_FPI</span><span class="p">,</span> <span class="n">XWAY_STP_CON1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">xway_stp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">shadow</span><span class="p">,</span> <span class="o">*</span><span class="n">groups</span><span class="p">,</span> <span class="o">*</span><span class="n">dsl</span><span class="p">,</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xway_stp</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request STP resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">devm_request_and_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to remap STP memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;stp-xway&quot;</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">direction_output</span> <span class="o">=</span> <span class="n">xway_stp_dir_out</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">xway_stp_set</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">xway_stp_request</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

	<span class="cm">/* store the shadow value if one was passed by the devicetree */</span>
	<span class="n">shadow</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;lantiq,shadow&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shadow</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">shadow</span><span class="p">);</span>

	<span class="cm">/* find out which gpio groups should be enabled */</span>
	<span class="n">groups</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;lantiq,groups&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">groups</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">groups</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XWAY_STP_GROUP_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">groups</span> <span class="o">=</span> <span class="n">XWAY_STP_GROUP0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">.</span><span class="n">ngpio</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* find out which gpios are controlled by the dsl core */</span>
	<span class="n">dsl</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;lantiq,dsl&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsl</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsl</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dsl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XWAY_STP_ADSL_MASK</span><span class="p">;</span>

	<span class="cm">/* find out which gpios are controlled by the phys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,ar9&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,gr9&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,vr9&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;lantiq,phy1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy1</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XWAY_STP_PHY_MASK</span><span class="p">;</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;lantiq,phy2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy2</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XWAY_STP_PHY_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check which edge trigger we should use, default to a falling edge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;lantiq,rising&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">edge</span> <span class="o">=</span> <span class="n">XWAY_STP_FALLING</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xway_stp_hw_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpiochip_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Init done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">xway_stp_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;lantiq,gpio-stp-xway&quot;</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">xway_stp_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">xway_stp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">xway_stp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;gpio-stp-xway&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">xway_stp_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">xway_stp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xway_stp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">xway_stp_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
