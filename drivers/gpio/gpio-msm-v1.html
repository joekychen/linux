<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpio › gpio-msm-v1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>gpio-msm-v1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2007 Google, Inc.</span>
<span class="cm"> * Copyright (c) 2009-2011, Code Aurora Forum. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;mach/cpu.h&gt;</span>
<span class="cp">#include &lt;mach/msm_gpiomux.h&gt;</span>
<span class="cp">#include &lt;mach/msm_iomap.h&gt;</span>

<span class="cm">/* see 80-VA736-2 Rev C pp 695-751</span>
<span class="cm">**</span>
<span class="cm">** These are actually the *shadow* gpio registers, since the</span>
<span class="cm">** real ones (which allow full access) are only available to the</span>
<span class="cm">** ARM9 side of the world.</span>
<span class="cm">**</span>
<span class="cm">** Since the _BASE need to be page-aligned when we&#39;re mapping them</span>
<span class="cm">** to virtual addresses, adjust for the additional offset in these</span>
<span class="cm">** macros.</span>
<span class="cm">*/</span>

<span class="cp">#define MSM_GPIO1_REG(off) (MSM_GPIO1_BASE + (off))</span>
<span class="cp">#define MSM_GPIO2_REG(off) (MSM_GPIO2_BASE + 0x400 + (off))</span>
<span class="cp">#define MSM_GPIO1_SHADOW_REG(off) (MSM_GPIO1_BASE + 0x800 + (off))</span>
<span class="cp">#define MSM_GPIO2_SHADOW_REG(off) (MSM_GPIO2_BASE + 0xC00 + (off))</span>

<span class="cm">/*</span>
<span class="cm"> * MSM7X00 registers</span>
<span class="cm"> */</span>
<span class="cm">/* output value */</span>
<span class="cp">#define MSM7X00_GPIO_OUT_0	MSM_GPIO1_SHADOW_REG(0x00)  </span><span class="cm">/* gpio  15-0  */</span><span class="cp"></span>
<span class="cp">#define MSM7X00_GPIO_OUT_1	MSM_GPIO2_SHADOW_REG(0x00)  </span><span class="cm">/* gpio  42-16 */</span><span class="cp"></span>
<span class="cp">#define MSM7X00_GPIO_OUT_2	MSM_GPIO1_SHADOW_REG(0x04)  </span><span class="cm">/* gpio  67-43 */</span><span class="cp"></span>
<span class="cp">#define MSM7X00_GPIO_OUT_3	MSM_GPIO1_SHADOW_REG(0x08)  </span><span class="cm">/* gpio  94-68 */</span><span class="cp"></span>
<span class="cp">#define MSM7X00_GPIO_OUT_4	MSM_GPIO1_SHADOW_REG(0x0C)  </span><span class="cm">/* gpio 106-95 */</span><span class="cp"></span>
<span class="cp">#define MSM7X00_GPIO_OUT_5	MSM_GPIO1_SHADOW_REG(0x50)  </span><span class="cm">/* gpio 107-121 */</span><span class="cp"></span>

<span class="cm">/* same pin map as above, output enable */</span>
<span class="cp">#define MSM7X00_GPIO_OE_0	MSM_GPIO1_SHADOW_REG(0x10)</span>
<span class="cp">#define MSM7X00_GPIO_OE_1	MSM_GPIO2_SHADOW_REG(0x08)</span>
<span class="cp">#define MSM7X00_GPIO_OE_2	MSM_GPIO1_SHADOW_REG(0x14)</span>
<span class="cp">#define MSM7X00_GPIO_OE_3	MSM_GPIO1_SHADOW_REG(0x18)</span>
<span class="cp">#define MSM7X00_GPIO_OE_4	MSM_GPIO1_SHADOW_REG(0x1C)</span>
<span class="cp">#define MSM7X00_GPIO_OE_5	MSM_GPIO1_SHADOW_REG(0x54)</span>

<span class="cm">/* same pin map as above, input read */</span>
<span class="cp">#define MSM7X00_GPIO_IN_0	MSM_GPIO1_SHADOW_REG(0x34)</span>
<span class="cp">#define MSM7X00_GPIO_IN_1	MSM_GPIO2_SHADOW_REG(0x20)</span>
<span class="cp">#define MSM7X00_GPIO_IN_2	MSM_GPIO1_SHADOW_REG(0x38)</span>
<span class="cp">#define MSM7X00_GPIO_IN_3	MSM_GPIO1_SHADOW_REG(0x3C)</span>
<span class="cp">#define MSM7X00_GPIO_IN_4	MSM_GPIO1_SHADOW_REG(0x40)</span>
<span class="cp">#define MSM7X00_GPIO_IN_5	MSM_GPIO1_SHADOW_REG(0x44)</span>

<span class="cm">/* same pin map as above, 1=edge 0=level interrup */</span>
<span class="cp">#define MSM7X00_GPIO_INT_EDGE_0	MSM_GPIO1_SHADOW_REG(0x60)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EDGE_1	MSM_GPIO2_SHADOW_REG(0x50)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EDGE_2	MSM_GPIO1_SHADOW_REG(0x64)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EDGE_3	MSM_GPIO1_SHADOW_REG(0x68)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EDGE_4	MSM_GPIO1_SHADOW_REG(0x6C)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EDGE_5	MSM_GPIO1_SHADOW_REG(0xC0)</span>

<span class="cm">/* same pin map as above, 1=positive 0=negative */</span>
<span class="cp">#define MSM7X00_GPIO_INT_POS_0	MSM_GPIO1_SHADOW_REG(0x70)</span>
<span class="cp">#define MSM7X00_GPIO_INT_POS_1	MSM_GPIO2_SHADOW_REG(0x58)</span>
<span class="cp">#define MSM7X00_GPIO_INT_POS_2	MSM_GPIO1_SHADOW_REG(0x74)</span>
<span class="cp">#define MSM7X00_GPIO_INT_POS_3	MSM_GPIO1_SHADOW_REG(0x78)</span>
<span class="cp">#define MSM7X00_GPIO_INT_POS_4	MSM_GPIO1_SHADOW_REG(0x7C)</span>
<span class="cp">#define MSM7X00_GPIO_INT_POS_5	MSM_GPIO1_SHADOW_REG(0xBC)</span>

<span class="cm">/* same pin map as above, interrupt enable */</span>
<span class="cp">#define MSM7X00_GPIO_INT_EN_0	MSM_GPIO1_SHADOW_REG(0x80)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EN_1	MSM_GPIO2_SHADOW_REG(0x60)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EN_2	MSM_GPIO1_SHADOW_REG(0x84)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EN_3	MSM_GPIO1_SHADOW_REG(0x88)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EN_4	MSM_GPIO1_SHADOW_REG(0x8C)</span>
<span class="cp">#define MSM7X00_GPIO_INT_EN_5	MSM_GPIO1_SHADOW_REG(0xB8)</span>

<span class="cm">/* same pin map as above, write 1 to clear interrupt */</span>
<span class="cp">#define MSM7X00_GPIO_INT_CLEAR_0	MSM_GPIO1_SHADOW_REG(0x90)</span>
<span class="cp">#define MSM7X00_GPIO_INT_CLEAR_1	MSM_GPIO2_SHADOW_REG(0x68)</span>
<span class="cp">#define MSM7X00_GPIO_INT_CLEAR_2	MSM_GPIO1_SHADOW_REG(0x94)</span>
<span class="cp">#define MSM7X00_GPIO_INT_CLEAR_3	MSM_GPIO1_SHADOW_REG(0x98)</span>
<span class="cp">#define MSM7X00_GPIO_INT_CLEAR_4	MSM_GPIO1_SHADOW_REG(0x9C)</span>
<span class="cp">#define MSM7X00_GPIO_INT_CLEAR_5	MSM_GPIO1_SHADOW_REG(0xB4)</span>

<span class="cm">/* same pin map as above, 1=interrupt pending */</span>
<span class="cp">#define MSM7X00_GPIO_INT_STATUS_0	MSM_GPIO1_SHADOW_REG(0xA0)</span>
<span class="cp">#define MSM7X00_GPIO_INT_STATUS_1	MSM_GPIO2_SHADOW_REG(0x70)</span>
<span class="cp">#define MSM7X00_GPIO_INT_STATUS_2	MSM_GPIO1_SHADOW_REG(0xA4)</span>
<span class="cp">#define MSM7X00_GPIO_INT_STATUS_3	MSM_GPIO1_SHADOW_REG(0xA8)</span>
<span class="cp">#define MSM7X00_GPIO_INT_STATUS_4	MSM_GPIO1_SHADOW_REG(0xAC)</span>
<span class="cp">#define MSM7X00_GPIO_INT_STATUS_5	MSM_GPIO1_SHADOW_REG(0xB0)</span>

<span class="cm">/*</span>
<span class="cm"> * QSD8X50 registers</span>
<span class="cm"> */</span>
<span class="cm">/* output value */</span>
<span class="cp">#define QSD8X50_GPIO_OUT_0	MSM_GPIO1_SHADOW_REG(0x00)  </span><span class="cm">/* gpio  15-0   */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_1	MSM_GPIO2_SHADOW_REG(0x00)  </span><span class="cm">/* gpio  42-16  */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_2	MSM_GPIO1_SHADOW_REG(0x04)  </span><span class="cm">/* gpio  67-43  */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_3	MSM_GPIO1_SHADOW_REG(0x08)  </span><span class="cm">/* gpio  94-68  */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_4	MSM_GPIO1_SHADOW_REG(0x0C)  </span><span class="cm">/* gpio 103-95  */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_5	MSM_GPIO1_SHADOW_REG(0x10)  </span><span class="cm">/* gpio 121-104 */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_6	MSM_GPIO1_SHADOW_REG(0x14)  </span><span class="cm">/* gpio 152-122 */</span><span class="cp"></span>
<span class="cp">#define QSD8X50_GPIO_OUT_7	MSM_GPIO1_SHADOW_REG(0x18)  </span><span class="cm">/* gpio 164-153 */</span><span class="cp"></span>

<span class="cm">/* same pin map as above, output enable */</span>
<span class="cp">#define QSD8X50_GPIO_OE_0	MSM_GPIO1_SHADOW_REG(0x20)</span>
<span class="cp">#define QSD8X50_GPIO_OE_1	MSM_GPIO2_SHADOW_REG(0x08)</span>
<span class="cp">#define QSD8X50_GPIO_OE_2	MSM_GPIO1_SHADOW_REG(0x24)</span>
<span class="cp">#define QSD8X50_GPIO_OE_3	MSM_GPIO1_SHADOW_REG(0x28)</span>
<span class="cp">#define QSD8X50_GPIO_OE_4	MSM_GPIO1_SHADOW_REG(0x2C)</span>
<span class="cp">#define QSD8X50_GPIO_OE_5	MSM_GPIO1_SHADOW_REG(0x30)</span>
<span class="cp">#define QSD8X50_GPIO_OE_6	MSM_GPIO1_SHADOW_REG(0x34)</span>
<span class="cp">#define QSD8X50_GPIO_OE_7	MSM_GPIO1_SHADOW_REG(0x38)</span>

<span class="cm">/* same pin map as above, input read */</span>
<span class="cp">#define QSD8X50_GPIO_IN_0	MSM_GPIO1_SHADOW_REG(0x50)</span>
<span class="cp">#define QSD8X50_GPIO_IN_1	MSM_GPIO2_SHADOW_REG(0x20)</span>
<span class="cp">#define QSD8X50_GPIO_IN_2	MSM_GPIO1_SHADOW_REG(0x54)</span>
<span class="cp">#define QSD8X50_GPIO_IN_3	MSM_GPIO1_SHADOW_REG(0x58)</span>
<span class="cp">#define QSD8X50_GPIO_IN_4	MSM_GPIO1_SHADOW_REG(0x5C)</span>
<span class="cp">#define QSD8X50_GPIO_IN_5	MSM_GPIO1_SHADOW_REG(0x60)</span>
<span class="cp">#define QSD8X50_GPIO_IN_6	MSM_GPIO1_SHADOW_REG(0x64)</span>
<span class="cp">#define QSD8X50_GPIO_IN_7	MSM_GPIO1_SHADOW_REG(0x68)</span>

<span class="cm">/* same pin map as above, 1=edge 0=level interrup */</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_0	MSM_GPIO1_SHADOW_REG(0x70)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_1	MSM_GPIO2_SHADOW_REG(0x50)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_2	MSM_GPIO1_SHADOW_REG(0x74)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_3	MSM_GPIO1_SHADOW_REG(0x78)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_4	MSM_GPIO1_SHADOW_REG(0x7C)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_5	MSM_GPIO1_SHADOW_REG(0x80)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_6	MSM_GPIO1_SHADOW_REG(0x84)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EDGE_7	MSM_GPIO1_SHADOW_REG(0x88)</span>

<span class="cm">/* same pin map as above, 1=positive 0=negative */</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_0	MSM_GPIO1_SHADOW_REG(0x90)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_1	MSM_GPIO2_SHADOW_REG(0x58)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_2	MSM_GPIO1_SHADOW_REG(0x94)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_3	MSM_GPIO1_SHADOW_REG(0x98)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_4	MSM_GPIO1_SHADOW_REG(0x9C)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_5	MSM_GPIO1_SHADOW_REG(0xA0)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_6	MSM_GPIO1_SHADOW_REG(0xA4)</span>
<span class="cp">#define QSD8X50_GPIO_INT_POS_7	MSM_GPIO1_SHADOW_REG(0xA8)</span>

<span class="cm">/* same pin map as above, interrupt enable */</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_0	MSM_GPIO1_SHADOW_REG(0xB0)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_1	MSM_GPIO2_SHADOW_REG(0x60)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_2	MSM_GPIO1_SHADOW_REG(0xB4)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_3	MSM_GPIO1_SHADOW_REG(0xB8)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_4	MSM_GPIO1_SHADOW_REG(0xBC)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_5	MSM_GPIO1_SHADOW_REG(0xC0)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_6	MSM_GPIO1_SHADOW_REG(0xC4)</span>
<span class="cp">#define QSD8X50_GPIO_INT_EN_7	MSM_GPIO1_SHADOW_REG(0xC8)</span>

<span class="cm">/* same pin map as above, write 1 to clear interrupt */</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_0	MSM_GPIO1_SHADOW_REG(0xD0)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_1	MSM_GPIO2_SHADOW_REG(0x68)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_2	MSM_GPIO1_SHADOW_REG(0xD4)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_3	MSM_GPIO1_SHADOW_REG(0xD8)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_4	MSM_GPIO1_SHADOW_REG(0xDC)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_5	MSM_GPIO1_SHADOW_REG(0xE0)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_6	MSM_GPIO1_SHADOW_REG(0xE4)</span>
<span class="cp">#define QSD8X50_GPIO_INT_CLEAR_7	MSM_GPIO1_SHADOW_REG(0xE8)</span>

<span class="cm">/* same pin map as above, 1=interrupt pending */</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_0	MSM_GPIO1_SHADOW_REG(0xF0)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_1	MSM_GPIO2_SHADOW_REG(0x70)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_2	MSM_GPIO1_SHADOW_REG(0xF4)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_3	MSM_GPIO1_SHADOW_REG(0xF8)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_4	MSM_GPIO1_SHADOW_REG(0xFC)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_5	MSM_GPIO1_SHADOW_REG(0x100)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_6	MSM_GPIO1_SHADOW_REG(0x104)</span>
<span class="cp">#define QSD8X50_GPIO_INT_STATUS_7	MSM_GPIO1_SHADOW_REG(0x108)</span>

<span class="cm">/*</span>
<span class="cm"> * MSM7X30 registers</span>
<span class="cm"> */</span>
<span class="cm">/* output value */</span>
<span class="cp">#define MSM7X30_GPIO_OUT_0	MSM_GPIO1_REG(0x00)   </span><span class="cm">/* gpio  15-0   */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_1	MSM_GPIO2_REG(0x00)   </span><span class="cm">/* gpio  43-16  */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_2	MSM_GPIO1_REG(0x04)   </span><span class="cm">/* gpio  67-44  */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_3	MSM_GPIO1_REG(0x08)   </span><span class="cm">/* gpio  94-68  */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_4	MSM_GPIO1_REG(0x0C)   </span><span class="cm">/* gpio 106-95  */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_5	MSM_GPIO1_REG(0x50)   </span><span class="cm">/* gpio 133-107 */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_6	MSM_GPIO1_REG(0xC4)   </span><span class="cm">/* gpio 150-134 */</span><span class="cp"></span>
<span class="cp">#define MSM7X30_GPIO_OUT_7	MSM_GPIO1_REG(0x214)  </span><span class="cm">/* gpio 181-151 */</span><span class="cp"></span>

<span class="cm">/* same pin map as above, output enable */</span>
<span class="cp">#define MSM7X30_GPIO_OE_0	MSM_GPIO1_REG(0x10)</span>
<span class="cp">#define MSM7X30_GPIO_OE_1	MSM_GPIO2_REG(0x08)</span>
<span class="cp">#define MSM7X30_GPIO_OE_2	MSM_GPIO1_REG(0x14)</span>
<span class="cp">#define MSM7X30_GPIO_OE_3	MSM_GPIO1_REG(0x18)</span>
<span class="cp">#define MSM7X30_GPIO_OE_4	MSM_GPIO1_REG(0x1C)</span>
<span class="cp">#define MSM7X30_GPIO_OE_5	MSM_GPIO1_REG(0x54)</span>
<span class="cp">#define MSM7X30_GPIO_OE_6	MSM_GPIO1_REG(0xC8)</span>
<span class="cp">#define MSM7X30_GPIO_OE_7	MSM_GPIO1_REG(0x218)</span>

<span class="cm">/* same pin map as above, input read */</span>
<span class="cp">#define MSM7X30_GPIO_IN_0	MSM_GPIO1_REG(0x34)</span>
<span class="cp">#define MSM7X30_GPIO_IN_1	MSM_GPIO2_REG(0x20)</span>
<span class="cp">#define MSM7X30_GPIO_IN_2	MSM_GPIO1_REG(0x38)</span>
<span class="cp">#define MSM7X30_GPIO_IN_3	MSM_GPIO1_REG(0x3C)</span>
<span class="cp">#define MSM7X30_GPIO_IN_4	MSM_GPIO1_REG(0x40)</span>
<span class="cp">#define MSM7X30_GPIO_IN_5	MSM_GPIO1_REG(0x44)</span>
<span class="cp">#define MSM7X30_GPIO_IN_6	MSM_GPIO1_REG(0xCC)</span>
<span class="cp">#define MSM7X30_GPIO_IN_7	MSM_GPIO1_REG(0x21C)</span>

<span class="cm">/* same pin map as above, 1=edge 0=level interrup */</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_0	MSM_GPIO1_REG(0x60)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_1	MSM_GPIO2_REG(0x50)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_2	MSM_GPIO1_REG(0x64)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_3	MSM_GPIO1_REG(0x68)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_4	MSM_GPIO1_REG(0x6C)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_5	MSM_GPIO1_REG(0xC0)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_6	MSM_GPIO1_REG(0xD0)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EDGE_7	MSM_GPIO1_REG(0x240)</span>

<span class="cm">/* same pin map as above, 1=positive 0=negative */</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_0	MSM_GPIO1_REG(0x70)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_1	MSM_GPIO2_REG(0x58)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_2	MSM_GPIO1_REG(0x74)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_3	MSM_GPIO1_REG(0x78)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_4	MSM_GPIO1_REG(0x7C)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_5	MSM_GPIO1_REG(0xBC)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_6	MSM_GPIO1_REG(0xD4)</span>
<span class="cp">#define MSM7X30_GPIO_INT_POS_7	MSM_GPIO1_REG(0x228)</span>

<span class="cm">/* same pin map as above, interrupt enable */</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_0	MSM_GPIO1_REG(0x80)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_1	MSM_GPIO2_REG(0x60)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_2	MSM_GPIO1_REG(0x84)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_3	MSM_GPIO1_REG(0x88)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_4	MSM_GPIO1_REG(0x8C)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_5	MSM_GPIO1_REG(0xB8)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_6	MSM_GPIO1_REG(0xD8)</span>
<span class="cp">#define MSM7X30_GPIO_INT_EN_7	MSM_GPIO1_REG(0x22C)</span>

<span class="cm">/* same pin map as above, write 1 to clear interrupt */</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_0	MSM_GPIO1_REG(0x90)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_1	MSM_GPIO2_REG(0x68)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_2	MSM_GPIO1_REG(0x94)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_3	MSM_GPIO1_REG(0x98)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_4	MSM_GPIO1_REG(0x9C)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_5	MSM_GPIO1_REG(0xB4)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_6	MSM_GPIO1_REG(0xDC)</span>
<span class="cp">#define MSM7X30_GPIO_INT_CLEAR_7	MSM_GPIO1_REG(0x230)</span>

<span class="cm">/* same pin map as above, 1=interrupt pending */</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_0	MSM_GPIO1_REG(0xA0)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_1	MSM_GPIO2_REG(0x70)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_2	MSM_GPIO1_REG(0xA4)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_3	MSM_GPIO1_REG(0xA8)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_4	MSM_GPIO1_REG(0xAC)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_5	MSM_GPIO1_REG(0xB0)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_6	MSM_GPIO1_REG(0xE0)</span>
<span class="cp">#define MSM7X30_GPIO_INT_STATUS_7	MSM_GPIO1_REG(0x234)</span>

<span class="cp">#define FIRST_GPIO_IRQ MSM_GPIO_TO_INT(0)</span>

<span class="cp">#define MSM_GPIO_BANK(soc, bank, first, last)				\</span>
<span class="cp">	{								\</span>
<span class="cp">		.regs = {						\</span>
<span class="cp">			.out =         soc##_GPIO_OUT_##bank,		\</span>
<span class="cp">			.in =          soc##_GPIO_IN_##bank,		\</span>
<span class="cp">			.int_status =  soc##_GPIO_INT_STATUS_##bank,	\</span>
<span class="cp">			.int_clear =   soc##_GPIO_INT_CLEAR_##bank,	\</span>
<span class="cp">			.int_en =      soc##_GPIO_INT_EN_##bank,	\</span>
<span class="cp">			.int_edge =    soc##_GPIO_INT_EDGE_##bank,	\</span>
<span class="cp">			.int_pos =     soc##_GPIO_INT_POS_##bank,	\</span>
<span class="cp">			.oe =          soc##_GPIO_OE_##bank,		\</span>
<span class="cp">		},							\</span>
<span class="cp">		.chip = {						\</span>
<span class="cp">			.base = (first),				\</span>
<span class="cp">			.ngpio = (last) - (first) + 1,			\</span>
<span class="cp">			.get = msm_gpio_get,				\</span>
<span class="cp">			.set = msm_gpio_set,				\</span>
<span class="cp">			.direction_input = msm_gpio_direction_input,	\</span>
<span class="cp">			.direction_output = msm_gpio_direction_output,	\</span>
<span class="cp">			.to_irq = msm_gpio_to_irq,			\</span>
<span class="cp">			.request = msm_gpio_request,			\</span>
<span class="cp">			.free = msm_gpio_free,				\</span>
<span class="cp">		}							\</span>
<span class="cp">	}</span>

<span class="cp">#define MSM_GPIO_BROKEN_INT_CLEAR 1</span>

<span class="k">struct</span> <span class="n">msm_gpio_regs</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">int_status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">int_clear</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">int_en</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">int_edge</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">int_pos</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">oe</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span>	<span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msm_gpio_regs</span>	<span class="n">regs</span><span class="p">;</span>
<span class="cp">#if MSM_GPIO_BROKEN_INT_CLEAR</span>
	<span class="kt">unsigned</span>                <span class="n">int_status_copy</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">both_edge_detect</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">int_enable</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* 0: awake, 1: sleep */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">out</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">out</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_update_both_edge_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_limit</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pol</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">intstat</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">in</span><span class="p">);</span>
		<span class="n">pol</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_pos</span><span class="p">);</span>
		<span class="n">pol</span> <span class="o">=</span> <span class="p">(</span><span class="n">pol</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">both_edge_detect</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="o">~</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">both_edge_detect</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_pos</span><span class="p">);</span>
		<span class="n">intstat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_status</span><span class="p">);</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">val</span> <span class="o">^</span> <span class="n">val2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">both_edge_detect</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">intstat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loop_limit</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;msm_gpio_update_both_edge_detect, &quot;</span>
	       <span class="s">&quot;failed to reach stable state %x != %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_clear_detect_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

<span class="cp">#if MSM_GPIO_BROKEN_INT_CLEAR</span>
	<span class="cm">/* Save interrupts that already triggered before we loose them. */</span>
	<span class="cm">/* Any interrupt that triggers between the read of int_status */</span>
	<span class="cm">/* and the write to int_clear will still be lost though. */</span>
	<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_status_copy</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_status</span><span class="p">);</span>
	<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_status_copy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_clear</span><span class="p">);</span>
	<span class="n">msm_gpio_update_both_edge_detect</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_direction_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">msm_chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">oe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">oe</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">msm_gpio_direction_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">msm_chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">msm_gpio_write</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">oe</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">oe</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">;</span>

	<span class="n">msm_chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">in</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">msm_chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">msm_gpio_write</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_to_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">MSM_GPIO_TO_INT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MSM_GPIOMUX</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msm_gpiomux_get</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msm_gpiomux_put</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define msm_gpio_request NULL</span>
<span class="cp">#define msm_gpio_free NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_gpio_chips</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msm_gpio_count</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="n">msm_gpio_chips_msm7x01</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">15</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X00</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">42</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X00</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">67</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X00</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">94</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X00</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">95</span><span class="p">,</span> <span class="mi">106</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X00</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="n">msm_gpio_chips_msm7x30</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">15</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">43</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">67</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">94</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">95</span><span class="p">,</span> <span class="mi">106</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">133</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">MSM7X30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">181</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="n">msm_gpio_chips_qsd8x50</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">15</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">42</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">67</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">94</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">95</span><span class="p">,</span> <span class="mi">103</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">152</span><span class="p">),</span>
	<span class="n">MSM_GPIO_BANK</span><span class="p">(</span><span class="n">QSD8X50</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">164</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_irq_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">msm_gpio_clear_detect_status</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">,</span>
				     <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="cm">/* level triggered interrupts are also latched */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_edge</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">)))</span>
		<span class="n">msm_gpio_clear_detect_status</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_en</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_irq_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="cm">/* level triggered interrupts are also latched */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_edge</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">)))</span>
		<span class="n">msm_gpio_clear_detect_status</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_en</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_irq_set_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msm_gpio_irq_set_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flow_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_edge</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_edge</span><span class="p">);</span>
		<span class="n">__irq_set_handler_locked</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_edge_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_edge</span><span class="p">);</span>
		<span class="n">__irq_set_handler_locked</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flow_type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">)</span> <span class="o">==</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">both_edge_detect</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">msm_gpio_update_both_edge_detect</span><span class="p">(</span><span class="n">msm_chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">both_edge_detect</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flow_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_HIGH</span><span class="p">))</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_pos</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_pos</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msm_gpio_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msm_gpio_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msm_gpio_chip</span> <span class="o">*</span><span class="n">msm_chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">int_status</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">val</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* printk(&quot;%s %08x %08x bit %d gpio %d irq %d\n&quot;,</span>
<span class="cm">				__func__, v, m, j, msm_chip-&gt;chip.start + j,</span>
<span class="cm">				FIRST_GPIO_IRQ + msm_chip-&gt;chip.start + j); */</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">FIRST_GPIO_IRQ</span> <span class="o">+</span>
					   <span class="n">msm_chip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">msm_gpio_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;msmgpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>       <span class="o">=</span> <span class="n">msm_gpio_irq_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>      <span class="o">=</span> <span class="n">msm_gpio_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>    <span class="o">=</span> <span class="n">msm_gpio_irq_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_wake</span>  <span class="o">=</span> <span class="n">msm_gpio_irq_set_wake</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>  <span class="o">=</span> <span class="n">msm_gpio_irq_set_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">msm_init_gpio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_msm7x01</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">msm_gpio_chips</span> <span class="o">=</span> <span class="n">msm_gpio_chips_msm7x01</span><span class="p">;</span>
		<span class="n">msm_gpio_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msm_gpio_chips_msm7x01</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_msm7x30</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">msm_gpio_chips</span> <span class="o">=</span> <span class="n">msm_gpio_chips_msm7x30</span><span class="p">;</span>
		<span class="n">msm_gpio_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msm_gpio_chips_msm7x30</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_qsd8x50</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">msm_gpio_chips</span> <span class="o">=</span> <span class="n">msm_gpio_chips_qsd8x50</span><span class="p">;</span>
		<span class="n">msm_gpio_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msm_gpio_chips_qsd8x50</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">FIRST_GPIO_IRQ</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIRST_GPIO_IRQ</span> <span class="o">+</span> <span class="n">NR_GPIO_IRQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">FIRST_GPIO_IRQ</span> <span class="o">&gt;=</span>
			<span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span>
			<span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chip</span><span class="p">.</span><span class="n">ngpio</span><span class="p">)</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msm_gpio_irq_chip</span><span class="p">,</span>
					 <span class="n">handle_edge_irq</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msm_gpio_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regs</span><span class="p">.</span><span class="n">int_en</span><span class="p">);</span>
		<span class="n">gpiochip_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msm_gpio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">INT_GPIO_GROUP1</span><span class="p">,</span> <span class="n">msm_gpio_irq_handler</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">INT_GPIO_GROUP2</span><span class="p">,</span> <span class="n">msm_gpio_irq_handler</span><span class="p">);</span>
	<span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="n">INT_GPIO_GROUP1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="n">INT_GPIO_GROUP2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">msm_init_gpio</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
