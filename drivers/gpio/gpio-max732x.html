<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpio › gpio-max732x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>gpio-max732x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  MAX732x I2C Port Expander with 8/16 I/O</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007 Marvell International Ltd.</span>
<span class="cm"> *  Copyright (C) 2008 Jack Ren &lt;jack.ren@marvell.com&gt;</span>
<span class="cm"> *  Copyright (C) 2008 Eric Miao &lt;eric.miao@marvell.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Derived from drivers/gpio/pca953x.c</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/max732x.h&gt;</span>


<span class="cm">/*</span>
<span class="cm"> * Each port of MAX732x (including MAX7319) falls into one of the</span>
<span class="cm"> * following three types:</span>
<span class="cm"> *</span>
<span class="cm"> *   - Push Pull Output</span>
<span class="cm"> *   - Input</span>
<span class="cm"> *   - Open Drain I/O</span>
<span class="cm"> *</span>
<span class="cm"> * designated by &#39;O&#39;, &#39;I&#39; and &#39;P&#39; individually according to MAXIM&#39;s</span>
<span class="cm"> * datasheets. &#39;I&#39; and &#39;P&#39; ports are interrupt capables, some with</span>
<span class="cm"> * a dedicated interrupt mask.</span>
<span class="cm"> *</span>
<span class="cm"> * There are two groups of I/O ports, each group usually includes</span>
<span class="cm"> * up to 8 I/O ports, and is accessed by a specific I2C address:</span>
<span class="cm"> *</span>
<span class="cm"> *   - Group A : by I2C address 0b&#39;110xxxx</span>
<span class="cm"> *   - Group B : by I2C address 0b&#39;101xxxx</span>
<span class="cm"> *</span>
<span class="cm"> * where &#39;xxxx&#39; is decided by the connections of pin AD2/AD0.  The</span>
<span class="cm"> * address used also affects the initial state of output signals.</span>
<span class="cm"> *</span>
<span class="cm"> * Within each group of ports, there are five known combinations of</span>
<span class="cm"> * I/O ports: 4I4O, 4P4O, 8I, 8P, 8O, see the definitions below for</span>
<span class="cm"> * the detailed organization of these ports. Only Goup A is interrupt</span>
<span class="cm"> * capable.</span>
<span class="cm"> *</span>
<span class="cm"> * GPIO numbers start from &#39;gpio_base + 0&#39; to &#39;gpio_base + 8/16&#39;,</span>
<span class="cm"> * and GPIOs from GROUP_A are numbered before those from GROUP_B</span>
<span class="cm"> * (if there are two groups).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: MAX7328/MAX7329 are drop-in replacements for PCF8574/a, so</span>
<span class="cm"> * they are not supported by this driver.</span>
<span class="cm"> */</span>

<span class="cp">#define PORT_NONE	0x0	</span><span class="cm">/* &#39;/&#39; No Port */</span><span class="cp"></span>
<span class="cp">#define PORT_OUTPUT	0x1	</span><span class="cm">/* &#39;O&#39; Push-Pull, Output Only */</span><span class="cp"></span>
<span class="cp">#define PORT_INPUT	0x2	</span><span class="cm">/* &#39;I&#39; Input Only */</span><span class="cp"></span>
<span class="cp">#define PORT_OPENDRAIN	0x3	</span><span class="cm">/* &#39;P&#39; Open-Drain, I/O */</span><span class="cp"></span>

<span class="cp">#define IO_4I4O		0x5AA5	</span><span class="cm">/* O7 O6 I5 I4 I3 I2 O1 O0 */</span><span class="cp"></span>
<span class="cp">#define IO_4P4O		0x5FF5	</span><span class="cm">/* O7 O6 P5 P4 P3 P2 O1 O0 */</span><span class="cp"></span>
<span class="cp">#define IO_8I		0xAAAA	</span><span class="cm">/* I7 I6 I5 I4 I3 I2 I1 I0 */</span><span class="cp"></span>
<span class="cp">#define IO_8P		0xFFFF	</span><span class="cm">/* P7 P6 P5 P4 P3 P2 P1 P0 */</span><span class="cp"></span>
<span class="cp">#define IO_8O		0x5555	</span><span class="cm">/* O7 O6 O5 O4 O3 O2 O1 O0 */</span><span class="cp"></span>

<span class="cp">#define GROUP_A(x)	((x) &amp; 0xffff)	</span><span class="cm">/* I2C Addr: 0b&#39;110xxxx */</span><span class="cp"></span>
<span class="cp">#define GROUP_B(x)	((x) &lt;&lt; 16)	</span><span class="cm">/* I2C Addr: 0b&#39;101xxxx */</span><span class="cp"></span>

<span class="cp">#define INT_NONE	0x0	</span><span class="cm">/* No interrupt capability */</span><span class="cp"></span>
<span class="cp">#define INT_NO_MASK	0x1	</span><span class="cm">/* Has interrupts, no mask */</span><span class="cp"></span>
<span class="cp">#define INT_INDEP_MASK	0x2	</span><span class="cm">/* Has interrupts, independent mask */</span><span class="cp"></span>
<span class="cp">#define INT_MERGED_MASK 0x3	</span><span class="cm">/* Has interrupts, merged mask */</span><span class="cp"></span>

<span class="cp">#define INT_CAPS(x)	(((uint64_t)(x)) &lt;&lt; 32)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MAX7319</span><span class="p">,</span>
	<span class="n">MAX7320</span><span class="p">,</span>
	<span class="n">MAX7321</span><span class="p">,</span>
	<span class="n">MAX7322</span><span class="p">,</span>
	<span class="n">MAX7323</span><span class="p">,</span>
	<span class="n">MAX7324</span><span class="p">,</span>
	<span class="n">MAX7325</span><span class="p">,</span>
	<span class="n">MAX7326</span><span class="p">,</span>
	<span class="n">MAX7327</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">max732x_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MAX7319</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_8I</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_MERGED_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7320</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_B</span><span class="p">(</span><span class="n">IO_8O</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7321</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_8P</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_NO_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7322</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_4I4O</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_MERGED_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7323</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_4P4O</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_INDEP_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7324</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_8I</span><span class="p">)</span> <span class="o">|</span> <span class="n">GROUP_B</span><span class="p">(</span><span class="n">IO_8O</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_MERGED_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7325</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_8P</span><span class="p">)</span> <span class="o">|</span> <span class="n">GROUP_B</span><span class="p">(</span><span class="n">IO_8O</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_NO_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7326</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_4I4O</span><span class="p">)</span> <span class="o">|</span> <span class="n">GROUP_B</span><span class="p">(</span><span class="n">IO_8O</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_MERGED_MASK</span><span class="p">),</span>
	<span class="p">[</span><span class="n">MAX7327</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP_A</span><span class="p">(</span><span class="n">IO_4P4O</span><span class="p">)</span> <span class="o">|</span> <span class="n">GROUP_B</span><span class="p">(</span><span class="n">IO_8O</span><span class="p">)</span> <span class="o">|</span> <span class="n">INT_CAPS</span><span class="p">(</span><span class="n">INT_NO_MASK</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">max732x_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;max7319&quot;</span><span class="p">,</span> <span class="n">MAX7319</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7320&quot;</span><span class="p">,</span> <span class="n">MAX7320</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7321&quot;</span><span class="p">,</span> <span class="n">MAX7321</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7322&quot;</span><span class="p">,</span> <span class="n">MAX7322</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7323&quot;</span><span class="p">,</span> <span class="n">MAX7323</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7324&quot;</span><span class="p">,</span> <span class="n">MAX7324</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7325&quot;</span><span class="p">,</span> <span class="n">MAX7325</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7326&quot;</span><span class="p">,</span> <span class="n">MAX7326</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max7327&quot;</span><span class="p">,</span> <span class="n">MAX7327</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">max732x_id</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span> <span class="n">gpio_chip</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>	<span class="cm">/* &quot;main&quot; client */</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client_dummy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client_group_a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client_group_b</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">mask_group_a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">dir_input</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">dir_output</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">reg_out</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_GPIO_MAX732X_IRQ</span>
	<span class="k">struct</span> <span class="n">mutex</span>	<span class="n">irq_lock</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">irq_base</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">irq_mask</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">irq_mask_cur</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">irq_trig_raise</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">irq_trig_fall</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">irq_features</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_writeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group_a</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">group_a</span> <span class="o">?</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_b</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed writing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_readb</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group_a</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">group_a</span> <span class="o">?</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_b</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed reading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_group_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mask_group_a</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_gpio_get_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max732x_chip</span><span class="p">,</span> <span class="n">gpio_chip</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">max732x_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">is_group_a</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">off</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">reg_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_gpio_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reg_out</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max732x_chip</span><span class="p">,</span> <span class="n">gpio_chip</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">reg_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">reg_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="n">reg_out</span> <span class="o">|</span> <span class="n">mask</span> <span class="o">:</span> <span class="n">reg_out</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">max732x_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">is_group_a</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">off</span><span class="p">),</span> <span class="n">reg_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* update the shadow register then */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_out</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_out</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_gpio_direction_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max732x_chip</span><span class="p">,</span> <span class="n">gpio_chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s port %d is output only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Open-drain pins must be set to high impedance (which is</span>
<span class="cm">	 * equivalent to output-high) to be turned into an input.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_output</span><span class="p">))</span>
		<span class="n">max732x_gpio_set_value</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_gpio_direction_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max732x_chip</span><span class="p">,</span> <span class="n">gpio_chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s port %d is input only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max732x_gpio_set_value</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_GPIO_MAX732X_IRQ</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_writew</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed writing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_readw</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed reading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_update_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_cur</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_cur</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_features</span> <span class="o">==</span> <span class="n">INT_NO_MASK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_features</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_INDEP_MASK</span>:
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">max732x_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INT_MERGED_MASK</span>:
		<span class="n">msg</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">max732x_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_gpio_to_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max732x_chip</span><span class="p">,</span> <span class="n">gpio_chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_cur</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_cur</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_bus_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_cur</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_bus_sync_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">max732x_irq_update_mask</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_irq_set_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">off</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_input</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s port %d is output only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d: unsupported type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_trig_fall</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_trig_fall</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_trig_raise</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_trig_raise</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">max732x_gpio_direction_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">max732x_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;max732x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>		<span class="o">=</span> <span class="n">max732x_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>		<span class="o">=</span> <span class="n">max732x_irq_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_bus_lock</span>		<span class="o">=</span> <span class="n">max732x_irq_bus_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_bus_sync_unlock</span>	<span class="o">=</span> <span class="n">max732x_irq_bus_sync_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>		<span class="o">=</span> <span class="n">max732x_irq_set_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">max732x_irq_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">cur_stat</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">old_stat</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">trigger</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">max732x_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trigger</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">trigger</span> <span class="o">&amp;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trigger</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cur_stat</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">cur_stat</span> <span class="o">&amp;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>

	<span class="n">old_stat</span> <span class="o">=</span> <span class="n">cur_stat</span> <span class="o">^</span> <span class="n">trigger</span><span class="p">;</span>

	<span class="n">pending</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_stat</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_trig_fall</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">cur_stat</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_trig_raise</span><span class="p">);</span>
	<span class="n">pending</span> <span class="o">&amp;=</span> <span class="n">trigger</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">max732x_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">pending</span> <span class="o">=</span> <span class="n">max732x_irq_pending</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>
		<span class="n">handle_nested_irq</span><span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

		<span class="n">pending</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_irq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max732x_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_irq</span> <span class="o">=</span> <span class="n">max732x_features</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">&amp;&amp;</span> <span class="n">has_irq</span> <span class="o">!=</span> <span class="n">INT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lvl</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_features</span> <span class="o">=</span> <span class="n">has_irq</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">lvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lvl</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">.</span><span class="n">ngpio</span><span class="p">;</span> <span class="n">lvl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">lvl</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_input</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lvl</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max732x_irq_chip</span><span class="p">,</span>
						 <span class="n">handle_edge_irq</span><span class="p">);</span>
			<span class="n">irq_set_nested_thread</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ARM</span>
			<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">irq_set_noprobe</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">,</span>
					   <span class="n">max732x_irq_handler</span><span class="p">,</span>
					   <span class="n">IRQF_TRIGGER_FALLING</span> <span class="o">|</span> <span class="n">IRQF_ONESHOT</span><span class="p">,</span>
					   <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">.</span><span class="n">to_irq</span> <span class="o">=</span> <span class="n">max732x_gpio_to_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_failed:</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_GPIO_MAX732X_IRQ */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">max732x_irq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max732x_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_irq</span> <span class="o">=</span> <span class="n">max732x_features</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">&amp;&amp;</span> <span class="n">has_irq</span> <span class="o">!=</span> <span class="n">INT_NONE</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt support not compiled in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max732x_irq_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">max732x_setup_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="n">gpio_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">id_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">max732x_features</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">id_data</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">id_data</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_OUTPUT</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_output</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_INPUT</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_input</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_OPENDRAIN</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_output</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_input</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mask_group_a</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">port</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_input</span><span class="p">)</span>
		<span class="n">gc</span><span class="o">-&gt;</span><span class="n">direction_input</span> <span class="o">=</span> <span class="n">max732x_gpio_direction_input</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dir_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gc</span><span class="o">-&gt;</span><span class="n">direction_output</span> <span class="o">=</span> <span class="n">max732x_gpio_direction_output</span><span class="p">;</span>
		<span class="n">gc</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">max732x_gpio_set_value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">max732x_gpio_get_value</span><span class="p">;</span>
	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">can_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">gpio_start</span><span class="p">;</span>
	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">ngpio</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">label</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">max732x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">addr_a</span><span class="p">,</span> <span class="n">addr_b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">nr_port</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">max732x_chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">nr_port</span> <span class="o">=</span> <span class="n">max732x_setup_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_base</span><span class="p">);</span>

	<span class="n">addr_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">addr_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x50</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x60</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_port</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr_b</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_b</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_dummy</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x50</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_b</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_port</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr_a</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_group_a</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_dummy</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid I2C address specified %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">max732x_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">is_group_a</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_port</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">max732x_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">is_group_a</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">max732x_irq_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpiochip_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">.</span><span class="n">ngpio</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_failed:</span>
	<span class="n">max732x_irq_teardown</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">max732x_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max732x_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max732x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">.</span><span class="n">ngpio</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="s">&quot;teardown&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio_chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="s">&quot;gpiochip_remove()&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max732x_irq_teardown</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* unregister any dummy i2c_client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_dummy</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client_dummy</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">max732x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;max732x&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">max732x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">max732x_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">max732x_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">max732x_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max732x_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* register after i2c postcore initcall and before</span>
<span class="cm"> * subsys initcalls that may rely on these GPIOs</span>
<span class="cm"> */</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">max732x_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">max732x_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max732x_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">max732x_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eric Miao &lt;eric.miao@marvell.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;GPIO expander driver for MAX732X&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
