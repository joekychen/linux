<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › xen › evtchn.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>evtchn.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * evtchn.c</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for receiving and demuxing event-channel signals.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004-2005, K A Fraser</span>
<span class="cm"> * Multi-process extensions Copyright (c) 2004, Steven Smith</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation; or, when distributed</span>
<span class="cm"> * separately from the Linux kernel or incorporated into other</span>
<span class="cm"> * software packages, subject to the following license:</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm"> * of this source file (the &quot;Software&quot;), to deal in the Software without</span>
<span class="cm"> * restriction, including without limitation the rights to use, copy, modify,</span>
<span class="cm"> * merge, publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="cm"> * and to permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>

<span class="cp">#include &lt;xen/xen.h&gt;</span>
<span class="cp">#include &lt;xen/events.h&gt;</span>
<span class="cp">#include &lt;xen/evtchn.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>

<span class="k">struct</span> <span class="n">per_user_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">bind_mutex</span><span class="p">;</span> <span class="cm">/* serialize bind/unbind operations */</span>

	<span class="cm">/* Notification ring, accessed via /dev/xen/evtchn. */</span>
<span class="cp">#define EVTCHN_RING_SIZE     (PAGE_SIZE / sizeof(evtchn_port_t))</span>
<span class="cp">#define EVTCHN_RING_MASK(_i) ((_i)&amp;(EVTCHN_RING_SIZE-1))</span>
	<span class="n">evtchn_port_t</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ring_cons</span><span class="p">,</span> <span class="n">ring_prod</span><span class="p">,</span> <span class="n">ring_overflow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">ring_cons_mutex</span><span class="p">;</span> <span class="cm">/* protect against concurrent readers */</span>

	<span class="cm">/* Processes wait on this queue when ring is empty. */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">evtchn_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fasync_struct</span> <span class="o">*</span><span class="n">evtchn_async_queue</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Who&#39;s bound to each port?  This is logically an array of struct</span>
<span class="cm"> * per_user_data *, but we encode the current enabled-state in bit 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">port_user</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">port_user_lock</span><span class="p">);</span> <span class="cm">/* protects port_user[] and ring_prod */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="nf">get_port_user</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="p">)(</span><span class="n">port_user</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_port_user</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">port_user</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">u</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">get_port_enabled</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">port_user</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_port_enabled</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">port_user</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port_user</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">evtchn_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="n">u</span> <span class="o">=</span> <span class="n">get_port_user</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">get_port_enabled</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
	     <span class="s">&quot;Interrupt for port %d, but apparently not enabled; per-user %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">port</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>

	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">set_port_enabled</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span> <span class="o">-</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EVTCHN_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">EVTCHN_RING_MASK</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span><span class="p">)]</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span> <span class="cm">/* Ensure ring contents visible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span> <span class="o">==</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">evtchn_wait</span><span class="p">);</span>
			<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">evtchn_async_queue</span><span class="p">,</span>
				    <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">evtchn_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">bytes1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytes2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Whole number of ports. */</span>
	<span class="n">count</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons_mutex</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_overflow</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock_out</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">evtchn_wait</span><span class="p">,</span>
					      <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span> <span class="o">!=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Byte lengths of two chunks. Chunk split (if any) is at ring wrap. */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">c</span> <span class="o">^</span> <span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EVTCHN_RING_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes1</span> <span class="o">=</span> <span class="p">(</span><span class="n">EVTCHN_RING_SIZE</span> <span class="o">-</span> <span class="n">EVTCHN_RING_MASK</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">);</span>
		<span class="n">bytes2</span> <span class="o">=</span> <span class="n">EVTCHN_RING_MASK</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bytes1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">);</span>
		<span class="n">bytes2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Truncate chunks according to caller&#39;s maximum byte count. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes1</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes1</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">bytes2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bytes1</span> <span class="o">+</span> <span class="n">bytes2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes2</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">bytes1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">rmb</span><span class="p">();</span> <span class="cm">/* Ensure that we see the port before we copy it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">EVTCHN_RING_MASK</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span> <span class="n">bytes1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">bytes2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">bytes1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bytes2</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">unlock_out</span><span class="p">;</span>

	<span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bytes1</span> <span class="o">+</span> <span class="n">bytes2</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bytes1</span> <span class="o">+</span> <span class="n">bytes2</span><span class="p">;</span>

 <span class="nl">unlock_out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">evtchn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">evtchn_port_t</span> <span class="o">*</span><span class="n">kbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">evtchn_port_t</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Whole number of ports. */</span>
	<span class="n">count</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evtchn_port_t</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">port</span> <span class="o">=</span> <span class="n">kbuf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;</span> <span class="n">NR_EVENT_CHANNELS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">get_port_user</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">u</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">get_port_enabled</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_port_enabled</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq_from_evtchn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evtchn_bind_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ports are never reused, so every caller should pass in a</span>
<span class="cm">	 * unique port.</span>
<span class="cm">	 *</span>
<span class="cm">	 * (Locking not necessary because we haven&#39;t registered the</span>
<span class="cm">	 * interrupt handler yet, and our caller has already</span>
<span class="cm">	 * serialized bind operations.)</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">get_port_user</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">set_port_user</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
	<span class="n">set_port_enabled</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="cm">/* start enabled */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bind_evtchn_to_irqhandler</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">evtchn_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
				       <span class="n">u</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">evtchn_make_refcounted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">evtchn_unbind_from_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">irq_from_evtchn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">unbind_from_irqhandler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">port</span><span class="p">);</span>

	<span class="n">set_port_user</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">evtchn_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Prevent bind from racing with unbind */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bind_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCTL_EVTCHN_BIND_VIRQ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioctl_evtchn_bind_virq</span> <span class="n">bind</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">evtchn_bind_virq</span> <span class="n">bind_virq</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bind</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bind</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bind_virq</span><span class="p">.</span><span class="n">virq</span> <span class="o">=</span> <span class="n">bind</span><span class="p">.</span><span class="n">virq</span><span class="p">;</span>
		<span class="n">bind_virq</span><span class="p">.</span><span class="n">vcpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_event_channel_op</span><span class="p">(</span><span class="n">EVTCHNOP_bind_virq</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">bind_virq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">evtchn_bind_to_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">bind_virq</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bind_virq</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_EVTCHN_BIND_INTERDOMAIN</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioctl_evtchn_bind_interdomain</span> <span class="n">bind</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">evtchn_bind_interdomain</span> <span class="n">bind_interdomain</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bind</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bind</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bind_interdomain</span><span class="p">.</span><span class="n">remote_dom</span>  <span class="o">=</span> <span class="n">bind</span><span class="p">.</span><span class="n">remote_domain</span><span class="p">;</span>
		<span class="n">bind_interdomain</span><span class="p">.</span><span class="n">remote_port</span> <span class="o">=</span> <span class="n">bind</span><span class="p">.</span><span class="n">remote_port</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_event_channel_op</span><span class="p">(</span><span class="n">EVTCHNOP_bind_interdomain</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">bind_interdomain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">evtchn_bind_to_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">bind_interdomain</span><span class="p">.</span><span class="n">local_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bind_interdomain</span><span class="p">.</span><span class="n">local_port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_EVTCHN_BIND_UNBOUND_PORT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioctl_evtchn_bind_unbound_port</span> <span class="n">bind</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">evtchn_alloc_unbound</span> <span class="n">alloc_unbound</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bind</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bind</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">alloc_unbound</span><span class="p">.</span><span class="n">dom</span>        <span class="o">=</span> <span class="n">DOMID_SELF</span><span class="p">;</span>
		<span class="n">alloc_unbound</span><span class="p">.</span><span class="n">remote_dom</span> <span class="o">=</span> <span class="n">bind</span><span class="p">.</span><span class="n">remote_domain</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_event_channel_op</span><span class="p">(</span><span class="n">EVTCHNOP_alloc_unbound</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">alloc_unbound</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">evtchn_bind_to_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">alloc_unbound</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_unbound</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_EVTCHN_UNBIND</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioctl_evtchn_unbind</span> <span class="n">unbind</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unbind</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">unbind</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unbind</span><span class="p">.</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="n">NR_EVENT_CHANNELS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_port_user</span><span class="p">(</span><span class="n">unbind</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq_from_evtchn</span><span class="p">(</span><span class="n">unbind</span><span class="p">.</span><span class="n">port</span><span class="p">));</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

		<span class="n">evtchn_unbind_from_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">unbind</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_EVTCHN_NOTIFY</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioctl_evtchn_notify</span> <span class="n">notify</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notify</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">notify</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="n">NR_EVENT_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_port_user</span><span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">notify_remote_via_evtchn</span><span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_EVTCHN_RESET</span>: <span class="p">{</span>
		<span class="cm">/* Initialise the ring to empty. Clear errors. */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons_mutex</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>
		<span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons_mutex</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bind_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">evtchn_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">evtchn_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons</span> <span class="o">!=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_prod</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_overflow</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evtchn_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fasync_helper</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">evtchn_async_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evtchn_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>

	<span class="n">u</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">u</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;evtchn:%s&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">evtchn_wait</span><span class="p">);</span>

	<span class="n">u</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="n">evtchn_port_t</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bind_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring_cons_mutex</span><span class="p">);</span>

	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evtchn_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">per_user_data</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_EVENT_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_port_user</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq_from_evtchn</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_EVENT_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_port_user</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">evtchn_unbind_from_user</span><span class="p">(</span><span class="n">get_port_user</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">evtchn_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">evtchn_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">evtchn_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">evtchn_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>    <span class="o">=</span> <span class="n">evtchn_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span>  <span class="o">=</span> <span class="n">evtchn_fasync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">evtchn_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">evtchn_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">evtchn_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span>        <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>         <span class="o">=</span> <span class="s">&quot;xen/evtchn&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">evtchn_fops</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">evtchn_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">port_user</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">NR_EVENT_CHANNELS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">port_user</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_user_lock</span><span class="p">);</span>

	<span class="cm">/* Create &#39;/dev/misc/evtchn&#39;. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evtchn_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;Could not register /dev/misc/evtchn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Event-channel device installed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">evtchn_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port_user</span><span class="p">);</span>
	<span class="n">port_user</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evtchn_miscdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">evtchn_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">evtchn_cleanup</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
