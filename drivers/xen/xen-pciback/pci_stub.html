<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › xen › xen-pciback › pci_stub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci_stub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PCI Stub Driver - Grabs devices in backend to be exported later</span>
<span class="cm"> *</span>
<span class="cm"> * Ryan Wilson &lt;hap9@epoch.ncsc.mil&gt;</span>
<span class="cm"> * Chris Bookholt &lt;hap10@epoch.ncsc.mil&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/rwsem.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;xen/events.h&gt;</span>
<span class="cp">#include &lt;asm/xen/pci.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>
<span class="cp">#include &quot;pciback.h&quot;</span>
<span class="cp">#include &quot;conf_space.h&quot;</span>
<span class="cp">#include &quot;conf_space_quirks.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_devs_to_hide</span><span class="p">;</span>
<span class="n">wait_queue_head_t</span> <span class="n">xen_pcibk_aer_wait_queue</span><span class="p">;</span>
<span class="cm">/*Add sem for sync AER handling and xen_pcibk remove/reconfigue ops,</span>
<span class="cm">* We want to avoid in middle of AER ops, xen_pcibk devices is being removed</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">pcistub_sem</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="n">pci_devs_to_hide</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pcistub_device_id</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">slot_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pcistub_device_ids</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">device_ids_lock</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dev_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span><span class="cm">/* non-NULL if struct pci_dev is in use */</span>
<span class="p">};</span>

<span class="cm">/* Access to pcistub_devices &amp; seized_devices lists and the initialize_devices</span>
<span class="cm"> * flag must be locked with pcistub_devices_lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pcistub_devices_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pcistub_devices</span><span class="p">);</span>

<span class="cm">/* wait for device_initcall before initializing our devices</span>
<span class="cm"> * (see pcistub_init_devices_late)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">initialize_devices</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">seized_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="nf">pcistub_device_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pcistub_device_alloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">psdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psdev</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">psdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Don&#39;t call this directly as it&#39;s called by pcistub_device_put */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcistub_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>

	<span class="n">psdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pcistub_device</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="n">dev_data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pcistub_device_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">xen_unregister_device_domain_owner</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Call the reset function which does not take lock as this</span>
<span class="cm">	 * is called from &quot;unbind&quot; which takes a device_lock mutex.</span>
<span class="cm">	 */</span>
	<span class="n">__pci_reset_function_locked</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_load_and_free_saved_state</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not reload PCI state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable the device */</span>
	<span class="n">xen_pcibk_reset_device</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_data</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Clean-up the device */</span>
	<span class="n">xen_pcibk_config_free_dyn_fields</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">xen_pcibk_config_free_dev</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_DEV_FLAGS_ASSIGNED</span><span class="p">;</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pcistub_device_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pcistub_device_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">pcistub_device_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="nf">pcistub_device_find</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span>
		    <span class="o">&amp;&amp;</span> <span class="n">domain</span> <span class="o">==</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">bus</span> <span class="o">==</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span>
		    <span class="o">&amp;&amp;</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcistub_device_get</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* didn&#39;t find it */</span>
	<span class="n">psdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">psdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">pcistub_device_get_pci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_pcibk_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pcistub_device_get</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
		<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_dev</span><span class="p">)</span>
		<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">pcistub_get_pci_dev_by_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_pcibk_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">found_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span>
		    <span class="o">&amp;&amp;</span> <span class="n">domain</span> <span class="o">==</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">bus</span> <span class="o">==</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span>
		    <span class="o">&amp;&amp;</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found_dev</span> <span class="o">=</span> <span class="n">pcistub_device_get_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">psdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">pcistub_get_pci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_pcibk_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">found_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found_dev</span> <span class="o">=</span> <span class="n">pcistub_device_get_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">psdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pcistub_put_pci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">,</span> <span class="o">*</span><span class="n">found_psdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found_psdev</span> <span class="o">=</span> <span class="n">psdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">found_psdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*hold this lock for avoiding breaking link between</span>
<span class="cm">	* pcistub and xen_pcibk when AER is in processing</span>
<span class="cm">	*/</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="cm">/* Cleanup our device</span>
<span class="cm">	 * (so it&#39;s ready for the next domain)</span>
<span class="cm">	 */</span>

	<span class="cm">/* This is OK - we are running from workqueue context</span>
<span class="cm">	 * and want to inhibit the user from fiddling with &#39;reset&#39;</span>
<span class="cm">	 */</span>
	<span class="n">pci_reset_function</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* This disables the device. */</span>
	<span class="n">xen_pcibk_reset_device</span><span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* And cleanup up our emulated fields. */</span>
	<span class="n">xen_pcibk_config_free_dyn_fields</span><span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">xen_pcibk_config_reset_dev</span><span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">xen_unregister_device_domain_owner</span><span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">found_psdev</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcistub_match_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pcistub_device_id</span> <span class="o">*</span><span class="n">pdev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Match the specified device by domain, bus, slot, func and also if</span>
<span class="cm">	 * any of the device&#39;s parent bridges match.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="o">==</span> <span class="n">pdev_id</span><span class="o">-&gt;</span><span class="n">domain</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">pdev_id</span><span class="o">-&gt;</span><span class="n">bus</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="n">pdev_id</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Sometimes topmost bridge links to itself. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcistub_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device_id</span> <span class="o">*</span><span class="n">pdev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pdev_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_device_ids</span><span class="p">,</span> <span class="n">slot_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcistub_match_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcistub_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initializing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* The PCI backend is not intended to be a module (or to work with</span>
<span class="cm">	 * removable PCI devices (yet). If it were, xen_pcibk_config_free()</span>
<span class="cm">	 * would need to be called somewhere to free the memory allocated</span>
<span class="cm">	 * here and then to call kfree(pci_get_drvdata(psdev-&gt;dev)).</span>
<span class="cm">	 */</span>
	<span class="n">dev_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev_data</span><span class="p">)</span> <span class="o">+</span>  <span class="n">strlen</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;[]&quot;</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup name for fake IRQ handler. It will only be enabled</span>
<span class="cm">	 * once the device is turned on by the guest.</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initializing config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_aer_wait_queue</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xen_pcibk_config_init_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* HACK: Force device (&amp; ACPI) to determine what IRQ it&#39;s on - we</span>
<span class="cm">	 * must do this here because pcibios_enable_device may specify</span>
<span class="cm">	 * the pci device&#39;s true irq (and possibly its other resources)</span>
<span class="cm">	 * if they differ from what&#39;s in the configuration space.</span>
<span class="cm">	 * This makes the assumption that the device&#39;s resources won&#39;t</span>
<span class="cm">	 * change after this point (otherwise this code may break!)</span>
<span class="cm">	 */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">config_release</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reseting (FLR, D3, etc) the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">__pci_reset_function_locked</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We need the device active to save the state. */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;save state of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span> <span class="o">=</span> <span class="n">pci_store_saved_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">pci_saved_state</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not store PCI conf saved state!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Now disable the device (this also ensures some private device</span>
<span class="cm">	 * data is setup before we export)</span>
<span class="cm">	 */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">xen_pcibk_reset_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PCI_DEV_FLAGS_ASSIGNED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">config_release:</span>
	<span class="n">xen_pcibk_config_free_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Because some initialization still happens on</span>
<span class="cm"> * devices during fs_initcall, we need to defer</span>
<span class="cm"> * full initialization of our devices until</span>
<span class="cm"> * device_initcall.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pcistub_init_devices_late</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: pcistub_init_devices_late</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seized_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">seized_devices</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pcistub_device</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_init_device</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;error %d initializing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
			<span class="n">psdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">initialize_devices</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcistub_seize</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialize_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* don&#39;t want irqs disabled when calling pcistub_init_device */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_init_device</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;deferring initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seized_devices</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcistub_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcistub_match</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">!=</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">!=</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t export pci devices that &quot;</span>
				<span class="s">&quot;don&#39;t have a normal (0) or bridge (1) &quot;</span>
				<span class="s">&quot;header type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;seizing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_seize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Didn&#39;t find the device */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcistub_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">,</span> <span class="o">*</span><span class="n">found_psdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;removing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">xen_pcibk_config_quirk_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found_psdev</span> <span class="o">=</span> <span class="n">psdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found_psdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found device to remove - in use? %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ****** removing device &quot;</span>
			       <span class="s">&quot;%s while still in-use! ******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ****** driver domain may&quot;</span>
			       <span class="s">&quot; still access this device&#39;s i/o resources!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ****** shutdown driver &quot;</span>
			       <span class="s">&quot;domain before binding device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ****** to other drivers &quot;</span>
			       <span class="s">&quot;or domains</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">xen_pcibk_release_pci_dev</span><span class="p">(</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">found_psdev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* the final put for releasing from the list */</span>
		<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">found_psdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcistub_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="cp">#define PCI_NODENAME_MAX 40</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kill_domain_by_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xenbus_transaction</span> <span class="n">xbt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nodename</span><span class="p">[</span><span class="n">PCI_NODENAME_MAX</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">nodename</span><span class="p">,</span> <span class="n">PCI_NODENAME_MAX</span><span class="p">,</span> <span class="s">&quot;/local/domain/0/backend/pci/%d/0&quot;</span><span class="p">,</span>
		<span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">xdev</span><span class="o">-&gt;</span><span class="n">otherend_id</span><span class="p">);</span>

<span class="nl">again:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_transaction_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xbt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;error %d when start xenbus transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*PV AER handlers will set this flag*/</span>
	<span class="n">xenbus_printf</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="n">nodename</span><span class="p">,</span> <span class="s">&quot;aerState&quot;</span> <span class="p">,</span> <span class="s">&quot;aerfail&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_transaction_end</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;error %d when end xenbus transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* For each aer recovery step error_detected, mmio_enabled, etc, front_end and</span>
<span class="cm"> * backend need to have cooperation. In xen_pcibk, those steps will do similar</span>
<span class="cm"> * jobs: send service request and waiting for front_end response.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">common_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">,</span>
				       <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aer_cmd</span><span class="p">,</span>
				       <span class="n">pci_ers_result_t</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_ers_result_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcie_aer_op</span> <span class="o">*</span><span class="n">aer_op</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*with PV AER drivers*/</span>
	<span class="n">aer_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">aer_op</span><span class="p">);</span>
	<span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">aer_cmd</span> <span class="p">;</span>
	<span class="cm">/*useful for error_detected callback*/</span>
	<span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="cm">/*pcifront_end BDF*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xen_pcibk_get_pcifront_dev</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DRV_NAME</span> <span class="s">&quot;: failed to get pcifront device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DRV_NAME</span> <span class="s">&quot;: aer_op %x dom %x bus %x devfn %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">aer_cmd</span><span class="p">,</span> <span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="cm">/*local flag to mark there&#39;s aer request, xen_pcibk callback will use</span>
<span class="cm">	* this flag to judge whether we need to check pci-front give aer</span>
<span class="cm">	* service ack signal</span>
<span class="cm">	*/</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">_PCIB_op_pending</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*It is possible that a pcifront conf_read_write ops request invokes</span>
<span class="cm">	* the callback which cause the spurious execution of wake_up.</span>
<span class="cm">	* Yet it is harmless and better than a spinlock here</span>
<span class="cm">	*/</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_active</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">notify_remote_via_irq</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">evtchn_irq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">xen_pcibk_aer_wait_queue</span><span class="p">,</span>
				 <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_active</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
				 <span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)),</span> <span class="mi">300</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_active</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pcifront aer process not responding!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_active</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_NONE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">_PCIB_op_pending</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIF_active</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;schedule pci_conf service in &quot;</span> <span class="n">DRV_NAME</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xen_pcibk_test_and_schedule_op</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_ers_result_t</span><span class="p">)</span><span class="n">aer_op</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* xen_pcibk_slot_reset: it will send the slot_reset request to  pcifront in case</span>
<span class="cm">* of the device driver could provide this service, and then wait for pcifront</span>
<span class="cm">* ack.</span>
<span class="cm">* @dev: pointer to PCI devices</span>
<span class="cm">* return value is used by aer_core do_recovery policy</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">xen_pcibk_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="n">pci_ers_result_t</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xen_pcibk_slot_reset(bus:%x,devfn:%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DRV_NAME</span> <span class="s">&quot; device is not found/assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; device is not connected or owned&quot;</span>
			<span class="s">&quot; by HVM, kill it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_AERHANDLER</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;guest with no AER driver should have been killed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">common_process</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">XEN_PCI_OP_aer_slotreset</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">PCI_ERS_RESULT_NONE</span> <span class="o">||</span>
		<span class="n">result</span> <span class="o">==</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;No AER slot_reset service or disconnected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">release:</span>
	<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*xen_pcibk_mmio_enabled: it will send the mmio_enabled request to  pcifront</span>
<span class="cm">* in case of the device driver could provide this service, and then wait</span>
<span class="cm">* for pcifront ack</span>
<span class="cm">* @dev: pointer to PCI devices</span>
<span class="cm">* return value is used by aer_core do_recovery policy</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">xen_pcibk_mmio_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="n">pci_ers_result_t</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xen_pcibk_mmio_enabled(bus:%x,devfn:%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DRV_NAME</span> <span class="s">&quot; device is not found/assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; device is not connected or owned&quot;</span>
			<span class="s">&quot; by HVM, kill it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_AERHANDLER</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;guest with no AER driver should have been killed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">common_process</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">XEN_PCI_OP_aer_mmio</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">PCI_ERS_RESULT_NONE</span> <span class="o">||</span>
		<span class="n">result</span> <span class="o">==</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;No AER mmio_enabled service or disconnected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">release:</span>
	<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*xen_pcibk_error_detected: it will send the error_detected request to  pcifront</span>
<span class="cm">* in case of the device driver could provide this service, and then wait</span>
<span class="cm">* for pcifront ack.</span>
<span class="cm">* @dev: pointer to PCI devices</span>
<span class="cm">* @error: the current PCI connection state</span>
<span class="cm">* return value is used by aer_core do_recovery policy</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">xen_pcibk_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">pci_channel_state_t</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="n">pci_ers_result_t</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xen_pcibk_error_detected(bus:%x,devfn:%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DRV_NAME</span> <span class="s">&quot; device is not found/assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; device is not connected or owned&quot;</span>
			<span class="s">&quot; by HVM, kill it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*Guest owns the device yet no aer handler regiested, kill guest*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_AERHANDLER</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;guest may have no aer driver, kill it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">common_process</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">XEN_PCI_OP_aer_detected</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">PCI_ERS_RESULT_NONE</span> <span class="o">||</span>
		<span class="n">result</span> <span class="o">==</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;No AER error_detected service or disconnected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">release:</span>
	<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*xen_pcibk_error_resume: it will send the error_resume request to  pcifront</span>
<span class="cm">* in case of the device driver could provide this service, and then wait</span>
<span class="cm">* for pcifront ack.</span>
<span class="cm">* @dev: pointer to PCI devices</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_pcibk_error_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xen_pcibk_error_resume(bus:%x,devfn:%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DRV_NAME</span> <span class="s">&quot; device is not found/assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; device is not connected or owned&quot;</span>
			<span class="s">&quot; by HVM, kill it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">_XEN_PCIB_AERHANDLER</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;guest with no AER driver should have been killed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_domain_by_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">common_process</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">XEN_PCI_OP_aer_resume</span><span class="p">,</span>
		       <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">);</span>
<span class="nl">release:</span>
	<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_sem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*add xen_pcibk AER handling*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">xen_pcibk_error_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">xen_pcibk_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmio_enabled</span> <span class="o">=</span> <span class="n">xen_pcibk_mmio_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">xen_pcibk_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">xen_pcibk_error_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Note: There is no MODULE_DEVICE_TABLE entry here because this isn&#39;t</span>
<span class="cm"> * for a normal device. I don&#39;t want it to be loaded automatically.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">xen_pcibk_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* The name should be xen_pciback, but until the tools are updated</span>
<span class="cm">	 * we will keep it as pciback. */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pciback&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pcistub_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pcistub_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pcistub_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xen_pcibk_error_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">str_to_slot</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; %x:%x:%x.%x&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* try again without domain */</span>
	<span class="o">*</span><span class="n">domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; %x:%x.%x&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">str_to_quirk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span>
			       <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; %04x:%02x:%02x.%d-%08x:%1x:%08x&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		   <span class="n">func</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcistub_device_id_add</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device_id</span> <span class="o">*</span><span class="n">pci_dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pci_dev_id</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pci_dev_id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_dev_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: wants to seize %04x:%02x:%02x.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">slot_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_device_ids</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcistub_device_id_remove</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device_id</span> <span class="o">*</span><span class="n">pci_dev_id</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pci_dev_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_device_ids</span><span class="p">,</span>
				 <span class="n">slot_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span>
		    <span class="o">&amp;&amp;</span> <span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="n">devfn</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t break; here because it&#39;s possible the same</span>
<span class="cm">			 * slot could be in the list more than once</span>
<span class="cm">			 */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">slot_list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pci_dev_id</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: removed %04x:%02x:%02x.%d from &quot;</span>
				 <span class="s">&quot;seize list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcistub_reg_add</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">clean</span> <span class="o">=</span> <span class="n">xen_pcibk_config_field_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xen_pcibk_config_quirks_add_field</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_slot_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">str_to_slot</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_device_id_add</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">new_slot</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pcistub_slot_add</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_slot_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">str_to_slot</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_device_id_remove</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">remove_slot</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pcistub_slot_remove</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_slot_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device_id</span> <span class="o">*</span><span class="n">pci_dev_id</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pci_dev_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_device_ids</span><span class="p">,</span> <span class="n">slot_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span>
				   <span class="s">&quot;%04x:%02x:%02x.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
				   <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				   <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pci_dev_id</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">slots</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">pcistub_slot_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_irq_handler_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dev_data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span>
		    <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span>
			      <span class="s">&quot;%s:%s:%sing:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pci_name</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			      <span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">isr_on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
			      <span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">ack_intr</span> <span class="o">?</span> <span class="s">&quot;ack&quot;</span> <span class="o">:</span> <span class="s">&quot;not ack&quot;</span><span class="p">,</span>
			      <span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">handled</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">irq_handlers</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">pcistub_irq_handler_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_irq_handler_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					  <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">str_to_slot</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev_data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fake irq handler: %d-&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">isr_on</span><span class="p">,</span>
		<span class="o">!</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">isr_on</span><span class="p">);</span>

	<span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">isr_on</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">isr_on</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">isr_on</span><span class="p">)</span>
		<span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">ack_intr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">irq_handler_state</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		   <span class="n">pcistub_irq_handler_switch</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_quirk_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">str_to_quirk</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_reg_add</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcistub_quirk_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_config_quirk</span> <span class="o">*</span><span class="n">quirk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">config_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">config_field_entry</span> <span class="o">*</span><span class="n">cfg_entry</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">quirk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xen_pcibk_quirks</span><span class="p">,</span> <span class="n">quirks_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span>
				   <span class="s">&quot;%02x:%02x.%01x</span><span class="se">\n\t</span><span class="s">%04x:%04x:%04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				   <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				   <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
				   <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">.</span><span class="n">device</span><span class="p">,</span>
				   <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">.</span><span class="n">subvendor</span><span class="p">,</span>
				   <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">.</span><span class="n">subdevice</span><span class="p">);</span>

		<span class="n">dev_data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cfg_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">config_fields</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">cfg_entry</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">count</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span>
					   <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%08x:%01x:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">cfg_entry</span><span class="o">-&gt;</span><span class="n">base_offset</span> <span class="o">+</span>
					   <span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					   <span class="n">field</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_ids_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">quirks</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">pcistub_quirk_show</span><span class="p">,</span>
		   <span class="n">pcistub_quirk_add</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">permissive_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">str_to_slot</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">psdev</span> <span class="o">=</span> <span class="n">pcistub_device_find</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* the driver data for a device should never be null at this point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">permissive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">permissive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Let user know that what they&#39;re doing could be unsafe */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabling permissive mode &quot;</span>
			 <span class="s">&quot;configuration space accesses!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;permissive mode is potentially unsafe!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">release:</span>
	<span class="n">pcistub_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">permissive_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcistub_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_pcibk_dev_data</span> <span class="o">*</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">psdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcistub_devices</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dev_data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev_data</span><span class="o">-&gt;</span><span class="n">permissive</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span>
		    <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pci_name</span><span class="p">(</span><span class="n">psdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcistub_devices_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">permissive</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">permissive_show</span><span class="p">,</span>
		   <span class="n">permissive_add</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcistub_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_new_slot</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_remove_slot</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_slots</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_quirks</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_permissive</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_irq_handlers</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_irq_handler_state</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pcistub_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parsed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_devs_to_hide</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pci_devs_to_hide</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">parsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">pci_devs_to_hide</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
				     <span class="s">&quot; (%x:%x:%x.%x) %n&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parsed</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">pci_devs_to_hide</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
					     <span class="s">&quot; (%x:%x.%x) %n&quot;</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parsed</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_device_id_add</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/* if parsed&lt;=0, we&#39;ve reached the end of the string */</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">parsed</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pci_devs_to_hide</span><span class="p">[</span><span class="n">pos</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;re the first PCI Device Driver to register, we&#39;re the</span>
<span class="cm">	 * first one to get offered PCI devices as they become</span>
<span class="cm">	 * available (and thus we can be the first to grab them)</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">driver_attr_new_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">driver_attr_remove_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">driver_attr_slots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">driver_attr_quirks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">driver_attr_permissive</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">driver_attr_irq_handlers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_pcibk_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">driver_attr_irq_handler_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pcistub_exit</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">parse_error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Error parsing pci_devs_to_hide at </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_devs_to_hide</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/*</span>
<span class="cm"> * fs_initcall happens before device_initcall</span>
<span class="cm"> * so xen_pcibk *should* get called first (b/c we</span>
<span class="cm"> * want to suck up any device before other drivers</span>
<span class="cm"> * get a chance by being the first pci device</span>
<span class="cm"> * driver to register)</span>
<span class="cm"> */</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">pcistub_init</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xen_pcibk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_initial_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xen_pcibk_config_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcistub_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pcistub_init_devices_late</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xen_pcibk_xenbus_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pcistub_exit</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">xen_pcibk_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_pcibk_xenbus_unregister</span><span class="p">();</span>
	<span class="n">pcistub_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">xen_pcibk_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">xen_pcibk_cleanup</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;xen-backend:pci&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
