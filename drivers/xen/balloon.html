<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › xen › balloon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>balloon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * Xen balloon driver - enables returning/claiming memory to/from Xen.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003, B Dragovic</span>
<span class="cm"> * Copyright (c) 2003-2004, M Williamson, K Fraser</span>
<span class="cm"> * Copyright (c) 2005 Dan M. Smith, IBM Corporation</span>
<span class="cm"> * Copyright (c) 2010 Daniel Kiper</span>
<span class="cm"> *</span>
<span class="cm"> * Memory hotplug support was written by Daniel Kiper. Work on</span>
<span class="cm"> * it was sponsored by Google under Google Summer of Code 2010</span>
<span class="cm"> * program. Jeremy Fitzhardinge from Citrix was the mentor for</span>
<span class="cm"> * this project.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation; or, when distributed</span>
<span class="cm"> * separately from the Linux kernel or incorporated into other</span>
<span class="cm"> * software packages, subject to the following license:</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm"> * of this source file (the &quot;Software&quot;), to deal in the Software without</span>
<span class="cm"> * restriction, including without limitation the rights to use, copy, modify,</span>
<span class="cm"> * merge, publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="cm"> * and to permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/memory.h&gt;</span>
<span class="cp">#include &lt;linux/memory_hotplug.h&gt;</span>

<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/tlb.h&gt;</span>
<span class="cp">#include &lt;asm/e820.h&gt;</span>

<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypercall.h&gt;</span>

<span class="cp">#include &lt;xen/xen.h&gt;</span>
<span class="cp">#include &lt;xen/interface/xen.h&gt;</span>
<span class="cp">#include &lt;xen/interface/memory.h&gt;</span>
<span class="cp">#include &lt;xen/balloon.h&gt;</span>
<span class="cp">#include &lt;xen/features.h&gt;</span>
<span class="cp">#include &lt;xen/page.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * balloon_process() state:</span>
<span class="cm"> *</span>
<span class="cm"> * BP_DONE: done or nothing to do,</span>
<span class="cm"> * BP_EAGAIN: error, go to sleep,</span>
<span class="cm"> * BP_ECANCELED: error, balloon operation canceled.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">bp_state</span> <span class="p">{</span>
	<span class="n">BP_DONE</span><span class="p">,</span>
	<span class="n">BP_EAGAIN</span><span class="p">,</span>
	<span class="n">BP_ECANCELED</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">balloon_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">balloon_stats</span> <span class="n">balloon_stats</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">balloon_stats</span><span class="p">);</span>

<span class="cm">/* We increase/decrease in batches which fit in a page */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame_list</span><span class="p">[</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)];</span>

<span class="cp">#ifdef CONFIG_HIGHMEM</span>
<span class="cp">#define inc_totalhigh_pages() (totalhigh_pages++)</span>
<span class="cp">#define dec_totalhigh_pages() (totalhigh_pages--)</span>
<span class="cp">#else</span>
<span class="cp">#define inc_totalhigh_pages() do {} while (0)</span>
<span class="cp">#define dec_totalhigh_pages() do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* List of ballooned pages, threaded through the mem_map array. */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ballooned_pages</span><span class="p">);</span>

<span class="cm">/* Main work function, always executed in process context. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">balloon_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">balloon_worker</span><span class="p">,</span> <span class="n">balloon_process</span><span class="p">);</span>

<span class="cm">/* When ballooning out (allocating memory to return to Xen) we don&#39;t really</span>
<span class="cm">   want the kernel to try too hard since that can trigger the oom killer. */</span>
<span class="cp">#define GFP_BALLOON \</span>
<span class="cp">	(GFP_HIGHUSER | __GFP_NOWARN | __GFP_NORETRY | __GFP_NOMEMALLOC)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scrub_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_XEN_SCRUB_PAGES</span>
	<span class="n">clear_highpage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* balloon_append: add the given page to the balloon. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__balloon_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Lowmem is re-populated first, so highmem pages go at list tail. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ballooned_pages</span><span class="p">);</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ballooned_pages</span><span class="p">);</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">balloon_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__balloon_append</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">dec_totalhigh_pages</span><span class="p">();</span>
	<span class="n">totalram_pages</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* balloon_retrieve: rescue a page from the balloon, if it is not empty. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">balloon_retrieve</span><span class="p">(</span><span class="n">bool</span> <span class="n">prefer_highmem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ballooned_pages</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prefer_highmem</span><span class="p">)</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ballooned_pages</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ballooned_pages</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span><span class="o">--</span><span class="p">;</span>
		<span class="n">inc_totalhigh_pages</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span><span class="o">--</span><span class="p">;</span>

	<span class="n">totalram_pages</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">balloon_first_page</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ballooned_pages</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ballooned_pages</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">balloon_next_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ballooned_pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bp_state</span> <span class="nf">update_schedule</span><span class="p">(</span><span class="k">enum</span> <span class="n">bp_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">BP_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BP_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">++</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">retry_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">max_retry_count</span> <span class="o">!=</span> <span class="n">RETRY_UNLIMITED</span> <span class="o">&amp;&amp;</span>
			<span class="n">balloon_stats</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">max_retry_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BP_ECANCELED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">&gt;</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">max_schedule_delay</span><span class="p">)</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">=</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">max_schedule_delay</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BP_EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XEN_BALLOON_MEMORY_HOTPLUG</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">current_credit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">target_pages</span> <span class="o">-</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span> <span class="o">-</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">balloon_is_inflated</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span> <span class="o">||</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span> <span class="o">||</span>
			<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reserve_additional_memory() adds memory region of size &gt;= credit above</span>
<span class="cm"> * max_pfn. New region is section aligned and size is modified to be multiple</span>
<span class="cm"> * of section size. Those features allow optimal use of address space and</span>
<span class="cm"> * establish proper alignment when this function is called first time after</span>
<span class="cm"> * boot (last section not fully populated at boot time contains unused memory</span>
<span class="cm"> * pages with PG_reserved bit not set; online_pages_range() does not allow page</span>
<span class="cm"> * onlining in whole range if first onlined page does not have PG_reserved</span>
<span class="cm"> * bit set). Real size of added memory is established at page onlining stage.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bp_state</span> <span class="nf">reserve_additional_memory</span><span class="p">(</span><span class="kt">long</span> <span class="n">credit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nid</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hotplug_start_paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">balloon_hotplug</span> <span class="o">=</span> <span class="n">credit</span><span class="p">;</span>

	<span class="n">hotplug_start_paddr</span> <span class="o">=</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">SECTION_ALIGN_UP</span><span class="p">(</span><span class="n">max_pfn</span><span class="p">));</span>
	<span class="n">balloon_hotplug</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">balloon_hotplug</span><span class="p">,</span> <span class="n">PAGES_PER_SECTION</span><span class="p">);</span>
	<span class="n">nid</span> <span class="o">=</span> <span class="n">memory_add_physaddr_to_nid</span><span class="p">(</span><span class="n">hotplug_start_paddr</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">add_memory</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">hotplug_start_paddr</span><span class="p">,</span> <span class="n">balloon_hotplug</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;xen_balloon: %s: add_memory() failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BP_EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">balloon_hotplug</span> <span class="o">-=</span> <span class="n">credit</span><span class="p">;</span>

	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span> <span class="o">+=</span> <span class="n">credit</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span> <span class="o">=</span> <span class="n">balloon_hotplug</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BP_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_online_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__online_page_set_limits</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>

	<span class="n">__balloon_append</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span><span class="p">)</span>
		<span class="o">--</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">--</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_memory_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">MEM_ONLINE</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_worker</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">xen_memory_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">xen_memory_notifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">current_credit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span> <span class="o">=</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">target_pages</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
		     <span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span> <span class="o">+</span>
		     <span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span> <span class="o">+</span>
		     <span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">target</span> <span class="o">-</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">balloon_is_inflated</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span> <span class="o">||</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bp_state</span> <span class="nf">reserve_additional_memory</span><span class="p">(</span><span class="kt">long</span> <span class="n">credit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">target_pages</span> <span class="o">=</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BP_DONE</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_XEN_BALLOON_MEMORY_HOTPLUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bp_state</span> <span class="nf">increase_reservation</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">pfn</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span>   <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_memory_reservation</span> <span class="n">reservation</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">address_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extent_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">domid</span>        <span class="o">=</span> <span class="n">DOMID_SELF</span>
	<span class="p">};</span>

<span class="cp">#ifdef CONFIG_XEN_BALLOON_MEMORY_HOTPLUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span><span class="p">);</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span> <span class="o">-=</span> <span class="n">nr_pages</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BP_DONE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">frame_list</span><span class="p">))</span>
		<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">frame_list</span><span class="p">);</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">balloon_first_page</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">balloon_next_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">reservation</span><span class="p">.</span><span class="n">extent_start</span><span class="p">,</span> <span class="n">frame_list</span><span class="p">);</span>
	<span class="n">reservation</span><span class="p">.</span><span class="n">nr_extents</span> <span class="o">=</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">XENMEM_populate_physmap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reservation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BP_EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">balloon_retrieve</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">pfn</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_auto_translated_physmap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="n">phys_to_machine_mapping_valid</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>

		<span class="n">set_phys_to_machine</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Link back into the page tables if not highmem. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_pv_domain</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_update_va_mapping</span><span class="p">(</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">),</span>
				<span class="n">mfn_pte</span><span class="p">(</span><span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PAGE_KERNEL</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Relinquish the page back to the allocator. */</span>
		<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">init_page_count</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span> <span class="o">+=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BP_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bp_state</span> <span class="nf">decrease_reservation</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bp_state</span> <span class="n">state</span> <span class="o">=</span> <span class="n">BP_DONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">pfn</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span>   <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_memory_reservation</span> <span class="n">reservation</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">address_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extent_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">domid</span>        <span class="o">=</span> <span class="n">DOMID_SELF</span>
	<span class="p">};</span>

<span class="cp">#ifdef CONFIG_XEN_BALLOON_MEMORY_HOTPLUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span><span class="p">);</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span> <span class="o">-=</span> <span class="n">nr_pages</span><span class="p">;</span>
		<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BP_DONE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">frame_list</span><span class="p">))</span>
		<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">frame_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">gfp</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">BP_EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pfn</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfn_to_mfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>

		<span class="n">scrub_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xen_pv_domain</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_update_va_mapping</span><span class="p">(</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">),</span>
				<span class="n">__pte_ma</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Ensure that ballooned highmem pages don&#39;t have kmaps. */</span>
	<span class="n">kmap_flush_unused</span><span class="p">();</span>
	<span class="n">flush_tlb_all</span><span class="p">();</span>

	<span class="cm">/* No more mappings: invalidate P2M and add to balloon. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">mfn_to_pfn</span><span class="p">(</span><span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">__set_phys_to_machine</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">INVALID_P2M_ENTRY</span><span class="p">);</span>
		<span class="n">balloon_append</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">reservation</span><span class="p">.</span><span class="n">extent_start</span><span class="p">,</span> <span class="n">frame_list</span><span class="p">);</span>
	<span class="n">reservation</span><span class="p">.</span><span class="n">nr_extents</span>   <span class="o">=</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">XENMEM_decrease_reservation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reservation</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">nr_pages</span><span class="p">);</span>

	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span> <span class="o">-=</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We avoid multiple worker processes conflicting via the balloon mutex.</span>
<span class="cm"> * We may of course race updates of the target counts (which are protected</span>
<span class="cm"> * by the balloon lock), or with changes to the Xen hard limit, but we will</span>
<span class="cm"> * recover from these in time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">balloon_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bp_state</span> <span class="n">state</span> <span class="o">=</span> <span class="n">BP_DONE</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">credit</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">credit</span> <span class="o">=</span> <span class="n">current_credit</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">credit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">balloon_is_inflated</span><span class="p">())</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">increase_reservation</span><span class="p">(</span><span class="n">credit</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">reserve_additional_memory</span><span class="p">(</span><span class="n">credit</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">credit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">decrease_reservation</span><span class="p">(</span><span class="o">-</span><span class="n">credit</span><span class="p">,</span> <span class="n">GFP_BALLOON</span><span class="p">);</span>

		<span class="n">state</span> <span class="o">=</span> <span class="n">update_schedule</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_PREEMPT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">credit</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">BP_DONE</span><span class="p">);</span>

	<span class="cm">/* Schedule more work if there is some still to be done. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">BP_EAGAIN</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_worker</span><span class="p">,</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Resets the Xen limit, sets new target, and kicks off processing. */</span>
<span class="kt">void</span> <span class="nf">balloon_set_new_target</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No need for lock. Not read-modify-write updates. */</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">target_pages</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_worker</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">balloon_set_new_target</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * alloc_xenballooned_pages - get pages that have been ballooned out</span>
<span class="cm"> * @nr_pages: Number of pages to get</span>
<span class="cm"> * @pages: pages returned</span>
<span class="cm"> * @highmem: allow highmem pages</span>
<span class="cm"> * @return 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">alloc_xenballooned_pages</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="n">bool</span> <span class="n">highmem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pgno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pgno</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">balloon_retrieve</span><span class="p">(</span><span class="n">highmem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">highmem</span> <span class="o">||</span> <span class="o">!</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pages</span><span class="p">[</span><span class="n">pgno</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">bp_state</span> <span class="n">st</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
				<span class="n">balloon_append</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">st</span> <span class="o">=</span> <span class="n">decrease_reservation</span><span class="p">(</span><span class="n">nr_pages</span> <span class="o">-</span> <span class="n">pgno</span><span class="p">,</span>
					<span class="n">highmem</span> <span class="o">?</span> <span class="n">GFP_HIGHUSER</span> <span class="o">:</span> <span class="n">GFP_USER</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">!=</span> <span class="n">BP_DONE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_undo</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_undo:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pgno</span><span class="p">)</span>
		<span class="n">balloon_append</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="o">--</span><span class="n">pgno</span><span class="p">]);</span>
	<span class="cm">/* Free the memory back to the kernel soon */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_worker</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">alloc_xenballooned_pages</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * free_xenballooned_pages - return pages retrieved with get_ballooned_pages</span>
<span class="cm"> * @nr_pages: Number of pages</span>
<span class="cm"> * @pages: pages to return</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">free_xenballooned_pages</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">balloon_append</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* The balloon may be too large now. Shrink it if needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_credit</span><span class="p">())</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_worker</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">balloon_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">free_xenballooned_pages</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">balloon_add_region</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_pfn</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">extra_pfn_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the amount of usable memory has been limited (e.g., with</span>
<span class="cm">	 * the &#39;mem&#39; command line parameter), don&#39;t add pages beyond</span>
<span class="cm">	 * this limit.</span>
<span class="cm">	 */</span>
	<span class="n">extra_pfn_end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_pfn</span><span class="p">,</span> <span class="n">start_pfn</span> <span class="o">+</span> <span class="n">pages</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">start_pfn</span><span class="p">;</span> <span class="n">pfn</span> <span class="o">&lt;</span> <span class="n">extra_pfn_end</span><span class="p">;</span> <span class="n">pfn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
		<span class="cm">/* totalram_pages and totalhigh_pages do not</span>
<span class="cm">		   include the boot-time balloon extension, so</span>
<span class="cm">		   don&#39;t subtract from it. */</span>
		<span class="n">__balloon_append</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">balloon_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;xen/balloon: Initialising balloon driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span> <span class="o">=</span> <span class="n">xen_pv_domain</span><span class="p">()</span>
		<span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">-</span> <span class="n">xen_released_pages</span><span class="p">,</span> <span class="n">max_pfn</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">max_pfn</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">target_pages</span>  <span class="o">=</span> <span class="n">balloon_stats</span><span class="p">.</span><span class="n">current_pages</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_low</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_high</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">schedule_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">max_schedule_delay</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">max_retry_count</span> <span class="o">=</span> <span class="n">RETRY_UNLIMITED</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_XEN_BALLOON_MEMORY_HOTPLUG</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">hotplug_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">balloon_stats</span><span class="p">.</span><span class="n">balloon_hotplug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_online_page_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_online_page</span><span class="p">);</span>
	<span class="n">register_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_memory_nb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the balloon with pages from the extra memory</span>
<span class="cm">	 * regions (see arch/x86/xen/setup.c).</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XEN_EXTRA_MEM_MAX_REGIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
			<span class="n">balloon_add_region</span><span class="p">(</span><span class="n">PFN_UP</span><span class="p">(</span><span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">),</span>
					   <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">balloon_init</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
