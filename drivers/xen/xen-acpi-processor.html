<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › xen › xen-acpi-processor.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xen-acpi-processor.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 by Oracle Inc</span>
<span class="cm"> * Author: Konrad Rzeszutek Wilk &lt;konrad.wilk@oracle.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This code borrows ideas from https://lkml.org/lkml/2011/11/30/249</span>
<span class="cm"> * so many thanks go to Kevin Tian &lt;kevin.tian@intel.com&gt;</span>
<span class="cm"> * and Yu Ke &lt;ke.yu@intel.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_bus.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>
<span class="cp">#include &lt;acpi/processor.h&gt;</span>

<span class="cp">#include &lt;xen/xen.h&gt;</span>
<span class="cp">#include &lt;xen/interface/platform.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypercall.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;xen-acpi-processor: &quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">no_hypercall</span><span class="p">;</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="s">&quot;Inhibit the hypercall.&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">no_hypercall</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Note: Do not convert the acpi_id* below to cpumask_var_t or use cpumask_bit</span>
<span class="cm"> * - as those shrink to nr_cpu_bits (which is dependent on possible_cpu), which</span>
<span class="cm"> * can be less than what we want to put in. Instead use the &#39;nr_acpi_bits&#39;</span>
<span class="cm"> * which is dynamically computed based on the MADT or x2APIC table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_acpi_bits</span><span class="p">;</span>
<span class="cm">/* Mutex to protect the acpi_ids_done - for CPU hotplug use. */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">acpi_ids_mutex</span><span class="p">);</span>
<span class="cm">/* Which ACPI ID we have processed from &#39;struct acpi_processor&#39;. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">acpi_ids_done</span><span class="p">;</span>
<span class="cm">/* Which ACPI ID exist in the SSDT/DSDT processor definitions. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="o">*</span><span class="n">acpi_id_present</span><span class="p">;</span>
<span class="cm">/* And if there is an _CST definition (or a PBLK) for the ACPI IDs */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="o">*</span><span class="n">acpi_id_cst_present</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">push_cxx_to_hypervisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">_pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_platform_op</span> <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span>			<span class="o">=</span> <span class="n">XENPF_set_processor_pminfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">interface_version</span>	<span class="o">=</span> <span class="n">XENPF_INTERFACE_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">XEN_PM_CX</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">xen_processor_cx</span> <span class="o">*</span><span class="n">dst_cx</span><span class="p">,</span> <span class="o">*</span><span class="n">dst_cx_states</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_processor_cx</span> <span class="o">*</span><span class="n">cx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dst_cx_states</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_processor_cx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst_cx_states</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dst_cx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dst_cx_states</span><span class="p">[</span><span class="n">ok</span><span class="o">++</span><span class="p">]);</span>

		<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">space_id</span> <span class="o">=</span> <span class="n">ACPI_ADR_SPACE_SYSTEM_IO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">entry_method</span> <span class="o">==</span> <span class="n">ACPI_CSTATE_SYSTEMIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">bit_width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">space_id</span> <span class="o">=</span> <span class="n">ACPI_ADR_SPACE_FIXED_HARDWARE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">entry_method</span> <span class="o">==</span> <span class="n">ACPI_CSTATE_FFH</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* NATIVE_CSTATE_BEYOND_HALT */</span>
				<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">bit_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* VENDOR_INTEL */</span>
			<span class="p">}</span>
			<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">access_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

		<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">=</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">;</span>
		<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">;</span>

		<span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">dpcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">dst_cx</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;No _Cx for ACPI CPU %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dst_cx_states</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ok</span><span class="p">;</span>
	<span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_control</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_control</span><span class="p">;</span>
	<span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_check</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_check</span><span class="p">;</span>
	<span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">has_cst</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">has_cst</span><span class="p">;</span>
	<span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">power_setup_done</span> <span class="o">=</span>
		<span class="n">_pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">power_setup_done</span><span class="p">;</span>

	<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">,</span> <span class="n">dst_cx_states</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_hypercall</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ACPI CPU%u - C-states uploaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;     C%d: %s %d uS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cx</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="cm">/* EINVAL means the ACPI ID is incorrect - meaning the ACPI</span>
<span class="cm">		 * table is referencing a non-existing CPU - which can happen</span>
<span class="cm">		 * with broken ACPI tables. */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;(CX): Hypervisor error (%d) for ACPI CPU%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">,</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dst_cx_states</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">xen_processor_px</span> <span class="o">*</span>
<span class="nf">xen_copy_pss_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">_pr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">xen_processor_performance</span> <span class="o">*</span><span class="n">dst_perf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_processor_px</span> <span class="o">*</span><span class="n">dst_states</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_processor_px</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor_px</span><span class="p">));</span>

	<span class="n">dst_states</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_processor_px</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst_states</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">state_count</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fortunatly for us, they are both the same size */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dst_states</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor_px</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dst_states</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_copy_psd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">_pr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">xen_processor_performance</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_psd_package</span> <span class="o">*</span><span class="n">pdomain</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_psd_package</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_psd_package</span><span class="p">));</span>

	<span class="cm">/* This information is enumerated only if acpi_processor_preregister_performance</span>
<span class="cm">	 * has been called.</span>
<span class="cm">	 */</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">shared_type</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">shared_type</span><span class="p">;</span>

	<span class="n">pdomain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">domain_info</span><span class="p">);</span>

	<span class="cm">/* &#39;acpi_processor_preregister_performance&#39; does not parse if the</span>
<span class="cm">	 * num_processors &lt;= 1, but Xen still requires it. Do it manually here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdomain</span><span class="o">-&gt;</span><span class="n">num_processors</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdomain</span><span class="o">-&gt;</span><span class="n">coord_type</span> <span class="o">==</span> <span class="n">DOMAIN_COORD_TYPE_SW_ALL</span><span class="p">)</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">shared_type</span> <span class="o">=</span> <span class="n">CPUFREQ_SHARED_TYPE_ALL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdomain</span><span class="o">-&gt;</span><span class="n">coord_type</span> <span class="o">==</span> <span class="n">DOMAIN_COORD_TYPE_HW_ALL</span><span class="p">)</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">shared_type</span> <span class="o">=</span> <span class="n">CPUFREQ_SHARED_TYPE_HW</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdomain</span><span class="o">-&gt;</span><span class="n">coord_type</span> <span class="o">==</span> <span class="n">DOMAIN_COORD_TYPE_SW_ANY</span><span class="p">)</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">shared_type</span> <span class="o">=</span> <span class="n">CPUFREQ_SHARED_TYPE_ANY</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">domain_info</span><span class="p">),</span> <span class="n">pdomain</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_psd_package</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_copy_pct_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_pct_register</span> <span class="o">*</span><span class="n">pct</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">xen_pct_register</span> <span class="o">*</span><span class="n">dst_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* It would be nice if you could just do &#39;memcpy(pct, dst_pct&#39;) but</span>
<span class="cm">	 * sadly the Xen structure did not have the proper padding so the</span>
<span class="cm">	 * descriptor field takes two (dst_pct) bytes instead of one (pct).</span>
<span class="cm">	 */</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">descriptor</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">;</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">space_id</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">space_id</span><span class="p">;</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">bit_width</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">bit_width</span><span class="p">;</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">;</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
	<span class="n">dst_pct</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">pct</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">push_pxx_to_hypervisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">_pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_platform_op</span> <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span>			<span class="o">=</span> <span class="n">XENPF_set_processor_pminfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">interface_version</span>	<span class="o">=</span> <span class="n">XENPF_INTERFACE_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">XEN_PM_PX</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">xen_processor_performance</span> <span class="o">*</span><span class="n">dst_perf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_processor_px</span> <span class="o">*</span><span class="n">dst_states</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dst_perf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">perf</span><span class="p">;</span>

	<span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">platform_limit</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance_platform_limit</span><span class="p">;</span>
	<span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XEN_PX_PPC</span><span class="p">;</span>
	<span class="n">xen_copy_pct_data</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">xen_copy_pct_data</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">status_register</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">status_register</span><span class="p">);</span>
	<span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XEN_PX_PCT</span><span class="p">;</span>
	<span class="n">dst_states</span> <span class="o">=</span> <span class="n">xen_copy_pss_data</span><span class="p">(</span><span class="n">_pr</span><span class="p">,</span> <span class="n">dst_perf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dst_states</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">,</span> <span class="n">dst_states</span><span class="p">);</span>
		<span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XEN_PX_PSS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_copy_psd_data</span><span class="p">(</span><span class="n">_pr</span><span class="p">,</span> <span class="n">dst_perf</span><span class="p">))</span>
		<span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XEN_PX_PSD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="p">(</span><span class="n">XEN_PX_PSD</span> <span class="o">|</span> <span class="n">XEN_PX_PSS</span> <span class="o">|</span> <span class="n">XEN_PX_PCT</span> <span class="o">|</span> <span class="n">XEN_PX_PPC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;ACPI CPU%u missing some P-state data (%x), skipping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">,</span> <span class="n">dst_perf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_hypercall</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_processor_performance</span> <span class="o">*</span><span class="n">perf</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">perf</span> <span class="o">=</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ACPI CPU%u - P-states uploaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">perf</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;     %cP%d: %d MHz, %d mW, %d uS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">perf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">perf</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">core_frequency</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">perf</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">power</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">perf</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">transition_latency</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="cm">/* EINVAL means the ACPI ID is incorrect - meaning the ACPI</span>
<span class="cm">		 * table is referencing a non-existing CPU - which can happen</span>
<span class="cm">		 * with broken ACPI tables. */</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;(_PXX): Hypervisor error (%d) for ACPI CPU%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">,</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dst_states</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dst_states</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">upload_pm_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">_pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_ids_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_set_bit</span><span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">,</span> <span class="n">acpi_ids_done</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_ids_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">power</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">push_cxx_to_hypervisor</span><span class="p">(</span><span class="n">_pr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span> <span class="o">&amp;&amp;</span> <span class="n">_pr</span><span class="o">-&gt;</span><span class="n">performance</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">push_pxx_to_hypervisor</span><span class="p">(</span><span class="n">_pr</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_ids_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">get_max_acpi_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xenpf_pcpuinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_platform_op</span> <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">XENPF_get_cpuinfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">interface_version</span> <span class="o">=</span> <span class="n">XENPF_INTERFACE_VERSION</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">last_cpu</span><span class="p">,</span> <span class="n">max_acpi_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pcpu_info</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xen_cpuid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NR_CPUS</span><span class="p">;</span>

	<span class="cm">/* The max_present is the same irregardless of the xen_cpuid */</span>
	<span class="n">last_cpu</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pcpu_info</span><span class="p">.</span><span class="n">max_present</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last_cpu</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xen_cpuid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">max_acpi_id</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">acpi_id</span><span class="p">,</span> <span class="n">max_acpi_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">max_acpi_id</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Slack for CPU hotplug support. */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;Max ACPI ID: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_acpi_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">max_acpi_id</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * The read_acpi_id and check_acpi_ids are there to support the Xen</span>
<span class="cm"> * oddity of virtual CPUs != physical CPUs in the initial domain.</span>
<span class="cm"> * The user can supply &#39;xen_max_vcpus=X&#39; on the Xen hypervisor line</span>
<span class="cm"> * which will band the amount of CPUs the initial domain can see.</span>
<span class="cm"> * In general that is OK, except it plays havoc with any of the</span>
<span class="cm"> * for_each_[present|online]_cpu macros which are banded to the virtual</span>
<span class="cm"> * CPU amount.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">acpi_status</span> <span class="n">__init</span>
<span class="nf">read_acpi_id</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lvl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">rv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">acpi_id</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_object_type</span> <span class="n">acpi_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">object</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">object</span> <span class="p">};</span>
	<span class="n">acpi_io_address</span> <span class="n">pblk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_type</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">acpi_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_PROCESSOR</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="n">acpi_id</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="n">processor</span><span class="p">.</span><span class="n">proc_id</span><span class="p">;</span>
		<span class="n">pblk</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="n">processor</span><span class="p">.</span><span class="n">pblk_address</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_DEVICE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_UID&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="n">acpi_id</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* There are more ACPI Processor objects than in x2APIC or MADT.</span>
<span class="cm">	 * This can happen with incorrect ACPI SSDT declerations. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_id</span> <span class="o">&gt;</span> <span class="n">nr_acpi_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;We only have %u, trying to set %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">nr_acpi_bits</span><span class="p">,</span> <span class="n">acpi_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* OK, There is a ACPI Processor object */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">acpi_id</span><span class="p">,</span> <span class="n">acpi_id_present</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;ACPI CPU%u w/ PBLK:0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acpi_id</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pblk</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_CST&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pblk</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* .. and it has a C-state */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">acpi_id</span><span class="p">,</span> <span class="n">acpi_id_cst_present</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">check_acpi_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">pr_backup</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_backup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* All online CPUs have been processed at this stage. Now verify</span>
<span class="cm">	 * whether in fact &quot;online CPUs&quot; == physical CPUs.</span>
<span class="cm">	 */</span>
	<span class="n">acpi_id_present</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nr_acpi_bits</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_id_present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acpi_id_cst_present</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nr_acpi_bits</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_id_cst_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_id_present</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acpi_walk_namespace</span><span class="p">(</span><span class="n">ACPI_TYPE_PROCESSOR</span><span class="p">,</span> <span class="n">ACPI_ROOT_OBJECT</span><span class="p">,</span>
			    <span class="n">ACPI_UINT32_MAX</span><span class="p">,</span>
			    <span class="n">read_acpi_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">acpi_get_devices</span><span class="p">(</span><span class="s">&quot;ACPI0007&quot;</span><span class="p">,</span> <span class="n">read_acpi_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">acpi_id_present</span><span class="p">,</span> <span class="n">acpi_ids_done</span><span class="p">,</span> <span class="n">nr_acpi_bits</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acpi_id_present</span><span class="p">,</span> <span class="n">nr_acpi_bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_backup</span><span class="o">-&gt;</span><span class="n">acpi_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="cm">/* Mask out C-states if there are no _CST or PBLK */</span>
			<span class="n">pr_backup</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acpi_id_cst_present</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">upload_pm_data</span><span class="p">(</span><span class="n">pr_backup</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_id_present</span><span class="p">);</span>
	<span class="n">acpi_id_present</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_id_cst_present</span><span class="p">);</span>
	<span class="n">acpi_id_cst_present</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">check_prereq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_initial_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">smi_command</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_vendor</span> <span class="o">==</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_vendor</span> <span class="o">==</span> <span class="n">X86_VENDOR_AMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copied from powernow-k8.h, can&#39;t include ../cpufreq/powernow</span>
<span class="cm">		 * as we get compile warnings for the static functions.</span>
<span class="cm">		 */</span>
<span class="cp">#define CPUID_FREQ_VOLT_CAPABILITIES    0x80000007</span>
<span class="cp">#define USE_HW_PSTATE                   0x00000080</span>
		<span class="n">u32</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">;</span>
		<span class="n">cpuid</span><span class="p">(</span><span class="n">CPUID_FREQ_VOLT_CAPABILITIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="n">USE_HW_PSTATE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USE_HW_PSTATE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* acpi_perf_data is a pointer to percpu data. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_processor_performance</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">acpi_perf_data</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_acpi_perf_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Freeing a NULL pointer is OK, and alloc_percpu zeroes. */</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
				 <span class="o">-&gt;</span><span class="n">shared_cpu_map</span><span class="p">);</span>
	<span class="n">free_percpu</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xen_acpi_processor_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">pr_backup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">check_prereq</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">nr_acpi_bits</span> <span class="o">=</span> <span class="n">get_max_acpi_id</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">acpi_ids_done</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nr_acpi_bits</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ids_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acpi_perf_data</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor_performance</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_perf_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;Memory allocation error for acpi_perf_data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_ids_done</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var_node</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shared_cpu_map</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Do initialization in ACPI core. It is OK to fail here. */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">acpi_processor_preregister_performance</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_processor_performance</span> <span class="o">*</span><span class="n">perf</span><span class="p">;</span>

		<span class="n">perf</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_processor_register_performance</span><span class="p">(</span><span class="n">perf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_processor_notify_smm</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">_pr</span><span class="p">;</span>
		<span class="n">_pr</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">processors</span><span class="p">,</span> <span class="n">i</span> <span class="cm">/* APIC ID */</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_pr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_backup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_backup</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pr_backup</span><span class="p">,</span> <span class="n">_pr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_processor</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">upload_pm_data</span><span class="p">(</span><span class="n">_pr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">check_acpi_ids</span><span class="p">(</span><span class="n">pr_backup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pr_backup</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_unregister:</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_processor_performance</span> <span class="o">*</span><span class="n">perf</span><span class="p">;</span>
		<span class="n">perf</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">acpi_processor_unregister_performance</span><span class="p">(</span><span class="n">perf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_out:</span>
	<span class="cm">/* Freeing a NULL pointer is OK: alloc_percpu zeroes. */</span>
	<span class="n">free_acpi_perf_data</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_ids_done</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">xen_acpi_processor_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_ids_done</span><span class="p">);</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_processor_performance</span> <span class="o">*</span><span class="n">perf</span><span class="p">;</span>
		<span class="n">perf</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">acpi_perf_data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">acpi_processor_unregister_performance</span><span class="p">(</span><span class="n">perf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_acpi_perf_data</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Konrad Rzeszutek Wilk &lt;konrad.wilk@oracle.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xen ACPI Processor P-states (and Cx) driver which uploads PM data to Xen hypervisor&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* We want to be loaded before the CPU freq scaling drivers are loaded.</span>
<span class="cm"> * They are loaded in late_initcall. */</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">xen_acpi_processor_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">xen_acpi_processor_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
