<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › nand › fsmc_nand.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fsmc_nand.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/mtd/nand/fsmc_nand.c</span>
<span class="cm"> *</span>
<span class="cm"> * ST Microelectronics</span>
<span class="cm"> * Flexible Static Memory Controller (FSMC)</span>
<span class="cm"> * Driver for NAND portions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2010 ST Microelectronics</span>
<span class="cm"> * Vipin Kumar &lt;vipin.kumar@st.com&gt;</span>
<span class="cm"> * Ashish Priyadarshi</span>
<span class="cm"> *</span>
<span class="cm"> * Based on drivers/mtd/nand/nomadik_nand.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2. This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dma-direction.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/resource.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand_ecc.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/fsmc.h&gt;</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;mtd/mtd-abi.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc1_128_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span>
		<span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">56</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">88</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc1_64_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">56</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc1_16_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ECC4 layout for NAND of pagesize 8192 bytes &amp; OOBsize 256 bytes. 13*16 bytes</span>
<span class="cm"> * of OB size is reserved for ECC, Byte no. 0 &amp; 1 reserved for bad block and 46</span>
<span class="cm"> * bytes are free for use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc4_256_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">208</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">3</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">6</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>
		<span class="mi">9</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>
		<span class="mi">18</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>
		<span class="mi">25</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">27</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
		<span class="mi">34</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">37</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span>
		<span class="mi">41</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>
		<span class="mi">50</span><span class="p">,</span>  <span class="mi">51</span><span class="p">,</span>  <span class="mi">52</span><span class="p">,</span>  <span class="mi">53</span><span class="p">,</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">55</span><span class="p">,</span>  <span class="mi">56</span><span class="p">,</span>
		<span class="mi">57</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span>
		<span class="mi">66</span><span class="p">,</span>  <span class="mi">67</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">69</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">71</span><span class="p">,</span>  <span class="mi">72</span><span class="p">,</span>
		<span class="mi">73</span><span class="p">,</span>  <span class="mi">74</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">76</span><span class="p">,</span>  <span class="mi">77</span><span class="p">,</span>  <span class="mi">78</span><span class="p">,</span>
		<span class="mi">82</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span>  <span class="mi">84</span><span class="p">,</span>  <span class="mi">85</span><span class="p">,</span>  <span class="mi">86</span><span class="p">,</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">88</span><span class="p">,</span>
		<span class="mi">89</span><span class="p">,</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">91</span><span class="p">,</span>  <span class="mi">92</span><span class="p">,</span>  <span class="mi">93</span><span class="p">,</span>  <span class="mi">94</span><span class="p">,</span>
		<span class="mi">98</span><span class="p">,</span>  <span class="mi">99</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span>
		<span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span>
		<span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span>
		<span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span>
		<span class="mi">130</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span>
		<span class="mi">137</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span>
		<span class="mi">146</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span>
		<span class="mi">153</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span>
		<span class="mi">162</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span>
		<span class="mi">169</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span>
		<span class="mi">178</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span>
		<span class="mi">185</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span>
		<span class="mi">194</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span>
		<span class="mi">201</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span>
		<span class="mi">210</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span>
		<span class="mi">217</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span>
		<span class="mi">226</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span>
		<span class="mi">233</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span>
		<span class="mi">242</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span>
		<span class="mi">249</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">254</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">47</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">111</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">127</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">143</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">159</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">175</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">191</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">207</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">223</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">239</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ECC4 layout for NAND of pagesize 4096 bytes &amp; OOBsize 224 bytes. 13*8 bytes</span>
<span class="cm"> * of OOB size is reserved for ECC, Byte no. 0 &amp; 1 reserved for bad block &amp; 118</span>
<span class="cm"> * bytes are free for use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc4_224_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">3</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">6</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>
		<span class="mi">9</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>
		<span class="mi">18</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>
		<span class="mi">25</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">27</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
		<span class="mi">34</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">37</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span>
		<span class="mi">41</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>
		<span class="mi">50</span><span class="p">,</span>  <span class="mi">51</span><span class="p">,</span>  <span class="mi">52</span><span class="p">,</span>  <span class="mi">53</span><span class="p">,</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">55</span><span class="p">,</span>  <span class="mi">56</span><span class="p">,</span>
		<span class="mi">57</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span>
		<span class="mi">66</span><span class="p">,</span>  <span class="mi">67</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">69</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">71</span><span class="p">,</span>  <span class="mi">72</span><span class="p">,</span>
		<span class="mi">73</span><span class="p">,</span>  <span class="mi">74</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">76</span><span class="p">,</span>  <span class="mi">77</span><span class="p">,</span>  <span class="mi">78</span><span class="p">,</span>
		<span class="mi">82</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span>  <span class="mi">84</span><span class="p">,</span>  <span class="mi">85</span><span class="p">,</span>  <span class="mi">86</span><span class="p">,</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">88</span><span class="p">,</span>
		<span class="mi">89</span><span class="p">,</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">91</span><span class="p">,</span>  <span class="mi">92</span><span class="p">,</span>  <span class="mi">93</span><span class="p">,</span>  <span class="mi">94</span><span class="p">,</span>
		<span class="mi">98</span><span class="p">,</span>  <span class="mi">99</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span>
		<span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span>
		<span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span>
		<span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">126</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">47</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">111</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">127</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">97</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ECC4 layout for NAND of pagesize 4096 bytes &amp; OOBsize 128 bytes. 13*8 bytes</span>
<span class="cm"> * of OOB size is reserved for ECC, Byte no. 0 &amp; 1 reserved for bad block &amp; 22</span>
<span class="cm"> * bytes are free for use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc4_128_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">3</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">6</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>
		<span class="mi">9</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>
		<span class="mi">18</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>
		<span class="mi">25</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">27</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
		<span class="mi">34</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">37</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span>
		<span class="mi">41</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>
		<span class="mi">50</span><span class="p">,</span>  <span class="mi">51</span><span class="p">,</span>  <span class="mi">52</span><span class="p">,</span>  <span class="mi">53</span><span class="p">,</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">55</span><span class="p">,</span>  <span class="mi">56</span><span class="p">,</span>
		<span class="mi">57</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span>
		<span class="mi">66</span><span class="p">,</span>  <span class="mi">67</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">69</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">71</span><span class="p">,</span>  <span class="mi">72</span><span class="p">,</span>
		<span class="mi">73</span><span class="p">,</span>  <span class="mi">74</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">76</span><span class="p">,</span>  <span class="mi">77</span><span class="p">,</span>  <span class="mi">78</span><span class="p">,</span>
		<span class="mi">82</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span>  <span class="mi">84</span><span class="p">,</span>  <span class="mi">85</span><span class="p">,</span>  <span class="mi">86</span><span class="p">,</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">88</span><span class="p">,</span>
		<span class="mi">89</span><span class="p">,</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">91</span><span class="p">,</span>  <span class="mi">92</span><span class="p">,</span>  <span class="mi">93</span><span class="p">,</span>  <span class="mi">94</span><span class="p">,</span>
		<span class="mi">98</span><span class="p">,</span>  <span class="mi">99</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span>
		<span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span>
		<span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span>
		<span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">126</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">47</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">111</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">127</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ECC4 layout for NAND of pagesize 2048 bytes &amp; OOBsize 64 bytes. 13*4 bytes of</span>
<span class="cm"> * OOB size is reserved for ECC, Byte no. 0 &amp; 1 reserved for bad block and 10</span>
<span class="cm"> * bytes are free for use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc4_64_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">52</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">3</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">6</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>
		<span class="mi">9</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>
		<span class="mi">18</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>
		<span class="mi">25</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">27</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
		<span class="mi">34</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">37</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span>
		<span class="mi">41</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>
		<span class="mi">50</span><span class="p">,</span>  <span class="mi">51</span><span class="p">,</span>  <span class="mi">52</span><span class="p">,</span>  <span class="mi">53</span><span class="p">,</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">55</span><span class="p">,</span>  <span class="mi">56</span><span class="p">,</span>
		<span class="mi">57</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">47</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ECC4 layout for NAND of pagesize 512 bytes &amp; OOBsize 16 bytes. 13 bytes of</span>
<span class="cm"> * OOB size is reserved for ECC, Byte no. 4 &amp; 5 reserved for bad block and One</span>
<span class="cm"> * byte is free for use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">fsmc_ecc4_16_layout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
		<span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ECC placement definitions in oobfree type format.</span>
<span class="cm"> * There are 13 bytes of ecc for every 512 byte block and it has to be read</span>
<span class="cm"> * consecutively and immediately after the 512 byte data block for hardware to</span>
<span class="cm"> * generate the error bit offsets in 512 byte data.</span>
<span class="cm"> * Managing the ecc bytes in the following way makes it easier for software to</span>
<span class="cm"> * read ecc bytes consecutive to data bytes. This way is similar to</span>
<span class="cm"> * oobfree structure maintained already in generic nand driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fsmc_eccplace</span> <span class="n">fsmc_ecc4_lp_place</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccplace</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">34</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">66</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">82</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">114</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">13</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsmc_eccplace</span> <span class="n">fsmc_ecc4_sp_place</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccplace</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">9</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct fsmc_nand_data - structure for FSMC NAND device state</span>
<span class="cm"> *</span>
<span class="cm"> * @pid:		Part ID on the AMBA PrimeCell format</span>
<span class="cm"> * @mtd:		MTD info for a NAND flash.</span>
<span class="cm"> * @nand:		Chip related info for a NAND flash.</span>
<span class="cm"> * @partitions:		Partition info for a NAND Flash.</span>
<span class="cm"> * @nr_partitions:	Total number of partition of a NAND flash.</span>
<span class="cm"> *</span>
<span class="cm"> * @ecc_place:		ECC placing locations in oobfree type format.</span>
<span class="cm"> * @bank:		Bank number for probed device.</span>
<span class="cm"> * @clk:		Clock structure for FSMC.</span>
<span class="cm"> *</span>
<span class="cm"> * @read_dma_chan:	DMA channel for read access</span>
<span class="cm"> * @write_dma_chan:	DMA channel for write access to NAND</span>
<span class="cm"> * @dma_access_complete: Completion structure</span>
<span class="cm"> *</span>
<span class="cm"> * @data_pa:		NAND Physical port for Data.</span>
<span class="cm"> * @data_va:		NAND port for Data.</span>
<span class="cm"> * @cmd_va:		NAND port for Command.</span>
<span class="cm"> * @addr_va:		NAND port for Address.</span>
<span class="cm"> * @regs_va:		FSMC regs base address.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span>		<span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span>	<span class="n">nand</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_partition</span>	<span class="o">*</span><span class="n">partitions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nr_partitions</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">fsmc_eccplace</span>	<span class="o">*</span><span class="n">ecc_place</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">bank</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">access_mode</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="cm">/* DMA related objects */</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>		<span class="o">*</span><span class="n">read_dma_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>		<span class="o">*</span><span class="n">write_dma_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">dma_access_complete</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">fsmc_nand_timings</span> <span class="o">*</span><span class="n">dev_timings</span><span class="p">;</span>

	<span class="n">dma_addr_t</span>		<span class="n">data_pa</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_va</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">cmd_va</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">addr_va</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs_va</span><span class="p">;</span>

	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">select_chip</span><span class="p">)(</span><span class="kt">uint32_t</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">busw</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* Assert CS signal based on chipnr */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_select_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chipnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chipnr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">chipnr</span><span class="p">,</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_cmd_ctrl - For facilitaing Hardware access</span>
<span class="cm"> * This routine allows hardware specific access to control-lines(ALE,CLE)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_cmd_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_va</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_va</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_ALE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">addr_va</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">addr_va</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_va</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_va</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_NCE</span><span class="p">)</span>
			<span class="n">pc</span> <span class="o">|=</span> <span class="n">FSMC_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FSMC_ENABLE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">NAND_CMD_NONE</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_nand_setup - FSMC (Flexible Static Memory Controller) init routine</span>
<span class="cm"> *</span>
<span class="cm"> * This routine initializes timing parameters related to NAND memory access in</span>
<span class="cm"> * FSMC registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_nand_setup</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">bank</span><span class="p">,</span>
			   <span class="kt">uint32_t</span> <span class="n">busw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsmc_nand_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">value</span> <span class="o">=</span> <span class="n">FSMC_DEVTYPE_NAND</span> <span class="o">|</span> <span class="n">FSMC_ENABLE</span> <span class="o">|</span> <span class="n">FSMC_WAITON</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tclr</span><span class="p">,</span> <span class="n">tar</span><span class="p">,</span> <span class="n">thiz</span><span class="p">,</span> <span class="n">thold</span><span class="p">,</span> <span class="n">twait</span><span class="p">,</span> <span class="n">tset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_timings</span> <span class="o">*</span><span class="n">tims</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_timings</span> <span class="n">default_timings</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tclr</span>	<span class="o">=</span> <span class="n">FSMC_TCLR_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tar</span>	<span class="o">=</span> <span class="n">FSMC_TAR_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">thiz</span>	<span class="o">=</span> <span class="n">FSMC_THIZ_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">thold</span>	<span class="o">=</span> <span class="n">FSMC_THOLD_4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">twait</span>	<span class="o">=</span> <span class="n">FSMC_TWAIT_6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tset</span>	<span class="o">=</span> <span class="n">FSMC_TSET_0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="p">)</span>
		<span class="n">tims</span> <span class="o">=</span> <span class="n">timings</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tims</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_timings</span><span class="p">;</span>

	<span class="n">tclr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tims</span><span class="o">-&gt;</span><span class="n">tclr</span> <span class="o">&amp;</span> <span class="n">FSMC_TCLR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FSMC_TCLR_SHIFT</span><span class="p">;</span>
	<span class="n">tar</span> <span class="o">=</span> <span class="p">(</span><span class="n">tims</span><span class="o">-&gt;</span><span class="n">tar</span> <span class="o">&amp;</span> <span class="n">FSMC_TAR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FSMC_TAR_SHIFT</span><span class="p">;</span>
	<span class="n">thiz</span> <span class="o">=</span> <span class="p">(</span><span class="n">tims</span><span class="o">-&gt;</span><span class="n">thiz</span> <span class="o">&amp;</span> <span class="n">FSMC_THIZ_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FSMC_THIZ_SHIFT</span><span class="p">;</span>
	<span class="n">thold</span> <span class="o">=</span> <span class="p">(</span><span class="n">tims</span><span class="o">-&gt;</span><span class="n">thold</span> <span class="o">&amp;</span> <span class="n">FSMC_THOLD_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FSMC_THOLD_SHIFT</span><span class="p">;</span>
	<span class="n">twait</span> <span class="o">=</span> <span class="p">(</span><span class="n">tims</span><span class="o">-&gt;</span><span class="n">twait</span> <span class="o">&amp;</span> <span class="n">FSMC_TWAIT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FSMC_TWAIT_SHIFT</span><span class="p">;</span>
	<span class="n">tset</span> <span class="o">=</span> <span class="p">(</span><span class="n">tims</span><span class="o">-&gt;</span><span class="n">tset</span> <span class="o">&amp;</span> <span class="n">FSMC_TSET_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FSMC_TSET_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">busw</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">value</span> <span class="o">|</span> <span class="n">FSMC_DEVWID_16</span><span class="p">,</span> <span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">value</span> <span class="o">|</span> <span class="n">FSMC_DEVWID_8</span><span class="p">,</span> <span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">))</span> <span class="o">|</span> <span class="n">tclr</span> <span class="o">|</span> <span class="n">tar</span><span class="p">,</span>
			<span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">thiz</span> <span class="o">|</span> <span class="n">thold</span> <span class="o">|</span> <span class="n">twait</span> <span class="o">|</span> <span class="n">tset</span><span class="p">,</span> <span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">COMM</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">thiz</span> <span class="o">|</span> <span class="n">thold</span> <span class="o">|</span> <span class="n">twait</span> <span class="o">|</span> <span class="n">tset</span><span class="p">,</span> <span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ATTRIB</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_enable_hwecc - Enables Hardware ECC through FSMC registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_enable_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FSMC_ECCPLEN_256</span><span class="p">,</span>
			<span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FSMC_ECCEN</span><span class="p">,</span>
			<span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">))</span> <span class="o">|</span> <span class="n">FSMC_ECCEN</span><span class="p">,</span>
			<span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">PC</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_read_hwecc_ecc4 - Hardware ECC calculator for ecc4 option supported by</span>
<span class="cm"> * FSMC. ECC is 13 bytes for 512 bytes of data (supports error correction up to</span>
<span class="cm"> * max of 8-bits)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_read_hwecc_ecc4</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ecc_tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">FSMC_BUSY_WAIT_TIMEOUT</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">STS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FSMC_CODE_RDY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">deadline</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;calculate ecc timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecc_tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC1</span><span class="p">));</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">ecc_tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC2</span><span class="p">));</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">ecc_tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC3</span><span class="p">));</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">ecc_tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">STS</span><span class="p">));</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_read_hwecc_ecc1 - Hardware ECC calculator for ecc1 option supported by</span>
<span class="cm"> * FSMC. ECC is 3 bytes for 512 bytes of data (supports error correction up to</span>
<span class="cm"> * max of 1-bit)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_read_hwecc_ecc1</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ecc_tmp</span><span class="p">;</span>

	<span class="n">ecc_tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC1</span><span class="p">));</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ecc_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Count the number of 0&#39;s in buff upto a max of max_bits */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_written_bits</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">written_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">written_bits</span> <span class="o">+=</span> <span class="n">hweight8</span><span class="p">(</span><span class="o">~</span><span class="n">buff</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written_bits</span> <span class="o">&gt;</span> <span class="n">max_bits</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">written_bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_access_complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_dst</span><span class="p">,</span> <span class="n">dma_src</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span> <span class="o">|</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">write_dma_chan</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">read_dma_chan</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dma_dev</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_src</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">dma_dst</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_pa</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_COMPL_SRC_UNMAP_SINGLE</span> <span class="o">|</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_src</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_pa</span><span class="p">;</span>
		<span class="n">dma_dst</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_COMPL_DEST_UNMAP_SINGLE</span> <span class="o">|</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx</span> <span class="o">=</span> <span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_dst</span><span class="p">,</span> <span class="n">dma_src</span><span class="p">,</span>
			<span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device_prep_dma_memcpy error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dma_complete</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_submit_error</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_submit_error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>
	<span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_access_complete</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">3000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wait_for_completion_timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_write_buf - write buffer to chip</span>
<span class="cm"> * @mtd:	MTD device structure</span>
<span class="cm"> * @buf:	data buffer</span>
<span class="cm"> * @len:	number of bytes to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_read_buf - read chip data into buffer</span>
<span class="cm"> * @mtd:	MTD device structure</span>
<span class="cm"> * @buf:	buffer to store date</span>
<span class="cm"> * @len:	number of bytes to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_read_buf_dma - read chip data into buffer</span>
<span class="cm"> * @mtd:	MTD device structure</span>
<span class="cm"> * @buf:	buffer to store date</span>
<span class="cm"> * @len:	number of bytes to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_read_buf_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="n">dma_xfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_write_buf_dma - write buffer to chip</span>
<span class="cm"> * @mtd:	MTD device structure</span>
<span class="cm"> * @buf:	data buffer</span>
<span class="cm"> * @len:	number of bytes to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsmc_write_buf_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="n">dma_xfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_read_page_hwecc</span>
<span class="cm"> * @mtd:	mtd info structure</span>
<span class="cm"> * @chip:	nand chip info structure</span>
<span class="cm"> * @buf:	buffer to store read data</span>
<span class="cm"> * @oob_required:	caller expects OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page:	page number to read</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is needed for fsmc version 8 as reading from NAND chip has to be</span>
<span class="cm"> * performed in a strict sequence as follows:</span>
<span class="cm"> * data(512 byte) -&gt; ecc(13 byte)</span>
<span class="cm"> * After this read, fsmc hardware generates and reports error data bits(up to a</span>
<span class="cm"> * max of 8 bits)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_read_page_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				 <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsmc_eccplace</span> <span class="o">*</span><span class="n">ecc_place</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ecc_place</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_calc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_code</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * ecc_oob is intentionally taken as uint16_t. In 16bit devices, we</span>
<span class="cm">	 * end up reading 14 bytes (7 words) from oob. The local array is</span>
<span class="cm">	 * to maintain word alignment</span>
<span class="cm">	 */</span>
	<span class="kt">uint16_t</span> <span class="n">ecc_oob</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ecc_oob</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="n">eccsize</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_READ</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">eccbytes</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">off</span> <span class="o">=</span> <span class="n">ecc_place</span><span class="o">-&gt;</span><span class="n">eccplace</span><span class="p">[</span><span class="n">group</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ecc_place</span><span class="o">-&gt;</span><span class="n">eccplace</span><span class="p">[</span><span class="n">group</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
			<span class="n">group</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * length is intentionally kept a higher multiple of 2</span>
<span class="cm">			 * to read at least 13 bytes even in case of 16 bit NAND</span>
<span class="cm">			 * devices</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READOOB</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">j</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">+=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_bch8_correct_data</span>
<span class="cm"> * @mtd:	mtd info structure</span>
<span class="cm"> * @dat:	buffer of read data</span>
<span class="cm"> * @read_ecc:	ecc read from device spare area</span>
<span class="cm"> * @calc_ecc:	ecc calculated from read data</span>
<span class="cm"> *</span>
<span class="cm"> * calc_ecc is a 104 bit information containing maximum of 8 error</span>
<span class="cm"> * offset informations of 13 bits each in 512 bytes of read data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_bch8_correct_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span>
			     <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">read_ecc</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">calc_ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsmc_nand_data</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">err_idx</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">num_err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ecc1</span><span class="p">,</span> <span class="n">ecc2</span><span class="p">,</span> <span class="n">ecc3</span><span class="p">,</span> <span class="n">ecc4</span><span class="p">;</span>

	<span class="n">num_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">STS</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="cm">/* no bit flipping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">num_err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* too many errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num_err</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is a temporary erase check. A newly erased page read</span>
<span class="cm">		 * would result in an ecc error because the oob data is also</span>
<span class="cm">		 * erased to FF and the calculated ecc for an FF data is not</span>
<span class="cm">		 * FF..FF.</span>
<span class="cm">		 * This is a workaround to skip performing correction in case</span>
<span class="cm">		 * data is FF..FF</span>
<span class="cm">		 *</span>
<span class="cm">		 * Logic:</span>
<span class="cm">		 * For every page, each bit written as 0 is counted until these</span>
<span class="cm">		 * number of bits are greater than 8 (the maximum correction</span>
<span class="cm">		 * capability of FSMC for each 512 + 13 bytes)</span>
<span class="cm">		 */</span>

		<span class="kt">int</span> <span class="n">bits_ecc</span> <span class="o">=</span> <span class="n">count_written_bits</span><span class="p">(</span><span class="n">read_ecc</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">bits_data</span> <span class="o">=</span> <span class="n">count_written_bits</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">bits_ecc</span> <span class="o">+</span> <span class="n">bits_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits_data</span><span class="p">)</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bits_data</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ------------------- calc_ecc[] bit wise -----------|--13 bits--|</span>
<span class="cm">	 * |---idx[7]--|--.....-----|---idx[2]--||---idx[1]--||---idx[0]--|</span>
<span class="cm">	 *</span>
<span class="cm">	 * calc_ecc is a 104 bit information containing maximum of 8 error</span>
<span class="cm">	 * offset informations of 13 bits each. calc_ecc is copied into a</span>
<span class="cm">	 * uint64_t array and error offset indexes are populated in err_idx</span>
<span class="cm">	 * array</span>
<span class="cm">	 */</span>
	<span class="n">ecc1</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC1</span><span class="p">));</span>
	<span class="n">ecc2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC2</span><span class="p">));</span>
	<span class="n">ecc3</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ECC3</span><span class="p">));</span>
	<span class="n">ecc4</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">FSMC_NAND_REG</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">STS</span><span class="p">));</span>

	<span class="n">err_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecc1</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">;</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecc1</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">;</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ecc2</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ecc1</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecc2</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">;</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ecc3</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ecc2</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">);</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecc3</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">;</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecc3</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">;</span>
	<span class="n">err_idx</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ecc4</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ecc3</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num_err</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">err_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">change_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">err_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">change_bit</span><span class="p">(</span><span class="n">err_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">dat</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fsmc_nand_probe_config_dt</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Set default NAND width to 8 bits */</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;bank-width&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid bank-width %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;st,ale-off&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ale_off</span><span class="p">);</span>
	<span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;st,cle-off&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cle_off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;nand-skip-bbtscan&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">NAND_SKIP_BBTSCAN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fsmc_nand_probe_config_dt</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * fsmc_nand_probe - Probe function</span>
<span class="cm"> * @pdev:       platform device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fsmc_nand_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="n">__maybe_unused</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_part_parser_data</span> <span class="n">ppdata</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">nand</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fsmc_nand_probe_config_dt</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform data is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for the device structure (and zero it) */</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate device structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;nand_data&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get memory data resourse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_va</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;data ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ale_off</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get memory ale resourse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">addr_va</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ale_off</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">addr_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ale ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cle_off</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get memory cle resourse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_va</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cle_off</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ale ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;fsmc_regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get memory regs resourse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;regs ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to fetch block clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_clk_prepare_enable</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This device ID is actually a common AMBA ID as used on the</span>
<span class="cm">	 * AMBA PrimeCell bus. However it is not a PrimeCell.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span> <span class="o">+</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSMC device partno %03x, manufacturer %02x, &quot;</span>
		 <span class="s">&quot;revision %02x, config %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">AMBA_PART_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">AMBA_MANF_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span>
		 <span class="n">AMBA_REV_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">AMBA_CONFIG_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">select_chip</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">select_bank</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">partitions</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_partitions</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_partitions</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_timings</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nand_timings</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_DMA_ACCESS</span><span class="p">)</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_access_complete</span><span class="p">);</span>

	<span class="cm">/* Link all private pointers */</span>
	<span class="n">mtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">;</span>
	<span class="n">nand</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">nand</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">nand</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_va</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_va</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span> <span class="o">=</span> <span class="n">fsmc_cmd_ctrl</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">chip_delay</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">NAND_ECC_HW</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span> <span class="o">=</span> <span class="n">fsmc_enable_hwecc</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">select_chip</span> <span class="o">=</span> <span class="n">fsmc_select_chip</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">badblockbits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="n">FSMC_NAND_BW16</span><span class="p">)</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USE_DMA_ACCESS</span>:
		<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">read_dma_chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">read_dma_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">read_dma_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get read dma channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_req_read_chnl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">write_dma_chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">write_dma_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">write_dma_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get write dma channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_req_write_chnl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">fsmc_read_buf_dma</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">fsmc_write_buf_dma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">USE_WORD_ACCESS</span>:
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">fsmc_read_buf</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">fsmc_write_buf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsmc_nand_setup</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span>
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_timings</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AMBA_REV_BITS</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">fsmc_read_page_hwecc</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">fsmc_read_hwecc_ecc4</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span> <span class="o">=</span> <span class="n">fsmc_bch8_correct_data</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">fsmc_read_hwecc_ecc1</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span> <span class="o">=</span> <span class="n">nand_correct_data</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan to find existence of the device</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_scan_ident</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No NAND Device found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_scan_ident</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AMBA_REV_BITS</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">oobsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_16_layout</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ecc_place</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_sp_place</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_64_layout</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ecc_place</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_lp_place</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">128</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_128_layout</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ecc_place</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_lp_place</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">224</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_224_layout</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ecc_place</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_lp_place</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">256</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_256_layout</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ecc_place</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc4_lp_place</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No oob scheme defined for &quot;</span>
			       <span class="s">&quot;oobsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">oobsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc1_16_layout</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc1_64_layout</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">128</span>:
			<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_ecc1_128_layout</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No oob scheme defined for &quot;</span>
			       <span class="s">&quot;oobsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Second stage of scan to fill MTD data-structures */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_scan_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The partition information can is accessed by (in the same precedence)</span>
<span class="cm">	 *</span>
<span class="cm">	 * command line through Bootloader,</span>
<span class="cm">	 * platform data,</span>
<span class="cm">	 * default partition information present in driver.</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check for partition info passed</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nand&quot;</span><span class="p">;</span>
	<span class="n">ppdata</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_device_parse_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppdata</span><span class="p">,</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_partitions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_probe</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSMC NAND driver registration successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_probe:</span>
<span class="nl">err_scan_ident:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_DMA_ACCESS</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">write_dma_chan</span><span class="p">);</span>
<span class="nl">err_req_write_chnl:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_DMA_ACCESS</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">read_dma_chan</span><span class="p">);</span>
<span class="nl">err_req_read_chnl:</span>
	<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">err_clk_prepare_enable:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clean up routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_nand_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nand_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_DMA_ACCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">write_dma_chan</span><span class="p">);</span>
			<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">read_dma_chan</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_nand_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span>
		<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsmc_nand_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsmc_nand_data</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">fsmc_nand_setup</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs_va</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">nand</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_timings</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">fsmc_nand_pm_ops</span><span class="p">,</span> <span class="n">fsmc_nand_suspend</span><span class="p">,</span> <span class="n">fsmc_nand_resume</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">fsmc_nand_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;st,spear600-fsmc-nand&quot;</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">fsmc_nand_id_table</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fsmc_nand_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">fsmc_nand_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fsmc-nand&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">fsmc_nand_id_table</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsmc_nand_pm_ops</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fsmc_nand_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsmc_nand_driver</span><span class="p">,</span>
				     <span class="n">fsmc_nand_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">fsmc_nand_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fsmc_nand_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsmc_nand_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fsmc_nand_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Vipin Kumar &lt;vipin.kumar@st.com&gt;, Ashish Priyadarshi&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NAND driver for SPEAr Platforms&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
