<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › nand › nandsim.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nandsim.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * NAND flash simulator.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Artem B. Bityuckiy &lt;dedekind@oktetlabs.ru&gt;, &lt;dedekind@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Note: NS means &quot;NAND Simulator&quot;.</span>
<span class="cm"> * Note: Input means input TO flash chip, output means output FROM chip.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any later</span>
<span class="cm"> * version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General</span>
<span class="cm"> * Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand_bch.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>

<span class="cm">/* Default simulator parameters values */</span>
<span class="cp">#if !defined(CONFIG_NANDSIM_FIRST_ID_BYTE)  || \</span>
<span class="cp">    !defined(CONFIG_NANDSIM_SECOND_ID_BYTE) || \</span>
<span class="cp">    !defined(CONFIG_NANDSIM_THIRD_ID_BYTE)  || \</span>
<span class="cp">    !defined(CONFIG_NANDSIM_FOURTH_ID_BYTE)</span>
<span class="cp">#define CONFIG_NANDSIM_FIRST_ID_BYTE  0x98</span>
<span class="cp">#define CONFIG_NANDSIM_SECOND_ID_BYTE 0x39</span>
<span class="cp">#define CONFIG_NANDSIM_THIRD_ID_BYTE  0xFF </span><span class="cm">/* No byte */</span><span class="cp"></span>
<span class="cp">#define CONFIG_NANDSIM_FOURTH_ID_BYTE 0xFF </span><span class="cm">/* No byte */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_NANDSIM_ACCESS_DELAY</span>
<span class="cp">#define CONFIG_NANDSIM_ACCESS_DELAY 25</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_PROGRAMM_DELAY</span>
<span class="cp">#define CONFIG_NANDSIM_PROGRAMM_DELAY 200</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_ERASE_DELAY</span>
<span class="cp">#define CONFIG_NANDSIM_ERASE_DELAY 2</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_OUTPUT_CYCLE</span>
<span class="cp">#define CONFIG_NANDSIM_OUTPUT_CYCLE 40</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_INPUT_CYCLE</span>
<span class="cp">#define CONFIG_NANDSIM_INPUT_CYCLE  50</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_BUS_WIDTH</span>
<span class="cp">#define CONFIG_NANDSIM_BUS_WIDTH  8</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_DO_DELAYS</span>
<span class="cp">#define CONFIG_NANDSIM_DO_DELAYS  0</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_LOG</span>
<span class="cp">#define CONFIG_NANDSIM_LOG        0</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_DBG</span>
<span class="cp">#define CONFIG_NANDSIM_DBG        0</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_NANDSIM_MAX_PARTS</span>
<span class="cp">#define CONFIG_NANDSIM_MAX_PARTS  32</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">uint</span> <span class="n">first_id_byte</span>  <span class="o">=</span> <span class="n">CONFIG_NANDSIM_FIRST_ID_BYTE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">second_id_byte</span> <span class="o">=</span> <span class="n">CONFIG_NANDSIM_SECOND_ID_BYTE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">third_id_byte</span>  <span class="o">=</span> <span class="n">CONFIG_NANDSIM_THIRD_ID_BYTE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">fourth_id_byte</span> <span class="o">=</span> <span class="n">CONFIG_NANDSIM_FOURTH_ID_BYTE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">access_delay</span>   <span class="o">=</span> <span class="n">CONFIG_NANDSIM_ACCESS_DELAY</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">programm_delay</span> <span class="o">=</span> <span class="n">CONFIG_NANDSIM_PROGRAMM_DELAY</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">erase_delay</span>    <span class="o">=</span> <span class="n">CONFIG_NANDSIM_ERASE_DELAY</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">output_cycle</span>   <span class="o">=</span> <span class="n">CONFIG_NANDSIM_OUTPUT_CYCLE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">input_cycle</span>    <span class="o">=</span> <span class="n">CONFIG_NANDSIM_INPUT_CYCLE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">bus_width</span>      <span class="o">=</span> <span class="n">CONFIG_NANDSIM_BUS_WIDTH</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">do_delays</span>      <span class="o">=</span> <span class="n">CONFIG_NANDSIM_DO_DELAYS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">log</span>            <span class="o">=</span> <span class="n">CONFIG_NANDSIM_LOG</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">dbg</span>            <span class="o">=</span> <span class="n">CONFIG_NANDSIM_DBG</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parts</span><span class="p">[</span><span class="n">CONFIG_NANDSIM_MAX_PARTS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parts_num</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badblocks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">weakblocks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">weakpages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gravepages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rptwear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">overridesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cache_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bbt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bch</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">first_id_byte</span><span class="p">,</span>  <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">second_id_byte</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">third_id_byte</span><span class="p">,</span>  <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fourth_id_byte</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">access_delay</span><span class="p">,</span>   <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">programm_delay</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">erase_delay</span><span class="p">,</span>    <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">output_cycle</span><span class="p">,</span>   <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">input_cycle</span><span class="p">,</span>    <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bus_width</span><span class="p">,</span>      <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">do_delays</span><span class="p">,</span>      <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">log</span><span class="p">,</span>            <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbg</span><span class="p">,</span>            <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parts_num</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">badblocks</span><span class="p">,</span>      <span class="n">charp</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">weakblocks</span><span class="p">,</span>     <span class="n">charp</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">weakpages</span><span class="p">,</span>      <span class="n">charp</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bitflips</span><span class="p">,</span>       <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gravepages</span><span class="p">,</span>     <span class="n">charp</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rptwear</span><span class="p">,</span>        <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">overridesize</span><span class="p">,</span>   <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span>     <span class="n">charp</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bbt</span><span class="p">,</span>	     <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span>	     <span class="n">uint</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">first_id_byte</span><span class="p">,</span>  <span class="s">&quot;The first byte returned by NAND Flash &#39;read ID&#39; command (manufacturer ID)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">second_id_byte</span><span class="p">,</span> <span class="s">&quot;The second byte returned by NAND Flash &#39;read ID&#39; command (chip ID)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">third_id_byte</span><span class="p">,</span>  <span class="s">&quot;The third byte returned by NAND Flash &#39;read ID&#39; command&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fourth_id_byte</span><span class="p">,</span> <span class="s">&quot;The fourth byte returned by NAND Flash &#39;read ID&#39; command&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">access_delay</span><span class="p">,</span>   <span class="s">&quot;Initial page access delay (microseconds)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">programm_delay</span><span class="p">,</span> <span class="s">&quot;Page programm delay (microseconds&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">erase_delay</span><span class="p">,</span>    <span class="s">&quot;Sector erase delay (milliseconds)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">output_cycle</span><span class="p">,</span>   <span class="s">&quot;Word output (from flash) time (nanoseconds)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">input_cycle</span><span class="p">,</span>    <span class="s">&quot;Word input (to flash) time (nanoseconds)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bus_width</span><span class="p">,</span>      <span class="s">&quot;Chip&#39;s bus width (8- or 16-bit)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">do_delays</span><span class="p">,</span>      <span class="s">&quot;Simulate NAND delays using busy-waits if not zero&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log</span><span class="p">,</span>            <span class="s">&quot;Perform logging if not zero&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg</span><span class="p">,</span>            <span class="s">&quot;Output debug information if not zero&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span>          <span class="s">&quot;Partition sizes (in erase blocks) separated by commas&quot;</span><span class="p">);</span>
<span class="cm">/* Page and erase block positions for the following parameters are independent of any partitions */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">badblocks</span><span class="p">,</span>      <span class="s">&quot;Erase blocks that are initially marked bad, separated by commas&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">weakblocks</span><span class="p">,</span>     <span class="s">&quot;Weak erase blocks [: remaining erase cycles (defaults to 3)]&quot;</span>
				 <span class="s">&quot; separated by commas e.g. 113:2 means eb 113&quot;</span>
				 <span class="s">&quot; can be erased only twice before failing&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">weakpages</span><span class="p">,</span>      <span class="s">&quot;Weak pages [: maximum writes (defaults to 3)]&quot;</span>
				 <span class="s">&quot; separated by commas e.g. 1401:2 means page 1401&quot;</span>
				 <span class="s">&quot; can be written only twice before failing&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bitflips</span><span class="p">,</span>       <span class="s">&quot;Maximum number of random bit flips per page (zero by default)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gravepages</span><span class="p">,</span>     <span class="s">&quot;Pages that lose data [: maximum reads (defaults to 3)]&quot;</span>
				 <span class="s">&quot; separated by commas e.g. 1401:2 means page 1401&quot;</span>
				 <span class="s">&quot; can be read only twice before failing&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rptwear</span><span class="p">,</span>        <span class="s">&quot;Number of erases between reporting wear, if not zero&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">overridesize</span><span class="p">,</span>   <span class="s">&quot;Specifies the NAND Flash size overriding the ID bytes. &quot;</span>
				 <span class="s">&quot;The size is specified in erase blocks and as the exponent of a power of two&quot;</span>
				 <span class="s">&quot; e.g. 5 means a size of 32 erase blocks&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span>     <span class="s">&quot;File to use to cache nand pages instead of memory&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bbt</span><span class="p">,</span>		 <span class="s">&quot;0 OOB, 1 BBT with marker in OOB, 2 BBT with marker in data area&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span>		 <span class="s">&quot;Enable BCH ecc and set how many bits should &quot;</span>
				 <span class="s">&quot;be correctable in 512-byte blocks&quot;</span><span class="p">);</span>

<span class="cm">/* The largest possible page size */</span>
<span class="cp">#define NS_LARGEST_PAGE_SIZE	4096</span>

<span class="cm">/* The prefix for simulator output */</span>
<span class="cp">#define NS_OUTPUT_PREFIX &quot;[nandsim]&quot;</span>

<span class="cm">/* Simulator&#39;s output macros (logging, debugging, warning, error) */</span>
<span class="cp">#define NS_LOG(args...) \</span>
<span class="cp">	do { if (log) printk(KERN_DEBUG NS_OUTPUT_PREFIX &quot; log: &quot; args); } while(0)</span>
<span class="cp">#define NS_DBG(args...) \</span>
<span class="cp">	do { if (dbg) printk(KERN_DEBUG NS_OUTPUT_PREFIX &quot; debug: &quot; args); } while(0)</span>
<span class="cp">#define NS_WARN(args...) \</span>
<span class="cp">	do { printk(KERN_WARNING NS_OUTPUT_PREFIX &quot; warning: &quot; args); } while(0)</span>
<span class="cp">#define NS_ERR(args...) \</span>
<span class="cp">	do { printk(KERN_ERR NS_OUTPUT_PREFIX &quot; error: &quot; args); } while(0)</span>
<span class="cp">#define NS_INFO(args...) \</span>
<span class="cp">	do { printk(KERN_INFO NS_OUTPUT_PREFIX &quot; &quot; args); } while(0)</span>

<span class="cm">/* Busy-wait delay macros (microseconds, milliseconds) */</span>
<span class="cp">#define NS_UDELAY(us) \</span>
<span class="cp">        do { if (do_delays) udelay(us); } while(0)</span>
<span class="cp">#define NS_MDELAY(us) \</span>
<span class="cp">        do { if (do_delays) mdelay(us); } while(0)</span>

<span class="cm">/* Is the nandsim structure initialized ? */</span>
<span class="cp">#define NS_IS_INITIALIZED(ns) ((ns)-&gt;geom.totsz != 0)</span>

<span class="cm">/* Good operation completion status */</span>
<span class="cp">#define NS_STATUS_OK(ns) (NAND_STATUS_READY | (NAND_STATUS_WP * ((ns)-&gt;lines.wp == 0)))</span>

<span class="cm">/* Operation failed completion status */</span>
<span class="cp">#define NS_STATUS_FAILED(ns) (NAND_STATUS_FAIL | NS_STATUS_OK(ns))</span>

<span class="cm">/* Calculate the page offset in flash RAM image by (row, column) address */</span>
<span class="cp">#define NS_RAW_OFFSET(ns) \</span>
<span class="cp">	(((ns)-&gt;regs.row &lt;&lt; (ns)-&gt;geom.pgshift) + ((ns)-&gt;regs.row * (ns)-&gt;geom.oobsz) + (ns)-&gt;regs.column)</span>

<span class="cm">/* Calculate the OOB offset in flash RAM image by (row, column) address */</span>
<span class="cp">#define NS_RAW_OFFSET_OOB(ns) (NS_RAW_OFFSET(ns) + ns-&gt;geom.pgsz)</span>

<span class="cm">/* After a command is input, the simulator goes to one of the following states */</span>
<span class="cp">#define STATE_CMD_READ0        0x00000001 </span><span class="cm">/* read data from the beginning of page */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_READ1        0x00000002 </span><span class="cm">/* read data from the second half of page */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_READSTART    0x00000003 </span><span class="cm">/* read data second command (large page devices) */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_PAGEPROG     0x00000004 </span><span class="cm">/* start page program */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_READOOB      0x00000005 </span><span class="cm">/* read OOB area */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_ERASE1       0x00000006 </span><span class="cm">/* sector erase first command */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_STATUS       0x00000007 </span><span class="cm">/* read status */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_STATUS_M     0x00000008 </span><span class="cm">/* read multi-plane status (isn&#39;t implemented) */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_SEQIN        0x00000009 </span><span class="cm">/* sequential data input */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_READID       0x0000000A </span><span class="cm">/* read ID */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_ERASE2       0x0000000B </span><span class="cm">/* sector erase second command */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_RESET        0x0000000C </span><span class="cm">/* reset */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_RNDOUT       0x0000000D </span><span class="cm">/* random output command */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_RNDOUTSTART  0x0000000E </span><span class="cm">/* random output start command */</span><span class="cp"></span>
<span class="cp">#define STATE_CMD_MASK         0x0000000F </span><span class="cm">/* command states mask */</span><span class="cp"></span>

<span class="cm">/* After an address is input, the simulator goes to one of these states */</span>
<span class="cp">#define STATE_ADDR_PAGE        0x00000010 </span><span class="cm">/* full (row, column) address is accepted */</span><span class="cp"></span>
<span class="cp">#define STATE_ADDR_SEC         0x00000020 </span><span class="cm">/* sector address was accepted */</span><span class="cp"></span>
<span class="cp">#define STATE_ADDR_COLUMN      0x00000030 </span><span class="cm">/* column address was accepted */</span><span class="cp"></span>
<span class="cp">#define STATE_ADDR_ZERO        0x00000040 </span><span class="cm">/* one byte zero address was accepted */</span><span class="cp"></span>
<span class="cp">#define STATE_ADDR_MASK        0x00000070 </span><span class="cm">/* address states mask */</span><span class="cp"></span>

<span class="cm">/* During data input/output the simulator is in these states */</span>
<span class="cp">#define STATE_DATAIN           0x00000100 </span><span class="cm">/* waiting for data input */</span><span class="cp"></span>
<span class="cp">#define STATE_DATAIN_MASK      0x00000100 </span><span class="cm">/* data input states mask */</span><span class="cp"></span>

<span class="cp">#define STATE_DATAOUT          0x00001000 </span><span class="cm">/* waiting for page data output */</span><span class="cp"></span>
<span class="cp">#define STATE_DATAOUT_ID       0x00002000 </span><span class="cm">/* waiting for ID bytes output */</span><span class="cp"></span>
<span class="cp">#define STATE_DATAOUT_STATUS   0x00003000 </span><span class="cm">/* waiting for status output */</span><span class="cp"></span>
<span class="cp">#define STATE_DATAOUT_STATUS_M 0x00004000 </span><span class="cm">/* waiting for multi-plane status output */</span><span class="cp"></span>
<span class="cp">#define STATE_DATAOUT_MASK     0x00007000 </span><span class="cm">/* data output states mask */</span><span class="cp"></span>

<span class="cm">/* Previous operation is done, ready to accept new requests */</span>
<span class="cp">#define STATE_READY            0x00000000</span>

<span class="cm">/* This state is used to mark that the next state isn&#39;t known yet */</span>
<span class="cp">#define STATE_UNKNOWN          0x10000000</span>

<span class="cm">/* Simulator&#39;s actions bit masks */</span>
<span class="cp">#define ACTION_CPY       0x00100000 </span><span class="cm">/* copy page/OOB to the internal buffer */</span><span class="cp"></span>
<span class="cp">#define ACTION_PRGPAGE   0x00200000 </span><span class="cm">/* program the internal buffer to flash */</span><span class="cp"></span>
<span class="cp">#define ACTION_SECERASE  0x00300000 </span><span class="cm">/* erase sector */</span><span class="cp"></span>
<span class="cp">#define ACTION_ZEROOFF   0x00400000 </span><span class="cm">/* don&#39;t add any offset to address */</span><span class="cp"></span>
<span class="cp">#define ACTION_HALFOFF   0x00500000 </span><span class="cm">/* add to address half of page */</span><span class="cp"></span>
<span class="cp">#define ACTION_OOBOFF    0x00600000 </span><span class="cm">/* add to address OOB offset */</span><span class="cp"></span>
<span class="cp">#define ACTION_MASK      0x00700000 </span><span class="cm">/* action mask */</span><span class="cp"></span>

<span class="cp">#define NS_OPER_NUM      13 </span><span class="cm">/* Number of operations supported by the simulator */</span><span class="cp"></span>
<span class="cp">#define NS_OPER_STATES   6  </span><span class="cm">/* Maximum number of states in operation */</span><span class="cp"></span>

<span class="cp">#define OPT_ANY          0xFFFFFFFF </span><span class="cm">/* any chip supports this operation */</span><span class="cp"></span>
<span class="cp">#define OPT_PAGE256      0x00000001 </span><span class="cm">/* 256-byte  page chips */</span><span class="cp"></span>
<span class="cp">#define OPT_PAGE512      0x00000002 </span><span class="cm">/* 512-byte  page chips */</span><span class="cp"></span>
<span class="cp">#define OPT_PAGE2048     0x00000008 </span><span class="cm">/* 2048-byte page chips */</span><span class="cp"></span>
<span class="cp">#define OPT_SMARTMEDIA   0x00000010 </span><span class="cm">/* SmartMedia technology chips */</span><span class="cp"></span>
<span class="cp">#define OPT_PAGE512_8BIT 0x00000040 </span><span class="cm">/* 512-byte page chips with 8-bit bus width */</span><span class="cp"></span>
<span class="cp">#define OPT_PAGE4096     0x00000080 </span><span class="cm">/* 4096-byte page chips */</span><span class="cp"></span>
<span class="cp">#define OPT_LARGEPAGE    (OPT_PAGE2048 | OPT_PAGE4096) </span><span class="cm">/* 2048 &amp; 4096-byte page chips */</span><span class="cp"></span>
<span class="cp">#define OPT_SMALLPAGE    (OPT_PAGE256  | OPT_PAGE512)  </span><span class="cm">/* 256 and 512-byte page chips */</span><span class="cp"></span>

<span class="cm">/* Remove action bits from state */</span>
<span class="cp">#define NS_STATE(x) ((x) &amp; ~ACTION_MASK)</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum previous states which need to be saved. Currently saving is</span>
<span class="cm"> * only needed for page program operation with preceded read command</span>
<span class="cm"> * (which is only valid for 512-byte pages).</span>
<span class="cm"> */</span>
<span class="cp">#define NS_MAX_PREVSTATES 1</span>

<span class="cm">/* Maximum page cache pages needed to read or write a NAND page to the cache_file */</span>
<span class="cp">#define NS_MAX_HELD_PAGES 16</span>

<span class="cm">/*</span>
<span class="cm"> * A union to represent flash memory contents and flash buffer.</span>
<span class="cm"> */</span>
<span class="k">union</span> <span class="n">ns_mem</span> <span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">byte</span><span class="p">;</span>    <span class="cm">/* for byte access */</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">word</span><span class="p">;</span>  <span class="cm">/* for 16-bit word access */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The structure which describes all the internal simulator data.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nandsim</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">partitions</span><span class="p">[</span><span class="n">CONFIG_NANDSIM_MAX_PARTS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbparts</span><span class="p">;</span>

	<span class="n">uint</span> <span class="n">busw</span><span class="p">;</span>              <span class="cm">/* flash chip bus width (8 or 16) */</span>
	<span class="n">u_char</span> <span class="n">ids</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>          <span class="cm">/* chip&#39;s ID bytes */</span>
	<span class="kt">uint32_t</span> <span class="n">options</span><span class="p">;</span>       <span class="cm">/* chip&#39;s characteristic bits */</span>
	<span class="kt">uint32_t</span> <span class="n">state</span><span class="p">;</span>         <span class="cm">/* current chip state */</span>
	<span class="kt">uint32_t</span> <span class="n">nxstate</span><span class="p">;</span>       <span class="cm">/* next expected state */</span>

	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>           <span class="cm">/* current operation, NULL operations isn&#39;t known yet  */</span>
	<span class="kt">uint32_t</span> <span class="n">pstates</span><span class="p">[</span><span class="n">NS_MAX_PREVSTATES</span><span class="p">];</span> <span class="cm">/* previous states */</span>
	<span class="kt">uint16_t</span> <span class="n">npstates</span><span class="p">;</span>      <span class="cm">/* number of previous states saved */</span>
	<span class="kt">uint16_t</span> <span class="n">stateidx</span><span class="p">;</span>      <span class="cm">/* current state index */</span>

	<span class="cm">/* The simulated NAND flash pages array */</span>
	<span class="k">union</span> <span class="n">ns_mem</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>

	<span class="cm">/* Slab allocator for nand pages */</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">nand_pages_slab</span><span class="p">;</span>

	<span class="cm">/* Internal buffer of page + OOB size bytes */</span>
	<span class="k">union</span> <span class="n">ns_mem</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* NAND flash &quot;geometry&quot; */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">totsz</span><span class="p">;</span>     <span class="cm">/* total flash size, bytes */</span>
		<span class="kt">uint32_t</span> <span class="n">secsz</span><span class="p">;</span>     <span class="cm">/* flash sector (erase block) size, bytes */</span>
		<span class="n">uint</span> <span class="n">pgsz</span><span class="p">;</span>          <span class="cm">/* NAND flash page size, bytes */</span>
		<span class="n">uint</span> <span class="n">oobsz</span><span class="p">;</span>         <span class="cm">/* page OOB area size, bytes */</span>
		<span class="kt">uint64_t</span> <span class="n">totszoob</span><span class="p">;</span>  <span class="cm">/* total flash size including OOB, bytes */</span>
		<span class="n">uint</span> <span class="n">pgszoob</span><span class="p">;</span>       <span class="cm">/* page size including OOB , bytes*/</span>
		<span class="n">uint</span> <span class="n">secszoob</span><span class="p">;</span>      <span class="cm">/* sector size including OOB, bytes */</span>
		<span class="n">uint</span> <span class="n">pgnum</span><span class="p">;</span>         <span class="cm">/* total number of pages */</span>
		<span class="n">uint</span> <span class="n">pgsec</span><span class="p">;</span>         <span class="cm">/* number of pages per sector */</span>
		<span class="n">uint</span> <span class="n">secshift</span><span class="p">;</span>      <span class="cm">/* bits number in sector size */</span>
		<span class="n">uint</span> <span class="n">pgshift</span><span class="p">;</span>       <span class="cm">/* bits number in page size */</span>
		<span class="n">uint</span> <span class="n">oobshift</span><span class="p">;</span>      <span class="cm">/* bits number in OOB size */</span>
		<span class="n">uint</span> <span class="n">pgaddrbytes</span><span class="p">;</span>   <span class="cm">/* bytes per page address */</span>
		<span class="n">uint</span> <span class="n">secaddrbytes</span><span class="p">;</span>  <span class="cm">/* bytes per sector address */</span>
		<span class="n">uint</span> <span class="n">idbytes</span><span class="p">;</span>       <span class="cm">/* the number ID bytes that this chip outputs */</span>
	<span class="p">}</span> <span class="n">geom</span><span class="p">;</span>

	<span class="cm">/* NAND flash internal registers */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">command</span><span class="p">;</span> <span class="cm">/* the command register */</span>
		<span class="n">u_char</span>   <span class="n">status</span><span class="p">;</span>  <span class="cm">/* the status register */</span>
		<span class="n">uint</span>     <span class="n">row</span><span class="p">;</span>     <span class="cm">/* the page number */</span>
		<span class="n">uint</span>     <span class="n">column</span><span class="p">;</span>  <span class="cm">/* the offset within page */</span>
		<span class="n">uint</span>     <span class="n">count</span><span class="p">;</span>   <span class="cm">/* internal counter */</span>
		<span class="n">uint</span>     <span class="n">num</span><span class="p">;</span>     <span class="cm">/* number of bytes which must be processed */</span>
		<span class="n">uint</span>     <span class="n">off</span><span class="p">;</span>     <span class="cm">/* fixed page offset */</span>
	<span class="p">}</span> <span class="n">regs</span><span class="p">;</span>

	<span class="cm">/* NAND flash lines state */</span>
        <span class="k">struct</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">ce</span><span class="p">;</span>  <span class="cm">/* chip Enable */</span>
                <span class="kt">int</span> <span class="n">cle</span><span class="p">;</span> <span class="cm">/* command Latch Enable */</span>
                <span class="kt">int</span> <span class="n">ale</span><span class="p">;</span> <span class="cm">/* address Latch Enable */</span>
                <span class="kt">int</span> <span class="n">wp</span><span class="p">;</span>  <span class="cm">/* write Protect */</span>
        <span class="p">}</span> <span class="n">lines</span><span class="p">;</span>

	<span class="cm">/* Fields needed when using a cache file */</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">cfile</span><span class="p">;</span> <span class="cm">/* Open file */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pages_written</span><span class="p">;</span> <span class="cm">/* Which pages have been written */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">file_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">held_pages</span><span class="p">[</span><span class="n">NS_MAX_HELD_PAGES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">held_cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Operations array. To perform any operation the simulator must pass</span>
<span class="cm"> * through the correspondent states chain.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nandsim_operations</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reqopts</span><span class="p">;</span>  <span class="cm">/* options which are required to perform the operation */</span>
	<span class="kt">uint32_t</span> <span class="n">states</span><span class="p">[</span><span class="n">NS_OPER_STATES</span><span class="p">];</span> <span class="cm">/* operation&#39;s states */</span>
<span class="p">}</span> <span class="n">ops</span><span class="p">[</span><span class="n">NS_OPER_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Read page + OOB from the beginning */</span>
	<span class="p">{</span><span class="n">OPT_SMALLPAGE</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READ0</span> <span class="o">|</span> <span class="n">ACTION_ZEROOFF</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span> <span class="o">|</span> <span class="n">ACTION_CPY</span><span class="p">,</span>
			<span class="n">STATE_DATAOUT</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Read page + OOB from the second half */</span>
	<span class="p">{</span><span class="n">OPT_PAGE512_8BIT</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READ1</span> <span class="o">|</span> <span class="n">ACTION_HALFOFF</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span> <span class="o">|</span> <span class="n">ACTION_CPY</span><span class="p">,</span>
			<span class="n">STATE_DATAOUT</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Read OOB */</span>
	<span class="p">{</span><span class="n">OPT_SMALLPAGE</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READOOB</span> <span class="o">|</span> <span class="n">ACTION_OOBOFF</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span> <span class="o">|</span> <span class="n">ACTION_CPY</span><span class="p">,</span>
			<span class="n">STATE_DATAOUT</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Program page starting from the beginning */</span>
	<span class="p">{</span><span class="n">OPT_ANY</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_SEQIN</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span><span class="p">,</span> <span class="n">STATE_DATAIN</span><span class="p">,</span>
			<span class="n">STATE_CMD_PAGEPROG</span> <span class="o">|</span> <span class="n">ACTION_PRGPAGE</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Program page starting from the beginning */</span>
	<span class="p">{</span><span class="n">OPT_SMALLPAGE</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READ0</span><span class="p">,</span> <span class="n">STATE_CMD_SEQIN</span> <span class="o">|</span> <span class="n">ACTION_ZEROOFF</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span><span class="p">,</span>
			      <span class="n">STATE_DATAIN</span><span class="p">,</span> <span class="n">STATE_CMD_PAGEPROG</span> <span class="o">|</span> <span class="n">ACTION_PRGPAGE</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Program page starting from the second half */</span>
	<span class="p">{</span><span class="n">OPT_PAGE512</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READ1</span><span class="p">,</span> <span class="n">STATE_CMD_SEQIN</span> <span class="o">|</span> <span class="n">ACTION_HALFOFF</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span><span class="p">,</span>
			      <span class="n">STATE_DATAIN</span><span class="p">,</span> <span class="n">STATE_CMD_PAGEPROG</span> <span class="o">|</span> <span class="n">ACTION_PRGPAGE</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Program OOB */</span>
	<span class="p">{</span><span class="n">OPT_SMALLPAGE</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READOOB</span><span class="p">,</span> <span class="n">STATE_CMD_SEQIN</span> <span class="o">|</span> <span class="n">ACTION_OOBOFF</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span><span class="p">,</span>
			      <span class="n">STATE_DATAIN</span><span class="p">,</span> <span class="n">STATE_CMD_PAGEPROG</span> <span class="o">|</span> <span class="n">ACTION_PRGPAGE</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Erase sector */</span>
	<span class="p">{</span><span class="n">OPT_ANY</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_ERASE1</span><span class="p">,</span> <span class="n">STATE_ADDR_SEC</span><span class="p">,</span> <span class="n">STATE_CMD_ERASE2</span> <span class="o">|</span> <span class="n">ACTION_SECERASE</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Read status */</span>
	<span class="p">{</span><span class="n">OPT_ANY</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_STATUS</span><span class="p">,</span> <span class="n">STATE_DATAOUT_STATUS</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Read multi-plane status */</span>
	<span class="p">{</span><span class="n">OPT_SMARTMEDIA</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_STATUS_M</span><span class="p">,</span> <span class="n">STATE_DATAOUT_STATUS_M</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Read ID */</span>
	<span class="p">{</span><span class="n">OPT_ANY</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READID</span><span class="p">,</span> <span class="n">STATE_ADDR_ZERO</span><span class="p">,</span> <span class="n">STATE_DATAOUT_ID</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Large page devices read page */</span>
	<span class="p">{</span><span class="n">OPT_LARGEPAGE</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_READ0</span><span class="p">,</span> <span class="n">STATE_ADDR_PAGE</span><span class="p">,</span> <span class="n">STATE_CMD_READSTART</span> <span class="o">|</span> <span class="n">ACTION_CPY</span><span class="p">,</span>
			       <span class="n">STATE_DATAOUT</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
	<span class="cm">/* Large page devices random page read */</span>
	<span class="p">{</span><span class="n">OPT_LARGEPAGE</span><span class="p">,</span> <span class="p">{</span><span class="n">STATE_CMD_RNDOUT</span><span class="p">,</span> <span class="n">STATE_ADDR_COLUMN</span><span class="p">,</span> <span class="n">STATE_CMD_RNDOUTSTART</span> <span class="o">|</span> <span class="n">ACTION_CPY</span><span class="p">,</span>
			       <span class="n">STATE_DATAOUT</span><span class="p">,</span> <span class="n">STATE_READY</span><span class="p">}},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">weak_block</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erase_block_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_erases</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erases_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">weak_blocks</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">weak_page</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_writes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">writes_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">weak_pages</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">grave_page</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_reads</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reads_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">grave_pages</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">erase_block_wear</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wear_eb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_wear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rptwear_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* MTD structure for NAND controller */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">nsmtd</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">ns_verify_buf</span><span class="p">[</span><span class="n">NS_LARGEST_PAGE_SIZE</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate array of page pointers, create slab allocation for an array</span>
<span class="cm"> * and initialize the array by NULL pointers.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: 0 if success, -ENOMEM if memory alloc fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">cfile</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfile</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_LARGEFILE</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cfile</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cfile</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">aio_read</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;alloc_device: cache file not readable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">aio_write</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;alloc_device: cache file not writeable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;alloc_device: unable to allocate pages written array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">file_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">file_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;alloc_device: unable to allocate file buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span> <span class="o">=</span> <span class="n">cfile</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ns_mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;alloc_device: unable to allocate page array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">byte</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nand_pages_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;nandsim&quot;</span><span class="p">,</span>
						<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nand_pages_slab</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;cache_create: unable to create kmem_cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">);</span>
<span class="nl">err_close:</span>
	<span class="n">filp_close</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free any allocated pages, and free the array of page pointers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">file_buf</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">);</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">byte</span><span class="p">)</span>
				<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nand_pages_slab</span><span class="p">,</span>
						<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">byte</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nand_pages_slab</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_partition_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;NAND simulator partition %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">divide</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the nandsim structure.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: 0 if success, -ERRNO if failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_nandsim</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nandsim</span>   <span class="o">*</span><span class="n">ns</span>   <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">remains</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">next_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NS_IS_INITIALIZED</span><span class="p">(</span><span class="n">ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;init_nandsim: nandsim is already initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Force mtd to not do delays */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize the NAND flash parameters */</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span>    <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span>     <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobsz</span>    <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span>    <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span>  <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobsz</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span>    <span class="o">=</span> <span class="n">divide</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">);</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totszoob</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobsz</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secshift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgshift</span>  <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobshift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobsz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsec</span>    <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span> <span class="o">/</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secszoob</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobsz</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsec</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPT_PAGE256</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">==</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPT_PAGE512</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPT_PAGE512_8BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">==</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPT_PAGE2048</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPT_PAGE4096</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;init_nandsim: unknown page size %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPT_SMALLPAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fill the partition_info structure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parts_num</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;too many partitions.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remains</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span><span class="p">;</span>
	<span class="n">next_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parts_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">part_sz</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part_sz</span> <span class="o">||</span> <span class="n">part_sz</span> <span class="o">&gt;</span> <span class="n">remains</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;bad partition size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span>   <span class="o">=</span> <span class="n">get_partition_name</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">next_offset</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span>   <span class="o">=</span> <span class="n">part_sz</span><span class="p">;</span>
		<span class="n">next_offset</span> <span class="o">+=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="n">remains</span> <span class="o">-=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nbparts</span> <span class="o">=</span> <span class="n">parts_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remains</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parts_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;too many partitions.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span>   <span class="o">=</span> <span class="n">get_partition_name</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">next_offset</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span>   <span class="o">=</span> <span class="n">remains</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nbparts</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Detect how many ID bytes the NAND chip outputs */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">second_id_byte</span> <span class="o">!=</span> <span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
                        <span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;16-bit flashes support wasn&#39;t tested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flash size: %llu MiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totsz</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;page size: %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>         <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;OOB area size: %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>     <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobsz</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sector size: %u KiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>         <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pages number: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>            <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pages per sector: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>        <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsec</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bus width: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>               <span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bits in sector size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>     <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secshift</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bits in page size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>       <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgshift</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bits in OOB size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">oobshift</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flash size with OOB: %llu KiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">totszoob</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;page address bytes: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>      <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sector address bytes: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>    <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;options: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>                <span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_device</span><span class="p">(</span><span class="n">ns</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Allocate / initialize the internal buffer */</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;init_nandsim: unable to allocate %u bytes for the internal buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">free_device</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free the nandsim structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_nandsim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">free_device</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zero_ok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erase_block_no</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">badblocks</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">badblocks</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">zero_ok</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">erase_block_no</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zero_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">erase_block_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;invalid badblocks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">erase_block_no</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd_block_markbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;invalid badblocks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_weakblocks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zero_ok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erase_block_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_erases</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">weak_block</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">weakblocks</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">weakblocks</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">zero_ok</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">erase_block_no</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zero_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">erase_block_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;invalid weakblocks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_erases</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">max_erases</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;unable to allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wb</span><span class="o">-&gt;</span><span class="n">erase_block_no</span> <span class="o">=</span> <span class="n">erase_block_no</span><span class="p">;</span>
		<span class="n">wb</span><span class="o">-&gt;</span><span class="n">max_erases</span> <span class="o">=</span> <span class="n">max_erases</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weak_blocks</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">erase_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erase_block_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">weak_block</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weak_blocks</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">erase_block_no</span> <span class="o">==</span> <span class="n">erase_block_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">erases_done</span> <span class="o">&gt;=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">max_erases</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wb</span><span class="o">-&gt;</span><span class="n">erases_done</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_weakpages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zero_ok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_writes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">weak_page</span> <span class="o">*</span><span class="n">wp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">weakpages</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">weakpages</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">zero_ok</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">page_no</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zero_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">page_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;invalid weakpagess.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_writes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">max_writes</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;unable to allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wp</span><span class="o">-&gt;</span><span class="n">page_no</span> <span class="o">=</span> <span class="n">page_no</span><span class="p">;</span>
		<span class="n">wp</span><span class="o">-&gt;</span><span class="n">max_writes</span> <span class="o">=</span> <span class="n">max_writes</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weak_pages</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">weak_page</span> <span class="o">*</span><span class="n">wp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weak_pages</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">page_no</span> <span class="o">==</span> <span class="n">page_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">writes_done</span> <span class="o">&gt;=</span> <span class="n">wp</span><span class="o">-&gt;</span><span class="n">max_writes</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wp</span><span class="o">-&gt;</span><span class="n">writes_done</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_gravepages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zero_ok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_reads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grave_page</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gravepages</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">g</span> <span class="o">=</span> <span class="n">gravepages</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">zero_ok</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">g</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">page_no</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zero_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">page_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;invalid gravepagess.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_reads</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">g</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">g</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">max_reads</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">g</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
			<span class="n">g</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;unable to allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">page_no</span> <span class="o">=</span> <span class="n">page_no</span><span class="p">;</span>
		<span class="n">gp</span><span class="o">-&gt;</span><span class="n">max_reads</span> <span class="o">=</span> <span class="n">max_reads</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grave_pages</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">g</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grave_page</span> <span class="o">*</span><span class="n">gp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grave_pages</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">page_no</span> <span class="o">==</span> <span class="n">page_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gp</span><span class="o">-&gt;</span><span class="n">reads_done</span> <span class="o">&gt;=</span> <span class="n">gp</span><span class="o">-&gt;</span><span class="n">max_reads</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">gp</span><span class="o">-&gt;</span><span class="n">reads_done</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_lists</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weak_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">weak_block</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weak_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">weak_page</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grave_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">grave_page</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">erase_block_wear</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_wear_reporting</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">mem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rptwear</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wear_eb_count</span> <span class="o">=</span> <span class="n">divide</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">wear_eb_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">!=</span> <span class="n">wear_eb_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;Too many erase blocks for wear reporting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">erase_block_wear</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">erase_block_wear</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;Too many erase blocks for wear reporting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_wear</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erase_block_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">avg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deciles</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">decile_max</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">erase_block_wear</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">total_wear</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_wear</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;Erase counter total overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">erase_block_wear</span><span class="p">[</span><span class="n">erase_block_no</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erase_block_wear</span><span class="p">[</span><span class="n">erase_block_no</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;Erase counter overflow for erase block %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">erase_block_no</span><span class="p">);</span>
	<span class="n">rptwear_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rptwear_cnt</span> <span class="o">&lt;</span> <span class="n">rptwear</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rptwear_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Calc wear stats */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wear_eb_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wear</span> <span class="o">=</span> <span class="n">erase_block_wear</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wear</span> <span class="o">&lt;</span> <span class="n">wmin</span><span class="p">)</span>
			<span class="n">wmin</span> <span class="o">=</span> <span class="n">wear</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wear</span> <span class="o">&gt;</span> <span class="n">wmax</span><span class="p">)</span>
			<span class="n">wmax</span> <span class="o">=</span> <span class="n">wear</span><span class="p">;</span>
		<span class="n">tot</span> <span class="o">+=</span> <span class="n">wear</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deciles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">decile_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deciles</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">decile_max</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">wmax</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wear_eb_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wear</span> <span class="o">=</span> <span class="n">erase_block_wear</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wear</span> <span class="o">&lt;=</span> <span class="n">decile_max</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">deciles</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">avg</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">/</span> <span class="n">wear_eb_count</span><span class="p">;</span>
	<span class="cm">/* Output wear report */</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;*** Wear Report ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;Total numbers of erases:  %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tot</span><span class="p">);</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;Number of erase blocks:   %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wear_eb_count</span><span class="p">);</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;Average number of erases: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;Maximum number of erases: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wmax</span><span class="p">);</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;Minimum number of erases: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wmin</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">?</span> <span class="n">decile_max</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&gt;</span> <span class="n">decile_max</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;Number of ebs with erase counts from %lu to %lu : %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">from</span><span class="p">,</span>
			<span class="n">decile_max</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">deciles</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;*** End of Wear Report ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the string representation of &#39;state&#39; state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_state_name</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATE_CMD_READ0</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_READ0&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_READ1</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_READ1&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_PAGEPROG</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_PAGEPROG&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_READOOB</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_READOOB&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_READSTART</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_READSTART&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_ERASE1</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_ERASE1&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_STATUS</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_STATUS&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_STATUS_M</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_STATUS_M&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_SEQIN</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_SEQIN&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_READID</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_READID&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_ERASE2</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_ERASE2&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_RESET</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_RESET&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_RNDOUT</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_RNDOUT&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_CMD_RNDOUTSTART</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_CMD_RNDOUTSTART&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_ADDR_PAGE</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_ADDR_PAGE&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_ADDR_SEC</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_ADDR_SEC&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_ADDR_ZERO</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_ADDR_ZERO&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_ADDR_COLUMN</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_ADDR_COLUMN&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_DATAIN</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_DATAIN&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_DATAOUT</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_DATAOUT&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_DATAOUT_ID</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_DATAOUT_ID&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_DATAOUT_STATUS</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_DATAOUT_STATUS&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_DATAOUT_STATUS_M</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_DATAOUT_STATUS_M&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_READY</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_READY&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_UNKNOWN</span>:
			<span class="k">return</span> <span class="s">&quot;STATE_UNKNOWN&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;get_state_name: unknown state, BUG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if command is valid.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: 1 if wrong command, 0 if right.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_command</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">NAND_CMD_READ0</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_READ1</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_READSTART</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_PAGEPROG</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_READOOB</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE1</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_SEQIN</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_READID</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE2</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_RESET</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_RNDOUT</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_RNDOUTSTART</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_STATUS_MULTI</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns state after command is accepted by command number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">get_state_by_command</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NAND_CMD_READ0</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_READ0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_READ1</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_READ1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_PAGEPROG</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_PAGEPROG</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_READSTART</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_READSTART</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_READOOB</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_READOOB</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_ERASE1</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_ERASE1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_STATUS</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_STATUS</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_STATUS_MULTI</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_STATUS_M</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_SEQIN</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_SEQIN</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_READID</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_READID</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_ERASE2</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_ERASE2</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_RESET</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_RESET</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_RNDOUT</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_RNDOUT</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NAND_CMD_RNDOUTSTART</span>:
			<span class="k">return</span> <span class="n">STATE_CMD_RNDOUTSTART</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;get_state_by_command: unknown command, BUG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move an address byte to the correspondent internal register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">accept_addr_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">bt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">))</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span>
						<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span> <span class="o">+</span>
						<span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch to STATE_READY state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">switch_to_ready_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;switch_to_ready_state: switch to %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">STATE_READY</span><span class="p">));</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span>       <span class="o">=</span> <span class="n">STATE_READY</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span>     <span class="o">=</span> <span class="n">STATE_UNKNOWN</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span>          <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If the operation isn&#39;t known yet, try to find it in the global array</span>
<span class="cm"> * of supported operations.</span>
<span class="cm"> *</span>
<span class="cm"> * Operation can be unknown because of the following.</span>
<span class="cm"> *   1. New command was accepted and this is the first call to find the</span>
<span class="cm"> *      correspondent states chain. In this case ns-&gt;npstates = 0;</span>
<span class="cm"> *   2. There are several operations which begin with the same command(s)</span>
<span class="cm"> *      (for example program from the second half and read from the</span>
<span class="cm"> *      second half operations both begin with the READ1 command). In this</span>
<span class="cm"> *      case the ns-&gt;pstates[] array contains previous states.</span>
<span class="cm"> *</span>
<span class="cm"> * Thus, the function tries to find operation containing the following</span>
<span class="cm"> * states (if the &#39;flag&#39; parameter is 0):</span>
<span class="cm"> *    ns-&gt;pstates[0], ... ns-&gt;pstates[ns-&gt;npstates], ns-&gt;state</span>
<span class="cm"> *</span>
<span class="cm"> * If (one and only one) matching operation is found, it is accepted (</span>
<span class="cm"> * ns-&gt;ops, ns-&gt;state, ns-&gt;nxstate are initialized, ns-&gt;npstate is</span>
<span class="cm"> * zeroed).</span>
<span class="cm"> *</span>
<span class="cm"> * If there are several matches, the current state is pushed to the</span>
<span class="cm"> * ns-&gt;pstates.</span>
<span class="cm"> *</span>
<span class="cm"> * The operation can be unknown only while commands are input to the chip.</span>
<span class="cm"> * As soon as address command is accepted, the operation must be known.</span>
<span class="cm"> * In such situation the function is called with &#39;flag&#39; != 0, and the</span>
<span class="cm"> * operation is searched using the following pattern:</span>
<span class="cm"> *     ns-&gt;pstates[0], ... ns-&gt;pstates[ns-&gt;npstates], &lt;address input&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * It is supposed that this pattern must either match one operation or</span>
<span class="cm"> * none. There can&#39;t be ambiguity in that case.</span>
<span class="cm"> *</span>
<span class="cm"> * If no matches found, the function does the following:</span>
<span class="cm"> *   1. if there are saved states present, try to ignore them and search</span>
<span class="cm"> *      again only using the last command. If nothing was found, switch</span>
<span class="cm"> *      to the STATE_READY state.</span>
<span class="cm"> *   2. if there are no saved states, switch to the STATE_READY state.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: -2 - no matched operations found.</span>
<span class="cm"> *          -1 - several matches.</span>
<span class="cm"> *           0 - operation is found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">opsfound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NS_OPER_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reqopts</span><span class="p">))</span>
			<span class="cm">/* Ignore operations we can&#39;t perform */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">states</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATE_ADDR_MASK</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NS_STATE</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">states</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">states</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pstates</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ops</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">reqopts</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">opsfound</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opsfound</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Exact match */</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * In this case the find_operation function was</span>
<span class="cm">			 * called when address has just began input. But it isn&#39;t</span>
<span class="cm">			 * yet fully input and the current state must</span>
<span class="cm">			 * not be one of STATE_ADDR_*, but the STATE_ADDR_*</span>
<span class="cm">			 * state must be the next state (ns-&gt;nxstate).</span>
<span class="cm">			 */</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span><span class="p">];</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;find_operation: operation found, index: %d, state: %s, nxstate %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">idx</span><span class="p">,</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opsfound</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nothing was found. Try to ignore previous commands (if any) and search again */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;find_operation: no operation found, try again with state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">find_operation</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;find_operation: no operations found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This shouldn&#39;t happen */</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;find_operation: BUG, operation must be known if address is input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;find_operation: there is still ambiguity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pstates</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">npstates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">held_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">held_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Get page cache pages in advance to provide NOFS memory allocation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgoff_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="p">;</span>

	<span class="n">start_index</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">end_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_index</span> <span class="o">-</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">NS_MAX_HELD_PAGES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">held_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">start_index</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_index</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">find_get_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_inode_now</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">put_pages</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">held_pages</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">held_cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_memalloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_MEMALLOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PF_MEMALLOC</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_memalloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">memalloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memalloc</span><span class="p">)</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PF_MEMALLOC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">memalloc</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_pages</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">memalloc</span> <span class="o">=</span> <span class="n">set_memalloc</span><span class="p">();</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">vfs_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">clear_memalloc</span><span class="p">(</span><span class="n">memalloc</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="n">put_pages</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">write_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">memalloc</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_pages</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">memalloc</span> <span class="o">=</span> <span class="n">set_memalloc</span><span class="p">();</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">vfs_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">clear_memalloc</span><span class="p">(</span><span class="n">memalloc</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="n">put_pages</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns a pointer to the current page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">union</span> <span class="n">ns_mem</span> <span class="o">*</span><span class="nf">NS_GET_PAGE</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retuns a pointer to the current byte, within the current page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_char</span> <span class="o">*</span><span class="nf">NS_PAGE_BYTE_OFF</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NS_GET_PAGE</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">do_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_no</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_error</span><span class="p">(</span><span class="n">page_no</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random32</span><span class="p">();</span>
		<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;simulating read error in page %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_bit_flips</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitflips</span> <span class="o">&amp;&amp;</span> <span class="n">random32</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flips</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitflips</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">flips</span> <span class="o">=</span> <span class="p">(</span><span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">bitflips</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">flips</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="n">pos</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;read_page: flipping bit %d in page %d &quot;</span>
				<span class="s">&quot;reading from %d ecc: corrected=%u failed=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pos</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">,</span>
				<span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span><span class="p">,</span> <span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill the NAND buffer with data read from the specified page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ns_mem</span> <span class="o">*</span><span class="n">mypage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_page: page %d not written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">loff_t</span> <span class="n">pos</span><span class="p">;</span>
			<span class="kt">ssize_t</span> <span class="n">tx</span><span class="p">;</span>

			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_page: page %d written, reading from %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_read_error</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">;</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">!=</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;read_page: read error for page %d ret %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">tx</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">do_bit_flips</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mypage</span> <span class="o">=</span> <span class="n">NS_GET_PAGE</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_page: page %d not allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_page: page %d allocated, reading from %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_read_error</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">,</span> <span class="n">NS_PAGE_BYTE_OFF</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="n">num</span><span class="p">);</span>
		<span class="n">do_bit_flips</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase all pages in the specified sector.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">erase_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ns_mem</span> <span class="o">*</span><span class="n">mypage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;erase_sector: freeing page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mypage</span> <span class="o">=</span> <span class="n">NS_GET_PAGE</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;erase_sector: freeing page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nand_pages_slab</span><span class="p">,</span> <span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span><span class="p">);</span>
			<span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mypage</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Program the specified page with the contents from the NAND buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prog_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ns_mem</span> <span class="o">*</span><span class="n">mypage</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">pg_off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
		<span class="kt">ssize_t</span> <span class="n">tx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">all</span><span class="p">;</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;prog_page: writing page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
		<span class="n">pg_off</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">file_buf</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">file_buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">,</span> <span class="n">pg_off</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">!=</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;prog_page: read error for page %d ret %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">tx</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pg_off</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">all</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">;</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">write_file</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">file_buf</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">!=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;prog_page: write error for page %d ret %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">tx</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">pages_written</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">write_file</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">,</span> <span class="n">pg_off</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">!=</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;prog_page: write error for page %d ret %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">tx</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mypage</span> <span class="o">=</span> <span class="n">NS_GET_PAGE</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;prog_page: allocating page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We allocate memory with GFP_NOFS because a flash FS may</span>
<span class="cm">		 * utilize this. If it is holding an FS lock, then gets here,</span>
<span class="cm">		 * then kernel memory alloc runs writeback which goes to the FS</span>
<span class="cm">		 * again and deadlocks. This was seen in practice.</span>
<span class="cm">		 */</span>
		<span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nand_pages_slab</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;prog_page: error allocating memory for page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mypage</span><span class="o">-&gt;</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pg_off</span> <span class="o">=</span> <span class="n">NS_PAGE_BYTE_OFF</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pg_off</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If state has any action bit, perform this action.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: 0 if success, -1 if error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_state_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busdiv</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">erase_block_no</span><span class="p">,</span> <span class="n">page_no</span><span class="p">;</span>

	<span class="n">action</span> <span class="o">&amp;=</span> <span class="n">ACTION_MASK</span><span class="p">;</span>

	<span class="cm">/* Check that page address input is correct */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">ACTION_SECERASE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;do_state_action: wrong page number (%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACTION_CPY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Copy page data to the internal buffer.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Column shouldn&#39;t be very large */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;do_state_action: column number is too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span><span class="p">;</span>
		<span class="n">read_page</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: (ACTION_CPY:) copy %d bytes to int buf, raw offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">num</span><span class="p">,</span> <span class="n">NS_RAW_OFFSET</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">NS_LOG</span><span class="p">(</span><span class="s">&quot;read page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">)</span>
			<span class="n">NS_LOG</span><span class="p">(</span><span class="s">&quot;read page %d (second half)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">NS_LOG</span><span class="p">(</span><span class="s">&quot;read OOB of page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>

		<span class="n">NS_UDELAY</span><span class="p">(</span><span class="n">access_delay</span><span class="p">);</span>
		<span class="n">NS_UDELAY</span><span class="p">(</span><span class="n">input_cycle</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">busdiv</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_SECERASE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Erase sector.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">wp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;do_state_action: device is write-protected, ignore sector erase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgnum</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsec</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;do_state_action: wrong sector address (%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">&lt;&lt;</span>
				<span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">))</span> <span class="o">|</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">erase_block_no</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secshift</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgshift</span><span class="p">);</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: erase sector at address %#x, off = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">NS_RAW_OFFSET</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="n">NS_LOG</span><span class="p">(</span><span class="s">&quot;erase sector %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">erase_block_no</span><span class="p">);</span>

		<span class="n">erase_sector</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>

		<span class="n">NS_MDELAY</span><span class="p">(</span><span class="n">erase_delay</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">erase_block_wear</span><span class="p">)</span>
			<span class="n">update_wear</span><span class="p">(</span><span class="n">erase_block_no</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">erase_error</span><span class="p">(</span><span class="n">erase_block_no</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;simulating erase failure in erase block %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">erase_block_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_PRGPAGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Program page - move internal buffer data to the page.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">wp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;do_state_action: device is write-protected, programm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">!=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;do_state_action: too few bytes were input (%d instead of %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prog_page</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">page_no</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">;</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: copy %d bytes from int buf to (%#x, %#x), raw off = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">num</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span><span class="p">,</span> <span class="n">NS_RAW_OFFSET</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span><span class="p">);</span>
		<span class="n">NS_LOG</span><span class="p">(</span><span class="s">&quot;programm page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">);</span>

		<span class="n">NS_UDELAY</span><span class="p">(</span><span class="n">programm_delay</span><span class="p">);</span>
		<span class="n">NS_UDELAY</span><span class="p">(</span><span class="n">output_cycle</span> <span class="o">*</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">busdiv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">write_error</span><span class="p">(</span><span class="n">page_no</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;simulating write failure in page %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_ZEROOFF</span>:
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: set internal offset to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_HALFOFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPT_PAGE512_8BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;do_state_action: BUG! can&#39;t skip half of page for non-512&quot;</span>
				<span class="s">&quot;byte page size 8x chips</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: set internal offset to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_OOBOFF</span>:
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: set internal offset to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgsz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;do_state_action: BUG! unknown action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch simulator&#39;s state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">switch_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The current operation have already been identified.</span>
<span class="cm">		 * Just follow the states chain.</span>
<span class="cm">		 */</span>

		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;switch_state: operation is known, switch to the next state, &quot;</span>
			<span class="s">&quot;state: %s, nxstate: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">));</span>

		<span class="cm">/* See, whether we need to do some action */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ACTION_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">do_state_action</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t yet know which operation we perform.</span>
<span class="cm">		 * Try to identify it.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 *  The only event causing the switch_state function to</span>
<span class="cm">		 *  be called with yet unknown operation is new command.</span>
<span class="cm">		 */</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">get_state_by_command</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;switch_state: operation is unknown, try to find it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">find_operation</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ACTION_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">do_state_action</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* For 16x devices column means the page offset in words */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">&amp;</span> <span class="n">STATE_ADDR_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;switch_state: double the column number for 16x device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The current state is the last. Return to STATE_READY</span>
<span class="cm">		 */</span>

		<span class="n">u_char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NS_STATUS_OK</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>

		<span class="cm">/* In case of data states, see if all bytes were input/output */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATE_DATAIN_MASK</span> <span class="o">|</span> <span class="n">STATE_DATAOUT_MASK</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;switch_state: not all bytes were processed, %d left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;switch_state: operation complete, switch to STATE_READY state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATE_DATAIN_MASK</span> <span class="o">|</span> <span class="n">STATE_DATAOUT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the next state is data input/output, switch to it now</span>
<span class="cm">		 */</span>

		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span>      <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span>    <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="o">++</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">stateidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span>   <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;switch_state: the next state is data I/O, switch, &quot;</span>
			<span class="s">&quot;state: %s, nxstate: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set the internal register to the count of bytes which</span>
<span class="cm">		 * are expected to be input or output</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STATE_DATAIN</span>:
			<span class="k">case</span> <span class="n">STATE_DATAOUT</span>:
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgszoob</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">off</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STATE_DATAOUT_ID</span>:
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">idbytes</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STATE_DATAOUT_STATUS</span>:
			<span class="k">case</span> <span class="n">STATE_DATAOUT_STATUS_M</span>:
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;switch_state: BUG! unknown data state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">&amp;</span> <span class="n">STATE_ADDR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the next state is address input, set the internal</span>
<span class="cm">		 * register to the number of expected address bytes</span>
<span class="cm">		 */</span>

		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STATE_ADDR_PAGE</span>:
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STATE_ADDR_SEC</span>:
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STATE_ADDR_ZERO</span>:
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STATE_ADDR_COLUMN</span>:
				<span class="cm">/* Column address is always 2 bytes */</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span> <span class="o">-</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;switch_state: BUG! unknown address state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Just reset internal counters.</span>
<span class="cm">		 */</span>

		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="nf">ns_nand_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">outb</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* Sanity and correctness checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;read_byte: chip is disabled, return %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">outb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">outb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ale</span> <span class="o">||</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">cle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;read_byte: ALE or CLE pin is high, return %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">outb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">outb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">STATE_DATAOUT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;read_byte: unexpected data output cycle, state is %s &quot;</span>
			<span class="s">&quot;return %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">outb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">outb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Status register may be read as many times as it is wanted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_DATAOUT_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_byte: return %#x status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if there is any data in the internal buffer which may be read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;read_byte: no more data to output, return %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">outb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">outb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATE_DATAOUT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">];</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">outb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">]);</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATE_DATAOUT_ID</span>:
			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_byte: read ID byte %d, total = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
			<span class="n">outb</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">];</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_byte: all bytes were read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_READY</span><span class="p">)</span>
			<span class="n">switch_state</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">outb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_nand_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Sanity and correctness checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_byte: chip is disabled, ignore write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ale</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">cle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_byte: ALE and CLE pins are high simultaneously, ignore write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">cle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The byte written is a command.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">==</span> <span class="n">NAND_CMD_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_LOG</span><span class="p">(</span><span class="s">&quot;reset chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_OK</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check that the command byte is correct */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_command</span><span class="p">(</span><span class="n">byte</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_byte: unknown command %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">byte</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_DATAOUT_STATUS</span>
			<span class="o">||</span> <span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_DATAOUT_STATUS_M</span>
			<span class="o">||</span> <span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_DATAOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">;</span>

			<span class="n">switch_state</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">==</span> <span class="n">NAND_CMD_RNDOUT</span><span class="p">)</span>
				<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if chip is expecting command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATE_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">&amp;</span> <span class="n">STATE_CMD_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Do not warn if only 2 id bytes are read */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">NAND_CMD_READID</span> <span class="o">&amp;&amp;</span>
			    <span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_DATAOUT_ID</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We are in situation when something else (not command)</span>
<span class="cm">				 * was expected but command was input. In this case ignore</span>
<span class="cm">				 * previous command(s)/state(s) and accept the last one.</span>
<span class="cm">				 */</span>
				<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;write_byte: command (%#x) wasn&#39;t expected, expected state is %s, &quot;</span>
					<span class="s">&quot;ignore previous states</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">byte</span><span class="p">,</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;command byte corresponding to %s state accepted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_state_name</span><span class="p">(</span><span class="n">get_state_by_command</span><span class="p">(</span><span class="n">byte</span><span class="p">)));</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
		<span class="n">switch_state</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The byte written is an address.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;write_byte: operation isn&#39;t known yet, identify it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">find_operation</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ACTION_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">do_state_action</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">STATE_ADDR_PAGE</span>:
					<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">pgaddrbytes</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_ADDR_SEC</span>:
					<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">secaddrbytes</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_ADDR_ZERO</span>:
					<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check that chip is expecting address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">&amp;</span> <span class="n">STATE_ADDR_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_byte: address (%#x) isn&#39;t expected, expected state is %s, &quot;</span>
				<span class="s">&quot;switch to STATE_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">byte</span><span class="p">,</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">));</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if this is expected byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_byte: no more address bytes expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">accept_addr_byte</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;write_byte: address byte %#x was accepted (%d bytes input, %d expected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">byte</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;address (%#x, %#x) is accepted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">column</span><span class="p">);</span>
			<span class="n">switch_state</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The byte written is an input data.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Check that chip is expecting data input */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">STATE_DATAIN_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_byte: data input (%#x) isn&#39;t expected, state is %s, &quot;</span>
				<span class="s">&quot;switch to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">byte</span><span class="p">,</span>
				<span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">STATE_READY</span><span class="p">));</span>
			<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if this is expected byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;write_byte: %u input bytes has already been accepted, ignore write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">byte</span><span class="p">);</span>
			<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_hwcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">cle</span> <span class="o">=</span> <span class="n">bitmask</span> <span class="o">&amp;</span> <span class="n">NAND_CLE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="n">bitmask</span> <span class="o">&amp;</span> <span class="n">NAND_ALE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ce</span> <span class="o">=</span> <span class="n">bitmask</span> <span class="o">&amp;</span> <span class="n">NAND_NCE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">NAND_CMD_NONE</span><span class="p">)</span>
		<span class="n">ns_nand_write_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_device_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;device_ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">ns_nand_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;read_word</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_nand_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Check that chip is expecting data input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">STATE_DATAIN_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_buf: data input isn&#39;t expected, state is %s, &quot;</span>
			<span class="s">&quot;switch to STATE_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if these are expected bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;write_buf: too many input bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;write_buf: %d bytes were written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_nand_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Sanity and correctness checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;read_buf: chip is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">ale</span> <span class="o">||</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">.</span><span class="n">cle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;read_buf: ALE or CLE pin is high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">STATE_DATAOUT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NS_WARN</span><span class="p">(</span><span class="s">&quot;read_buf: unexpected data output cycle, current state is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_state_name</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATE_DATAOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if these are expected bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;read_buf: too many bytes to read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">switch_to_ready_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NS_STATUS_FAILED</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">byte</span> <span class="o">+</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NS_STATE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">nxstate</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_READY</span><span class="p">)</span>
			<span class="n">switch_state</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_nand_verify_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_nand_read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ns_verify_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns_verify_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;verify_buf: the buffer is OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NS_DBG</span><span class="p">(</span><span class="s">&quot;verify_buf: the buffer is wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Module initialization function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ns_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">nand</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">bus_width</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;wrong bus width (%d), use only 8 or 16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate and initialize mtd_info, nand_chip and nandsim structures */</span>
	<span class="n">nsmtd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span><span class="p">)</span>
				<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nsmtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;unable to allocate core structures.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span>        <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">nsmtd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">nand</span>        <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="p">)(</span><span class="n">chip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">nand</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register simulator&#39;s callbacks.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span>	 <span class="o">=</span> <span class="n">ns_hwcontrol</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span>  <span class="o">=</span> <span class="n">ns_nand_read_byte</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span>  <span class="o">=</span> <span class="n">ns_device_ready</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span>  <span class="o">=</span> <span class="n">ns_nand_write_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span>   <span class="o">=</span> <span class="n">ns_nand_read_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">verify_buf</span> <span class="o">=</span> <span class="n">ns_nand_verify_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_word</span>  <span class="o">=</span> <span class="n">ns_nand_read_word</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span>   <span class="o">=</span> <span class="n">NAND_ECC_SOFT</span><span class="p">;</span>
	<span class="cm">/* The NAND_SKIP_BBTSCAN option is necessary for &#39;overridesize&#39; */</span>
	<span class="cm">/* and &#39;badblocks&#39; parameters to work */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span>   <span class="o">|=</span> <span class="n">NAND_SKIP_BBTSCAN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bbt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">|=</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">|=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;bbt has to be 0..2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Perform minimum nandsim structure initialization to handle</span>
<span class="cm">	 * the initial ID read command correctly</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">third_id_byte</span> <span class="o">!=</span> <span class="mh">0xFF</span> <span class="o">||</span> <span class="n">fourth_id_byte</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">idbytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">idbytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">NS_STATUS_OK</span><span class="p">(</span><span class="n">nand</span><span class="p">);</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">nxstate</span> <span class="o">=</span> <span class="n">STATE_UNKNOWN</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPT_PAGE256</span><span class="p">;</span> <span class="cm">/* temporary value */</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_id_byte</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_id_byte</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">third_id_byte</span><span class="p">;</span>
	<span class="n">nand</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourth_id_byte</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nand</span><span class="o">-&gt;</span><span class="n">busw</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">parse_weakblocks</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">parse_weakpages</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">parse_gravepages</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">nand_scan_ident</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;cannot scan NAND Simulator device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eccsteps</span><span class="p">,</span> <span class="n">eccbytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd_nand_has_bch</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;BCH ECC support is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* use 512-byte ecc blocks */</span>
		<span class="n">eccsteps</span> <span class="o">=</span> <span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="o">/</span><span class="mi">512</span><span class="p">;</span>
		<span class="n">eccbytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">bch</span><span class="o">*</span><span class="mi">13</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
		<span class="cm">/* do not bother supporting small page devices */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">eccsteps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;bch not available on small page devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">eccbytes</span><span class="o">*</span><span class="n">eccsteps</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;invalid bch value %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bch</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">NAND_ECC_SOFT_BCH</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">eccbytes</span><span class="p">;</span>
		<span class="n">NS_INFO</span><span class="p">(</span><span class="s">&quot;using %u-bit/%u bytes BCH ECC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bch</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">nand_scan_tail</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;can&#39;t register NAND Simulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overridesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">&lt;&lt;</span> <span class="n">overridesize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&gt;&gt;</span> <span class="n">overridesize</span> <span class="o">!=</span> <span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_ERR</span><span class="p">(</span><span class="s">&quot;overridesize is too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* N.B. This relies on nand_scan not doing anything with the size before we change it */</span>
		<span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span> <span class="o">+</span> <span class="n">overridesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">setup_wear_reporting</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">init_nandsim</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">nand_default_bbt</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">parse_badblocks</span><span class="p">(</span><span class="n">nand</span><span class="p">,</span> <span class="n">nsmtd</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

	<span class="cm">/* Register NAND partitions */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mtd_device_register</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nand</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				     <span class="n">nand</span><span class="o">-&gt;</span><span class="n">nbparts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_exit:</span>
	<span class="n">free_nandsim</span><span class="p">(</span><span class="n">nand</span><span class="p">);</span>
	<span class="n">nand_release</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nand</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nand</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">);</span>
	<span class="n">free_lists</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ns_init_module</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Module clean-up function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ns_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nandsim</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">nsmtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">free_nandsim</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>    <span class="cm">/* Free nandsim private resources */</span>
	<span class="n">nand_release</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">);</span> <span class="cm">/* Unregister driver */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nsmtd</span><span class="p">);</span>        <span class="cm">/* Free other structures */</span>
	<span class="n">free_lists</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">ns_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span> <span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;Artem B. Bityuckiy&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;The NAND flash simulator&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
