<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › nand › mpc5121_nfc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpc5121_nfc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2004-2008 Freescale Semiconductor, Inc.</span>
<span class="cm"> * Copyright 2009 Semihalf.</span>
<span class="cm"> *</span>
<span class="cm"> * Approved as OSADL project by a majority of OSADL members and funded</span>
<span class="cm"> * by OSADL membership fees in 2009;  for details see www.osadl.org.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on original driver from Freescale Semiconductor</span>
<span class="cm"> * written by John Rigby &lt;jrigby@freescale.com&gt; on basis</span>
<span class="cm"> * of drivers/mtd/nand/mxc_nand.c. Reworked and extended</span>
<span class="cm"> * Piotr Ziecik &lt;kosmo@semihalf.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,</span>
<span class="cm"> * MA 02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>

<span class="cp">#include &lt;asm/mpc5121.h&gt;</span>

<span class="cm">/* Addresses for NFC MAIN RAM BUFFER areas */</span>
<span class="cp">#define NFC_MAIN_AREA(n)	((n) *  0x200)</span>

<span class="cm">/* Addresses for NFC SPARE BUFFER areas */</span>
<span class="cp">#define NFC_SPARE_BUFFERS	8</span>
<span class="cp">#define NFC_SPARE_LEN		0x40</span>
<span class="cp">#define NFC_SPARE_AREA(n)	(0x1000 + ((n) * NFC_SPARE_LEN))</span>

<span class="cm">/* MPC5121 NFC registers */</span>
<span class="cp">#define NFC_BUF_ADDR		0x1E04</span>
<span class="cp">#define NFC_FLASH_ADDR		0x1E06</span>
<span class="cp">#define NFC_FLASH_CMD		0x1E08</span>
<span class="cp">#define NFC_CONFIG		0x1E0A</span>
<span class="cp">#define NFC_ECC_STATUS1		0x1E0C</span>
<span class="cp">#define NFC_ECC_STATUS2		0x1E0E</span>
<span class="cp">#define NFC_SPAS		0x1E10</span>
<span class="cp">#define NFC_WRPROT		0x1E12</span>
<span class="cp">#define NFC_NF_WRPRST		0x1E18</span>
<span class="cp">#define NFC_CONFIG1		0x1E1A</span>
<span class="cp">#define NFC_CONFIG2		0x1E1C</span>
<span class="cp">#define NFC_UNLOCKSTART_BLK0	0x1E20</span>
<span class="cp">#define NFC_UNLOCKEND_BLK0	0x1E22</span>
<span class="cp">#define NFC_UNLOCKSTART_BLK1	0x1E24</span>
<span class="cp">#define NFC_UNLOCKEND_BLK1	0x1E26</span>
<span class="cp">#define NFC_UNLOCKSTART_BLK2	0x1E28</span>
<span class="cp">#define NFC_UNLOCKEND_BLK2	0x1E2A</span>
<span class="cp">#define NFC_UNLOCKSTART_BLK3	0x1E2C</span>
<span class="cp">#define NFC_UNLOCKEND_BLK3	0x1E2E</span>

<span class="cm">/* Bit Definitions: NFC_BUF_ADDR */</span>
<span class="cp">#define NFC_RBA_MASK		(7 &lt;&lt; 0)</span>
<span class="cp">#define NFC_ACTIVE_CS_SHIFT	5</span>
<span class="cp">#define NFC_ACTIVE_CS_MASK	(3 &lt;&lt; NFC_ACTIVE_CS_SHIFT)</span>

<span class="cm">/* Bit Definitions: NFC_CONFIG */</span>
<span class="cp">#define NFC_BLS_UNLOCKED	(1 &lt;&lt; 1)</span>

<span class="cm">/* Bit Definitions: NFC_CONFIG1 */</span>
<span class="cp">#define NFC_ECC_4BIT		(1 &lt;&lt; 0)</span>
<span class="cp">#define NFC_FULL_PAGE_DMA	(1 &lt;&lt; 1)</span>
<span class="cp">#define NFC_SPARE_ONLY		(1 &lt;&lt; 2)</span>
<span class="cp">#define NFC_ECC_ENABLE		(1 &lt;&lt; 3)</span>
<span class="cp">#define NFC_INT_MASK		(1 &lt;&lt; 4)</span>
<span class="cp">#define NFC_BIG_ENDIAN		(1 &lt;&lt; 5)</span>
<span class="cp">#define NFC_RESET		(1 &lt;&lt; 6)</span>
<span class="cp">#define NFC_CE			(1 &lt;&lt; 7)</span>
<span class="cp">#define NFC_ONE_CYCLE		(1 &lt;&lt; 8)</span>
<span class="cp">#define NFC_PPB_32		(0 &lt;&lt; 9)</span>
<span class="cp">#define NFC_PPB_64		(1 &lt;&lt; 9)</span>
<span class="cp">#define NFC_PPB_128		(2 &lt;&lt; 9)</span>
<span class="cp">#define NFC_PPB_256		(3 &lt;&lt; 9)</span>
<span class="cp">#define NFC_PPB_MASK		(3 &lt;&lt; 9)</span>
<span class="cp">#define NFC_FULL_PAGE_INT	(1 &lt;&lt; 11)</span>

<span class="cm">/* Bit Definitions: NFC_CONFIG2 */</span>
<span class="cp">#define NFC_COMMAND		(1 &lt;&lt; 0)</span>
<span class="cp">#define NFC_ADDRESS		(1 &lt;&lt; 1)</span>
<span class="cp">#define NFC_INPUT		(1 &lt;&lt; 2)</span>
<span class="cp">#define NFC_OUTPUT		(1 &lt;&lt; 3)</span>
<span class="cp">#define NFC_ID			(1 &lt;&lt; 4)</span>
<span class="cp">#define NFC_STATUS		(1 &lt;&lt; 5)</span>
<span class="cp">#define NFC_CMD_FAIL		(1 &lt;&lt; 15)</span>
<span class="cp">#define NFC_INT			(1 &lt;&lt; 15)</span>

<span class="cm">/* Bit Definitions: NFC_WRPROT */</span>
<span class="cp">#define NFC_WPC_LOCK_TIGHT	(1 &lt;&lt; 0)</span>
<span class="cp">#define NFC_WPC_LOCK		(1 &lt;&lt; 1)</span>
<span class="cp">#define NFC_WPC_UNLOCK		(1 &lt;&lt; 2)</span>

<span class="cp">#define	DRV_NAME		&quot;mpc5121_nfc&quot;</span>

<span class="cm">/* Timeouts */</span>
<span class="cp">#define NFC_RESET_TIMEOUT	1000		</span><span class="cm">/* 1 ms */</span><span class="cp"></span>
<span class="cp">#define NFC_TIMEOUT		(HZ / 10)	</span><span class="cm">/* 1/10 s */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span>		<span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span>	<span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">irq_waitq</span><span class="p">;</span>
	<span class="n">uint</span>			<span class="n">column</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">spareonly</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">csreg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">);</span>

<span class="cm">/* Read NFC register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">nfc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">uint</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">in_be16</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Write NFC register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">uint</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set bits in NFC register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfc_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">uint</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">nfc_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clear bits in NFC register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfc_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">uint</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">nfc_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Invoke address cycle */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_send_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_FLASH_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_ADDRESS</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Invoke command cycle */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_FLASH_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_COMMAND</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send data from NFC buffers to NAND flash */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_send_prog_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_BUF_ADDR</span><span class="p">,</span> <span class="n">NFC_RBA_MASK</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_INPUT</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Receive data from NAND flash */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_send_read_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_BUF_ADDR</span><span class="p">,</span> <span class="n">NFC_RBA_MASK</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_OUTPUT</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Receive ID from NAND flash */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_send_read_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_BUF_ADDR</span><span class="p">,</span> <span class="n">NFC_RBA_MASK</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_ID</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Receive status from NAND flash */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_send_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_BUF_ADDR</span><span class="p">,</span> <span class="n">NFC_RBA_MASK</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_STATUS</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_done</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* NFC interrupt handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mpc5121_nfc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_INT_MASK</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq_waitq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait for operation complete */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nfc_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NFC_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_INT_MASK</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq_waitq</span><span class="p">,</span>
			<span class="p">(</span><span class="n">nfc_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NFC_INT</span><span class="p">),</span> <span class="n">NFC_TIMEOUT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Timeout while waiting for interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG2</span><span class="p">,</span> <span class="n">NFC_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Do address cycle(s) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_addr_cycle</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pagemask</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc5121_nfc_send_addr</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">column</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
			<span class="n">mpc5121_nfc_send_addr</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">column</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">mpc5121_nfc_send_addr</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">page</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">pagemask</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pagemask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Control chip select signals */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_select_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_CE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfc_clear</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_BUF_ADDR</span><span class="p">,</span> <span class="n">NFC_ACTIVE_CS_MASK</span><span class="p">);</span>
	<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_BUF_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&lt;&lt;</span> <span class="n">NFC_ACTIVE_CS_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">NFC_ACTIVE_CS_MASK</span><span class="p">);</span>
	<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_CE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Init external chip select logic on ADS5121 board */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ads5121_chipselect_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,mpc5121ads-cpld&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* CPLD Register 9 controls NAND /CE Lines */</span>
		<span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Control chips select signal on ADS5121 board */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ads5121_select_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">nand</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">nand</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc5121_nfc_select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mpc5121_nfc_select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">out_8</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read NAND Ready/Busy signal */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc5121_nfc_dev_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NFC handles ready/busy signal internally. Therefore, this function</span>
<span class="cm">	 * always returns status as ready.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write command to NAND flash */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">command</span><span class="p">,</span>
							<span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">column</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">spareonly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NAND_CMD_PAGEPROG</span>:
		<span class="n">mpc5121_nfc_send_prog_page</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * NFC does not support sub-page reads and writes,</span>
<span class="cm">	 * so emulate them using full page transfers.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">NAND_CMD_READ0</span>:
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_READ1</span>:
		<span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_READOOB</span>:
		<span class="n">prv</span><span class="o">-&gt;</span><span class="n">spareonly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_SEQIN</span>:
		<span class="n">mpc5121_nfc_command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_ERASE1</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE2</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_READID</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpc5121_nfc_send_cmd</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_addr_cycle</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NAND_CMD_READ0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
			<span class="n">mpc5121_nfc_send_cmd</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READSTART</span><span class="p">);</span>
		<span class="n">mpc5121_nfc_send_read_page</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_READID</span>:
		<span class="n">mpc5121_nfc_send_read_id</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_STATUS</span>:
		<span class="n">mpc5121_nfc_send_read_status</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span>
			<span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Copy data from/to NFC spare buffers. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_copy_spare</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">uint</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">nand</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">nand</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sbsize</span><span class="p">,</span> <span class="n">blksize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NAND spare area is available through NFC spare buffers.</span>
<span class="cm">	 * The NFC divides spare area into (page_size / 512) chunks.</span>
<span class="cm">	 * Each chunk is placed into separate spare memory area, using</span>
<span class="cm">	 * first (spare_size / num_of_chunks) bytes of the buffer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For NAND device in which the spare area is not divided fully</span>
<span class="cm">	 * by the number of chunks, number of used bytes in each spare</span>
<span class="cm">	 * buffer is rounded down to the nearest even number of bytes,</span>
<span class="cm">	 * and all remaining bytes are added to the last used spare area.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For more information read section 26.6.10 of MPC5121e</span>
<span class="cm">	 * Microcontroller Reference Manual, Rev. 3.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Calculate number of valid bytes in each spare buffer */</span>
	<span class="n">sbsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">/</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">/</span> <span class="mi">512</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate spare buffer number */</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">sbsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">NFC_SPARE_BUFFERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">NFC_SPARE_BUFFERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate offset to requested data block in selected spare</span>
<span class="cm">		 * buffer and its size.</span>
<span class="cm">		 */</span>
		<span class="n">o</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">sbsize</span><span class="p">);</span>
		<span class="n">blksize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sbsize</span> <span class="o">-</span> <span class="n">o</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NFC_SPARE_AREA</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span>
							<span class="n">buffer</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NFC_SPARE_AREA</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>

		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">blksize</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="cm">/* Copy data from/to NFC main and spare buffers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_buf_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
									<span class="kt">int</span> <span class="n">wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">c</span> <span class="o">=</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Handle spare area access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">spareonly</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate offset from beginning of spare area */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">-=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

		<span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">mpc5121_nfc_copy_spare</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">wr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle main area access - limit copy length to prevent</span>
<span class="cm">	 * crossing main/spare boundary.</span>
<span class="cm">	 */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NFC_MAIN_AREA</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NFC_MAIN_AREA</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="cm">/* Handle crossing main/spare boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">mpc5121_nfc_buf_copy</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">wr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Read data from NFC buffers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpc5121_nfc_buf_copy</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Write data to NFC buffers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
						<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpc5121_nfc_buf_copy</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Compare buffer with NAND flash */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc5121_nfc_verify_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
						<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">bsize</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bsize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">mpc5121_nfc_read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bsize</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">bsize</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">bsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read byte from NFC buffers */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">mpc5121_nfc_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mpc5121_nfc_read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read word from NFC buffers */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">mpc5121_nfc_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mpc5121_nfc_read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read NFC configuration from Reset Config Word</span>
<span class="cm"> *</span>
<span class="cm"> * NFC is configured during reset in basis of information stored</span>
<span class="cm"> * in Reset Config Word. There is no other way to set NAND block</span>
<span class="cm"> * size, spare size and bus width.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc5121_nfc_read_hw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc512x_reset_module</span> <span class="o">*</span><span class="n">rm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">rmnode</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rcw_pagesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rcw_sparesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rcw_width</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rcwh</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">romloc</span><span class="p">,</span> <span class="n">ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rmnode</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,mpc5121-reset&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing &#39;fsl,mpc5121-reset&#39; &quot;</span>
					<span class="s">&quot;node in device tree!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rm</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">rmnode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error mapping reset module node!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcwh</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="o">-&gt;</span><span class="n">rcwhr</span><span class="p">);</span>

	<span class="cm">/* Bit 6: NFC bus width */</span>
	<span class="n">rcw_width</span> <span class="o">=</span> <span class="p">((</span><span class="n">rcwh</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Bit 7: NFC Page/Spare size */</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcwh</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/* Bits [22:21]: ROM Location */</span>
	<span class="n">romloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcwh</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="cm">/* Decode RCW bits */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">romloc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">rcw_pagesize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">rcw_sparesize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="n">rcw_pagesize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">rcw_sparesize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">rcw_pagesize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">rcw_sparesize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">rcw_pagesize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">rcw_sparesize</span> <span class="o">=</span> <span class="mi">218</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="n">rcw_pagesize</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="n">rcw_sparesize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcw_width</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">;</span>

	<span class="n">dev_notice</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Configured for &quot;</span>
				<span class="s">&quot;%u-bit NAND, page size %u &quot;</span>
				<span class="s">&quot;with %u spare.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rcw_width</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">rcw_pagesize</span><span class="p">,</span>
				<span class="n">rcw_sparesize</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">rm</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">rmnode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free driver resources */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc5121_nfc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">csreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mpc5121_nfc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">rootnode</span><span class="p">,</span> <span class="o">*</span><span class="n">dn</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regs_paddr</span><span class="p">,</span> <span class="n">regs_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">chips_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resettime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_part_parser_data</span> <span class="n">ppdata</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check SoC revision. This driver supports only NFC</span>
<span class="cm">	 * in MPC5121 revision 2 and MPC5123 revision 3.</span>
<span class="cm">	 */</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_SVR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SoC revision %u is not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">prv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory exhausted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">;</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">prv</span><span class="p">;</span>
	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Read NFC configuration from Reset Config Word */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mpc5121_nfc_read_hw_config</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to read NFC config!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error mapping IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error parsing memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chips_no</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;chips&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chips_no</span> <span class="o">||</span> <span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chips_no</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid/missing &#39;chips&#39; property!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regs_paddr</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">regs_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs_paddr</span><span class="p">,</span> <span class="n">regs_size</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error requesting memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs_paddr</span><span class="p">,</span> <span class="n">regs_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error mapping memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPC5121 NAND&quot;</span><span class="p">;</span>
	<span class="n">ppdata</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">dn</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span> <span class="o">=</span> <span class="n">mpc5121_nfc_dev_ready</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span> <span class="o">=</span> <span class="n">mpc5121_nfc_command</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span> <span class="o">=</span> <span class="n">mpc5121_nfc_read_byte</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_word</span> <span class="o">=</span> <span class="n">mpc5121_nfc_read_word</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">mpc5121_nfc_read_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">mpc5121_nfc_write_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">verify_buf</span> <span class="o">=</span> <span class="n">mpc5121_nfc_verify_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span> <span class="o">=</span> <span class="n">mpc5121_nfc_select_chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">NAND_ECC_SOFT</span><span class="p">;</span>

	<span class="cm">/* Support external chip-select logic on ADS5121 board */</span>
	<span class="n">rootnode</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">rootnode</span><span class="p">,</span> <span class="s">&quot;fsl,mpc5121ads&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ads5121_chipselect_init</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chipselect init error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">rootnode</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span> <span class="o">=</span> <span class="n">ads5121_select_chip</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">rootnode</span><span class="p">);</span>

	<span class="cm">/* Enable NFC clock */</span>
	<span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nfc_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to acquire NFC clock!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="cm">/* Reset NAND Flash controller */</span>
	<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_RESET</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nfc_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NFC_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resettime</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">NFC_RESET_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout while resetting NFC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable write to NFC memory */</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG</span><span class="p">,</span> <span class="n">NFC_BLS_UNLOCKED</span><span class="p">);</span>

	<span class="cm">/* Enable write to all NAND pages */</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_UNLOCKSTART_BLK0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_UNLOCKEND_BLK0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_WRPROT</span><span class="p">,</span> <span class="n">NFC_WPC_UNLOCK</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup NFC:</span>
<span class="cm">	 *	- Big Endian transfers,</span>
<span class="cm">	 *	- Interrupt after full page read/write.</span>
<span class="cm">	 */</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_BIG_ENDIAN</span> <span class="o">|</span> <span class="n">NFC_INT_MASK</span> <span class="o">|</span>
							<span class="n">NFC_FULL_PAGE_INT</span><span class="p">);</span>

	<span class="cm">/* Set spare area size */</span>
	<span class="n">nfc_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_SPAS</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq_waitq</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc5121_nfc_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span>
									<span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error requesting IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Detect NAND chips */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_scan</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">chips_no</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NAND Flash not found !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set erase block size */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">/</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_PPB_32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_PPB_64</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_PPB_128</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">nfc_set</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NFC_CONFIG1</span><span class="p">,</span> <span class="n">NFC_PPB_256</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unsupported NAND flash!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>

	<span class="cm">/* Register device in MTD */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mtd_device_parse_register</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error adding MTD device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">mpc5121_nfc_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mpc5121_nfc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc5121_nfc_prv</span> <span class="o">*</span><span class="n">prv</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">nand_release</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="n">mpc5121_nfc_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc5121_nfc_match</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5121-nfc&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mpc5121_nfc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mpc5121_nfc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mpc5121_nfc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">mpc5121_nfc_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mpc5121_nfc_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Freescale Semiconductor, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MPC5121 NAND MTD driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
