<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › nand › nand_bbt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nand_bbt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/mtd/nand_bbt.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Overview:</span>
<span class="cm"> *   Bad block table support for the NAND driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004 Thomas Gleixner (tglx@linutronix.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *</span>
<span class="cm"> * When nand_scan_bbt is called, then it tries to find the bad block table</span>
<span class="cm"> * depending on the options in the BBT descriptor(s). If no flash based BBT</span>
<span class="cm"> * (NAND_BBT_USE_FLASH) is specified then the device is scanned for factory</span>
<span class="cm"> * marked good / bad blocks. This information is used to create a memory BBT.</span>
<span class="cm"> * Once a new bad block is discovered then the &quot;factory&quot; information is updated</span>
<span class="cm"> * on the device.</span>
<span class="cm"> * If a flash based BBT is specified then the function first tries to find the</span>
<span class="cm"> * BBT on flash. If a BBT is found then the contents are read and the memory</span>
<span class="cm"> * based BBT is created. If a mirrored BBT is selected then the mirror is</span>
<span class="cm"> * searched too and the versions are compared. If the mirror has a greater</span>
<span class="cm"> * version number than the mirror BBT is used to build the memory based BBT.</span>
<span class="cm"> * If the tables are not versioned, then we &quot;or&quot; the bad block information.</span>
<span class="cm"> * If one of the BBTs is out of date or does not exist it is (re)created.</span>
<span class="cm"> * If no BBT exists at all then the device is scanned for factory marked</span>
<span class="cm"> * good / bad blocks and the bad block tables are created.</span>
<span class="cm"> *</span>
<span class="cm"> * For manufacturer created BBTs like the one found on M-SYS DOC devices</span>
<span class="cm"> * the BBT is searched and read but never created</span>
<span class="cm"> *</span>
<span class="cm"> * The auto generated bad block table is located in the last good blocks</span>
<span class="cm"> * of the device. The table is mirrored, so it can be updated eventually.</span>
<span class="cm"> * The table is marked in the OOB area with an ident pattern and a version</span>
<span class="cm"> * number which indicates which of both tables is more up to date. If the NAND</span>
<span class="cm"> * controller needs the complete OOB area for the ECC information then the</span>
<span class="cm"> * option NAND_BBT_NO_OOB should be used (along with NAND_BBT_USE_FLASH, of</span>
<span class="cm"> * course): it moves the ident pattern and the version byte into the data area</span>
<span class="cm"> * and the OOB area will remain untouched.</span>
<span class="cm"> *</span>
<span class="cm"> * The table uses 2 bits per block</span>
<span class="cm"> * 11b:		block is good</span>
<span class="cm"> * 00b:		block is factory marked bad</span>
<span class="cm"> * 01b, 10b:	block is marked bad due to wear</span>
<span class="cm"> *</span>
<span class="cm"> * The memory bad block table uses the following scheme:</span>
<span class="cm"> * 00b:		block is good</span>
<span class="cm"> * 01b:		block is marked bad due to wear</span>
<span class="cm"> * 10b:		block is reserved (to protect the bbt area)</span>
<span class="cm"> * 11b:		block is factory marked bad</span>
<span class="cm"> *</span>
<span class="cm"> * Multichip devices like DOC store the bad block info per floor.</span>
<span class="cm"> *</span>
<span class="cm"> * Following assumptions are made:</span>
<span class="cm"> * - bbts start at a page boundary, if autolocated on a block boundary</span>
<span class="cm"> * - the space necessary for a bbt in FLASH does not exceed a block boundary</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand_ecc.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_pattern_no_oob</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * check_pattern - [GENERIC] check if a pattern is in the buffer</span>
<span class="cm"> * @buf: the buffer to search</span>
<span class="cm"> * @len: the length of buffer to search</span>
<span class="cm"> * @paglen: the pagelength</span>
<span class="cm"> * @td: search pattern descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Check for a pattern at the given place. Used to search bad block tables and</span>
<span class="cm"> * good / bad block identifiers. If the SCAN_EMPTY option is set then check, if</span>
<span class="cm"> * all bytes except the pattern area contain 0xff.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_pattern</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">paglen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">check_pattern_no_oob</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">paglen</span> <span class="o">+</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">offs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANEMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Compare the pattern */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANEMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">+=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * check_short_pattern - [GENERIC] check if a pattern is in the buffer</span>
<span class="cm"> * @buf: the buffer to search</span>
<span class="cm"> * @td:	search pattern descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Check for a pattern at the given place. Used to search bad block tables and</span>
<span class="cm"> * good / bad block identifiers. Same as check_pattern, but no optional empty</span>
<span class="cm"> * check.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_short_pattern</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Compare the pattern */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">offs</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * add_marker_len - compute the length of the marker in data area</span>
<span class="cm"> * @td: BBT descriptor used for computation</span>
<span class="cm"> *</span>
<span class="cm"> * The length will be 0 if the marker is located in OOB area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">add_marker_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_bbt - [GENERIC] Read the bad block table starting from page</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @page: the starting page</span>
<span class="cm"> * @num: the number of bbt descriptors to read</span>
<span class="cm"> * @td: the bbt describtion table</span>
<span class="cm"> * @offs: offset in the memory table</span>
<span class="cm"> *</span>
<span class="cm"> * Read the bad block table starting from page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">from</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NRBITS_MSK</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">msk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">marker_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reserved_block_code</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">reserved_block_code</span><span class="p">;</span>

	<span class="n">totlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">bits</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">marker_len</span> <span class="o">=</span> <span class="n">add_marker_len</span><span class="p">(</span><span class="n">td</span><span class="p">);</span>
	<span class="n">from</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">page</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">totlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">totlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">marker_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * In case the BBT marker is not in the OOB area it</span>
<span class="cm">			 * will be just in the first page.</span>
<span class="cm">			 */</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">marker_len</span><span class="p">;</span>
			<span class="n">from</span> <span class="o">+=</span> <span class="n">marker_len</span><span class="p">;</span>
			<span class="n">marker_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nand_bbt: ECC error in BBT at &quot;</span>
					<span class="s">&quot;0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_bitflip</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nand_bbt: corrected error in BBT at &quot;</span>
					<span class="s">&quot;0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nand_bbt: error reading BBT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Analyse data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">bits</span><span class="p">,</span> <span class="n">act</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">uint8_t</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">msk</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">reserved_block_code</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">reserved_block_code</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nand_read_bbt: reserved block at 0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">loff_t</span><span class="p">)((</span><span class="n">offs</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">act</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
					<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">offs</span> <span class="o">+</span> <span class="p">(</span><span class="n">act</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">|=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">);</span>
					<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">bbtblocks</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * Leave it for now, if it&#39;s matured we can</span>
<span class="cm">				 * move this message to pr_debug.</span>
<span class="cm">				 */</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nand_read_bbt: bad block at 0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">loff_t</span><span class="p">)((</span><span class="n">offs</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">act</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
				<span class="cm">/* Factory marked bad or worn out? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">offs</span> <span class="o">+</span> <span class="p">(</span><span class="n">act</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">|=</span> <span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">offs</span> <span class="o">+</span> <span class="p">(</span><span class="n">act</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">|=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">);</span>
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">badblocks</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">totlen</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">from</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_abs_bbt - [GENERIC] Read the bad block table starting at a given page</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @td: descriptor for the bad block table</span>
<span class="cm"> * @chip: read the table for a specific chip, -1 read all chips; applies only if</span>
<span class="cm"> *        NAND_BBT_PERCHIP option is set</span>
<span class="cm"> *</span>
<span class="cm"> * Read the bad block table for all chips starting at a given page. We assume</span>
<span class="cm"> * that the bbt bits are in consecutive order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_abs_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">chip</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">read_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">,</span>
					<span class="n">td</span><span class="p">,</span> <span class="n">offs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">offs</span> <span class="o">+=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">read_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* BBT marker is in the first page, no OOB */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_read_raw_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Scan read raw data from flash */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_read_raw_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_RAW</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">ops</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">+</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_read_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">scan_read_raw_data</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">scan_read_raw_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Scan write data with oob to flash */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_write_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">oob</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mtd_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bbt_get_ver_offs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ver_offs</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">veroffs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">))</span>
		<span class="n">ver_offs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ver_offs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_abs_bbts - [GENERIC] Read the bad block table(s) for all chips starting at a given page</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @td: descriptor for the bad block table</span>
<span class="cm"> * @md:	descriptor for the bad block table mirror</span>
<span class="cm"> *</span>
<span class="cm"> * Read the bad block table(s) for all chips starting at a given page. We</span>
<span class="cm"> * assume that the bbt bits are in consecutive order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_abs_bbts</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Read the primary version, if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan_read_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">,</span>
			      <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">bbt_get_ver_offs</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">td</span><span class="p">)];</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad block table at page %d, version 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Read the mirror version, if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scan_read_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">,</span>
			      <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">bbt_get_ver_offs</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">md</span><span class="p">)];</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad block table at page %d, version 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Scan a given block full */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_block_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span>
			   <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">readlen</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">scanlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scan_read_raw_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
	<span class="cm">/* Ignore ECC errors when checking for BBM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mtd_is_bitflip_or_eccerr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+=</span> <span class="n">scanlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_pattern</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scanlen</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">bd</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Scan a given block partially */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_block_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span>
			   <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Read the full oob until read_oob is fixed to handle single</span>
<span class="cm">		 * byte reads for 16 bit buswidth.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
		<span class="cm">/* Ignore ECC errors when checking for BBM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mtd_is_bitflip_or_eccerr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">check_short_pattern</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bd</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">offs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * create_bbt - [GENERIC] Create a bad block table by scanning the device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @bd: descriptor for the good/bad block search pattern</span>
<span class="cm"> * @chip: create the table for a specific chip, -1 read all chips; applies only</span>
<span class="cm"> *        if NAND_BBT_PERCHIP option is set</span>
<span class="cm"> *</span>
<span class="cm"> * Create a bad block table by scanning the device for the given good/bad block</span>
<span class="cm"> * identify pattern.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">numblocks</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">scanlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">startblock</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">from</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">readlen</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Scanning device for bad blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANALLPAGES</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCAN2NDPAGE</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANEMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We need only read few bytes from the OOB area */</span>
		<span class="n">scanlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">readlen</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Full page content should be read */</span>
		<span class="n">scanlen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">+</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
		<span class="n">readlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note that numblocks is 2 * (real numblocks) here, see i+=2</span>
<span class="cm">		 * below as it makes shifting and masking less painful</span>
<span class="cm">		 */</span>
		<span class="n">numblocks</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">startblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;create_bbt(): chipnr (%d) &gt; available chips (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">chip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">numblocks</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">startblock</span> <span class="o">=</span> <span class="n">chip</span> <span class="o">*</span> <span class="n">numblocks</span><span class="p">;</span>
		<span class="n">numblocks</span> <span class="o">+=</span> <span class="n">startblock</span><span class="p">;</span>
		<span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">startblock</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANLASTPAGE</span><span class="p">)</span>
		<span class="n">from</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">-</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">*</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">startblock</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numblocks</span><span class="p">;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANALLPAGES</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scan_block_full</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">readlen</span><span class="p">,</span>
					      <span class="n">scanlen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scan_block_fast</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x6</span><span class="p">);</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Bad eraseblock %d at 0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">from</span><span class="p">);</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">badblocks</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">from</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * search_bbt - [GENERIC] scan the device for a specific bad block table</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @td: descriptor for the bad block table</span>
<span class="cm"> *</span>
<span class="cm"> * Read the bad block table by searching for a given ident pattern. Search is</span>
<span class="cm"> * preformed either from the beginning up or from the end of the device</span>
<span class="cm"> * downwards. The search starts always at the start of a block. If the option</span>
<span class="cm"> * NAND_BBT_PERCHIP is given, each chip is searched for a bbt, which contains</span>
<span class="cm"> * the bad block information of this chip. This is necessary to provide support</span>
<span class="cm"> * for certain DOC devices.</span>
<span class="cm"> *</span>
<span class="cm"> * The bbt ident pattern resides in the oob area of the first page in a block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">search_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chips</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">startblock</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scanlen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">+</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bbtblocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocktopage</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>

	<span class="cm">/* Search direction top -&gt; down? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_LASTBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">startblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">startblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do we have a bbt per chip? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chips</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">;</span>
		<span class="n">bbtblocks</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
		<span class="n">startblock</span> <span class="o">&amp;=</span> <span class="n">bbtblocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chips</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bbtblocks</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Number of bits for each erase block in the bbt */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NRBITS_MSK</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset version information */</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Scan the maximum number of blocks */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxblocks</span><span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="kt">int</span> <span class="n">actblock</span> <span class="o">=</span> <span class="n">startblock</span> <span class="o">+</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">block</span><span class="p">;</span>
			<span class="n">loff_t</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">actblock</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>

			<span class="cm">/* Read first page */</span>
			<span class="n">scan_read_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_pattern</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scanlen</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">td</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">actblock</span> <span class="o">&lt;&lt;</span> <span class="n">blocktopage</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">offs</span> <span class="o">=</span> <span class="n">bbt_get_ver_offs</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
					<span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">offs</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">startblock</span> <span class="o">+=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check, if we found a bbt for each requested chip */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Bad block table not found for chip %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad block table found at page %d, version &quot;</span>
				 <span class="s">&quot;0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * search_read_bbts - [GENERIC] scan the device for bad block table(s)</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @td: descriptor for the bad block table</span>
<span class="cm"> * @md: descriptor for the bad block table mirror</span>
<span class="cm"> *</span>
<span class="cm"> * Search and read the bad block table(s).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">search_read_bbts</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Search the primary table */</span>
	<span class="n">search_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>

	<span class="cm">/* Search the mirror table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span>
		<span class="n">search_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>

	<span class="cm">/* Force result check */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * write_bbt - [GENERIC] (Re)write the bad block table</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @td: descriptor for the bad block table</span>
<span class="cm"> * @md: descriptor for the bad block table mirror</span>
<span class="cm"> * @chipsel: selector for a specific chip, -1 for all</span>
<span class="cm"> *</span>
<span class="cm"> * (Re)write the bad block table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">chipsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">erase_info</span> <span class="n">einfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">startblock</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">numblocks</span><span class="p">,</span> <span class="n">sft</span><span class="p">,</span> <span class="n">sftmsk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nrchips</span><span class="p">,</span> <span class="n">bbtoffs</span><span class="p">,</span> <span class="n">pageoffs</span><span class="p">,</span> <span class="n">ooboffs</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">msk</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">rcode</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">reserved_block_code</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">to</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcode</span><span class="p">)</span>
		<span class="n">rcode</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* Write bad block table per chip rather than per device? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">numblocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
		<span class="cm">/* Full device write or specific chip? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chipsel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nrchips</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nrchips</span> <span class="o">=</span> <span class="n">chipsel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span> <span class="o">=</span> <span class="n">chipsel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">numblocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
		<span class="n">nrchips</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loop through the chips */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">nrchips</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * There was already a version of the table, reuse the page</span>
<span class="cm">		 * This applies for absolute placement too, as we have the</span>
<span class="cm">		 * page nr. in td-&gt;pages.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chip</span><span class="p">];</span>
			<span class="k">goto</span> <span class="n">write</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Automatic placement of the bad block table. Search direction</span>
<span class="cm">		 * top -&gt; down?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_LASTBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">startblock</span> <span class="o">=</span> <span class="n">numblocks</span> <span class="o">*</span> <span class="p">(</span><span class="n">chip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">startblock</span> <span class="o">=</span> <span class="n">chip</span> <span class="o">*</span> <span class="n">numblocks</span><span class="p">;</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxblocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="n">startblock</span> <span class="o">+</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
			<span class="cm">/* Check, if the block is bad */</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span>
				 <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="k">case</span> <span class="mh">0x03</span>:
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
			<span class="cm">/* Check, if the block is used by the mirror table */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span> <span class="o">||</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span> <span class="o">!=</span> <span class="n">page</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">write</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No space left to write bad block table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="nl">write:</span>

		<span class="cm">/* Set up shift count and masks for the flash table */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NRBITS_MSK</span><span class="p">;</span>
		<span class="n">msk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">rcode</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">sft</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">sftmsk</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">msk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">sft</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">sftmsk</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">msk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">sft</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">sftmsk</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
			<span class="n">msk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="n">sft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sftmsk</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">msk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">msk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bbtoffs</span> <span class="o">=</span> <span class="n">chip</span> <span class="o">*</span> <span class="p">(</span><span class="n">numblocks</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">to</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">page</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>

		<span class="cm">/* Must we save the block contents? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SAVECONTENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Make it block aligned */</span>
			<span class="n">to</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">loff_t</span><span class="p">)((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nand_bbt: error reading block &quot;</span>
						<span class="s">&quot;for writing the bad block table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;nand_bbt: ECC error while reading &quot;</span>
					<span class="s">&quot;block for writing bad block table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Read oob data */</span>
			<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
			<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span> <span class="o">+</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>

			<span class="cm">/* Calc the byte offset in the buffer */</span>
			<span class="n">pageoffs</span> <span class="o">=</span> <span class="n">page</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
			<span class="n">offs</span> <span class="o">=</span> <span class="n">pageoffs</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
			<span class="cm">/* Preset the bbt area with 0xff */</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">offs</span><span class="p">],</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">numblocks</span> <span class="o">&gt;&gt;</span> <span class="n">sft</span><span class="p">));</span>
			<span class="n">ooboffs</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="p">(</span><span class="n">pageoffs</span> <span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">offs</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="cm">/* The version byte */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span>
				<span class="n">offs</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Calc length */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">numblocks</span> <span class="o">&gt;&gt;</span> <span class="n">sft</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">offs</span><span class="p">;</span>
			<span class="cm">/* Make it page aligned! */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
			<span class="cm">/* Preset the buffer with 0xff */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="cm">/* Pattern is located at the begin of first page */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Calc length */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">numblocks</span> <span class="o">&gt;&gt;</span> <span class="n">sft</span><span class="p">);</span>
			<span class="cm">/* Make it page aligned! */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
			<span class="cm">/* Preset the buffer with 0xff */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span>
			       <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span><span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
			<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ooboffs</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="cm">/* Pattern is located in oob area of first page */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">ooboffs</span> <span class="o">+</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">offs</span><span class="p">],</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ooboffs</span> <span class="o">+</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">veroffs</span><span class="p">]</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">chip</span><span class="p">];</span>

		<span class="cm">/* Walk through the memory table */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numblocks</span><span class="p">;)</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">dat</span><span class="p">;</span>
			<span class="n">dat</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">bbtoffs</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">sftcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">sft</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">sftmsk</span><span class="p">;</span>
				<span class="cm">/* Do not store the reserved bbt blocks! */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">offs</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="n">sft</span><span class="p">)]</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">msk</span><span class="p">[</span><span class="n">dat</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">sftcnt</span><span class="p">);</span>
				<span class="n">dat</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">einfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">einfo</span><span class="p">));</span>
		<span class="n">einfo</span><span class="p">.</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>
		<span class="n">einfo</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
		<span class="n">einfo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">nand_erase_nand</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">einfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">scan_write_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				<span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span>
				<span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bad block table written to 0x%012llx, version 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">to</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">chip</span><span class="p">]);</span>

		<span class="cm">/* Mark it as used */</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">outerr:</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;nand_bbt: error while writing bad block table %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_memory_bbt - [GENERIC] create a memory based bad block table</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @bd: descriptor for the good/bad block search pattern</span>
<span class="cm"> *</span>
<span class="cm"> * The function creates a memory based bbt by scanning the device for</span>
<span class="cm"> * manufacturer / software marked good / bad blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nand_memory_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_BBT_SCANEMPTY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">create_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * check_create - [GENERIC] create and write bbt(s) if necessary</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: temporary buffer</span>
<span class="cm"> * @bd: descriptor for the good/bad block search pattern</span>
<span class="cm"> *</span>
<span class="cm"> * The function checks the results of the previous call to read_bbt and creates</span>
<span class="cm"> * / updates the bbt(s) if necessary. Creation is necessary if no bbt was found</span>
<span class="cm"> * for the chip/device. Update is necessary if one of the tables is missing or</span>
<span class="cm"> * the version nr. of one table is less than the other.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chips</span><span class="p">,</span> <span class="n">writeops</span><span class="p">,</span> <span class="n">create</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">,</span> <span class="o">*</span><span class="n">rd2</span><span class="p">;</span>

	<span class="cm">/* Do we have a bbt per chip? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span>
		<span class="n">chips</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chips</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">create</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rd2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Per chip or per device? */</span>
		<span class="n">chipsel</span> <span class="o">=</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Mirrored table available? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">create</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>
				<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
				<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">))</span>
					<span class="n">rd2</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int8_t</span><span class="p">)(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
				<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>
				<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">create</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">create</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Create the bad block table by scanning the device? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_CREATE</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Create the table in memory by scanning the chip(s) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_CREATE_EMPTY</span><span class="p">))</span>
				<span class="n">create_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>

			<span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span>
				<span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read back first? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">read_abs_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Mark table as invalid */</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* If they weren&#39;t versioned, read both */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res2</span> <span class="o">=</span> <span class="n">read_abs_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">rd2</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">res2</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Mark table as invalid */</span>
				<span class="n">rd2</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">rd2</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Scrub the flash table(s)? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_bitflip</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">||</span> <span class="n">mtd_is_bitflip</span><span class="p">(</span><span class="n">res2</span><span class="p">))</span>
			<span class="n">writeops</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="cm">/* Update version numbers before writing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/* Write the bad block table to the device? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">writeops</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">write_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Write the mirror bad block table to the device? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">writeops</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">md</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">write_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mark_bbt_regions - [GENERIC] mark the bad block table regions</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @td: bad block table descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * The bad block table regions are marked as &quot;bad&quot; to prevent accidental</span>
<span class="cm"> * erasures / writes. The regions are identified by the mark 0x02.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_bbt_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">chips</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">nrblocks</span><span class="p">,</span> <span class="n">update</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="p">;</span>

	<span class="cm">/* Do we have a bbt per chip? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chips</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">;</span>
		<span class="n">nrblocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chips</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nrblocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_ABSPAGE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
			<span class="n">block</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">oldval</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)];</span>
			<span class="n">newval</span> <span class="o">=</span> <span class="n">oldval</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">));</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">newval</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">oldval</span> <span class="o">!=</span> <span class="n">newval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">reserved_block_code</span><span class="p">)</span>
				<span class="n">nand_update_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_LASTBLOCK</span><span class="p">)</span>
			<span class="n">block</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrblocks</span><span class="p">)</span> <span class="o">-</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxblocks</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nrblocks</span><span class="p">;</span>
		<span class="n">block</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxblocks</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">oldval</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)];</span>
			<span class="n">newval</span> <span class="o">=</span> <span class="n">oldval</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">));</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">newval</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oldval</span> <span class="o">!=</span> <span class="n">newval</span><span class="p">)</span>
				<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">block</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we want reserved blocks to be recorded to flash, and some</span>
<span class="cm">		 * new ones have been marked, then we need to update the stored</span>
<span class="cm">		 * bbts.  This should only happen once.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">reserved_block_code</span><span class="p">)</span>
			<span class="n">nand_update_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)(</span><span class="n">block</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * verify_bbt_descr - verify the bad block description</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @bd: the table to verify</span>
<span class="cm"> *</span>
<span class="cm"> * This functions performs a few sanity checks on the bad block description</span>
<span class="cm"> * table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_bbt_descr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pattern_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">table_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pattern_len</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NRBITS_MSK</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span>
		<span class="n">pattern_len</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">offs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_VERSION</span><span class="p">)</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">veroffs</span> <span class="o">!=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SAVECONTENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span>
		<span class="n">table_size</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">table_size</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">;</span>
	<span class="n">table_size</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">table_size</span> <span class="o">*=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span>
		<span class="n">table_size</span> <span class="o">+=</span> <span class="n">pattern_len</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">table_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_scan_bbt - [NAND Interface] scan, find, read and maybe create bad block table(s)</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @bd: descriptor for the good/bad block search pattern</span>
<span class="cm"> *</span>
<span class="cm"> * The function checks, if a bad block table(s) is/are already available. If</span>
<span class="cm"> * not it scans the device for manufacturer marked good / bad blocks and writes</span>
<span class="cm"> * the bad block table(s) to the selected place.</span>
<span class="cm"> *</span>
<span class="cm"> * The bad block table memory is allocated here. It must be freed by calling</span>
<span class="cm"> * the nand_free_bbt function.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_scan_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate memory (2bit per block) and clear the memory bad block</span>
<span class="cm">	 * table.</span>
<span class="cm">	 */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no primary table decriptor is given, scan the device to build a</span>
<span class="cm">	 * memory based bad block table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">nand_memory_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bd</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;nand_bbt: can&#39;t scan flash and build the RAM-based BBT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">);</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">verify_bbt_descr</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="n">verify_bbt_descr</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>

	<span class="cm">/* Allocate a temporary buffer for one eraseblock incl. oob */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Is the bbt at a given page? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_ABSPAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">read_abs_bbts</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Search the bad block table using a pattern in oob */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">search_read_bbts</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">check_create</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>

	<span class="cm">/* Prevent the bbt regions from erasing / writing */</span>
	<span class="n">mark_bbt_region</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span>
		<span class="n">mark_bbt_region</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_update_bbt - [NAND Interface] update bad block table(s)</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @offs: the offset of the newly marked block</span>
<span class="cm"> *</span>
<span class="cm"> * The function updates the bad block table(s).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_update_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span> <span class="o">||</span> <span class="o">!</span><span class="n">td</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Allocate a temporary buffer for one eraseblock incl. oob */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Do we have a bbt per chip? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">offs</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>
		<span class="n">chipsel</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chipsel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">td</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Write the bad block table to the device? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">write_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Write the mirror bad block table to the device? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">write_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">chipsel</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Define some generic bad / good block scan pattern which are used</span>
<span class="cm"> * while scanning a device for factory marked good / bad blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">scan_ff_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">scan_agand_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xC7</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="n">agand_flashbased</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">NAND_BBT_SCANEMPTY</span> <span class="o">|</span> <span class="n">NAND_BBT_SCANALLPAGES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offs</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">scan_agand_pattern</span>
<span class="p">};</span>

<span class="cm">/* Generic flash bbt descriptors */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">bbt_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">mirror_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="n">bbt_main_descr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">NAND_BBT_LASTBLOCK</span> <span class="o">|</span> <span class="n">NAND_BBT_CREATE</span> <span class="o">|</span> <span class="n">NAND_BBT_WRITE</span>
		<span class="o">|</span> <span class="n">NAND_BBT_2BIT</span> <span class="o">|</span> <span class="n">NAND_BBT_VERSION</span> <span class="o">|</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offs</span> <span class="o">=</span>	<span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">veroffs</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxblocks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">bbt_pattern</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="n">bbt_mirror_descr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">NAND_BBT_LASTBLOCK</span> <span class="o">|</span> <span class="n">NAND_BBT_CREATE</span> <span class="o">|</span> <span class="n">NAND_BBT_WRITE</span>
		<span class="o">|</span> <span class="n">NAND_BBT_2BIT</span> <span class="o">|</span> <span class="n">NAND_BBT_VERSION</span> <span class="o">|</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offs</span> <span class="o">=</span>	<span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">veroffs</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxblocks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">mirror_pattern</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="n">bbt_main_no_bbt_descr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">NAND_BBT_LASTBLOCK</span> <span class="o">|</span> <span class="n">NAND_BBT_CREATE</span> <span class="o">|</span> <span class="n">NAND_BBT_WRITE</span>
		<span class="o">|</span> <span class="n">NAND_BBT_2BIT</span> <span class="o">|</span> <span class="n">NAND_BBT_VERSION</span> <span class="o">|</span> <span class="n">NAND_BBT_PERCHIP</span>
		<span class="o">|</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">veroffs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxblocks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">bbt_pattern</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="n">bbt_mirror_no_bbt_descr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">NAND_BBT_LASTBLOCK</span> <span class="o">|</span> <span class="n">NAND_BBT_CREATE</span> <span class="o">|</span> <span class="n">NAND_BBT_WRITE</span>
		<span class="o">|</span> <span class="n">NAND_BBT_2BIT</span> <span class="o">|</span> <span class="n">NAND_BBT_VERSION</span> <span class="o">|</span> <span class="n">NAND_BBT_PERCHIP</span>
		<span class="o">|</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">veroffs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxblocks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">mirror_pattern</span>
<span class="p">};</span>

<span class="cp">#define BADBLOCK_SCAN_MASK (~NAND_BBT_NO_OOB)</span>
<span class="cm">/**</span>
<span class="cm"> * nand_create_badblock_pattern - [INTERN] Creates a BBT descriptor structure</span>
<span class="cm"> * @this: NAND chip to create descriptor for</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates and initializes a nand_bbt_descr for BBM detection</span>
<span class="cm"> * based on the properties of @this. The new descriptor is stored in</span>
<span class="cm"> * this-&gt;badblock_pattern. Thus, this-&gt;badblock_pattern should be NULL when</span>
<span class="cm"> * passed to this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_create_badblock_pattern</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_bbt_descr</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Bad block pattern already allocated; not replacing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">BADBLOCK_SCAN_MASK</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">offs</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">badblockpos</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">scan_ff_pattern</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NAND_BBT_DYNAMICSTRUCT</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_default_bbt - [NAND Interface] Select a default bad block table for the device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function selects the default bad block table support for the device and</span>
<span class="cm"> * calls the nand_scan_bbt function.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_default_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Default for AG-AND. We must use a flash based bad block table as the</span>
<span class="cm">	 * devices have factory marked _good_ blocks. Erasing those blocks</span>
<span class="cm">	 * leads to loss of the good / bad information, so we _must_ store this</span>
<span class="cm">	 * information in a good / bad table during startup.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_IS_AND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use the default pattern descriptors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bbt_main_descr</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bbt_mirror_descr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">|=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">nand_scan_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agand_flashbased</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Is a flash based bad block table requested? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use the default pattern descriptors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bbt_main_no_bbt_descr</span><span class="p">;</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bbt_mirror_no_bbt_descr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bbt_main_descr</span><span class="p">;</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bbt_mirror_descr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_md</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span><span class="p">)</span>
		<span class="n">nand_create_badblock_pattern</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nand_scan_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_isbad_bbt - [NAND Interface] Check if a block is bad</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @offs: offset in the device</span>
<span class="cm"> * @allowbbt: allow access to bad block table region</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_isbad_bbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allowbbt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* Get block number * 2 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">offs</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nand_isbad_bbt(): bbt info for offs 0x%08x: &quot;</span>
			<span class="s">&quot;(block %d) 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">offs</span><span class="p">,</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="k">return</span> <span class="n">allowbbt</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_scan_bbt</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_default_bbt</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
