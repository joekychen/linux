<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › nand › nand_base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nand_base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/mtd/nand.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Overview:</span>
<span class="cm"> *   This is the generic MTD driver for NAND flash devices. It should be</span>
<span class="cm"> *   capable of working with almost all NAND chips currently available.</span>
<span class="cm"> *   Basic support for AG-AND chips is provided.</span>
<span class="cm"> *</span>
<span class="cm"> *	Additional technical information is available on</span>
<span class="cm"> *	http://www.linux-mtd.infradead.org/doc/nand.html</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2000 Steven J. Hill (sjhill@realitydiluted.com)</span>
<span class="cm"> *		  2002-2006 Thomas Gleixner (tglx@linutronix.de)</span>
<span class="cm"> *</span>
<span class="cm"> *  Credits:</span>
<span class="cm"> *	David Woodhouse for adding multichip support</span>
<span class="cm"> *</span>
<span class="cm"> *	Aleph One Ltd. and Toby Churchill Ltd. for supporting the</span>
<span class="cm"> *	rework for 2K page size chips</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *	Enable cached programming for 2k page size chips</span>
<span class="cm"> *	Check, if mtd-&gt;ecctype should be set to MTD_ECC_HW</span>
<span class="cm"> *	if we have HW ECC support.</span>
<span class="cm"> *	The AG-AND chips have nice features for speed improvement,</span>
<span class="cm"> *	which are not supported yet. Read / program 4 pages in one go.</span>
<span class="cm"> *	BBT table is not serialized, has to be fixed</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand_ecc.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand_bch.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>

<span class="cm">/* Define default oob placement schemes for large and small page devices */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">nand_oob_8</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">nand_oob_16</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		 <span class="p">.</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">nand_oob_64</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
		   <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
		   <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">38</span><span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">nand_oob_128</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="mi">80</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span>
		   <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span>
		   <span class="mi">96</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span>
		   <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span>
		   <span class="mi">112</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span>
		   <span class="mi">120</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">127</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">78</span><span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nand_get_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">new_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nand_do_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * For devices which display every fart in the system on a separate LED. Is</span>
<span class="cm"> * compiled away when LED support is disabled.</span>
<span class="cm"> */</span>
<span class="n">DEFINE_LED_TRIGGER</span><span class="p">(</span><span class="n">nand_led_trigger</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_offs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
					<span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Start address must align on block boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: unaligned address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Length must align on block boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: length not block aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_release_device - [GENERIC] release chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Deselect, release chip lock and wake up anyone waiting on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_release_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* De-select the NAND device */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Release the controller and the chip */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FL_READY</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_byte - [DEFAULT] read one byte from the chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Default read function for 8bit buswidth</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">nand_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_byte16 - [DEFAULT] read one byte endianess aware from the chip</span>
<span class="cm"> * nand_read_byte16 - [DEFAULT] read one byte endianness aware from the chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Default read function for 16bit buswidth with endianness conversion.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">nand_read_byte16</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_word - [DEFAULT] read one word from the chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Default read function for 16bit buswidth without endianness conversion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">nand_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_select_chip - [DEFAULT] control CE line</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @chipnr: chipnumber to select, -1 for deselect</span>
<span class="cm"> *</span>
<span class="cm"> * Default select function for 1 chip devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_select_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chipnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chipnr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_buf - [DEFAULT] write buffer to chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @len: number of bytes to write</span>
<span class="cm"> *</span>
<span class="cm"> * Default write function for 8bit buswidth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_buf - [DEFAULT] read chip data into buffer</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: buffer to store date</span>
<span class="cm"> * @len: number of bytes to read</span>
<span class="cm"> *</span>
<span class="cm"> * Default read function for 8bit buswidth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_verify_buf - [DEFAULT] Verify chip data against buffer</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: buffer containing the data to compare</span>
<span class="cm"> * @len: number of bytes to compare</span>
<span class="cm"> *</span>
<span class="cm"> * Default verify function for 8bit buswidth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_verify_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">readb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_buf16 - [DEFAULT] write buffer to chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @len: number of bytes to write</span>
<span class="cm"> *</span>
<span class="cm"> * Default write function for 16bit buswidth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_buf16</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_buf16 - [DEFAULT] read chip data into buffer</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: buffer to store date</span>
<span class="cm"> * @len: number of bytes to read</span>
<span class="cm"> *</span>
<span class="cm"> * Default read function for 16bit buswidth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_read_buf16</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_verify_buf16 - [DEFAULT] Verify chip data against buffer</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @buf: buffer containing the data to compare</span>
<span class="cm"> * @len: number of bytes to compare</span>
<span class="cm"> *</span>
<span class="cm"> * Default verify function for 16bit buswidth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_verify_buf16</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">readw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_block_bad - [DEFAULT] Read bad block marker from the chip</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @ofs: offset from device start</span>
<span class="cm"> * @getchip: 0, if the chip is already selected</span>
<span class="cm"> *</span>
<span class="cm"> * Check, if the block is bad.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_block_bad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">getchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANLASTPAGE</span><span class="p">)</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">-</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getchip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chipnr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>

		<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>

		<span class="cm">/* Select the NAND device */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READOOB</span><span class="p">,</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockpos</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">bad</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">mtd</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockpos</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
				<span class="n">bad</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bad</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READOOB</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockpos</span><span class="p">,</span>
					<span class="n">page</span><span class="p">);</span>
			<span class="n">bad</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockbits</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">bad</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">hweight8</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockbits</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCAN2NDPAGE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getchip</span><span class="p">)</span>
		<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_default_block_markbad - [DEFAULT] mark a block bad</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @ofs: offset from device start</span>
<span class="cm"> *</span>
<span class="cm"> * This is the default implementation, which can be overridden by a hardware</span>
<span class="cm"> * specific driver. We try operations in the following order, according to our</span>
<span class="cm"> * bbt_options (NAND_BBT_NO_OOB_BBM and NAND_BBT_USE_FLASH):</span>
<span class="cm"> *  (1) erase the affected block, to allow OOB marker to be written cleanly</span>
<span class="cm"> *  (2) update in-memory BBT</span>
<span class="cm"> *  (3) write bad block marker to OOB area of affected block</span>
<span class="cm"> *  (4) update flash-based BBT</span>
<span class="cm"> * Note that we retain the first error encountered in (3) or (4), finish the</span>
<span class="cm"> * procedures, and dump the error in the end.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_default_block_markbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_oob</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB_BBM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_oob</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">erase_info</span> <span class="n">einfo</span><span class="p">;</span>

		<span class="cm">/* Attempt erase before marking OOB */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">einfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">einfo</span><span class="p">));</span>
		<span class="n">einfo</span><span class="p">.</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>
		<span class="n">einfo</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="n">einfo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span><span class="p">;</span>
		<span class="n">nand_erase_nand</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">einfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get block number */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span><span class="p">);</span>
	<span class="cm">/* Mark block bad in memory-based BBT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Write bad block marker to OOB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_oob</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
		<span class="n">loff_t</span> <span class="n">wr_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>

		<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>

		<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockpos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
			<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>

		<span class="cm">/* Write to first/last page(s) if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCANLASTPAGE</span><span class="p">)</span>
			<span class="n">wr_ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">-</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">nand_do_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">wr_ofs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">wr_ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_SCAN2NDPAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update flash-based bad block table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">nand_update_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">badblocks</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_check_wp - [GENERIC] check if the chip is write protected</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Check, if the device is write protected. The function expects, that the</span>
<span class="cm"> * device is already selected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_check_wp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Broken xD cards report WP despite being writable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BROKEN_XD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check the WP bit */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_WP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_block_checkbad - [GENERIC] Check if a block is marked bad</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @ofs: offset from device start</span>
<span class="cm"> * @getchip: 0, if the chip is already selected</span>
<span class="cm"> * @allowbbt: 1, if its allowed to access the bbt area</span>
<span class="cm"> *</span>
<span class="cm"> * Check, if the block is bad. Either by reading the bad block table or</span>
<span class="cm"> * calling of the scan function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_block_checkbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">getchip</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">allowbbt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">block_bad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">getchip</span><span class="p">);</span>

	<span class="cm">/* Return info from the table */</span>
	<span class="k">return</span> <span class="n">nand_isbad_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">allowbbt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * panic_nand_wait_ready - [GENERIC] Wait for the ready pin after commands.</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @timeo: Timeout</span>
<span class="cm"> *</span>
<span class="cm"> * Helper function for nand_wait_ready used when needing to wait in interrupt</span>
<span class="cm"> * context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">panic_nand_wait_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Wait for the device to get ready */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeo</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">touch_softlockup_watchdog</span><span class="p">();</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Wait for the ready pin, after a command. The timeout is caught later. */</span>
<span class="kt">void</span> <span class="nf">nand_wait_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* 400ms timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">||</span> <span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">panic_nand_wait_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

	<span class="n">led_trigger_event</span><span class="p">(</span><span class="n">nand_led_trigger</span><span class="p">,</span> <span class="n">LED_FULL</span><span class="p">);</span>
	<span class="cm">/* Wait until command is processed or timeout occurs */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">touch_softlockup_watchdog</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeo</span><span class="p">));</span>
	<span class="n">led_trigger_event</span><span class="p">(</span><span class="n">nand_led_trigger</span><span class="p">,</span> <span class="n">LED_OFF</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nand_wait_ready</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nand_command - [DEFAULT] Send command to NAND device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @command: the command to be sent</span>
<span class="cm"> * @column: the column address for this command, -1 if none</span>
<span class="cm"> * @page_addr: the page address for this command, -1 if none</span>
<span class="cm"> *</span>
<span class="cm"> * Send command to NAND device. This function is used for small page devices</span>
<span class="cm"> * (256/512 Bytes per page).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">NAND_CTRL_CLE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">;</span>

	<span class="cm">/* Write out the command to the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">NAND_CMD_SEQIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">readcmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* OOB area */</span>
			<span class="n">column</span> <span class="o">-=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
			<span class="n">readcmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READOOB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First 256 bytes --&gt; READ0 */</span>
			<span class="n">readcmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">column</span> <span class="o">-=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="n">readcmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READ1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_CTRL_CHANGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Address cycle, when necessary */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">NAND_CTRL_ALE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">;</span>
	<span class="cm">/* Serially input address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Adjust columns for 16 bit buswidth */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span>
			<span class="n">column</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_CTRL_CHANGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_CTRL_CHANGE</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="cm">/* One more address cycle for devices &gt; 32MiB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span> <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Program and erase have their own busy handlers status and sequential</span>
<span class="cm">	 * in needs no delay</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">NAND_CMD_PAGEPROG</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE1</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE2</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_SEQIN</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS</span>:
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span>
			       <span class="n">NAND_CTRL_CLE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
			       <span class="n">NAND_CMD_NONE</span><span class="p">,</span> <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_READY</span><span class="p">))</span>
				<span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* This applies to read commands */</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we don&#39;t have access to the busy pin, we apply the given</span>
<span class="cm">		 * command delay</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Apply this short delay always to ensure that we do wait tWB in</span>
<span class="cm">	 * any case on any machine.</span>
<span class="cm">	 */</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">nand_wait_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_command_lp - [DEFAULT] Send command to NAND large page device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @command: the command to be sent</span>
<span class="cm"> * @column: the column address for this command, -1 if none</span>
<span class="cm"> * @page_addr: the page address for this command, -1 if none</span>
<span class="cm"> *</span>
<span class="cm"> * Send command to NAND device. This is the version for the new large page</span>
<span class="cm"> * devices. We don&#39;t have the separate regions as we have in the small page</span>
<span class="cm"> * devices. We must emulate NAND_CMD_READOOB to keep the code compatible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_command_lp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Emulate NAND_CMD_READOOB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">NAND_CMD_READOOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">column</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Command latch cycle */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CLE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">page_addr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">NAND_CTRL_CHANGE</span> <span class="o">|</span> <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_ALE</span><span class="p">;</span>

		<span class="cm">/* Serially input address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Adjust columns for 16 bit buswidth */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span>
				<span class="n">column</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_CTRL_CHANGE</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">column</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_ALE</span><span class="p">);</span>
			<span class="cm">/* One more address cycle for devices &gt; 128MiB */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
					       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_ALE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span> <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Program and erase have their own busy handlers status, sequential</span>
<span class="cm">	 * in, and deplete1 need no delay.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">NAND_CMD_CACHEDPROG</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_PAGEPROG</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE1</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_ERASE2</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_SEQIN</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_RNDIN</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_DEPLETE1</span>:
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_STATUS_ERROR</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS_ERROR0</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS_ERROR1</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS_ERROR2</span>:
	<span class="k">case</span> <span class="n">NAND_CMD_STATUS_ERROR3</span>:
		<span class="cm">/* Read error status commands require only a short delay */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span>
			       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CLE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span>
			       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_READY</span><span class="p">))</span>
				<span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_RNDOUT</span>:
		<span class="cm">/* No ready / busy check necessary */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RNDOUTSTART</span><span class="p">,</span>
			       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CLE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span>
			       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_CMD_READ0</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READSTART</span><span class="p">,</span>
			       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CLE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_NONE</span><span class="p">,</span>
			       <span class="n">NAND_NCE</span> <span class="o">|</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">);</span>

		<span class="cm">/* This applies to read commands */</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we don&#39;t have access to the busy pin, we apply the given</span>
<span class="cm">		 * command delay.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Apply this short delay always to ensure that we do wait tWB in</span>
<span class="cm">	 * any case on any machine.</span>
<span class="cm">	 */</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">nand_wait_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * panic_nand_get_device - [GENERIC] Get chip for selected access</span>
<span class="cm"> * @chip: the nand chip descriptor</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @new_state: the state which is requested</span>
<span class="cm"> *</span>
<span class="cm"> * Used when in panic, no locks are taken.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">panic_nand_get_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Hardware controller shared among independent devices */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_get_device - [GENERIC] Get chip for selected access</span>
<span class="cm"> * @chip: the nand chip descriptor</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @new_state: the state which is requested</span>
<span class="cm"> *</span>
<span class="cm"> * Get the device and lock it for exclusive access</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nand_get_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Hardware controller shared among independent devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="n">chip</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * panic_nand_wait - [GENERIC] wait until the command is done</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @chip: NAND chip structure</span>
<span class="cm"> * @timeo: timeout</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for command done. This is a helper function for nand_wait used when</span>
<span class="cm"> * we are in interrupt context. May happen when in panic and trying to write</span>
<span class="cm"> * an oops through mtdoops.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">panic_nand_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeo</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_READY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_wait - [DEFAULT] wait until the command is done</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @chip: NAND chip structure</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for command done. This applies to erase and program only. Erase can</span>
<span class="cm"> * take up to 400ms and program up to 20ms according to general NAND and</span>
<span class="cm"> * SmartMedia specs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_ERASING</span><span class="p">)</span>
		<span class="n">timeo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">400</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">timeo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">led_trigger_event</span><span class="p">(</span><span class="n">nand_led_trigger</span><span class="p">,</span> <span class="n">LED_FULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Apply this short delay always to ensure that we do wait tWB in any</span>
<span class="cm">	 * case on any machine.</span>
<span class="cm">	 */</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_ERASING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_IS_AND</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS_MULTI</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">||</span> <span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="n">panic_nand_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeo</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_READY</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">led_trigger_event</span><span class="p">(</span><span class="n">nand_led_trigger</span><span class="p">,</span> <span class="n">LED_OFF</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __nand_unlock - [REPLACEABLE] unlocks specified locked blocks</span>
<span class="cm"> * @mtd: mtd info</span>
<span class="cm"> * @ofs: offset to start unlock from</span>
<span class="cm"> * @len: length to unlock</span>
<span class="cm"> * @invert: when = 0, unlock the range of blocks within the lower and</span>
<span class="cm"> *                    upper boundary address</span>
<span class="cm"> *          when = 1, unlock the range of blocks outside the boundaries</span>
<span class="cm"> *                    of the lower and upper boundary address</span>
<span class="cm"> *</span>
<span class="cm"> * Returs unlock status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__nand_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span>
					<span class="kt">uint64_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Submit address of first page to unlock */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_UNLOCK1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">);</span>

	<span class="cm">/* Submit address of last page to unlock */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_UNLOCK2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">page</span> <span class="o">|</span> <span class="n">invert</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">);</span>

	<span class="cm">/* Call wait ready function */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* See if device thinks it succeeded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: error status = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_unlock - [REPLACEABLE] unlocks specified locked blocks</span>
<span class="cm"> * @mtd: mtd info</span>
<span class="cm"> * @ofs: offset to start unlock from</span>
<span class="cm"> * @len: length to unlock</span>
<span class="cm"> *</span>
<span class="cm"> * Returns unlock status.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chipnr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: start = 0x%012llx, len = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_offs_len</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Align to last block address if size addresses end of the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">+</span> <span class="n">len</span> <span class="o">==</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>

	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_UNLOCKING</span><span class="p">);</span>

	<span class="cm">/* Shift to get chip number */</span>
	<span class="n">chipnr</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="cm">/* Check, if it is write protected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_check_wp</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: device is write protected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__nand_unlock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_unlock</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nand_lock - [REPLACEABLE] locks all blocks present in the device</span>
<span class="cm"> * @mtd: mtd info</span>
<span class="cm"> * @ofs: offset to start unlock from</span>
<span class="cm"> * @len: length to unlock</span>
<span class="cm"> *</span>
<span class="cm"> * This feature is not supported in many NAND parts. &#39;Micron&#39; NAND parts do</span>
<span class="cm"> * have this feature, but it allows only to lock all blocks, not for specified</span>
<span class="cm"> * range for block. Implementing &#39;lock&#39; feature by making use of &#39;unlock&#39;, for</span>
<span class="cm"> * now.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns lock status.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chipnr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: start = 0x%012llx, len = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_offs_len</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_LOCKING</span><span class="p">);</span>

	<span class="cm">/* Shift to get chip number */</span>
	<span class="n">chipnr</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="cm">/* Check, if it is write protected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_check_wp</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: device is write protected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Submit address of first page to lock */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_LOCK</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">);</span>

	<span class="cm">/* Call wait ready function */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* See if device thinks it succeeded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: error status = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__nand_unlock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_lock</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_page_raw - [INTERN] read raw page data without ecc</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: buffer to store read data</span>
<span class="cm"> * @oob_required: caller requires OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> *</span>
<span class="cm"> * Not for syndrome calculating ECC controllers, which use a special oob layout.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_page_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			      <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oob_required</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_page_raw_syndrome - [INTERN] read raw page data without ecc</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: buffer to store read data</span>
<span class="cm"> * @oob_required: caller requires OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> *</span>
<span class="cm"> * We need a special oob layout and handling even when OOB isn&#39;t used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_page_raw_syndrome</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">steps</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">steps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">steps</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">eccbytes</span><span class="p">);</span>
		<span class="n">oob</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="p">(</span><span class="n">oob</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_page_swecc - [REPLACEABLE] software ECC based page read function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: buffer to store read data</span>
<span class="cm"> * @oob_required: caller requires OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_page_swecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_calc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_code</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">eccpos</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">eccpos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

	<span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">+=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_subpage - [REPLACEABLE] software ECC based sub-page read function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @data_offs: offset of requested data within the page</span>
<span class="cm"> * @readlen: data length</span>
<span class="cm"> * @bufpoi: buffer to store read data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_subpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">data_offs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">readlen</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bufpoi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start_step</span><span class="p">,</span> <span class="n">end_step</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">eccpos</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">eccpos</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_col_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datafrag_len</span><span class="p">,</span> <span class="n">eccfrag_len</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">,</span> <span class="n">aligned_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busw</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Column address within the page aligned to ECC size (256bytes) */</span>
	<span class="n">start_step</span> <span class="o">=</span> <span class="n">data_offs</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">end_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_offs</span> <span class="o">+</span> <span class="n">readlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">num_steps</span> <span class="o">=</span> <span class="n">end_step</span> <span class="o">-</span> <span class="n">start_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Data size aligned to ECC ecc.size */</span>
	<span class="n">datafrag_len</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">eccfrag_len</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>

	<span class="n">data_col_addr</span> <span class="o">=</span> <span class="n">start_step</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="cm">/* If we read not a page aligned data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_col_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RNDOUT</span><span class="p">,</span> <span class="n">data_col_addr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">bufpoi</span> <span class="o">+</span> <span class="n">data_col_addr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">datafrag_len</span><span class="p">);</span>

	<span class="cm">/* Calculate ECC */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eccfrag_len</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The performance is faster if we position offsets according to</span>
<span class="cm">	 * ecc.pos. Let&#39;s make sure that there are no gaps in ECC positions.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eccfrag_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">start_step</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span>
			<span class="n">eccpos</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">start_step</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">gaps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gaps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RNDOUT</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send the command to read the particular ECC bytes take care</span>
<span class="cm">		 * about buswidth alignment in read_buf.</span>
<span class="cm">		 */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">start_step</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>

		<span class="n">aligned_pos</span> <span class="o">=</span> <span class="n">eccpos</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">busw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">aligned_len</span> <span class="o">=</span> <span class="n">eccfrag_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eccpos</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">busw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">aligned_len</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eccpos</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">busw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">aligned_len</span><span class="o">++</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RNDOUT</span><span class="p">,</span>
					<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">+</span> <span class="n">aligned_pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">aligned_pos</span><span class="p">],</span> <span class="n">aligned_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eccfrag_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">index</span><span class="p">]];</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">bufpoi</span> <span class="o">+</span> <span class="n">data_col_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eccfrag_len</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccode</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">+=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_page_hwecc - [REPLACEABLE] hardware ECC based page read function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: buffer to store read data</span>
<span class="cm"> * @oob_required: caller requires OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> *</span>
<span class="cm"> * Not for syndrome calculating ECC controllers which need a special oob layout.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_page_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_calc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_code</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">eccpos</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">eccpos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_READ</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

	<span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">+=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_page_hwecc_oob_first - [REPLACEABLE] hw ecc, read oob first</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: buffer to store read data</span>
<span class="cm"> * @oob_required: caller requires OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware ECC for large page chips, require OOB to be read first. For this</span>
<span class="cm"> * ECC mode, the write_page method is re-used from ECC_HW. These methods</span>
<span class="cm"> * read/write ECC from the OOB area, unlike the ECC_HW_SYNDROME support with</span>
<span class="cm"> * multiple ECC steps, follows the &quot;infix ECC&quot; scheme and reads/writes ECC from</span>
<span class="cm"> * the data area, by overwriting the NAND manufacturer bad block markings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_page_hwecc_oob_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_code</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">eccpos</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">eccpos</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_calc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read the OOB area first */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READOOB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_READ</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">+=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_page_syndrome - [REPLACEABLE] hardware ECC syndrome based page read</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: buffer to store read data</span>
<span class="cm"> * @oob_required: caller requires OOB data read to chip-&gt;oob_poi</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> *</span>
<span class="cm"> * The hw generator calculates the error syndrome automatically. Therefore we</span>
<span class="cm"> * need a special oob layout and handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_page_syndrome</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				   <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_READ</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_READSYN</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">eccbytes</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">+=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">oob</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate remaining oob bytes */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="p">(</span><span class="n">oob</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_transfer_oob - [INTERN] Transfer oob to client buffer</span>
<span class="cm"> * @chip: nand chip structure</span>
<span class="cm"> * @oob: oob destination address</span>
<span class="cm"> * @ops: oob ops structure</span>
<span class="cm"> * @len: size of oob to transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="nf">nand_transfer_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MTD_OPS_PLACE_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_RAW</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">oob</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MTD_OPS_AUTO_OOB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nand_oobfree</span> <span class="o">*</span><span class="n">free</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">boffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">roffs</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">;</span> <span class="n">free</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read request not from offset 0? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">roffs</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">roffs</span> <span class="o">&gt;=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">roffs</span> <span class="o">-=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">boffs</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">roffs</span><span class="p">;</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">roffs</span><span class="p">));</span>
				<span class="n">roffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
				<span class="n">boffs</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span> <span class="o">+</span> <span class="n">boffs</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">oob</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_do_read_ops - [INTERN] Read data with ECC</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @from: offset to read from</span>
<span class="cm"> * @ops: oob ops structure</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function. Called with chip held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_do_read_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chipnr</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">realpage</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">aligned</span><span class="p">,</span> <span class="n">oob_required</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_ecc_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">readlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">oobreadlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">max_oobsize</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span> <span class="o">?</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">:</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bufpoi</span><span class="p">,</span> <span class="o">*</span><span class="n">oob</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bitflips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">;</span>

	<span class="n">chipnr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="n">realpage</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">realpage</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>

	<span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">;</span>
	<span class="n">oob</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="n">oob_required</span> <span class="o">=</span> <span class="n">oob</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="n">col</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
		<span class="n">aligned</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">==</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

		<span class="cm">/* Is the current page in the buffer? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">realpage</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">||</span> <span class="n">oob</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bufpoi</span> <span class="o">=</span> <span class="n">aligned</span> <span class="o">?</span> <span class="n">buf</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">;</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Now read the page into the buffer.  Absent an error,</span>
<span class="cm">			 * the read methods return max bitflips per ecc step.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_RAW</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">,</span>
							      <span class="n">oob_required</span><span class="p">,</span>
							      <span class="n">page</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aligned</span> <span class="o">&amp;&amp;</span> <span class="n">NAND_SUBPAGE_READ</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">oob</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_subpage</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span>
							<span class="n">col</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">,</span>
							  <span class="n">oob_required</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aligned</span><span class="p">)</span>
					<span class="cm">/* Invalidate page cache */</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="cm">/* Transfer not aligned data */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aligned</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NAND_SUBPAGE_READ</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">oob</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MTD_OPS_RAW</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="n">realpage</span><span class="p">;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf_bitflips</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Invalidate page cache */</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">+</span> <span class="n">col</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">buf</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">oob</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">toread</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">oobreadlen</span><span class="p">,</span> <span class="n">max_oobsize</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">toread</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">oob</span> <span class="o">=</span> <span class="n">nand_transfer_oob</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
						<span class="n">oob</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">toread</span><span class="p">);</span>
					<span class="n">oobreadlen</span> <span class="o">-=</span> <span class="n">toread</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_NO_READRDY</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Apply delay or wait for ready/busy pin */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span>
					<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">nand_wait_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">+</span> <span class="n">col</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">max_bitflips</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_bitflips</span><span class="p">,</span>
					     <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf_bitflips</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">readlen</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">readlen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* For subsequent reads align to page boundary */</span>
		<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Increment page address */</span>
		<span class="n">realpage</span><span class="o">++</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">realpage</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>
		<span class="cm">/* Check, if we cross a chip boundary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chipnr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">readlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oob</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span> <span class="o">-</span> <span class="n">oobreadlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">max_bitflips</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read - [MTD Interface] MTD compatibility function for nand_do_read_ecc</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @from: offset to read from</span>
<span class="cm"> * @len: number of bytes to read</span>
<span class="cm"> * @retlen: pointer to variable to store the number of read bytes</span>
<span class="cm"> * @buf: the databuffer to put data</span>
<span class="cm"> *</span>
<span class="cm"> * Get hold of the chip and call nand_do_read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_read_ops</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_oob_std - [REPLACEABLE] the most common OOB data read function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_oob_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READOOB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_oob_syndrome - [REPLACEABLE] OOB data read function for HW ECC</span>
<span class="cm"> *			    with syndromes</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @page: page number to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_oob_syndrome</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bufpoi</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">toread</span><span class="p">,</span> <span class="n">sndrnd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sndrnd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">eccsize</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">eccsize</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RNDOUT</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sndrnd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">toread</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">,</span> <span class="n">toread</span><span class="p">);</span>
		<span class="n">bufpoi</span> <span class="o">+=</span> <span class="n">toread</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">toread</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_oob_std - [REPLACEABLE] the most common OOB data write function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @page: page number to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_write_oob_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_SEQIN</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="cm">/* Send command to program the OOB data */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_PAGEPROG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_FAIL</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_oob_syndrome - [REPLACEABLE] OOB data write function for HW ECC</span>
<span class="cm"> *			     with syndrome - only for large page flash</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @page: page number to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_write_oob_syndrome</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sndcmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bufpoi</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * data-ecc-data-ecc ... ecc-oob</span>
<span class="cm">	 * or</span>
<span class="cm">	 * data-pad-ecc-pad-data-pad .... ecc-pad-oob</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">*</span> <span class="p">(</span><span class="n">eccsize</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">);</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">eccsize</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_SEQIN</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">steps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sndcmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&lt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">uint32_t</span> <span class="n">fill</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

				<span class="n">len</span> <span class="o">=</span> <span class="n">eccsize</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fill</span><span class="p">,</span>
							<span class="n">num</span><span class="p">);</span>
					<span class="n">len</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pos</span> <span class="o">=</span> <span class="n">eccsize</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">eccsize</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RNDIN</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sndcmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">bufpoi</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bufpoi</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_PAGEPROG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_FAIL</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_do_read_oob - [INTERN] NAND read out-of-band</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @from: offset to read from</span>
<span class="cm"> * @ops: oob operations description structure</span>
<span class="cm"> *</span>
<span class="cm"> * NAND read out-of-band data from the spare area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_do_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">realpage</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_ecc_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: from = 0x%08Lx, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">from</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to start read outside oob</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">from</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span>
		     <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">+</span> <span class="n">readlen</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="o">*</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to read beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chipnr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="cm">/* Shift to get page */</span>
	<span class="n">realpage</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">realpage</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_RAW</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">nand_transfer_oob</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_NO_READRDY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Apply delay or wait for ready/busy pin */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">nand_wait_ready</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">readlen</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">readlen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Increment page address */</span>
		<span class="n">realpage</span><span class="o">++</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">realpage</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>
		<span class="cm">/* Check, if we cross a chip boundary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chipnr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span> <span class="o">-</span> <span class="n">readlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="k">return</span>  <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">?</span> <span class="o">-</span><span class="n">EUCLEAN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_read_oob - [MTD Interface] NAND read data and/or out-of-band</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @from: offset to read from</span>
<span class="cm"> * @ops: oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * NAND read data and/or out-of-band data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">from</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to read beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTD_OPS_PLACE_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_AUTO_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_RAW</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_read_ops</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * nand_write_page_raw - [INTERN] raw page write function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @oob_required: must write chip-&gt;oob_poi to OOB</span>
<span class="cm"> *</span>
<span class="cm"> * Not for syndrome calculating ECC controllers, which use a special oob layout.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_page_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oob_required</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_page_raw_syndrome - [INTERN] raw page write function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @oob_required: must write chip-&gt;oob_poi to OOB</span>
<span class="cm"> *</span>
<span class="cm"> * We need a special oob layout and handling even when ECC isn&#39;t checked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_page_raw_syndrome</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">steps</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">steps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">steps</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">eccbytes</span><span class="p">);</span>
		<span class="n">oob</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="p">(</span><span class="n">oob</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * nand_write_page_swecc - [REPLACEABLE] software ECC based page write function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @oob_required: must write chip-&gt;oob_poi to OOB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_page_swecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_calc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">eccpos</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">eccpos</span><span class="p">;</span>

	<span class="cm">/* Software ECC calculation */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_page_hwecc - [REPLACEABLE] hardware ECC based page write function</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @oob_required: must write chip-&gt;oob_poi to OOB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_page_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ecc_calc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">ecccalc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">eccpos</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">eccpos</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_WRITE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">[</span><span class="n">eccpos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ecc_calc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_page_syndrome - [REPLACEABLE] hardware ECC syndrome based page write</span>
<span class="cm"> * @mtd: mtd info structure</span>
<span class="cm"> * @chip: nand chip info structure</span>
<span class="cm"> * @buf: data buffer</span>
<span class="cm"> * @oob_required: must write chip-&gt;oob_poi to OOB</span>
<span class="cm"> *</span>
<span class="cm"> * The hw generator calculates the error syndrome automatically. Therefore we</span>
<span class="cm"> * need a special oob layout and handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_write_page_syndrome</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eccsize</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccbytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eccsteps</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eccsteps</span><span class="p">;</span> <span class="n">eccsteps</span><span class="o">--</span><span class="p">,</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">eccsize</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_ECC_WRITE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eccsize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">prepad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">oob</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">eccbytes</span><span class="p">);</span>
		<span class="n">oob</span> <span class="o">+=</span> <span class="n">eccbytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">postpad</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate remaining oob bytes */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="p">(</span><span class="n">oob</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_page - [REPLACEABLE] write one page</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @chip: NAND chip descriptor</span>
<span class="cm"> * @buf: the data to write</span>
<span class="cm"> * @oob_required: must write chip-&gt;oob_poi to OOB</span>
<span class="cm"> * @page: page number to write</span>
<span class="cm"> * @cached: cached programming</span>
<span class="cm"> * @raw: use _raw version of write_page</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_write_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oob_required</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">cached</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_SEQIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">oob_required</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">oob_required</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cached progamming disabled for now. Not sure if it&#39;s worth the</span>
<span class="cm">	 * trouble. The speed gain is not very impressive. (2.3-&gt;2.6Mib/s).</span>
<span class="cm">	 */</span>
	<span class="n">cached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_CACHEPRG</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_PAGEPROG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * See if operation failed and additional status checks are</span>
<span class="cm">		 * available.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_FAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">errstat</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">errstat</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
					       <span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_FAIL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_CACHEDPROG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MTD_NAND_VERIFY_WRITE</span>
	<span class="cm">/* Send command to read back the data */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READ0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">verify_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Make sure the next page prog is preceded by a status read */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_fill_oob - [INTERN] Transfer client buffer to oob</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @oob: oob data buffer</span>
<span class="cm"> * @len: oob data write length</span>
<span class="cm"> * @ops: oob ops structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="nf">nand_fill_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialise to all 0xFF, to avoid the possibility of left over OOB</span>
<span class="cm">	 * data from a previous OOB read.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MTD_OPS_PLACE_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_RAW</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">oob</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MTD_OPS_AUTO_OOB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nand_oobfree</span> <span class="o">*</span><span class="n">free</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">boffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">woffs</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">;</span> <span class="n">free</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Write request not from offset 0? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">woffs</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">woffs</span> <span class="o">&gt;=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">woffs</span> <span class="o">-=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">boffs</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">woffs</span><span class="p">;</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">woffs</span><span class="p">));</span>
				<span class="n">woffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
				<span class="n">boffs</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span> <span class="o">+</span> <span class="n">boffs</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">oob</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NOTALIGNED(x)	((x &amp; (chip-&gt;subpagesize - 1)) != 0)</span>

<span class="cm">/**</span>
<span class="cm"> * nand_do_write_ops - [INTERN] NAND write with ECC</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @to: offset to write to</span>
<span class="cm"> * @ops: oob operations description structure</span>
<span class="cm"> *</span>
<span class="cm"> * NAND write with ECC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_do_write_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chipnr</span><span class="p">,</span> <span class="n">realpage</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">blockmask</span><span class="p">,</span> <span class="n">column</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">writelen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">oobwritelen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">oobmaxlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span> <span class="o">?</span>
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">:</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">subpage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oob_required</span> <span class="o">=</span> <span class="n">oob</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writelen</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reject writes, which are not page aligned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NOTALIGNED</span><span class="p">(</span><span class="n">to</span><span class="p">)</span> <span class="o">||</span> <span class="n">NOTALIGNED</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: attempt to write non page aligned data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">subpage</span> <span class="o">=</span> <span class="n">column</span> <span class="o">||</span> <span class="p">(</span><span class="n">writelen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subpage</span> <span class="o">&amp;&amp;</span> <span class="n">oob</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">chipnr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="cm">/* Check, if it is write protected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_check_wp</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">realpage</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">realpage</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>
	<span class="n">blockmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Invalidate the page cache, when we write to the cached page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">to</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t allow multipage oob writes with offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oob</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span> <span class="o">&gt;</span> <span class="n">oobmaxlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">writelen</span> <span class="o">&gt;</span> <span class="n">bytes</span> <span class="o">&amp;&amp;</span> <span class="n">page</span> <span class="o">!=</span> <span class="n">blockmask</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="cm">/* Partial page write? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">column</span> <span class="o">||</span> <span class="n">writelen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">cached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">column</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">writelen</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
			<span class="n">wbuf</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">oob</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">oobwritelen</span><span class="p">,</span> <span class="n">oobmaxlen</span><span class="p">);</span>
			<span class="n">oob</span> <span class="o">=</span> <span class="n">nand_fill_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
			<span class="n">oobwritelen</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* We still need to erase leftover OOB data */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_page</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="n">oob_required</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
				       <span class="n">cached</span><span class="p">,</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_RAW</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">writelen</span> <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writelen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">realpage</span><span class="o">++</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">realpage</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">;</span>
		<span class="cm">/* Check, if we cross a chip boundary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chipnr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">writelen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">oob</span><span class="p">))</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * panic_nand_write - [MTD Interface] NAND write with ECC</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @to: offset to write to</span>
<span class="cm"> * @len: number of bytes to write</span>
<span class="cm"> * @retlen: pointer to variable to store the number of written bytes</span>
<span class="cm"> * @buf: the data to write</span>
<span class="cm"> *</span>
<span class="cm"> * NAND write with ECC. Used when performing writes in interrupt context, this</span>
<span class="cm"> * may for example be called by mtdoops when writing an oops while in panic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">panic_nand_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Wait for the device to get ready */</span>
	<span class="n">panic_nand_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

	<span class="cm">/* Grab the device */</span>
	<span class="n">panic_nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_write_ops</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>

	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write - [MTD Interface] NAND write with ECC</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @to: offset to write to</span>
<span class="cm"> * @len: number of bytes to write</span>
<span class="cm"> * @retlen: pointer to variable to store the number of written bytes</span>
<span class="cm"> * @buf: the data to write</span>
<span class="cm"> *</span>
<span class="cm"> * NAND write with ECC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_write_ops</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_do_write_oob - [MTD Interface] NAND write out-of-band</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @to: offset to write to</span>
<span class="cm"> * @ops: oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * NAND write out-of-band.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_do_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chipnr</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: to = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="cm">/* Do not allow write past end of page */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to write past end of page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to start write outside oob</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not allow write past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">to</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span>
		     <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span> <span class="o">&gt;</span>
			<span class="p">((</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="o">*</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to write beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chipnr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="cm">/* Shift to get page */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the chip. Some chips (like the Toshiba TC5832DC found in one</span>
<span class="cm">	 * of my DiskOnChip 2000 test units) will clear the whole data page too</span>
<span class="cm">	 * if we don&#39;t do this. I have no clue why, but I seem to have &#39;fixed&#39;</span>
<span class="cm">	 * it in the doc2000 driver in August 1999.  dwmw2.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Check, if it is write protected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_check_wp</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="cm">/* Invalidate the page cache, if we write to the cached page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nand_fill_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_RAW</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob_raw</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_write_oob - [MTD Interface] NAND write data and/or out-of-band</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @to: offset to write to</span>
<span class="cm"> * @ops: oob operation description structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Do not allow writes past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">to</span> <span class="o">+</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: attempt to write beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTD_OPS_PLACE_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_AUTO_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_RAW</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_do_write_ops</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * single_erase_cmd - [GENERIC] NAND standard block erase command function</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @page: the page address of the block which will be erased</span>
<span class="cm"> *</span>
<span class="cm"> * Standard erase command for NAND chips.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">single_erase_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="cm">/* Send commands to erase a block */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * multi_erase_cmd - [GENERIC] AND specific block erase command function</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @page: the page address of the block which will be erased</span>
<span class="cm"> *</span>
<span class="cm"> * AND multi block erase command function. Erase 4 consecutive blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">multi_erase_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="cm">/* Send commands to erase a block */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="o">++</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="o">++</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="o">++</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_erase - [MTD Interface] erase block(s)</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @instr: erase instruction</span>
<span class="cm"> *</span>
<span class="cm"> * Erase one ore more blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nand_erase_nand</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BBT_PAGE_MASK	0xffffff3f</span>
<span class="cm">/**</span>
<span class="cm"> * nand_erase_nand - [INTERN] erase block(s)</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @instr: erase instruction</span>
<span class="cm"> * @allowbbt: allow erasing the bbt area</span>
<span class="cm"> *</span>
<span class="cm"> * Erase one ore more blocks.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_erase_nand</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">allowbbt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">pages_per_block</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">rewrite_bbt</span><span class="p">[</span><span class="n">NAND_MAX_CHIPS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bbt_masked_page</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: start = 0x%012llx, len = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_offs_len</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Grab the lock and see if the device is available */</span>
	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_ERASING</span><span class="p">);</span>

	<span class="cm">/* Shift to get first page */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
	<span class="n">chipnr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span><span class="p">);</span>

	<span class="cm">/* Calculate pages in each block */</span>
	<span class="n">pages_per_block</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

	<span class="cm">/* Select the NAND device */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

	<span class="cm">/* Check, if it is write protected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nand_check_wp</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: device is write protected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">erase_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If BBT requires refresh, set the BBT page mask to see if the BBT</span>
<span class="cm">	 * should be rewritten. Otherwise the mask is set to 0xffffffff which</span>
<span class="cm">	 * can not be matched. This is also done when the bbt is actually</span>
<span class="cm">	 * erased to avoid recursive updates.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">BBT_AUTO_REFRESH</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allowbbt</span><span class="p">)</span>
		<span class="n">bbt_masked_page</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chipnr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BBT_PAGE_MASK</span><span class="p">;</span>

	<span class="cm">/* Loop through the pages */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASING</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if we have a bad block, we do not erase bad blocks! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nand_block_checkbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span> <span class="n">page</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">allowbbt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: attempt to erase a bad block at page 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">erase_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Invalidate the page cache, if we erase the block which</span>
<span class="cm">		 * contains the current cached page.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&lt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">&lt;</span>
		    <span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">pages_per_block</span><span class="p">))</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">erase_cmd</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * See if operation failed and additional status checks are</span>
<span class="cm">		 * available</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_FAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">errstat</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">errstat</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">FL_ERASING</span><span class="p">,</span>
					       <span class="n">status</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

		<span class="cm">/* See if block erase succeeded */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NAND_STATUS_FAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: failed erase, page 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">erase_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If BBT requires refresh, set the BBT rewrite flag to the</span>
<span class="cm">		 * page being erased.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bbt_masked_page</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">page</span> <span class="o">&amp;</span> <span class="n">BBT_PAGE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">bbt_masked_page</span><span class="p">)</span>
			    <span class="n">rewrite_bbt</span><span class="p">[</span><span class="n">chipnr</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

		<span class="cm">/* Increment page address and decrement length */</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">+=</span> <span class="n">pages_per_block</span><span class="p">;</span>

		<span class="cm">/* Check, if we cross a chip boundary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">page</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chipnr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * If BBT requires refresh and BBT-PERCHIP, set the BBT</span>
<span class="cm">			 * page mask to see if this BBT should be rewritten.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bbt_masked_page</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_PERCHIP</span><span class="p">))</span>
				<span class="n">bbt_masked_page</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chipnr</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">BBT_PAGE_MASK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_DONE</span><span class="p">;</span>

<span class="nl">erase_exit:</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MTD_ERASE_DONE</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Deselect and wake up anyone waiting on the device */</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="cm">/* Do call back function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">mtd_erase_callback</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If BBT requires refresh and erase was successful, rewrite any</span>
<span class="cm">	 * selected bad block tables.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bbt_masked_page</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">||</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chipnr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chipnr</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">;</span> <span class="n">chipnr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rewrite_bbt</span><span class="p">[</span><span class="n">chipnr</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Update the BBT for chip */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: nand_update_bbt (%d:0x%0llx 0x%0x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">chipnr</span><span class="p">,</span> <span class="n">rewrite_bbt</span><span class="p">[</span><span class="n">chipnr</span><span class="p">],</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_td</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">chipnr</span><span class="p">]);</span>
		<span class="n">nand_update_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">rewrite_bbt</span><span class="p">[</span><span class="n">chipnr</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Return more or less happy */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_sync - [MTD Interface] sync</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Sync is actually a wait for chip ready function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Grab the lock and see if the device is available */</span>
	<span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_SYNCING</span><span class="p">);</span>
	<span class="cm">/* Release it and go back */</span>
	<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_block_isbad - [MTD Interface] Check if block at offset is bad</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @offs: offset relative to mtd start</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_block_isbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nand_block_checkbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_block_markbad - [MTD Interface] Mark block at the given offset as bad</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @ofs: offset relative to mtd start</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_block_markbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_block_isbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If it was bad already, return success and do nothing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">block_markbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_suspend - [MTD Interface] Suspend the NAND flash</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nand_get_device</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_resume - [MTD Interface] Resume the NAND flash</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span>
		<span class="n">nand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s called for a chip which is not in suspended state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set default functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nand_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check for proper chip_delay setup, set 20us if not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="cm">/* check, if a user supplied command function given */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span> <span class="o">=</span> <span class="n">nand_command</span><span class="p">;</span>

	<span class="cm">/* check, if a user supplied wait function given */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">waitfunc</span> <span class="o">=</span> <span class="n">nand_wait</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span> <span class="o">=</span> <span class="n">nand_select_chip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span> <span class="o">=</span> <span class="n">busw</span> <span class="o">?</span> <span class="n">nand_read_byte16</span> <span class="o">:</span> <span class="n">nand_read_byte</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_word</span> <span class="o">=</span> <span class="n">nand_read_word</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">block_bad</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">block_bad</span> <span class="o">=</span> <span class="n">nand_block_bad</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">block_markbad</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">block_markbad</span> <span class="o">=</span> <span class="n">nand_default_block_markbad</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">busw</span> <span class="o">?</span> <span class="n">nand_write_buf16</span> <span class="o">:</span> <span class="n">nand_write_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">busw</span> <span class="o">?</span> <span class="n">nand_read_buf16</span> <span class="o">:</span> <span class="n">nand_read_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">verify_buf</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">verify_buf</span> <span class="o">=</span> <span class="n">busw</span> <span class="o">?</span> <span class="n">nand_verify_buf16</span> <span class="o">:</span> <span class="n">nand_verify_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">scan_bbt</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">scan_bbt</span> <span class="o">=</span> <span class="n">nand_default_bbt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hwcontrol</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Sanitize ONFI strings so we can safely print them */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sanitize_string</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Null terminate */</span>
	<span class="n">s</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Remove non printable chars */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
			<span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remove trailing spaces */</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">onfi_crc16</span><span class="p">(</span><span class="n">u16</span> <span class="n">crc</span><span class="p">,</span> <span class="n">u8</span> <span class="k">const</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">^=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x8005</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the NAND chip is ONFI compliant, returns 1 if it is, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nand_flash_detect_onfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">busw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_onfi_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Try ONFI for unknown chip or LP */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READID</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;O&#39;</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;N&#39;</span> <span class="o">||</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;F&#39;</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_PARAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onfi_crc16</span><span class="p">(</span><span class="n">ONFI_CRC_BASE</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ONFI param page %d valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check version */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unsupported ONFI version: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sanitize_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">));</span>
	<span class="n">sanitize_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">byte_per_page</span><span class="p">);</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pages_per_block</span><span class="p">)</span> <span class="o">*</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spare_bytes_per_page</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blocks_per_lun</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">*=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">lun_count</span><span class="p">;</span>
	<span class="o">*</span><span class="n">busw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">busw</span> <span class="o">=</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_CHIPOPTIONS_MSK</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NAND_NO_READRDY</span> <span class="o">&amp;</span> <span class="n">NAND_CHIPOPTIONS_MSK</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ONFI flash detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the flash and manufacturer id and lookup if the type is supported.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_flash_dev</span> <span class="o">*</span><span class="nf">nand_get_flash_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">busw</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="o">*</span><span class="n">maf_id</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">nand_flash_dev</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">maf_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Select the device */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the chip, required by some chips (e.g. Micron MT29FxGxxxxx)</span>
<span class="cm">	 * after power-up.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Send the command for reading device ID */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READID</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Read manufacturer and device IDs */</span>
	<span class="o">*</span><span class="n">maf_id</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try again to make sure, as some systems the bus-hold or other</span>
<span class="cm">	 * interface concerns can cause random data which looks like a</span>
<span class="cm">	 * possibly credible NAND flash to appear. If the two results do</span>
<span class="cm">	 * not match, ignore the device completely.</span>
<span class="cm">	 */</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READID</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">id_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">*</span><span class="n">maf_id</span> <span class="o">||</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: second ID read did not match &quot;</span>
			<span class="s">&quot;%02x,%02x against %02x,%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="o">*</span><span class="n">maf_id</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">nand_flash_ids</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">type</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pagesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check is chip is ONFI compliant */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_flash_detect_onfi</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">busw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ident_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READID</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Read entire ID string */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">id_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pagesize</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">init_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the pagesize, oobsize, erasesize by the driver */</span>
		<span class="n">busw</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">init_size</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">id_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pagesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">extid</span><span class="p">;</span>
		<span class="cm">/* The 3rd id byte holds MLC / multichip data */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cellinfo</span> <span class="o">=</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="cm">/* The 4th id byte is the important one */</span>
		<span class="n">extid</span> <span class="o">=</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Field definitions are in the following datasheets:</span>
<span class="cm">		 * Old style (4,5 byte ID): Samsung K9GAG08U0M (p.32)</span>
<span class="cm">		 * New style   (6 byte ID): Samsung K9GBG08U0M (p.40)</span>
<span class="cm">		 *</span>
<span class="cm">		 * Check for wraparound + Samsung ID + nonzero 6th byte</span>
<span class="cm">		 * to decide what to do.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="n">id_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">NAND_MFR_SAMSUNG</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cellinfo</span> <span class="o">&amp;</span> <span class="n">NAND_CI_CELLTYPE_MSK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">id_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Calc pagesize */</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="n">extid</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Calc oobsize */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="mi">218</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="mi">436</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">extid</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Calc blocksize */</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="p">(((</span><span class="n">extid</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">));</span>
			<span class="n">busw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Calc pagesize */</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="n">extid</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Calc oobsize */</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">extid</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Calc blocksize. Blocksize is multiples of 64KiB */</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="n">extid</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Get buswidth information */</span>
			<span class="n">busw</span> <span class="o">=</span> <span class="p">(</span><span class="n">extid</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="n">NAND_BUSWIDTH_16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Old devices have chip data hardcoded in the device id table.</span>
<span class="cm">		 */</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">pagesize</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">busw</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check for Spansion/AMD ID + repeating 5th, 6th byte since</span>
<span class="cm">		 * some Spansion chips have erasesize that conflicts with size</span>
<span class="cm">		 * listed in nand_ids table.</span>
<span class="cm">		 * Data sheet (5 byte ID): Spansion S30ML-P ORNAND (p.39)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_AMD</span> <span class="o">&amp;&amp;</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">id_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">id_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">id_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">==</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">&lt;&lt;=</span> <span class="p">((</span><span class="n">id_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Get chip options, preserve non chip based options */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_CHIPOPTIONS_MSK</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_CHIPOPTIONS_MSK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if chip is not a Samsung device. Do not clear the</span>
<span class="cm">	 * options for chips which do not have an extended id.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">maf_id</span> <span class="o">!=</span> <span class="n">NAND_MFR_SAMSUNG</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pagesize</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NAND_SAMSUNG_LP_OPTIONS</span><span class="p">;</span>
<span class="nl">ident_done:</span>

	<span class="cm">/* Try to identify manufacturer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">maf_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">maf_idx</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">maf_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">maf_idx</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="o">*</span><span class="n">maf_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check, if buswidth is correct. Hardware drivers should set</span>
<span class="cm">	 * chip correct!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">busw</span> <span class="o">!=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;NAND device: Manufacturer ID:&quot;</span>
			<span class="s">&quot; 0x%02x, Chip ID: 0x%02x (%s %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">maf_id</span><span class="p">,</span>
			<span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">maf_idx</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;NAND bus width %d instead %d bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
			   <span class="n">busw</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate the address shift from the page size */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Convert chipsize to number of pages per chip -1 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagemask</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_erase_shift</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phys_erase_shift</span> <span class="o">=</span>
		<span class="n">ffs</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_shift</span> <span class="o">+=</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockbits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Set the bad block position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;</span> <span class="mi">512</span> <span class="o">||</span> <span class="p">(</span><span class="n">busw</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockpos</span> <span class="o">=</span> <span class="n">NAND_LARGE_BADBLOCK_POS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblockpos</span> <span class="o">=</span> <span class="n">NAND_SMALL_BADBLOCK_POS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bad block marker is stored in the last page of each block</span>
<span class="cm">	 * on Samsung and Hynix MLC devices; stored in first two pages</span>
<span class="cm">	 * of each block on Micron devices with 2KiB pages and on</span>
<span class="cm">	 * SLC Samsung, Hynix, Toshiba, AMD/Spansion, and Macronix.</span>
<span class="cm">	 * All others scan only the first page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cellinfo</span> <span class="o">&amp;</span> <span class="n">NAND_CI_CELLTYPE_MSK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_SAMSUNG</span> <span class="o">||</span>
			 <span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_HYNIX</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">|=</span> <span class="n">NAND_BBT_SCANLASTPAGE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cellinfo</span> <span class="o">&amp;</span> <span class="n">NAND_CI_CELLTYPE_MSK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_SAMSUNG</span> <span class="o">||</span>
				 <span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_HYNIX</span> <span class="o">||</span>
				 <span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_TOSHIBA</span> <span class="o">||</span>
				 <span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_AMD</span> <span class="o">||</span>
				 <span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_MACRONIX</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">==</span> <span class="mi">2048</span> <span class="o">&amp;&amp;</span>
			 <span class="o">*</span><span class="n">maf_id</span> <span class="o">==</span> <span class="n">NAND_MFR_MICRON</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">|=</span> <span class="n">NAND_BBT_SCAN2NDPAGE</span><span class="p">;</span>

	<span class="cm">/* Check for AND chips with 4 page planes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_4PAGE_ARRAY</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">erase_cmd</span> <span class="o">=</span> <span class="n">multi_erase_cmd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">erase_cmd</span> <span class="o">=</span> <span class="n">single_erase_cmd</span><span class="p">;</span>

	<span class="cm">/* Do not replace user supplied command function! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;</span> <span class="mi">512</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span> <span class="o">==</span> <span class="n">nand_command</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span> <span class="o">=</span> <span class="n">nand_command_lp</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;NAND device: Manufacturer ID: 0x%02x, Chip ID: 0x%02x (%s %s),&quot;</span>
		<span class="s">&quot; page size: %d, OOB size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">maf_id</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">maf_idx</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_version</span> <span class="o">?</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">onfi_params</span><span class="p">.</span><span class="n">model</span> <span class="o">:</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nand_scan_ident - [NAND Interface] Scan for the NAND device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @maxchips: number of chips to scan for</span>
<span class="cm"> * @table: alternative NAND ID table</span>
<span class="cm"> *</span>
<span class="cm"> * This is the first phase of the normal nand_scan() function. It reads the</span>
<span class="cm"> * flash ID and sets up MTD fields accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * The mtd-&gt;owner field must be set to the module of the caller.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_scan_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxchips</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nand_flash_dev</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">busw</span><span class="p">,</span> <span class="n">nand_maf_id</span><span class="p">,</span> <span class="n">nand_dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_flash_dev</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>

	<span class="cm">/* Get buswidth to select the correct functions */</span>
	<span class="n">busw</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_BUSWIDTH_16</span><span class="p">;</span>
	<span class="cm">/* Set the default functions */</span>
	<span class="n">nand_set_defaults</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">busw</span><span class="p">);</span>

	<span class="cm">/* Read the flash type */</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">nand_get_flash_type</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">busw</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">nand_maf_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nand_dev_id</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_SCAN_SILENT_NODEV</span><span class="p">))</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No NAND device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check for a chip array */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxchips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/* See comment in nand_get_flash_type for reset */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Send the command for reading device ID */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmdfunc</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">NAND_CMD_READID</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Read manufacturer and device IDs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nand_maf_id</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">nand_dev_id</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d NAND chips detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Store the number of chips and calc total size for mtd */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">numchips</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipsize</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_scan_ident</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * nand_scan_tail - [NAND Interface] Scan for the NAND device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * This is the second phase of the normal nand_scan() function. It fills out</span>
<span class="cm"> * all the uninitialized function pointers with the defaults and scans for a</span>
<span class="cm"> * bad block table if appropriate.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_scan_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* New bad blocks should be marked in OOB, flash-based BBT, or both */</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_NO_OOB_BBM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">&amp;</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_OWN_BUFFERS</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Set the internal oob buffer location, just after the page data */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">oob_poi</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">+</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no default placement scheme is given, select an appropriate one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">NAND_ECC_SOFT_BCH</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_oob_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_oob_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_oob_64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">128</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_oob_128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No oob scheme defined for oobsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_page</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_page</span> <span class="o">=</span> <span class="n">nand_write_page</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check ECC mode, default to software if 3byte/512byte hardware ECC is</span>
<span class="cm">	 * selected and we have 256 byte pagesize fallback to software ECC</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NAND_ECC_HW_OOB_FIRST</span>:
		<span class="cm">/* Similar to NAND_ECC_HW, but a separate read_page handle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No ECC functions supplied; &quot;</span>
				   <span class="s">&quot;hardware ECC not possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">nand_read_page_hwecc_oob_first</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_ECC_HW</span>:
		<span class="cm">/* Use standard hwecc read page function? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">nand_read_page_hwecc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">=</span> <span class="n">nand_write_page_hwecc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span> <span class="o">=</span> <span class="n">nand_read_page_raw</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span> <span class="o">=</span> <span class="n">nand_write_page_raw</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span> <span class="o">=</span> <span class="n">nand_read_oob_std</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span> <span class="o">=</span> <span class="n">nand_write_oob_std</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_ECC_HW_SYNDROME</span>:
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">||</span>
		     <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">==</span> <span class="n">nand_read_page_hwecc</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">||</span>
		     <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">==</span> <span class="n">nand_write_page_hwecc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No ECC functions supplied; &quot;</span>
				   <span class="s">&quot;hardware ECC not possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="cm">/* Use standard syndrome read/write page function? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">nand_read_page_syndrome</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">=</span> <span class="n">nand_write_page_syndrome</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span> <span class="o">=</span> <span class="n">nand_read_page_raw_syndrome</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span> <span class="o">=</span> <span class="n">nand_write_page_raw_syndrome</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span> <span class="o">=</span> <span class="n">nand_read_oob_syndrome</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span> <span class="o">=</span> <span class="n">nand_write_oob_syndrome</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Driver must set ecc.strength when using hardware ECC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d byte HW ECC not possible on &quot;</span>
			   <span class="s">&quot;%d byte page size, fallback to SW ECC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">NAND_ECC_SOFT</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_ECC_SOFT</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">nand_calculate_ecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span> <span class="o">=</span> <span class="n">nand_correct_data</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">nand_read_page_swecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_subpage</span> <span class="o">=</span> <span class="n">nand_read_subpage</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">=</span> <span class="n">nand_write_page_swecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span> <span class="o">=</span> <span class="n">nand_read_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span> <span class="o">=</span> <span class="n">nand_write_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span> <span class="o">=</span> <span class="n">nand_read_oob_std</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span> <span class="o">=</span> <span class="n">nand_write_oob_std</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_ECC_SOFT_BCH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd_nand_has_bch</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;CONFIG_MTD_ECC_BCH not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">nand_bch_calculate_ecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span> <span class="o">=</span> <span class="n">nand_bch_correct_data</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">nand_read_page_swecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_subpage</span> <span class="o">=</span> <span class="n">nand_read_subpage</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">=</span> <span class="n">nand_write_page_swecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span> <span class="o">=</span> <span class="n">nand_read_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span> <span class="o">=</span> <span class="n">nand_write_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span> <span class="o">=</span> <span class="n">nand_read_oob_std</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span> <span class="o">=</span> <span class="n">nand_write_oob_std</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Board driver should supply ecc.size and ecc.bytes values to</span>
<span class="cm">		 * select how many bits are correctable; see nand_bch_init()</span>
<span class="cm">		 * for details. Otherwise, default to 4 bits for large page</span>
<span class="cm">		 * devices.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">nand_bch_init</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
					       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;BCH ECC initialization failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span> <span class="o">=</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">fls</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NAND_ECC_NONE</span>:
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;NAND_ECC_NONE selected by board driver. &quot;</span>
			   <span class="s">&quot;This is not recommended!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page</span> <span class="o">=</span> <span class="n">nand_read_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page</span> <span class="o">=</span> <span class="n">nand_write_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span> <span class="o">=</span> <span class="n">nand_read_oob_std</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_page_raw</span> <span class="o">=</span> <span class="n">nand_read_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_page_raw</span> <span class="o">=</span> <span class="n">nand_write_page_raw</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span> <span class="o">=</span> <span class="n">nand_write_oob_std</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Invalid NAND_ECC_MODE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* For many systems, the standard OOB write also works for raw */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob_raw</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob_raw</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">read_oob</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob_raw</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob_raw</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">write_oob</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The number of bytes available for a client to place data into</span>
<span class="cm">	 * the out of band area.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span>
			<span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">+=</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the number of read / write steps for one page depending on ECC</span>
<span class="cm">	 * mode.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Invalid ECC parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>

	<span class="cm">/* Allow subpage writes up to ecc.steps. Not possible for MLC flash */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_NO_SUBPAGE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cellinfo</span> <span class="o">&amp;</span> <span class="n">NAND_CI_CELLTYPE_MSK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">steps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">subpagesize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span><span class="p">;</span>

	<span class="cm">/* Initialize state */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FL_READY</span><span class="p">;</span>

	<span class="cm">/* De-select the device */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Invalidate the pagebuffer reference */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pagebuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill in remaining MTD driver data */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MTD_NANDFLASH</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_ROM</span><span class="p">)</span> <span class="o">?</span> <span class="n">MTD_CAP_ROM</span> <span class="o">:</span>
						<span class="n">MTD_CAP_NANDFLASH</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_erase</span> <span class="o">=</span> <span class="n">nand_erase</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_point</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unpoint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read</span> <span class="o">=</span> <span class="n">nand_read</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write</span> <span class="o">=</span> <span class="n">nand_write</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_panic_write</span> <span class="o">=</span> <span class="n">panic_nand_write</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_oob</span> <span class="o">=</span> <span class="n">nand_read_oob</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write_oob</span> <span class="o">=</span> <span class="n">nand_write_oob</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_sync</span> <span class="o">=</span> <span class="n">nand_sync</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unlock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_suspend</span> <span class="o">=</span> <span class="n">nand_suspend</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_resume</span> <span class="o">=</span> <span class="n">nand_resume</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_isbad</span> <span class="o">=</span> <span class="n">nand_block_isbad</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_markbad</span> <span class="o">=</span> <span class="n">nand_block_markbad</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writebufsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="cm">/* propagate ecc info to mtd_info */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_strength</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span><span class="p">;</span>

	<span class="cm">/* Check, if we should skip the bad block table scan */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_SKIP_BBTSCAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Build bad block table */</span>
	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">scan_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_scan_tail</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * is_module_text_address() isn&#39;t exported, and it&#39;s mostly a pointless</span>
<span class="cm"> * test if this is a module _anyway_ -- they&#39;d have to try _really_ hard</span>
<span class="cm"> * to call us from in-kernel code if the core NAND support is modular.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef MODULE</span>
<span class="cp">#define caller_is_module() (1)</span>
<span class="cp">#else</span>
<span class="cp">#define caller_is_module() \</span>
<span class="cp">	is_module_text_address((unsigned long)__builtin_return_address(0))</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * nand_scan - [NAND Interface] Scan for the NAND device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> * @maxchips: number of chips to scan for</span>
<span class="cm"> *</span>
<span class="cm"> * This fills out all the uninitialized function pointers with the defaults.</span>
<span class="cm"> * The flash ID is read and the mtd/chip structures are filled with the</span>
<span class="cm"> * appropriate values. The mtd-&gt;owner field must be set to the module of the</span>
<span class="cm"> * caller.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nand_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxchips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Many callers got this wrong, so check for it for a while... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">&amp;&amp;</span> <span class="n">caller_is_module</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;%s called with NULL mtd-&gt;owner!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_scan_ident</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">maxchips</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nand_scan_tail</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nand_scan</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * nand_release - [NAND Interface] Free resources held by the NAND device</span>
<span class="cm"> * @mtd: MTD device structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nand_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NAND_ECC_SOFT_BCH</span><span class="p">)</span>
		<span class="n">nand_bch_free</span><span class="p">((</span><span class="k">struct</span> <span class="n">nand_bch_control</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mtd_device_unregister</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="cm">/* Free bad block table memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NAND_OWN_BUFFERS</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>

	<span class="cm">/* Free bad block descriptor memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span><span class="o">-&gt;</span><span class="n">options</span>
			<span class="o">&amp;</span> <span class="n">NAND_BBT_DYNAMICSTRUCT</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">badblock_pattern</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nand_release</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nand_base_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">led_trigger_register_simple</span><span class="p">(</span><span class="s">&quot;nand-disk&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nand_led_trigger</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nand_base_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">led_trigger_unregister_simple</span><span class="p">(</span><span class="n">nand_led_trigger</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nand_base_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nand_base_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steven J. Hill &lt;sjhill@realitydiluted.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas Gleixner &lt;tglx@linutronix.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Generic NAND flash driver code&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
