<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › nand › s3c2410.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s3c2410.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/drivers/mtd/nand/s3c2410.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2004-2008 Simtec Electronics</span>
<span class="cm"> *	http://armlinux.simtec.co.uk/</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Samsung S3C2410/S3C2440/S3C2412 NAND driver</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>

<span class="cp">#ifdef CONFIG_MTD_NAND_S3C2410_DEBUG</span>
<span class="cp">#define DEBUG</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>

<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand_ecc.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;plat/regs-nand.h&gt;</span>
<span class="cp">#include &lt;plat/nand.h&gt;</span>

<span class="cp">#ifdef CONFIG_MTD_NAND_S3C2410_HWECC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hardware_ecc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hardware_ecc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MTD_NAND_S3C2410_CLKSTOP</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">clock_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">clock_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>


<span class="cm">/* new oob placement block for use with hardware ecc generation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">nand_hw_eccoob</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">}}</span>
<span class="p">};</span>

<span class="cm">/* controller and mtd information */</span>

<span class="k">struct</span> <span class="n">s3c2410_nand_info</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c2410_nand_mtd - driver MTD structure</span>
<span class="cm"> * @mtd: The MTD instance to pass to the MTD layer.</span>
<span class="cm"> * @chip: The NAND chip information.</span>
<span class="cm"> * @set: The platform information supplied for this set of NAND chips.</span>
<span class="cm"> * @info: Link back to the hardware information.</span>
<span class="cm"> * @scan_res: The result from calling nand_scan_ident().</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span>			<span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span>		<span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_set</span>		<span class="o">*</span><span class="n">set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">scan_res</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">s3c_cpu_type</span> <span class="p">{</span>
	<span class="n">TYPE_S3C2410</span><span class="p">,</span>
	<span class="n">TYPE_S3C2412</span><span class="p">,</span>
	<span class="n">TYPE_S3C2440</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">s3c_nand_clk_state</span> <span class="p">{</span>
	<span class="n">CLOCK_DISABLE</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CLOCK_ENABLE</span><span class="p">,</span>
	<span class="n">CLOCK_SUSPEND</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* overview of the s3c2410 nand state */</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c2410_nand_info - NAND controller state.</span>
<span class="cm"> * @mtds: An array of MTD instances on this controoler.</span>
<span class="cm"> * @platform: The platform data for this board.</span>
<span class="cm"> * @device: The platform device we bound to.</span>
<span class="cm"> * @area: The IO area resource that came from request_mem_region().</span>
<span class="cm"> * @clk: The clock resource for this controller.</span>
<span class="cm"> * @regs: The area mapped for the hardware registers described by @area.</span>
<span class="cm"> * @sel_reg: Pointer to the register controlling the NAND selection.</span>
<span class="cm"> * @sel_bit: The bit in @sel_reg to select the NAND chip.</span>
<span class="cm"> * @mtd_count: The number of MTDs created from this controller.</span>
<span class="cm"> * @save_sel: The contents of @sel_reg to be saved over suspend.</span>
<span class="cm"> * @clk_rate: The clock rate from @clk.</span>
<span class="cm"> * @clk_state: The current clock state.</span>
<span class="cm"> * @cpu_type: The exact type of this controller.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="p">{</span>
	<span class="cm">/* mtd info */</span>
	<span class="k">struct</span> <span class="n">nand_hw_control</span>		<span class="n">controller</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span>		<span class="o">*</span><span class="n">mtds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_platform_nand</span>	<span class="o">*</span><span class="n">platform</span><span class="p">;</span>

	<span class="cm">/* device info */</span>
	<span class="k">struct</span> <span class="n">device</span>			<span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>			<span class="o">*</span><span class="n">area</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">sel_reg</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">sel_bit</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">mtd_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">save_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">clk_rate</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">s3c_nand_clk_state</span>		<span class="n">clk_state</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">s3c_cpu_type</span>		<span class="n">cpu_type</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="k">struct</span> <span class="n">notifier_block</span>	<span class="n">freq_transition</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* conversion functions */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="nf">s3c2410_nand_mtd_toours</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="nf">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s3c2410_nand_mtd_toours</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="nf">to_nand_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c2410_platform_nand</span> <span class="o">*</span><span class="nf">to_nand_plat</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">allow_clk_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clock_stop</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2410_nand_clk_set_state - Enable, disable or suspend NAND clock.</span>
<span class="cm"> * @info: The controller instance.</span>
<span class="cm"> * @new_state: State to which clock should be set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">s3c_nand_clk_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_clk_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">new_state</span> <span class="o">==</span> <span class="n">CLOCK_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk_state</span> <span class="o">==</span> <span class="n">CLOCK_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">CLOCK_ENABLE</span><span class="p">)</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">CLOCK_ENABLE</span><span class="p">)</span>
			<span class="n">clk_enable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">clk_state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* timing calculations */</span>

<span class="cp">#define NS_IN_KHZ 1000000</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_nand_calc_rate - calculate timing data.</span>
<span class="cm"> * @wanted: The cycle time in nanoseconds.</span>
<span class="cm"> * @clk: The clock rate in kHz.</span>
<span class="cm"> * @max: The maximum divider value.</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the timing value from the given parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_nand_calc_rate</span><span class="p">(</span><span class="kt">int</span> <span class="n">wanted</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">((</span><span class="n">wanted</span> <span class="o">*</span> <span class="n">clk</span><span class="p">),</span> <span class="n">NS_IN_KHZ</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;result %d from %ld, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">wanted</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d ns is too big for current clock rate %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wanted</span><span class="p">,</span> <span class="n">clk</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define to_ns(ticks,clk) (((ticks) * NS_IN_KHZ) / (unsigned int)(clk))</span>

<span class="cm">/* controller setup */</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2410_nand_setrate - setup controller timing information.</span>
<span class="cm"> * @info: The controller instance.</span>
<span class="cm"> *</span>
<span class="cm"> * Given the information supplied by the platform, calculate and set</span>
<span class="cm"> * the necessary timing registers in the hardware to generate the</span>
<span class="cm"> * necessary timing cycles to the hardware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_setrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_platform_nand</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tacls_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">TYPE_S3C2412</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tacls</span><span class="p">,</span> <span class="n">twrph0</span><span class="p">,</span> <span class="n">twrph1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clkrate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">set</span><span class="p">),</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* calculate the timing information for the controller */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">clk_rate</span> <span class="o">=</span> <span class="n">clkrate</span><span class="p">;</span>
	<span class="n">clkrate</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* turn clock into kHz for ease of use */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tacls</span> <span class="o">=</span> <span class="n">s3c_nand_calc_rate</span><span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">tacls</span><span class="p">,</span> <span class="n">clkrate</span><span class="p">,</span> <span class="n">tacls_max</span><span class="p">);</span>
		<span class="n">twrph0</span> <span class="o">=</span> <span class="n">s3c_nand_calc_rate</span><span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">twrph0</span><span class="p">,</span> <span class="n">clkrate</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">twrph1</span> <span class="o">=</span> <span class="n">s3c_nand_calc_rate</span><span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">twrph1</span><span class="p">,</span> <span class="n">clkrate</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default timings */</span>
		<span class="n">tacls</span> <span class="o">=</span> <span class="n">tacls_max</span><span class="p">;</span>
		<span class="n">twrph0</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">twrph1</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tacls</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">twrph0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">twrph1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;cannot get suitable timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Tacls=%d, %dns Twrph0=%d %dns, Twrph1=%d %dns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">tacls</span><span class="p">,</span> <span class="n">to_ns</span><span class="p">(</span><span class="n">tacls</span><span class="p">,</span> <span class="n">clkrate</span><span class="p">),</span> <span class="n">twrph0</span><span class="p">,</span> <span class="n">to_ns</span><span class="p">(</span><span class="n">twrph0</span><span class="p">,</span> <span class="n">clkrate</span><span class="p">),</span> <span class="n">twrph1</span><span class="p">,</span> <span class="n">to_ns</span><span class="p">(</span><span class="n">twrph1</span><span class="p">,</span> <span class="n">clkrate</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_S3C2410</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">S3C2410_NFCONF_TACLS</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">S3C2410_NFCONF_TWRPH0</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">S3C2410_NFCONF_TWRPH1</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
		<span class="n">set</span> <span class="o">=</span> <span class="n">S3C2410_NFCONF_EN</span><span class="p">;</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">S3C2410_NFCONF_TACLS</span><span class="p">(</span><span class="n">tacls</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">S3C2410_NFCONF_TWRPH0</span><span class="p">(</span><span class="n">twrph0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">S3C2410_NFCONF_TWRPH1</span><span class="p">(</span><span class="n">twrph1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TYPE_S3C2440</span>:
	<span class="k">case</span> <span class="n">TYPE_S3C2412</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">S3C2440_NFCONF_TACLS</span><span class="p">(</span><span class="n">tacls_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">S3C2440_NFCONF_TWRPH0</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">S3C2440_NFCONF_TWRPH1</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>

		<span class="n">set</span> <span class="o">=</span> <span class="n">S3C2440_NFCONF_TACLS</span><span class="p">(</span><span class="n">tacls</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">S3C2440_NFCONF_TWRPH0</span><span class="p">(</span><span class="n">twrph0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">S3C2440_NFCONF_TWRPH1</span><span class="p">(</span><span class="n">twrph1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCONF</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCONF</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;NF_CONF is 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2410_nand_inithw - basic hardware initialisation</span>
<span class="cm"> * @info: The hardware state.</span>
<span class="cm"> *</span>
<span class="cm"> * Do the basic initialisation of the hardware, using s3c2410_nand_setrate()</span>
<span class="cm"> * to setup the hardware access speeds and set the controller to be enabled.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_inithw</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c2410_nand_setrate</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

 	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
 	<span class="k">case</span> <span class="n">TYPE_S3C2410</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>

 	<span class="k">case</span> <span class="n">TYPE_S3C2440</span>:
 	<span class="k">case</span> <span class="n">TYPE_S3C2412</span>:
		<span class="cm">/* enable the controller and de-assert nFCE */</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">S3C2440_NFCONT_ENABLE</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2410_nand_select_chip - select the given nand chip</span>
<span class="cm"> * @mtd: The MTD instance for this chip.</span>
<span class="cm"> * @chip: The chip number.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called by the MTD layer to either select a given chip for the</span>
<span class="cm"> * @mtd instance, or to indicate that the access has finished and the</span>
<span class="cm"> * chip can be de-selected.</span>
<span class="cm"> *</span>
<span class="cm"> * The routine ensures that the nFCE line is correctly setup, and any</span>
<span class="cm"> * platform specific selection code is called to route nFCE to the specific</span>
<span class="cm"> * chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_select_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="n">nmtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cur</span><span class="p">;</span>

	<span class="n">nmtd</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_ENABLE</span><span class="p">);</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">|=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span> <span class="o">&gt;</span> <span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">nr_chips</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;invalid chip %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">platform</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">select_chip</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">select_chip</span><span class="p">)</span> <span class="p">(</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cur</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_SUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_nand_hwcontrol</span>
<span class="cm"> *</span>
<span class="cm"> * Issue command and address cycles to the chip</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_hwcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">NAND_CMD_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CLE</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCMD</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* command and control functions */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2440_nand_hwcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">NAND_CMD_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CLE</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCMD</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_nand_devready()</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if the nand is busy, 1 if it is ready</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_devready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S3C2410_NFSTAT_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2440_nand_devready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S3C2440_NFSTAT_READY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2412_nand_devready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2412_NFSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S3C2412_NFSTAT_READY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ECC handling functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_correct_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span>
				     <span class="n">u_char</span> <span class="o">*</span><span class="n">read_ecc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">calc_ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diff0</span><span class="p">,</span> <span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">byte</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(%p,%p,%p,%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">read_ecc</span><span class="p">,</span> <span class="n">calc_ecc</span><span class="p">);</span>

	<span class="n">diff0</span> <span class="o">=</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">calc_ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">diff1</span> <span class="o">=</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">calc_ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">diff2</span> <span class="o">=</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">calc_ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: rd %02x%02x%02x calc %02x%02x%02x diff %02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">read_ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		 <span class="n">calc_ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">calc_ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">calc_ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		 <span class="n">diff0</span><span class="p">,</span> <span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diff0</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">diff1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">diff2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* ECC is ok */</span>

	<span class="cm">/* sometimes people do not think about using the ECC, so check</span>
<span class="cm">	 * to see if we have an 0xff,0xff,0xff read ECC and then ignore</span>
<span class="cm">	 * the error, on the assumption that this is an un-eccd page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">read_ecc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span>
	    <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">platform</span><span class="o">-&gt;</span><span class="n">ignore_unset_ecc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Can we correct this ECC (ie, one row and column change).</span>
<span class="cm">	 * Note, this is similar to the 256 error code on smartmedia */</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">diff0</span> <span class="o">^</span> <span class="p">(</span><span class="n">diff0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">diff1</span> <span class="o">^</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">diff2</span> <span class="o">^</span> <span class="p">(</span><span class="n">diff2</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* calculate the bit position of the error */</span>

		<span class="n">bit</span>  <span class="o">=</span> <span class="p">((</span><span class="n">diff2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff2</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* calculate the byte position of the error */</span>

		<span class="n">byte</span> <span class="o">=</span> <span class="p">((</span><span class="n">diff2</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff0</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff0</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>  <span class="o">|</span>
		       <span class="p">((</span><span class="n">diff0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;correcting error bit %d, byte %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bit</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

		<span class="n">dat</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if there is only one bit difference in the ECC, then</span>
<span class="cm">	 * one of only a row or column parity has changed, which</span>
<span class="cm">	 * means the error is most probably in the ECC itself */</span>

	<span class="n">diff0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">diff0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">diff2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">diff0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">fls</span><span class="p">(</span><span class="n">diff0</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ECC functions</span>
<span class="cm"> *</span>
<span class="cm"> * These allow the s3c2410 and s3c2440 to use the controller&#39;s ECC</span>
<span class="cm"> * generator block to ECC the data as it passes through]</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_enable_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCONF</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">S3C2410_NFCONF_INITECC</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCONF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2412_nand_enable_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">S3C2412_NFCONT_INIT_MAIN_ECC</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2440_nand_enable_hwecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">S3C2440_NFCONT_INITECC</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_calculate_ecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ecc_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFECC</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFECC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFECC</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: returning ecc %02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">ecc_code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecc_code</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ecc_code</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2412_nand_calculate_ecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ecc_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ecc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2412_NFMECC0</span><span class="p">);</span>

	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span><span class="p">;</span>
	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;calculate_ecc: returning ecc %02x,%02x,%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ecc_code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecc_code</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ecc_code</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2440_nand_calculate_ecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ecc_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ecc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFMECC0</span><span class="p">);</span>

	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span><span class="p">;</span>
	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ecc_code</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: returning ecc %06lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ecc</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* over-ride the standard functions for a little more speed. We can</span>
<span class="cm"> * use read/write block to move the data buffers to/from the controller</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">readsb</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2440_nand_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">readsl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFDATA</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* cleanup if we&#39;ve got less than a word to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFDATA</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">writesb</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2440_nand_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">s3c2410_nand_mtd_toinfo</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">writesl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFDATA</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* cleanup any fractional write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFDATA</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* cpufreq driver support */</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_cpufreq_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newclk</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_nand_info</span><span class="p">,</span> <span class="n">freq_transition</span><span class="p">);</span>
	<span class="n">newclk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_POSTCHANGE</span> <span class="o">&amp;&amp;</span> <span class="n">newclk</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clk_rate</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_PRECHANGE</span> <span class="o">&amp;&amp;</span> <span class="n">newclk</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clk_rate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s3c2410_nand_setrate</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_cpufreq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">s3c2410_nand_cpufreq_transition</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
					 <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_cpufreq_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
				    <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_cpufreq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_cpufreq_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* device management functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c24xx_nand_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_nand_info</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s3c2410_nand_cpufreq_deregister</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Release all our mtds  and their partitions, then go through</span>
<span class="cm">	 * freeing the resources used</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mtdno</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">mtdno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mtdno</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mtd_count</span><span class="p">;</span> <span class="n">mtdno</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;releasing mtd %d (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtdno</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">nand_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free the common resources */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_DISABLE</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">area</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_resource</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_nand_add_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">s3c2410_nand_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mtd_device_parse_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					 <span class="n">set</span><span class="o">-&gt;</span><span class="n">partitions</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">nr_partitions</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2410_nand_init_chip - initialise a single instance of an chip</span>
<span class="cm"> * @info: The base NAND controller the chip is on.</span>
<span class="cm"> * @nmtd: The new controller MTD instance to fill in.</span>
<span class="cm"> * @set: The information passed from the board specific platform data.</span>
<span class="cm"> *</span>
<span class="cm"> * Initialise the given @nmtd from the information in @info and @set. This</span>
<span class="cm"> * readies the structure for use with the MTD layer functions by ensuring</span>
<span class="cm"> * all pointers are setup and the necessary control routines selected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="n">nmtd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">s3c2410_nand_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span>    <span class="o">=</span> <span class="n">s3c2410_nand_write_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span>     <span class="o">=</span> <span class="n">s3c2410_nand_read_buf</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">select_chip</span>  <span class="o">=</span> <span class="n">s3c2410_nand_select_chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_delay</span>   <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">priv</span>	   <span class="o">=</span> <span class="n">nmtd</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span>	   <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_S3C2410</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFDATA</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span>   <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCONF</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span>	<span class="o">=</span> <span class="n">S3C2410_NFCONF_nFCE</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span>  <span class="o">=</span> <span class="n">s3c2410_nand_hwcontrol</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span> <span class="o">=</span> <span class="n">s3c2410_nand_devready</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TYPE_S3C2440</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFDATA</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span>   <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span>	<span class="o">=</span> <span class="n">S3C2440_NFCONT_nFCE</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span>  <span class="o">=</span> <span class="n">s3c2440_nand_hwcontrol</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span> <span class="o">=</span> <span class="n">s3c2440_nand_devready</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read_buf</span>  <span class="o">=</span> <span class="n">s3c2440_nand_read_buf</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write_buf</span>	<span class="o">=</span> <span class="n">s3c2440_nand_write_buf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TYPE_S3C2412</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFDATA</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span>   <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2440_NFCONT</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span>	<span class="o">=</span> <span class="n">S3C2412_NFCONT_nFCE0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span>  <span class="o">=</span> <span class="n">s3c2440_nand_hwcontrol</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev_ready</span> <span class="o">=</span> <span class="n">s3c2412_nand_devready</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C2410_NFCONF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S3C2412_NFCONF_NANDBOOT</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;System booted from NAND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
  	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">;</span>

	<span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">info</span>	   <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">priv</span>	   <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">owner</span>    <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">set</span>	   <span class="o">=</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hardware_ecc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">s3c2410_nand_calculate_ecc</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">correct</span>   <span class="o">=</span> <span class="n">s3c2410_nand_correct_data</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span>	    <span class="o">=</span> <span class="n">NAND_ECC_HW</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">strength</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TYPE_S3C2410</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span>	    <span class="o">=</span> <span class="n">s3c2410_nand_enable_hwecc</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">s3c2410_nand_calculate_ecc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TYPE_S3C2412</span>:
  			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span>     <span class="o">=</span> <span class="n">s3c2412_nand_enable_hwecc</span><span class="p">;</span>
  			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">s3c2412_nand_calculate_ecc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TYPE_S3C2440</span>:
  			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">hwctl</span>     <span class="o">=</span> <span class="n">s3c2440_nand_enable_hwecc</span><span class="p">;</span>
  			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">s3c2440_nand_calculate_ecc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span>	    <span class="o">=</span> <span class="n">NAND_ECC_SOFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">ecc_layout</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">ecc_layout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">disable_ecc</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span>	<span class="o">=</span> <span class="n">NAND_ECC_NONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NAND_ECC_NONE</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;NAND ECC disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NAND_ECC_SOFT</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;NAND soft ECC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NAND_ECC_HW</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;NAND hardware ECC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;NAND ECC UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If you use u-boot BBT creation code, specifying this flag will</span>
<span class="cm">	 * let the kernel fish out the BBT from the NAND, and also skip the</span>
<span class="cm">	 * full NAND scan that can take 1/2s or so. Little things... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">flash_bbt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bbt_options</span> <span class="o">|=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NAND_SKIP_BBTSCAN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2410_nand_update_chip - post probe update</span>
<span class="cm"> * @info: The controller instance.</span>
<span class="cm"> * @nmtd: The driver version of the MTD instance.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called after the chip probe has successfully completed</span>
<span class="cm"> * and the relevant per-chip information updated. This call ensure that</span>
<span class="cm"> * we update the internal state accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * The internal state is currently limited to the ECC state information.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_nand_update_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="n">nmtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;chip %p =&gt; page shift %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">NAND_ECC_HW</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* change the behaviour depending on wether we are using</span>
<span class="cm">		 * the large or small page nand device */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">page_shift</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span>	    <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span>	    <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">size</span>	    <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">bytes</span>	    <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ecc</span><span class="p">.</span><span class="n">layout</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_hw_eccoob</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* s3c24xx_nand_probe</span>
<span class="cm"> *</span>
<span class="cm"> * called by device layer when it finds a device matching</span>
<span class="cm"> * one our driver can handled. This code checks to see if</span>
<span class="cm"> * it can allocate all necessary resources then calls the</span>
<span class="cm"> * nand layer to look for devices</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c24xx_nand_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_platform_nand</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">to_nand_plat</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">s3c_cpu_type</span> <span class="n">cpu_type</span><span class="p">;</span> 
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_mtd</span> <span class="o">*</span><span class="n">nmtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_set</span> <span class="o">*</span><span class="n">sets</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_sets</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">setno</span><span class="p">;</span>

	<span class="n">cpu_type</span> <span class="o">=</span> <span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;s3c2410_nand_probe(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory for flash info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">.</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* get the clock source and enable it */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nand&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_ENABLE</span><span class="p">);</span>

	<span class="cm">/* allocate and map the resource */</span>

	<span class="cm">/* currently we assume we have the one resource */</span>
	<span class="n">res</span>  <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">area</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot reserve register region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">platform</span>   <span class="o">=</span> <span class="n">plat</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span>       <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span>   <span class="o">=</span> <span class="n">cpu_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot reserve register region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mapped registers at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="cm">/* initialise the hardware */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">s3c2410_nand_inithw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>

	<span class="n">sets</span> <span class="o">=</span> <span class="p">(</span><span class="n">plat</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">sets</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nr_sets</span> <span class="o">=</span> <span class="p">(</span><span class="n">plat</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">nr_sets</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mtd_count</span> <span class="o">=</span> <span class="n">nr_sets</span><span class="p">;</span>

	<span class="cm">/* allocate our information */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">nr_sets</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate mtd storage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialise all possible chips */</span>

	<span class="n">nmtd</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mtds</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">setno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">setno</span> <span class="o">&lt;</span> <span class="n">nr_sets</span><span class="p">;</span> <span class="n">setno</span><span class="o">++</span><span class="p">,</span> <span class="n">nmtd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;initialising set %d (%p, info %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">setno</span><span class="p">,</span> <span class="n">nmtd</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="n">s3c2410_nand_init_chip</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">nmtd</span><span class="p">,</span> <span class="n">sets</span><span class="p">);</span>

		<span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">scan_res</span> <span class="o">=</span> <span class="n">nand_scan_ident</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">sets</span><span class="p">)</span> <span class="o">?</span> <span class="n">sets</span><span class="o">-&gt;</span><span class="n">nr_chips</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
						 <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">scan_res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c2410_nand_update_chip</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">nmtd</span><span class="p">);</span>
			<span class="n">nand_scan_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nmtd</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">);</span>
			<span class="n">s3c2410_nand_add_partition</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">nmtd</span><span class="p">,</span> <span class="n">sets</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sets</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">sets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">s3c2410_nand_cpufreq_register</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to init cpufreq support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allow_clk_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clock idle support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_SUSPEND</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;initialised ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">exit_error:</span>
	<span class="n">s3c24xx_nand_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PM Support */</span>
<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c24xx_nand_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">pm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">save_sel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span><span class="p">);</span>

		<span class="cm">/* For the moment, we must ensure nFCE is high during</span>
<span class="cm">		 * the time we are suspended. This really should be</span>
<span class="cm">		 * handled by suspending the MTDs we are using, but</span>
<span class="cm">		 * that is currently not the case. */</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">save_sel</span> <span class="o">|</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span><span class="p">);</span>

		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_DISABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c24xx_nand_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_nand_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_ENABLE</span><span class="p">);</span>
		<span class="n">s3c2410_nand_inithw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* Restore the state of the nFCE line. */</span>

		<span class="n">sel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span><span class="p">);</span>
		<span class="n">sel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span><span class="p">;</span>
		<span class="n">sel</span> <span class="o">|=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">save_sel</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_bit</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sel_reg</span><span class="p">);</span>

		<span class="n">s3c2410_nand_clk_set_state</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CLOCK_SUSPEND</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define s3c24xx_nand_suspend NULL</span>
<span class="cp">#define s3c24xx_nand_resume NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* driver device registration */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">s3c24xx_driver_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c2410-nand&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S3C2410</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c2440-nand&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S3C2440</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c2412-nand&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S3C2412</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c6400-nand&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S3C2412</span><span class="p">,</span> <span class="cm">/* compatible with 2412 */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">s3c24xx_driver_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s3c24xx_nand_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">s3c24xx_nand_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">s3c24xx_nand_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">s3c24xx_nand_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">s3c24xx_nand_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">s3c24xx_driver_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;s3c24xx-nand&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c2410_nand_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;S3C24XX NAND Driver, (c) 2004 Simtec Electronics</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s3c24xx_nand_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">s3c2410_nand_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s3c24xx_nand_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">s3c2410_nand_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">s3c2410_nand_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;S3C24XX MTD NAND driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
