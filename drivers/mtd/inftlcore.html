<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › inftlcore.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>inftlcore.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * inftlcore.c -- Linux driver for Inverse Flash Translation Layer (INFTL)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2002, Greg Ungerer (gerg@snapgear.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Based heavily on the nftlcore.c code which is:</span>
<span class="cm"> * Copyright © 1999 Machine Vision Holdings, Inc.</span>
<span class="cm"> * Copyright © 1999 David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nftl.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/inftl.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/errno.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum number of loops while examining next block, to have a</span>
<span class="cm"> * chance to detect consistency problems (they should never happen</span>
<span class="cm"> * because of the checks done in the mounting.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_LOOPS 10000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inftl_add_mtd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_ops</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MTD_NANDFLASH</span> <span class="o">||</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">UINT_MAX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* OK, this is moderately ugly.  But probably safe.  Alternatives? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DiskOnChip&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_isbad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
<span class="s">&quot;INFTL no longer supports the old DiskOnChip drivers loaded via docprobe.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Please use the new diskonchip driver under the NAND subsystem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: add_mtd for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">inftl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inftl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inftl</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>
	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">devnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INFTL_mount</span><span class="p">(</span><span class="n">inftl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: could not mount device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">inftl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OK, it&#39;s a new one. Set up all the data structures. */</span>

	<span class="cm">/* Calculate geometry */</span>
	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">%</span> <span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">temp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">%</span> <span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span><span class="o">++</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  Oh no we don&#39;t have</span>
<span class="cm">		   mbd.size == heads * cylinders * sectors</span>
<span class="cm">		*/</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: cannot calculate a geometry to &quot;</span>
		       <span class="s">&quot;match size of 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: using C:%d H:%d S:%d &quot;</span>
			<span class="s">&quot;(== 0x%lx sects)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">,</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="p">,</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">*</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span>
			<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_mtd_blktrans_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">inftl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PSYCHO_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;INFTL: Found new inftl%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">devnum</span> <span class="o">+</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inftl_remove_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: remove_dev (i=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="n">del_mtd_blktrans_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Actual INFTL access routines.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Read oob data from flash</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">inftl_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write oob data to flash</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">inftl_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write data and oob to flash</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inftl_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		       <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">oob</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mtd_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * INFTL_findfreeblock: Find a free Erase Unit on the INFTL partition.</span>
<span class="cm"> *	This function is used when the give Virtual Unit Chain.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">INFTL_findfreeblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desperate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pot</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">LastFreeEUN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">silly</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: INFTL_findfreeblock(inftl=%p,desperate=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inftl</span><span class="p">,</span> <span class="n">desperate</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Normally, we force a fold to happen before we run out of free</span>
<span class="cm">	 * blocks completely.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desperate</span> <span class="o">&amp;&amp;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">numfreeEUNs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: there are too few free EUNs (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">numfreeEUNs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Scan for a free block */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">pot</span><span class="p">]</span> <span class="o">==</span> <span class="n">BLOCK_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">LastFreeEUN</span> <span class="o">=</span> <span class="n">pot</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">pot</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pot</span> <span class="o">&gt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">lastEUN</span><span class="p">)</span>
			<span class="n">pot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: no free blocks found!  &quot;</span>
				<span class="s">&quot;EUN range = %d - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">LastFreeEUN</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pot</span> <span class="o">!=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">LastFreeEUN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">INFTL_foldchain</span><span class="p">(</span><span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">thisVUC</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pendingblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">BlockMap</span><span class="p">[</span><span class="n">MAX_SECTORS_PER_UNIT</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BlockDeleted</span><span class="p">[</span><span class="n">MAX_SECTORS_PER_UNIT</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">prevEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">silly</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">targetEUN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_oob</span> <span class="n">oob</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: INFTL_foldchain(inftl=%p,thisVUC=%d,pending=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inftl</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">,</span> <span class="n">pendingblock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">BlockMap</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BlockMap</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">BlockDeleted</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BlockDeleted</span><span class="p">));</span>

	<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">targetEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: trying to fold non-existent &quot;</span>
		       <span class="s">&quot;Virtual Unit Chain %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan to find the Erase Unit which holds the actual data for each</span>
<span class="cm">	 * 512-byte block within the Chain.</span>
<span class="cm">	 */</span>
	<span class="n">silly</span> <span class="o">=</span> <span class="n">MAX_LOOPS</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="o">/</span><span class="n">SECTORSIZE</span><span class="p">;</span> <span class="n">block</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">BlockMap</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">BlockDeleted</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span>
					   <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">),</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">SECTOR_IGNORE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">oob</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="n">oob</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">Status1</span><span class="p">;</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SECTOR_FREE</span>:
			<span class="k">case</span> <span class="n">SECTOR_IGNORE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SECTOR_USED</span>:
				<span class="n">BlockMap</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisEUN</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SECTOR_DELETED</span>:
				<span class="n">BlockDeleted</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: unknown status &quot;</span>
					<span class="s">&quot;for block %d in EUN %d: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">block</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: infinite loop in Virtual &quot;</span>
				<span class="s">&quot;Unit Chain 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK. We now know the location of every block in the Virtual Unit</span>
<span class="cm">	 * Chain, and the Erase Unit into which we are supposed to be copying.</span>
<span class="cm">	 * Go for it.</span>
<span class="cm">	 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: folding chain %d into unit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">,</span> <span class="n">targetEUN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="o">/</span><span class="n">SECTORSIZE</span> <span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">movebuf</span><span class="p">[</span><span class="n">SECTORSIZE</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s in the target EUN already, or if it&#39;s pending write,</span>
<span class="cm">		 * do nothing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BlockMap</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">==</span> <span class="n">targetEUN</span> <span class="o">||</span> <span class="p">(</span><span class="n">pendingblock</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">thisVUC</span> <span class="o">*</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">block</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Copy only in non free block (free blocks can only</span>
<span class="cm">                 * happen in case of media errors or deleted blocks).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BlockMap</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">*</span> <span class="n">BlockMap</span><span class="p">[</span><span class="n">block</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">),</span>
			       <span class="n">SECTORSIZE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
			       <span class="n">movebuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mtd_is_bitflip</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">*</span> <span class="n">BlockMap</span><span class="p">[</span><span class="n">block</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">),</span>
				       <span class="n">SECTORSIZE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
				       <span class="n">movebuf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: error went away on retry?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inftl_oob</span><span class="p">));</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">oob</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">Status1</span> <span class="o">=</span> <span class="n">SECTOR_USED</span><span class="p">;</span>

		<span class="n">inftl_write</span><span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">*</span> <span class="n">targetEUN</span><span class="p">)</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">),</span> <span class="n">SECTORSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
			    <span class="n">movebuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Newest unit in chain now contains data from _all_ older units.</span>
<span class="cm">	 * So go through and erase each unit in chain, oldest first. (This</span>
<span class="cm">	 * is important, by doing oldest first if we crash/reboot then it</span>
<span class="cm">	 * it is relatively simple to clean up the mess).</span>
<span class="cm">	 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: want to erase virtual chain %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Find oldest unit in chain. */</span>
		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
		<span class="n">prevEUN</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prevEUN</span> <span class="o">=</span> <span class="n">thisEUN</span><span class="p">;</span>
			<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/* Check if we are all done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">==</span> <span class="n">targetEUN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Unlink the last block from the chain. */</span>
		<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">prevEUN</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>

		<span class="cm">/* Now try to erase it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INFTL_formatblock</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Could not erase : mark block as reserved.</span>
<span class="cm">			 */</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_RESERVED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Correctly erased : mark it as free */</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_FREE</span><span class="p">;</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">numfreeEUNs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">targetEUN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">INFTL_makefreeblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pendingblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the part that needs some cleverness applied.</span>
<span class="cm">	 * For now, I&#39;m doing the minimum applicable to actually</span>
<span class="cm">	 * get the thing to work.</span>
<span class="cm">	 * Wear-levelling and other clever stuff needs to be implemented</span>
<span class="cm">	 * and we also need to do some assessment of the results when</span>
<span class="cm">	 * the system loses power half-way through the routine.</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">LongestChain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ChainLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chain</span><span class="p">,</span> <span class="n">EUN</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: INFTL_makefreeblock(inftl=%p,&quot;</span>
		<span class="s">&quot;pending=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="p">,</span> <span class="n">pendingblock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chain</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">;</span> <span class="n">chain</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">chain</span><span class="p">];</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">EUN</span> <span class="o">&lt;=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">lastEUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thislen</span><span class="o">++</span><span class="p">;</span>
			<span class="n">EUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">EUN</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">thislen</span> <span class="o">&gt;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: endless loop in &quot;</span>
					<span class="s">&quot;Virtual Chain %d: Unit %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">chain</span><span class="p">,</span> <span class="n">EUN</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Actually, don&#39;t return failure.</span>
<span class="cm">				 * Just ignore this chain and get on with it.</span>
<span class="cm">				 */</span>
				<span class="n">thislen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">thislen</span> <span class="o">&gt;</span> <span class="n">ChainLength</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ChainLength</span> <span class="o">=</span> <span class="n">thislen</span><span class="p">;</span>
			<span class="n">LongestChain</span> <span class="o">=</span> <span class="n">chain</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ChainLength</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: no Virtual Unit Chains available &quot;</span>
			<span class="s">&quot;for folding. Failing request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">INFTL_foldchain</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">LongestChain</span><span class="p">,</span> <span class="n">pendingblock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nrbits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">bitcount</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * INFTL_findwriteunit: Return the unit number into which we can write</span>
<span class="cm"> *                      for this block. Make it available if it isn&#39;t already.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">INFTL_findwriteunit</span><span class="p">(</span><span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thisVUC</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">writeEUN</span><span class="p">,</span> <span class="n">prev_block</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blockofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_oob</span> <span class="n">oob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_bci</span> <span class="n">bci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">anac</span><span class="p">,</span> <span class="n">nacs</span><span class="p">,</span> <span class="n">parity</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">silly</span><span class="p">,</span> <span class="n">silly2</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: INFTL_findwriteunit(inftl=%p,block=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Scan the media to find a unit in the VUC which has</span>
<span class="cm">		 * a free space for the block in question.</span>
<span class="cm">		 */</span>
		<span class="n">writeEUN</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
		<span class="n">silly</span> <span class="o">=</span> <span class="n">MAX_LOOPS</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">&lt;=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">lastEUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span> <span class="o">+</span>
				       <span class="n">blockofs</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bci</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status1</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: status of block %d in EUN %d is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">block</span> <span class="p">,</span> <span class="n">writeEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SECTOR_FREE</span>:
				<span class="n">writeEUN</span> <span class="o">=</span> <span class="n">thisEUN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SECTOR_DELETED</span>:
			<span class="k">case</span> <span class="n">SECTOR_USED</span>:
				<span class="cm">/* Can&#39;t go any further */</span>
				<span class="k">goto</span> <span class="n">hitused</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SECTOR_IGNORE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/*</span>
<span class="cm">				 * Invalid block. Don&#39;t use it any more.</span>
<span class="cm">				 * Must implement.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: infinite loop in &quot;</span>
					<span class="s">&quot;Virtual Unit Chain 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Skip to next block in chain */</span>
			<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
		<span class="p">}</span>

<span class="nl">hitused:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">writeEUN</span> <span class="o">!=</span> <span class="n">BLOCK_NIL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">writeEUN</span><span class="p">;</span>


		<span class="cm">/*</span>
<span class="cm">		 * OK. We didn&#39;t find one in the existing chain, or there</span>
<span class="cm">		 * is no existing chain. Allocate a new one.</span>
<span class="cm">		 */</span>
		<span class="n">writeEUN</span> <span class="o">=</span> <span class="n">INFTL_findfreeblock</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">writeEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * That didn&#39;t work - there were no free blocks just</span>
<span class="cm">			 * waiting to be picked up. We&#39;re going to have to fold</span>
<span class="cm">			 * a chain to make room.</span>
<span class="cm">			 */</span>
			<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">INFTL_makefreeblock</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Hopefully we free something, lets try again.</span>
<span class="cm">			 * This time we are desperate...</span>
<span class="cm">			 */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: using desperate==1 to find free EUN &quot;</span>
					<span class="s">&quot;to accommodate write to VUC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">thisVUC</span><span class="p">);</span>
			<span class="n">writeEUN</span> <span class="o">=</span> <span class="n">INFTL_findfreeblock</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">writeEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Ouch. This should never happen - we should</span>
<span class="cm">				 * always be able to make some room somehow.</span>
<span class="cm">				 * If we get here, we&#39;ve allocated more storage</span>
<span class="cm">				 * space than actual media, or our makefreeblock</span>
<span class="cm">				 * routine is missing something.</span>
<span class="cm">				 */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: cannot make free &quot;</span>
					<span class="s">&quot;space.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
				<span class="n">INFTL_dumptables</span><span class="p">(</span><span class="n">inftl</span><span class="p">);</span>
				<span class="n">INFTL_dumpVUchains</span><span class="p">(</span><span class="n">inftl</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Insert new block into virtual chain. Firstly update the</span>
<span class="cm">		 * block headers in flash...</span>
<span class="cm">		 */</span>
		<span class="n">anac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nacs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">!=</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span>
				       <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">);</span>
			<span class="n">anac</span> <span class="o">=</span> <span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">ANAC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nacs</span> <span class="o">=</span> <span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">NACs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prev_block</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev_block</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">)</span>
			<span class="n">prev_block</span> <span class="o">-=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">firstEUN</span><span class="p">;</span>

		<span class="n">parity</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrbits</span><span class="p">(</span><span class="n">thisVUC</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parity</span> <span class="o">|=</span> <span class="p">(</span><span class="n">nrbits</span><span class="p">(</span><span class="n">prev_block</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parity</span> <span class="o">|=</span> <span class="p">(</span><span class="n">nrbits</span><span class="p">(</span><span class="n">anac</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parity</span> <span class="o">|=</span> <span class="p">(</span><span class="n">nrbits</span><span class="p">(</span><span class="n">nacs</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">virtualUnitNo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">thisVUC</span><span class="p">);</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">prevUnitNo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prev_block</span><span class="p">);</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">ANAC</span> <span class="o">=</span> <span class="n">anac</span><span class="p">;</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">NACs</span> <span class="o">=</span> <span class="n">nacs</span><span class="p">;</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">parityPerField</span> <span class="o">=</span> <span class="n">parity</span><span class="p">;</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">discarded</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>

		<span class="n">inftl_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">writeEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">);</span>

		<span class="cm">/* Also back up header... */</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">virtualUnitNo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">thisVUC</span><span class="p">);</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">prevUnitNo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prev_block</span><span class="p">);</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ANAC</span> <span class="o">=</span> <span class="n">anac</span><span class="p">;</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">NACs</span> <span class="o">=</span> <span class="n">nacs</span><span class="p">;</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">parityPerField</span> <span class="o">=</span> <span class="n">parity</span><span class="p">;</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">discarded</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>

		<span class="n">inftl_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">writeEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">+</span>
				<span class="n">SECTORSIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">.</span><span class="n">u</span><span class="p">);</span>

		<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">writeEUN</span><span class="p">]</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
		<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">]</span> <span class="o">=</span> <span class="n">writeEUN</span><span class="p">;</span>

		<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">numfreeEUNs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">writeEUN</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">silly2</span><span class="o">--</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: error folding to make room for Virtual &quot;</span>
		<span class="s">&quot;Unit Chain 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Given a Virtual Unit Chain, see if it can be deleted, and if so do it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">INFTL_trydeletechain</span><span class="p">(</span><span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">thisVUC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BlockUsed</span><span class="p">[</span><span class="n">MAX_SECTORS_PER_UNIT</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BlockDeleted</span><span class="p">[</span><span class="n">MAX_SECTORS_PER_UNIT</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">silly</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_bci</span> <span class="n">bci</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: INFTL_trydeletechain(inftl=%p,&quot;</span>
		<span class="s">&quot;thisVUC=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">BlockUsed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BlockUsed</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">BlockDeleted</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BlockDeleted</span><span class="p">));</span>

	<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: trying to delete non-existent &quot;</span>
		       <span class="s">&quot;Virtual Unit Chain %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan through the Erase Units to determine whether any data is in</span>
<span class="cm">	 * each of the 512-byte blocks within the Chain.</span>
<span class="cm">	 */</span>
	<span class="n">silly</span> <span class="o">=</span> <span class="n">MAX_LOOPS</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="o">/</span><span class="n">SECTORSIZE</span><span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BlockUsed</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">||</span> <span class="n">BlockDeleted</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span>
					   <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">),</span> <span class="mi">8</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
					  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">SECTOR_IGNORE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status1</span><span class="p">;</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SECTOR_FREE</span>:
			<span class="k">case</span> <span class="n">SECTOR_IGNORE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SECTOR_USED</span>:
				<span class="n">BlockUsed</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SECTOR_DELETED</span>:
				<span class="n">BlockDeleted</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: unknown status &quot;</span>
					<span class="s">&quot;for block %d in EUN %d: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">block</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: infinite loop in Virtual &quot;</span>
				<span class="s">&quot;Unit Chain 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="o">/</span><span class="n">SECTORSIZE</span><span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BlockUsed</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For each block in the chain free it and make it available</span>
<span class="cm">	 * for future use. Erase from the oldest unit first.</span>
<span class="cm">	 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: deleting empty VUC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">prevEUN</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">];</span>
		<span class="n">thisEUN</span> <span class="o">=</span> <span class="o">*</span><span class="n">prevEUN</span><span class="p">;</span>

		<span class="cm">/* If the chain is all gone already, we&#39;re done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: Empty VUC %d for deletion was already absent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Find oldest unit in chain. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">thisEUN</span> <span class="o">&gt;=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">);</span>

			<span class="n">prevEUN</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
			<span class="n">thisEUN</span> <span class="o">=</span> <span class="o">*</span><span class="n">prevEUN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Deleting EUN %d from VUC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">thisEUN</span><span class="p">,</span> <span class="n">thisVUC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">INFTL_formatblock</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Could not erase : mark block as reserved.</span>
<span class="cm">			 */</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_RESERVED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Correctly erased : mark it as free */</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_FREE</span><span class="p">;</span>
			<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">numfreeEUNs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now sort out whatever was pointing to it... */</span>
		<span class="o">*</span><span class="n">prevEUN</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>

		<span class="cm">/* Ideally we&#39;d actually be responsive to new</span>
<span class="cm">		   requests while we&#39;re doing this -- if there&#39;s</span>
<span class="cm">		   free space why should others be made to wait? */</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">thisVUC</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">INFTL_deleteblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">block</span> <span class="o">/</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blockofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">silly</span> <span class="o">=</span> <span class="n">MAX_LOOPS</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_bci</span> <span class="n">bci</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: INFTL_deleteblock(inftl=%p,&quot;</span>
		<span class="s">&quot;block=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">blockofs</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SECTOR_IGNORE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SECTOR_FREE</span>:
		<span class="k">case</span> <span class="n">SECTOR_IGNORE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SECTOR_DELETED</span>:
			<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">foundit</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SECTOR_USED</span>:
			<span class="k">goto</span> <span class="n">foundit</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: unknown status for &quot;</span>
				<span class="s">&quot;block %d in EUN %d: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">block</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: infinite loop in Virtual &quot;</span>
				<span class="s">&quot;Unit Chain 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">block</span> <span class="o">/</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
	<span class="p">}</span>

<span class="nl">foundit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">!=</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span> <span class="o">+</span> <span class="n">blockofs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">bci</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status1</span> <span class="o">=</span> <span class="n">SECTOR_DELETED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inftl_write_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">INFTL_trydeletechain</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">block</span> <span class="o">/</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inftl_writeblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">mbd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">writeEUN</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blockofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_oob</span> <span class="n">oob</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">pend</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: inftl_writeblock(inftl=%p,block=%ld,&quot;</span>
		<span class="s">&quot;buffer=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="cm">/* Is block all zero? */</span>
	<span class="n">pend</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">SECTORSIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">pend</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">pend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeEUN</span> <span class="o">=</span> <span class="n">INFTL_findwriteunit</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">writeEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;inftl_writeblock(): cannot find &quot;</span>
				<span class="s">&quot;block to write to</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we _still_ haven&#39;t got a block to use,</span>
<span class="cm">			 * we&#39;re screwed.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inftl_oob</span><span class="p">));</span>
		<span class="n">oob</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">oob</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">Status1</span> <span class="o">=</span> <span class="n">SECTOR_USED</span><span class="p">;</span>

		<span class="n">inftl_write</span><span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">writeEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">blockofs</span><span class="p">,</span> <span class="n">SECTORSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * need to write SECTOR_USED flags since they are not written</span>
<span class="cm">		 * in mtd_writeecc</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INFTL_deleteblock</span><span class="p">(</span><span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inftl_readblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">mbd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">VUtable</span><span class="p">[</span><span class="n">block</span> <span class="o">/</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blockofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">SECTORSIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">silly</span> <span class="o">=</span> <span class="n">MAX_LOOPS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inftl_bci</span> <span class="n">bci</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;INFTL: inftl_readblock(inftl=%p,block=%ld,&quot;</span>
		<span class="s">&quot;buffer=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inftl</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">&lt;</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">nb_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inftl_read_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span> <span class="o">+</span>
				  <span class="n">blockofs</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SECTOR_IGNORE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="n">bci</span><span class="p">.</span><span class="n">Status1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SECTOR_DELETED</span>:
			<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">BLOCK_NIL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">foundit</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SECTOR_USED</span>:
			<span class="k">goto</span> <span class="n">foundit</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SECTOR_FREE</span>:
		<span class="k">case</span> <span class="n">SECTOR_IGNORE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: unknown status for &quot;</span>
				<span class="s">&quot;block %ld in EUN %d: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">block</span><span class="p">,</span> <span class="n">thisEUN</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silly</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;INFTL: infinite loop in &quot;</span>
				<span class="s">&quot;Virtual Unit Chain 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">block</span> <span class="o">/</span> <span class="p">(</span><span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span> <span class="o">/</span> <span class="n">SECTORSIZE</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">thisEUN</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">PUtable</span><span class="p">[</span><span class="n">thisEUN</span><span class="p">];</span>
	<span class="p">}</span>

<span class="nl">foundit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">==</span> <span class="n">BLOCK_NIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The requested block is not on the media, return all 0x00 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SECTORSIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
		<span class="n">loff_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">thisEUN</span> <span class="o">*</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">EraseSize</span><span class="p">)</span> <span class="o">+</span> <span class="n">blockofs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">SECTORSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="cm">/* Handle corrected bit flips gracefully */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mtd_is_bitflip</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inftl_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">INFTLrecord</span> <span class="o">*</span><span class="n">inftl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">inftl</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_blktrans_ops</span> <span class="n">inftl_tr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;inftl&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>		<span class="o">=</span> <span class="n">INFTL_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">part_bits</span>	<span class="o">=</span> <span class="n">INFTL_PARTN_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blksize</span> 	<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>		<span class="o">=</span> <span class="n">inftl_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readsect</span>	<span class="o">=</span> <span class="n">inftl_readblock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writesect</span>	<span class="o">=</span> <span class="n">inftl_writeblock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_mtd</span>	<span class="o">=</span> <span class="n">inftl_add_mtd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_dev</span>	<span class="o">=</span> <span class="n">inftl_remove_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_inftl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_mtd_blktrans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inftl_tr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_inftl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deregister_mtd_blktrans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inftl_tr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_inftl</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_inftl</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Greg Ungerer &lt;gerg@snapgear.com&gt;, David Woodhouse &lt;dwmw2@infradead.org&gt;, Fabrice Bellard &lt;fabrice.bellard@netgem.com&gt; et al.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support code for Inverse Flash Translation Layer, used on M-Systems DiskOnChip 2000, Millennium and Millennium Plus&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
