<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › maps › nettel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nettel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *      nettel.c -- mappings for NETtel/SecureEdge/SnapGear (x86) boards.</span>
<span class="cm"> *</span>
<span class="cm"> *      (C) Copyright 2000-2001, Greg Ungerer (gerg@snapgear.com)</span>
<span class="cm"> *      (C) Copyright 2001-2002, SnapGear (www.snapgear.com)</span>
<span class="cm"> */</span>

<span class="cm">/****************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/map.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/cfi.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/****************************************************************************/</span>

<span class="cp">#define INTEL_BUSWIDTH		1</span>
<span class="cp">#define AMD_WINDOW_MAXSIZE	0x00200000</span>
<span class="cp">#define AMD_BUSWIDTH	 	1</span>

<span class="cm">/*</span>
<span class="cm"> *	PAR masks and shifts, assuming 64K pages.</span>
<span class="cm"> */</span>
<span class="cp">#define SC520_PAR_ADDR_MASK	0x00003fff</span>
<span class="cp">#define SC520_PAR_ADDR_SHIFT	16</span>
<span class="cp">#define SC520_PAR_TO_ADDR(par) \</span>
<span class="cp">	(((par)&amp;SC520_PAR_ADDR_MASK) &lt;&lt; SC520_PAR_ADDR_SHIFT)</span>

<span class="cp">#define SC520_PAR_SIZE_MASK	0x01ffc000</span>
<span class="cp">#define SC520_PAR_SIZE_SHIFT	2</span>
<span class="cp">#define SC520_PAR_TO_SIZE(par) \</span>
<span class="cp">	((((par)&amp;SC520_PAR_SIZE_MASK) &lt;&lt; SC520_PAR_SIZE_SHIFT) + (64*1024))</span>

<span class="cp">#define SC520_PAR(cs, addr, size) \</span>
<span class="cp">	((cs) | \</span>
<span class="cp">	((((size)-(64*1024)) &gt;&gt; SC520_PAR_SIZE_SHIFT) &amp; SC520_PAR_SIZE_MASK) | \</span>
<span class="cp">	(((addr) &gt;&gt; SC520_PAR_ADDR_SHIFT) &amp; SC520_PAR_ADDR_MASK))</span>

<span class="cp">#define SC520_PAR_BOOTCS	0x8a000000</span>
<span class="cp">#define	SC520_PAR_ROMCS1	0xaa000000</span>
<span class="cp">#define SC520_PAR_ROMCS2	0xca000000	</span><span class="cm">/* Cache disabled, 64K page */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">nettel_mmcrp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">intel_mtd</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">amd_mtd</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>

<span class="cm">/****************************************************************************/</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">map_info</span> <span class="n">nettel_intel_map</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear Intel&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bankwidth</span> <span class="o">=</span> <span class="n">INTEL_BUSWIDTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">nettel_intel_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x000e0000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear filesystem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x000e0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x00020000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear Intel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear BIOS Config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x007e0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x00020000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear BIOS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x007e0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x00020000</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">map_info</span> <span class="n">nettel_amd_map</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear AMD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">AMD_WINDOW_MAXSIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bankwidth</span> <span class="o">=</span> <span class="n">AMD_BUSWIDTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">nettel_amd_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear BIOS config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x000e0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x00010000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear BIOS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x000f0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x00010000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear AMD&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SnapGear high BIOS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x001f0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x00010000</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NUM_AMD_PARTITIONS ARRAY_SIZE(nettel_amd_partitions)</span>

<span class="cm">/****************************************************************************/</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>

<span class="cm">/*</span>
<span class="cm"> *	Set the Intel flash back to read mode since some old boot</span>
<span class="cm"> *	loaders don&#39;t.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nettel_reboot_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfi_private</span> <span class="o">*</span><span class="n">cfi</span> <span class="o">=</span> <span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">fldrv_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">;</span>

	<span class="cm">/* Make sure all FLASH chips are put back into read mode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">size</span><span class="p">);</span> <span class="n">b</span> <span class="o">+=</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfi_send_gen_cmd</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nettel_intel_map</span><span class="p">,</span> <span class="n">cfi</span><span class="p">,</span>
			<span class="n">cfi</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="n">NOTIFY_OK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">nettel_notifier_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">nettel_reboot_notifier</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nettel_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">amdpar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">amdaddr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_amd_partitions</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">intel0par</span><span class="p">,</span> <span class="o">*</span><span class="n">intel1par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_bootcspar</span><span class="p">,</span> <span class="n">orig_romcs1par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intel0addr</span><span class="p">,</span> <span class="n">intel0size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intel1addr</span><span class="p">,</span> <span class="n">intel1size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intelboot</span><span class="p">,</span> <span class="n">intel0cs</span><span class="p">,</span> <span class="n">intel1cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_intel_partitions</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nettel_mmcrp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="mh">0xfffef000</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNAPGEAR: failed to disable MMCR cache??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set CPU clock to be 33.000MHz */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc64</span><span class="p">))</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">amdpar</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc4</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
	<span class="n">intelboot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intel0cs</span> <span class="o">=</span> <span class="n">SC520_PAR_ROMCS1</span><span class="p">;</span>
	<span class="n">intel0par</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">intel1cs</span> <span class="o">=</span> <span class="n">SC520_PAR_ROMCS2</span><span class="p">;</span>
	<span class="n">intel1par</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xbc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Save the CS settings then ensure ROMCS1 and ROMCS2 are off,</span>
<span class="cm">	 *	otherwise they might clash with where we try to map BOOTCS.</span>
<span class="cm">	 */</span>
	<span class="n">orig_bootcspar</span> <span class="o">=</span> <span class="o">*</span><span class="n">amdpar</span><span class="p">;</span>
	<span class="n">orig_romcs1par</span> <span class="o">=</span> <span class="o">*</span><span class="n">intel0par</span><span class="p">;</span>
	<span class="o">*</span><span class="n">intel0par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">intel1par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 *	The first thing to do is determine if we have a separate</span>
<span class="cm">	 *	boot FLASH device. Typically this is a small (1 to 2MB)</span>
<span class="cm">	 *	AMD FLASH part. It seems that device size is about the</span>
<span class="cm">	 *	only way to tell if this is the case...</span>
<span class="cm">	 */</span>
	<span class="n">amdaddr</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="n">maxsize</span> <span class="o">=</span> <span class="n">AMD_WINDOW_MAXSIZE</span><span class="p">;</span>

	<span class="o">*</span><span class="n">amdpar</span> <span class="o">=</span> <span class="n">SC520_PAR</span><span class="p">(</span><span class="n">SC520_PAR_BOOTCS</span><span class="p">,</span> <span class="n">amdaddr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="p">(</span><span class="s">&quot;wbinvd&quot;</span><span class="p">);</span>

	<span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">phys</span> <span class="o">=</span> <span class="n">amdaddr</span><span class="p">;</span>
	<span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">amdaddr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNAPGEAR: failed to ioremap() BOOTCS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_mmcrp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">simple_map_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nettel_amd_map</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">amd_mtd</span> <span class="o">=</span> <span class="n">do_map_probe</span><span class="p">(</span><span class="s">&quot;jedec_probe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nettel_amd_map</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;SNAPGEAR: AMD flash device size = %dK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">amd_mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">));</span>

		<span class="n">amd_mtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

		<span class="cm">/* The high BIOS partition is only present for 2MB units */</span>
		<span class="n">num_amd_partitions</span> <span class="o">=</span> <span class="n">NUM_AMD_PARTITIONS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amd_mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">AMD_WINDOW_MAXSIZE</span><span class="p">)</span>
			<span class="n">num_amd_partitions</span><span class="o">--</span><span class="p">;</span>
		<span class="cm">/* Don&#39;t add the partition until after the primary INTEL&#39;s */</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Map the Intel flash into memory after the AMD</span>
<span class="cm">		 *	It has to start on a multiple of maxsize.</span>
<span class="cm">		 */</span>
		<span class="n">maxsize</span> <span class="o">=</span> <span class="n">SC520_PAR_TO_SIZE</span><span class="p">(</span><span class="n">orig_romcs1par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxsize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
			<span class="n">maxsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">intel0addr</span> <span class="o">=</span> <span class="n">amdaddr</span> <span class="o">+</span> <span class="n">maxsize</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
		<span class="cm">/* INTEL boot FLASH */</span>
		<span class="n">intelboot</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orig_romcs1par</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel0cs</span> <span class="o">=</span> <span class="n">SC520_PAR_BOOTCS</span><span class="p">;</span>
			<span class="n">intel0par</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc4</span><span class="p">);</span>
			<span class="n">intel1cs</span> <span class="o">=</span> <span class="n">SC520_PAR_ROMCS1</span><span class="p">;</span>
			<span class="n">intel1par</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc0</span><span class="p">);</span>

			<span class="n">intel0addr</span> <span class="o">=</span> <span class="n">SC520_PAR_TO_ADDR</span><span class="p">(</span><span class="n">orig_bootcspar</span><span class="p">);</span>
			<span class="n">maxsize</span> <span class="o">=</span> <span class="n">SC520_PAR_TO_SIZE</span><span class="p">(</span><span class="n">orig_bootcspar</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Kernel base is on ROMCS1, not BOOTCS */</span>
			<span class="n">intel0cs</span> <span class="o">=</span> <span class="n">SC520_PAR_ROMCS1</span><span class="p">;</span>
			<span class="n">intel0par</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc0</span><span class="p">);</span>
			<span class="n">intel1cs</span> <span class="o">=</span> <span class="n">SC520_PAR_BOOTCS</span><span class="p">;</span>
			<span class="n">intel1par</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">nettel_mmcrp</span> <span class="o">+</span> <span class="mh">0xc4</span><span class="p">);</span>

			<span class="n">intel0addr</span> <span class="o">=</span> <span class="n">SC520_PAR_TO_ADDR</span><span class="p">(</span><span class="n">orig_romcs1par</span><span class="p">);</span>
			<span class="n">maxsize</span> <span class="o">=</span> <span class="n">SC520_PAR_TO_SIZE</span><span class="p">(</span><span class="n">orig_romcs1par</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Destroy useless AMD MTD mapping */</span>
		<span class="n">amd_mtd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span><span class="p">);</span>
		<span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="cm">/* Only AMD flash supported */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
	<span class="cm">/*</span>
<span class="cm">	 *	We have determined the INTEL FLASH configuration, so lets</span>
<span class="cm">	 *	go ahead and probe for them now.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Set PAR to the maximum size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxsize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="n">maxsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="o">*</span><span class="n">intel0par</span> <span class="o">=</span> <span class="n">SC520_PAR</span><span class="p">(</span><span class="n">intel0cs</span><span class="p">,</span> <span class="n">intel0addr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>

	<span class="cm">/* Turn other PAR off so the first probe doesn&#39;t find it */</span>
	<span class="o">*</span><span class="n">intel1par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Probe for the size of the first Intel flash */</span>
	<span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">maxsize</span><span class="p">;</span>
	<span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">phys</span> <span class="o">=</span> <span class="n">intel0addr</span><span class="p">;</span>
	<span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">intel0addr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNAPGEAR: failed to ioremap() ROMCS1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">simple_map_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nettel_intel_map</span><span class="p">);</span>

	<span class="n">intel_mtd</span> <span class="o">=</span> <span class="n">do_map_probe</span><span class="p">(</span><span class="s">&quot;cfi_probe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nettel_intel_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set PAR to the detected size */</span>
	<span class="n">intel0size</span> <span class="o">=</span> <span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">intel0par</span> <span class="o">=</span> <span class="n">SC520_PAR</span><span class="p">(</span><span class="n">intel0cs</span><span class="p">,</span> <span class="n">intel0addr</span><span class="p">,</span> <span class="n">intel0size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Map second Intel FLASH right after first. Set its size to the</span>
<span class="cm">	 *	same maxsize used for the first Intel FLASH.</span>
<span class="cm">	 */</span>
	<span class="n">intel1addr</span> <span class="o">=</span> <span class="n">intel0addr</span> <span class="o">+</span> <span class="n">intel0size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">intel1par</span> <span class="o">=</span> <span class="n">SC520_PAR</span><span class="p">(</span><span class="n">intel1cs</span><span class="p">,</span> <span class="n">intel1addr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="p">(</span><span class="s">&quot;wbinvd&quot;</span><span class="p">);</span>

	<span class="n">maxsize</span> <span class="o">+=</span> <span class="n">intel0size</span><span class="p">;</span>

	<span class="cm">/* Delete the old map and probe again to do both chips */</span>
	<span class="n">map_destroy</span><span class="p">(</span><span class="n">intel_mtd</span><span class="p">);</span>
	<span class="n">intel_mtd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span><span class="p">);</span>

	<span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">maxsize</span><span class="p">;</span>
	<span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">intel0addr</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNAPGEAR: failed to ioremap() ROMCS1/2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_mtd</span> <span class="o">=</span> <span class="n">do_map_probe</span><span class="p">(</span><span class="s">&quot;cfi_probe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nettel_intel_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">intel_mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel1size</span> <span class="o">=</span> <span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">intel0size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel1size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">intel1par</span> <span class="o">=</span> <span class="n">SC520_PAR</span><span class="p">(</span><span class="n">intel1cs</span><span class="p">,</span> <span class="n">intel1addr</span><span class="p">,</span> <span class="n">intel1size</span><span class="p">);</span>
		<span class="n">__asm__</span> <span class="p">(</span><span class="s">&quot;wbinvd&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">intel1par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;SNAPGEAR: Intel flash device size = %lldKiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

	<span class="n">num_intel_partitions</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nettel_intel_partitions</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intelboot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Adjust offset and size of last boot partition.</span>
<span class="cm">		 *	Must allow for BIOS region at end of FLASH.</span>
<span class="cm">		 */</span>
		<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel0size</span> <span class="o">+</span> <span class="n">intel1size</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="o">+</span> <span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">);</span>
		<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">intel0size</span> <span class="o">+</span> <span class="n">intel1size</span><span class="p">;</span>
		<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">intel0size</span> <span class="o">+</span> <span class="n">intel1size</span><span class="p">)</span> <span class="o">-</span> <span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
		<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">intel_mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
		<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
			<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span>
			<span class="n">nettel_intel_partitions</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No BIOS regions when AMD boot */</span>
		<span class="n">num_intel_partitions</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mtd_device_register</span><span class="p">(</span><span class="n">intel_mtd</span><span class="p">,</span> <span class="n">nettel_intel_partitions</span><span class="p">,</span>
				 <span class="n">num_intel_partitions</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd_mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mtd_device_register</span><span class="p">(</span><span class="n">amd_mtd</span><span class="p">,</span> <span class="n">nettel_amd_partitions</span><span class="p">,</span>
					 <span class="n">num_amd_partitions</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nettel_notifier_block</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
<span class="nl">out_unmap1:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="nl">out_unmap2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_mmcrp</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span><span class="p">);</span>

	<span class="k">return</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nettel_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nettel_notifier_block</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amd_mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtd_device_unregister</span><span class="p">(</span><span class="n">amd_mtd</span><span class="p">);</span>
		<span class="n">map_destroy</span><span class="p">(</span><span class="n">amd_mtd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nettel_mmcrp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_mmcrp</span><span class="p">);</span>
		<span class="n">nettel_mmcrp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span><span class="p">);</span>
		<span class="n">nettel_amd_map</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_MTD_CFI_INTELEXT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtd_device_unregister</span><span class="p">(</span><span class="n">intel_mtd</span><span class="p">);</span>
		<span class="n">map_destroy</span><span class="p">(</span><span class="n">intel_mtd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span><span class="p">);</span>
		<span class="n">nettel_intel_map</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nettel_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nettel_cleanup</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Greg Ungerer &lt;gerg@snapgear.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SnapGear/SecureEdge FLASH support&quot;</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
