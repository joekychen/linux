<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › onenand › onenand_base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>onenand_base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/mtd/onenand/onenand_base.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright © 2005-2009 Samsung Electronics</span>
<span class="cm"> *  Copyright © 2007 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  Kyungmin Park &lt;kyungmin.park@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Credits:</span>
<span class="cm"> *	Adrian Hunter &lt;ext-adrian.hunter@nokia.com&gt;:</span>
<span class="cm"> *	auto-placement support, read-while load support, various fixes</span>
<span class="cm"> *</span>
<span class="cm"> *	Vishak G &lt;vishak.g at samsung.com&gt;, Rohit Hagargundgi &lt;h.rohit at samsung.com&gt;</span>
<span class="cm"> *	Flex-OneNAND support</span>
<span class="cm"> *	Amul Kumar Saha &lt;amul.saha at samsung.com&gt;</span>
<span class="cm"> *	OTP support</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/onenand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Multiblock erase if number of blocks to erase is 2 or more.</span>
<span class="cm"> * Maximum number of blocks for simultaneous erase is 64.</span>
<span class="cm"> */</span>
<span class="cp">#define MB_ERASE_MIN_BLK_COUNT 2</span>
<span class="cp">#define MB_ERASE_MAX_BLK_COUNT 64</span>

<span class="cm">/* Default Flex-OneNAND boundary and lock respectively */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flex_bdry</span><span class="p">[</span><span class="n">MAX_DIES</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">flex_bdry</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">flex_bdry</span><span class="p">,</span>	<span class="s">&quot;SLC Boundary information for Flex-OneNAND&quot;</span>
				<span class="s">&quot;Syntax:flex_bdry=DIE_BDRY,LOCK,...&quot;</span>
				<span class="s">&quot;DIE_BDRY: SLC boundary of the die&quot;</span>
				<span class="s">&quot;LOCK: Locking information for SLC boundary&quot;</span>
				<span class="s">&quot;    : 0-&gt;Set boundary in unlocked status&quot;</span>
				<span class="s">&quot;    : 1-&gt;Set boundary in locked status&quot;</span><span class="p">);</span>

<span class="cm">/* Default OneNAND/Flex-OneNAND OTP options*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">otp</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">otp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">otp</span><span class="p">,</span>	<span class="s">&quot;Corresponding behaviour of OneNAND in OTP&quot;</span>
			<span class="s">&quot;Syntax : otp=LOCK_TYPE&quot;</span>
			<span class="s">&quot;LOCK_TYPE : Keys issued, for specific OTP Lock type&quot;</span>
			<span class="s">&quot;	   : 0 -&gt; Default (No Blocks Locked)&quot;</span>
			<span class="s">&quot;	   : 1 -&gt; OTP Block lock&quot;</span>
			<span class="s">&quot;	   : 2 -&gt; 1st Block lock&quot;</span>
			<span class="s">&quot;	   : 3 -&gt; BOTH OTP Block and 1st Block lock&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * flexonenand_oob_128 - oob info for Flex-Onenand with 4KB page</span>
<span class="cm"> * For now, we expose only 64 out of 80 ecc bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">flexonenand_oob_128</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
		<span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
		<span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
		<span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
		<span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span>
		<span class="mi">86</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span>
		<span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span>
		<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">34</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">50</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">66</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">82</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">98</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">114</span><span class="p">,</span> <span class="mi">4</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * onenand_oob_128 - oob info for OneNAND with 4KB page</span>
<span class="cm"> *</span>
<span class="cm"> * Based on specification:</span>
<span class="cm"> * 4Gb M-die OneNAND Flash (KFM4G16Q4M, KFN8G16Q4M). Rev. 1.3, Apr. 2010</span>
<span class="cm"> *</span>
<span class="cm"> * For eccpos we expose only 64 bytes out of 72 (see struct nand_ecclayout)</span>
<span class="cm"> *</span>
<span class="cm"> * oobfree uses the spare area fields marked as</span>
<span class="cm"> * &quot;Managed by internal ECC logic for Logical Sector Number area&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">onenand_oob_128</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
		<span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
		<span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
		<span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
		<span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span>
		<span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span>
		<span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span>
		<span class="mi">119</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">18</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">34</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">50</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">66</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">82</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">98</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">114</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_oob_64 - oob info for large (2KB) page</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">onenand_oob_64</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
		<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
		<span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span>
		<span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">18</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">34</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">46</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">50</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">62</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_oob_32 - oob info for middle (1KB) page</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="n">onenand_oob_32</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">eccbytes</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eccpos</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
		<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">.</span><span class="n">oobfree</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">18</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ffchars</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 16 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 32 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 48 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 64 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 80 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 96 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 112 */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 128 */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_readw - [OneNAND Interface] Read OneNAND register</span>
<span class="cm"> * @param addr		address to read</span>
<span class="cm"> *</span>
<span class="cm"> * Read OneNAND register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">onenand_readw</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_writew - [OneNAND Interface] Write OneNAND register with value</span>
<span class="cm"> * @param value		value to write</span>
<span class="cm"> * @param addr		address to write</span>
<span class="cm"> *</span>
<span class="cm"> * Write OneNAND register with value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_writew</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_block_address - [DEFAULT] Get block address</span>
<span class="cm"> * @param this		onenand chip data structure</span>
<span class="cm"> * @param block		the block</span>
<span class="cm"> * @return		translated block address if DDP, otherwise same</span>
<span class="cm"> *</span>
<span class="cm"> * Setup Start Address 1 Register (F100h)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_block_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Device Flash Core select, NAND Flash Block Address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ONENAND_DDP_CHIP1</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span> <span class="o">^</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_bufferram_address - [DEFAULT] Get bufferram address</span>
<span class="cm"> * @param this		onenand chip data structure</span>
<span class="cm"> * @param block		the block</span>
<span class="cm"> * @return		set DBS value if DDP, otherwise 0</span>
<span class="cm"> *</span>
<span class="cm"> * Setup Start Address 2 Register (F101h) for DDP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_bufferram_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Device BufferRAM Select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ONENAND_DDP_CHIP1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ONENAND_DDP_CHIP0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_page_address - [DEFAULT] Get page address</span>
<span class="cm"> * @param page		the page address</span>
<span class="cm"> * @param sector	the sector address</span>
<span class="cm"> * @return		combined page and sector address</span>
<span class="cm"> *</span>
<span class="cm"> * Setup Start Address 8 Register (F107h)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_page_address</span><span class="p">(</span><span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Flash Page Address, Flash Sector Address */</span>
	<span class="kt">int</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">fsa</span><span class="p">;</span>

	<span class="n">fpa</span> <span class="o">=</span> <span class="n">page</span> <span class="o">&amp;</span> <span class="n">ONENAND_FPA_MASK</span><span class="p">;</span>
	<span class="n">fsa</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">&amp;</span> <span class="n">ONENAND_FSA_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">fpa</span> <span class="o">&lt;&lt;</span> <span class="n">ONENAND_FPA_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">fsa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_buffer_address - [DEFAULT] Get buffer address</span>
<span class="cm"> * @param dataram1	DataRAM index</span>
<span class="cm"> * @param sectors	the sector address</span>
<span class="cm"> * @param count		the number of sectors</span>
<span class="cm"> * @return		the start buffer value</span>
<span class="cm"> *</span>
<span class="cm"> * Setup Start Buffer Register (F200h)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_buffer_address</span><span class="p">(</span><span class="kt">int</span> <span class="n">dataram1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bsa</span><span class="p">,</span> <span class="n">bsc</span><span class="p">;</span>

	<span class="cm">/* BufferRAM Sector Address */</span>
	<span class="n">bsa</span> <span class="o">=</span> <span class="n">sectors</span> <span class="o">&amp;</span> <span class="n">ONENAND_BSA_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dataram1</span><span class="p">)</span>
		<span class="n">bsa</span> <span class="o">|=</span> <span class="n">ONENAND_BSA_DATARAM1</span><span class="p">;</span>	<span class="cm">/* DataRAM1 */</span>
	<span class="k">else</span>
		<span class="n">bsa</span> <span class="o">|=</span> <span class="n">ONENAND_BSA_DATARAM0</span><span class="p">;</span>	<span class="cm">/* DataRAM0 */</span>

	<span class="cm">/* BufferRAM Sector Count */</span>
	<span class="n">bsc</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="n">ONENAND_BSC_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">bsa</span> <span class="o">&lt;&lt;</span> <span class="n">ONENAND_BSA_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">bsc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flexonenand_block- For given address return block number</span>
<span class="cm"> * @param this         - OneNAND device structure</span>
<span class="cm"> * @param addr		- Address for which block number is needed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">flexonenand_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">die</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">die</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">boundary</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">];</span>

	<span class="n">blk</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&gt;</span> <span class="n">boundary</span><span class="p">)</span>
		<span class="n">blk</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">blk</span> <span class="o">+=</span> <span class="n">die</span> <span class="o">?</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">onenand_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flexonenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flexonenand_addr - Return address of the block</span>
<span class="cm"> * @this:		OneNAND device structure</span>
<span class="cm"> * @block:		Block number on Flex-OneNAND</span>
<span class="cm"> *</span>
<span class="cm"> * Return address of the block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">flexonenand_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">die</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boundary</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">block</span> <span class="o">&gt;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">-=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">;</span>
		<span class="n">die</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">boundary</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">];</span>
	<span class="n">ofs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)(</span><span class="n">block</span> <span class="o">-</span> <span class="n">boundary</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ofs</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">loff_t</span> <span class="nf">onenand_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flexonenand_addr</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">onenand_addr</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_get_density - [DEFAULT] Get OneNAND density</span>
<span class="cm"> * @param dev_id	OneNAND device ID</span>
<span class="cm"> *</span>
<span class="cm"> * Get OneNAND density from device ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">onenand_get_density</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">density</span> <span class="o">=</span> <span class="n">dev_id</span> <span class="o">&gt;&gt;</span> <span class="n">ONENAND_DEVICE_DENSITY_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">density</span> <span class="o">&amp;</span> <span class="n">ONENAND_DEVICE_DENSITY_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flexonenand_region - [Flex-OneNAND] Return erase region of addr</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param addr		address whose erase region needs to be identified</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">flexonenand_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexonenand_region</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_command - [DEFAULT] Send command to OneNAND device</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param cmd		the command to be sent</span>
<span class="cm"> * @param addr		offset to read from or write to</span>
<span class="cm"> * @param len		number of bytes to read or write</span>
<span class="cm"> *</span>
<span class="cm"> * Send command to OneNAND device. This function is used for middle/large page</span>
<span class="cm"> * devices (1KB/2KB Bytes per page)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>

	<span class="cm">/* Address translation */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ONENAND_CMD_UNLOCK</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_LOCK</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_LOCK_TIGHT</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_UNLOCK_ALL</span>:
		<span class="n">block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FLEXONENAND_CMD_PI_ACCESS</span>:
		<span class="cm">/* addr contains die index */</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ONENAND_CMD_ERASE</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_MULTIBLOCK_ERASE</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_ERASE_VERIFY</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_BUFFERRAM</span>:
	<span class="k">case</span> <span class="n">ONENAND_CMD_OTP_ACCESS</span>:
		<span class="n">block</span> <span class="o">=</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FLEXONENAND_CMD_READ_PI</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">ONENAND_CMD_READ</span><span class="p">;</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
			<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">onenand_addr</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">))</span><span class="o">&gt;&gt;</span>\
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Make the even block number */</span>
			<span class="n">block</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Is it the odd plane? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span>
				<span class="n">block</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">page</span> <span class="o">&amp;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE: The setting order of the registers is very important! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ONENAND_CMD_BUFFERRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Select DataRAM for DDP */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_bufferram_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">||</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
			<span class="cm">/* It is always BufferRAM0 */</span>
			<span class="n">ONENAND_SET_BUFFERRAM0</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* Switch to the next data buffer */</span>
			<span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write &#39;DFS, FBA&#39; of Flash */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_block_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS1</span><span class="p">);</span>

		<span class="cm">/* Select DataRAM for DDP */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_bufferram_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Now we use page size operation */</span>
		<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dataram</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLEXONENAND_CMD_RECOVER_LSB</span>:
		<span class="k">case</span> <span class="n">ONENAND_CMD_READ</span>:
		<span class="k">case</span> <span class="n">ONENAND_CMD_READOOB</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
				<span class="cm">/* It is always BufferRAM0 */</span>
				<span class="n">dataram</span> <span class="o">=</span> <span class="n">ONENAND_SET_BUFFERRAM0</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dataram</span> <span class="o">=</span> <span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">ONENAND_CMD_PROG</span><span class="p">)</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">ONENAND_CMD_2X_PROG</span><span class="p">;</span>
			<span class="n">dataram</span> <span class="o">=</span> <span class="n">ONENAND_CURRENT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Write &#39;FPA, FSA&#39; of Flash */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_page_address</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS8</span><span class="p">);</span>

		<span class="cm">/* Write &#39;BSA, BSC&#39; of DataRAM */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_buffer_address</span><span class="p">(</span><span class="n">dataram</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_BUFFER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Interrupt clear */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_INT_CLEAR</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>

	<span class="cm">/* Write command */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_COMMAND</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_ecc - return ecc status</span>
<span class="cm"> * @param this		onenand chip structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">onenand_read_ecc</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ecc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_ECC_STATUS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecc</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_ECC_STATUS</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ecc</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span> <span class="o">&amp;</span> <span class="n">FLEXONENAND_UNCORRECTABLE_ERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ONENAND_ECC_2BIT_ALL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">ONENAND_ECC_1BIT_ALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_wait - [DEFAULT] wait until the command is done</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param state		state to select the max. timeout value</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for command done. This applies to all OneNAND command</span>
<span class="cm"> * Read can take up to 30us, erase up to 2ms and program up to 350us</span>
<span class="cm"> * according to general OneNAND specs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span> <span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ONENAND_INT_MASTER</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* The 20 msec is enough */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">interrupt</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FL_READING</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">FL_PREPARING_ERASE</span><span class="p">)</span>
			<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* To get correct interrupt status in timeout case */</span>
	<span class="n">interrupt</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_CTRL_STATUS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the Spec. it checks the controller status first</span>
<span class="cm">	 * However if you get the correct information in case of</span>
<span class="cm">	 * power off recovery (POR) test, it should read ECC status first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">ONENAND_INT_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ecc</span> <span class="o">=</span> <span class="n">onenand_read_ecc</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span> <span class="o">&amp;</span> <span class="n">ONENAND_ECC_2BIT_ALL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ECC error = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ecc</span><span class="p">);</span>
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ecc</span> <span class="o">&amp;</span> <span class="n">ONENAND_ECC_1BIT_ALL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: correctable ECC error = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ecc</span><span class="p">);</span>
				<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_READING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: read timeout! ctrl=0x%04x intr=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_PREPARING_ERASE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">ONENAND_INT_ERASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: mb erase timeout! ctrl=0x%04x intr=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">ONENAND_INT_MASTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout! ctrl=0x%04x intr=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If there&#39;s controller error, it&#39;s a real error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ONENAND_CTRL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: controller error = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ONENAND_CTRL_LOCK</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: it&#39;s locked error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * onenand_interrupt - [DEFAULT] onenand interrupt handler</span>
<span class="cm"> * @param irq		onenand interrupt number</span>
<span class="cm"> * @param dev_id	interrupt data</span>
<span class="cm"> *</span>
<span class="cm"> * complete the work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">onenand_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* To handle shared interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">.</span><span class="n">done</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * onenand_interrupt_wait - [DEFAULT] wait until the command is done</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param state		state to select the max. timeout value</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for command done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_interrupt_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">onenand_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * onenand_try_interrupt_wait - [DEFAULT] try interrupt wait</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param state		state to select the max. timeout value</span>
<span class="cm"> *</span>
<span class="cm"> * Try interrupt based wait (It is used one-time)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_try_interrupt_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remain</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* We use interrupt wait first */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">onenand_interrupt_wait</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">remain</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OneNAND: There&#39;s no interrupt. &quot;</span>
				<span class="s">&quot;We use the normal wait</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Release the irq */</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">onenand_wait</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">onenand_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * onenand_setup_wait - [OneNAND Interface] setup onenand wait method</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * There&#39;s two method to wait onenand work</span>
<span class="cm"> * 1. polling - read interrupt status register</span>
<span class="cm"> * 2. interrupt - use the kernel interrupt method</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_setup_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">syscfg</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">onenand_wait</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">onenand_interrupt</span><span class="p">,</span>
				<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;onenand&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we can&#39;t get irq, use the normal wait */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">onenand_wait</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable interrupt */</span>
	<span class="n">syscfg</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>
	<span class="n">syscfg</span> <span class="o">|=</span> <span class="n">ONENAND_SYS_CFG1_IOBE</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">syscfg</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">onenand_try_interrupt_wait</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_bufferram_offset - [DEFAULT] BufferRAM offset</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param area		BufferRAM area</span>
<span class="cm"> * @return		offset given area</span>
<span class="cm"> *</span>
<span class="cm"> * Return BufferRAM offset given area</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">onenand_bufferram_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_CURRENT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Note: the &#39;this-&gt;writesize&#39; is a real page size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="o">==</span> <span class="n">ONENAND_DATARAM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="o">==</span> <span class="n">ONENAND_SPARERAM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_bufferram - [OneNAND Interface] Read the bufferram area</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param area		BufferRAM area</span>
<span class="cm"> * @param buffer	the databuffer to put/get data</span>
<span class="cm"> * @param offset	offset to read from or write to</span>
<span class="cm"> * @param count		number of bytes to read/write</span>
<span class="cm"> *</span>
<span class="cm"> * Read the BufferRAM area</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read_bufferram</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">area</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bufferram</span><span class="p">;</span>

	<span class="n">bufferram</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">area</span><span class="p">;</span>

	<span class="n">bufferram</span> <span class="o">+=</span> <span class="n">onenand_bufferram_offset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_CHECK_BYTE_ACCESS</span><span class="p">(</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">word</span><span class="p">;</span>

		<span class="cm">/* Align with word(16-bit) size */</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Read word and save byte */</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">bufferram</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufferram</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_sync_read_bufferram - [OneNAND Interface] Read the bufferram area with Sync. Burst mode</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param area		BufferRAM area</span>
<span class="cm"> * @param buffer	the databuffer to put/get data</span>
<span class="cm"> * @param offset	offset to read from or write to</span>
<span class="cm"> * @param count		number of bytes to read/write</span>
<span class="cm"> *</span>
<span class="cm"> * Read the BufferRAM area with Sync. Burst Mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_sync_read_bufferram</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">area</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bufferram</span><span class="p">;</span>

	<span class="n">bufferram</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">area</span><span class="p">;</span>

	<span class="n">bufferram</span> <span class="o">+=</span> <span class="n">onenand_bufferram_offset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mmcontrol</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SYS_CFG1_SYNC_READ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_CHECK_BYTE_ACCESS</span><span class="p">(</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">word</span><span class="p">;</span>

		<span class="cm">/* Align with word(16-bit) size */</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Read word and save byte */</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">bufferram</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufferram</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mmcontrol</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_write_bufferram - [OneNAND Interface] Write the bufferram area</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param area		BufferRAM area</span>
<span class="cm"> * @param buffer	the databuffer to put/get data</span>
<span class="cm"> * @param offset	offset to read from or write to</span>
<span class="cm"> * @param count		number of bytes to read/write</span>
<span class="cm"> *</span>
<span class="cm"> * Write the BufferRAM area</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_write_bufferram</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">area</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bufferram</span><span class="p">;</span>

	<span class="n">bufferram</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">area</span><span class="p">;</span>

	<span class="n">bufferram</span> <span class="o">+=</span> <span class="n">onenand_bufferram_offset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_CHECK_BYTE_ACCESS</span><span class="p">(</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">word</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">byte_offset</span><span class="p">;</span>

		<span class="cm">/* Align with word(16-bit) size */</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Calculate byte access offset */</span>
		<span class="n">byte_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

		<span class="cm">/* Read word and save byte */</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">bufferram</span> <span class="o">+</span> <span class="n">byte_offset</span><span class="p">);</span>
		<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">bufferram</span> <span class="o">+</span> <span class="n">byte_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">bufferram</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_get_2x_blockpage - [GENERIC] Get blockpage at 2x program mode</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param addr		address to check</span>
<span class="cm"> * @return		blockpage address</span>
<span class="cm"> *</span>
<span class="cm"> * Get blockpage address at 2x program mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_get_2x_blockpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blockpage</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>

	<span class="cm">/* Calculate the even block number */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Is it the odd plane? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span>
		<span class="n">block</span><span class="o">++</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_mask</span><span class="p">;</span>
	<span class="n">blockpage</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">blockpage</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_check_bufferram - [GENERIC] Check BufferRAM information</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param addr		address to check</span>
<span class="cm"> * @return		1 if there are valid data, otherwise 0</span>
<span class="cm"> *</span>
<span class="cm"> * Check bufferram if there is data we required</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_check_bufferram</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blockpage</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">blockpage</span> <span class="o">=</span> <span class="n">onenand_get_2x_blockpage</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">blockpage</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

	<span class="cm">/* Is there valid data? */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ONENAND_CURRENT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">==</span> <span class="n">blockpage</span><span class="p">)</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Check another BufferRAM */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">ONENAND_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">==</span> <span class="n">blockpage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Select DataRAM for DDP */</span>
		<span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">onenand_bufferram_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_update_bufferram - [GENERIC] Update BufferRAM information</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param addr		address to update</span>
<span class="cm"> * @param valid		valid flag</span>
<span class="cm"> *</span>
<span class="cm"> * Update BufferRAM information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_update_bufferram</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blockpage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">blockpage</span> <span class="o">=</span> <span class="n">onenand_get_2x_blockpage</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">blockpage</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

	<span class="cm">/* Invalidate another BufferRAM */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ONENAND_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">==</span> <span class="n">blockpage</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Update BufferRAM */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ONENAND_CURRENT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">=</span> <span class="n">blockpage</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_invalidate_bufferram - [GENERIC] Invalidate BufferRAM information</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> * @param addr		start address to invalidate</span>
<span class="cm"> * @param len		length to invalidate</span>
<span class="cm"> *</span>
<span class="cm"> * Invalidate BufferRAM information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_invalidate_bufferram</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">end_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Invalidate BufferRAM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUFFERRAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">buf_addr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf_addr</span> <span class="o">&gt;=</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">buf_addr</span> <span class="o">&lt;</span> <span class="n">end_addr</span><span class="p">)</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blockpage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_get_device - [GENERIC] Get chip for selected access</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param new_state	the state which is requested</span>
<span class="cm"> *</span>
<span class="cm"> * Get the device and lock it for exclusive access</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_get_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab the lock and see if the device is available</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">FL_PM_SUSPENDED</span> <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_release_device - [GENERIC] release chip</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Deselect, release chip lock and wake up anyone waiting on the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_release_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FL_PM_SUSPENDED</span> <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="cm">/* Release the chip */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FL_READY</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_transfer_auto_oob - [INTERN] oob auto-placement transfer</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param buf		destination address</span>
<span class="cm"> * @param column	oob offset to read from</span>
<span class="cm"> * @param thislen	oob length to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_transfer_auto_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">column</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">thislen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_oobfree</span> <span class="o">*</span><span class="n">free</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readcol</span> <span class="o">=</span> <span class="n">column</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readend</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lastgap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">oob_buf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">;</span>

	<span class="n">free</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MTD_MAX_OOBFREE_ENTRIES</span> <span class="o">&amp;&amp;</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">free</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readcol</span> <span class="o">&gt;=</span> <span class="n">lastgap</span><span class="p">)</span>
			<span class="n">readcol</span> <span class="o">+=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">lastgap</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readend</span> <span class="o">&gt;=</span> <span class="n">lastgap</span><span class="p">)</span>
			<span class="n">readend</span> <span class="o">+=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">lastgap</span><span class="p">;</span>
		<span class="n">lastgap</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">oob_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="n">free</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MTD_MAX_OOBFREE_ENTRIES</span> <span class="o">&amp;&amp;</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">free</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">free_end</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">readend</span> <span class="o">&amp;&amp;</span> <span class="n">free_end</span> <span class="o">&gt;</span> <span class="n">readcol</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">st</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span><span class="n">readcol</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">free_end</span><span class="p">,</span><span class="n">readend</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">oob_buf</span> <span class="o">+</span> <span class="n">st</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_recover_lsb - [Flex-OneNAND] Recover LSB page data</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param addr		address to recover</span>
<span class="cm"> * @param status	return value from onenand_wait / onenand_bbt_wait</span>
<span class="cm"> *</span>
<span class="cm"> * MLC NAND Flash cell has paired pages - LSB page and MSB page. LSB page has</span>
<span class="cm"> * lower page address and MSB page has higher page address in paired pages.</span>
<span class="cm"> * If power off occurs during MSB page program, the paired LSB page data can</span>
<span class="cm"> * become corrupt. LSB page recovery read is a way to read LSB page though page</span>
<span class="cm"> * data are corrupted. When uncorrectable error occurs as a result of LSB page</span>
<span class="cm"> * read after power up, issue LSB page recovery read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_recover_lsb</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Recovery is only for Flex-OneNAND */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* check if we failed due to uncorrectable error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">ONENAND_BBT_READ_ECC_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* check if address lies in MLC region */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">flexonenand_region</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* We are attempting to reread, so decrement stats.failed</span>
<span class="cm">	 * which was incremented by onenand_wait due to read failure</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Attempting to recover from uncorrectable read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">);</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Issue the LSB page recovery command */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FLEXONENAND_CMD_RECOVER_LSB</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_mlc_read_ops_nolock - MLC OneNAND read main and/or out-of-band</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		offset to read from</span>
<span class="cm"> * @param ops:		oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * MLC OneNAND / Flex-OneNAND has 4KB page size and 4KB dataram.</span>
<span class="cm"> * So, read-while-load is not present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_mlc_read_ops_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_ecc_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ooblen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oobread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writesize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: from = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">from</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">oobcolumn</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempt read beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">writesize</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">read</span><span class="p">);</span>

		<span class="n">column</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="n">thislen</span> <span class="o">&gt;</span> <span class="n">writesize</span><span class="p">)</span>
			<span class="n">thislen</span> <span class="o">=</span> <span class="n">writesize</span> <span class="o">-</span> <span class="n">column</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onenand_check_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_READ</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">writesize</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_recover_lsb</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_DATARAM</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oobbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thisooblen</span> <span class="o">=</span> <span class="n">oobsize</span> <span class="o">-</span> <span class="n">oobcolumn</span><span class="p">;</span>
			<span class="n">thisooblen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">,</span> <span class="n">ooblen</span> <span class="o">-</span> <span class="n">oobread</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
				<span class="n">onenand_transfer_auto_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">);</span>
			<span class="n">oobread</span> <span class="o">+=</span> <span class="n">thisooblen</span><span class="p">;</span>
			<span class="n">oobbuf</span> <span class="o">+=</span> <span class="n">thisooblen</span><span class="p">;</span>
			<span class="n">oobcolumn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">read</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">from</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return success, if no ECC failures, else -EBADMSG</span>
<span class="cm">	 * fs driver will take care of that, because</span>
<span class="cm">	 * retlen == desired len and result == -EBADMSG</span>
<span class="cm">	 */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">oobread</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* return max bitflips per ecc step; ONENANDs correct 1 bit only */</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">!=</span> <span class="n">stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_ops_nolock - [OneNAND Interface] OneNAND read main and/or out-of-band</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		offset to read from</span>
<span class="cm"> * @param ops:		oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * OneNAND read main and/or out-of-band data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read_ops_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_ecc_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ooblen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oobread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boundary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writesize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: from = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">from</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">oobcolumn</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">from</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempt read beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">;</span>

 	<span class="cm">/* Read-while-load method */</span>

 	<span class="cm">/* Do first load to bufferRAM */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
 		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onenand_check_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_READ</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">writesize</span><span class="p">);</span>
 			<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
 			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 		<span class="p">}</span>
 	<span class="p">}</span>

	<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">writesize</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">read</span><span class="p">);</span>
	<span class="n">column</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="n">thislen</span> <span class="o">&gt;</span> <span class="n">writesize</span><span class="p">)</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">writesize</span> <span class="o">-</span> <span class="n">column</span><span class="p">;</span>

 	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
 		<span class="cm">/* If there is more to load then start next load */</span>
 		<span class="n">from</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">+</span> <span class="n">thislen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_READ</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">writesize</span><span class="p">);</span>
 			<span class="cm">/*</span>
<span class="cm"> 			 * Chip boundary handling in DDP</span>
<span class="cm"> 			 * Now we issued chip 1 read and pointed chip 1</span>
<span class="cm">			 * bufferram so we have to point chip 0 bufferram.</span>
<span class="cm"> 			 */</span>
 			<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
 			    <span class="n">unlikely</span><span class="p">(</span><span class="n">from</span> <span class="o">==</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
 				<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_DDP_CHIP0</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
 				<span class="n">boundary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 			<span class="p">}</span> <span class="k">else</span>
 				<span class="n">boundary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 			<span class="n">ONENAND_SET_PREV_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
 		<span class="p">}</span>
 		<span class="cm">/* While load is going, read from last bufferRAM */</span>
 		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_DATARAM</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>

		<span class="cm">/* Read oob area if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oobbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thisooblen</span> <span class="o">=</span> <span class="n">oobsize</span> <span class="o">-</span> <span class="n">oobcolumn</span><span class="p">;</span>
			<span class="n">thisooblen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">,</span> <span class="n">ooblen</span> <span class="o">-</span> <span class="n">oobread</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
				<span class="n">onenand_transfer_auto_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">);</span>
			<span class="n">oobread</span> <span class="o">+=</span> <span class="n">thisooblen</span><span class="p">;</span>
			<span class="n">oobbuf</span> <span class="o">+=</span> <span class="n">thisooblen</span><span class="p">;</span>
			<span class="n">oobcolumn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

 		<span class="cm">/* See if we are done */</span>
 		<span class="n">read</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
 			<span class="k">break</span><span class="p">;</span>
 		<span class="cm">/* Set up for next read from bufferRAM */</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">boundary</span><span class="p">))</span>
 			<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_DDP_CHIP1</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
 		<span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
 		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">writesize</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">read</span><span class="p">);</span>
 		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 		<span class="n">cond_resched</span><span class="p">();</span>
 		<span class="cm">/* Now wait for load */</span>
 		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
 		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return success, if no ECC failures, else -EBADMSG</span>
<span class="cm">	 * fs driver will take care of that, because</span>
<span class="cm">	 * retlen == desired len and result == -EBADMSG</span>
<span class="cm">	 */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">oobread</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* return max bitflips per ecc step; ONENANDs correct 1 bit only */</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">!=</span> <span class="n">stats</span><span class="p">.</span><span class="n">corrected</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_oob_nolock - [MTD Interface] OneNAND read out-of-band</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		offset to read from</span>
<span class="cm"> * @param ops:		oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * OneNAND read out-of-band data from the spare area</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read_oob_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_ecc_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">;</span>

	<span class="n">from</span> <span class="o">+=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: from = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">from</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Initialize return length value */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">oobsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempted to start read outside oob</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">from</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span>
		     <span class="n">column</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">-</span>
				     <span class="p">(</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="o">*</span> <span class="n">oobsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempted to read beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">;</span>

	<span class="n">readcmd</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">ONENAND_CMD_READ</span> <span class="o">:</span> <span class="n">ONENAND_CMD_READOOB</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">thislen</span> <span class="o">=</span> <span class="n">oobsize</span> <span class="o">-</span> <span class="n">column</span><span class="p">;</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_recover_lsb</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mtd_is_eccerr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: read failed = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
			<span class="n">onenand_transfer_auto_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>

		<span class="n">read</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="cm">/* Read more? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Page size */</span>
			<span class="n">from</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
			<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_stats</span><span class="p">.</span><span class="n">failed</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read - [MTD Interface] Read data from flash</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		offset to read from</span>
<span class="cm"> * @param len		number of bytes to read</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of read bytes</span>
<span class="cm"> * @param buf		the databuffer to put data</span>
<span class="cm"> *</span>
<span class="cm"> * Read with ecc</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="n">len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooblen</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">datbuf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oobbuf</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">onenand_mlc_read_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">onenand_read_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_oob - [MTD Interface] Read main and/or out-of-band</span>
<span class="cm"> * @param mtd:		MTD device structure</span>
<span class="cm"> * @param from:		offset to read from</span>
<span class="cm"> * @param ops:		oob operation description structure</span>

<span class="cm"> * Read main and/or out-of-band</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTD_OPS_PLACE_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_AUTO_OOB</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_OPS_RAW</span>:
		<span class="cm">/* Not implemented yet */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">onenand_mlc_read_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">onenand_read_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_read_oob_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_bbt_wait - [DEFAULT] wait until the command is done</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param state		state to select the max. timeout value</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for command done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_bbt_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interrupt</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">ecc</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr8</span><span class="p">;</span>

	<span class="cm">/* The 20 msec is enough */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">interrupt</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">ONENAND_INT_MASTER</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* To get correct interrupt status in timeout case */</span>
	<span class="n">interrupt</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_CTRL_STATUS</span><span class="p">);</span>
	<span class="n">addr1</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS1</span><span class="p">);</span>
	<span class="n">addr8</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">ONENAND_INT_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecc</span> <span class="o">=</span> <span class="n">onenand_read_ecc</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span> <span class="o">&amp;</span> <span class="n">ONENAND_ECC_2BIT_ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ecc 0x%04x ctrl 0x%04x &quot;</span>
			       <span class="s">&quot;intr 0x%04x addr1 %#x addr8 %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">ecc</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr8</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ONENAND_BBT_READ_ECC_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: read timeout! ctrl 0x%04x &quot;</span>
		       <span class="s">&quot;intr 0x%04x addr1 %#x addr8 %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr8</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ONENAND_BBT_READ_FATAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initial bad block case: 0x2400 or 0x0400 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">ONENAND_CTRL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ctrl 0x%04x intr 0x%04x addr1 %#x &quot;</span>
		       <span class="s">&quot;addr8 %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr8</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ONENAND_BBT_READ_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_bbt_read_oob - [MTD Interface] OneNAND read out-of-band for bbt scan</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		offset to read from</span>
<span class="cm"> * @param ops		oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * OneNAND read out-of-band data from the spare area for bbt scan</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">onenand_bbt_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> 
			    <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">column</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: from = 0x%08x, len = %zi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">from</span><span class="p">,</span>
			<span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Initialize return value */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">from</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempt read beyond end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ONENAND_BBT_READ_FATAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Grab the lock and see if the device is available */</span>
	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">readcmd</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">ONENAND_CMD_READ</span> <span class="o">:</span> <span class="n">ONENAND_CMD_READOOB</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">thislen</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="n">column</span><span class="p">;</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_recover_lsb</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
		<span class="n">read</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="cm">/* Read more? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Update Page size */</span>
			<span class="n">from</span> <span class="o">+=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
			<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Deselect and wake up anyone waiting on the device */</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MTD_ONENAND_VERIFY_WRITE</span>
<span class="cm">/**</span>
<span class="cm"> * onenand_verify_oob - [GENERIC] verify the oob contents after a write</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param buf		the databuffer to verify</span>
<span class="cm"> * @param to		offset to read from</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_verify_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">oob_buf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">;</span>

	<span class="n">readcmd</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">ONENAND_CMD_READ</span> <span class="o">:</span> <span class="n">ONENAND_CMD_READOOB</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">readcmd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">oob_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">oob_buf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_verify - [GENERIC] verify the chip contents after a write</span>
<span class="cm"> * @param mtd          MTD device structure</span>
<span class="cm"> * @param buf          the databuffer to verify</span>
<span class="cm"> * @param addr         offset to read from</span>
<span class="cm"> * @param len          number of bytes to read and compare</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">column</span><span class="p">;</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="n">column</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_READ</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_DATARAM</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">verify_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">verify_buf</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define onenand_verify(...)		(0)</span>
<span class="cp">#define onenand_verify_oob(...)		(0)</span>
<span class="cp">#endif</span>

<span class="cp">#define NOTALIGNED(x)	((x &amp; (this-&gt;subpagesize - 1)) != 0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_panic_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interrupt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">interrupt</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interrupt</span> <span class="o">&amp;</span> <span class="n">ONENAND_INT_MASTER</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_panic_write - [MTD Interface] write buffer to FLASH in a panic context</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param to		offset to write to</span>
<span class="cm"> * @param len		number of bytes to write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of written bytes</span>
<span class="cm"> * @param buf		the data to write</span>
<span class="cm"> *</span>
<span class="cm"> * Write with ECC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_panic_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="n">subpage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Wait for any existing operation to clear */</span>
	<span class="n">onenand_panic_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: to = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">to</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Reject writes, which are not page aligned */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">NOTALIGNED</span><span class="p">(</span><span class="n">to</span><span class="p">)</span> <span class="o">||</span> <span class="n">NOTALIGNED</span><span class="p">(</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempt to write not page aligned data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Loop until all data write */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="n">column</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">written</span><span class="p">);</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">wbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_BUFFERRAM</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>

		<span class="cm">/* Partial page write */</span>
		<span class="n">subpage</span> <span class="o">=</span> <span class="n">thislen</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subpage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
			<span class="n">wbuf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_DATARAM</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">ffchars</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_PROG</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

		<span class="n">onenand_panic_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

		<span class="cm">/* In partial page write we don&#39;t update bufferram */</span>
		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">subpage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ONENAND_SET_BUFFERRAM1</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span> <span class="o">+</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">subpage</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: write failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">written</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">to</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">written</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_fill_auto_oob - [INTERN] oob auto-placement transfer</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param oob_buf	oob buffer</span>
<span class="cm"> * @param buf		source address</span>
<span class="cm"> * @param column	oob offset to write to</span>
<span class="cm"> * @param thislen	oob length to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_fill_auto_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">oob_buf</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="kt">int</span> <span class="n">thislen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nand_oobfree</span> <span class="o">*</span><span class="n">free</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writecol</span> <span class="o">=</span> <span class="n">column</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writeend</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lastgap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">free</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MTD_MAX_OOBFREE_ENTRIES</span> <span class="o">&amp;&amp;</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">free</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">writecol</span> <span class="o">&gt;=</span> <span class="n">lastgap</span><span class="p">)</span>
			<span class="n">writecol</span> <span class="o">+=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">lastgap</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">writeend</span> <span class="o">&gt;=</span> <span class="n">lastgap</span><span class="p">)</span>
			<span class="n">writeend</span> <span class="o">+=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">lastgap</span><span class="p">;</span>
		<span class="n">lastgap</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MTD_MAX_OOBFREE_ENTRIES</span> <span class="o">&amp;&amp;</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">free</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">free_end</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">writeend</span> <span class="o">&amp;&amp;</span> <span class="n">free_end</span> <span class="o">&gt;</span> <span class="n">writecol</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">st</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span><span class="n">writecol</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">free_end</span><span class="p">,</span><span class="n">writeend</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">oob_buf</span> <span class="o">+</span> <span class="n">st</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_write_ops_nolock - [OneNAND Interface] write main and/or out-of-band</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param to		offset to write to</span>
<span class="cm"> * @param ops		oob operation description structure</span>
<span class="cm"> *</span>
<span class="cm"> * Write main and/or oob with ECC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_write_ops_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">subpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prevlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev_subpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oobwritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ooblen</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">oob</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: to = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">to</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Initialize retlen, in case of early exit */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reject writes, which are not page aligned */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">NOTALIGNED</span><span class="p">(</span><span class="n">to</span><span class="p">)</span> <span class="o">||</span> <span class="n">NOTALIGNED</span><span class="p">(</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempt to write not page aligned data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="cm">/* Check zero length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">oobcolumn</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Loop until all data write */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_char</span> <span class="o">*</span><span class="n">wbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

			<span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="n">column</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">written</span><span class="p">);</span>
			<span class="n">thisooblen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">oobsize</span> <span class="o">-</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">ooblen</span> <span class="o">-</span> <span class="n">oobwritten</span><span class="p">);</span>

			<span class="n">cond_resched</span><span class="p">();</span>

			<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_BUFFERRAM</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>

			<span class="cm">/* Partial page write */</span>
			<span class="n">subpage</span> <span class="o">=</span> <span class="n">thislen</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">subpage</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
				<span class="n">wbuf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_DATARAM</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">oob</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">oobbuf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">;</span>

				<span class="cm">/* We send data to spare ram with oobsize</span>
<span class="cm">				 * to prevent byte access */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">oobbuf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
					<span class="n">onenand_fill_auto_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">oobbuf</span> <span class="o">+</span> <span class="n">oobcolumn</span><span class="p">,</span> <span class="n">oob</span><span class="p">,</span> <span class="n">thisooblen</span><span class="p">);</span>

				<span class="n">oobwritten</span> <span class="o">+=</span> <span class="n">thisooblen</span><span class="p">;</span>
				<span class="n">oob</span> <span class="o">+=</span> <span class="n">thisooblen</span><span class="p">;</span>
				<span class="n">oobcolumn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">oobbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ffchars</span><span class="p">;</span>

			<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * 2 PLANE, MLC, and Flex-OneNAND do not support</span>
<span class="cm">		 * write-while-program feature.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ONENAND_SET_PREV_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>

			<span class="cm">/* In partial page write we don&#39;t update bufferram */</span>
			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">prev_subpage</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">written</span> <span class="o">-=</span> <span class="n">prevlen</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: write failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Only check verify write turn on */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_verify</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="n">to</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: verify failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">ongoing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">ONENAND_CMD_PROG</span><span class="p">;</span>

		<span class="cm">/* Exclude 1st OTP and OTP blocks for cache program feature */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_CACHE_PROGRAM</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">likely</span><span class="p">(</span><span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">written</span> <span class="o">+</span> <span class="n">thislen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">ONENAND_CMD_2X_CACHE_PROG</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">ongoing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * 2 PLANE, MLC, and Flex-OneNAND wait here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">||</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>

			<span class="cm">/* In partial page write we don&#39;t update bufferram */</span>
			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">subpage</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: write failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Only check verify write turn on */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_verify</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: verify failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">written</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">written</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>

		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prev_subpage</span> <span class="o">=</span> <span class="n">subpage</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
		<span class="n">prevlen</span> <span class="o">=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">to</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In error case, clear all bufferrams */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">onenand_invalidate_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">written</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">oobwritten</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * onenand_write_oob_nolock - [INTERN] OneNAND write out-of-band</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param to		offset to write to</span>
<span class="cm"> * @param len		number of bytes to write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of written bytes</span>
<span class="cm"> * @param buf		the data to write</span>
<span class="cm"> * @param mode		operation mode</span>
<span class="cm"> *</span>
<span class="cm"> * OneNAND write out-of-band</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_write_oob_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oobcmd</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">to</span> <span class="o">+=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: to = 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">to</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Initialize retlen, in case of early exit */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">oobsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempted to start write outside oob</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For compatibility with NAND: Do not allow write past end of page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">oobsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempt to write past end of page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not allow reads past end of device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">to</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span>
		     <span class="n">column</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">)</span> <span class="o">-</span>
				     <span class="p">(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="o">*</span> <span class="n">oobsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Attempted to write past end of device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">oobbuf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">;</span>

	<span class="n">oobcmd</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">ONENAND_CMD_PROG</span> <span class="o">:</span> <span class="n">ONENAND_CMD_PROGOOB</span><span class="p">;</span>

	<span class="cm">/* Loop until all data write */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">written</span><span class="p">);</span>

		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_BUFFERRAM</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="cm">/* We send data to spare ram with oobsize</span>
<span class="cm">		 * to prevent byte access */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">oobbuf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">)</span>
			<span class="n">onenand_fill_auto_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">oobbuf</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Set main area of DataRAM to 0xff*/</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_DATARAM</span><span class="p">,</span>
					 <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oobcmd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ONENAND_SET_BUFFERRAM1</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span> <span class="o">+</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: write failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_verify_oob</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">oobbuf</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: verify failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">written</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">to</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">written</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_write - [MTD Interface] write buffer to FLASH</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param to		offset to write to</span>
<span class="cm"> * @param len		number of bytes to write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of written bytes</span>
<span class="cm"> * @param buf		the data to write</span>
<span class="cm"> *</span>
<span class="cm"> * Write with ECC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="n">len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooblen</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">datbuf</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oobbuf</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_write_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_write_oob - [MTD Interface] NAND write data and/or out-of-band</span>
<span class="cm"> * @param mtd:		MTD device structure</span>
<span class="cm"> * @param to:		offset to write</span>
<span class="cm"> * @param ops:		oob operation description structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTD_OPS_PLACE_OOB</span>:
	<span class="k">case</span> <span class="n">MTD_OPS_AUTO_OOB</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_OPS_RAW</span>:
		<span class="cm">/* Not implemented yet */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">datbuf</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_write_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_write_oob_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_block_isbad_nolock - [GENERIC] Check if a block is marked bad</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset from device start</span>
<span class="cm"> * @param allowbbt	1, if its allowed to access the bbt area</span>
<span class="cm"> *</span>
<span class="cm"> * Check, if the block is bad. Either by reading the bad block table or</span>
<span class="cm"> * calling of the scan function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_block_isbad_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allowbbt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bbm_info</span> <span class="o">*</span><span class="n">bbm</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbm</span><span class="p">;</span>

	<span class="cm">/* Return info from the table */</span>
	<span class="k">return</span> <span class="n">bbm</span><span class="o">-&gt;</span><span class="n">isbad_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">allowbbt</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_multiblock_erase_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_ERASE_VERIFY</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_VERIFYING_ERASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed verify, block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_multiblock_erase - [INTERN] erase block(s) using multiblock erase</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param instr		erase instruction</span>
<span class="cm"> * @param region	erase region</span>
<span class="cm"> *</span>
<span class="cm"> * Erase one or more blocks up to 64 block at a time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_multiblock_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bdry_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">bdry_addr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">bdry_addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bdry_addr</span><span class="p">)</span>
			<span class="n">bdry_block</span> <span class="o">=</span> <span class="n">bdry_addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pre-check bbs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if we have a bad block, we do not erase bad blocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onenand_block_isbad_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: attempt to erase a bad block &quot;</span>
			       <span class="s">&quot;at addr 0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* loop over 64 eb batches */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">erase_info</span> <span class="n">verify_instr</span> <span class="o">=</span> <span class="o">*</span><span class="n">instr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_eb_count</span> <span class="o">=</span> <span class="n">MB_ERASE_MAX_BLK_COUNT</span><span class="p">;</span>

		<span class="n">verify_instr</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">verify_instr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* do not cross chip boundary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdry_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">this_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">this_block</span> <span class="o">&lt;</span> <span class="n">bdry_block</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max_eb_count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_eb_count</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">bdry_block</span> <span class="o">-</span> <span class="n">this_block</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">eb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">block_size</span> <span class="o">&amp;&amp;</span> <span class="n">eb_count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">max_eb_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_MULTIBLOCK_ERASE</span><span class="p">,</span>
				      <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
			<span class="n">onenand_invalidate_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_PREPARING_ERASE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed multiblock erase, &quot;</span>
				       <span class="s">&quot;block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>
				<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
				<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span> <span class="n">MTD_FAIL_ADDR_UNKNOWN</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">len</span> <span class="o">-=</span> <span class="n">block_size</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">block_size</span><span class="p">;</span>
			<span class="n">eb_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* last block of 64-eb series */</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_ERASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
		<span class="n">onenand_invalidate_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_ERASING</span><span class="p">);</span>
		<span class="cm">/* Check if it is write protected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed erase, block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span> <span class="n">MTD_FAIL_ADDR_UNKNOWN</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">eb_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* verify */</span>
		<span class="n">verify_instr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">eb_count</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onenand_multiblock_erase_verify</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verify_instr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">verify_instr</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span> <span class="n">verify_instr</span><span class="p">.</span><span class="n">fail_addr</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * onenand_block_by_block_erase - [INTERN] erase block(s) using regular erase</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param instr		erase instruction</span>
<span class="cm"> * @param region	erase region</span>
<span class="cm"> * @param block_size	erase block size</span>
<span class="cm"> *</span>
<span class="cm"> * Erase one or more blocks one block at a time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_block_by_block_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mtd_erase_region_info</span> <span class="o">*</span><span class="n">region</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">region_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* region is set for Flex-OneNAND */</span>
		<span class="n">region_end</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">*</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">numblocks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASING</span><span class="p">;</span>

	<span class="cm">/* Loop through the blocks */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="cm">/* Check if we have a bad block, we do not erase bad blocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onenand_block_isbad_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: attempt to erase a bad block &quot;</span>
					<span class="s">&quot;at addr 0x%012llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_ERASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

		<span class="n">onenand_invalidate_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_ERASING</span><span class="p">);</span>
		<span class="cm">/* Check, if it is write protected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed erase, block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">block_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">region</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">==</span> <span class="n">region_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">region</span><span class="o">++</span><span class="p">;</span>

			<span class="n">block_size</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
			<span class="n">region_end</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">*</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">numblocks</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* FIXME: This should be handled at MTD partitioning level. */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unaligned address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_erase - [MTD Interface] erase block(s)</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param instr		erase instruction</span>
<span class="cm"> *</span>
<span class="cm"> * Erase one or more blocks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_erase_region_info</span> <span class="o">*</span><span class="n">region</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">region_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: start=0x%012llx, len=%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Find the eraseregion of this address */</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">flexonenand_region</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="n">region</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">block_size</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>

		<span class="cm">/* Start address within region must align on block boundary.</span>
<span class="cm">		 * Erase region&#39;s start offset is always block start address.</span>
<span class="cm">		 */</span>
		<span class="n">region_offset</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">block_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>

	<span class="cm">/* Start address must align on block boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">addr</span> <span class="o">-</span> <span class="n">region_offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unaligned address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Length must align on block boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Length not block aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Grab the lock and see if the device is available */</span>
	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_ERASING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">||</span> <span class="n">region</span> <span class="o">||</span>
	    <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">MB_ERASE_MIN_BLK_COUNT</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* region is set for Flex-OneNAND (no mb erase) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_block_by_block_erase</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span>
						   <span class="n">region</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_multiblock_erase</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Deselect and wake up anyone waiting on the device */</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="cm">/* Do call back function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_DONE</span><span class="p">;</span>
		<span class="n">mtd_erase_callback</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_sync - [MTD Interface] sync</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Sync is actually a wait for chip ready function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Grab the lock and see if the device is available */</span>
	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_SYNCING</span><span class="p">);</span>

	<span class="cm">/* Release it and go back */</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_block_isbad - [MTD Interface] Check whether the block at the given offset is bad</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset relative to mtd start</span>
<span class="cm"> *</span>
<span class="cm"> * Check whether the block is bad</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_block_isbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check for invalid offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_block_isbad_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_default_block_markbad - [DEFAULT] mark a block bad</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset from device start</span>
<span class="cm"> *</span>
<span class="cm"> * This is the default implementation, which can be overridden by</span>
<span class="cm"> * a hardware specific driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_default_block_markbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bbm_info</span> <span class="o">*</span><span class="n">bbm</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbm</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">;</span>

	<span class="cm">/* Get block number */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bbm</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">)</span>
                <span class="n">bbm</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">[</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* We write two bytes, so we don&#39;t have to mess with 16-bit access */</span>
        <span class="n">ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">+</span> <span class="p">(</span><span class="n">bbm</span><span class="o">-&gt;</span><span class="n">badblockpos</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
	<span class="cm">/* FIXME : What to do when marking SLC block in partition</span>
<span class="cm">	 * 	   with MLC erasesize? For now, it is not advisable to</span>
<span class="cm">	 *	   create partitions containing both SLC and MLC regions.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">onenand_write_oob_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_block_markbad - [MTD Interface] Mark the block at the given offset as bad</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset relative to mtd start</span>
<span class="cm"> *</span>
<span class="cm"> * Mark the block as bad</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_block_markbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_block_isbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If it was bad already, return success and do nothing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_block_markbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_do_lock_cmd - [OneNAND Interface] Lock or unlock block(s)</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset relative to mtd start</span>
<span class="cm"> * @param len		number of bytes to lock or unlock</span>
<span class="cm"> * @param cmd		lock or unlock command</span>
<span class="cm"> *</span>
<span class="cm"> * Lock or unlock one or more blocks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_do_lock_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wp_status_mask</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">onenand_block</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ONENAND_CMD_LOCK</span><span class="p">)</span>
		<span class="n">wp_status_mask</span> <span class="o">=</span> <span class="n">ONENAND_WP_LS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wp_status_mask</span> <span class="o">=</span> <span class="n">ONENAND_WP_US</span><span class="p">;</span>

	<span class="cm">/* Continuous lock scheme */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_CONT_LOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set start block address */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_BLOCK_ADDRESS</span><span class="p">);</span>
		<span class="cm">/* Set end block address */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>  <span class="n">ONENAND_REG_END_BLOCK_ADDRESS</span><span class="p">);</span>
		<span class="cm">/* Write lock command */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* There&#39;s no return value */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_LOCKING</span><span class="p">);</span>

		<span class="cm">/* Sanity check */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_CTRL_STATUS</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="n">ONENAND_CTRL_ONGO</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Check lock status */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_WP_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">wp_status_mask</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: wp status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Block lock scheme */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set block address */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_block_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS1</span><span class="p">);</span>
		<span class="cm">/* Select DataRAM for DDP */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_bufferram_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
		<span class="cm">/* Set start block address */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_BLOCK_ADDRESS</span><span class="p">);</span>
		<span class="cm">/* Write lock command */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* There&#39;s no return value */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_LOCKING</span><span class="p">);</span>

		<span class="cm">/* Sanity check */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_CTRL_STATUS</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="n">ONENAND_CTRL_ONGO</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Check lock status */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_WP_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">wp_status_mask</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: block = %d, wp status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_lock - [MTD Interface] Lock block(s)</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset relative to mtd start</span>
<span class="cm"> * @param len		number of bytes to unlock</span>
<span class="cm"> *</span>
<span class="cm"> * Lock one or more blocks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_LOCKING</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_do_lock_cmd</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ONENAND_CMD_LOCK</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_unlock - [MTD Interface] Unlock block(s)</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param ofs		offset relative to mtd start</span>
<span class="cm"> * @param len		number of bytes to unlock</span>
<span class="cm"> *</span>
<span class="cm"> * Unlock one or more blocks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_LOCKING</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_do_lock_cmd</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ONENAND_CMD_UNLOCK</span><span class="p">);</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_check_lock_status - [OneNAND Interface] Check lock status</span>
<span class="cm"> * @param this		onenand chip data structure</span>
<span class="cm"> *</span>
<span class="cm"> * Check lock status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_check_lock_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set block address */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_block_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS1</span><span class="p">);</span>
		<span class="cm">/* Select DataRAM for DDP */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_bufferram_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
		<span class="cm">/* Set start block address */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_BLOCK_ADDRESS</span><span class="p">);</span>

		<span class="cm">/* Check lock status */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_WP_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ONENAND_WP_US</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: block = %d, wp status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_unlock_all - [OneNAND Interface] unlock all blocks</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Unlock all blocks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_unlock_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_UNLOCK_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set start block address */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_BLOCK_ADDRESS</span><span class="p">);</span>
		<span class="cm">/* Write unlock command */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_UNLOCK_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* There&#39;s no return value */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_LOCKING</span><span class="p">);</span>

		<span class="cm">/* Sanity check */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_CTRL_STATUS</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="n">ONENAND_CTRL_ONGO</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t check lock status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_SKIP_UNLOCK_CHECK</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* Check lock status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onenand_check_lock_status</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* Workaround for all block unlock in DDP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* All blocks on another chip */</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">onenand_do_lock_cmd</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ONENAND_CMD_UNLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MTD_ONENAND_OTP</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_otp_command - Send OTP specific command to OneNAND device</span>
<span class="cm"> * @param mtd	 MTD device structure</span>
<span class="cm"> * @param cmd	 the command to be sent</span>
<span class="cm"> * @param addr	 offset to read from or write to</span>
<span class="cm"> * @param len	 number of bytes to read or write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_otp_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>

	<span class="cm">/* Address translation */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ONENAND_CMD_OTP_ACCESS</span>:
		<span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Make the even block number */</span>
			<span class="n">block</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Is it the odd plane? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span>
				<span class="n">block</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">page</span> <span class="o">&amp;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write &#39;DFS, FBA&#39; of Flash */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_block_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
				<span class="n">ONENAND_REG_START_ADDRESS1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Now we use page size operation */</span>
		<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dataram</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">ONENAND_CMD_PROG</span><span class="p">)</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">ONENAND_CMD_2X_PROG</span><span class="p">;</span>
			<span class="n">dataram</span> <span class="o">=</span> <span class="n">ONENAND_CURRENT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Write &#39;FPA, FSA&#39; of Flash */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_page_address</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
				<span class="n">ONENAND_REG_START_ADDRESS8</span><span class="p">);</span>

		<span class="cm">/* Write &#39;BSA, BSC&#39; of DataRAM */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_buffer_address</span><span class="p">(</span><span class="n">dataram</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_START_BUFFER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Interrupt clear */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_INT_CLEAR</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_INTERRUPT</span><span class="p">);</span>

	<span class="cm">/* Write command */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_COMMAND</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_otp_write_oob_nolock - [INTERN] OneNAND write out-of-band, specific to OTP</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param to		offset to write to</span>
<span class="cm"> * @param len		number of bytes to write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of written bytes</span>
<span class="cm"> * @param buf		the data to write</span>
<span class="cm"> *</span>
<span class="cm"> * OneNAND write out-of-band only for OTP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_otp_write_oob_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooblen</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">to</span> <span class="o">+=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>

	<span class="cm">/* Initialize retlen, in case of early exit */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span>

	<span class="n">column</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">oobbuf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">;</span>

	<span class="cm">/* Loop until all data write */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">thislen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">oobsize</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">written</span><span class="p">);</span>

		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Write &#39;DFS, FBA&#39; of Flash</span>
<span class="cm">		 * Add: F100h DQ=DFS, FBA</span>
<span class="cm">		 */</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_block_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
				<span class="n">ONENAND_REG_START_ADDRESS1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Select DataRAM for DDP</span>
<span class="cm">		 * Add: F101h DQ=DBS</span>
<span class="cm">		 */</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">onenand_bufferram_address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
				<span class="n">ONENAND_REG_START_ADDRESS2</span><span class="p">);</span>
		<span class="n">ONENAND_SET_NEXT_BUFFERRAM</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Enter OTP access mode</span>
<span class="cm">		 */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_OTP_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_OTPING</span><span class="p">);</span>

		<span class="cm">/* We send data to spare ram with oobsize</span>
<span class="cm">		 * to prevent byte access */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">oobbuf</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Write Data into DataRAM</span>
<span class="cm">		 * Add: 8th Word</span>
<span class="cm">		 * in sector0/spare/page0</span>
<span class="cm">		 * DQ=XXFCh</span>
<span class="cm">		 */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_SPARERAM</span><span class="p">,</span>
					<span class="n">oobbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

		<span class="n">onenand_otp_command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_PROGOOB</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
		<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ONENAND_SET_BUFFERRAM1</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="n">onenand_update_bufferram</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span> <span class="o">+</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: write failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Exit OTP access mode */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_CTRL_STATUS</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="mh">0x60</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">BLOCK</span><span class="se">\t</span><span class="s">STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;1st Block</span><span class="se">\t</span><span class="s">LOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;OTP Block</span><span class="se">\t</span><span class="s">LOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">BLOCK</span><span class="se">\t</span><span class="s">STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;1st Block</span><span class="se">\t</span><span class="s">LOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;OTP Block</span><span class="se">\t</span><span class="s">UN-LOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">BLOCK</span><span class="se">\t</span><span class="s">STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;1st Block</span><span class="se">\t</span><span class="s">UN-LOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;OTP Block</span><span class="se">\t</span><span class="s">LOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reboot to check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">written</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">to</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="n">written</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Internal OTP operation */</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">otp_op_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">form</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * do_otp_read - [DEFAULT] Read OTP block area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to read</span>
<span class="cm"> * @param len		number of bytes to read</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of readbytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> *</span>
<span class="cm"> * Read OTP block area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_otp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="n">len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooblen</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">datbuf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oobbuf</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Enter OTP access mode */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_OTP_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_OTPING</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">onenand_mlc_read_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">onenand_read_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>

	<span class="cm">/* Exit OTP access mode */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_otp_write - [DEFAULT] Write OTP block area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param to		The offset to write</span>
<span class="cm"> * @param len		number of bytes to write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of write bytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> *</span>
<span class="cm"> * Write OTP block area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_otp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="cm">/* Force buffer page aligned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enter OTP access mode */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_OTP_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_OTPING</span><span class="p">);</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_write_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>

	<span class="cm">/* Exit OTP access mode */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_otp_lock - [DEFAULT] Lock OTP block area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to lock</span>
<span class="cm"> * @param len		number of bytes to lock</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of lock bytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> *</span>
<span class="cm"> * Lock OTP block area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_otp_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Enter OTP access mode */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_OTP_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_OTPING</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * For Flex-OneNAND, we write lock mark to 1st word of sector 4 of</span>
<span class="cm">		 * main area of page 49.</span>
<span class="cm">		 */</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_write_ops_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">*</span> <span class="mi">49</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
		<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span><span class="p">;</span>

		<span class="cm">/* Exit OTP access mode */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_otp_write_oob_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
		<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_otp_walk - [DEFAULT] Handle OTP operation</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to read/write</span>
<span class="cm"> * @param len		number of bytes to read/write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of read bytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> * @param action	do given action</span>
<span class="cm"> * @param mode		specify user and factory</span>
<span class="cm"> *</span>
<span class="cm"> * Handle OTP operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_otp_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="n">otp_op_t</span> <span class="n">action</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">otp_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">density</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">density</span> <span class="o">=</span> <span class="n">onenand_get_density</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">density</span> <span class="o">&lt;</span> <span class="n">ONENAND_DEVICE_DENSITY_512Mb</span><span class="p">)</span>
		<span class="n">otp_pages</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">otp_pages</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OTP_FACTORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">from</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">*</span> <span class="n">otp_pages</span><span class="p">;</span>
		<span class="n">otp_pages</span> <span class="o">=</span> <span class="n">ONENAND_PAGES_PER_BLOCK</span> <span class="o">-</span> <span class="n">otp_pages</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check User/Factory boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MTD_OTP_USER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">*</span> <span class="n">otp_pages</span> <span class="o">&lt;</span> <span class="n">from</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">*</span> <span class="n">otp_pages</span> <span class="o">&lt;</span>  <span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_OTPING</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">otp_pages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* OTP Info functions */</span>
			<span class="k">struct</span> <span class="n">otp_info</span> <span class="o">*</span><span class="n">otpinfo</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">otp_info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">otpinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">otp_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">otpinfo</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
			<span class="n">otpinfo</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
			<span class="n">otpinfo</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">from</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">otp_info</span><span class="p">);</span>
			<span class="o">*</span><span class="n">retlen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">otp_info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">tmp_retlen</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

			<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp_retlen</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">tmp_retlen</span><span class="p">;</span>
			<span class="o">*</span><span class="n">retlen</span> <span class="o">+=</span> <span class="n">tmp_retlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">otp_pages</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_get_fact_prot_info - [MTD Interface] Read factory OTP info</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> * @param len		number of bytes to read</span>
<span class="cm"> *</span>
<span class="cm"> * Read factory OTP info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_get_fact_prot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">otp_info</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_otp_walk</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MTD_OTP_FACTORY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">:</span> <span class="n">retlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_fact_prot_reg - [MTD Interface] Read factory OTP area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to read</span>
<span class="cm"> * @param len		number of bytes to read</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of read bytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> *</span>
<span class="cm"> * Read factory OTP area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read_fact_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">onenand_otp_walk</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">do_otp_read</span><span class="p">,</span> <span class="n">MTD_OTP_FACTORY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_get_user_prot_info - [MTD Interface] Read user OTP info</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> * @param len		number of bytes to read</span>
<span class="cm"> *</span>
<span class="cm"> * Read user OTP info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_get_user_prot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">otp_info</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_otp_walk</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MTD_OTP_USER</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">:</span> <span class="n">retlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_read_user_prot_reg - [MTD Interface] Read user OTP area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to read</span>
<span class="cm"> * @param len		number of bytes to read</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of read bytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> *</span>
<span class="cm"> * Read user OTP area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_read_user_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">onenand_otp_walk</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">do_otp_read</span><span class="p">,</span> <span class="n">MTD_OTP_USER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_write_user_prot_reg - [MTD Interface] Write user OTP area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to write</span>
<span class="cm"> * @param len		number of bytes to write</span>
<span class="cm"> * @param retlen	pointer to variable to store the number of write bytes</span>
<span class="cm"> * @param buf		the databuffer to put/get data</span>
<span class="cm"> *</span>
<span class="cm"> * Write user OTP area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_write_user_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">onenand_otp_walk</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">do_otp_write</span><span class="p">,</span> <span class="n">MTD_OTP_USER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_lock_user_prot_reg - [MTD Interface] Lock user OTP area</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param from		The offset to lock</span>
<span class="cm"> * @param len		number of bytes to unlock</span>
<span class="cm"> *</span>
<span class="cm"> * Write lock mark on spare area in page 0 in OTP block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_lock_user_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span> <span class="o">:</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">otp_lock_offset</span> <span class="o">=</span> <span class="n">ONENAND_OTP_LOCK_OFFSET</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span>
						 <span class="o">:</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Write lock mark to 8th word of sector0 of page0 of the spare0.</span>
<span class="cm">	 * We write 16 bytes spare area instead of 2 bytes.</span>
<span class="cm">	 * For Flex-OneNAND, we write lock mark to 1st word of sector 4 of</span>
<span class="cm">	 * main area of page 49.</span>
<span class="cm">	 */</span>

	<span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: OTP lock operation</span>
<span class="cm">	 *       OTP block : 0xXXFC			XX 1111 1100</span>
<span class="cm">	 *       1st block : 0xXXF3 (If chip support)	XX 1111 0011</span>
<span class="cm">	 *       Both      : 0xXXF0 (If chip support)	XX 1111 0000</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">otp_lock_offset</span> <span class="o">=</span> <span class="n">FLEXONENAND_OTP_LOCK_OFFSET</span><span class="p">;</span>

	<span class="cm">/* ONENAND_OTP_AREA | ONENAND_OTP_BLOCK0 | ONENAND_OTP_AREA_BLOCK0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">otp_lock_offset</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">otp_lock_offset</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">otp_lock_offset</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;[OneNAND] Invalid option selected for OTP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_otp_walk</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">do_otp_lock</span><span class="p">,</span> <span class="n">MTD_OTP_USER</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">:</span> <span class="n">retlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_MTD_ONENAND_OTP */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * onenand_check_features - Check and set OneNAND features</span>
<span class="cm"> * @param mtd		MTD data structure</span>
<span class="cm"> *</span>
<span class="cm"> * Check and set OneNAND features</span>
<span class="cm"> * - lock scheme</span>
<span class="cm"> * - two plane</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_check_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">density</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">numbufs</span><span class="p">;</span>

	<span class="cm">/* Lock scheme depends on density and process */</span>
	<span class="n">density</span> <span class="o">=</span> <span class="n">onenand_get_density</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">process</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">version_id</span> <span class="o">&gt;&gt;</span> <span class="n">ONENAND_VERSION_PROCESS_SHIFT</span><span class="p">;</span>
	<span class="n">numbufs</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_NUM_BUFFERS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Lock scheme */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">density</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ONENAND_DEVICE_DENSITY_4Gb</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_2PLANE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">numbufs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_4KB_PAGE</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_CACHE_PROGRAM</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * There are two different 4KiB pagesize chips</span>
<span class="cm">			 * and no way to detect it by H/W config values.</span>
<span class="cm">			 *</span>
<span class="cm">			 * To detect the correct NOP for each chips,</span>
<span class="cm">			 * It should check the version ID as workaround.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Now it has as following</span>
<span class="cm">			 * KFM4G16Q4M has NOP 4 with version ID 0x0131</span>
<span class="cm">			 * KFM4G16Q5M has NOP 1 with versoin ID 0x013e</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">version_id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe</span><span class="p">)</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_NOP_1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">ONENAND_DEVICE_DENSITY_2Gb</span>:
		<span class="cm">/* 2Gb DDP does not have 2 plane */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_2PLANE</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_UNLOCK_ALL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ONENAND_DEVICE_DENSITY_1Gb</span>:
		<span class="cm">/* A-Die has all block unlock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">process</span><span class="p">)</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_UNLOCK_ALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Some OneNAND has continuous lock scheme */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">process</span><span class="p">)</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_CONT_LOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The MLC has 4KiB pagesize. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_MLC</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_4KB_PAGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ONENAND_HAS_2PLANE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ONENAND_HAS_CONT_LOCK</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_HAS_UNLOCK_ALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_CONT_LOCK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Lock scheme is Continuous Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_UNLOCK_ALL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Chip support all block unlock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_2PLANE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Chip has 2 plane</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_4KB_PAGE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Chip has 4KiB pagesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_HAS_CACHE_PROGRAM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Chip has cache program feature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_print_device_info - Print device &amp; version ID</span>
<span class="cm"> * @param device        device ID</span>
<span class="cm"> * @param version	version ID</span>
<span class="cm"> *</span>
<span class="cm"> * Print device &amp; version ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_print_device_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">demuxed</span><span class="p">,</span> <span class="n">ddp</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">flexonenand</span><span class="p">;</span>

        <span class="n">vcc</span> <span class="o">=</span> <span class="n">device</span> <span class="o">&amp;</span> <span class="n">ONENAND_DEVICE_VCC_MASK</span><span class="p">;</span>
        <span class="n">demuxed</span> <span class="o">=</span> <span class="n">device</span> <span class="o">&amp;</span> <span class="n">ONENAND_DEVICE_IS_DEMUX</span><span class="p">;</span>
        <span class="n">ddp</span> <span class="o">=</span> <span class="n">device</span> <span class="o">&amp;</span> <span class="n">ONENAND_DEVICE_IS_DDP</span><span class="p">;</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">onenand_get_density</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">flexonenand</span> <span class="o">=</span> <span class="n">device</span> <span class="o">&amp;</span> <span class="n">DEVICE_IS_FLEXONENAND</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%sOneNAND%s %dMB %sV 16-bit (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">demuxed</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;Muxed &quot;</span><span class="p">,</span>
		<span class="n">flexonenand</span> <span class="o">?</span> <span class="s">&quot;Flex-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                <span class="n">ddp</span> <span class="o">?</span> <span class="s">&quot;(DDP)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">density</span><span class="p">),</span>
                <span class="n">vcc</span> <span class="o">?</span> <span class="s">&quot;2.65/3.3&quot;</span> <span class="o">:</span> <span class="s">&quot;1.8&quot;</span><span class="p">,</span>
                <span class="n">device</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OneNAND version = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">onenand_manufacturers</span> <span class="n">onenand_manuf_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">ONENAND_MFR_SAMSUNG</span><span class="p">,</span> <span class="s">&quot;Samsung&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ONENAND_MFR_NUMONYX</span><span class="p">,</span> <span class="s">&quot;Numonyx&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_check_maf - Check manufacturer ID</span>
<span class="cm"> * @param manuf         manufacturer ID</span>
<span class="cm"> *</span>
<span class="cm"> * Check manufacturer ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_check_maf</span><span class="p">(</span><span class="kt">int</span> <span class="n">manuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">onenand_manuf_ids</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">manuf</span> <span class="o">==</span> <span class="n">onenand_manuf_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">onenand_manuf_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;OneNAND Manufacturer: %s (0x%0x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">manuf</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* flexonenand_get_boundary	- Reads the SLC boundary</span>
<span class="cm">* @param onenand_info		- onenand info structure</span>
<span class="cm">**/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexonenand_get_boundary</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">die</span><span class="p">,</span> <span class="n">bdry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">syscfg</span><span class="p">,</span> <span class="n">locked</span><span class="p">;</span>

	<span class="cm">/* Disable ECC */</span>
	<span class="n">syscfg</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">((</span><span class="n">syscfg</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="p">),</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">die</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">die</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span><span class="p">;</span> <span class="n">die</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FLEXONENAND_CMD_PI_ACCESS</span><span class="p">,</span> <span class="n">die</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_SYNCING</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FLEXONENAND_CMD_READ_PI</span><span class="p">,</span> <span class="n">die</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>

		<span class="n">bdry</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_DATARAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bdry</span> <span class="o">&gt;&gt;</span> <span class="n">FLEXONENAND_PI_UNLOCK_SHIFT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">=</span> <span class="n">bdry</span> <span class="o">&amp;</span> <span class="n">FLEXONENAND_PI_MASK</span><span class="p">;</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Die %d boundary: %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">die</span><span class="p">,</span>
		       <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">],</span> <span class="n">locked</span> <span class="o">?</span> <span class="s">&quot;(Locked)&quot;</span> <span class="o">:</span> <span class="s">&quot;(Unlocked)&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable ECC */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">syscfg</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flexonenand_get_size - Fill up fields in onenand_chip and mtd_info</span>
<span class="cm"> * 			  boundary[], diesize[], mtd-&gt;size, mtd-&gt;erasesize</span>
<span class="cm"> * @param mtd		- MTD device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flexonenand_get_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">die</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eraseshift</span><span class="p">,</span> <span class="n">density</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blksperdie</span><span class="p">,</span> <span class="n">maxbdry</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">ofs</span><span class="p">;</span>

	<span class="n">density</span> <span class="o">=</span> <span class="n">onenand_get_density</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">blksperdie</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">density</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">);</span>
	<span class="n">blksperdie</span> <span class="o">&gt;&gt;=</span> <span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">maxbdry</span> <span class="o">=</span> <span class="n">blksperdie</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">eraseshift</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* This fills up the device boundary */</span>
	<span class="n">flexonenand_get_boundary</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="n">die</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">die</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span><span class="p">;</span> <span class="n">die</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">die</span> <span class="o">||</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">maxbdry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">eraseshift</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span> <span class="o">=</span>
							<span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span> <span class="o">&lt;&lt;</span> <span class="n">eraseshift</span><span class="p">;</span>
			<span class="n">eraseshift</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span> <span class="o">+=</span>
							<span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">eraseshift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">!=</span> <span class="n">maxbdry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">eraseshift</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span> <span class="o">=</span> <span class="n">maxbdry</span> <span class="o">^</span>
							 <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">];</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span> <span class="o">&lt;&lt;</span> <span class="n">eraseshift</span><span class="p">;</span>
			<span class="n">eraseshift</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Expose MLC erase size except when all blocks are SLC */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Device has %d eraseregions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;[offset: 0x%08x, erasesize: 0x%05x,&quot;</span>
			<span class="s">&quot; numblocks: %04u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span><span class="p">,</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">die</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">die</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span><span class="p">;</span> <span class="n">die</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">blksperdie</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
						 <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="n">die</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flexonenand_check_blocks_erased - Check if blocks are erased</span>
<span class="cm"> * @param mtd_info	- mtd info structure</span>
<span class="cm"> * @param start		- first erase block to check</span>
<span class="cm"> * @param end		- last erase block to check</span>
<span class="cm"> *</span>
<span class="cm"> * Converting an unerased block from MLC to SLC</span>
<span class="cm"> * causes byte values to change. Since both data and its ECC</span>
<span class="cm"> * have changed, reads on the block give uncorrectable error.</span>
<span class="cm"> * This might lead to the block being detected as bad.</span>
<span class="cm"> *</span>
<span class="cm"> * Avoid this by ensuring that the block to be converted is</span>
<span class="cm"> * erased.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexonenand_check_blocks_erased</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ooblen</span>	<span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">datbuf</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oobbuf</span>	<span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">loff_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Check blocks from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">flexonenand_addr</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onenand_block_isbad_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Since main area write results in ECC write to spare,</span>
<span class="cm">		 * it is sufficient to check only ECC bytes for change.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">onenand_read_oob_nolock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Block %d not erased.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flexonenand_set_boundary	- Writes the SLC boundary</span>
<span class="cm"> * @param mtd			- mtd info structure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">flexonenand_set_boundary</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">die</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">boundary</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">blksperdie</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">thisboundary</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Change only once for SDP Flex-OneNAND */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">die</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* boundary value of -1 indicates no required change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">boundary</span> <span class="o">==</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">density</span> <span class="o">=</span> <span class="n">onenand_get_density</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">blksperdie</span> <span class="o">=</span> <span class="p">((</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">density</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span><span class="p">;</span>
	<span class="n">blksperdie</span> <span class="o">&gt;&gt;=</span> <span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">&gt;=</span> <span class="n">blksperdie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid boundary value. &quot;</span>
				<span class="s">&quot;Boundary not changed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if converting blocks are erased */</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">boundary</span><span class="p">[</span><span class="n">die</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">die</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">boundary</span> <span class="o">+</span> <span class="p">(</span><span class="n">die</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">flexonenand_check_blocks_erased</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Please erase blocks &quot;</span>
				<span class="s">&quot;before boundary change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FLEXONENAND_CMD_PI_ACCESS</span><span class="p">,</span> <span class="n">die</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_SYNCING</span><span class="p">);</span>

	<span class="cm">/* Check is boundary is locked */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FLEXONENAND_CMD_READ_PI</span><span class="p">,</span> <span class="n">die</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_READING</span><span class="p">);</span>

	<span class="n">thisboundary</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_DATARAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">thisboundary</span> <span class="o">&gt;&gt;</span> <span class="n">FLEXONENAND_PI_UNLOCK_SHIFT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: boundary locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Changing die %d boundary: %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">die</span><span class="p">,</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">lock</span> <span class="o">?</span> <span class="s">&quot;(Locked)&quot;</span> <span class="o">:</span> <span class="s">&quot;(Unlocked)&quot;</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">die</span> <span class="o">?</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">diesize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">boundary</span> <span class="o">&amp;=</span> <span class="n">FLEXONENAND_PI_MASK</span><span class="p">;</span>
	<span class="n">boundary</span> <span class="o">|=</span> <span class="n">lock</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">FLEXONENAND_PI_UNLOCK_SHIFT</span><span class="p">);</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_ERASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_ERASING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed PI erase for Die %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">die</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">boundary</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_DATARAM</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ONENAND_CMD_PROG</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed PI write for Die %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">die</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FLEXONENAND_CMD_PI_UPDATE</span><span class="p">,</span> <span class="n">die</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_WRITING</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_COMMAND</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="cm">/* Recalculate device size on boundary change*/</span>
		<span class="n">flexonenand_get_size</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_chip_probe - [OneNAND Interface] The generic chip probe</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> *</span>
<span class="cm"> * OneNAND detection method:</span>
<span class="cm"> *   Compare the values from command with ones from register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_chip_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bram_maf_id</span><span class="p">,</span> <span class="n">bram_dev_id</span><span class="p">,</span> <span class="n">maf_id</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">syscfg</span><span class="p">;</span>

	<span class="cm">/* Save system configuration 1 */</span>
	<span class="n">syscfg</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>
	<span class="cm">/* Clear Sync. Burst Read mode to read BootRAM */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">((</span><span class="n">syscfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ONENAND_SYS_CFG1_SYNC_READ</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ONENAND_SYS_CFG1_SYNC_WRITE</span><span class="p">),</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>

	<span class="cm">/* Send the command for reading device ID from BootRAM */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_CMD_READID</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_BOOTRAM</span><span class="p">);</span>

	<span class="cm">/* Read manufacturer and device IDs from BootRAM */</span>
	<span class="n">bram_maf_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_BOOTRAM</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">bram_dev_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_BOOTRAM</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="cm">/* Reset OneNAND to read default register values */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">ONENAND_CMD_RESET</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_BOOTRAM</span><span class="p">);</span>
	<span class="cm">/* Wait reset */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_RESETING</span><span class="p">);</span>

	<span class="cm">/* Restore system configuration 1 */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">(</span><span class="n">syscfg</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_SYS_CFG1</span><span class="p">);</span>

	<span class="cm">/* Check manufacturer ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onenand_check_maf</span><span class="p">(</span><span class="n">bram_maf_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Read manufacturer and device IDs from Register */</span>
	<span class="n">maf_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_MANUFACTURER_ID</span><span class="p">);</span>
	<span class="n">dev_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_DEVICE_ID</span><span class="p">);</span>

	<span class="cm">/* Check OneNAND device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maf_id</span> <span class="o">!=</span> <span class="n">bram_maf_id</span> <span class="o">||</span> <span class="n">dev_id</span> <span class="o">!=</span> <span class="n">bram_dev_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_probe - [OneNAND Interface] Probe the OneNAND device</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maf_id</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">ver_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">density</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_probe</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read manufacturer and device IDs from Register */</span>
	<span class="n">maf_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_MANUFACTURER_ID</span><span class="p">);</span>
	<span class="n">dev_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_DEVICE_ID</span><span class="p">);</span>
	<span class="n">ver_id</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_VERSION_ID</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">technology</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_TECHNOLOGY</span><span class="p">);</span>

	<span class="cm">/* Flash device information */</span>
	<span class="n">onenand_print_device_info</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">ver_id</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">version_id</span> <span class="o">=</span> <span class="n">ver_id</span><span class="p">;</span>

	<span class="cm">/* Check OneNAND features */</span>
	<span class="n">onenand_check_features</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">density</span> <span class="o">=</span> <span class="n">onenand_get_density</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span> <span class="o">=</span> <span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Maximum possible erase regions */</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_erase_region_info</span><span class="p">)</span>
					<span class="o">*</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">dies</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For Flex-OneNAND, chipsize represents maximum possible device size.</span>
<span class="cm">	 * mtd-&gt;size represents the actual device size.</span>
<span class="cm">	 */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">density</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="cm">/* OneNAND page size &amp; block size */</span>
	<span class="cm">/* The data buffer size is equal to page size */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">ONENAND_REG_DATA_BUFFER_SIZE</span><span class="p">);</span>
	<span class="cm">/* We use the full BufferRAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_4KB_PAGE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="cm">/* Pages per a block are always 64 in OneNAND */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Flex-OneNAND SLC area has 64 pages per block.</span>
<span class="cm">	 * Flex-OneNAND MLC area has 128 pages per block.</span>
<span class="cm">	 * Expose MLC erase size to find erase_shift and page_mask.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">page_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">-</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Set density mask. it is used for DDP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_DDP</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">density_mask</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">erase_shift</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* It&#39;s real page size */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="cm">/* REVISIT: Multichip handling */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="n">flexonenand_get_size</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipsize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We emulate the 4KiB page and 256KiB erase block size</span>
<span class="cm">	 * But oobsize is still 64 bytes.</span>
<span class="cm">	 * It is only valid if you turn on 2X program support,</span>
<span class="cm">	 * Otherwise it will be ignored by compiler.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_2PLANE</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_suspend - [MTD Interface] Suspend the OneNAND flash</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">onenand_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">onenand_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_resume - [MTD Interface] Resume the OneNAND flash</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">onenand_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FL_PM_SUSPENDED</span><span class="p">)</span>
		<span class="n">onenand_release_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: resume() called for the chip which is not &quot;</span>
				<span class="s">&quot;in suspended state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_scan - [OneNAND Interface] Scan for the OneNAND device</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> * @param maxchips	Number of chips to scan for</span>
<span class="cm"> *</span>
<span class="cm"> * This fills out all the not initialized function pointers</span>
<span class="cm"> * with the defaults.</span>
<span class="cm"> * The flash ID is read and the mtd/chip structures are</span>
<span class="cm"> * filled with the appropriate values.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">onenand_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxchips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_word</span> <span class="o">=</span> <span class="n">onenand_readw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_word</span> <span class="o">=</span> <span class="n">onenand_writew</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">onenand_command</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">onenand_setup_wait</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_wait</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">bbt_wait</span> <span class="o">=</span> <span class="n">onenand_bbt_wait</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">unlock_all</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">unlock_all</span> <span class="o">=</span> <span class="n">onenand_unlock_all</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_probe</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_probe</span> <span class="o">=</span> <span class="n">onenand_chip_probe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span> <span class="o">=</span> <span class="n">onenand_read_bufferram</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">write_bufferram</span> <span class="o">=</span> <span class="n">onenand_write_bufferram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">block_markbad</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">block_markbad</span> <span class="o">=</span> <span class="n">onenand_default_block_markbad</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">scan_bbt</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">scan_bbt</span> <span class="o">=</span> <span class="n">onenand_default_bbt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onenand_probe</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Set Sync. Burst Read after probing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">mmcontrol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OneNAND Sync. Burst Read support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">read_bufferram</span> <span class="o">=</span> <span class="n">onenand_sync_read_bufferram</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate buffers, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t allocate page_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_MTD_ONENAND_VERIFY_WRITE</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">verify_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">verify_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_PAGEBUF_ALLOC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t allocate oob_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_PAGEBUF_ALLOC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ONENAND_PAGEBUF_ALLOC</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ONENAND_OOBBUF_ALLOC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FL_READY</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chip_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow subpage writes up to oobsize.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flexonenand_oob_128</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">onenand_oob_128</span><span class="p">;</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ONENAND_IS_NOP_1</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">onenand_oob_64</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">onenand_oob_32</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: No OOB scheme defined for oobsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* To prevent kernel oops */</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">onenand_oob_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">subpagesize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The number of bytes available for a client to place data into</span>
<span class="cm">	 * the out of band area</span>
<span class="cm">	 */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MTD_MAX_OOBFREE_ENTRIES</span> <span class="o">&amp;&amp;</span>
	    <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">+=</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobfree</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecclayout</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_strength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill in remaining MTD driver data */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ONENAND_IS_MLC</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">?</span> <span class="n">MTD_MLCNANDFLASH</span> <span class="o">:</span> <span class="n">MTD_NANDFLASH</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MTD_CAP_NANDFLASH</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_erase</span> <span class="o">=</span> <span class="n">onenand_erase</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_point</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unpoint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read</span> <span class="o">=</span> <span class="n">onenand_read</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write</span> <span class="o">=</span> <span class="n">onenand_write</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_oob</span> <span class="o">=</span> <span class="n">onenand_read_oob</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write_oob</span> <span class="o">=</span> <span class="n">onenand_write_oob</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_panic_write</span> <span class="o">=</span> <span class="n">onenand_panic_write</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTD_ONENAND_OTP</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_fact_prot_info</span> <span class="o">=</span> <span class="n">onenand_get_fact_prot_info</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_fact_prot_reg</span> <span class="o">=</span> <span class="n">onenand_read_fact_prot_reg</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_user_prot_info</span> <span class="o">=</span> <span class="n">onenand_get_user_prot_info</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_user_prot_reg</span> <span class="o">=</span> <span class="n">onenand_read_user_prot_reg</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write_user_prot_reg</span> <span class="o">=</span> <span class="n">onenand_write_user_prot_reg</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock_user_prot_reg</span> <span class="o">=</span> <span class="n">onenand_lock_user_prot_reg</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_sync</span> <span class="o">=</span> <span class="n">onenand_sync</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">onenand_lock</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unlock</span> <span class="o">=</span> <span class="n">onenand_unlock</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_suspend</span> <span class="o">=</span> <span class="n">onenand_suspend</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_resume</span> <span class="o">=</span> <span class="n">onenand_resume</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_isbad</span> <span class="o">=</span> <span class="n">onenand_block_isbad</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_markbad</span> <span class="o">=</span> <span class="n">onenand_block_markbad</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writebufsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>

	<span class="cm">/* Unlock whole block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_SKIP_INITIAL_UNLOCKING</span><span class="p">))</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">unlock_all</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">scan_bbt</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">FLEXONENAND</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="o">||</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Change Flex-OneNAND boundaries if required */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">flexonenand_set_boundary</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">flex_bdry</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span>
						 <span class="n">flex_bdry</span><span class="p">[(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * onenand_release - [OneNAND Interface] Free resources held by the OneNAND device</span>
<span class="cm"> * @param mtd		MTD device structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">onenand_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">onenand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Deregister partitions */</span>
	<span class="n">mtd_device_unregister</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="cm">/* Free bad block table memory, if allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bbm_info</span> <span class="o">*</span><span class="n">bbm</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bbm</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bbm</span><span class="o">-&gt;</span><span class="n">bbt</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bbm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Buffers allocated by onenand_scan */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_PAGEBUF_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTD_ONENAND_VERIFY_WRITE</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">verify_buf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ONENAND_OOBBUF_ALLOC</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">oob_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">eraseregions</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">onenand_scan</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">onenand_release</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kyungmin Park &lt;kyungmin.park@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Generic OneNAND flash driver code&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
