<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › devices › m25p80.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>m25p80.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * MTD SPI driver for ST M25Pxx (and similar) serial flash chips</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Mike Lavender, mike@steroidmicros.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005, Intec Automation Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Some parts are based on lart.c by Abraham Van Der Merwe</span>
<span class="cm"> *</span>
<span class="cm"> * Cleaned up and generalized based on mtd_dataflash.c</span>
<span class="cm"> *</span>
<span class="cm"> * This code is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/math64.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mod_devicetable.h&gt;</span>

<span class="cp">#include &lt;linux/mtd/cfi.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>

<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/flash.h&gt;</span>

<span class="cm">/* Flash opcodes. */</span>
<span class="cp">#define	OPCODE_WREN		0x06	</span><span class="cm">/* Write enable */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_RDSR		0x05	</span><span class="cm">/* Read status register */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_WRSR		0x01	</span><span class="cm">/* Write status register 1 byte */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_NORM_READ	0x03	</span><span class="cm">/* Read data bytes (low frequency) */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_FAST_READ	0x0b	</span><span class="cm">/* Read data bytes (high frequency) */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_PP		0x02	</span><span class="cm">/* Page program (up to 256 bytes) */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_BE_4K		0x20	</span><span class="cm">/* Erase 4KiB block */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_BE_32K		0x52	</span><span class="cm">/* Erase 32KiB block */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_CHIP_ERASE	0xc7	</span><span class="cm">/* Erase whole flash chip */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_SE		0xd8	</span><span class="cm">/* Sector erase (usually 64KiB) */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_RDID		0x9f	</span><span class="cm">/* Read JEDEC ID */</span><span class="cp"></span>

<span class="cm">/* Used for SST flashes only. */</span>
<span class="cp">#define	OPCODE_BP		0x02	</span><span class="cm">/* Byte program */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_WRDI		0x04	</span><span class="cm">/* Write disable */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_AAI_WP		0xad	</span><span class="cm">/* Auto address increment word program */</span><span class="cp"></span>

<span class="cm">/* Used for Macronix flashes only. */</span>
<span class="cp">#define	OPCODE_EN4B		0xb7	</span><span class="cm">/* Enter 4-byte mode */</span><span class="cp"></span>
<span class="cp">#define	OPCODE_EX4B		0xe9	</span><span class="cm">/* Exit 4-byte mode */</span><span class="cp"></span>

<span class="cm">/* Used for Spansion flashes only. */</span>
<span class="cp">#define	OPCODE_BRWR		0x17	</span><span class="cm">/* Bank register write */</span><span class="cp"></span>

<span class="cm">/* Status Register bits. */</span>
<span class="cp">#define	SR_WIP			1	</span><span class="cm">/* Write in progress */</span><span class="cp"></span>
<span class="cp">#define	SR_WEL			2	</span><span class="cm">/* Write enable latch */</span><span class="cp"></span>
<span class="cm">/* meaning of other SR_* bits may differ between vendors */</span>
<span class="cp">#define	SR_BP0			4	</span><span class="cm">/* Block protect 0 */</span><span class="cp"></span>
<span class="cp">#define	SR_BP1			8	</span><span class="cm">/* Block protect 1 */</span><span class="cp"></span>
<span class="cp">#define	SR_BP2			0x10	</span><span class="cm">/* Block protect 2 */</span><span class="cp"></span>
<span class="cp">#define	SR_SRWD			0x80	</span><span class="cm">/* SR write protect */</span><span class="cp"></span>

<span class="cm">/* Define max times to check status register before we give up. */</span>
<span class="cp">#define	MAX_READY_WAIT_JIFFIES	(40 * HZ)	</span><span class="cm">/* M25P16 specs 40s max chip erase */</span><span class="cp"></span>
<span class="cp">#define	MAX_CMD_SIZE		5</span>

<span class="cp">#ifdef CONFIG_M25PXX_USE_FAST_READ</span>
<span class="cp">#define OPCODE_READ 	OPCODE_FAST_READ</span>
<span class="cp">#define FAST_READ_DUMMY_BYTE 1</span>
<span class="cp">#else</span>
<span class="cp">#define OPCODE_READ 	OPCODE_NORM_READ</span>
<span class="cp">#define FAST_READ_DUMMY_BYTE 0</span>
<span class="cp">#endif</span>

<span class="cp">#define JEDEC_MFR(_jedec_id)	((_jedec_id) &gt;&gt; 16)</span>

<span class="cm">/****************************************************************************/</span>

<span class="k">struct</span> <span class="n">m25p</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_device</span>	<span class="o">*</span><span class="n">spi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span>		<span class="n">mtd</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">page_size</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">addr_width</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">erase_opcode</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">command</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="nf">mtd_to_m25p</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m25p</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Internal helper functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Read the status register, returning its value in the location</span>
<span class="cm"> * Return the status register value.</span>
<span class="cm"> * Returns negative if error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_sr</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">code</span> <span class="o">=</span> <span class="n">OPCODE_RDSR</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_write_then_read</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error %d reading SR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write status register 1 byte</span>
<span class="cm"> * Returns negative if error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_sr</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_WRSR</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">spi_write</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set write enable latch with Write Enable command.</span>
<span class="cm"> * Returns negative if error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">write_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">code</span> <span class="o">=</span> <span class="n">OPCODE_WREN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">spi_write_then_read</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send write disble instruction to the chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">write_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">code</span> <span class="o">=</span> <span class="n">OPCODE_WRDI</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">spi_write_then_read</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable/disable 4-byte addressing mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">set_4byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">u32</span> <span class="n">jedec_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">JEDEC_MFR</span><span class="p">(</span><span class="n">jedec_id</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CFI_MFR_MACRONIX</span>:
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">OPCODE_EN4B</span> <span class="o">:</span> <span class="n">OPCODE_EX4B</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">spi_write</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="cm">/* Spansion style */</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_BRWR</span><span class="p">;</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">spi_write</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Service routine to read status register until ready, or timeout occurs.</span>
<span class="cm"> * Returns non-zero if error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_till_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sr</span><span class="p">;</span>

	<span class="n">deadline</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MAX_READY_WAIT_JIFFIES</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">read_sr</span><span class="p">(</span><span class="n">flash</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="n">SR_WIP</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cond_resched</span><span class="p">();</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">deadline</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase the whole flash memory</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful, non-zero otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">erase_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s %lldKiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="cm">/* Wait until finished previous write command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Send write enable, then erase commands. */</span>
	<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

	<span class="cm">/* Set up command buffer. */</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_CHIP_ERASE</span><span class="p">;</span>

	<span class="n">spi_write</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m25p_addr2cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* opcode is in cmd[0] */</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span>  <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m25p_cmdsz</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase one sector of flash memory at offset ``offset&#39;&#39; which is any</span>
<span class="cm"> * address within the sector which should be erased.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful, non-zero otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">erase_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s %dKiB at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">erasesize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* Wait until finished previous write command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Send write enable, then erase commands. */</span>
	<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

	<span class="cm">/* Set up command buffer. */</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">erase_opcode</span><span class="p">;</span>
	<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="n">spi_write</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * MTD implementation</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Erase an address range on the flash chip.  The address range may extend</span>
<span class="cm"> * one or more erase sectors.  Return an error is there is a problem erasing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m25p80_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">mtd_to_m25p</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rem</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s at 0x%llx, len %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">div_u64_rem</span><span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* whole-chip erase? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">erase_chip</span><span class="p">(</span><span class="n">flash</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* REVISIT in some cases we could speed up erasing large regions</span>
<span class="cm">	 * by using OPCODE_SE instead of OPCODE_BE_4K.  We may have set up</span>
<span class="cm">	 * to use &quot;small sector erase&quot;, but that&#39;s not always optimal.</span>
<span class="cm">	 */</span>

	<span class="cm">/* &quot;sector&quot;-at-a-time erase */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">erase_sector</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_DONE</span><span class="p">;</span>
	<span class="n">mtd_erase_callback</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read an address range from the flash chip.  The address range</span>
<span class="cm"> * may be any size provided it is within the physical boundaries.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m25p80_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">mtd_to_m25p</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s from 0x%08x, len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">t</span><span class="p">));</span>

	<span class="cm">/* NOTE:</span>
<span class="cm">	 * OPCODE_FAST_READ (if available) is faster.</span>
<span class="cm">	 * Should add 1 byte DUMMY_BYTE.</span>
<span class="cm">	 */</span>
	<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">)</span> <span class="o">+</span> <span class="n">FAST_READ_DUMMY_BYTE</span><span class="p">;</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Wait till previous write/erase is done. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* REVISIT status return?? */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME switch to OPCODE_FAST_READ.  It&#39;s required for higher</span>
<span class="cm">	 * clocks; and at this writing, every chip this driver handles</span>
<span class="cm">	 * supports that opcode.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Set up the write data buffer. */</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_READ</span><span class="p">;</span>
	<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">)</span> <span class="o">-</span> <span class="n">FAST_READ_DUMMY_BYTE</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write an address range to the flash chip.  Data must be written in</span>
<span class="cm"> * FLASH_PAGESIZE chunks.  The address range may be any size provided</span>
<span class="cm"> * it is within the physical boundaries.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m25p80_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">mtd_to_m25p</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">page_offset</span><span class="p">,</span> <span class="n">page_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s to 0x%08x, len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">t</span><span class="p">));</span>

	<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Wait until finished previous write command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

	<span class="cm">/* Set up the opcode in the write buffer. */</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_PP</span><span class="p">;</span>
	<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="n">page_offset</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* do all the bytes fit onto one page? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

		<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* the size of data remaining on the first page */</span>
		<span class="n">page_size</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">-</span> <span class="n">page_offset</span><span class="p">;</span>

		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">;</span>
		<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

		<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

		<span class="cm">/* write everything in flash-&gt;page_size chunks */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">page_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page_size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_size</span> <span class="o">&gt;</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">)</span>
				<span class="n">page_size</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">;</span>

			<span class="cm">/* write the next page to flash */</span>
			<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">to</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

			<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">;</span>

			<span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

			<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

			<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

			<span class="o">*</span><span class="n">retlen</span> <span class="o">+=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sst_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m25p</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">mtd_to_m25p</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">actual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_sz</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s to 0x%08x, len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">t</span><span class="p">));</span>

	<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Wait until finished previous write command. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">time_out</span><span class="p">;</span>

	<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

	<span class="n">actual</span> <span class="o">=</span> <span class="n">to</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Start write from odd address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_BP</span><span class="p">;</span>
		<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

		<span class="cm">/* write one byte. */</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">time_out</span><span class="p">;</span>
		<span class="o">*</span><span class="n">retlen</span> <span class="o">+=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">to</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_AAI_WP</span><span class="p">;</span>
	<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="cm">/* Write out most of the data here. */</span>
	<span class="n">cmd_sz</span> <span class="o">=</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">actual</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">actual</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cmd_sz</span><span class="p">;</span>
		<span class="cm">/* write two bytes. */</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">actual</span><span class="p">;</span>

		<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">time_out</span><span class="p">;</span>
		<span class="o">*</span><span class="n">retlen</span> <span class="o">+=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">cmd_sz</span><span class="p">;</span>
		<span class="n">cmd_sz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">to</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_disable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">time_out</span><span class="p">;</span>

	<span class="cm">/* Write out trailing byte if it exists. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPCODE_BP</span><span class="p">;</span>
		<span class="n">m25p_addr2cmd</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">actual</span><span class="p">;</span>

		<span class="n">spi_sync</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_till_ready</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">time_out</span><span class="p">;</span>
		<span class="o">*</span><span class="n">retlen</span> <span class="o">+=</span> <span class="n">m</span><span class="p">.</span><span class="n">actual_length</span> <span class="o">-</span> <span class="n">m25p_cmdsz</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="n">write_disable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">time_out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * SPI device driver setup and teardown</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">flash_info</span> <span class="p">{</span>
	<span class="cm">/* JEDEC id zero means &quot;no ID&quot; (most older chips); otherwise it has</span>
<span class="cm">	 * a high byte of zero plus three data bytes: the manufacturer id,</span>
<span class="cm">	 * then a two byte device id.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span>		<span class="n">jedec_id</span><span class="p">;</span>
	<span class="n">u16</span>             <span class="n">ext_id</span><span class="p">;</span>

	<span class="cm">/* The size listed here is what works with OPCODE_SE, which isn&#39;t</span>
<span class="cm">	 * necessarily called a &quot;sector&quot; by the vendor.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span>	<span class="n">sector_size</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">n_sectors</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="n">page_size</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">addr_width</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define	SECT_4K		0x01		</span><span class="cm">/* OPCODE_BE_4K works uniformly */</span><span class="cp"></span>
<span class="cp">#define	M25P_NO_ERASE	0x02		</span><span class="cm">/* No erase command needed */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cp">#define INFO(_jedec_id, _ext_id, _sector_size, _n_sectors, _flags)	\</span>
<span class="cp">	((kernel_ulong_t)&amp;(struct flash_info) {				\</span>
<span class="cp">		.jedec_id = (_jedec_id),				\</span>
<span class="cp">		.ext_id = (_ext_id),					\</span>
<span class="cp">		.sector_size = (_sector_size),				\</span>
<span class="cp">		.n_sectors = (_n_sectors),				\</span>
<span class="cp">		.page_size = 256,					\</span>
<span class="cp">		.flags = (_flags),					\</span>
<span class="cp">	})</span>

<span class="cp">#define CAT25_INFO(_sector_size, _n_sectors, _page_size, _addr_width)	\</span>
<span class="cp">	((kernel_ulong_t)&amp;(struct flash_info) {				\</span>
<span class="cp">		.sector_size = (_sector_size),				\</span>
<span class="cp">		.n_sectors = (_n_sectors),				\</span>
<span class="cp">		.page_size = (_page_size),				\</span>
<span class="cp">		.addr_width = (_addr_width),				\</span>
<span class="cp">		.flags = M25P_NO_ERASE,					\</span>
<span class="cp">	})</span>

<span class="cm">/* NOTE: double check command sets and memory organization when you add</span>
<span class="cm"> * more flash chips.  This current list focusses on newer chips, which</span>
<span class="cm"> * have been converging on command sets which including JEDEC ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">spi_device_id</span> <span class="n">m25p_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Atmel -- some are (confusingly) marketed as &quot;DataFlash&quot; */</span>
	<span class="p">{</span> <span class="s">&quot;at25fs010&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f6601</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;at25fs040&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f6604</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;at25df041a&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f4401</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;at25df321a&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f4701</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;at25df641&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f4800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;at26f004&quot;</span><span class="p">,</span>   <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f0400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;at26df081a&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f4501</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;at26df161a&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f4601</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;at26df321&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1f4700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* EON -- en25xxx */</span>
	<span class="p">{</span> <span class="s">&quot;en25f32&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1c3116</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;en25p32&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1c2016</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;en25q32b&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1c3016</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;en25p64&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x1c2017</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* Everspin */</span>
	<span class="p">{</span> <span class="s">&quot;mr25h256&quot;</span><span class="p">,</span> <span class="n">CAT25_INFO</span><span class="p">(</span>  <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* Intel/Numonyx -- xxxs33b */</span>
	<span class="p">{</span> <span class="s">&quot;160s33b&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x898911</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;320s33b&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x898912</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;640s33b&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x898913</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* Macronix */</span>
	<span class="p">{</span> <span class="s">&quot;mx25l2005a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22012</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l4005a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22013</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l8005&quot;</span><span class="p">,</span>   <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22014</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l1606e&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22015</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l3205d&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22016</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l6405d&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22017</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l12805d&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22018</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l12855e&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22618</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l25635e&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22019</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mx25l25655e&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xc22619</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* Spansion -- single (large) sector size only, at least</span>
<span class="cm">	 * for the chips listed here (without boot sectors).</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="s">&quot;s25sl004a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010212</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl008a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010213</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl016a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010214</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl032a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010215</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl032p&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010215</span><span class="p">,</span> <span class="mh">0x4d00</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl064a&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010216</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl256s0&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010219</span><span class="p">,</span> <span class="mh">0x4d00</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl256s1&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010219</span><span class="p">,</span> <span class="mh">0x4d01</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl512s&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010220</span><span class="p">,</span> <span class="mh">0x4d00</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s70fl01gs&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x010221</span><span class="p">,</span> <span class="mh">0x4d00</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl12800&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x012018</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25sl12801&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x012018</span><span class="p">,</span> <span class="mh">0x0301</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl129p0&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x012018</span><span class="p">,</span> <span class="mh">0x4d00</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl129p1&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x012018</span><span class="p">,</span> <span class="mh">0x4d01</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl016k&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef4015</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;s25fl064k&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef4017</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* SST -- large erase sizes are &quot;overlays&quot;, &quot;sectors&quot; are 4K */</span>
	<span class="p">{</span> <span class="s">&quot;sst25vf040b&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf258d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25vf080b&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf258e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25vf016b&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf2541</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25vf032b&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf254a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25wf512&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf2501</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25wf010&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf2502</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25wf020&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf2503</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sst25wf040&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0xbf2504</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* ST Microelectronics -- newer production may have feature updates */</span>
	<span class="p">{</span> <span class="s">&quot;m25p05&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202010</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p10&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202011</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p20&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202012</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p40&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202013</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p80&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202014</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p16&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202015</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p32&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202016</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p64&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202017</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p128&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x202018</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;m25p05-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p10-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p20-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p40-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p80-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p16-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p32-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p64-nonjedec&quot;</span><span class="p">,</span>  <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25p128-nonjedec&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;m45pe10&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x204011</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>    <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m45pe80&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x204014</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m45pe16&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x204015</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;m25pe80&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x208014</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>       <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25pe16&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x208015</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;m25px32&quot;</span><span class="p">,</span>    <span class="n">INFO</span><span class="p">(</span><span class="mh">0x207116</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25px32-s0&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x207316</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25px32-s1&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0x206316</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m25px64&quot;</span><span class="p">,</span>    <span class="n">INFO</span><span class="p">(</span><span class="mh">0x207117</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* Winbond -- w25x &quot;blocks&quot; are 64K, &quot;sectors&quot; are 4KiB */</span>
	<span class="p">{</span> <span class="s">&quot;w25x10&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3011</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25x20&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3012</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25x40&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3013</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25x80&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3014</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25x16&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3015</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25x32&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3016</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25q32&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef4016</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25x64&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef3017</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25q64&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef4017</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w25q80&quot;</span><span class="p">,</span> <span class="n">INFO</span><span class="p">(</span><span class="mh">0xef5014</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* Catalyst / On Semiconductor -- non-JEDEC */</span>
	<span class="p">{</span> <span class="s">&quot;cat25c11&quot;</span><span class="p">,</span> <span class="n">CAT25_INFO</span><span class="p">(</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cat25c03&quot;</span><span class="p">,</span> <span class="n">CAT25_INFO</span><span class="p">(</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cat25c09&quot;</span><span class="p">,</span> <span class="n">CAT25_INFO</span><span class="p">(</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cat25c17&quot;</span><span class="p">,</span> <span class="n">CAT25_INFO</span><span class="p">(</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cat25128&quot;</span><span class="p">,</span> <span class="n">CAT25_INFO</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">m25p_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">spi_device_id</span> <span class="o">*</span><span class="n">__devinit</span> <span class="nf">jedec_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">code</span> <span class="o">=</span> <span class="n">OPCODE_RDID</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">id</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">jedec</span><span class="p">;</span>
	<span class="n">u16</span>                     <span class="n">ext_jedec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flash_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* JEDEC also defines an optional &quot;extended device information&quot;</span>
<span class="cm">	 * string for after vendor-specific data, after the three bytes</span>
<span class="cm">	 * we use here.  Supporting some chips might require using it.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">spi_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: error %d reading JEDEC ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">jedec</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">jedec</span> <span class="o">=</span> <span class="n">jedec</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">jedec</span> <span class="o">|=</span> <span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">jedec</span> <span class="o">=</span> <span class="n">jedec</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">jedec</span> <span class="o">|=</span> <span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">ext_jedec</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">m25p_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">m25p_ids</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">driver_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span> <span class="o">==</span> <span class="n">jedec</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">!=</span> <span class="n">ext_jedec</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">m25p_ids</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unrecognized JEDEC id %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jedec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * board specific setup should have ensured the SPI clock used here</span>
<span class="cm"> * matches what the READ command supports, at least until this driver</span>
<span class="cm"> * understands FAST_READ (for clocks over 25 MHz).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">m25p_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">spi_device_id</span>	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">spi_get_device_id</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">flash_platform_data</span>	<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m25p</span>			<span class="o">*</span><span class="n">flash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flash_info</span>		<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_part_parser_data</span>	<span class="n">ppdata</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTD_OF_PARTS</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_available</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Platform data helps sort out which chip type we have, as</span>
<span class="cm">	 * well as how this board partitions it.  If we don&#39;t have</span>
<span class="cm">	 * a chip ID, try the JEDEC id commands; they&#39;ll work for most</span>
<span class="cm">	 * newer chips, even if we don&#39;t recognize the particular chip.</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">spi_device_id</span> <span class="o">*</span><span class="n">plat_id</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">m25p_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plat_id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m25p_ids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">plat_id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">m25p_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">plat_id</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unrecognized id %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">spi_device_id</span> <span class="o">*</span><span class="n">jid</span><span class="p">;</span>

		<span class="n">jid</span> <span class="o">=</span> <span class="n">jedec_probe</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">jid</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">jid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jid</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * JEDEC knows better, so overwrite platform ID. We</span>
<span class="cm">			 * can&#39;t trust partitions any longer, but we&#39;ll let</span>
<span class="cm">			 * mtd apply them anyway, since some partitions may be</span>
<span class="cm">			 * marked read-only, and we don&#39;t want to lose that</span>
<span class="cm">			 * information, even if it&#39;s not 100% accurate.</span>
<span class="cm">			 */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found %s, expected %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">jid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">jid</span><span class="p">;</span>
			<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">jid</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">flash</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flash</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_CMD_SIZE</span> <span class="o">+</span> <span class="n">FAST_READ_DUMMY_BYTE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">spi</span> <span class="o">=</span> <span class="n">spi</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">flash</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Atmel, SST and Intel/Numonyx serial flash tend to power</span>
<span class="cm">	 * up with the software protection bits set</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">JEDEC_MFR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CFI_MFR_ATMEL</span> <span class="o">||</span>
	    <span class="n">JEDEC_MFR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CFI_MFR_INTEL</span> <span class="o">||</span>
	    <span class="n">JEDEC_MFR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CFI_MFR_SST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_enable</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="n">write_sr</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MTD_NORFLASH</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">writesize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MTD_CAP_NORFLASH</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">n_sectors</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">_erase</span> <span class="o">=</span> <span class="n">m25p80_erase</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">_read</span> <span class="o">=</span> <span class="n">m25p80_read</span><span class="p">;</span>

	<span class="cm">/* sst flash chips use AAI word program */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JEDEC_MFR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CFI_MFR_SST</span><span class="p">)</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">_write</span> <span class="o">=</span> <span class="n">sst_write</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">_write</span> <span class="o">=</span> <span class="n">m25p80_write</span><span class="p">;</span>

	<span class="cm">/* prefer &quot;small sector&quot; erase if possible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SECT_4K</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">erase_opcode</span> <span class="o">=</span> <span class="n">OPCODE_BE_4K</span><span class="p">;</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">erasesize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">erase_opcode</span> <span class="o">=</span> <span class="n">OPCODE_SE</span><span class="p">;</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">erasesize</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">M25P_NO_ERASE</span><span class="p">)</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MTD_NO_ERASE</span><span class="p">;</span>

	<span class="n">ppdata</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">writebufsize</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">addr_width</span><span class="p">)</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">addr_width</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* enable 4-byte addressing if the device exceeds 16MiB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">set_4byte</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">jedec_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_width</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s (%lld Kbytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mtd .name = %s, .size = 0x%llx (%lldMiB) &quot;</span>
			<span class="s">&quot;.erasesize = 0x%.8x (%uKiB) .numeraseregions = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">),</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">erasesize</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">erasesize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">numeraseregions</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">numeraseregions</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">numeraseregions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mtd.eraseregions[%d] = { .offset = 0x%llx, &quot;</span>
				<span class="s">&quot;.erasesize = 0x%.8x (%uKiB), &quot;</span>
				<span class="s">&quot;.numblocks = %d }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
				<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span><span class="p">,</span>
				<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
				<span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">.</span><span class="n">eraseregions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numblocks</span><span class="p">);</span>


	<span class="cm">/* partitions should match sector boundaries; and it may be good to</span>
<span class="cm">	 * use readonly partitions for writeprotected sectors (BP2..BP0).</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">mtd_device_parse_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppdata</span><span class="p">,</span>
			<span class="n">data</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">parts</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">data</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nr_parts</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">m25p_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m25p</span>	<span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Clean up MTD stuff. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mtd_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">m25p80_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;m25p80&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">m25p_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">m25p_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">m25p_remove</span><span class="p">),</span>

	<span class="cm">/* REVISIT: many of these chips have deep power-down modes, which</span>
<span class="cm">	 * should clearly be entered on suspend() to minimize power use.</span>
<span class="cm">	 * And also when they&#39;re otherwise idle...</span>
<span class="cm">	 */</span>
<span class="p">};</span>

<span class="n">module_spi_driver</span><span class="p">(</span><span class="n">m25p80_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Lavender&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MTD SPI driver for ST M25Pxx flash chips&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
