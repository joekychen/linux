<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › devices › pmc551.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pmc551.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PMC551 PCI Mezzanine Ram Device</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *	Mark Ferrell &lt;mferrell@mvista.com&gt;</span>
<span class="cm"> *	Copyright 1999,2000 Nortel Networks</span>
<span class="cm"> *</span>
<span class="cm"> * License:</span>
<span class="cm"> *	As part of this driver was derived from the slram.c driver it</span>
<span class="cm"> *	falls under the same license, which is GNU General Public</span>
<span class="cm"> *	License v2</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *	This driver is intended to support the PMC551 PCI Ram device</span>
<span class="cm"> *	from Ramix Inc.  The PMC551 is a PMC Mezzanine module for</span>
<span class="cm"> *	cPCI embedded systems.  The device contains a single SROM</span>
<span class="cm"> *	that initially programs the V370PDC chipset onboard the</span>
<span class="cm"> *	device, and various banks of DRAM/SDRAM onboard.  This driver</span>
<span class="cm"> *	implements this PCI Ram device as an MTD (Memory Technology</span>
<span class="cm"> *	Device) so that it can be used to hold a file system, or for</span>
<span class="cm"> *	added swap space in embedded systems.  Since the memory on</span>
<span class="cm"> *	this board isn&#39;t as fast as main memory we do not try to hook</span>
<span class="cm"> *	it into main memory as that would simply reduce performance</span>
<span class="cm"> *	on the system.  Using it as a block device allows us to use</span>
<span class="cm"> *	it as high speed swap or for a high speed disk device of some</span>
<span class="cm"> *	sort.  Which becomes very useful on diskless systems in the</span>
<span class="cm"> *	embedded market I might add.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	Due to what I assume is more buggy SROM, the 64M PMC551 I</span>
<span class="cm"> *	have available claims that all 4 of its DRAM banks have 64MiB</span>
<span class="cm"> *	of ram configured (making a grand total of 256MiB onboard).</span>
<span class="cm"> *	This is slightly annoying since the BAR0 size reflects the</span>
<span class="cm"> *	aperture size, not the dram size, and the V370PDC supplies no</span>
<span class="cm"> *	other method for memory size discovery.  This problem is</span>
<span class="cm"> *	mostly only relevant when compiled as a module, as the</span>
<span class="cm"> *	unloading of the module with an aperture size smaller than</span>
<span class="cm"> *	the ram will cause the driver to detect the onboard memory</span>
<span class="cm"> *	size to be equal to the aperture size when the module is</span>
<span class="cm"> *	reloaded.  Soooo, to help, the module supports an msize</span>
<span class="cm"> *	option to allow the specification of the onboard memory, and</span>
<span class="cm"> *	an asize option, to allow the specification of the aperture</span>
<span class="cm"> *	size.  The aperture must be equal to or less then the memory</span>
<span class="cm"> *	size, the driver will correct this if you screw it up.  This</span>
<span class="cm"> *	problem is not relevant for compiled in drivers as compiled</span>
<span class="cm"> *	in drivers only init once.</span>
<span class="cm"> *</span>
<span class="cm"> * Credits:</span>
<span class="cm"> *	Saeed Karamooz &lt;saeed@ramix.com&gt; of Ramix INC. for the</span>
<span class="cm"> *	initial example code of how to initialize this device and for</span>
<span class="cm"> *	help with questions I had concerning operation of the device.</span>
<span class="cm"> *</span>
<span class="cm"> *	Most of the MTD code for this driver was originally written</span>
<span class="cm"> *	for the slram.o module in the MTD drivers package which</span>
<span class="cm"> *	allows the mapping of system memory into an MTD device.</span>
<span class="cm"> *	Since the PMC551 memory module is accessed in the same</span>
<span class="cm"> *	fashion as system memory, the slram.c code became a very nice</span>
<span class="cm"> *	fit to the needs of this driver.  All we added was PCI</span>
<span class="cm"> *	detection/initialization to the driver and automatically figure</span>
<span class="cm"> *	out the size via the PCI detection.o, later changes by Corey</span>
<span class="cm"> *	Minyard set up the card to utilize a 1M sliding apature.</span>
<span class="cm"> *</span>
<span class="cm"> *	Corey Minyard &lt;minyard@nortelnetworks.com&gt;</span>
<span class="cm"> *	* Modified driver to utilize a sliding aperture instead of</span>
<span class="cm"> *	 mapping all memory into kernel space which turned out to</span>
<span class="cm"> *	 be very wasteful.</span>
<span class="cm"> *	* Located a bug in the SROM&#39;s initialization sequence that</span>
<span class="cm"> *	 made the memory unusable, added a fix to code to touch up</span>
<span class="cm"> *	 the DRAM some.</span>
<span class="cm"> *</span>
<span class="cm"> * Bugs/FIXMEs:</span>
<span class="cm"> *	* MUST fix the init function to not spin on a register</span>
<span class="cm"> *	waiting for it to set .. this does not safely handle busted</span>
<span class="cm"> *	devices that never reset the register correctly which will</span>
<span class="cm"> *	cause the system to hang w/ a reboot being the only chance at</span>
<span class="cm"> *	recover. [sort of fixed, could be better]</span>
<span class="cm"> *	* Add I2C handling of the SROM so we can read the SROM&#39;s information</span>
<span class="cm"> *	about the aperture size.  This should always accurately reflect the</span>
<span class="cm"> *	onboard memory size.</span>
<span class="cm"> *	* Comb the init routine.  It&#39;s still a bit cludgy on a few things.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>

<span class="cp">#define PMC551_VERSION \</span>
<span class="cp">	&quot;Ramix PMC551 PCI Mezzanine Ram Driver. (C) 1999,2000 Nortel Networks.\n&quot;</span>

<span class="cp">#define PCI_VENDOR_ID_V3_SEMI 0x11b0</span>
<span class="cp">#define PCI_DEVICE_ID_V3_SEMI_V370PDC 0x0200</span>

<span class="cp">#define PMC551_PCI_MEM_MAP0 0x50</span>
<span class="cp">#define PMC551_PCI_MEM_MAP1 0x54</span>
<span class="cp">#define PMC551_PCI_MEM_MAP_MAP_ADDR_MASK 0x3ff00000</span>
<span class="cp">#define PMC551_PCI_MEM_MAP_APERTURE_MASK 0x000000f0</span>
<span class="cp">#define PMC551_PCI_MEM_MAP_REG_EN 0x00000002</span>
<span class="cp">#define PMC551_PCI_MEM_MAP_ENABLE 0x00000001</span>

<span class="cp">#define PMC551_SDRAM_MA  0x60</span>
<span class="cp">#define PMC551_SDRAM_CMD 0x62</span>
<span class="cp">#define PMC551_DRAM_CFG  0x64</span>
<span class="cp">#define PMC551_SYS_CTRL_REG 0x78</span>

<span class="cp">#define PMC551_DRAM_BLK0 0x68</span>
<span class="cp">#define PMC551_DRAM_BLK1 0x6c</span>
<span class="cp">#define PMC551_DRAM_BLK2 0x70</span>
<span class="cp">#define PMC551_DRAM_BLK3 0x74</span>
<span class="cp">#define PMC551_DRAM_BLK_GET_SIZE(x) (524288 &lt;&lt; ((x &gt;&gt; 4) &amp; 0x0f))</span>
<span class="cp">#define PMC551_DRAM_BLK_SET_COL_MUX(x, v) (((x) &amp; ~0x00007000) | (((v) &amp; 0x7) &lt;&lt; 12))</span>
<span class="cp">#define PMC551_DRAM_BLK_SET_ROW_MUX(x, v) (((x) &amp; ~0x00000f00) | (((v) &amp; 0xf) &lt;&lt; 8))</span>

<span class="k">struct</span> <span class="n">mypriv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base_map0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curr_map0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">asize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">nextpmc551</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">pmc551list</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pmc551_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">virt</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="o">*</span><span class="n">phys</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmc551_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mypriv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">soff_hi</span><span class="p">,</span> <span class="n">soff_lo</span><span class="p">;</span>	<span class="cm">/* start address offset hi/lo */</span>
	<span class="n">u32</span> <span class="n">eoff_hi</span><span class="p">,</span> <span class="n">eoff_lo</span><span class="p">;</span>	<span class="cm">/* end address offset hi/lo */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_erase(pos:%ld, len:%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">eoff_hi</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">soff_hi</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eoff_lo</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">soff_lo</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pmc551_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">==</span> <span class="n">eoff_hi</span> <span class="o">||</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The whole thing fits within one access, so just one shot</span>
<span class="cm">		   will do it. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We have to do multiple writes to get all the data</span>
<span class="cm">		   written. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">!=</span> <span class="n">eoff_hi</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_erase() soff_hi: %ld, &quot;</span>
				<span class="s">&quot;eoff_hi: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">soff_hi</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">eoff_hi</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">soff_hi</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">;</span>
			<span class="n">pmc551_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_map0</span> <span class="o">|</span> <span class="n">soff_hi</span><span class="p">),</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">eoff_lo</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_DONE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_erase() done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">mtd_erase_callback</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmc551_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">virt</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="o">*</span><span class="n">phys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mypriv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">soff_hi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">soff_lo</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_point(%ld, %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">from</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">soff_hi</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">soff_lo</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Cheap hack optimization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_map0</span> <span class="o">!=</span> <span class="n">from</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_PCI_MEM_MAP0</span><span class="p">,</span>
					<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_map0</span> <span class="o">|</span> <span class="n">soff_hi</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_map0</span> <span class="o">=</span> <span class="n">soff_hi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">virt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">soff_lo</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmc551_unpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_unpoint()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmc551_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="o">*</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mypriv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">soff_hi</span><span class="p">,</span> <span class="n">soff_lo</span><span class="p">;</span>	<span class="cm">/* start address offset hi/lo */</span>
	<span class="n">u32</span> <span class="n">eoff_hi</span><span class="p">,</span> <span class="n">eoff_lo</span><span class="p">;</span>	<span class="cm">/* end address offset hi/lo */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">copyto</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_read(pos:%ld, len:%ld) asize: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">from</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">from</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">soff_hi</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eoff_hi</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">soff_lo</span> <span class="o">=</span> <span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eoff_lo</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pmc551_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">==</span> <span class="n">eoff_hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The whole thing fits within one access, so just one shot</span>
<span class="cm">		   will do it. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">copyto</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">copyto</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We have to do multiple writes to get all the data</span>
<span class="cm">		   written. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">!=</span> <span class="n">eoff_hi</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_read() soff_hi: %ld, &quot;</span>
				<span class="s">&quot;eoff_hi: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">soff_hi</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">eoff_hi</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">copyto</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>
			<span class="n">copyto</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">soff_hi</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">;</span>
			<span class="n">pmc551_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">soff_hi</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">copyto</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">eoff_lo</span><span class="p">);</span>
		<span class="n">copyto</span> <span class="o">+=</span> <span class="n">eoff_lo</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_read() done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">copyto</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmc551_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="o">*</span> <span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mypriv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">soff_hi</span><span class="p">,</span> <span class="n">soff_lo</span><span class="p">;</span>	<span class="cm">/* start address offset hi/lo */</span>
	<span class="n">u32</span> <span class="n">eoff_hi</span><span class="p">,</span> <span class="n">eoff_lo</span><span class="p">;</span>	<span class="cm">/* end address offset hi/lo */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">copyfrom</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_write(pos:%ld, len:%ld) asize:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">to</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">soff_hi</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eoff_hi</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">soff_lo</span> <span class="o">=</span> <span class="n">to</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eoff_lo</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pmc551_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">==</span> <span class="n">eoff_hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The whole thing fits within one access, so just one shot</span>
<span class="cm">		   will do it. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">copyfrom</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">copyfrom</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We have to do multiple writes to get all the data</span>
<span class="cm">		   written. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">!=</span> <span class="n">eoff_hi</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_write() soff_hi: %ld, &quot;</span>
				<span class="s">&quot;eoff_hi: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">soff_hi</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">eoff_hi</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">copyfrom</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>
			<span class="n">copyfrom</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">soff_hi</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">soff_hi</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">;</span>
			<span class="n">pmc551_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">soff_hi</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">copyfrom</span><span class="p">,</span> <span class="n">eoff_lo</span><span class="p">);</span>
		<span class="n">copyfrom</span> <span class="o">+=</span> <span class="n">eoff_lo</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551_write() done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">copyfrom</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fixup routines for the V370PDC</span>
<span class="cm"> * PCI device ID 0x020011b0</span>
<span class="cm"> *</span>
<span class="cm"> * This function basically kick starts the DRAM oboard the card and gets it</span>
<span class="cm"> * ready to be used.  Before this is done the device reads VERY erratic, so</span>
<span class="cm"> * much that it can crash the Linux 2.2.x series kernels when a user cat&#39;s</span>
<span class="cm"> * /proc/pci .. though that is mainly a kernel bug in handling the PCI DEVSEL</span>
<span class="cm"> * register.  FIXME: stop spinning on registers .. must implement a timeout</span>
<span class="cm"> * mechanism</span>
<span class="cm"> * returns the size of the memory region found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fixup_pmc551</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_BUGFIX</span>
	<span class="n">u32</span> <span class="n">dram_data</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">dcmd</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dtmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bcmd</span><span class="p">,</span> <span class="n">counter</span><span class="p">;</span>

	<span class="cm">/* Sanity Check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attempt to reset the card</span>
<span class="cm">	 * FIXME: Stop Spinning registers</span>
<span class="cm">	 */</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* unlock registers */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SYS_CTRL_REG</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">);</span>
	<span class="cm">/* read in old data */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SYS_CTRL_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcmd</span><span class="p">);</span>
	<span class="cm">/* bang the reset line up and down for a few */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SYS_CTRL_REG</span><span class="p">,</span> <span class="n">bcmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcmd</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SYS_CTRL_REG</span><span class="p">,</span> <span class="n">bcmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">bcmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SYS_CTRL_REG</span><span class="p">,</span> <span class="n">bcmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take care and turn off the memory on the device while we</span>
<span class="cm">	 * tweak the configurations</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_COMMAND_IO</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable existing aperture before probing memory size</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_PCI_MEM_MAP0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcmd</span><span class="p">);</span>
	<span class="n">dtmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dcmd</span> <span class="o">|</span> <span class="n">PMC551_PCI_MEM_MAP_ENABLE</span> <span class="o">|</span> <span class="n">PMC551_PCI_MEM_MAP_REG_EN</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_PCI_MEM_MAP0</span><span class="p">,</span> <span class="n">dtmp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Grab old BAR0 config so that we can figure out memory size</span>
<span class="cm">	 * This is another bit of kludge going on.  The reason for the</span>
<span class="cm">	 * redundancy is I am hoping to retain the original configuration</span>
<span class="cm">	 * previously assigned to the card by the BIOS or some previous</span>
<span class="cm">	 * fixup routine in the kernel.  So we read the old config into cfg,</span>
<span class="cm">	 * then write all 1&#39;s to the memory space, read back the result into</span>
<span class="cm">	 * &quot;size&quot;, and then write back all the old config.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_MTD_PMC551_BUGFIX</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/*</span>
<span class="cm">	 * Get the size of the memory by reading all the DRAM size values</span>
<span class="cm">	 * and adding them up.</span>
<span class="cm">	 *</span>
<span class="cm">	 * KLUDGE ALERT: the boards we are using have invalid column and</span>
<span class="cm">	 * row mux values.  We fix them here, but this will break other</span>
<span class="cm">	 * memory configurations.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_COL_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_ROW_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK0</span><span class="p">,</span> <span class="n">dram_data</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_COL_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_ROW_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK1</span><span class="p">,</span> <span class="n">dram_data</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_COL_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_ROW_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK2</span><span class="p">,</span> <span class="n">dram_data</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dram_data</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_COL_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="n">dram_data</span> <span class="o">=</span> <span class="n">PMC551_DRAM_BLK_SET_ROW_MUX</span><span class="p">(</span><span class="n">dram_data</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK3</span><span class="p">,</span> <span class="n">dram_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Oops .. something went wrong</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_MTD_PMC551_BUGFIX */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_BASE_ADDRESS_SPACE_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Precharge Dram</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_MA</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_CMD</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until command has gone through</span>
<span class="cm">	 * FIXME: register spinning issue</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">PCI_COMMAND_IO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn on auto refresh</span>
<span class="cm">	 * The loop is taken directly from Ramix&#39;s example code.  I assume that</span>
<span class="cm">	 * this must be held high for some duration of time, but I can find no</span>
<span class="cm">	 * documentation refrencing the reasons why.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_CMD</span><span class="p">,</span> <span class="mh">0x0df</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make certain command has gone through</span>
<span class="cm">		 * FIXME: register spinning issue</span>
<span class="cm">		 */</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">PCI_COMMAND_IO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_MA</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_CMD</span><span class="p">,</span> <span class="mh">0x0ff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until command completes</span>
<span class="cm">	 * FIXME: register spinning issue</span>
<span class="cm">	 */</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SDRAM_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">PCI_COMMAND_IO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcmd</span><span class="p">);</span>
	<span class="n">dcmd</span> <span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_CFG</span><span class="p">,</span> <span class="n">dcmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to make certain fast back-to-back, if not</span>
<span class="cm">	 * then set it so</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_FAST_BACK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_FAST_BACK</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to make certain the DEVSEL is set correctly, this device</span>
<span class="cm">	 * has a tendency to assert DEVSEL and TRDY when a write is performed</span>
<span class="cm">	 * to the memory when memory is read-only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_DEVSEL_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_STATUS_DEVSEL_MASK</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set to be prefetchable and put everything back based on old cfg.</span>
<span class="cm">	 * it&#39;s possible that the reset of the V370PDC nuked the original</span>
<span class="cm">	 * setup</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	   cfg |= PCI_BASE_ADDRESS_MEM_PREFETCH;</span>
<span class="cm">	   pci_write_config_dword( dev, PCI_BASE_ADDRESS_0, cfg );</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn PCI memory and I/O bus access back on</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
			      <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_IO</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some screen fun</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: %d%sB (0x%x) of %sprefetchable memory at &quot;</span>
		<span class="s">&quot;0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1048576</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span> <span class="o">:</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span>
		<span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1048576</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Ki&quot;</span> <span class="o">:</span> <span class="s">&quot;Mi&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;non-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see the state of the memory</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: DRAM_BLK0 Flags: %s,%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK0 Size: %d at %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK0 Row MUX: %d, Col MUX: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RW&quot;</span> <span class="o">:</span> <span class="s">&quot;RO&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Off&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		<span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dcmd</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FF</span><span class="p">),</span> <span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: DRAM_BLK1 Flags: %s,%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK1 Size: %d at %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK1 Row MUX: %d, Col MUX: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RW&quot;</span> <span class="o">:</span> <span class="s">&quot;RO&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Off&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		<span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dcmd</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FF</span><span class="p">),</span> <span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: DRAM_BLK2 Flags: %s,%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK2 Size: %d at %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK2 Row MUX: %d, Col MUX: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RW&quot;</span> <span class="o">:</span> <span class="s">&quot;RO&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Off&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		<span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dcmd</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FF</span><span class="p">),</span> <span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_DRAM_BLK3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: DRAM_BLK3 Flags: %s,%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK3 Size: %d at %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: DRAM_BLK3 Row MUX: %d, Col MUX: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RW&quot;</span> <span class="o">:</span> <span class="s">&quot;RO&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dcmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Off&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		<span class="n">PMC551_DRAM_BLK_GET_SIZE</span><span class="p">(</span><span class="n">dcmd</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FF</span><span class="p">),</span> <span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">),</span>
		<span class="p">((</span><span class="n">dcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: Memory Access %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: I/O Access %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: Devsel %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="n">PCI_STATUS_DEVSEL_MASK</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Fast&quot;</span> <span class="o">:</span>
		<span class="p">((</span><span class="n">PCI_STATUS_DEVSEL_MASK</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Medium&quot;</span> <span class="o">:</span>
		<span class="p">((</span><span class="n">PCI_STATUS_DEVSEL_MASK</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Slow&quot;</span> <span class="o">:</span> <span class="s">&quot;Invalid&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: %sFast Back-to-Back</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="n">PCI_COMMAND_FAST_BACK</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Not &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_SYS_CTRL_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: EEPROM is under %s control</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: System Control Register is %slocked to PCI access</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;pmc551: System Control Register is %slocked to EEPROM access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bcmd</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;software&quot;</span> <span class="o">:</span> <span class="s">&quot;hardware&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bcmd</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">bcmd</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Kernel version specific module stuffages</span>
<span class="cm"> */</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mark Ferrell &lt;mferrell@mvista.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">PMC551_VERSION</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Stuff these outside the ifdef so as to not bust compiled in driver support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">asize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">msize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msize</span><span class="p">,</span> <span class="s">&quot;memory size in MiB [1 - 1024]&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">asize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">asize</span><span class="p">,</span> <span class="s">&quot;aperture size, must be &lt;= memsize [1-1024]&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * PMC551 Card Initialization</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_pmc551</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mypriv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ffs</span><span class="p">(</span><span class="n">msize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Invalid memory size [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">msize</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">asize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ffs</span><span class="p">(</span><span class="n">asize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Invalid aperture size &quot;</span>
				<span class="s">&quot;[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asize</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PMC551_VERSION</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * PCU-bus chipset probe.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_V3_SEMI</span><span class="p">,</span>
						  <span class="n">PCI_DEVICE_ID_V3_SEMI_V370PDC</span><span class="p">,</span>
						  <span class="n">PCI_Device</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Found PCI V370PDC at 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * The PMC551 device acts VERY weird if you don&#39;t init it</span>
<span class="cm">		 * first.  i.e. it will not correctly report devsel.  If for</span>
<span class="cm">		 * some reason the sdram is in a wrote-protected state the</span>
<span class="cm">		 * device will DEVSEL when it is written to causing problems</span>
<span class="cm">		 * with the oldproc.c driver in</span>
<span class="cm">		 * some kernels (2.2.*)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">=</span> <span class="n">fixup_pmc551</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Cannot init SDRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is needed until the driver is capable of reading the</span>
<span class="cm">		 * onboard I2C SROM to discover the &quot;real&quot; memory size.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">msize</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Using specified memory &quot;</span>
				<span class="s">&quot;size 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msize</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mtd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Cannot allocate new MTD &quot;</span>
				<span class="s">&quot;device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mypriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Cannot allocate new MTD &quot;</span>
				<span class="s">&quot;device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">asize</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: reducing aperture size to &quot;</span>
				<span class="s">&quot;fit %dM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">=</span> <span class="n">asize</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">asize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">asize</span> <span class="o">==</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Using existing aperture &quot;</span>
				<span class="s">&quot;size %dM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">=</span> <span class="n">asize</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Using specified aperture &quot;</span>
				<span class="s">&quot;size %dM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">=</span> <span class="n">asize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Unable to map IO space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: setting aperture to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ffs</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_map0</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMC551_PCI_MEM_MAP_REG_EN</span>
				   <span class="o">|</span> <span class="n">PMC551_PCI_MEM_MAP_ENABLE</span>
				   <span class="o">|</span> <span class="p">(</span><span class="n">ffs</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_map0</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_map0</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMC551_PCI_MEM_MAP0</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_map0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTD_PMC551_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: aperture set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base_map0</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">msize</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MTD_CAP_RAM</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_erase</span> <span class="o">=</span> <span class="n">pmc551_erase</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read</span> <span class="o">=</span> <span class="n">pmc551_read</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write</span> <span class="o">=</span> <span class="n">pmc551_write</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_point</span> <span class="o">=</span> <span class="n">pmc551_point</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unpoint</span> <span class="o">=</span> <span class="n">pmc551_unpoint</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MTD_RAM</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PMC551 RAM board&quot;</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtd_device_register</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: Failed to register new device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Keep a reference as the mtd_device_register worked */</span>
		<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Registered pmc551 memory device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Mapped %dMiB of memory from 0x%p to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Total memory is %d%sB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">?</span> <span class="n">length</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1048576</span><span class="p">)</span> <span class="o">?</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span> <span class="o">:</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span>
			<span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1048576</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Ki&quot;</span> <span class="o">:</span> <span class="s">&quot;Mi&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nextpmc551</span> <span class="o">=</span> <span class="n">pmc551list</span><span class="p">;</span>
		<span class="n">pmc551list</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Exited early, reference left over */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_Device</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc551list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: %d pmc551 devices loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PMC551 Card Cleanup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_pmc551</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mypriv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">pmc551list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="n">pmc551list</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nextpmc551</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pmc551: unmapping %dMiB starting at &quot;</span>
				<span class="s">&quot;0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">asize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
			<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">mtd_device_unregister</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;pmc551: %d pmc551 devices unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_pmc551</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_pmc551</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
