<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › devices › doc2001plus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>doc2001plus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux driver for Disk-On-Chip Millennium Plus</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2002-2003 Greg Ungerer &lt;gerg@snapgear.com&gt;</span>
<span class="cm"> * (c) 2002-2003 SnapGear Inc</span>
<span class="cm"> * (c) 1999 Machine Vision Holdings, Inc.</span>
<span class="cm"> * (c) 1999, 2000 David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Released under GPL</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/errno.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/doc2000.h&gt;</span>

<span class="cm">/* #define ECC_DEBUG */</span>

<span class="cm">/* I have no idea why some DoC chips can not use memcop_form|to_io().</span>
<span class="cm"> * This may be due to the different revisions of the ASIC controller built-in or</span>
<span class="cm"> * simplily a QA/Bug issue. Who knows ?? If you have trouble, please uncomment</span>
<span class="cm"> * this:*/</span>
<span class="cp">#undef USE_MEMCPY</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">doc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">doc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">doc_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">doc_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">doc_erase</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">docmilpluslist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


<span class="cm">/* Perform the required delay cycles by writing to the NOP register */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DoC_Delay</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cycles</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">cycles</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_NOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define	CDSN_CTRL_FR_B_MASK	(CDSN_CTRL_FR_B0 | CDSN_CTRL_FR_B1)</span>

<span class="cm">/* DOC_WaitReady: Wait for RDY line to be asserted by the flash chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_DoC_WaitReady</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;_DoC_WaitReady called for out-of-line wait</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Out-of-line routine to wait for chip response */</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CDSN_CTRL_FR_B_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CDSN_CTRL_FR_B_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">c</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;_DoC_WaitReady timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">DoC_WaitReady</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is inline, to optimise the common case, where it&#39;s ready instantly */</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read form NOP register should be issued prior to the read from CDSNControl</span>
<span class="cm">	   see Software Requirement 11.4 item 2. */</span>
	<span class="n">DoC_Delay</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CDSN_CTRL_FR_B_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CDSN_CTRL_FR_B_MASK</span><span class="p">)</span>
		<span class="cm">/* Call the out-of-line routine to wait */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* For some reason the Millennium Plus seems to occasionally put itself</span>
<span class="cm"> * into reset mode. For me this happens randomly, with no pattern that I</span>
<span class="cm"> * can detect. M-systems suggest always check this on any block level</span>
<span class="cm"> * operation and setting to normal mode if in reset mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">DoC_CheckASIC</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure the DoC is in normal mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_DOCControl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DOC_MODE_NORMAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WriteDOC</span><span class="p">((</span><span class="n">DOC_MODE_NORMAL</span> <span class="o">|</span> <span class="n">DOC_MODE_MDWREN</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_DOCControl</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">DOC_MODE_NORMAL</span> <span class="o">|</span> <span class="n">DOC_MODE_MDWREN</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_CtrlConfirm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* DoC_Command: Send a flash command to the flash chip through the Flash</span>
<span class="cm"> * command register. Need 2 Write Pipeline Terminates to complete send.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DoC_Command</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtraflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashCmd</span><span class="p">);</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DoC_Address: Set the current address for the flash chip through the Flash</span>
<span class="cm"> * Address register. Need 2 Write Pipeline Terminates to complete send.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">DoC_Address</span><span class="p">(</span><span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">doc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numbytes</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtraflags1</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtraflags2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">doc</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>

	<span class="cm">/* Allow for possible Mill Plus internal flash interleaving */</span>
	<span class="n">ofs</span> <span class="o">&gt;&gt;=</span> <span class="n">doc</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">numbytes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Send single byte, bits 0-7. */</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashAddress</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* Send bits 9-16 followed by 17-23 */</span>
		<span class="n">WriteDOC</span><span class="p">((</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashAddress</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">((</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashAddress</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* Send 0-7, 9-16, then 17-23 */</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashAddress</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">((</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashAddress</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">((</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashAddress</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DoC_SelectChip: Select a given flash chip within the current floor */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">DoC_SelectChip</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No choice for flash chip on Millennium Plus */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DoC_SelectFloor: Select a given floor (bank of flash chips) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">DoC_SelectFloor</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">floor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WriteDOC</span><span class="p">((</span><span class="n">floor</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_DeviceSelect</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Translate the given offset into the appropriate command and offset.</span>
<span class="cm"> * This does the mapping using the 16bit interleave layout defined by</span>
<span class="cm"> * M-Systems, and looks like this for a sector pair:</span>
<span class="cm"> *  +-----------+-------+-------+-------+--------------+---------+-----------+</span>
<span class="cm"> *  | 0 --- 511 |512-517|518-519|520-521| 522 --- 1033 |1034-1039|1040 - 1055|</span>
<span class="cm"> *  +-----------+-------+-------+-------+--------------+---------+-----------+</span>
<span class="cm"> *  | Data 0    | ECC 0 |Flags0 |Flags1 | Data 1       |ECC 1    | OOB 1 + 2 |</span>
<span class="cm"> *  +-----------+-------+-------+-------+--------------+---------+-----------+</span>
<span class="cm"> */</span>
<span class="cm">/* FIXME: This lives in INFTL not here. Other users of flash devices</span>
<span class="cm">   may not want it */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">DoC_GetDataOffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ofs</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">&amp;=</span> <span class="mh">0x1ff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">1014</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READ1</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READOOB</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">-</span> <span class="mi">1014</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3ff</span><span class="p">)</span> <span class="o">|</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No interleave */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NAND_CMD_READ1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">DoC_GetECCOffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READOOB</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READ1</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3ff</span><span class="p">)</span> <span class="o">|</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">DoC_GetFlagsOffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READ1</span><span class="p">;</span>
	<span class="n">ofs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
	<span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3ff</span><span class="p">)</span> <span class="o">|</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">DoC_GetHdrOffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">NAND_CMD_READOOB</span><span class="p">;</span>
	<span class="n">ofs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">?</span> <span class="mi">24</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3ff</span><span class="p">)</span> <span class="o">|</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">MemReadDOC</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef USE_MEMCPY</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">docptr</span> <span class="o">+</span> <span class="n">DoC_Mil_CDSN_IO</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">MemWriteDOC</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef USE_MEMCPY</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">docptr</span> <span class="o">+</span> <span class="n">DoC_Mil_CDSN_IO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* DoC_IdentChip: Identify a given NAND chip given {floor,chip} */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">DoC_IdentChip</span><span class="p">(</span><span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">doc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">floor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mfr</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">doc</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>

	<span class="cm">/* Page in the required floor/chip */</span>
	<span class="n">DoC_SelectFloor</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">floor</span><span class="p">);</span>
	<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
	<span class="n">WriteDOC</span><span class="p">((</span><span class="n">DOC_FLASH_CE</span> <span class="o">|</span> <span class="n">DOC_FLASH_WP</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="cm">/* Reset the chip, see Software Requirement 11.4 item 1. */</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Read the NAND chip ID: 1. Send ReadID command */</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_READID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Read the NAND chip ID: 2. Send address byte zero */</span>
	<span class="n">DoC_Address</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashControl</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Read the manufacturer and device id codes of the flash device through</span>
<span class="cm">	   CDSN IO register see Software Requirement 11.4 item 5.*/</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>

	<span class="n">mfr</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doc</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">)</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="p">);</span> <span class="cm">/* 2 way interleave */</span>

	<span class="n">id</span>  <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doc</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">)</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="p">);</span> <span class="cm">/* 2 way interleave */</span>

	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>

	<span class="cm">/* Disable flash internally */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="cm">/* No response - return failure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfr</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">mfr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Try to identify manufacturer */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">mfr</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Flash chip found: Manufacturer ID: %2.2X, &quot;</span>
			       <span class="s">&quot;Chip ID: %2.2X (%s:%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mfr</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
			       <span class="n">nand_manuf_ids</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="n">doc</span><span class="o">-&gt;</span><span class="n">mfr</span> <span class="o">=</span> <span class="n">mfr</span><span class="p">;</span>
			<span class="n">doc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="n">doc</span><span class="o">-&gt;</span><span class="n">chipshift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipsize</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">doc</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">erasesize</span> <span class="o">&lt;&lt;</span> <span class="n">doc</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nand_flash_ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DoC_ScanChips: Find all NAND chips present in a DiskOnChip, and identify them */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DoC_ScanChips</span><span class="p">(</span><span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">floor</span><span class="p">,</span> <span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numchips</span><span class="p">[</span><span class="n">MAX_FLOORS_MPLUS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mfr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Work out the intended interleave setting */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">ChipID</span> <span class="o">==</span> <span class="n">DOC_ChipID_DocMilPlus32</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check the ASIC agrees */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="p">(</span><span class="n">ReadDOC</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_Configuration</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_Configuration</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Setting DiskOnChip Millennium Plus interleave to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="o">?</span><span class="s">&quot;on (16-bit)&quot;</span><span class="o">:</span><span class="s">&quot;off (8-bit)&quot;</span><span class="p">);</span>
		<span class="n">conf</span> <span class="o">^=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_Configuration</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For each floor, find the number of valid chips it contains */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">floor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">floor</span> <span class="o">&lt;</span> <span class="n">MAX_FLOORS_MPLUS</span><span class="p">;</span> <span class="n">floor</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">numchips</span><span class="p">[</span><span class="n">floor</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">MAX_CHIPS_MPLUS</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">DoC_IdentChip</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">numchips</span><span class="p">[</span><span class="n">floor</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* If there are none at all that we recognise, bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;No flash chips recognised.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate an array to hold the information for each chip */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Nand</span><span class="p">)</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MTD: No memory for allocating chip info structures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill out the chip array with {floor, chipno} for each</span>
<span class="cm">	 * detected chip in the device. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">floor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">floor</span> <span class="o">&lt;</span> <span class="n">MAX_FLOORS_MPLUS</span><span class="p">;</span> <span class="n">floor</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">numchips</span><span class="p">[</span><span class="n">floor</span><span class="p">]</span> <span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">floor</span> <span class="o">=</span> <span class="n">floor</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">curadr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">curmode</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="n">ret</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate and print the total size of the device */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipshift</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%d flash chips found. Total DiskOnChip size: %ld MiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">this</span><span class="o">-&gt;</span><span class="n">numchips</span> <span class="p">,</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">totlen</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DoCMilPlus_is_alias</span><span class="p">(</span><span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">doc1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">doc2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doc1</span><span class="o">-&gt;</span><span class="n">physadr</span> <span class="o">==</span> <span class="n">doc2</span><span class="o">-&gt;</span><span class="n">physadr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Use the alias resolution register which was set aside for this</span>
<span class="cm">	 * purpose. If it&#39;s value is the same on both chips, they might</span>
<span class="cm">	 * be the same chip, and we write to one and check for a change in</span>
<span class="cm">	 * the other. It&#39;s unclear if this register is usuable in the</span>
<span class="cm">	 * DoC 2000 (it&#39;s in the Millennium docs), but it seems to work. */</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">doc1</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_AliasResolution</span><span class="p">);</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">doc2</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_AliasResolution</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">!=</span> <span class="n">tmp2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WriteDOC</span><span class="p">((</span><span class="n">tmp1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">doc1</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_AliasResolution</span><span class="p">);</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">doc2</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_AliasResolution</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">==</span> <span class="p">(</span><span class="n">tmp1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Restore register contents.  May not be necessary, but do it just to</span>
<span class="cm">	 * be safe. */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">doc1</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">,</span> <span class="n">Mplus_AliasResolution</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine is found from the docprobe code by symbol_get(),</span>
<span class="cm"> * which will bump the use count of this module. */</span>
<span class="kt">void</span> <span class="nf">DoCMilPlus_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* We must avoid being called twice for the same device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">docmilpluslist</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">docmilpluslist</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DoCMilPlus_is_alias</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Ignoring DiskOnChip Millennium &quot;</span>
				<span class="s">&quot;Plus at 0x%lX - already configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">physadr</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">nextdoc</span><span class="p">)</span>
			<span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">nextdoc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiskOnChip Millennium Plus&quot;</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;DiskOnChip Millennium Plus found at &quot;</span>
		<span class="s">&quot;address 0x%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">physadr</span><span class="p">);</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MTD_NANDFLASH</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MTD_CAP_NANDFLASH</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writebufsize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_strength</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_erase</span> <span class="o">=</span> <span class="n">doc_erase</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read</span> <span class="o">=</span> <span class="n">doc_read</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write</span> <span class="o">=</span> <span class="n">doc_write</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_oob</span> <span class="o">=</span> <span class="n">doc_read_oob</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write_oob</span> <span class="o">=</span> <span class="n">doc_write_oob</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Ident all the chips present. */</span>
	<span class="n">DoC_ScanChips</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">nextdoc</span> <span class="o">=</span> <span class="n">docmilpluslist</span><span class="p">;</span>
		<span class="n">docmilpluslist</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span>  <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">;</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>
		<span class="n">mtd_device_register</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">DoCMilPlus_init</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int doc_dumpblk(struct mtd_info *mtd, loff_t from)</span>
<span class="c">{</span>
<span class="c">	int i;</span>
<span class="c">	loff_t fofs;</span>
<span class="c">	struct DiskOnChip *this = mtd-&gt;priv;</span>
<span class="c">	void __iomem * docptr = this-&gt;virtadr;</span>
<span class="c">	struct Nand *mychip = &amp;this-&gt;chips[from &gt;&gt; (this-&gt;chipshift)];</span>
<span class="c">	unsigned char *bp, buf[1056];</span>
<span class="c">	char c[32];</span>

<span class="c">	from &amp;= ~0x3ff;</span>

<span class="c">	/* Don&#39;t allow read past end of device */</span>
<span class="c">	if (from &gt;= this-&gt;totlen)</span>
<span class="c">		return -EINVAL;</span>

<span class="c">	DoC_CheckASIC(docptr);</span>

<span class="c">	/* Find the chip which is to be used and select it */</span>
<span class="c">	if (this-&gt;curfloor != mychip-&gt;floor) {</span>
<span class="c">		DoC_SelectFloor(docptr, mychip-&gt;floor);</span>
<span class="c">		DoC_SelectChip(docptr, mychip-&gt;chip);</span>
<span class="c">	} else if (this-&gt;curchip != mychip-&gt;chip) {</span>
<span class="c">		DoC_SelectChip(docptr, mychip-&gt;chip);</span>
<span class="c">	}</span>
<span class="c">	this-&gt;curfloor = mychip-&gt;floor;</span>
<span class="c">	this-&gt;curchip = mychip-&gt;chip;</span>

<span class="c">	/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
<span class="c">	WriteDOC((DOC_FLASH_CE | DOC_FLASH_WP), docptr, Mplus_FlashSelect);</span>

<span class="c">	/* Reset the chip, see Software Requirement 11.4 item 1. */</span>
<span class="c">	DoC_Command(docptr, NAND_CMD_RESET, 0);</span>
<span class="c">	DoC_WaitReady(docptr);</span>

<span class="c">	fofs = from;</span>
<span class="c">	DoC_Command(docptr, DoC_GetDataOffset(mtd, &amp;fofs), 0);</span>
<span class="c">	DoC_Address(this, 3, fofs, 0, 0x00);</span>
<span class="c">	WriteDOC(0, docptr, Mplus_FlashControl);</span>
<span class="c">	DoC_WaitReady(docptr);</span>

<span class="c">	/* disable the ECC engine */</span>
<span class="c">	WriteDOC(DOC_ECC_RESET, docptr, Mplus_ECCConf);</span>

<span class="c">	ReadDOC(docptr, Mplus_ReadPipeInit);</span>
<span class="c">	ReadDOC(docptr, Mplus_ReadPipeInit);</span>

<span class="c">	/* Read the data via the internal pipeline through CDSN IO</span>
<span class="c">	   register, see Pipelined Read Operations 11.3 */</span>
<span class="c">	MemReadDOC(docptr, buf, 1054);</span>
<span class="c">	buf[1054] = ReadDOC(docptr, Mplus_LastDataRead);</span>
<span class="c">	buf[1055] = ReadDOC(docptr, Mplus_LastDataRead);</span>

<span class="c">	memset(&amp;c[0], 0, sizeof(c));</span>
<span class="c">	printk(&quot;DUMP OFFSET=%x:\n&quot;, (int)from);</span>

<span class="c">        for (i = 0, bp = &amp;buf[0]; (i &lt; 1056); i++) {</span>
<span class="c">                if ((i % 16) == 0)</span>
<span class="c">                        printk(&quot;%08x: &quot;, i);</span>
<span class="c">                printk(&quot; %02x&quot;, *bp);</span>
<span class="c">                c[(i &amp; 0xf)] = ((*bp &gt;= 0x20) &amp;&amp; (*bp &lt;= 0x7f)) ? *bp : &#39;.&#39;;</span>
<span class="c">                bp++;</span>
<span class="c">                if (((i + 1) % 16) == 0)</span>
<span class="c">                        printk(&quot;    %s\n&quot;, c);</span>
<span class="c">        }</span>
<span class="c">	printk(&quot;\n&quot;);</span>

<span class="c">	/* Disable flash internally */</span>
<span class="c">	WriteDOC(0, docptr, Mplus_FlashSelect);</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">doc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">fofs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">syndrome</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Nand</span> <span class="o">*</span><span class="n">mychip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chipshift</span><span class="p">)];</span>

	<span class="cm">/* Don&#39;t allow a single read to cross a 512-byte block boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">from</span> <span class="o">|</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">from</span> <span class="o">|</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">from</span><span class="p">;</span>

	<span class="n">DoC_CheckASIC</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Find the chip which is to be used and select it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectFloor</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">);</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="cm">/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
	<span class="n">WriteDOC</span><span class="p">((</span><span class="n">DOC_FLASH_CE</span> <span class="o">|</span> <span class="n">DOC_FLASH_WP</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="cm">/* Reset the chip, see Software Requirement 11.4 item 1. */</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="n">fofs</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">DoC_GetDataOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DoC_Address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fofs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashControl</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* init the ECC engine, see Reed-Solomon EDC/ECC 11.1 .*/</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_RESET</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_EN</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

	<span class="cm">/* Let the caller know we completed it */</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
	<span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>

	<span class="cm">/* Read the data via the internal pipeline through CDSN IO</span>
<span class="cm">	   register, see Pipelined Read Operations 11.3 */</span>
	<span class="n">MemReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Read the ECC data following raw data */</span>
	<span class="n">MemReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">eccbuf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">eccbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>
	<span class="n">eccbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>

	<span class="cm">/* Flush the pipeline */</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

	<span class="cm">/* Check the ECC Status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nb_errors</span><span class="p">;</span>
		<span class="cm">/* There was an ECC error */</span>
<span class="cp">#ifdef ECC_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DiskOnChip ECC Error: Read at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">from</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Read the ECC syndrome through the DiskOnChip ECC logic.</span>
<span class="cm">		   These syndrome will be all ZERO when there is no error */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">syndrome</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCSyndrome0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">nb_errors</span> <span class="o">=</span> <span class="n">doc_decode_ecc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">syndrome</span><span class="p">);</span>
<span class="cp">#ifdef ECC_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ECC Errors corrected: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nb_errors</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nb_errors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We return error, but have actually done the</span>
<span class="cm">			   read. Not that this can be told to user-space, via</span>
<span class="cm">			   sys_read(), but at least MTD-aware stuff can know</span>
<span class="cm">			   about it by checking *retlen */</span>
<span class="cp">#ifdef ECC_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): Millennium Plus ECC error (from=0x%x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">from</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;        syndrome= %02x:%02x:%02x:%02x:%02x:&quot;</span>
				<span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">syndrome</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">syndrome</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">syndrome</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">syndrome</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">syndrome</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">syndrome</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;          eccbuf= %02x:%02x:%02x:%02x:%02x:&quot;</span>
				<span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">eccbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">eccbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="cp">#endif</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef PSYCHO_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ECC DATA at %lx: %2.2X %2.2X %2.2X %2.2X %2.2X %2.2X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">from</span><span class="p">,</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	       <span class="n">eccbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="cm">/* disable the ECC engine */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_DIS</span><span class="p">,</span> <span class="n">docptr</span> <span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

	<span class="cm">/* Disable flash internally */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">doc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">fto</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Nand</span> <span class="o">*</span><span class="n">mychip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">to</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chipshift</span><span class="p">)];</span>

	<span class="cm">/* Don&#39;t allow writes which aren&#39;t exactly one block (512 bytes) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">to</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mh">0x200</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Determine position of OOB flags, before or after data */</span>
	<span class="n">before</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">to</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">));</span>

	<span class="n">DoC_CheckASIC</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Find the chip which is to be used and select it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectFloor</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">);</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="cm">/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_FLASH_CE</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="cm">/* Reset the chip, see Software Requirement 11.4 item 1. */</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Set device to appropriate plane of flash */</span>
	<span class="n">fto</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DoC_GetDataOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fto</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashCmd</span><span class="p">);</span>

	<span class="cm">/* On interleaved devices the flags for 2nd half 512 are before data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">before</span><span class="p">)</span>
		<span class="n">fto</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* issue the Serial Data In command to initial the Page Program process */</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_SEQIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DoC_Address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fto</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Disable the ECC engine */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_RESET</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">before</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write the block status BLOCK_USED (0x5555) */</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* init the ECC engine, see Reed-Solomon EDC/ECC 11.1 .*/</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_EN</span> <span class="o">|</span> <span class="n">DOC_ECC_RW</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

	<span class="n">MemWriteDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Write ECC data to flash, the ECC info is generated by</span>
<span class="cm">	   the DiskOnChip ECC logic see Reed-Solomon EDC/ECC 11.1 */</span>
	<span class="n">DoC_Delay</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Read the ECC data through the DiskOnChip ECC logic */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">eccbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCSyndrome0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* disable the ECC engine */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_DIS</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

	<span class="cm">/* Write the ECC data to flash */</span>
	<span class="n">MemWriteDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">eccbuf</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">before</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write the block status BLOCK_USED (0x5555) */</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="o">+</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mil_CDSN_IO</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef PSYCHO_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;OOB data at %lx is %2.2X %2.2X %2.2X %2.2X %2.2X %2.2X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">to</span><span class="p">,</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	       <span class="n">eccbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">eccbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>

	<span class="cm">/* Commit the Page Program command and wait for ready</span>
<span class="cm">	   see Software Requirement 11.4 item 1.*/</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_PAGEPROG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Read the status of the flash device through CDSN IO register</span>
<span class="cm">	   see Software Requirement 11.4 item 5.*/</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
	<span class="n">DoC_Delay</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MTD: Error 0x%x programming at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">to</span><span class="p">);</span>
		<span class="cm">/* Error in programming</span>
<span class="cm">		   FIXME: implement Bad Block Replacement (in nftl.c ??) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>

	<span class="cm">/* Disable flash internally */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="cm">/* Let the caller know we completed it */</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">doc_read_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">fofs</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Nand</span> <span class="o">*</span><span class="n">mychip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipshift</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">);</span>

	<span class="n">ofs</span> <span class="o">+=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>

	<span class="n">DoC_CheckASIC</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Find the chip which is to be used and select it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectFloor</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">);</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="cm">/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
	<span class="n">WriteDOC</span><span class="p">((</span><span class="n">DOC_FLASH_CE</span> <span class="o">|</span> <span class="n">DOC_FLASH_WP</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="cm">/* disable the ECC engine */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_RESET</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Maximum of 16 bytes in the OOB region, so limit read to that */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">want</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">want</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Figure out which region we are accessing... */</span>
		<span class="n">fofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_READOOB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">DoC_GetECCOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">DoC_GetFlagsOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">DoC_GetHdrOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">want</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">want</span><span class="p">;</span>

		<span class="cm">/* Issue read command */</span>
		<span class="n">DoC_Address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fofs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashControl</span><span class="p">);</span>
		<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

		<span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
		<span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
		<span class="n">MemReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">got</span><span class="p">],</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">got</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">got</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>

		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">got</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">want</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable flash internally */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">doc_write_oob</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">fofs</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Nand</span> <span class="o">*</span><span class="n">mychip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipshift</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MTD_OPS_PLACE_OOB</span><span class="p">);</span>

	<span class="n">ofs</span> <span class="o">+=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ooboffs</span><span class="p">;</span>

	<span class="n">DoC_CheckASIC</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="cm">/* Find the chip which is to be used and select it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectFloor</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">);</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="cm">/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_FLASH_CE</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>


	<span class="cm">/* Maximum of 16 bytes in the OOB region, so limit write to that */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">want</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">want</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset the chip, see Software Requirement 11.4 item 1. */</span>
		<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

		<span class="cm">/* Figure out which region we are accessing... */</span>
		<span class="n">fofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">interleave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WriteDOC</span><span class="p">(</span><span class="n">NAND_CMD_READOOB</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashCmd</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DoC_GetECCOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashCmd</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DoC_GetFlagsOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashCmd</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DoC_GetHdrOffset</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fofs</span><span class="p">),</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashCmd</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">want</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">want</span><span class="p">;</span>

		<span class="cm">/* Issue the Serial Data In command to initial the Page Program process */</span>
		<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_SEQIN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">DoC_Address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fofs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* Disable the ECC engine */</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_ECC_RESET</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ECCConf</span><span class="p">);</span>

		<span class="cm">/* Write the data via the internal pipeline through CDSN IO</span>
<span class="cm">		   register, see Pipelined Write Operations 11.2 */</span>
		<span class="n">MemWriteDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">got</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>
		<span class="n">WriteDOC</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_WritePipeTerm</span><span class="p">);</span>

		<span class="cm">/* Commit the Page Program command and wait for ready</span>
<span class="cm">	 	   see Software Requirement 11.4 item 1.*/</span>
		<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_PAGEPROG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

		<span class="cm">/* Read the status of the flash device through CDSN IO register</span>
<span class="cm">		   see Software Requirement 11.4 item 5.*/</span>
		<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
		<span class="n">DoC_Delay</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MTD: Error 0x%x programming oob at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dummy</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ofs</span><span class="p">);</span>
			<span class="cm">/* FIXME: implement Bad Block Replacement */</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>

		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">got</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">want</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable flash internally */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">doc_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ofs</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">docptr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Nand</span> <span class="o">*</span><span class="n">mychip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">[</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chipshift</span><span class="p">];</span>

	<span class="n">DoC_CheckASIC</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MTD: Erase not right size (%x != %x)n&quot;</span><span class="p">,</span>
		       <span class="n">len</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">);</span>

	<span class="cm">/* Find the chip which is to be used and select it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectFloor</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">);</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">!=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DoC_SelectChip</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curfloor</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">floor</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">curchip</span> <span class="o">=</span> <span class="n">mychip</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_PENDING</span><span class="p">;</span>

	<span class="cm">/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="n">DOC_FLASH_CE</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_RESET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>

	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DoC_Address</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_ERASE2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DoC_WaitReady</span><span class="p">(</span><span class="n">docptr</span><span class="p">);</span>
	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASING</span><span class="p">;</span>

	<span class="cm">/* Read the status of the flash device through CDSN IO register</span>
<span class="cm">	   see Software Requirement 11.4 item 5. */</span>
	<span class="n">DoC_Command</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">NAND_CMD_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_ReadPipeInit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MTD: Error 0x%x erasing at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="cm">/* FIXME: implement Bad Block Replacement (in nftl.c ??) */</span>
		<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_DONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">ReadDOC</span><span class="p">(</span><span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_LastDataRead</span><span class="p">);</span>

	<span class="cm">/* Disable flash internally */</span>
	<span class="n">WriteDOC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">docptr</span><span class="p">,</span> <span class="n">Mplus_FlashSelect</span><span class="p">);</span>

	<span class="n">mtd_erase_callback</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Module stuff</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_doc2001plus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DiskOnChip</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">mtd</span><span class="o">=</span><span class="n">docmilpluslist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="n">docmilpluslist</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">nextdoc</span><span class="p">;</span>

		<span class="n">mtd_device_unregister</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">virtadr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chips</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_doc2001plus</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Greg Ungerer &lt;gerg@snapgear.com&gt; et al.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for DiskOnChip Millennium Plus&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
