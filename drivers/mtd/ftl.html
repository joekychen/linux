<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › ftl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ftl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* This version ported to the Linux-MTD system by dwmw2@infradead.org</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes: Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> * - fixes some leaks on failure in build_maps and ftl_notify_add, cleanups</span>
<span class="cm"> *</span>
<span class="cm"> * Based on:</span>
<span class="cm"> */</span>
<span class="cm">/*======================================================================</span>

<span class="cm">    A Flash Translation Layer memory card driver</span>

<span class="cm">    This driver implements a disk-like block device driver with an</span>
<span class="cm">    apparent block size of 512 bytes for flash memory cards.</span>

<span class="cm">    ftl_cs.c 1.62 2000/02/01 00:59:04</span>

<span class="cm">    The contents of this file are subject to the Mozilla Public</span>
<span class="cm">    License Version 1.1 (the &quot;License&quot;); you may not use this file</span>
<span class="cm">    except in compliance with the License. You may obtain a copy of</span>
<span class="cm">    the License at http://www.mozilla.org/MPL/</span>

<span class="cm">    Software distributed under the License is distributed on an &quot;AS</span>
<span class="cm">    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or</span>
<span class="cm">    implied. See the License for the specific language governing</span>
<span class="cm">    rights and limitations under the License.</span>

<span class="cm">    The initial developer of the original code is David A. Hinds</span>
<span class="cm">    &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds</span>
<span class="cm">    are Copyright © 1999 David A. Hinds.  All Rights Reserved.</span>

<span class="cm">    Alternatively, the contents of this file may be used under the</span>
<span class="cm">    terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in</span>
<span class="cm">    which case the provisions of the GPL are applicable instead of the</span>
<span class="cm">    above.  If you wish to allow the use of your version of this file</span>
<span class="cm">    only under the terms of the GPL and not to allow others to use</span>
<span class="cm">    your version of this file under the MPL, indicate your decision</span>
<span class="cm">    by deleting the provisions above and replace them with the notice</span>
<span class="cm">    and other provisions required by the GPL.  If you do not delete</span>
<span class="cm">    the provisions above, a recipient may use your version of this</span>
<span class="cm">    file under either the MPL or the GPL.</span>

<span class="cm">    LEGAL NOTE: The FTL format is patented by M-Systems.  They have</span>
<span class="cm">    granted a license for its use with PCMCIA devices:</span>

<span class="cm">     &quot;M-Systems grants a royalty-free, non-exclusive license under</span>
<span class="cm">      any presently existing M-Systems intellectual property rights</span>
<span class="cm">      necessary for the design and development of FTL-compatible</span>
<span class="cm">      drivers, file systems and utilities using the data formats with</span>
<span class="cm">      PCMCIA PC Cards as described in the PCMCIA Flash Translation</span>
<span class="cm">      Layer (FTL) Specification.&quot;</span>

<span class="cm">    Use of the FTL format for non-PCMCIA applications may be an</span>
<span class="cm">    infringement of these patents.  For additional information,</span>
<span class="cm">    contact M-Systems directly. M-Systems since acquired by Sandisk. </span>

<span class="cm">======================================================================*/</span>
<span class="cp">#include &lt;linux/mtd/blktrans.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cm">/*#define PSYCHO_DEBUG */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/mtd/ftl.h&gt;</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Parameters that can be set with &#39;insmod&#39; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">shuffle_freq</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">shuffle_freq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Major device # for FTL device */</span>
<span class="cp">#ifndef FTL_MAJOR</span>
<span class="cp">#define FTL_MAJOR	44</span>
<span class="cp">#endif</span>


<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Maximum number of separate memory devices we&#39;ll allow */</span>
<span class="cp">#define MAX_DEV		4</span>

<span class="cm">/* Maximum number of regions per device */</span>
<span class="cp">#define MAX_REGION	4</span>

<span class="cm">/* Maximum number of partitions in an FTL region */</span>
<span class="cp">#define PART_BITS	4</span>

<span class="cm">/* Maximum number of outstanding erase requests per socket */</span>
<span class="cp">#define MAX_ERASE	8</span>

<span class="cm">/* Sector size -- shouldn&#39;t need to change */</span>
<span class="cp">#define SECTOR_SIZE	512</span>


<span class="cm">/* Each memory region corresponds to a minor device */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">partition_t</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="n">mbd</span><span class="p">;</span>
    <span class="kt">uint32_t</span>		<span class="n">state</span><span class="p">;</span>
    <span class="kt">uint32_t</span>		<span class="o">*</span><span class="n">VirtualBlockMap</span><span class="p">;</span>
    <span class="kt">uint32_t</span>		<span class="o">*</span><span class="n">VirtualPageMap</span><span class="p">;</span>
    <span class="kt">uint32_t</span>		<span class="n">FreeTotal</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">eun_info_t</span> <span class="p">{</span>
	<span class="kt">uint32_t</span>		<span class="n">Offset</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">EraseCount</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">Free</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">Deleted</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">*</span><span class="n">EUNInfo</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">xfer_info_t</span> <span class="p">{</span>
	<span class="kt">uint32_t</span>		<span class="n">Offset</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">EraseCount</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">state</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">*</span><span class="n">XferInfo</span><span class="p">;</span>
    <span class="kt">uint16_t</span>		<span class="n">bam_index</span><span class="p">;</span>
    <span class="kt">uint32_t</span>		<span class="o">*</span><span class="n">bam_cache</span><span class="p">;</span>
    <span class="kt">uint16_t</span>		<span class="n">DataUnits</span><span class="p">;</span>
    <span class="kt">uint32_t</span>		<span class="n">BlocksPerUnit</span><span class="p">;</span>
    <span class="n">erase_unit_header_t</span>	<span class="n">header</span><span class="p">;</span>
<span class="p">}</span> <span class="n">partition_t</span><span class="p">;</span>

<span class="cm">/* Partition state flags */</span>
<span class="cp">#define FTL_FORMATTED	0x01</span>

<span class="cm">/* Transfer unit states */</span>
<span class="cp">#define XFER_UNKNOWN	0x00</span>
<span class="cp">#define XFER_ERASING	0x01</span>
<span class="cp">#define XFER_ERASED	0x02</span>
<span class="cp">#define XFER_PREPARED	0x03</span>
<span class="cp">#define XFER_FAILED	0x04</span>

<span class="cm">/*====================================================================*/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">ftl_erase_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">done</span><span class="p">);</span>


<span class="cm">/*======================================================================</span>

<span class="cm">    Scan_header() checks to see if a memory region contains an FTL</span>
<span class="cm">    partition.  build_maps() reads all the erase unit headers, builds</span>
<span class="cm">    the erase unit map, and then builds the virtual page map.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_header</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">erase_unit_header_t</span> <span class="n">header</span><span class="p">;</span>
    <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">max_offset</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x100000</span><span class="o">&lt;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span><span class="o">?</span><span class="mh">0x100000</span><span class="o">:</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
    <span class="cm">/* Search first megabyte for a valid FTL header */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">max_offset</span><span class="p">;</span>
	 <span class="n">offset</span> <span class="o">+=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span> <span class="o">?</span> <span class="o">:</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span>
                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">DataOrgTuple</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;FTL100&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">max_offset</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: FTL header not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">BlockSize</span> <span class="o">!=</span> <span class="mi">9</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span> <span class="o">&gt;=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">NumEraseUnits</span><span class="p">)))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: FTL header corrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">)</span> <span class="o">!=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl: FTL EraseUnitSize %x != MTD erasesize %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">,</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_maps</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">erase_unit_header_t</span> <span class="n">header</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">xvalid</span><span class="p">,</span> <span class="n">xtrans</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hdr_ok</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
    <span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>

    <span class="cm">/* Set up erase unit maps */</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumEraseUnits</span><span class="p">)</span> <span class="o">-</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eun_info_t</span><span class="p">),</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Offset</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span> <span class="o">=</span>
	<span class="n">kmalloc</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfer_info_t</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">out_EUNInfo</span><span class="p">;</span>

    <span class="n">xvalid</span> <span class="o">=</span> <span class="n">xtrans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumEraseUnits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FirstPhysicalEUN</span><span class="p">))</span>
		      <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retval</span><span class="p">,</span>
                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">out_XferInfo</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Is this a transfer partition? */</span>
	<span class="n">hdr_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">DataOrgTuple</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;FTL100&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr_ok</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">LogicalEUN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">LogicalEUN</span><span class="p">)].</span><span class="n">Offset</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">LogicalEUN</span><span class="p">)].</span><span class="n">Offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">LogicalEUN</span><span class="p">)].</span><span class="n">EraseCount</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">EraseCount</span><span class="p">);</span>
	    <span class="n">xvalid</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">xtrans</span> <span class="o">==</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: format error: too many &quot;</span>
		       <span class="s">&quot;transfer units!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_XferInfo</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">hdr_ok</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">LogicalEUN</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xtrans</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_PREPARED</span><span class="p">;</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xtrans</span><span class="p">].</span><span class="n">EraseCount</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">EraseCount</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xtrans</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_UNKNOWN</span><span class="p">;</span>
		<span class="cm">/* Pick anything reasonable for the erase count */</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xtrans</span><span class="p">].</span><span class="n">EraseCount</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseCount</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xtrans</span><span class="p">].</span><span class="n">Offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	    <span class="n">xtrans</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* Check for format trouble */</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">xtrans</span> <span class="o">!=</span> <span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">xvalid</span><span class="o">+</span><span class="n">xtrans</span> <span class="o">!=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">NumEraseUnits</span><span class="p">)))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: format error: erase units &quot;</span>
	       <span class="s">&quot;don&#39;t add up!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_XferInfo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Set up virtual page map */</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">header</span><span class="p">.</span><span class="n">BlockSize</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">blocks</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">out_XferInfo</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">header</span><span class="p">.</span><span class="n">BlockSize</span><span class="p">;</span>

    <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">out_VirtualBlockMap</span><span class="p">;</span>

    <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                       <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retval</span><span class="p">,</span>
                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bam_cache</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">BLOCK_FREE</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span> <span class="p">{</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Free</span><span class="o">++</span><span class="p">;</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">BLOCK_TYPE</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">==</span> <span class="n">BLOCK_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">BLOCK_NUMBER</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">))</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">BLOCK_NUMBER</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">j</span><span class="p">]))]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="p">.</span><span class="n">BlockSize</span><span class="p">);</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BLOCK_DELETED</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Deleted</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_bam_cache:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">);</span>
<span class="nl">out_VirtualBlockMap:</span>
    <span class="n">vfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">);</span>
<span class="nl">out_XferInfo:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">);</span>
<span class="nl">out_EUNInfo:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">);</span>
<span class="nl">out:</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* build_maps */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Erase_xfer() schedules an asynchronous erase operation for a</span>
<span class="cm">    transfer unit.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">erase_xfer</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span>
		      <span class="kt">uint16_t</span> <span class="n">xfernum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">xfer_info_t</span> <span class="o">*</span><span class="n">xfer</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">erase</span><span class="p">;</span>

    <span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xfernum</span><span class="p">];</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: erasing xfer unit at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">);</span>
    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_ERASING</span><span class="p">;</span>

    <span class="cm">/* Is there a free erase slot? Always in MTD. */</span>


    <span class="n">erase</span><span class="o">=</span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">erase_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">erase</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">erase</span><span class="o">-&gt;</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">;</span>
    <span class="n">erase</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ftl_erase_callback</span><span class="p">;</span>
    <span class="n">erase</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">;</span>
    <span class="n">erase</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">;</span>
    <span class="n">erase</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">part</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_erase</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">erase</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
	    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">EraseCount</span><span class="o">++</span><span class="p">;</span>
    <span class="k">else</span>
	    <span class="n">kfree</span><span class="p">(</span><span class="n">erase</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* erase_xfer */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Prepare_xfer() takes a freshly erased transfer unit and gives</span>
<span class="cm">    it an appropriate header.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ftl_erase_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">erase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">xfer_info_t</span> <span class="o">*</span><span class="n">xfer</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="cm">/* Look up the transfer unit */</span>
    <span class="n">part</span> <span class="o">=</span> <span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">erase</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Offset</span> <span class="o">==</span> <span class="n">erase</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: internal error: &quot;</span>
	       <span class="s">&quot;erase lookup failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">erase</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">MTD_ERASE_DONE</span><span class="p">)</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_ERASED</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">xfer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_FAILED</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: erase failed: state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">erase</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">kfree</span><span class="p">(</span><span class="n">erase</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* ftl_erase_callback */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prepare_xfer</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">erase_unit_header_t</span> <span class="n">header</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">xfer_info_t</span> <span class="o">*</span><span class="n">xfer</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nbam</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">ctl</span><span class="p">;</span>
    <span class="kt">ssize_t</span> <span class="n">retlen</span><span class="p">;</span>
    <span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>

    <span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_FAILED</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: preparing xfer unit at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">);</span>

    <span class="cm">/* Write the transfer unit header */</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
    <span class="n">header</span><span class="p">.</span><span class="n">LogicalEUN</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
    <span class="n">header</span><span class="p">.</span><span class="n">EraseCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">xfer</span><span class="o">-&gt;</span><span class="n">EraseCount</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Write the BAM stub */</span>
    <span class="n">nbam</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">)</span> <span class="o">+</span> <span class="n">SECTOR_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">);</span>
    <span class="n">ctl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BLOCK_CONTROL</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbam</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="p">{</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_PREPARED</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span> <span class="cm">/* prepare_xfer */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Copy_erase_unit() takes a full erase block and a transfer unit,</span>
<span class="cm">    copies everything to the transfer unit, then swaps the block</span>
<span class="cm">    pointers.</span>

<span class="cm">    All data blocks are copied to the corresponding blocks in the</span>
<span class="cm">    target unit, so the virtual block map does not need to be</span>
<span class="cm">    updated.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_erase_unit</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">srcunit</span><span class="p">,</span>
			   <span class="kt">uint16_t</span> <span class="n">xferunit</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SECTOR_SIZE</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">eun_info_t</span> <span class="o">*</span><span class="n">eun</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">xfer_info_t</span> <span class="o">*</span><span class="n">xfer</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">unit</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">ssize_t</span> <span class="n">retlen</span><span class="p">;</span>
    <span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">srcunitswap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">srcunit</span><span class="p">);</span>

    <span class="n">eun</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">srcunit</span><span class="p">];</span>
    <span class="n">xfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">xferunit</span><span class="p">];</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: copying block 0x%x to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">,</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">);</span>


    <span class="cm">/* Read current BAM */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">!=</span> <span class="n">srcunit</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                       <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">));</span>

	<span class="cm">/* mark the cache bad, in case we get an error later */</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;ftl: Failed to read BAM cache in copy_erase_unit()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Write the LogicalEUN for the transfer unit */</span>
    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">XFER_UNKNOWN</span><span class="p">;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span> <span class="cm">/* Bad! */</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x7fff</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unit</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;ftl: Failed to write back to BAM cache in copy_erase_unit()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Copy all data blocks from source unit to transfer unit */</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">;</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">;</span>

    <span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">BLOCK_TYPE</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BLOCK_CONTROL</span>:
	    <span class="cm">/* This gets updated later */</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLOCK_DATA</span>:
	<span class="k">case</span> <span class="n">BLOCK_REPLACEMENT</span>:
	    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ftl: Error reading old xfer unit in copy_erase_unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
            <span class="p">}</span>


	    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ftl: Error writing new xfer unit in copy_erase_unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
            <span class="p">}</span>

	    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	    <span class="cm">/* All other blocks must be free */</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
	    <span class="n">free</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">dest</span> <span class="o">+=</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Write the BAM to the transfer unit */</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span>
                    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">),</span>
                    <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">),</span>
                    <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;ftl: Error writing BAM in copy_erase_unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="cm">/* All clear? Then update the LogicalEUN again */</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">),</span>
                    <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srcunitswap</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ftl: Error writing new LogicalEUN in copy_erase_unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="cm">/* Update the maps and usage stats*/</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">EraseCount</span><span class="p">;</span>
    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">EraseCount</span> <span class="o">=</span> <span class="n">eun</span><span class="o">-&gt;</span><span class="n">EraseCount</span><span class="p">;</span>
    <span class="n">eun</span><span class="o">-&gt;</span><span class="n">EraseCount</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">;</span>
    <span class="n">xfer</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">=</span> <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Offset</span><span class="p">;</span>
    <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span> <span class="o">-=</span> <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Free</span><span class="p">;</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span> <span class="o">+=</span> <span class="n">free</span><span class="p">;</span>
    <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Free</span> <span class="o">=</span> <span class="n">free</span><span class="p">;</span>
    <span class="n">eun</span><span class="o">-&gt;</span><span class="n">Deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Now, the cache should be valid for the new block */</span>
    <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">=</span> <span class="n">srcunit</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* copy_erase_unit */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    reclaim_block() picks a full erase unit and a transfer unit and</span>
<span class="cm">    then calls copy_erase_unit() to copy one to the other.  Then, it</span>
<span class="cm">    schedules an erase on the expired block.</span>

<span class="cm">    What&#39;s a good way to decide which transfer unit and which erase</span>
<span class="cm">    unit to use?  Beats me.  My way is to always pick the transfer</span>
<span class="cm">    unit with the fewest erases, and usually pick the data unit with</span>
<span class="cm">    the most deleted blocks.  But with a small probability, pick the</span>
<span class="cm">    oldest data unit instead.  This means that we generally postpone</span>
<span class="cm">    the next reclamation as long as possible, but shuffle static</span>
<span class="cm">    stuff around a bit for wear leveling.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reclaim_block</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">eun</span><span class="p">,</span> <span class="n">xfer</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">best</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">queued</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: reclaiming space...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;NumTransferUnits == %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">);</span>
    <span class="cm">/* Pick the least erased transfer unit */</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">xfer</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="n">queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">NumTransferUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kt">int</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">XFER_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;XferInfo[%d].state == XFER_UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">erase_xfer</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">XFER_ERASING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;XferInfo[%d].state == XFER_ERASING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">XFER_ERASED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;XferInfo[%d].state == XFER_ERASED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">prepare_xfer</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">XFER_PREPARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;XferInfo[%d].state == XFER_PREPARED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">EraseCount</span> <span class="o">&lt;=</span> <span class="n">best</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">best</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">EraseCount</span><span class="p">;</span>
		    <span class="n">xfer</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;XferInfo[%d].state == %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfer</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">queued</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: waiting for transfer &quot;</span>
		      <span class="s">&quot;unit to be prepared...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mtd_sync</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ne</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: reclaim failed: no &quot;</span>
			   <span class="s">&quot;suitable transfer units!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
		    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: reclaim failed: no &quot;</span>
			  <span class="s">&quot;suitable transfer units!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">xfer</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">);</span>

    <span class="n">eun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">%</span> <span class="n">shuffle_freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: recycling freshest block...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">best</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">EraseCount</span> <span class="o">&lt;=</span> <span class="n">best</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">best</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">EraseCount</span><span class="p">;</span>
		<span class="n">eun</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	    <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Deleted</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">best</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Deleted</span><span class="p">;</span>
		<span class="n">eun</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">static</span> <span class="kt">int</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ne</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: reclaim failed: &quot;</span>
		       <span class="s">&quot;no free blocks!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: reclaim failed: &quot;</span>
		       <span class="s">&quot;no free blocks!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">copy_erase_unit</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">eun</span><span class="p">,</span> <span class="n">xfer</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
	<span class="n">erase_xfer</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">xfer</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: copy_erase_unit failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* reclaim_block */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Find_free() searches for a free block.  If necessary, it updates</span>
<span class="cm">    the BAM cache for the erase unit containing the free block.  It</span>
<span class="cm">    returns the block index -- the erase unit is just the currently</span>
<span class="cm">    cached unit.  If there are no free blocks, it returns 0 -- this</span>
<span class="cm">    is never a valid data block because it contains the header.</span>

<span class="cm">======================================================================*/</span>

<span class="cp">#ifdef PSYCHO_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_lists</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ftl_cs: Free total = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ftl_cs:   unit %d: %d phys, %d free, &quot;</span>
	       <span class="s">&quot;%d deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
	       <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Offset</span> <span class="o">&gt;&gt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">,</span>
	       <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Free</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Deleted</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">find_free</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">stop</span><span class="p">,</span> <span class="n">eun</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">blk</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="cm">/* Find an erase unit with some free space */</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span><span class="p">;</span>
    <span class="n">eun</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">eun</span><span class="p">].</span><span class="n">Free</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Wrap around at end of table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">eun</span> <span class="o">==</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">DataUnits</span><span class="p">)</span> <span class="n">eun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">eun</span> <span class="o">!=</span> <span class="n">stop</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">eun</span><span class="p">].</span><span class="n">Free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Is this unit&#39;s BAM cached? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eun</span> <span class="o">!=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Invalidate cache */</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span>
                       <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">eun</span><span class="p">].</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">),</span>
                       <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span>
                       <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;ftl: Error reading BAM in find_free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">=</span> <span class="n">eun</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Find a free block */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">blk</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span><span class="p">;</span> <span class="n">blk</span><span class="o">++</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BLOCK_FREE</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">blk</span><span class="p">])))</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">==</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">BlocksPerUnit</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PSYCHO_DEBUG</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ne</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="n">dump_lists</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: bad free list!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: found free block at %d in %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">eun</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">blk</span><span class="p">;</span>

<span class="p">}</span> <span class="cm">/* find_free */</span>


<span class="cm">/*======================================================================</span>

<span class="cm">    Read a series of sectors from an FTL partition.</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ftl_read</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="n">caddr_t</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">u_long</span> <span class="n">sector</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">nblocks</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">log_addr</span><span class="p">,</span> <span class="n">bsize</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">retlen</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: ftl_read(0x%p, 0x%lx, %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">part</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FTL_FORMATTED</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: bad partition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">bsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nblocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">sector</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">SECTOR_SIZE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: bad read offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_addr</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">sector</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">log_addr</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">log_addr</span> <span class="o">/</span> <span class="n">bsize</span><span class="p">].</span><span class="n">Offset</span>
			  <span class="o">+</span> <span class="p">(</span><span class="n">log_addr</span> <span class="o">%</span> <span class="n">bsize</span><span class="p">));</span>
	    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Error reading MTD device in ftl_read()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">buffer</span> <span class="o">+=</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ftl_read */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Write a series of sectors to an FTL partition</span>

<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_bam_entry</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">log_addr</span><span class="p">,</span>
			 <span class="kt">uint32_t</span> <span class="n">virt_addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">le_virt_addr</span><span class="p">;</span>
<span class="cp">#ifdef PSYCHO_DEBUG</span>
    <span class="kt">uint32_t</span> <span class="n">old_addr</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="kt">uint16_t</span> <span class="n">eun</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: set_bam_entry(0x%p, 0x%x, 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">part</span><span class="p">,</span> <span class="n">log_addr</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">);</span>
    <span class="n">bsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">;</span>
    <span class="n">eun</span> <span class="o">=</span> <span class="n">log_addr</span> <span class="o">/</span> <span class="n">bsize</span><span class="p">;</span>
    <span class="n">blk</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_addr</span> <span class="o">%</span> <span class="n">bsize</span><span class="p">)</span> <span class="o">/</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">eun</span><span class="p">].</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">blk</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">+</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">BAMOffset</span><span class="p">));</span>

<span class="cp">#ifdef PSYCHO_DEBUG</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">old_addr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;ftl: Error reading old_addr in set_bam_entry: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">old_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">old_addr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(((</span><span class="n">virt_addr</span> <span class="o">==</span> <span class="mh">0xfffffffe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BLOCK_FREE</span><span class="p">(</span><span class="n">old_addr</span><span class="p">))</span> <span class="o">||</span>
	<span class="p">((</span><span class="n">virt_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">BLOCK_TYPE</span><span class="p">(</span><span class="n">old_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BLOCK_DATA</span><span class="p">))</span> <span class="o">||</span>
	<span class="p">(</span><span class="o">!</span><span class="n">BLOCK_DELETED</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">!=</span> <span class="mh">0xfffffffe</span><span class="p">)))</span> <span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ne</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: set_bam_entry() inconsistency!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs:   log_addr = 0x%x, old = 0x%x&quot;</span>
		   <span class="s">&quot;, new = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_addr</span><span class="p">,</span> <span class="n">old_addr</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="n">le_virt_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">==</span> <span class="n">eun</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef PSYCHO_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">blk</span><span class="p">])</span> <span class="o">!=</span> <span class="n">old_addr</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">static</span> <span class="kt">int</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ne</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: set_bam_entry() &quot;</span>
		       <span class="s">&quot;inconsistency!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs:   log_addr = 0x%x, cache&quot;</span>
		       <span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">blk</span><span class="p">]),</span> <span class="n">old_addr</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">[</span><span class="n">blk</span><span class="p">]</span> <span class="o">=</span> <span class="n">le_virt_addr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">le_virt_addr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: set_bam_entry() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs:   log_addr = 0x%x, new = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">log_addr</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* set_bam_entry */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ftl_write</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="n">caddr_t</span> <span class="n">buffer</span><span class="p">,</span>
		     <span class="n">u_long</span> <span class="n">sector</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">nblocks</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">log_addr</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">old_addr</span><span class="p">,</span> <span class="n">blk</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ftl_cs: ftl_write(0x%p, %ld, %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">part</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FTL_FORMATTED</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: bad partition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* See if we need to reclaim space, before we start */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span> <span class="o">&lt;</span> <span class="n">nblocks</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reclaim_block</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">;</span>

    <span class="n">virt_addr</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">*</span> <span class="n">SECTOR_SIZE</span> <span class="o">|</span> <span class="n">BLOCK_DATA</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nblocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virt_addr</span> <span class="o">&gt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: bad write offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Grab a free block */</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">find_free</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">static</span> <span class="kt">int</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ne</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: internal error: &quot;</span>
		       <span class="s">&quot;no free blocks!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tag the BAM entry, and write the new block */</span>
	<span class="n">log_addr</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span> <span class="o">*</span> <span class="n">bsize</span> <span class="o">+</span> <span class="n">blk</span> <span class="o">*</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span><span class="p">].</span><span class="n">Free</span><span class="o">--</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">FreeTotal</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_bam_entry</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">log_addr</span><span class="p">,</span> <span class="mh">0xfffffffe</span><span class="p">))</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span><span class="p">].</span><span class="n">Deleted</span><span class="o">++</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span><span class="p">].</span><span class="n">Offset</span> <span class="o">+</span>
		      <span class="n">blk</span> <span class="o">*</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs: block write failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ftl_cs:   log_addr = 0x%x, virt_addr&quot;</span>
		   <span class="s">&quot; = 0x%x, Offset = 0x%zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_addr</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span>
		   <span class="n">offset</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only delete the old entry when the new entry is ready */</span>
	<span class="n">old_addr</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">sector</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">sector</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">old_addr</span><span class="o">/</span><span class="n">bsize</span><span class="p">].</span><span class="n">Deleted</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">set_bam_entry</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">old_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finally, set up the new pointers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_bam_entry</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">log_addr</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">))</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">sector</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_addr</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_index</span><span class="p">].</span><span class="n">Deleted</span><span class="o">--</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">+=</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">virt_addr</span> <span class="o">+=</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ftl_write */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ftl_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">sect</span><span class="p">;</span>

	<span class="cm">/* Sort of arbitrary: round size down to 4KiB boundary */</span>
	<span class="n">sect</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span><span class="p">)</span><span class="o">/</span><span class="n">SECTOR_SIZE</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">sect</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ftl_readsect</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ftl_read</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ftl_writesect</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ftl_write</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ftl_discardsect</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr_sects</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">EraseUnitSize</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FTL erase sector %ld for %d sectors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">sector</span><span class="p">,</span> <span class="n">nr_sects</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nr_sects</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">old_addr</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">sector</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">[</span><span class="n">old_addr</span><span class="o">/</span><span class="n">bsize</span><span class="p">].</span><span class="n">Deleted</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set_bam_entry</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">old_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nr_sects</span><span class="o">--</span><span class="p">;</span>
		<span class="n">sector</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ftl_freepart</span><span class="p">(</span><span class="n">partition_t</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualBlockMap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualPageMap</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">VirtualPageMap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">EUNInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">XferInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">bam_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ftl_freepart */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ftl_add_mtd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_ops</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">partition_t</span> <span class="o">*</span><span class="n">partition</span><span class="p">;</span>

	<span class="n">partition</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">partition_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">partition</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No memory to scan for FTL on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">partition</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scan_header</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">build_maps</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">partition</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FTL_FORMATTED</span><span class="p">;</span>
<span class="cp">#ifdef PCMCIA_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ftl_cs: opening %d KiB FTL partition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">partition</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">partition</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">partition</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">FormattedSize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

		<span class="n">partition</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>
		<span class="n">partition</span><span class="o">-&gt;</span><span class="n">mbd</span><span class="p">.</span><span class="n">devnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_mtd_blktrans_dev</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">partition</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ftl_freepart</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ftl_remove_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_blktrans_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_mtd_blktrans_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ftl_freepart</span><span class="p">((</span><span class="n">partition_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_blktrans_ops</span> <span class="n">ftl_tr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ftl&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>		<span class="o">=</span> <span class="n">FTL_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">part_bits</span>	<span class="o">=</span> <span class="n">PART_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blksize</span> 	<span class="o">=</span> <span class="n">SECTOR_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readsect</span>	<span class="o">=</span> <span class="n">ftl_readsect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writesect</span>	<span class="o">=</span> <span class="n">ftl_writesect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">discard</span>	<span class="o">=</span> <span class="n">ftl_discardsect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>		<span class="o">=</span> <span class="n">ftl_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_mtd</span>	<span class="o">=</span> <span class="n">ftl_add_mtd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_dev</span>	<span class="o">=</span> <span class="n">ftl_remove_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ftl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_mtd_blktrans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ftl_tr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_ftl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deregister_mtd_blktrans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ftl_tr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_ftl</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_ftl</span><span class="p">);</span>


<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual MPL/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Hinds &lt;dahinds@users.sourceforge.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support code for Flash Translation Layer, used on PCMCIA devices&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
