<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mtd › mtdcore.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mtdcore.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Core registration and callback routines for MTD</span>
<span class="cm"> * drivers and users.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 1999-2010 David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> * Copyright © 2006      Red Hat UK Limited </span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/backing-dev.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>

<span class="cp">#include &quot;mtdcore.h&quot;</span>
<span class="cm">/*</span>
<span class="cm"> * backing device capabilities for non-mappable devices (such as NAND flash)</span>
<span class="cm"> * - permits private mappings, copies are taken of the data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="n">mtd_bdi_unmappable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="n">BDI_CAP_MAP_COPY</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * backing device capabilities for R/O mappable devices (such as ROM)</span>
<span class="cm"> * - permits private mappings, copies are taken of the data</span>
<span class="cm"> * - permits non-writable shared mappings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="n">mtd_bdi_ro_mappable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="p">(</span><span class="n">BDI_CAP_MAP_COPY</span> <span class="o">|</span> <span class="n">BDI_CAP_MAP_DIRECT</span> <span class="o">|</span>
			   <span class="n">BDI_CAP_EXEC_MAP</span> <span class="o">|</span> <span class="n">BDI_CAP_READ_MAP</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * backing device capabilities for writable mappable devices (such as RAM)</span>
<span class="cm"> * - permits private mappings, copies are taken of the data</span>
<span class="cm"> * - permits non-writable shared mappings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="n">mtd_bdi_rw_mappable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="p">(</span><span class="n">BDI_CAP_MAP_COPY</span> <span class="o">|</span> <span class="n">BDI_CAP_MAP_DIRECT</span> <span class="o">|</span>
			   <span class="n">BDI_CAP_EXEC_MAP</span> <span class="o">|</span> <span class="n">BDI_CAP_READ_MAP</span> <span class="o">|</span>
			   <span class="n">BDI_CAP_WRITE_MAP</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mtd_cls_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mtd_cls_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">mtd_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mtd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">mtd_cls_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">mtd_cls_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_IDR</span><span class="p">(</span><span class="n">mtd_idr</span><span class="p">);</span>

<span class="cm">/* These are exported solely for the purpose of mtd_blkdevs.c. You</span>
<span class="cm">   should not use them for _anything_ else */</span>
<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="nf">__mtd_next_device</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idr_get_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__mtd_next_device</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mtd_notifiers</span><span class="p">);</span>


<span class="cp">#if defined(CONFIG_MTD_CHAR) || defined(CONFIG_MTD_CHAR_MODULE)</span>
<span class="cp">#define MTD_DEVT(index) MKDEV(MTD_CHAR_MAJOR, (index)*2)</span>
<span class="cp">#else</span>
<span class="cp">#define MTD_DEVT(index) 0</span>
<span class="cp">#endif</span>

<span class="cm">/* REVISIT once MTD uses the driver model better, whoever allocates</span>
<span class="cm"> * the mtd_info will probably want to use the release() hook...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mtd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="n">__maybe_unused</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">MTD_DEVT</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* remove /dev/mtdXro node if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
		<span class="n">device_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_class</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtd_cls_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mtd</span> <span class="o">?</span> <span class="n">mtd_suspend</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtd_cls_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="p">)</span>
		<span class="n">mtd_resume</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTD_ABSENT</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;absent&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_RAM</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;ram&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_ROM</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;rom&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_NORFLASH</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;nor&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_NANDFLASH</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;nand&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_DATAFLASH</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;dataflash&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTD_UBIVOLUME</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;ubi&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_type_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_flags_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_flags_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_size_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_erasesize_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">erasesize</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_erasesize_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_writesize_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">writesize</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_writesize_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_subpagesize_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subpagesize</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">&gt;&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">subpage_sft</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subpagesize</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">subpagesize</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_subpagesize_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_oobsize_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">oobsize</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_oobsize_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_numeraseregions_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">numeraseregions</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">numeraseregions</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_numeraseregions_show</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_ecc_strength_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_strength</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ecc_strength</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mtd_ecc_strength_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_bitflip_threshold_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">bitflip_threshold</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtd_bitflip_threshold_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitflip_threshold</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitflip_threshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">bitflip_threshold</span> <span class="o">=</span> <span class="n">bitflip_threshold</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bitflip_threshold</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">mtd_bitflip_threshold_show</span><span class="p">,</span>
		   <span class="n">mtd_bitflip_threshold_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">mtd_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_flags</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_erasesize</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_writesize</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_subpagesize</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_oobsize</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_numeraseregions</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ecc_strength</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bitflip_threshold</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">mtd_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span>		<span class="o">=</span> <span class="n">mtd_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">mtd_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">mtd_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">mtd_devtype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mtd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span>		<span class="o">=</span> <span class="n">mtd_groups</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">mtd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	add_mtd_device - register an MTD device</span>
<span class="cm"> *	@mtd: pointer to new MTD device info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Add a device to the list of MTD devices present in the system, and</span>
<span class="cm"> *	notify each currently active MTD &#39;user&#39; of its arrival. Returns</span>
<span class="cm"> *	zero on success or 1 on failure, which currently will only happen</span>
<span class="cm"> *	if there is insufficient memory or a sysfs error.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">add_mtd_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_notifier</span> <span class="o">*</span><span class="n">not</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MTD_RAM</span>:
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mtd_bdi_rw_mappable</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MTD_ROM</span>:
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mtd_bdi_ro_mappable</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mtd_bdi_unmappable</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail_locked</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">idr_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_locked</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* default value if not set by driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">bitflip_threshold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">bitflip_threshold</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_strength</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">))</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">))</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize_shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Some chips always power up locked. Unlock them now */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_WRITEABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_POWERUP_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">mtd_unlock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: unlock failed, writes may not work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Caller should have set dev.parent to match the</span>
<span class="cm">	 * physical device.</span>
<span class="cm">	 */</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mtd_devtype</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mtd_class</span><span class="p">;</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">devt</span> <span class="o">=</span> <span class="n">MTD_DEVT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mtd%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_added</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MTD_DEVT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
		<span class="n">device_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_class</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			      <span class="n">MTD_DEVT</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;mtd%dro&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mtd: Giving out device %d to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* No need to get a refcount on the module containing</span>
<span class="cm">	   the notifier, since we hold the mtd_table_mutex */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">not</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtd_notifiers</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">not</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="cm">/* We _know_ we aren&#39;t being removed, because</span>
<span class="cm">	   our caller is still holding us here. So none</span>
<span class="cm">	   of this try_ nonsense, and no bitching about it</span>
<span class="cm">	   either. :) */</span>
	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_added:</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="nl">fail_locked:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	del_mtd_device - unregister an MTD device</span>
<span class="cm"> *	@mtd: pointer to MTD device info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Remove a device from the list of MTD devices present in the system,</span>
<span class="cm"> *	and notify each currently active MTD &#39;user&#39; of its departure.</span>
<span class="cm"> *	Returns zero on success or 1 on failure, which currently will happen</span>
<span class="cm"> *	if the requested device does not appear to be present in the list.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">del_mtd_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_notifier</span> <span class="o">*</span><span class="n">not</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No need to get a refcount on the module containing</span>
<span class="cm">		the notifier, since we hold the mtd_table_mutex */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">not</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtd_notifiers</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">not</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Removing MTD device #%d (%s) with use count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mtd_device_parse_register - parse partitions and register an MTD device.</span>
<span class="cm"> *</span>
<span class="cm"> * @mtd: the MTD device to register</span>
<span class="cm"> * @types: the list of MTD partition probes to try, see</span>
<span class="cm"> *         &#39;parse_mtd_partitions()&#39; for more information</span>
<span class="cm"> * @parser_data: MTD partition parser-specific data</span>
<span class="cm"> * @parts: fallback partition information to register, if parsing fails;</span>
<span class="cm"> *         only valid if %nr_parts &gt; %0</span>
<span class="cm"> * @nr_parts: the number of partitions in parts, if zero then the full</span>
<span class="cm"> *            MTD device is registered if no partition info is found</span>
<span class="cm"> *</span>
<span class="cm"> * This function aggregates MTD partitions parsing (done by</span>
<span class="cm"> * &#39;parse_mtd_partitions()&#39;) and MTD device and partitions registering. It</span>
<span class="cm"> * basically follows the most common pattern found in many MTD drivers:</span>
<span class="cm"> *</span>
<span class="cm"> * * It first tries to probe partitions on MTD device @mtd using parsers</span>
<span class="cm"> *   specified in @types (if @types is %NULL, then the default list of parsers</span>
<span class="cm"> *   is used, see &#39;parse_mtd_partitions()&#39; for more information). If none are</span>
<span class="cm"> *   found this functions tries to fallback to information specified in</span>
<span class="cm"> *   @parts/@nr_parts.</span>
<span class="cm"> * * If any partitioning info was found, this function registers the found</span>
<span class="cm"> *   partitions.</span>
<span class="cm"> * * If no partitions were found this function just registers the MTD device</span>
<span class="cm"> *   @mtd and exits.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero in case of success and a negative error code in case of failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_device_parse_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">types</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mtd_part_parser_data</span> <span class="o">*</span><span class="n">parser_data</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="o">*</span><span class="n">parts</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">nr_parts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_partition</span> <span class="o">*</span><span class="n">real_parts</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_mtd_partitions</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">real_parts</span><span class="p">,</span> <span class="n">parser_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nr_parts</span> <span class="o">&amp;&amp;</span> <span class="n">parts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">real_parts</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_parts</span><span class="p">,</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">real_parts</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nr_parts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_mtd_partitions</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">real_parts</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">real_parts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_mtd_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_device_parse_register</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * mtd_device_unregister - unregister an existing MTD device.</span>
<span class="cm"> *</span>
<span class="cm"> * @master: the MTD device to unregister.  This will unregister both the master</span>
<span class="cm"> *          and any partitions if registered.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_device_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">del_mtd_partitions</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">del_mtd_device</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_device_unregister</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	register_mtd_user - register a &#39;user&#39; of MTD devices.</span>
<span class="cm"> *	@new: pointer to notifier info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Registers a pair of callbacks function to be called upon addition</span>
<span class="cm"> *	or removal of MTD devices. Causes the &#39;add&#39; callback to be immediately</span>
<span class="cm"> *	invoked for each MTD device currently present in the system.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">register_mtd_user</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mtd_notifier</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtd_notifiers</span><span class="p">);</span>

	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="n">mtd_for_each_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_mtd_user</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	unregister_mtd_user - unregister a &#39;user&#39; of MTD devices.</span>
<span class="cm"> *	@old: pointer to notifier info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Removes a callback function pair from the list of &#39;users&#39; to be</span>
<span class="cm"> *	notified upon addition or removal of MTD devices. Causes the</span>
<span class="cm"> *	&#39;remove&#39; callback to be immediately invoked for each MTD device</span>
<span class="cm"> *	currently present in the system.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">unregister_mtd_user</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mtd_notifier</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="n">mtd_for_each_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">unregister_mtd_user</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	get_mtd_device - obtain a validated handle for an MTD device</span>
<span class="cm"> *	@mtd: last known address of the required MTD device</span>
<span class="cm"> *	@num: internal device number of the required MTD device</span>
<span class="cm"> *</span>
<span class="cm"> *	Given a number and NULL address, return the num&#39;th entry in the device</span>
<span class="cm"> *	table, if any.	Given an address and num == -1, search the device table</span>
<span class="cm"> *	for a device with that address and return if it&#39;s still present. Given</span>
<span class="cm"> *	both, return the num&#39;th driver only if its address matches. Return</span>
<span class="cm"> *	error code if not.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="nf">get_mtd_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtd_for_each_device</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">mtd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_idr</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span> <span class="o">&amp;&amp;</span> <span class="n">mtd</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__get_mtd_device</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">get_mtd_device</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">__get_mtd_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__get_mtd_device</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	get_mtd_device_nm - obtain a validated handle for an MTD device by</span>
<span class="cm"> *	device name</span>
<span class="cm"> *	@name: MTD device name to open</span>
<span class="cm"> *</span>
<span class="cm"> * 	This function returns MTD device description structure in case of</span>
<span class="cm"> * 	success and an error code in case of failure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="nf">get_mtd_device_nm</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

	<span class="n">mtd_for_each_device</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mtd</span> <span class="o">=</span> <span class="n">other</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__get_mtd_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">get_mtd_device_nm</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">put_mtd_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="n">__put_mtd_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">put_mtd_device</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__put_mtd_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">--</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_put_device</span><span class="p">)</span>
		<span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_put_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__put_mtd_device</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Erase is an asynchronous operation.  Device drivers are supposed</span>
<span class="cm"> * to call instr-&gt;callback() whenever the operation completes, even</span>
<span class="cm"> * if it completes with a failure.</span>
<span class="cm"> * Callers are supposed to pass a callback function and wait for it</span>
<span class="cm"> * to be called before writing to the block.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">erase_info</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">instr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_WRITEABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="n">instr</span><span class="o">-&gt;</span><span class="n">fail_addr</span> <span class="o">=</span> <span class="n">MTD_FAIL_ADDR_UNKNOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">instr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MTD_ERASE_DONE</span><span class="p">;</span>
		<span class="n">mtd_erase_callback</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_erase</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">instr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_erase</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This stuff for eXecute-In-Place. phys is optional and may be set to NULL.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span>
	      <span class="kt">void</span> <span class="o">**</span><span class="n">virt</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="o">*</span><span class="n">phys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys</span><span class="p">)</span>
		<span class="o">*</span><span class="n">phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_point</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">from</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">from</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_point</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">virt</span><span class="p">,</span> <span class="n">phys</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_point</span><span class="p">);</span>

<span class="cm">/* We probably shouldn&#39;t allow XIP if the unpoint isn&#39;t a NULL */</span>
<span class="kt">int</span> <span class="nf">mtd_unpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_point</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">from</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">from</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unpoint</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_unpoint</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allow NOMMU mmap() to directly map the device (if not NULL)</span>
<span class="cm"> * - return the address to which the offset maps</span>
<span class="cm"> * - return -ENOSYS to indicate refusal to do the mapping</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">mtd_get_unmapped_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_unmapped_area</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_unmapped_area</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_get_unmapped_area</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span>
	     <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_code</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">from</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">from</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the absence of an error, drivers return a non-negative integer</span>
<span class="cm">	 * representing the maximum number of bitflips that were corrected on</span>
<span class="cm">	 * any one ecc region (if applicable; zero otherwise).</span>
<span class="cm">	 */</span>
	<span class="n">ret_code</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret_code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecc_strength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* device lacks ecc */</span>
	<span class="k">return</span> <span class="n">ret_code</span> <span class="o">&gt;=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">bitflip_threshold</span> <span class="o">?</span> <span class="o">-</span><span class="n">EUCLEAN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_read</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">to</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_WRITEABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_write</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * In blackbox flight recorder like scenarios we want to make successful writes</span>
<span class="cm"> * in interrupt context. panic_write() is only intended to be called when its</span>
<span class="cm"> * known the kernel is about to panic and we need the write to succeed. Since</span>
<span class="cm"> * the kernel is not going to be running for much longer, this function can</span>
<span class="cm"> * break locks and delay to ensure the write succeeds (but not sleep).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_panic_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span>
		    <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_panic_write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">to</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_WRITEABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_panic_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_panic_write</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Method to access the protection register area, present in some flash</span>
<span class="cm"> * devices. The user data is one time programmable but the factory data is read</span>
<span class="cm"> * only.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_get_fact_prot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">otp_info</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_fact_prot_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_fact_prot_info</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_get_fact_prot_info</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_read_fact_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_fact_prot_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_fact_prot_reg</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_read_fact_prot_reg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_get_user_prot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">otp_info</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_user_prot_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_get_user_prot_info</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_get_user_prot_info</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_read_user_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_user_prot_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_read_user_prot_reg</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_read_user_prot_reg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_write_user_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write_user_prot_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_write_user_prot_reg</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_write_user_prot_reg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_lock_user_prot_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock_user_prot_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock_user_prot_reg</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_lock_user_prot_reg</span><span class="p">);</span>

<span class="cm">/* Chip-supported device locking */</span>
<span class="kt">int</span> <span class="nf">mtd_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_lock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_lock</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unlock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_unlock</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_unlock</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_is_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_is_locked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_is_locked</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_is_locked</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_block_isbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_isbad</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_isbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_block_isbad</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mtd_block_markbad</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_markbad</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_WRITEABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_block_markbad</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_block_markbad</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * default_mtd_writev - the default writev method</span>
<span class="cm"> * @mtd: mtd device description object pointer</span>
<span class="cm"> * @vecs: the vectors to write</span>
<span class="cm"> * @count: count of vectors in @vecs</span>
<span class="cm"> * @to: the MTD device offset to write to</span>
<span class="cm"> * @retlen: on exit contains the count of bytes written to the MTD device.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns zero in case of success and a negative error code in</span>
<span class="cm"> * case of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">default_mtd_writev</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">vecs</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thislen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thislen</span><span class="p">,</span>
				<span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
		<span class="n">totlen</span> <span class="o">+=</span> <span class="n">thislen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">thislen</span> <span class="o">!=</span> <span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">to</span> <span class="o">+=</span> <span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mtd_writev - the vector-based MTD write method</span>
<span class="cm"> * @mtd: mtd device description object pointer</span>
<span class="cm"> * @vecs: the vectors to write</span>
<span class="cm"> * @count: count of vectors in @vecs</span>
<span class="cm"> * @to: the MTD device offset to write to</span>
<span class="cm"> * @retlen: on exit contains the count of bytes written to the MTD device.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns zero in case of success and a negative error code in</span>
<span class="cm"> * case of failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mtd_writev</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">vecs</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MTD_WRITEABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_writev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">default_mtd_writev</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">retlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">_writev</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">retlen</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_writev</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * mtd_kmalloc_up_to - allocate a contiguous buffer up to the specified size</span>
<span class="cm"> * @mtd: mtd device description object pointer</span>
<span class="cm"> * @size: a pointer to the ideal or maximum size of the allocation, points</span>
<span class="cm"> *        to the actual allocation size on success.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine attempts to allocate a contiguous kernel buffer up to</span>
<span class="cm"> * the specified size, backing off the size of the request exponentially</span>
<span class="cm"> * until the request succeeds or until the allocation size falls below</span>
<span class="cm"> * the system page size. This attempts to make sure it does not adversely</span>
<span class="cm"> * impact system performance, so when allocating more than one page, we</span>
<span class="cm"> * ask the memory allocator to avoid re-trying, swapping, writing back</span>
<span class="cm"> * or performing I/O.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, this function also makes sure that the allocated buffer is aligned to</span>
<span class="cm"> * the MTD device&#39;s min. I/O unit, i.e. the &quot;mtd-&gt;writesize&quot; value.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called, for example by mtd_{read,write} and jffs2_scan_medium,</span>
<span class="cm"> * to handle smaller (i.e. degraded) buffer allocations under low- or</span>
<span class="cm"> * fragmented-memory situations where such reduced allocations, from a</span>
<span class="cm"> * requested ideal, are allowed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the allocated buffer on success; otherwise, NULL.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">mtd_kmalloc_up_to</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfp_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span> <span class="n">__GFP_WAIT</span> <span class="o">|</span>
		       <span class="n">__GFP_NORETRY</span> <span class="o">|</span> <span class="n">__GFP_NO_KSWAPD</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">min_alloc</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">KMALLOC_MAX_SIZE</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">min_alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">kbuf</span><span class="p">;</span>

		<span class="o">*</span><span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the last resort allocation allow &#39;kmalloc()&#39; to do all sorts of</span>
<span class="cm">	 * things (write-back, dropping caches, etc) by using GFP_KERNEL.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">kmalloc</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mtd_kmalloc_up_to</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="cm">/*====================================================================*/</span>
<span class="cm">/* Support for /proc/mtd */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_mtd</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtd_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;dev:    size   erasesize  name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="n">mtd_for_each_device</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;mtd%d: %8.8llx %8.8x </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			   <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">,</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_table_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtd_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mtd_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mtd_proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mtd_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/*====================================================================*/</span>
<span class="cm">/* Init code */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mtd_bdi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="o">*</span><span class="n">bdi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bdi_init</span><span class="p">(</span><span class="n">bdi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bdi_register</span><span class="p">(</span><span class="n">bdi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">bdi_destroy</span><span class="p">(</span><span class="n">bdi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_mtd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_class</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_bdi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_unmappable</span><span class="p">,</span> <span class="s">&quot;mtd-unmap&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_bdi1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_bdi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_ro_mappable</span><span class="p">,</span> <span class="s">&quot;mtd-romap&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_bdi2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_bdi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_rw_mappable</span><span class="p">,</span> <span class="s">&quot;mtd-rwmap&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_bdi3</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">proc_mtd</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;mtd&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtd_proc_ops</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_bdi3:</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_ro_mappable</span><span class="p">);</span>
<span class="nl">err_bdi2:</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_unmappable</span><span class="p">);</span>
<span class="nl">err_bdi1:</span>
	<span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_class</span><span class="p">);</span>
<span class="nl">err_reg:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error registering mtd class or bdi: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_mtd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc_mtd</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span> <span class="s">&quot;mtd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>
	<span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_class</span><span class="p">);</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_unmappable</span><span class="p">);</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_ro_mappable</span><span class="p">);</span>
	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtd_bdi_rw_mappable</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_mtd</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_mtd</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Woodhouse &lt;dwmw2@infradead.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Core MTD registration and access routines&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
