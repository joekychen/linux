<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-acpi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-acpi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Provides ACPI support for IDE drives.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Intel Corp.</span>
<span class="cm"> * Copyright (C) 2005 Randy Dunlap</span>
<span class="cm"> * Copyright (C) 2006 SUSE Linux Products GmbH</span>
<span class="cm"> * Copyright (C) 2006 Hannes Reinecke</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ata.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;acpi/acpi_bus.h&gt;</span>

<span class="cp">#define REGS_PER_GTF		7</span>

<span class="k">struct</span> <span class="n">GTM_buffer</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">PIO_speed0</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">DMA_speed0</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">PIO_speed1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">DMA_speed1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">GTM_flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ide_acpi_drive_link</span> <span class="p">{</span>
	<span class="n">acpi_handle</span>	 <span class="n">obj_handle</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">idbuff</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ide_acpi_hwif_link</span> <span class="p">{</span>
	<span class="n">ide_hwif_t</span>			<span class="o">*</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">acpi_handle</span>			 <span class="n">obj_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">GTM_buffer</span>		 <span class="n">gtm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_acpi_drive_link</span>	 <span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_acpi_drive_link</span>	 <span class="n">slave</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#undef DEBUGGING</span>
<span class="cm">/* note: adds function name and KERN_DEBUG */</span>
<span class="cp">#ifdef DEBUGGING</span>
<span class="cp">#define DEBPRINT(fmt, args...)	\</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s: &quot; fmt, __func__, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DEBPRINT(fmt, args...)	do {} while (0)</span>
<span class="cp">#endif	</span><span class="cm">/* DEBUGGING */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ide_noacpi</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">noacpi</span><span class="p">,</span> <span class="n">ide_noacpi</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noacpi</span><span class="p">,</span> <span class="s">&quot;disable IDE ACPI support&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ide_acpigtf</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">acpigtf</span><span class="p">,</span> <span class="n">ide_acpigtf</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">acpigtf</span><span class="p">,</span> <span class="s">&quot;enable IDE ACPI _GTF support&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ide_acpionboot</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">acpionboot</span><span class="p">,</span> <span class="n">ide_acpionboot</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">acpionboot</span><span class="p">,</span> <span class="s">&quot;call IDE ACPI methods on boot&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ide_noacpi_psx</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">no_acpi_psx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_noacpi_psx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="s">&quot;%s detected - disable ACPI _PSx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">ide_acpi_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Bug 9673. */</span>
	<span class="cm">/* We should check if this is because ACPI NVS isn&#39;t save/restored. */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">no_acpi_psx</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span>    <span class="o">=</span> <span class="s">&quot;HP nx9005&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span>  <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BIOS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Phoenix Technologies Ltd.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">,</span> <span class="s">&quot;KAM1.60&quot;</span><span class="p">)</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">ide_acpi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">ide_acpi_dmi_table</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ide_port_acpi</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ide_noacpi</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_get_dev_handle - finds acpi_handle and PCI device.function</span>
<span class="cm"> * @dev: device to locate</span>
<span class="cm"> * @handle: returned acpi_handle for @dev</span>
<span class="cm"> * @pcidevfn: return PCI device.func for @dev</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the ACPI object handle to the corresponding PCI device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_get_dev_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="o">*</span><span class="n">pcidevfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devnum</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">dev_handle</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device_info</span>	<span class="o">*</span><span class="n">dinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">devnum</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="cm">/* ACPI _ADR encoding for PCI bus: */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">devnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">func</span><span class="p">);</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ENTER: pci %02x:%02x.%01x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devnum</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="n">dev_handle</span> <span class="o">=</span> <span class="n">DEVICE_ACPI_HANDLE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;no acpi handle for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_object_info</span><span class="p">(</span><span class="n">dev_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;get_object_info for device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">ACPI_VALID_ADR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pcidevfn</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">dev_handle</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;get_object_info for device has wrong &quot;</span>
			<span class="s">&quot; address: %llu, should be %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dinfo</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1ULL</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;for dev=0x%x.%x, addr=0x%llx, *handle=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">devnum</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_acpi_hwif_get_handle - Get ACPI object handle for a given hwif</span>
<span class="cm"> * @hwif: device to locate</span>
<span class="cm"> *</span>
<span class="cm"> * Retrieves the object handle for a given hwif.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns handle on success, 0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">acpi_handle</span> <span class="nf">ide_acpi_hwif_get_handle</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">acpi_handle</span>		<span class="n">uninitialized_var</span><span class="p">(</span><span class="n">dev_handle</span><span class="p">);</span>
	<span class="n">u64</span>			<span class="n">pcidevfn</span><span class="p">;</span>
	<span class="n">acpi_handle</span>		<span class="n">chan_handle</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ENTER: device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;no PCI device for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ide_get_dev_handle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcidevfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ide_get_dev_handle failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get child objects of dev_handle == channel objects,</span>
<span class="cm">	 * + _their_ children == drive objects */</span>
	<span class="cm">/* channel is hwif-&gt;channel */</span>
	<span class="n">chan_handle</span> <span class="o">=</span> <span class="n">acpi_get_child</span><span class="p">(</span><span class="n">dev_handle</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;chan adr=%d: handle=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">chan_handle</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chan_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_drive_get_GTF - get the drive bootup default taskfile settings</span>
<span class="cm"> * @drive: the drive for which the taskfile settings should be retrieved</span>
<span class="cm"> * @gtf_length: number of bytes of _GTF data returned at @gtf_address</span>
<span class="cm"> * @gtf_address: buffer containing _GTF taskfile arrays</span>
<span class="cm"> *</span>
<span class="cm"> * The _GTF method has no input parameters.</span>
<span class="cm"> * It returns a variable number of register set values (registers</span>
<span class="cm"> * hex 1F1..1F7, taskfiles).</span>
<span class="cm"> * The &lt;variable number&gt; is not known in advance, so have ACPI-CA</span>
<span class="cm"> * allocate the buffer as needed and return it, then free it later.</span>
<span class="cm"> *</span>
<span class="cm"> * The returned @gtf_length and @gtf_address are only valid if the</span>
<span class="cm"> * function return value is 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_drive_get_GTF</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">gtf_length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">gtf_address</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">obj_loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span>			<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span>		<span class="n">output</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> 		<span class="o">*</span><span class="n">out_obj</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="o">*</span><span class="n">gtf_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">gtf_address</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">obj_loc</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;No ACPI object found for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setting up output buffer */</span>
	<span class="n">output</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">output</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* ACPI-CA sets this; save/free it later */</span>

	<span class="cm">/* _GTF has no input parameters */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span> <span class="s">&quot;_GTF&quot;</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: Run _GTF error: status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">output</span><span class="p">.</span><span class="n">length</span> <span class="o">||</span> <span class="o">!</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;Run _GTF: &quot;</span>
		       <span class="s">&quot;length or ptr is NULL (0x%llx, 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">output</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
		       <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">out_obj</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;Run _GTF: error: &quot;</span>
		       <span class="s">&quot;expected object type of ACPI_TYPE_BUFFER, &quot;</span>
		       <span class="s">&quot;got 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">||</span> <span class="o">!</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">||</span>
	    <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">REGS_PER_GTF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: unexpected GTF length (%d) or addr (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
		       <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">gtf_length</span> <span class="o">=</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="o">*</span><span class="n">gtf_address</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="o">*</span><span class="n">obj_loc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_obj</span><span class="p">;</span>
	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;returning gtf_length=%d, gtf_address=0x%lx, obj_loc=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="o">*</span><span class="n">gtf_length</span><span class="p">,</span> <span class="o">*</span><span class="n">gtf_address</span><span class="p">,</span> <span class="o">*</span><span class="n">obj_loc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_drive_set_taskfiles - write the drive taskfile settings from _GTF</span>
<span class="cm"> * @drive: the drive to which the taskfile command should be sent</span>
<span class="cm"> * @gtf_length: total number of bytes of _GTF taskfiles</span>
<span class="cm"> * @gtf_address: location of _GTF taskfile arrays</span>
<span class="cm"> *</span>
<span class="cm"> * Write {gtf_address, length gtf_length} in groups of</span>
<span class="cm"> * REGS_PER_GTF bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_drive_set_taskfiles</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gtf_length</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gtf_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">gtf_count</span> <span class="o">=</span> <span class="n">gtf_length</span> <span class="o">/</span> <span class="n">REGS_PER_GTF</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ix</span><span class="p">;</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;total GTF bytes=%u (0x%x), gtf_count=%d, addr=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">gtf_length</span><span class="p">,</span> <span class="n">gtf_length</span><span class="p">,</span> <span class="n">gtf_count</span><span class="p">,</span> <span class="n">gtf_address</span><span class="p">);</span>

	<span class="cm">/* send all taskfile registers (0x1f1-0x1f7) *in*that*order* */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">gtf_count</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">gtf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">gtf_address</span> <span class="o">+</span> <span class="n">ix</span> <span class="o">*</span> <span class="n">REGS_PER_GTF</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;(0x1f1-1f7): &quot;</span>
			 <span class="s">&quot;hex: %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">gtf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gtf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gtf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			 <span class="n">gtf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">gtf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">gtf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">gtf</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ide_acpigtf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;_GTF execution disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* convert GTF to taskfile */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">tf</span><span class="p">.</span><span class="n">feature</span><span class="p">,</span> <span class="n">gtf</span><span class="p">,</span> <span class="n">REGS_PER_GTF</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">tf</span> <span class="o">=</span> <span class="n">IDE_VALID_OUT_TF</span> <span class="o">|</span> <span class="n">IDE_VALID_DEVICE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">tf</span>  <span class="o">=</span> <span class="n">IDE_VALID_IN_TF</span>  <span class="o">|</span> <span class="n">IDE_VALID_DEVICE</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ide_no_data_taskfile</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ide_no_data_taskfile failed: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_acpi_exec_tfs - get then write drive taskfile settings</span>
<span class="cm"> * @drive: the drive for which the taskfile settings should be</span>
<span class="cm"> *         written.</span>
<span class="cm"> *</span>
<span class="cm"> * According to the ACPI spec this should be called after _STM</span>
<span class="cm"> * has been evaluated for the interface. Some ACPI vendors interpret</span>
<span class="cm"> * that as a hard requirement and modify the taskfile according</span>
<span class="cm"> * to the Identify Drive information passed down with _STM.</span>
<span class="cm"> * So one should really make sure to call this only after _STM has</span>
<span class="cm"> * been executed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ide_acpi_exec_tfs</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">gtf_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">gtf_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">obj_loc</span><span class="p">;</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;call get_GTF, drive=%s port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_drive_get_GTF</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtf_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtf_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj_loc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;get_GTF error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;call set_taskfiles, drive=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_drive_set_taskfiles</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">gtf_length</span><span class="p">,</span> <span class="n">gtf_address</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">obj_loc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;set_taskfiles error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_acpi_get_timing - get the channel (controller) timings</span>
<span class="cm"> * @hwif: target IDE interface (channel)</span>
<span class="cm"> *</span>
<span class="cm"> * This function executes the _GTM ACPI method for the target channel.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ide_acpi_get_timing</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span>		<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span>	<span class="n">output</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> 	<span class="o">*</span><span class="n">out_obj</span><span class="p">;</span>

	<span class="cm">/* Setting up output buffer for _GTM */</span>
	<span class="n">output</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">output</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* ACPI-CA sets this; save/free it later */</span>

	<span class="cm">/* _GTM has no input parameters */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span> <span class="s">&quot;_GTM&quot;</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;_GTM status: %d, outptr: 0x%p, outlen: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">status</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">output</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;Run _GTM error: status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">output</span><span class="p">.</span><span class="n">length</span> <span class="o">||</span> <span class="o">!</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;Run _GTM: length or ptr is NULL (0x%llx, 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">output</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
		       <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">out_obj</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;Run _GTM: error: &quot;</span>
		       <span class="s">&quot;expected object type of ACPI_TYPE_BUFFER, &quot;</span>
		       <span class="s">&quot;got 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">||</span> <span class="o">!</span><span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">||</span>
	    <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">GTM_buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: unexpected _GTM length (0x%x)[should be 0x%zx] or &quot;</span>
			<span class="s">&quot;addr (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">GTM_buffer</span><span class="p">),</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">,</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">GTM_buffer</span><span class="p">));</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;_GTM info: ptr: 0x%p, len: 0x%x, exp.len: 0x%Zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span> <span class="n">out_obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">GTM_buffer</span><span class="p">));</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;_GTM fields: 0x%x, 0x%x, 0x%x, 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">.</span><span class="n">PIO_speed0</span><span class="p">,</span>
		 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">.</span><span class="n">DMA_speed0</span><span class="p">,</span>
		 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">.</span><span class="n">PIO_speed1</span><span class="p">,</span>
		 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">.</span><span class="n">DMA_speed1</span><span class="p">,</span>
		 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">.</span><span class="n">GTM_flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_acpi_push_timing - set the channel (controller) timings</span>
<span class="cm"> * @hwif: target IDE interface (channel)</span>
<span class="cm"> *</span>
<span class="cm"> * This function executes the _STM ACPI method for the target channel.</span>
<span class="cm"> *</span>
<span class="cm"> * _STM requires Identify Drive data, which has to passed as an argument.</span>
<span class="cm"> * Unfortunately drive-&gt;id is a mangled version which we can&#39;t readily</span>
<span class="cm"> * use; hence we&#39;ll get the information afresh.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ide_acpi_push_timing</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span>		<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span>	<span class="n">input</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> 	<span class="n">in_params</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ide_acpi_drive_link</span>	<span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_acpi_drive_link</span>	<span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>

	<span class="cm">/* Give the GTM buffer + drive Identify data to the channel via the</span>
<span class="cm">	 * _STM method: */</span>
	<span class="cm">/* setup input parameters buffer for _STM */</span>
	<span class="n">input</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">input</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">in_params</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">GTM_buffer</span><span class="p">);</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ATA_ID_WORDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">idbuff</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ATA_ID_WORDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">in_params</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">idbuff</span><span class="p">;</span>
	<span class="cm">/* Output buffer: _STM has no output */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span> <span class="s">&quot;_STM&quot;</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;Run _STM error: status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;_STM status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_acpi_set_state - set the channel power state</span>
<span class="cm"> * @hwif: target IDE interface</span>
<span class="cm"> * @on: state, on/off</span>
<span class="cm"> *</span>
<span class="cm"> * This function executes the _PS0/_PS3 ACPI method to set the power state.</span>
<span class="cm"> * ACPI spec requires _PS0 when IDE power on and _PS3 when power off</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ide_acpi_set_state</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_noacpi_psx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ENTER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* channel first and then drives for power on and verse versa for power off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">acpi_bus_set_power</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span> <span class="n">ACPI_STATE_D0</span><span class="p">);</span>

	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">)</span>
			<span class="n">acpi_bus_set_power</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span>
					   <span class="n">on</span> <span class="o">?</span> <span class="n">ACPI_STATE_D0</span> <span class="o">:</span> <span class="n">ACPI_STATE_D3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span><span class="p">)</span>
		<span class="n">acpi_bus_set_power</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span> <span class="n">ACPI_STATE_D3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ide_acpi_init_port - initialize the ACPI link for an IDE interface</span>
<span class="cm"> * @hwif: target IDE interface (channel)</span>
<span class="cm"> *</span>
<span class="cm"> * The ACPI spec is not quite clear when the drive identify buffer</span>
<span class="cm"> * should be obtained. Calling IDENTIFY DEVICE during shutdown</span>
<span class="cm"> * is not the best of ideas as the drive might already being put to</span>
<span class="cm"> * sleep. And obviously we can&#39;t call it during resume.</span>
<span class="cm"> * So we get the information during startup; but this means that</span>
<span class="cm"> * any changes during run-time will be lost after resume.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ide_acpi_init_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_acpi_hwif_link</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span> <span class="o">=</span> <span class="n">ide_acpi_hwif_get_handle</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;no ACPI object for %s found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="p">);</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_acpi_port_init_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ACPI spec mandates that we send information</span>
<span class="cm">	 * for both drives, regardless whether they are connected</span>
<span class="cm">	 * or not.</span>
<span class="cm">	 */</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">acpidata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">acpidata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>

	<span class="cm">/* get _ADR info for each device */</span>
	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_handle</span> <span class="n">dev_handle</span><span class="p">;</span>

		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ENTER: %s at channel#: %d port#: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* TBD: could also check ACPI object VALID bits */</span>
		<span class="n">dev_handle</span> <span class="o">=</span> <span class="n">acpi_get_child</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span><span class="p">,</span>
					    <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;drive %s handle 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_handle</span><span class="p">);</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">obj_handle</span> <span class="o">=</span> <span class="n">dev_handle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send IDENTIFY for each device */</span>
	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">taskfile_lib_get_identify</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">acpidata</span><span class="o">-&gt;</span><span class="n">idbuff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;identify device %s failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_noacpi</span> <span class="o">||</span> <span class="n">ide_acpionboot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBPRINT</span><span class="p">(</span><span class="s">&quot;ACPI methods disabled on boot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ACPI _PS0 before _STM */</span>
	<span class="n">ide_acpi_set_state</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * ACPI requires us to call _STM on startup</span>
<span class="cm">	 */</span>
	<span class="n">ide_acpi_get_timing</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">ide_acpi_push_timing</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_acpi_exec_tfs</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
