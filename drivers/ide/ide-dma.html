<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  IDE DMA support (including IDE PCI BM-DMA).</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1995-1998   Mark Lord</span>
<span class="cm"> *  Copyright (C) 1999-2000   Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> *  Copyright (C) 2004, 2007  Bartlomiej Zolnierkiewicz</span>
<span class="cm"> *</span>
<span class="cm"> *  May be copied or modified under the terms of the GNU General Public License</span>
<span class="cm"> *</span>
<span class="cm"> *  DMA is supported for all IDE devices (disk drives, cdroms, tapes, floppies).</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Special Thanks to Mark for his Six years of work.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Thanks to &quot;Christopher J. Reimer&quot; &lt;reimer@doe.carleton.ca&gt; for</span>
<span class="cm"> * fixing the problem with the BIOS on some Acer motherboards.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to &quot;Benoit Poulot-Cazajous&quot; &lt;poulot@chorus.fr&gt; for testing</span>
<span class="cm"> * &quot;TX&quot; chipset compatibility and for providing patches for the &quot;TX&quot; chipset.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Christian Brunner &lt;chb@muc.de&gt; for taking a good first crack</span>
<span class="cm"> * at generic DMA -- his patches were referred to when preparing this code.</span>
<span class="cm"> *</span>
<span class="cm"> * Most importantly, thanks to Robert Bringman &lt;rob@mars.trion.com&gt;</span>
<span class="cm"> * for supplying a Promise UDMA board &amp; WD UDMA drive for this work!</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drive_list_entry</span> <span class="n">drive_whitelist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Micropolis 2112A&quot;</span>	<span class="p">,</span>       <span class="nb">NULL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CONNER CTMA 4000&quot;</span>	<span class="p">,</span>       <span class="nb">NULL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CONNER CTT8000-A&quot;</span>	<span class="p">,</span>       <span class="nb">NULL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ST34342A&quot;</span>		<span class="p">,</span>	<span class="nb">NULL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span>			<span class="p">,</span>	<span class="nb">NULL</span>		<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drive_list_entry</span> <span class="n">drive_blacklist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC11000H&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC22100H&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC32500H&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC33100H&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC31600H&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC32100H&quot;</span>	<span class="p">,</span>	<span class="s">&quot;24.09P07&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WDC AC23200L&quot;</span>	<span class="p">,</span>	<span class="s">&quot;21.10N21&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Compaq CRD-8241B&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CRD-8400B&quot;</span>		<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CRD-8480B&quot;</span><span class="p">,</span>			<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CRD-8482B&quot;</span><span class="p">,</span>			<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CRD-84&quot;</span>		<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SanDisk SDP3B&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SanDisk SDP3B-64&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SANYO CD-ROM CRD&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HITACHI CDR-8&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HITACHI CDR-8335&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HITACHI CDR-8435&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Toshiba CD-ROM XM-6202B&quot;</span>	<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TOSHIBA CD-ROM XM-1702BC&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CD-532E-A&quot;</span>		<span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;E-IDE CD-ROM CR-840&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CD-ROM Drive/F5A&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WPI CDD-820&quot;</span><span class="p">,</span>		<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SAMSUNG CD-ROM SC-148C&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SAMSUNG CD-ROM SC&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ATAPI CD-ROM DRIVE 40X MAXIMUM&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 		<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;_NEC DV5800A&quot;</span><span class="p">,</span>               <span class="nb">NULL</span>            <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SAMSUNG CD-ROM SN-124&quot;</span><span class="p">,</span>	<span class="s">&quot;N001&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Seagate STT20000A&quot;</span><span class="p">,</span>		<span class="nb">NULL</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CD-ROM CDR_U200&quot;</span><span class="p">,</span>		<span class="s">&quot;1.09&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span>			<span class="p">,</span>	<span class="nb">NULL</span>		<span class="p">}</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dma_intr	-	IDE DMA interrupt handler</span>
<span class="cm"> *	@drive: the drive the interrupt is for</span>
<span class="cm"> *</span>
<span class="cm"> *	Handle an interrupt completing a read/write DMA transfer on an</span>
<span class="cm"> *	IDE device</span>
<span class="cm"> */</span>

<span class="n">ide_startstop_t</span> <span class="nf">ide_dma_intr</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_stat</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OK_STAT</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">DRIVE_READY</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bad_wstat</span> <span class="o">|</span> <span class="n">ATA_DRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_stat</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf_flags</span> <span class="o">&amp;</span> <span class="n">IDE_TFLAG_FS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ide_finish_cmd</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ide_complete_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s: bad DMA status (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dma_stat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ide_error</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;dma_intr&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_dma_good_drive</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ide_in_drive_list</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">drive_whitelist</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dma_map_sg	-	map IDE scatter gather for DMA I/O</span>
<span class="cm"> *	@drive: the drive to map the DMA table for</span>
<span class="cm"> *	@cmd: command</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform the DMA mapping magic necessary to access the source or</span>
<span class="cm"> *	target buffers of a request via DMA.  The lower layers of the</span>
<span class="cm"> *	kernel provide the necessary cache management so that we can</span>
<span class="cm"> *	operate in a portable fashion.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_dma_map_sg</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf_flags</span> <span class="o">&amp;</span> <span class="n">IDE_TFLAG_WRITE</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_dma_direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_dma_direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_nents</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_dma_direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">orig_sg_nents</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_nents</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_nents</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dma_unmap_sg	-	clean up DMA mapping</span>
<span class="cm"> *	@drive: The drive to unmap</span>
<span class="cm"> *</span>
<span class="cm"> *	Teardown mappings after DMA has completed. This must be called</span>
<span class="cm"> *	after the completion of each use of ide_build_dmatable and before</span>
<span class="cm"> *	the next use of ide_build_dmatable. Failure to do so will cause</span>
<span class="cm"> *	an oops as only one mapping can be live for each target at a given</span>
<span class="cm"> *	time.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>

	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">orig_sg_nents</span><span class="p">,</span>
		     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_dma_direction</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_dma_unmap_sg</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dma_off_quietly	-	Generic DMA kill</span>
<span class="cm"> *	@drive: drive to control</span>
<span class="cm"> *</span>
<span class="cm"> *	Turn off the current DMA on this IDE controller.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ide_dma_off_quietly</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_USING_DMA</span><span class="p">;</span>
	<span class="n">ide_toggle_bounce</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_host_set</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ide_dma_off_quietly</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dma_off	-	disable DMA on a device</span>
<span class="cm"> *	@drive: drive to disable DMA on</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable IDE DMA for a device on this IDE controller.</span>
<span class="cm"> *	Inform the user that DMA has been disabled.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ide_dma_off</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: DMA disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ide_dma_off_quietly</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ide_dma_off</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dma_on		-	Enable DMA on a device</span>
<span class="cm"> *	@drive: drive to enable DMA on</span>
<span class="cm"> *</span>
<span class="cm"> *	Enable IDE DMA for a device on this IDE controller.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ide_dma_on</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_USING_DMA</span><span class="p">;</span>
	<span class="n">ide_toggle_bounce</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_host_set</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__ide_dma_bad_drive</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">blacklist</span> <span class="o">=</span> <span class="n">ide_in_drive_list</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">drive_blacklist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blacklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Disabling (U)DMA for %s (blacklisted)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">blacklist</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__ide_dma_bad_drive</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">xfer_mode_bases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">XFER_UDMA_0</span><span class="p">,</span>
	<span class="n">XFER_MW_DMA_0</span><span class="p">,</span>
	<span class="n">XFER_SW_DMA_0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ide_get_mode_mask</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFER_UDMA_0</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FIELD_VALID</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_UDMA_MODES</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">&amp;&amp;</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">udma_filter</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">udma_filter</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">ultra_mask</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * avoid false cable warning from eighty_ninty_three()</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req_mode</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">eighty_ninty_three</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">mask</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFER_MW_DMA_0</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MWDMA_MODES</span><span class="p">];</span>

		<span class="cm">/* Also look for the CF specific MWDMA modes... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_is_cfa</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFA_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFA_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">mask</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">mode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">&amp;&amp;</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">mdma_filter</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">mdma_filter</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFER_SW_DMA_0</span>:
		<span class="n">mask</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SWDMA_MODES</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ATA_SWDMA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_DMA_MODES</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_DMA_MODES</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * if the mode is valid convert it to the mask</span>
<span class="cm">			 * (the maximum allowed mode is XFER_SW_DMA_2)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">mode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">swdma_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_find_dma_mode	-	compute DMA speed</span>
<span class="cm"> *	@drive: IDE device</span>
<span class="cm"> *	@req_mode: requested mode</span>
<span class="cm"> *</span>
<span class="cm"> *	Checks the drive/host capabilities and finds the speed to use for</span>
<span class="cm"> *	the DMA transfer.  The speed is then limited by the requested mode.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 if the drive/host combination is incapable of DMA transfers</span>
<span class="cm"> *	or if the requested mode is not a DMA mode.</span>
<span class="cm"> */</span>

<span class="n">u8</span> <span class="nf">ide_find_dma_mode</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">ide_disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_ATAPI_DMA</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xfer_mode_bases</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req_mode</span> <span class="o">&lt;</span> <span class="n">xfer_mode_bases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ide_get_mode_mask</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">xfer_mode_bases</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">req_mode</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">xfer_mode_bases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">ide_acorn</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * is this correct?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ide_dma_good_drive</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_EIDE_DMA_TIME</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">XFER_MW_DMA_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">req_mode</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s mode selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			  <span class="n">mode</span> <span class="o">?</span> <span class="n">ide_xfer_verbose</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;no DMA&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_tune_dma</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_dma</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_NODMA</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* consult the list of known &quot;bad&quot; drives */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__ide_dma_bad_drive</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_TRUST_BIOS_FOR_DMA</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">config_drive_for_dma</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="n">ide_max_dma_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">speed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_set_dma_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">speed</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_dma_check</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_tune_dma</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* TODO: always do PIO fallback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_TRUST_BIOS_FOR_DMA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ide_set_max_pio</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_set_dma</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force DMAing for the beginning of the check.</span>
<span class="cm">	 * Some chipsets appear to do interesting</span>
<span class="cm">	 * things, if not checked and cleared.</span>
<span class="cm">	 *   PARANOIA!!!</span>
<span class="cm">	 */</span>
	<span class="n">ide_dma_off_quietly</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_dma_check</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ide_dma_on</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_check_dma_crc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">ide_dma_off_quietly</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">crc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t try non Ultra-DMA modes without iCRC&#39;s.  Force the</span>
<span class="cm">	 * device to PIO and make the user enable SWDMA/MWDMA modes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">XFER_UDMA_7</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">XFER_PIO_4</span><span class="p">;</span>
	<span class="n">ide_set_xfer_rate</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">current_speed</span> <span class="o">&gt;=</span> <span class="n">XFER_SW_DMA_0</span><span class="p">)</span>
		<span class="n">ide_dma_on</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_dma_lost_irq</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMA interrupt recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_dma_lost_irq</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * un-busy the port etc, and clear any pending DMA status. we want to</span>
<span class="cm"> * retry the current request in pio mode instead of risking tossing it</span>
<span class="cm"> * all away</span>
<span class="cm"> */</span>
<span class="n">ide_startstop_t</span> <span class="nf">ide_dma_timeout_retry</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="o">*</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">ide_startstop_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ide_stopped</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * end current dma transaction</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: DMA timeout error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ide_error</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;dma timeout error&quot;</span><span class="p">,</span>
				<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: DMA timeout retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_clear</span><span class="p">)</span>
			<span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_clear</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout waiting for DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_test_irq</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ide_dump_status</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;DMA timeout&quot;</span><span class="p">,</span>
					<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">));</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="n">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable dma for now, but remember that we did so because of</span>
<span class="cm">	 * a timeout -- we&#39;ll reenable after we finish this next request</span>
<span class="cm">	 * (or rather the first chunk of it) in pio.</span>
<span class="cm">	 */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_DMA_PIO_RETRY</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">retry_pio</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ide_dma_off_quietly</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * make sure request is sane</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_release_dma_engine</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prd_size</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_max_nents</span> <span class="o">*</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_ent_size</span><span class="p">;</span>

		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">prd_size</span><span class="p">,</span>
				  <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_cpu</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_dma</span><span class="p">);</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_cpu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_release_dma_engine</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_allocate_dma_engine</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prd_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_max_nents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_max_nents</span> <span class="o">=</span> <span class="n">PRD_ENTRIES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_ent_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_ent_size</span> <span class="o">=</span> <span class="n">PRD_BYTES</span><span class="p">;</span>

	<span class="n">prd_size</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_max_nents</span> <span class="o">*</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">prd_ent_size</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_cpu</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">prd_size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_dma</span><span class="p">,</span>
						<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_cpu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to allocate PRD table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_allocate_dma_engine</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_dma_prepare</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="o">*</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_USING_DMA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_check</span> <span class="o">&amp;&amp;</span> <span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_check</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ide_map_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_dma_map_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_map</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_setup</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_dma_unmap</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_dma_unmap:</span>
	<span class="n">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="nl">out_map:</span>
	<span class="n">ide_map_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
