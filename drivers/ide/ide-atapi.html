<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-atapi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-atapi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ATAPI support.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;ide-atapi&quot;</span>
<span class="cp">#define PFX DRV_NAME &quot;: &quot;</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define debug_log(fmt, args...) \</span>
<span class="cp">	printk(KERN_INFO &quot;ide: &quot; fmt, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define debug_log(fmt, args...) do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define ATAPI_MIN_CDB_BYTES	12</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dev_is_idecd</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_cdrom</span> <span class="o">||</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_optical</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether we can support a device,</span>
<span class="cm"> * based on the ATAPI IDENTIFY command results.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ide_check_atapi_device</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gcw</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">removable</span><span class="p">,</span> <span class="n">drq_type</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">;</span>

	<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gcw</span><span class="p">)</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">];</span>

	<span class="n">protocol</span>    <span class="o">=</span> <span class="p">(</span><span class="n">gcw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">device_type</span> <span class="o">=</span>  <span class="n">gcw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">removable</span>   <span class="o">=</span> <span class="p">(</span><span class="n">gcw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">drq_type</span>    <span class="o">=</span> <span class="p">(</span><span class="n">gcw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">packet_size</span> <span class="o">=</span>  <span class="n">gcw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC</span>
	<span class="cm">/* kludge for Apple PowerBook internal zip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span> <span class="o">&amp;&amp;</span> <span class="n">device_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">strstr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">],</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strstr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">],</span> <span class="s">&quot;ZIP&quot;</span><span class="p">))</span>
		<span class="n">device_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s: protocol (0x%02x) is not ATAPI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span> <span class="o">&amp;&amp;</span> <span class="n">device_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span> <span class="o">&amp;&amp;</span> <span class="n">device_type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s: invalid device type (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">device_type</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">removable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s: the removable flag is not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span> <span class="o">&amp;&amp;</span> <span class="n">drq_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s: sorry, DRQ type (0x%02x) not &quot;</span>
			<span class="s">&quot;supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drq_type</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">packet_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s: packet size (0x%02x) is not 12 &quot;</span>
			<span class="s">&quot;bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_check_atapi_device</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_init_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_init_pc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Add a special packet command request to the tail of the request queue,</span>
<span class="cm"> * and wait for it to be serviced.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ide_queue_pc_tail</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_SPECIAL</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">special</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">bufflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span>
					<span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">put_req</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQ_IDETAPE_PC1</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">put_req:</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_queue_pc_tail</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_do_test_unit_ready</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="n">pc</span><span class="p">;</span>

	<span class="n">ide_init_pc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_queue_pc_tail</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_do_test_unit_ready</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_do_start_stop</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="n">pc</span><span class="p">;</span>

	<span class="n">ide_init_pc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">START_STOP</span><span class="p">;</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span>
		<span class="n">pc</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PC_FLAG_WAIT_FOR_DSC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_queue_pc_tail</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_do_start_stop</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_set_media_lock</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="n">pc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_DOORLOCKING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ide_init_pc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span><span class="p">;</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">on</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_queue_pc_tail</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_set_media_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_create_request_sense_cmd</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_init_pc</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">req_xfer</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">req_xfer</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_create_request_sense_cmd</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_prep_sense</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">sense_rq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ide_floppy</span>:
		<span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_tape</span>:
		<span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sense</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_SENSE</span> <span class="o">||</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq_armed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sense</span><span class="p">));</span>

	<span class="n">blk_rq_init</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">sense_rq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">sense_rq</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span>
			      <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;%s: failed to map sense &quot;</span>
					    <span class="s">&quot;buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">rq_disk</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="p">;</span>
	<span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_REQUEST_SENSE</span><span class="p">;</span>
	<span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_SENSE</span><span class="p">;</span>
	<span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_PREEMPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span>
		<span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQ_IDETAPE_PC1</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq_armed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_prep_sense</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_queue_sense_rq</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">special</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* deferred failure from ide_prep_sense() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq_armed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;%s: error queuing a sense request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq</span><span class="p">.</span><span class="n">special</span> <span class="o">=</span> <span class="n">special</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq_armed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">elv_add_request</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq</span><span class="p">,</span> <span class="n">ELEVATOR_INSERT_FRONT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_queue_sense_rq</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called when an error was detected during the last packet command.</span>
<span class="cm"> * We queue a request sense packet command at the head of the request</span>
<span class="cm"> * queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ide_retry_pc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">failed_rq</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">sense_rq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">request_sense_pc</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ide_read_error</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="cm">/* init pc from sense_rq */</span>
	<span class="n">ide_init_pc</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">sense_rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">|=</span> <span class="n">IDE_AFLAG_IGNORE_DSC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Push back the failed request and put request sense on top</span>
<span class="cm">	 * of it.  The failed command will be retried after sense data</span>
<span class="cm">	 * is acquired.</span>
<span class="cm">	 */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ide_requeue_and_plug</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">failed_rq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_queue_sense_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">pc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blk_start_request</span><span class="p">(</span><span class="n">failed_rq</span><span class="p">);</span>
		<span class="n">ide_complete_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">failed_rq</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_retry_pc</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_cd_expiry</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;%s: rq-&gt;cmd[0]: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some commands are *slow* and normally take a long time to complete.</span>
<span class="cm">	 * Usually we can use the ATAPI &quot;disconnect&quot; to bypass this, but not all</span>
<span class="cm">	 * commands/drives support that. Let ide_timer_expiry keep polling us</span>
<span class="cm">	 * for these.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GPCMD_BLANK</span>:
	<span class="k">case</span> <span class="n">GPCMD_FORMAT_UNIT</span>:
	<span class="k">case</span> <span class="n">GPCMD_RESERVE_RZONE_TRACK</span>:
	<span class="k">case</span> <span class="n">GPCMD_CLOSE_TRACK</span>:
	<span class="k">case</span> <span class="n">GPCMD_FLUSH_CACHE</span>:
		<span class="n">wait</span> <span class="o">=</span> <span class="n">ATAPI_WAIT_PC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_QUIET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;cmd 0x%x timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">wait</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_cd_expiry</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_cd_get_xferlen</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REQ_TYPE_FS</span>:
		<span class="k">return</span> <span class="mi">32768</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REQ_TYPE_SENSE</span>:
	<span class="k">case</span> <span class="n">REQ_TYPE_BLOCK_PC</span>:
	<span class="k">case</span> <span class="n">REQ_TYPE_ATA_PC</span>:
		<span class="k">return</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_cd_get_xferlen</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_read_bcount_and_ireason</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">bcount</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ireason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_taskfile</span> <span class="n">tf</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">tf_read</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="n">IDE_VALID_NSECT</span> <span class="o">|</span>
				     <span class="n">IDE_VALID_LBAM</span> <span class="o">|</span> <span class="n">IDE_VALID_LBAH</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">lbah</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="p">.</span><span class="n">lbam</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ireason</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">nsect</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_read_bcount_and_ireason</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Check the contents of the interrupt reason register and attempt to recover if</span>
<span class="cm"> * there are problems.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * - 0 if everything&#39;s ok</span>
<span class="cm"> * - 1 if the request has to be terminated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ide_check_ireason</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">ireason</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>

	<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;ireason: 0x%x, rw: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ireason</span><span class="p">,</span> <span class="n">rw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ireason</span> <span class="o">==</span> <span class="p">(</span><span class="o">!</span><span class="n">rw</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ireason</span> <span class="o">==</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: %s: wrong transfer direction!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span>
			<span class="n">ide_pad_transfer</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rw</span> <span class="o">&amp;&amp;</span> <span class="n">ireason</span> <span class="o">==</span> <span class="n">ATAPI_COD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Some drives (ASUS) seem to tell us that status info</span>
<span class="cm">			 * is available.  Just get it and ignore.</span>
<span class="cm">			 */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ireason</span> <span class="o">&amp;</span> <span class="n">ATAPI_COD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: CoD != 0 in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* drive wants a command packet, or invalid ireason... */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: %s: bad interrupt reason 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ireason</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_ATA_PC</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_check_ireason</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is the usual interrupt handler which will be called during a packet</span>
<span class="cm"> * command.  We will transfer some of the data (as requested by the drive)</span>
<span class="cm"> * and will re-point interrupt handler to us.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ide_startstop_t</span> <span class="nf">ide_pc_intr</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_tp_ops</span> <span class="o">*</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bcount</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat</span><span class="p">,</span> <span class="n">ireason</span><span class="p">,</span> <span class="n">dsc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">write</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_WRITING</span><span class="p">);</span>

	<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;Enter %s - interrupt handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span><span class="p">)</span> <span class="o">?</span> <span class="n">WAIT_FLOPPY_CMD</span>
					       <span class="o">:</span> <span class="n">WAIT_TAPE_CMD</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_DMA_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: DMA %s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">)</span>
						     <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PC_FLAG_DMA_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;%s: DMA finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* No more interrupts */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_DRQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">uptodate</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;Packet command completed, %d bytes transferred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">));</span>

		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_FLAG_DMA_IN_PROGRESS</span><span class="p">;</span>

		<span class="n">local_irq_enable_in_hardirq</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span>
			<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_ERR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_DMA_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Error detected */</span>
			<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;%s: I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">ide_tape</span><span class="p">)</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: I/O error in request &quot;</span>
						<span class="s">&quot;sense command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ide_do_reset</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;[cmd %x]: check condition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="cm">/* Retry operation */</span>
			<span class="n">ide_retry_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

			<span class="cm">/* queued, but not started */</span>
			<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_WAIT_FOR_DSC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_DSC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dsc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * -&gt;pc_callback() might change rq-&gt;data_len for</span>
<span class="cm">		 * residual count, cache total length.</span>
<span class="cm">		 */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

		<span class="cm">/* Command finished - Call the callback function */</span>
		<span class="n">uptodate</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pc_callback</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">dsc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">failed_pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_SPECIAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span> <span class="o">&amp;&amp;</span> <span class="n">uptodate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">uptodate</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ide_complete_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_DMA_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_FLAG_DMA_IN_PROGRESS</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: The device wants to issue more &quot;</span>
				<span class="s">&quot;interrupts in DMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ide_dma_off</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ide_do_reset</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get the number of bytes to transfer on this interrupt. */</span>
	<span class="n">ide_read_bcount_and_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_check_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">bcount</span><span class="p">,</span> <span class="n">ireason</span><span class="p">,</span> <span class="n">write</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ide_do_reset</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">done</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">bcount</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span><span class="p">);</span>
	<span class="n">ide_pio_bytes</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>

	<span class="cm">/* Update transferred byte count */</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">-=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">bcount</span> <span class="o">-=</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcount</span><span class="p">)</span>
		<span class="n">ide_pad_transfer</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">bcount</span><span class="p">);</span>

	<span class="n">debug_log</span><span class="p">(</span><span class="s">&quot;[cmd %x] transferred %d bytes, padded %d bytes, resid: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">done</span><span class="p">,</span> <span class="n">bcount</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span><span class="p">);</span>

	<span class="cm">/* And set the interrupt handler again */</span>
	<span class="n">ide_set_handler</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">ide_pc_intr</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ide_started</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_init_packet_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">valid_tf</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">bcount</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">dma</span> <span class="o">?</span> <span class="n">ATAPI_PROT_DMA</span> <span class="o">:</span> <span class="n">ATAPI_PROT_PIO</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">tf</span> <span class="o">=</span> <span class="n">IDE_VALID_LBAH</span> <span class="o">|</span> <span class="n">IDE_VALID_LBAM</span> <span class="o">|</span>
			    <span class="n">IDE_VALID_FEATURE</span> <span class="o">|</span> <span class="n">valid_tf</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_PACKET</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>		<span class="cm">/* Use PIO/DMA */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">lbam</span>    <span class="o">=</span> <span class="n">bcount</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">lbah</span>    <span class="o">=</span> <span class="p">(</span><span class="n">bcount</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ide_read_ireason</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_taskfile</span> <span class="n">tf</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">tf_read</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="n">IDE_VALID_NSECT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">nsect</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ide_wait_ireason</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ireason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">retries</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ireason</span> <span class="o">&amp;</span> <span class="n">ATAPI_COD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ireason</span> <span class="o">&amp;</span> <span class="n">ATAPI_IO</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: (IO,CoD != (0,1) while issuing &quot;</span>
				<span class="s">&quot;a packet command, retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">ireason</span> <span class="o">=</span> <span class="n">ide_read_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: (IO,CoD != (0,1) while issuing&quot;</span>
					<span class="s">&quot; a packet command, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ireason</span> <span class="o">|=</span> <span class="n">ATAPI_COD</span><span class="p">;</span>
			<span class="n">ireason</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATAPI_IO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ireason</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_delayed_transfer_pc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Send the actual packet */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">output_data</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Timeout for the packet command */</span>
	<span class="k">return</span> <span class="n">WAIT_FLOPPY_CMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ide_startstop_t</span> <span class="nf">ide_transfer_pc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="n">ide_expiry_t</span> <span class="o">*</span><span class="n">expiry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">ide_startstop_t</span> <span class="n">startstop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ireason</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_wait_stat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">startstop</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">ATA_DRQ</span><span class="p">,</span> <span class="n">ATA_BUSY</span><span class="p">,</span> <span class="n">WAIT_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Strange, packet command initiated yet &quot;</span>
				<span class="s">&quot;DRQ isn&#39;t asserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">startstop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_DRQ_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ATAPI commands get padded out to 12 bytes minimum */</span>
		<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="n">ATAPI_MIN_CDB_BYTES</span><span class="p">)</span>
			<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">ATAPI_MIN_CDB_BYTES</span><span class="p">;</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
		<span class="n">expiry</span>  <span class="o">=</span> <span class="n">ide_cd_expiry</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

		<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">ATAPI_MIN_CDB_BYTES</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If necessary schedule the packet transfer to occur &#39;timeout&#39;</span>
<span class="cm">		 * milliseconds later in ide_delayed_transfer_pc() after the</span>
<span class="cm">		 * device says it&#39;s ready for a packet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_ZIP_DRIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pc_delay</span><span class="p">;</span>
			<span class="n">expiry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_delayed_transfer_pc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span><span class="p">)</span> <span class="o">?</span> <span class="n">WAIT_FLOPPY_CMD</span>
							       <span class="o">:</span> <span class="n">WAIT_TAPE_CMD</span><span class="p">;</span>
			<span class="n">expiry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ireason</span> <span class="o">=</span> <span class="n">ide_read_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span>
			<span class="n">ireason</span> <span class="o">=</span> <span class="n">ide_wait_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">ireason</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ireason</span> <span class="o">&amp;</span> <span class="n">ATAPI_COD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">ireason</span> <span class="o">&amp;</span> <span class="n">ATAPI_IO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: (IO,CoD) != (0,1) while &quot;</span>
				<span class="s">&quot;issuing a packet command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">ide_do_reset</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>

	<span class="cm">/* Set the interrupt routine */</span>
	<span class="n">ide_set_handler</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">?</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">irq_handler</span>
					     <span class="o">:</span> <span class="n">ide_pc_intr</span><span class="p">),</span>
			<span class="n">timeout</span><span class="p">);</span>

	<span class="cm">/* Send the actual packet */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_ZIP_DRIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">output_data</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">);</span>

	<span class="cm">/* Begin DMA, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_DMA_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PC_FLAG_DMA_IN_PROGRESS</span><span class="p">;</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ide_started</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ide_startstop_t</span> <span class="nf">ide_issue_pc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_atapi_pc</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">ide_expiry_t</span> <span class="o">*</span><span class="n">expiry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bcount</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drq_int</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_DRQ_INTERRUPT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_idecd</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">valid_tf</span> <span class="o">=</span> <span class="n">IDE_VALID_NSECT</span> <span class="o">|</span> <span class="n">IDE_VALID_LBAL</span><span class="p">;</span>
		<span class="n">bcount</span> <span class="o">=</span> <span class="n">ide_cd_get_xferlen</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">expiry</span> <span class="o">=</span> <span class="n">ide_cd_expiry</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">ATAPI_WAIT_PC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">!</span><span class="n">ide_dma_prepare</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

		<span class="n">valid_tf</span> <span class="o">=</span> <span class="n">IDE_VALID_DEVICE</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">bcount</span> <span class="o">=</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span> <span class="o">?</span> <span class="n">bytes</span>
						     <span class="o">:</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
							     <span class="n">bytes</span><span class="p">,</span> <span class="mi">63</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>

		<span class="cm">/* We haven&#39;t transferred any data yet */</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="n">bcount</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_DMA_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_FLAG_DMA_ERROR</span><span class="p">;</span>
			<span class="n">ide_dma_off</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PC_FLAG_DMA_OK</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">!</span><span class="n">ide_dma_prepare</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_FLAG_DMA_OK</span><span class="p">;</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span><span class="p">)</span> <span class="o">?</span> <span class="n">WAIT_FLOPPY_CMD</span>
						       <span class="o">:</span> <span class="n">WAIT_TAPE_CMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_init_packet_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">valid_tf</span><span class="p">,</span> <span class="n">bcount</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_rw_taskfile</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drq_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_execute_command</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ide_transfer_pc</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drq_int</span> <span class="o">?</span> <span class="n">ide_started</span> <span class="o">:</span> <span class="n">ide_transfer_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_issue_pc</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
