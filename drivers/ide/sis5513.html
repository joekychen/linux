<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › sis5513.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sis5513.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 1999-2000	Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> * Copyright (C) 2002		Lionel Bouton &lt;Lionel.Bouton@inet6.fr&gt;, Maintainer</span>
<span class="cm"> * Copyright (C) 2003		Vojtech Pavlik &lt;vojtech@suse.cz&gt;</span>
<span class="cm"> * Copyright (C) 2007-2009	Bartlomiej Zolnierkiewicz</span>
<span class="cm"> *</span>
<span class="cm"> * May be copied or modified under the terms of the GNU General Public License</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks :</span>
<span class="cm"> *</span>
<span class="cm"> * SiS Taiwan		: for direct support and hardware.</span>
<span class="cm"> * Daniela Engert	: for initial ATA100 advices and numerous others.</span>
<span class="cm"> * John Fremlin, Manfred Spraul, Dave Morgan, Peter Kjellerstedt	:</span>
<span class="cm"> *			  for checking code correctness, providing patches.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Original tests and design on the SiS620 chipset.</span>
<span class="cm"> * ATA100 tests and design on the SiS735 chipset.</span>
<span class="cm"> * ATA16/33 support from specs</span>
<span class="cm"> * ATA133 support for SiS961/962 by L.C. Chang &lt;lcchang@sis.com.tw&gt;</span>
<span class="cm"> * ATA133 961/962/963 fixes by Vojtech Pavlik &lt;vojtech@suse.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation:</span>
<span class="cm"> *	SiS chipset documentation available under NDA to companies only</span>
<span class="cm"> *      (not to individuals).</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The original SiS5513 comes from a SiS5511/55112/5513 chipset. The original</span>
<span class="cm"> * SiS5513 was also used in the SiS5596/5513 chipset. Thus if we see a SiS5511</span>
<span class="cm"> * or SiS5596, we can assume we see the first MWDMA-16 capable SiS5513 chip.</span>
<span class="cm"> *</span>
<span class="cm"> * Later SiS chipsets integrated the 5513 functionality into the NorthBridge,</span>
<span class="cm"> * starting with SiS5571 and up to SiS745. The PCI ID didn&#39;t change, though. We</span>
<span class="cm"> * can figure out that we have a more modern and more capable 5513 by looking</span>
<span class="cm"> * for the respective NorthBridge IDs.</span>
<span class="cm"> *</span>
<span class="cm"> * Even later (96x family) SiS chipsets use the MuTIOL link and place the 5513</span>
<span class="cm"> * into the SouthBrige. Here we cannot rely on looking up the NorthBridge PCI</span>
<span class="cm"> * ID, while the now ATA-133 capable 5513 still has the same PCI ID.</span>
<span class="cm"> * Fortunately the 5513 can be &#39;unmasked&#39; by fiddling with some config space</span>
<span class="cm"> * bits, changing its device id to the true one - 5517 for 961 and 5518 for</span>
<span class="cm"> * 962/963.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;sis5513&quot;</span>

<span class="cm">/* registers layout and init values are chipset family dependent */</span>

<span class="cp">#define ATA_16		0x01</span>
<span class="cp">#define ATA_33		0x02</span>
<span class="cp">#define ATA_66		0x03</span>
<span class="cp">#define ATA_100a	0x04 </span><span class="cm">/* SiS730/SiS550 is ATA100 with ATA66 layout */</span><span class="cp"></span>
<span class="cp">#define ATA_100		0x05</span>
<span class="cp">#define ATA_133a	0x06 </span><span class="cm">/* SiS961b with 133 support */</span><span class="cp"></span>
<span class="cp">#define ATA_133		0x07 </span><span class="cm">/* SiS962/963 */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">chipset_family</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Devices supported</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">host_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chipset_family</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SiSHostChipInfo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;SiS968&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_968</span><span class="p">,</span>	<span class="n">ATA_133</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS966&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_966</span><span class="p">,</span>	<span class="n">ATA_133</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS965&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_965</span><span class="p">,</span>	<span class="n">ATA_133</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS745&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_745</span><span class="p">,</span>	<span class="n">ATA_100</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS735&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_735</span><span class="p">,</span>	<span class="n">ATA_100</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS733&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_733</span><span class="p">,</span>	<span class="n">ATA_100</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS635&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_635</span><span class="p">,</span>	<span class="n">ATA_100</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS633&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_633</span><span class="p">,</span>	<span class="n">ATA_100</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;SiS730&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_730</span><span class="p">,</span>	<span class="n">ATA_100a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS550&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_550</span><span class="p">,</span>	<span class="n">ATA_100a</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;SiS640&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_640</span><span class="p">,</span>	<span class="n">ATA_66</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS630&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_630</span><span class="p">,</span>	<span class="n">ATA_66</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS620&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_620</span><span class="p">,</span>	<span class="n">ATA_66</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS540&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_540</span><span class="p">,</span>	<span class="n">ATA_66</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS530&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_530</span><span class="p">,</span>	<span class="n">ATA_66</span>   <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;SiS5600&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5600</span><span class="p">,</span>	<span class="n">ATA_33</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5598&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5598</span><span class="p">,</span>	<span class="n">ATA_33</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5597&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5597</span><span class="p">,</span>	<span class="n">ATA_33</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5591/2&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5591</span><span class="p">,</span>	<span class="n">ATA_33</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5582&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5582</span><span class="p">,</span>	<span class="n">ATA_33</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5581&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5581</span><span class="p">,</span>	<span class="n">ATA_33</span>   <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;SiS5596&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5596</span><span class="p">,</span>	<span class="n">ATA_16</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5571&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5571</span><span class="p">,</span>	<span class="n">ATA_16</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS5517&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5517</span><span class="p">,</span>	<span class="n">ATA_16</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SiS551x&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_SI_5511</span><span class="p">,</span>	<span class="n">ATA_16</span>   <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Cycle time bits and values vary across chip dma capabilities</span>
<span class="cm">   These three arrays hold the register layout and the values to set.</span>
<span class="cm">   Indexed by chipset_family and (dma_mode - XFER_UDMA_0) */</span>

<span class="cm">/* {0, ATA_16, ATA_33, ATA_66, ATA_100a, ATA_100, ATA_133} */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">cycle_time_offset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">cycle_time_range</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">cycle_time_value</span><span class="p">[][</span><span class="n">XFER_UDMA_6</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* no UDMA */</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* no UDMA */</span>
	<span class="p">{</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* ATA_33 */</span>
	<span class="p">{</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* ATA_66 */</span>
	<span class="p">{</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* ATA_100a (730 specific),</span>
<span class="cm">				      different cycle_time range and offset */</span>
	<span class="p">{</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* ATA_100 */</span>
	<span class="p">{</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ATA_133a (earliest 691 southbridges) */</span>
	<span class="p">{</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ATA_133 */</span>
<span class="p">};</span>
<span class="cm">/* CRC Valid Setup Time vary across IDE clock setting 33/66/100/133</span>
<span class="cm">   See SiS962 data sheet for more detail */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">cvs_time_value</span><span class="p">[][</span><span class="n">XFER_UDMA_6</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* no UDMA */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* no UDMA */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cm">/* Initialize time, Active time, Recovery time vary across</span>
<span class="cm">   IDE clock settings. These 3 arrays hold the register value</span>
<span class="cm">   for PIO0/1/2/3/4 and DMA0/1/2 mode in order */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">ini_time_value</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">act_time_value</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">rco_time_value</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Printing configuration</span>
<span class="cm"> */</span>
<span class="cm">/* Used for chipset type printing at boot time */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chipset_capability</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ATA&quot;</span><span class="p">,</span> <span class="s">&quot;ATA 16&quot;</span><span class="p">,</span>
	<span class="s">&quot;ATA 33&quot;</span><span class="p">,</span> <span class="s">&quot;ATA 66&quot;</span><span class="p">,</span>
	<span class="s">&quot;ATA 100 (1st gen)&quot;</span><span class="p">,</span> <span class="s">&quot;ATA 100 (2nd gen)&quot;</span><span class="p">,</span>
	<span class="s">&quot;ATA 133 (1st gen)&quot;</span><span class="p">,</span> <span class="s">&quot;ATA 133 (2nd gen)&quot;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Configuration functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">sis_ata133_get_base</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg54</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg54</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">reg54</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x70</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">+</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_ata16_program_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drive_pci</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u16</span> <span class="n">pio_timings</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{</span> <span class="mh">0x000</span><span class="p">,</span> <span class="mh">0x607</span><span class="p">,</span> <span class="mh">0x404</span><span class="p">,</span> <span class="mh">0x303</span><span class="p">,</span> <span class="mh">0x301</span> <span class="p">};</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">mwdma_timings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x008</span><span class="p">,</span> <span class="mh">0x302</span><span class="p">,</span> <span class="mh">0x301</span> <span class="p">};</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">);</span>

	<span class="cm">/* clear active/recovery timings */</span>
	<span class="n">t1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x070f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_MW_DMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&gt;</span> <span class="n">ATA_16</span><span class="p">)</span>
			<span class="n">t1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">;</span>	<span class="cm">/* disable UDMA */</span>
		<span class="n">t1</span> <span class="o">|=</span> <span class="n">mwdma_timings</span><span class="p">[</span><span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t1</span> <span class="o">|=</span> <span class="n">pio_timings</span><span class="p">[</span><span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">];</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="n">t1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_ata100_program_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">t1</span><span class="p">,</span> <span class="n">drive_pci</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* timing bits: 7:4 active 3:0 recovery */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pio_timings</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">};</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">mwdma_timings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_MW_DMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">t2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t2</span><span class="p">);</span>
		<span class="n">t2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* disable UDMA */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="n">t2</span><span class="p">);</span>

		<span class="n">t1</span> <span class="o">=</span> <span class="n">mwdma_timings</span><span class="p">[</span><span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">t1</span> <span class="o">=</span> <span class="n">pio_timings</span><span class="p">[</span><span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">];</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_ata133_program_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drive_pci</span> <span class="o">=</span> <span class="n">sis_ata133_get_base</span><span class="p">(</span><span class="n">drive</span><span class="p">),</span> <span class="n">clk</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">);</span>

	<span class="n">t1</span> <span class="o">&amp;=</span> <span class="mh">0xc0c00fff</span><span class="p">;</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="n">ATA_133</span> <span class="o">:</span> <span class="n">ATA_100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_MW_DMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* disable UDMA */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>
	<span class="n">t1</span> <span class="o">|=</span> <span class="n">ini_time_value</span><span class="p">[</span><span class="n">clk</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">t1</span> <span class="o">|=</span> <span class="n">act_time_value</span><span class="p">[</span><span class="n">clk</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">t1</span> <span class="o">|=</span> <span class="n">rco_time_value</span><span class="p">[</span><span class="n">clk</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="n">t1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_program_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&lt;</span> <span class="n">ATA_100</span><span class="p">)</span>		<span class="cm">/* ATA_16/33/66/100a */</span>
		<span class="n">sis_ata16_program_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&lt;</span> <span class="n">ATA_133</span><span class="p">)</span>	<span class="cm">/* ATA_100/133a */</span>
		<span class="n">sis_ata100_program_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span>					<span class="cm">/* ATA_133 */</span>
		<span class="n">sis_ata133_program_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">config_drive_art_rwp</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reg4bh</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rw_prefetch</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg4bh</span><span class="p">);</span>

	<span class="n">rw_prefetch</span> <span class="o">=</span> <span class="n">reg4bh</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x11</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_disk</span><span class="p">)</span>
		<span class="n">rw_prefetch</span> <span class="o">|=</span> <span class="mh">0x11</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg4bh</span> <span class="o">!=</span> <span class="n">rw_prefetch</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="n">rw_prefetch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_set_pio_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">config_drive_art_rwp</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">sis_program_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_ata133_program_udma_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">regdw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drive_pci</span> <span class="o">=</span> <span class="n">sis_ata133_get_base</span><span class="p">(</span><span class="n">drive</span><span class="p">),</span> <span class="n">clk</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regdw</span><span class="p">);</span>

	<span class="n">regdw</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">regdw</span> <span class="o">&amp;=</span> <span class="mh">0xfffff00f</span><span class="p">;</span>
	<span class="cm">/* check if ATA133 enable */</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">regdw</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="n">ATA_133</span> <span class="o">:</span> <span class="n">ATA_100</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span><span class="p">;</span>
	<span class="n">regdw</span> <span class="o">|=</span> <span class="n">cycle_time_value</span><span class="p">[</span><span class="n">clk</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">regdw</span> <span class="o">|=</span> <span class="n">cvs_time_value</span><span class="p">[</span><span class="n">clk</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="n">regdw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_ata33_program_udma_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">drive_pci</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">chipset_family</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* force the UDMA bit on if we want to use UDMA */</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="cm">/* clean reg cycle time bits */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mh">0xff</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">cycle_time_range</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="n">cycle_time_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="cm">/* set reg cycle time bits */</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">cycle_time_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mode</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">cycle_time_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_program_udma_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&gt;=</span> <span class="n">ATA_133</span><span class="p">)</span>	<span class="cm">/* ATA_133 */</span>
		<span class="n">sis_ata133_program_udma_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span>				<span class="cm">/* ATA_33/66/100a/100/133a */</span>
		<span class="n">sis_ata33_program_udma_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sis_set_dma_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span>
		<span class="n">sis_program_udma_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sis_program_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">sis_ata133_udma_filter</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">regdw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">drive_pci</span> <span class="o">=</span> <span class="n">sis_ata133_get_base</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive_pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regdw</span><span class="p">);</span>

	<span class="cm">/* if ATA133 disable, we should not set speed above UDMA5 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">regdw</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis_find_family</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chipset_family</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">SiSHostChipInfo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chipset_family</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="n">SiSHostChipInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">chipset_family</span> <span class="o">=</span> <span class="n">SiSHostChipInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chipset_family</span><span class="p">;</span>

		<span class="cm">/* Special case for SiS630 : 630S/ET is ATA_100a */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SiSHostChipInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SI_630</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span>
				<span class="n">chipset_family</span> <span class="o">=</span> <span class="n">ATA_100a</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: %s %s controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">SiSHostChipInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			<span class="n">chipset_capability</span><span class="p">[</span><span class="n">chipset_family</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chipset_family</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Belongs to pci-quirks */</span>

			<span class="n">u32</span> <span class="n">idemisc</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">trueid</span><span class="p">;</span>

			<span class="cm">/* Disable ID masking and register remapping */</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idemisc</span><span class="p">);</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="p">(</span><span class="n">idemisc</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">));</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trueid</span><span class="p">);</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">idemisc</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">trueid</span> <span class="o">==</span> <span class="mh">0x5518</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: SiS 962/963 MuTIOL IDE UDMA133 controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
				<span class="n">chipset_family</span> <span class="o">=</span> <span class="n">ATA_133</span><span class="p">;</span>

				<span class="cm">/* Check for 5513 compatibility mapping</span>
<span class="cm">				 * We must use this, else the port enabled code will fail,</span>
<span class="cm">				 * as it expects the enablebits at 0x4a.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">idemisc</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">idemisc</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: Switching to 5513 register mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chipset_family</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Belongs to pci-quirks */</span>

			<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">lpc_bridge</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">trueid</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">prefctl</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">idecfg</span><span class="p">;</span>

			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idecfg</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="n">idecfg</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trueid</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="n">idecfg</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">trueid</span> <span class="o">==</span> <span class="mh">0x5517</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* SiS 961/961B */</span>

				<span class="n">lpc_bridge</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span> <span class="cm">/* Bus 0, Dev 2, Fn 0 */</span>
				<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prefctl</span><span class="p">);</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">lpc_bridge</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">lpc_bridge</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prefctl</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: SiS 961B MuTIOL IDE UDMA133 controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
					<span class="n">chipset_family</span> <span class="o">=</span> <span class="n">ATA_133a</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: SiS 961 MuTIOL IDE UDMA100 controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
					<span class="n">chipset_family</span> <span class="o">=</span> <span class="n">ATA_100</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">chipset_family</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_chipset_sis5513</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make general config ops here</span>
<span class="cm">	   1/ tell IDE channels to operate in Compatibility mode only</span>
<span class="cm">	   2/ tell old chips to allow per drive IDE timings */</span>

	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chipset_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_133</span>:
		<span class="cm">/* SiS962 operation mode */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regw</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">regw</span><span class="o">&amp;</span><span class="mh">0xfff7</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regw</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">regw</span><span class="o">&amp;</span><span class="mh">0xfff7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_133a</span>:
	<span class="k">case</span> <span class="n">ATA_100</span>:
		<span class="cm">/* Fixup latency */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="cm">/* Set compatibility bit */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">reg</span><span class="o">|</span><span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_100a</span>:
	<span class="k">case</span> <span class="n">ATA_66</span>:
		<span class="cm">/* Fixup latency */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

		<span class="cm">/* On ATA_66 chips the bit was elsewhere */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">reg</span><span class="o">|</span><span class="mh">0x04</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_33</span>:
		<span class="cm">/* On ATA_33 we didn&#39;t have a single bit to set */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">reg</span><span class="o">&amp;</span><span class="mh">0xf0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ATA_16</span>:
		<span class="cm">/* force per drive recovery and active timings</span>
<span class="cm">		   needed on ATA_33 and below chips */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">reg</span><span class="o">|</span><span class="mh">0x08</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sis_laptop</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subvendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subdevice</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sis_laptop</span> <span class="n">sis_laptop</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* devid, subvendor, subdev */</span>
	<span class="p">{</span> <span class="mh">0x5513</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x1107</span> <span class="p">},</span>	<span class="cm">/* ASUS A6K */</span>
	<span class="p">{</span> <span class="mh">0x5513</span><span class="p">,</span> <span class="mh">0x1734</span><span class="p">,</span> <span class="mh">0x105f</span> <span class="p">},</span>	<span class="cm">/* FSC Amilo A1630 */</span>
	<span class="p">{</span> <span class="mh">0x5513</span><span class="p">,</span> <span class="mh">0x1071</span><span class="p">,</span> <span class="mh">0x8640</span> <span class="p">},</span>     <span class="cm">/* EasyNote K5305 */</span>
	<span class="cm">/* end marker */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">sis_cable_detect</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sis_laptop</span> <span class="o">*</span><span class="n">lap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sis_laptop</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ata66</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lap</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lap</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">;</span>
		<span class="n">lap</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&gt;=</span> <span class="n">ATA_133</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">regw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">reg_addr</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x52</span><span class="o">:</span> <span class="mh">0x50</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regw</span><span class="p">);</span>
		<span class="n">ata66</span> <span class="o">=</span> <span class="p">(</span><span class="n">regw</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&gt;=</span> <span class="n">ATA_66</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg48h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg48h</span><span class="p">);</span>
		<span class="n">ata66</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg48h</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ata66</span> <span class="o">?</span> <span class="n">ATA_CBL_PATA80</span> <span class="o">:</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">sis_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">sis_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">sis_set_dma_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">sis_cable_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">sis_ata133_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">sis_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">sis_set_dma_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_filter</span>		<span class="o">=</span> <span class="n">sis_ata133_udma_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">sis_cable_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">sis5513_chipset</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_chipset</span>	<span class="o">=</span> <span class="n">init_chipset_sis5513</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enablebits</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">host_flags</span>	<span class="o">=</span> <span class="n">IDE_HFLAG_NO_AUTODMA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sis5513_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sis5513_chipset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udma_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sis_find_family</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chipset_family</span> <span class="o">&gt;=</span> <span class="n">ATA_133</span><span class="p">)</span>
		<span class="n">d</span><span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sis_ata133_port_ops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">d</span><span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sis_port_ops</span><span class="p">;</span>

	<span class="n">d</span><span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">udma_rates</span><span class="p">[</span><span class="n">chipset_family</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">ide_pci_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sis5513_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_pci_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">sis5513_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SI_5513</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SI_5518</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SI_1180</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">sis5513_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sis5513_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SIS_IDE&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sis5513_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sis5513_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sis5513_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ide_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ide_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sis5513_ide_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ide_pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sis5513_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sis5513_ide_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sis5513_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sis5513_ide_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sis5513_ide_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Lionel Bouton, L C Chang, Andre Hedrick, Vojtech Pavlik&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PCI driver module for SIS IDE&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
