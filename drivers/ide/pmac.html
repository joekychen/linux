<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › pmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Support for IDE interfaces on PowerMacs.</span>
<span class="cm"> *</span>
<span class="cm"> * These IDE interfaces are memory-mapped and have a DBDMA channel</span>
<span class="cm"> * for doing DMA.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1998-2003 Paul Mackerras &amp; Ben. Herrenschmidt</span>
<span class="cm"> *  Copyright (C) 2007-2008 Bartlomiej Zolnierkiewicz</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version</span>
<span class="cm"> *  2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Some code taken from drivers/ide/ide-dma.c:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1995-1998  Mark Lord</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: - Use pre-calculated (kauai) timing tables all the time and</span>
<span class="cm"> * get rid of the &quot;rounded&quot; tables used previously, so we have the</span>
<span class="cm"> * same table format for all controllers and can then just have one</span>
<span class="cm"> * big table</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/pmu.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dbdma.h&gt;</span>
<span class="cp">#include &lt;asm/ide.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mediabay.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;ide-pmac&quot;</span>

<span class="cp">#undef IDE_PMAC_DEBUG</span>

<span class="cp">#define DMA_WAIT_TIMEOUT	50</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">pmac_ide_hwif</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">regbase</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">kind</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">aapl_bus_id</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">broken_dma</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">broken_dma_warn</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span><span class="o">*</span>		<span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_dev</span>		<span class="o">*</span><span class="n">mdev</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">timings</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span>		<span class="o">*</span><span class="n">kauai_fcr</span><span class="p">;</span>
	<span class="n">ide_hwif_t</span>			<span class="o">*</span><span class="n">hwif</span><span class="p">;</span>

	<span class="cm">/* Those fields are duplicating what is in hwif. We currently</span>
<span class="cm">	 * can&#39;t use the hwif ones because of some assumptions that are</span>
<span class="cm">	 * beeing done by the generic code about the kind of dma controller</span>
<span class="cm">	 * and format of the dma table. This will have to be fixed though.</span>
<span class="cm">	 */</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span>	<span class="n">dma_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="o">*</span>		<span class="n">dma_table_cpu</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pmac_ide_hwif_t</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">controller_ohare</span><span class="p">,</span>	<span class="cm">/* OHare based */</span>
	<span class="n">controller_heathrow</span><span class="p">,</span>	<span class="cm">/* Heathrow/Paddington */</span>
	<span class="n">controller_kl_ata3</span><span class="p">,</span>	<span class="cm">/* KeyLargo ATA-3 */</span>
	<span class="n">controller_kl_ata4</span><span class="p">,</span>	<span class="cm">/* KeyLargo ATA-4 */</span>
	<span class="n">controller_un_ata6</span><span class="p">,</span>	<span class="cm">/* UniNorth2 ATA-6 */</span>
	<span class="n">controller_k2_ata6</span><span class="p">,</span>	<span class="cm">/* K2 ATA-6 */</span>
	<span class="n">controller_sh_ata6</span><span class="p">,</span>	<span class="cm">/* Shasta ATA-6 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">model_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;OHare ATA&quot;</span><span class="p">,</span>		<span class="cm">/* OHare based */</span>
	<span class="s">&quot;Heathrow ATA&quot;</span><span class="p">,</span>		<span class="cm">/* Heathrow/Paddington */</span>
	<span class="s">&quot;KeyLargo ATA-3&quot;</span><span class="p">,</span>	<span class="cm">/* KeyLargo ATA-3 (MDMA only) */</span>
	<span class="s">&quot;KeyLargo ATA-4&quot;</span><span class="p">,</span>	<span class="cm">/* KeyLargo ATA-4 (UDMA/66) */</span>
	<span class="s">&quot;UniNorth ATA-6&quot;</span><span class="p">,</span>	<span class="cm">/* UniNorth2 ATA-6 (UDMA/100) */</span>
	<span class="s">&quot;K2 ATA-6&quot;</span><span class="p">,</span>		<span class="cm">/* K2 ATA-6 (UDMA/100) */</span>
	<span class="s">&quot;Shasta ATA-6&quot;</span><span class="p">,</span>		<span class="cm">/* Shasta ATA-6 (UDMA/133) */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Extra registers, both 32-bit little-endian</span>
<span class="cm"> */</span>
<span class="cp">#define IDE_TIMING_CONFIG	0x200</span>
<span class="cp">#define IDE_INTERRUPT		0x300</span>

<span class="cm">/* Kauai (U2) ATA has different register setup */</span>
<span class="cp">#define IDE_KAUAI_PIO_CONFIG	0x200</span>
<span class="cp">#define IDE_KAUAI_ULTRA_CONFIG	0x210</span>
<span class="cp">#define IDE_KAUAI_POLL_CONFIG	0x220</span>

<span class="cm">/*</span>
<span class="cm"> * Timing configuration register definitions</span>
<span class="cm"> */</span>

<span class="cm">/* Number of IDE_SYSCLK_NS ticks, argument is in nanoseconds */</span>
<span class="cp">#define SYSCLK_TICKS(t)		(((t) + IDE_SYSCLK_NS - 1) / IDE_SYSCLK_NS)</span>
<span class="cp">#define SYSCLK_TICKS_66(t)	(((t) + IDE_SYSCLK_66_NS - 1) / IDE_SYSCLK_66_NS)</span>
<span class="cp">#define IDE_SYSCLK_NS		30	</span><span class="cm">/* 33Mhz cell */</span><span class="cp"></span>
<span class="cp">#define IDE_SYSCLK_66_NS	15	</span><span class="cm">/* 66Mhz cell */</span><span class="cp"></span>

<span class="cm">/* 133Mhz cell, found in shasta.</span>
<span class="cm"> * See comments about 100 Mhz Uninorth 2...</span>
<span class="cm"> * Note that PIO_MASK and MDMA_MASK seem to overlap</span>
<span class="cm"> */</span>
<span class="cp">#define TR_133_PIOREG_PIO_MASK		0xff000fff</span>
<span class="cp">#define TR_133_PIOREG_MDMA_MASK		0x00fff800</span>
<span class="cp">#define TR_133_UDMAREG_UDMA_MASK	0x0003ffff</span>
<span class="cp">#define TR_133_UDMAREG_UDMA_EN		0x00000001</span>

<span class="cm">/* 100Mhz cell, found in Uninorth 2. I don&#39;t have much infos about</span>
<span class="cm"> * this one yet, it appears as a pci device (106b/0033) on uninorth</span>
<span class="cm"> * internal PCI bus and it&#39;s clock is controlled like gem or fw. It</span>
<span class="cm"> * appears to be an evolution of keylargo ATA4 with a timing register</span>
<span class="cm"> * extended to 2 32bits registers and a similar DBDMA channel. Other</span>
<span class="cm"> * registers seem to exist but I can&#39;t tell much about them.</span>
<span class="cm"> * </span>
<span class="cm"> * So far, I&#39;m using pre-calculated tables for this extracted from</span>
<span class="cm"> * the values used by the MacOS X driver.</span>
<span class="cm"> * </span>
<span class="cm"> * The &quot;PIO&quot; register controls PIO and MDMA timings, the &quot;ULTRA&quot;</span>
<span class="cm"> * register controls the UDMA timings. At least, it seems bit 0</span>
<span class="cm"> * of this one enables UDMA vs. MDMA, and bits 4..7 are the</span>
<span class="cm"> * cycle time in units of 10ns. Bits 8..15 are used by I don&#39;t</span>
<span class="cm"> * know their meaning yet</span>
<span class="cm"> */</span>
<span class="cp">#define TR_100_PIOREG_PIO_MASK		0xff000fff</span>
<span class="cp">#define TR_100_PIOREG_MDMA_MASK		0x00fff000</span>
<span class="cp">#define TR_100_UDMAREG_UDMA_MASK	0x0000ffff</span>
<span class="cp">#define TR_100_UDMAREG_UDMA_EN		0x00000001</span>


<span class="cm">/* 66Mhz cell, found in KeyLargo. Can do ultra mode 0 to 2 on</span>
<span class="cm"> * 40 connector cable and to 4 on 80 connector one.</span>
<span class="cm"> * Clock unit is 15ns (66Mhz)</span>
<span class="cm"> * </span>
<span class="cm"> * 3 Values can be programmed:</span>
<span class="cm"> *  - Write data setup, which appears to match the cycle time. They</span>
<span class="cm"> *    also call it DIOW setup.</span>
<span class="cm"> *  - Ready to pause time (from spec)</span>
<span class="cm"> *  - Address setup. That one is weird. I don&#39;t see where exactly</span>
<span class="cm"> *    it fits in UDMA cycles, I got it&#39;s name from an obscure piece</span>
<span class="cm"> *    of commented out code in Darwin. They leave it to 0, we do as</span>
<span class="cm"> *    well, despite a comment that would lead to think it has a</span>
<span class="cm"> *    min value of 45ns.</span>
<span class="cm"> * Apple also add 60ns to the write data setup (or cycle time ?) on</span>
<span class="cm"> * reads.</span>
<span class="cm"> */</span>
<span class="cp">#define TR_66_UDMA_MASK			0xfff00000</span>
<span class="cp">#define TR_66_UDMA_EN			0x00100000 </span><span class="cm">/* Enable Ultra mode for DMA */</span><span class="cp"></span>
<span class="cp">#define TR_66_UDMA_ADDRSETUP_MASK	0xe0000000 </span><span class="cm">/* Address setup */</span><span class="cp"></span>
<span class="cp">#define TR_66_UDMA_ADDRSETUP_SHIFT	29</span>
<span class="cp">#define TR_66_UDMA_RDY2PAUS_MASK	0x1e000000 </span><span class="cm">/* Ready 2 pause time */</span><span class="cp"></span>
<span class="cp">#define TR_66_UDMA_RDY2PAUS_SHIFT	25</span>
<span class="cp">#define TR_66_UDMA_WRDATASETUP_MASK	0x01e00000 </span><span class="cm">/* Write data setup time */</span><span class="cp"></span>
<span class="cp">#define TR_66_UDMA_WRDATASETUP_SHIFT	21</span>
<span class="cp">#define TR_66_MDMA_MASK			0x000ffc00</span>
<span class="cp">#define TR_66_MDMA_RECOVERY_MASK	0x000f8000</span>
<span class="cp">#define TR_66_MDMA_RECOVERY_SHIFT	15</span>
<span class="cp">#define TR_66_MDMA_ACCESS_MASK		0x00007c00</span>
<span class="cp">#define TR_66_MDMA_ACCESS_SHIFT		10</span>
<span class="cp">#define TR_66_PIO_MASK			0x000003ff</span>
<span class="cp">#define TR_66_PIO_RECOVERY_MASK		0x000003e0</span>
<span class="cp">#define TR_66_PIO_RECOVERY_SHIFT	5</span>
<span class="cp">#define TR_66_PIO_ACCESS_MASK		0x0000001f</span>
<span class="cp">#define TR_66_PIO_ACCESS_SHIFT		0</span>

<span class="cm">/* 33Mhz cell, found in OHare, Heathrow (&amp; Paddington) and KeyLargo</span>
<span class="cm"> * Can do pio &amp; mdma modes, clock unit is 30ns (33Mhz)</span>
<span class="cm"> * </span>
<span class="cm"> * The access time and recovery time can be programmed. Some older</span>
<span class="cm"> * Darwin code base limit OHare to 150ns cycle time. I decided to do</span>
<span class="cm"> * the same here fore safety against broken old hardware ;)</span>
<span class="cm"> * The HalfTick bit, when set, adds half a clock (15ns) to the access</span>
<span class="cm"> * time and removes one from recovery. It&#39;s not supported on KeyLargo</span>
<span class="cm"> * implementation afaik. The E bit appears to be set for PIO mode 0 and</span>
<span class="cm"> * is used to reach long timings used in this mode.</span>
<span class="cm"> */</span>
<span class="cp">#define TR_33_MDMA_MASK			0x003ff800</span>
<span class="cp">#define TR_33_MDMA_RECOVERY_MASK	0x001f0000</span>
<span class="cp">#define TR_33_MDMA_RECOVERY_SHIFT	16</span>
<span class="cp">#define TR_33_MDMA_ACCESS_MASK		0x0000f800</span>
<span class="cp">#define TR_33_MDMA_ACCESS_SHIFT		11</span>
<span class="cp">#define TR_33_MDMA_HALFTICK		0x00200000</span>
<span class="cp">#define TR_33_PIO_MASK			0x000007ff</span>
<span class="cp">#define TR_33_PIO_E			0x00000400</span>
<span class="cp">#define TR_33_PIO_RECOVERY_MASK		0x000003e0</span>
<span class="cp">#define TR_33_PIO_RECOVERY_SHIFT	5</span>
<span class="cp">#define TR_33_PIO_ACCESS_MASK		0x0000001f</span>
<span class="cp">#define TR_33_PIO_ACCESS_SHIFT		0</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt register definitions</span>
<span class="cm"> */</span>
<span class="cp">#define IDE_INTR_DMA			0x80000000</span>
<span class="cp">#define IDE_INTR_DEVICE			0x40000000</span>

<span class="cm">/*</span>
<span class="cm"> * FCR Register on Kauai. Not sure what bit 0x4 is  ...</span>
<span class="cm"> */</span>
<span class="cp">#define KAUAI_FCR_UATA_MAGIC		0x00000004</span>
<span class="cp">#define KAUAI_FCR_UATA_RESET_N		0x00000002</span>
<span class="cp">#define KAUAI_FCR_UATA_ENABLE		0x00000001</span>

<span class="cm">/* Rounded Multiword DMA timings</span>
<span class="cm"> * </span>
<span class="cm"> * I gave up finding a generic formula for all controller</span>
<span class="cm"> * types and instead, built tables based on timing values</span>
<span class="cm"> * used by Apple in Darwin&#39;s implementation.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mdma_timings_t</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">accessTime</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">recoveryTime</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cycleTime</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mdma_timings_t</span> <span class="n">mdma_timings_33</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">270</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">210</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span> <span class="mi">150</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span> <span class="mi">120</span> <span class="p">},</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mdma_timings_t</span> <span class="n">mdma_timings_33k</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">210</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span> <span class="mi">150</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span> <span class="mi">120</span> <span class="p">},</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mdma_timings_t</span> <span class="n">mdma_timings_66</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">270</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">210</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span> <span class="mi">165</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span> <span class="mi">120</span> <span class="p">},</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* KeyLargo ATA-4 Ultra DMA timings (rounded) */</span>
<span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">addrSetup</span><span class="p">;</span> <span class="cm">/* ??? */</span>
	<span class="kt">int</span>	<span class="n">rdy2pause</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">wrDataSetup</span><span class="p">;</span>
<span class="p">}</span> <span class="n">kl66_udma_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span>  <span class="mi">120</span> <span class="p">},</span>	<span class="cm">/* Mode 0 */</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span>  <span class="mi">90</span> <span class="p">},</span>	<span class="cm">/*      1 */</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span>  <span class="mi">60</span> <span class="p">},</span>	<span class="cm">/*      2 */</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span>   <span class="mi">45</span> <span class="p">},</span>	<span class="cm">/*      3 */</span>
    <span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span>   <span class="mi">30</span> <span class="p">}</span>	<span class="cm">/*      4 */</span>
<span class="p">};</span>

<span class="cm">/* UniNorth 2 ATA/100 timings */</span>
<span class="k">struct</span> <span class="n">kauai_timing</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">cycle_time</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">timing_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kauai_timing</span>	<span class="n">kauai_pio_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">930</span>	<span class="p">,</span> <span class="mh">0x08000fff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">600</span>	<span class="p">,</span> <span class="mh">0x08000a92</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">383</span>	<span class="p">,</span> <span class="mh">0x0800060f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">360</span>	<span class="p">,</span> <span class="mh">0x08000492</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">330</span>	<span class="p">,</span> <span class="mh">0x0800048f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">300</span>	<span class="p">,</span> <span class="mh">0x080003cf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">270</span>	<span class="p">,</span> <span class="mh">0x080003cc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">240</span>	<span class="p">,</span> <span class="mh">0x0800038b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">239</span>	<span class="p">,</span> <span class="mh">0x0800030c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">180</span>	<span class="p">,</span> <span class="mh">0x05000249</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span>	<span class="p">,</span> <span class="mh">0x04000148</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span>	<span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kauai_timing</span>	<span class="n">kauai_mdma_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">1260</span>	<span class="p">,</span> <span class="mh">0x00fff000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">480</span>	<span class="p">,</span> <span class="mh">0x00618000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">360</span>	<span class="p">,</span> <span class="mh">0x00492000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">270</span>	<span class="p">,</span> <span class="mh">0x0038e000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">240</span>	<span class="p">,</span> <span class="mh">0x0030c000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">210</span>	<span class="p">,</span> <span class="mh">0x002cb000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">180</span>	<span class="p">,</span> <span class="mh">0x00249000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">150</span>	<span class="p">,</span> <span class="mh">0x00209000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span>	<span class="p">,</span> <span class="mh">0x00148000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span>	<span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kauai_timing</span>	<span class="n">kauai_udma_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">120</span>	<span class="p">,</span> <span class="mh">0x000070c0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">90</span>	<span class="p">,</span> <span class="mh">0x00005d80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">60</span>	<span class="p">,</span> <span class="mh">0x00004a60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">45</span>	<span class="p">,</span> <span class="mh">0x00003a50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">30</span>	<span class="p">,</span> <span class="mh">0x00002a30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">20</span>	<span class="p">,</span> <span class="mh">0x00002921</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span>	<span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kauai_timing</span>	<span class="n">shasta_pio_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">930</span>	<span class="p">,</span> <span class="mh">0x08000fff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">600</span>	<span class="p">,</span> <span class="mh">0x0A000c97</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">383</span>	<span class="p">,</span> <span class="mh">0x07000712</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">360</span>	<span class="p">,</span> <span class="mh">0x040003cd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">330</span>	<span class="p">,</span> <span class="mh">0x040003cd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">300</span>	<span class="p">,</span> <span class="mh">0x040003cd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">270</span>	<span class="p">,</span> <span class="mh">0x040003cd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">240</span>	<span class="p">,</span> <span class="mh">0x040003cd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">239</span>	<span class="p">,</span> <span class="mh">0x040003cd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">180</span>	<span class="p">,</span> <span class="mh">0x0400028b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span>	<span class="p">,</span> <span class="mh">0x0400010a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span>	<span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kauai_timing</span>	<span class="n">shasta_mdma_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">1260</span>	<span class="p">,</span> <span class="mh">0x00fff000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">480</span>	<span class="p">,</span> <span class="mh">0x00820800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">360</span>	<span class="p">,</span> <span class="mh">0x00820800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">270</span>	<span class="p">,</span> <span class="mh">0x00820800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">240</span>	<span class="p">,</span> <span class="mh">0x00820800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">210</span>	<span class="p">,</span> <span class="mh">0x00820800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">180</span>	<span class="p">,</span> <span class="mh">0x00820800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">150</span>	<span class="p">,</span> <span class="mh">0x0028b000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span>	<span class="p">,</span> <span class="mh">0x001ca000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span>	<span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kauai_timing</span>	<span class="n">shasta_udma133_timings</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">120</span>   <span class="p">,</span> <span class="mh">0x00035901</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">90</span>    <span class="p">,</span> <span class="mh">0x000348b1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">60</span>    <span class="p">,</span> <span class="mh">0x00033881</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">45</span>    <span class="p">,</span> <span class="mh">0x00033861</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">30</span>    <span class="p">,</span> <span class="mh">0x00033841</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">20</span>    <span class="p">,</span> <span class="mh">0x00033031</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">15</span>    <span class="p">,</span> <span class="mh">0x00033021</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span>	<span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">kauai_lookup_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">kauai_timing</span><span class="o">*</span> <span class="n">table</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cycle_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cycle_time</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cycle_time</span> <span class="o">&gt;</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">cycle_time</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timing_reg</span><span class="p">;</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allow up to 256 DBDMA commands per xfer */</span>
<span class="cp">#define MAX_DCMDS		256</span>

<span class="cm">/* </span>
<span class="cm"> * Wait 1s for disk to answer on IDE bus after a hard reset</span>
<span class="cm"> * of the device (via GPIO/FCR).</span>
<span class="cm"> * </span>
<span class="cm"> * Some devices seem to &quot;pollute&quot; the bus even after dropping</span>
<span class="cm"> * the BSY bit (typically some combo drives slave on the UDMA</span>
<span class="cm"> * bus) after a hard reset. Since we hard reset all drives on</span>
<span class="cm"> * KeyLargo ATA66, we have to keep that delay around. I may end</span>
<span class="cm"> * up not hard resetting anymore on these and keep the delay only</span>
<span class="cm"> * for older interfaces instead (we have to reset when coming</span>
<span class="cm"> * from MacOS...) --BenH. </span>
<span class="cm"> */</span>
<span class="cp">#define IDE_WAKEUP_DELAY	(1*HZ)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pmac_ide_init_dma</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#define PMAC_IDE_REG(x) \</span>
<span class="cp">	((void __iomem *)((drive)-&gt;hwif-&gt;io_ports.data_addr + (x)))</span>

<span class="cm">/*</span>
<span class="cm"> * Apply the timings of the proper unit (master/slave) to the shared</span>
<span class="cm"> * timing register when selecting that unit. This version is for</span>
<span class="cm"> * ASICs with a single timing register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_apply_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Apply the timings of the proper unit (master/slave) to the shared</span>
<span class="cm"> * timing register when selecting that unit. This version is for</span>
<span class="cm"> * ASICs with a dual timing register (Kauai)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_kauai_apply_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_KAUAI_PIO_CONFIG</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_KAUAI_ULTRA_CONFIG</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_KAUAI_PIO_CONFIG</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_KAUAI_ULTRA_CONFIG</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_KAUAI_PIO_CONFIG</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force an update of controller timing values for a given drive</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pmac_ide_do_update_timings</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_sh_ata6</span> <span class="o">||</span>
	    <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_un_ata6</span> <span class="o">||</span>
	    <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_k2_ata6</span><span class="p">)</span>
		<span class="n">pmac_ide_kauai_apply_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pmac_ide_apply_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_dev_select</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_apply_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">select</span> <span class="o">|</span> <span class="n">ATA_DEVICE_OBS</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">device_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_kauai_dev_select</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_kauai_apply_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">select</span> <span class="o">|</span> <span class="n">ATA_DEVICE_OBS</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">device_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_exec_command</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">command_addr</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">data_addr</span>
				     <span class="o">+</span> <span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_write_devctl</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">data_addr</span>
				     <span class="o">+</span> <span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Old tuning functions (called on hdparm -p), sets up drive PIO timings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_set_pio_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pio</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_timing</span> <span class="o">*</span><span class="n">tim</span> <span class="o">=</span> <span class="n">ide_timing_find_mode</span><span class="p">(</span><span class="n">XFER_PIO_0</span> <span class="o">+</span> <span class="n">pio</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">accessTicks</span><span class="p">,</span> <span class="n">recTicks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">accessTime</span><span class="p">,</span> <span class="n">recTime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cycle_time</span><span class="p">;</span>

	<span class="cm">/* which drive is it ? */</span>
	<span class="n">timings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">timings</span><span class="p">;</span>

	<span class="n">cycle_time</span> <span class="o">=</span> <span class="n">ide_pio_cycle_time</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">pio</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">controller_sh_ata6</span>: <span class="p">{</span>
		<span class="cm">/* 133Mhz cell */</span>
		<span class="n">u32</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">kauai_lookup_timing</span><span class="p">(</span><span class="n">shasta_pio_timings</span><span class="p">,</span> <span class="n">cycle_time</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_133_PIOREG_PIO_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">controller_un_ata6</span>:
	<span class="k">case</span> <span class="n">controller_k2_ata6</span>: <span class="p">{</span>
		<span class="cm">/* 100Mhz cell */</span>
		<span class="n">u32</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">kauai_lookup_timing</span><span class="p">(</span><span class="n">kauai_pio_timings</span><span class="p">,</span> <span class="n">cycle_time</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_100_PIOREG_PIO_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">controller_kl_ata4</span>:
		<span class="cm">/* 66Mhz cell */</span>
		<span class="n">recTime</span> <span class="o">=</span> <span class="n">cycle_time</span> <span class="o">-</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">-</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">;</span>
		<span class="n">recTime</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">recTime</span><span class="p">,</span> <span class="mi">150U</span><span class="p">);</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">accessTime</span><span class="p">,</span> <span class="mi">150U</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">accessTime</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">recTime</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_66_PIO_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">accessTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_66_PIO_ACCESS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">recTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_66_PIO_RECOVERY_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="p">{</span>
		<span class="cm">/* 33Mhz cell */</span>
		<span class="kt">int</span> <span class="n">ebit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">recTime</span> <span class="o">=</span> <span class="n">cycle_time</span> <span class="o">-</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">-</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">;</span>
		<span class="n">recTime</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">recTime</span><span class="p">,</span> <span class="mi">150U</span><span class="p">);</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">accessTime</span><span class="p">,</span> <span class="mi">150U</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS</span><span class="p">(</span><span class="n">accessTime</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mi">4U</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS</span><span class="p">(</span><span class="n">recTime</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mi">5U</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recTicks</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">recTicks</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* guess, but it&#39;s only for PIO0, so... */</span>
			<span class="n">ebit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_33_PIO_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">accessTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_33_PIO_ACCESS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">recTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_33_PIO_RECOVERY_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ebit</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">|=</span> <span class="n">TR_33_PIO_E</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef IDE_PMAC_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Set PIO timing for mode %d, reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pio</span><span class="p">,</span>  <span class="o">*</span><span class="n">timings</span><span class="p">);</span>
<span class="cp">#endif	</span>

	<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">pmac_ide_do_update_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate KeyLargo ATA/66 UDMA timings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_timings_udma_ata4</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span> <span class="n">u8</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">rdyToPauseTicks</span><span class="p">,</span> <span class="n">wrDataSetupTicks</span><span class="p">,</span> <span class="n">addrTicks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rdyToPauseTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">kl66_udma_timings</span><span class="p">[</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">rdy2pause</span><span class="p">);</span>
	<span class="n">wrDataSetupTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">kl66_udma_timings</span><span class="p">[</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">wrDataSetup</span><span class="p">);</span>
	<span class="n">addrTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">kl66_udma_timings</span><span class="p">[</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">addrSetup</span><span class="p">);</span>

	<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TR_66_UDMA_MASK</span> <span class="o">|</span> <span class="n">TR_66_MDMA_MASK</span><span class="p">))</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">wrDataSetupTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_66_UDMA_WRDATASETUP_SHIFT</span><span class="p">)</span> <span class="o">|</span> 
			<span class="p">(</span><span class="n">rdyToPauseTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_66_UDMA_RDY2PAUS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">addrTicks</span> <span class="o">&lt;&lt;</span><span class="n">TR_66_UDMA_ADDRSETUP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">TR_66_UDMA_EN</span><span class="p">;</span>
<span class="cp">#ifdef IDE_PMAC_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ide_pmac: Set UDMA timing for mode %d, reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>  <span class="o">*</span><span class="n">timings</span><span class="p">);</span>
<span class="cp">#endif	</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate Kauai ATA/100 UDMA timings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_timings_udma_ata6</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">pio_timings</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ultra_timings</span><span class="p">,</span> <span class="n">u8</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_timing</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">ide_timing_find_mode</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_5</span> <span class="o">||</span> <span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tr</span> <span class="o">=</span> <span class="n">kauai_lookup_timing</span><span class="p">(</span><span class="n">kauai_udma_timings</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ultra_timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">ultra_timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_100_UDMAREG_UDMA_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ultra_timings</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ultra_timings</span><span class="p">)</span> <span class="o">|</span> <span class="n">TR_100_UDMAREG_UDMA_EN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate Shasta ATA/133 UDMA timings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_timings_udma_shasta</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">pio_timings</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ultra_timings</span><span class="p">,</span> <span class="n">u8</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_timing</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">ide_timing_find_mode</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_6</span> <span class="o">||</span> <span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tr</span> <span class="o">=</span> <span class="n">kauai_lookup_timing</span><span class="p">(</span><span class="n">shasta_udma133_timings</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ultra_timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">ultra_timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_133_UDMAREG_UDMA_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ultra_timings</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ultra_timings</span><span class="p">)</span> <span class="o">|</span> <span class="n">TR_133_UDMAREG_UDMA_EN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate MDMA timings for all cells</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_timings_mdma</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intf_type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">timings2</span><span class="p">,</span>
		 	<span class="n">u8</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cycleTime</span><span class="p">,</span> <span class="n">accessTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">recTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">accessTicks</span><span class="p">,</span> <span class="n">recTicks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mdma_timings_t</span><span class="o">*</span> <span class="n">tm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Get default cycle time for mode */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">cycleTime</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">cycleTime</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">cycleTime</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if drive provides explicit DMA cycle time */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FIELD_VALID</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_EIDE_DMA_TIME</span><span class="p">])</span>
		<span class="n">cycleTime</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_EIDE_DMA_TIME</span><span class="p">],</span> <span class="n">cycleTime</span><span class="p">);</span>

	<span class="cm">/* OHare limits according to some old Apple sources */</span>	
	<span class="k">if</span> <span class="p">((</span><span class="n">intf_type</span> <span class="o">==</span> <span class="n">controller_ohare</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cycleTime</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">))</span>
		<span class="n">cycleTime</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
	<span class="cm">/* Get the proper timing array for this controller */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">intf_type</span><span class="p">)</span> <span class="p">{</span>
	        <span class="k">case</span> <span class="n">controller_sh_ata6</span>:
		<span class="k">case</span> <span class="n">controller_un_ata6</span>:
		<span class="k">case</span> <span class="n">controller_k2_ata6</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">controller_kl_ata4</span>:
			<span class="n">tm</span> <span class="o">=</span> <span class="n">mdma_timings_66</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">controller_kl_ata3</span>:
			<span class="n">tm</span> <span class="o">=</span> <span class="n">mdma_timings_33k</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tm</span> <span class="o">=</span> <span class="n">mdma_timings_33</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tm</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Lookup matching access &amp; recovery times */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tm</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">cycleTime</span> <span class="o">&lt;</span> <span class="n">cycleTime</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cycleTime</span> <span class="o">=</span> <span class="n">tm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cycleTime</span><span class="p">;</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">tm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">accessTime</span><span class="p">;</span>
		<span class="n">recTime</span> <span class="o">=</span> <span class="n">tm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">recoveryTime</span><span class="p">;</span>

<span class="cp">#ifdef IDE_PMAC_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: MDMA, cycleTime: %d, accessTime: %d, recTime: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cycleTime</span><span class="p">,</span> <span class="n">accessTime</span><span class="p">,</span> <span class="n">recTime</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">intf_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">controller_sh_ata6</span>: <span class="p">{</span>
		<span class="cm">/* 133Mhz cell */</span>
		<span class="n">u32</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">kauai_lookup_timing</span><span class="p">(</span><span class="n">shasta_mdma_timings</span><span class="p">,</span> <span class="n">cycleTime</span><span class="p">);</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_133_PIOREG_MDMA_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">timings2</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">timings2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_133_UDMAREG_UDMA_EN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">controller_un_ata6</span>:
	<span class="k">case</span> <span class="n">controller_k2_ata6</span>: <span class="p">{</span>
		<span class="cm">/* 100Mhz cell */</span>
		<span class="n">u32</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">kauai_lookup_timing</span><span class="p">(</span><span class="n">kauai_mdma_timings</span><span class="p">,</span> <span class="n">cycleTime</span><span class="p">);</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_100_PIOREG_MDMA_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">timings2</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">timings2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_100_UDMAREG_UDMA_EN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">controller_kl_ata4</span>:
		<span class="cm">/* 66Mhz cell */</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">accessTime</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mh">0x1U</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS_66</span><span class="p">(</span><span class="n">recTime</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mh">0x3U</span><span class="p">);</span>
		<span class="cm">/* Clear out mdma bits and disable udma */</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TR_66_MDMA_MASK</span> <span class="o">|</span> <span class="n">TR_66_UDMA_MASK</span><span class="p">))</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">accessTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_66_MDMA_ACCESS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">recTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_66_MDMA_RECOVERY_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">controller_kl_ata3</span>:
		<span class="cm">/* 33Mhz cell on KeyLargo */</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS</span><span class="p">(</span><span class="n">accessTime</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mi">1U</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">accessTicks</span> <span class="o">*</span> <span class="n">IDE_SYSCLK_NS</span><span class="p">;</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS</span><span class="p">(</span><span class="n">recTime</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mi">1U</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_33_MDMA_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">accessTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_33_MDMA_ACCESS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">recTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_33_MDMA_RECOVERY_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="p">{</span>
		<span class="cm">/* 33Mhz cell on others */</span>
		<span class="kt">int</span> <span class="n">halfTick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">origAccessTime</span> <span class="o">=</span> <span class="n">accessTime</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">origRecTime</span> <span class="o">=</span> <span class="n">recTime</span><span class="p">;</span>
		
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS</span><span class="p">(</span><span class="n">accessTime</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mi">1U</span><span class="p">);</span>
		<span class="n">accessTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">accessTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">accessTime</span> <span class="o">=</span> <span class="n">accessTicks</span> <span class="o">*</span> <span class="n">IDE_SYSCLK_NS</span><span class="p">;</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">SYSCLK_TICKS</span><span class="p">(</span><span class="n">recTime</span><span class="p">);</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mi">2U</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">recTicks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">recTicks</span><span class="p">,</span> <span class="mh">0x1fU</span><span class="p">);</span>
		<span class="n">recTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">recTicks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">IDE_SYSCLK_NS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">accessTicks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">accessTime</span> <span class="o">-</span> <span class="n">IDE_SYSCLK_NS</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">origAccessTime</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">recTime</span> <span class="o">-</span> <span class="n">IDE_SYSCLK_NS</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">origRecTime</span><span class="p">))</span> <span class="p">{</span>
            		<span class="n">halfTick</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">accessTicks</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">timings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_33_MDMA_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">accessTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_33_MDMA_ACCESS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">recTicks</span> <span class="o">&lt;&lt;</span> <span class="n">TR_33_MDMA_RECOVERY_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">halfTick</span><span class="p">)</span>
			<span class="o">*</span><span class="n">timings</span> <span class="o">|=</span> <span class="n">TR_33_MDMA_HALFTICK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef IDE_PMAC_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Set MDMA timing for mode %d, reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>  <span class="o">*</span><span class="n">timings</span><span class="p">);</span>
<span class="cp">#endif	</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_set_dma_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">timings</span><span class="p">,</span> <span class="o">*</span><span class="n">timings2</span><span class="p">,</span> <span class="n">tl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">;</span>

	<span class="n">timings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">unit</span><span class="p">];</span>
	<span class="n">timings2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">unit</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Copy timings to local image */</span>
	<span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">timings</span><span class="p">;</span>
	<span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">timings2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_kl_ata4</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_timings_udma_ata4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_un_ata6</span>
			 <span class="o">||</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_k2_ata6</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_timings_udma_ata6</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_sh_ata6</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_timings_udma_shasta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_timings_mdma</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Apply timings to controller */</span>
	<span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">timings2</span> <span class="o">=</span> <span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">pmac_ide_do_update_timings</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>	
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Blast some well known &quot;safe&quot; values to the timing registers at init or</span>
<span class="cm"> * wakeup from sleep time, before we do real calculation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sanitize_timings</span><span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">value2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="k">switch</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">controller_sh_ata6</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x0a820c97</span><span class="p">;</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="mh">0x00033031</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">controller_un_ata6</span>:
		<span class="k">case</span> <span class="n">controller_k2_ata6</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x08618a92</span><span class="p">;</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="mh">0x00002921</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">controller_kl_ata4</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x0008438c</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">controller_kl_ata3</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00084526</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">controller_heathrow</span>:
		<span class="k">case</span> <span class="n">controller_ohare</span>:
		<span class="nl">default:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00074526</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">value2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">on_media_bay</span><span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">&amp;&amp;</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Suspend call back, should be called after the child devices</span>
<span class="cm"> * have actually been suspended</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_ide_do_suspend</span><span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We clear the timings */</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* The media bay will handle itself just fine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="cm">/* Kauai has bus control FCRs directly here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fcr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">);</span>
		<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KAUAI_FCR_UATA_RESET_N</span> <span class="o">|</span> <span class="n">KAUAI_FCR_UATA_ENABLE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the bus on older machines and the cell on kauai */</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Resume call back, should be called before the child devices</span>
<span class="cm"> * are resumed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_ide_do_resume</span><span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Hard reset &amp; re-enable controller (do we really need to reset ? -BenH) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Kauai has it different */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">fcr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">);</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KAUAI_FCR_UATA_RESET_N</span> <span class="o">|</span> <span class="n">KAUAI_FCR_UATA_ENABLE</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">IDE_WAKEUP_DELAY</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Sanitize drive timings */</span>
	<span class="n">sanitize_timings</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pmac_ide_cable_detect</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cable</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cable-type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Get cable type from device-tree. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cable</span><span class="p">,</span> <span class="s">&quot;80-&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Some drives fail to detect 80c cable in PowerBook */</span>
		<span class="cm">/* These machine use proprietary short IDE cable anyway */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;PowerBook&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * G5&#39;s seem to have incorrect cable type in device-tree.</span>
<span class="cm">	 * Let&#39;s assume they have a 80 conductor cable, this seem</span>
<span class="cm">	 * to be always the case unless the user mucked around.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;K2-UATA&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;shasta-ata&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_init_dev</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">)</span> <span class="o">==</span> <span class="n">MB_CD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_NOPROBE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NOPROBE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_tp_ops</span> <span class="n">pmac_tp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">exec_command</span>		<span class="o">=</span> <span class="n">pmac_exec_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>		<span class="o">=</span> <span class="n">ide_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_altstatus</span>		<span class="o">=</span> <span class="n">ide_read_altstatus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_devctl</span>		<span class="o">=</span> <span class="n">pmac_write_devctl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dev_select</span>		<span class="o">=</span> <span class="n">pmac_dev_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tf_load</span>		<span class="o">=</span> <span class="n">ide_tf_load</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tf_read</span>		<span class="o">=</span> <span class="n">ide_tf_read</span><span class="p">,</span>

	<span class="p">.</span><span class="n">input_data</span>		<span class="o">=</span> <span class="n">ide_input_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_data</span>		<span class="o">=</span> <span class="n">ide_output_data</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_tp_ops</span> <span class="n">pmac_ata6_tp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">exec_command</span>		<span class="o">=</span> <span class="n">pmac_exec_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>		<span class="o">=</span> <span class="n">ide_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_altstatus</span>		<span class="o">=</span> <span class="n">ide_read_altstatus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_devctl</span>		<span class="o">=</span> <span class="n">pmac_write_devctl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dev_select</span>		<span class="o">=</span> <span class="n">pmac_kauai_dev_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tf_load</span>		<span class="o">=</span> <span class="n">ide_tf_load</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tf_read</span>		<span class="o">=</span> <span class="n">ide_tf_read</span><span class="p">,</span>

	<span class="p">.</span><span class="n">input_data</span>		<span class="o">=</span> <span class="n">ide_input_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_data</span>		<span class="o">=</span> <span class="n">ide_output_data</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">pmac_ide_ata4_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_dev</span>		<span class="o">=</span> <span class="n">pmac_ide_init_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">pmac_ide_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">pmac_ide_set_dma_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">pmac_ide_cable_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">pmac_ide_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_dev</span>		<span class="o">=</span> <span class="n">pmac_ide_init_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">pmac_ide_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">pmac_ide_set_dma_mode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="n">pmac_dma_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">pmac_port_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_dma</span>		<span class="o">=</span> <span class="n">pmac_ide_init_dma</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset</span>		<span class="o">=</span> <span class="n">ide_pmac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tp_ops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_tp_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ide_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_dma_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">host_flags</span>		<span class="o">=</span> <span class="n">IDE_HFLAG_SET_PIO_MODE_KEEP_DMA</span> <span class="o">|</span>
				  <span class="n">IDE_HFLAG_POST_SET_MODE</span> <span class="o">|</span>
				  <span class="n">IDE_HFLAG_MMIO</span> <span class="o">|</span>
				  <span class="n">IDE_HFLAG_UNMASK_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pio_mask</span>		<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mwdma_mask</span>		<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Setup, register &amp; probe an IDE channel driven by this driver, this is</span>
<span class="cm"> * called by one of the 2 probe functions (macio or PCI).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pmac_ide_setup_device</span><span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bidp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">*</span><span class="n">hws</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">hw</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pmac_port_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">broken_dma</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">broken_dma_warn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;shasta-ata&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_sh_ata6</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ata6_tp_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ide_ata4_port_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;kauai-ata&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_un_ata6</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ata6_tp_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ide_ata4_port_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;K2-UATA&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_k2_ata6</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ata6_tp_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ide_ata4_port_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;keylargo-ata&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ata-4&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_kl_ata4</span><span class="p">;</span>
			<span class="n">d</span><span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_ide_ata4_port_ops</span><span class="p">;</span>
			<span class="n">d</span><span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_kl_ata3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;heathrow-ata&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_heathrow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">controller_ohare</span><span class="p">;</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">broken_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bidp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;AAPL,bus-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span> <span class="o">=</span>  <span class="n">bidp</span> <span class="o">?</span> <span class="o">*</span><span class="n">bidp</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* On Kauai-type controllers, we make sure the FCR is correct */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">KAUAI_FCR_UATA_MAGIC</span> <span class="o">|</span>
		       <span class="n">KAUAI_FCR_UATA_RESET_N</span> <span class="o">|</span>
		       <span class="n">KAUAI_FCR_UATA_ENABLE</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span><span class="p">);</span>
	
	<span class="cm">/* Make sure we have sane timings */</span>
	<span class="n">sanitize_timings</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>

	<span class="cm">/* If we are on a media bay, wait for it to settle and lock it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">)</span>
		<span class="n">lock_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">ide_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">hws</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwif</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Fixup bus ID for media bay */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bidp</span><span class="p">)</span>
			<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_ohare</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The code below is having trouble on some ohare machines</span>
<span class="cm">		 * (timing related ?). Until I can put my hand on one of these</span>
<span class="cm">		 * units, I keep the old way</span>
<span class="cm">		 */</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 		<span class="cm">/* This is necessary to enable IDE when net-booting */</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">IDE_WAKEUP_DELAY</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Found Apple %s controller (%s), &quot;</span>
	       <span class="s">&quot;bus ID %d%s, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">[</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">],</span>
	       <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">?</span> <span class="s">&quot;macio&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI&quot;</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">aapl_bus_id</span><span class="p">,</span>
	       <span class="n">on_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (mediabay)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_host_register</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">hws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">)</span>
		<span class="n">unlock_media_bay</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">);</span>

 <span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="p">)</span>
		<span class="n">ide_host_free</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pmac_ide_init_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_ports_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">ctl_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attach to a macio probed interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">pmac_ide_macio_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regbase</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_hw</span> <span class="n">hw</span><span class="p">;</span>

	<span class="n">pmif</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmif</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macio_resource_count</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ide-pmac: no address for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_pmif</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request memory resource for IO ports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_request_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ide-pmac (ports)&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ide-pmac: can&#39;t request MMIO resource for &quot;</span>
				<span class="s">&quot;%s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_pmif</span><span class="p">;</span>
	<span class="p">}</span>
			
	<span class="cm">/* XXX This is bogus. Should be fixed in the registry by checking</span>
<span class="cm">	 * the kind of host interrupt controller, a bit like gatwick</span>
<span class="cm">	 * fixes in irq.c. That works well enough for the single case</span>
<span class="cm">	 * where that happens though...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_irq_count</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ide-pmac: no intrs for device %s, using &quot;</span>
				    <span class="s">&quot;13</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_create_mapping</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">macio_irq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">macio_resource_start</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x400</span><span class="p">);</span>
	<span class="n">regbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="n">regbase</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macio_resource_count</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio_request_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ide-pmac (dma)&quot;</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ide-pmac: can&#39;t request DMA &quot;</span>
					    <span class="s">&quot;resource for %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">macio_resource_start</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">pmif</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">pmac_ide_init_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>
	<span class="n">hw</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">hw</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hw</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmac_ide_setup_device</span><span class="p">(</span><span class="n">pmif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The inteface is released to the common IDE layer */</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">);</span>
			<span class="n">macio_release_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">macio_release_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out_free_pmif:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pmac_ide_macio_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">PM_EVENT_SLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmac_ide_do_suspend</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">mesg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pmac_ide_macio_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmac_ide_do_resume</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attach to a PCI probed interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">pmac_ide_pci_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rbase</span><span class="p">,</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_hw</span> <span class="n">hw</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ide-pmac: cannot find MacIO node for Kauai ATA interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmif</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmif</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ide-pmac: Can&#39;t enable PCI device for &quot;</span>
				    <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_pmif</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;Kauai ATA&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ide-pmac: Cannot obtain PCI resources for &quot;</span>
				<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_pmif</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>

	<span class="n">rbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rlen</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">rbase</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kauai_fcr</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pmif</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">pmac_ide_init_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">);</span>
	<span class="n">hw</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">hw</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmac_ide_setup_device</span><span class="p">(</span><span class="n">pmif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The inteface is released to the common IDE layer */</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out_free_pmif:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pmac_ide_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">PM_EVENT_SLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmac_ide_do_suspend</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">mesg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pmac_ide_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmac_ide_do_resume</span><span class="p">(</span><span class="n">pmif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PMAC_MEDIABAY</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_macio_mb_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span><span class="o">*</span> <span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mb_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">mb_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MB_CD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
			<span class="n">ide_port_scan</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
			<span class="n">ide_port_unregister_devices</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PMAC_MEDIABAY */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">pmac_ide_macio_match</span><span class="p">[]</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="s">&quot;IDE&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="s">&quot;ATA&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;ide&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;ata&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">macio_driver</span> <span class="n">pmac_ide_macio_driver</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="s">&quot;ide-pmac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span>	<span class="o">=</span> <span class="n">pmac_ide_macio_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pmac_ide_macio_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">pmac_ide_macio_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">pmac_ide_macio_resume</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PMAC_MEDIABAY</span>
	<span class="p">.</span><span class="n">mediabay_event</span>	<span class="o">=</span> <span class="n">pmac_ide_macio_mb_event</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pmac_ide_pci_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_UNI_N_ATA</span><span class="p">),</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_IPID_ATA100</span><span class="p">),</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_K2_ATA100</span><span class="p">),</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_SH_ATA</span><span class="p">),</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_IPID2_ATA</span><span class="p">),</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pmac_ide_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ide-pmac&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pmac_ide_pci_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pmac_ide_pci_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">pmac_ide_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">pmac_ide_pci_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pmac_ide_pci_match</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">pmac_ide_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_IDE_PMAC_ATA100FIRST</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_ide_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">macio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_ide_macio_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_ide_pci_driver</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">macio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_ide_macio_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_ide_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">macio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_ide_macio_driver</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pmac_ide_build_dmatable builds the DBDMA command list</span>
<span class="cm"> * for a transfer and sets the DBDMA channel to point to it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_ide_build_dmatable</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wr</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf_flags</span> <span class="o">&amp;</span> <span class="n">IDE_TFLAG_WRITE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_nents</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DMA table is already aligned */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_table_cpu</span><span class="p">;</span>

	<span class="cm">/* Make sure DMA controller is stopped (necessary ?) */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">RUN</span><span class="o">|</span><span class="n">PAUSE</span><span class="o">|</span><span class="n">FLUSH</span><span class="o">|</span><span class="n">WAKE</span><span class="o">|</span><span class="n">DEAD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RUN</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Build DBDMA commands list */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cur_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">cur_len</span><span class="p">;</span>

		<span class="n">cur_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">cur_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">broken_dma</span> <span class="o">&amp;&amp;</span> <span class="n">cur_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">L1_CACHE_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">broken_dma_warn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: DMA on non aligned address, &quot;</span>
				       <span class="s">&quot;switching to PIO on Ohare chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">broken_dma_warn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cur_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_len</span> <span class="o">&lt;</span> <span class="mh">0xfe00</span><span class="p">)</span><span class="o">?</span> <span class="n">cur_len</span><span class="o">:</span> <span class="mh">0xfe00</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">MAX_DCMDS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: DMA table too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">wr</span><span class="o">?</span> <span class="n">OUTPUT_MORE</span><span class="o">:</span> <span class="n">INPUT_MORE</span><span class="p">);</span>
			<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
			<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">cur_addr</span><span class="p">);</span>
			<span class="n">table</span><span class="o">-&gt;</span><span class="n">cmd_dep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">table</span><span class="o">-&gt;</span><span class="n">xfer_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">table</span><span class="o">-&gt;</span><span class="n">res_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cur_addr</span> <span class="o">+=</span> <span class="n">tc</span><span class="p">;</span>
			<span class="n">cur_len</span> <span class="o">-=</span> <span class="n">tc</span><span class="p">;</span>
			<span class="o">++</span><span class="n">table</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert the last command to an input/output last command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">command</span><span class="p">,</span> <span class="n">wr</span><span class="o">?</span> <span class="n">OUTPUT_LAST</span><span class="o">:</span> <span class="n">INPUT_LAST</span><span class="p">);</span>
		<span class="cm">/* add the stop command to the end of the list */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">));</span>
		<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_STOP</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: empty DMA table?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* revert to PIO for this request */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare a DMA transfer. We build the DMA table, adjust the timings for</span>
<span class="cm"> * a read on KeyLargo ATA/66 and mark us as waiting for DMA completion</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmac_ide_dma_setup</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ata4</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">controller_kl_ata4</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">write</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf_flags</span> <span class="o">&amp;</span> <span class="n">IDE_TFLAG_WRITE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_ide_build_dmatable</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Apple adds 60ns to wrDataSetup on reads */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TR_66_UDMA_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">write</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x00800000UL</span><span class="p">),</span>
			<span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">PMAC_IDE_REG</span><span class="p">(</span><span class="n">IDE_TIMING_CONFIG</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Kick the DMA controller into life after the DMA command has been issued</span>
<span class="cm"> * to the drive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pmac_ide_dma_start</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">RUN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="cm">/* Make sure it gets to the controller right now */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * After a DMA transfer, make sure the controller is stopped</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pmac_ide_dma_end</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dstat</span><span class="p">;</span>

	<span class="n">dstat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">RUN</span><span class="o">|</span><span class="n">WAKE</span><span class="o">|</span><span class="n">DEAD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/* verify good dma status. we don&#39;t check for ACTIVE beeing 0. We should...</span>
<span class="cm">	 * in theory, but with ATAPI decices doing buffer underruns, that would</span>
<span class="cm">	 * cause us to disable DMA, which isn&#39;t what we want</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RUN</span><span class="o">|</span><span class="n">DEAD</span><span class="p">))</span> <span class="o">!=</span> <span class="n">RUN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check out that the interrupt we got was for us. We can&#39;t always know this</span>
<span class="cm"> * for sure with those Apple interfaces (well, we could on the recent ones but</span>
<span class="cm"> * that&#39;s not implemented yet), on the other hand, we don&#39;t have shared interrupts</span>
<span class="cm"> * so it&#39;s not really a problem</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pmac_ide_dma_test_irq</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* We have to things to deal with here:</span>
<span class="cm">	 * </span>
<span class="cm">	 * - The dbdma won&#39;t stop if the command was started</span>
<span class="cm">	 * but completed with an error without transferring all</span>
<span class="cm">	 * datas. This happens when bad blocks are met during</span>
<span class="cm">	 * a multi-block transfer.</span>
<span class="cm">	 * </span>
<span class="cm">	 * - The dbdma fifo hasn&#39;t yet finished flushing to</span>
<span class="cm">	 * to system memory when the disk interrupt occurs.</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>

	<span class="cm">/* If ACTIVE is cleared, the STOP command have passed and</span>
<span class="cm">	 * transfer is complete.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If dbdma didn&#39;t execute the STOP command yet, the</span>
<span class="cm">	 * active bit is still set. We consider that we aren&#39;t</span>
<span class="cm">	 * sharing interrupts (which is hopefully the case with</span>
<span class="cm">	 * those controllers) and so we just try to flush the</span>
<span class="cm">	 * channel for pending data in the fifo</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">FLUSH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FLUSH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ide%d, ide_dma_test_irq timeout flushing channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>	
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_ide_dma_host_set</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pmac_ide_dma_lost_irq</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ide-pmac lost interrupt, dma status: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="n">pmac_dma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_host_set</span>		<span class="o">=</span> <span class="n">pmac_ide_dma_host_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_setup</span>		<span class="o">=</span> <span class="n">pmac_ide_dma_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_start</span>		<span class="o">=</span> <span class="n">pmac_ide_dma_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_end</span>		<span class="o">=</span> <span class="n">pmac_ide_dma_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_test_irq</span>		<span class="o">=</span> <span class="n">pmac_ide_dma_test_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_lost_irq</span>		<span class="o">=</span> <span class="n">pmac_ide_dma_lost_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the data structures needed for using DMA with an interface</span>
<span class="cm"> * and fill the proper list of functions pointers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pmac_ide_init_dma</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="n">pmif</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">pmac_ide_hwif_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We won&#39;t need pci_dev if we switch to generic consistent</span>
<span class="cm">	 * DMA routines ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_regs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate space for the DBDMA commands.</span>
<span class="cm">	 * The +2 is +1 for the stop command and +1 to allow for</span>
<span class="cm">	 * aligning the start address to a multiple of 16 bytes.</span>
<span class="cm">	 */</span>
	<span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_table_cpu</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span>
		<span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">MAX_DCMDS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dmatable_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmif</span><span class="o">-&gt;</span><span class="n">dma_table_cpu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to allocate DMA command list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_max_nents</span> <span class="o">=</span> <span class="n">MAX_DCMDS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pmac_ide_probe</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
