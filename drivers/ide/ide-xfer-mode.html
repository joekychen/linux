<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-xfer-mode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-xfer-mode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">udma_str</span><span class="p">[]</span> <span class="o">=</span>
	 <span class="p">{</span> <span class="s">&quot;UDMA/16&quot;</span><span class="p">,</span> <span class="s">&quot;UDMA/25&quot;</span><span class="p">,</span>  <span class="s">&quot;UDMA/33&quot;</span><span class="p">,</span>  <span class="s">&quot;UDMA/44&quot;</span><span class="p">,</span>
	   <span class="s">&quot;UDMA/66&quot;</span><span class="p">,</span> <span class="s">&quot;UDMA/100&quot;</span><span class="p">,</span> <span class="s">&quot;UDMA/133&quot;</span><span class="p">,</span> <span class="s">&quot;UDMA7&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mwdma_str</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="s">&quot;MWDMA0&quot;</span><span class="p">,</span> <span class="s">&quot;MWDMA1&quot;</span><span class="p">,</span> <span class="s">&quot;MWDMA2&quot;</span><span class="p">,</span> <span class="s">&quot;MWDMA3&quot;</span><span class="p">,</span> <span class="s">&quot;MWDMA4&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">swdma_str</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="s">&quot;SWDMA0&quot;</span><span class="p">,</span> <span class="s">&quot;SWDMA1&quot;</span><span class="p">,</span> <span class="s">&quot;SWDMA2&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pio_str</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="s">&quot;PIO0&quot;</span><span class="p">,</span> <span class="s">&quot;PIO1&quot;</span><span class="p">,</span> <span class="s">&quot;PIO2&quot;</span><span class="p">,</span> <span class="s">&quot;PIO3&quot;</span><span class="p">,</span> <span class="s">&quot;PIO4&quot;</span><span class="p">,</span> <span class="s">&quot;PIO5&quot;</span><span class="p">,</span> <span class="s">&quot;PIO6&quot;</span> <span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_xfer_verbose	-	return IDE mode names</span>
<span class="cm"> *	@mode: transfer mode</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a constant string giving the name of the mode</span>
<span class="cm"> *	requested.</span>
<span class="cm"> */</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ide_xfer_verbose</span><span class="p">(</span><span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">XFER_UDMA_7</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">udma_str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_MW_DMA_0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">XFER_MW_DMA_4</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">mwdma_str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_SW_DMA_0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">XFER_SW_DMA_2</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">swdma_str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">XFER_PIO_0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">XFER_PIO_6</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">pio_str</span><span class="p">[</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XFER_PIO_SLOW</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;PIO SLOW&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;XFER ERROR&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ide_xfer_verbose</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_get_best_pio_mode	-	get PIO mode from drive</span>
<span class="cm"> *	@drive: drive to consider</span>
<span class="cm"> *	@mode_wanted: preferred mode</span>
<span class="cm"> *	@max_mode: highest allowed mode</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine returns the recommended PIO settings for a given drive,</span>
<span class="cm"> *	based on the drive-&gt;id information and the ide_pio_blacklist[].</span>
<span class="cm"> *</span>
<span class="cm"> *	Drive PIO mode is auto-selected if 255 is passed as mode_wanted.</span>
<span class="cm"> *	This is used by most chipset support modules when &quot;auto-tuning&quot;.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ide_get_best_pio_mode</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode_wanted</span><span class="p">,</span> <span class="n">u8</span> <span class="n">max_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pio_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">overridden</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_wanted</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">mode_wanted</span><span class="p">,</span> <span class="n">max_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_PIO_NO_BLACKLIST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pio_mode</span> <span class="o">=</span> <span class="n">ide_scan_pio_blacklist</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pio_mode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: is on PIO blacklist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pio_mode</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_PIO_MODES</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pio_mode</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 2 is maximum allowed tPIO value */</span>
			<span class="n">pio_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">overridden</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FIELD_VALID</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	      <span class="cm">/* ATA2? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_is_cfa</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFA_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
				<span class="n">pio_mode</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
						     <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFA_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_iordy</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PIO_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">overridden</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PIO_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
						<span class="n">pio_mode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PIO_MODES</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">pio_mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">pio_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">overridden</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: tPIO &gt; 2, assuming tPIO = 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pio_mode</span> <span class="o">&gt;</span> <span class="n">max_mode</span><span class="p">)</span>
		<span class="n">pio_mode</span> <span class="o">=</span> <span class="n">max_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pio_mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_pio_need_iordy</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * IORDY may lead to controller lock up on certain controllers</span>
<span class="cm">	 * if the port is not occupied.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_flags</span> <span class="o">&amp;</span> <span class="n">IDE_PFLAG_PROBING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ata_id_pio_need_iordy</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pio</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_pio_need_iordy</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_set_pio_mode</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_SET_MODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_pio_mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: temporary hack for some legacy host drivers that didn&#39;t</span>
<span class="cm">	 * set transfer mode on the device in -&gt;set_pio_mode method...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_dma_mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_pio_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_POST_SET_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ide_config_drive_speed</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_pio_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_pio_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ide_config_drive_speed</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_set_dma_mode</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_SET_MODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_dma_mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_POST_SET_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ide_config_drive_speed</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_dma_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_dma_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ide_config_drive_speed</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_set_dma_mode</span><span class="p">);</span>

<span class="cm">/* req_pio == &quot;255&quot; for auto-tune */</span>
<span class="kt">void</span> <span class="nf">ide_set_pio</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req_pio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">host_pio</span><span class="p">,</span> <span class="n">pio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_pio_mode</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_SET_MODE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">host_pio</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">pio_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pio</span> <span class="o">=</span> <span class="n">ide_get_best_pio_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">req_pio</span><span class="p">,</span> <span class="n">host_pio</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO:</span>
<span class="cm">	 * - report device max PIO mode</span>
<span class="cm">	 * - check req_pio != 255 against device max PIO mode</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: host max PIO%d wanted PIO%d%s selected PIO%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">host_pio</span><span class="p">,</span> <span class="n">req_pio</span><span class="p">,</span>
			  <span class="n">req_pio</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">?</span> <span class="s">&quot;(auto-tune)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pio</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ide_set_pio_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">XFER_PIO_0</span> <span class="o">+</span> <span class="n">pio</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_set_pio</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_rate_filter		-	filter transfer mode</span>
<span class="cm"> *	@drive: IDE device</span>
<span class="cm"> *	@speed: desired speed</span>
<span class="cm"> *</span>
<span class="cm"> *	Given the available transfer modes this function returns</span>
<span class="cm"> *	the best available speed at or below the speed requested.</span>
<span class="cm"> *</span>
<span class="cm"> *	TODO: check device PIO capabilities</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ide_rate_filter</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">ide_find_dma_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">pio_mask</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">pio_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">XFER_PIO_4</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*	printk(&quot;%s: mode 0x%02x, speed 0x%02x\n&quot;, __func__, mode, speed); */</span>

	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_set_xfer_rate	-	set transfer rate</span>
<span class="cm"> *	@drive: drive to set</span>
<span class="cm"> *	@rate: speed to attempt to set</span>
<span class="cm"> *</span>
<span class="cm"> *	General helper for setting the speed of an IDE device. This</span>
<span class="cm"> *	function knows about user enforced limits from the configuration</span>
<span class="cm"> *	which -&gt;set_pio_mode/-&gt;set_dma_mode does not.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ide_set_xfer_rate</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">set_dma_mode</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_SET_MODE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">ide_rate_filter</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="n">XFER_PIO_0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">XFER_PIO_0</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">XFER_PIO_6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ide_set_pio_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ide_set_dma_mode</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
