<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › hpt366.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hpt366.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 1999-2003		Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> * Portions Copyright (C) 2001	        Sun Microsystems, Inc.</span>
<span class="cm"> * Portions Copyright (C) 2003		Red Hat Inc</span>
<span class="cm"> * Portions Copyright (C) 2007		Bartlomiej Zolnierkiewicz</span>
<span class="cm"> * Portions Copyright (C) 2005-2009	MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to HighPoint Technologies for their assistance, and hardware.</span>
<span class="cm"> * Special Thanks to Jon Burchmore in SanDiego for the deep pockets, his</span>
<span class="cm"> * donation of an ABit BP6 mainboard, processor, and memory acellerated</span>
<span class="cm"> * development and support.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * HighPoint has its own drivers (open source except for the RAID part)</span>
<span class="cm"> * available from http://www.highpoint-tech.com/USA_new/service_support.htm </span>
<span class="cm"> * This may be useful to anyone wanting to work on this driver, however  do not</span>
<span class="cm"> * trust  them too much since the code tends to become less and less meaningful</span>
<span class="cm"> * as the time passes... :-/</span>
<span class="cm"> *</span>
<span class="cm"> * Note that final HPT370 support was done by force extraction of GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * - add function for getting/setting power status of drive</span>
<span class="cm"> * - the HPT370&#39;s state machine can get confused. reset it before each dma </span>
<span class="cm"> *   xfer to prevent that from happening.</span>
<span class="cm"> * - reset state engine whenever we get an error.</span>
<span class="cm"> * - check for busmaster state at end of dma. </span>
<span class="cm"> * - use new highpoint timings.</span>
<span class="cm"> * - detect bus speed using highpoint register.</span>
<span class="cm"> * - use pll if we don&#39;t have a clock table. added a 66MHz table that&#39;s</span>
<span class="cm"> *   just 2x the 33MHz table.</span>
<span class="cm"> * - removed turnaround. NOTE: we never want to switch between pll and</span>
<span class="cm"> *   pci clocks as the chip can glitch in those cases. the highpoint</span>
<span class="cm"> *   approved workaround slows everything down too much to be useful. in</span>
<span class="cm"> *   addition, we would have to serialize access to each chip.</span>
<span class="cm"> * 	Adrian Sun &lt;a.sun@sun.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * add drive timings for 66MHz PCI bus,</span>
<span class="cm"> * fix ATA Cable signal detection, fix incorrect /proc info</span>
<span class="cm"> * add /proc display for per-drive PIO/DMA/UDMA mode and</span>
<span class="cm"> * per-channel ATA-33/66 Cable detect.</span>
<span class="cm"> * 	Duncan Laurie &lt;void@sun.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * fixup /proc output for multiple controllers</span>
<span class="cm"> *	Tim Hockin &lt;thockin@sun.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * On hpt366: </span>
<span class="cm"> * Reset the hpt366 on error, reset on dma</span>
<span class="cm"> * Fix disabling Fast Interrupt hpt366.</span>
<span class="cm"> * 	Mike Waychison &lt;crlf@sun.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Added support for 372N clocking and clock switching. The 372N needs</span>
<span class="cm"> * different clocks on read/write. This requires overloading rw_disk and</span>
<span class="cm"> * other deeply crazy things. Thanks to &lt;http://www.hoerstreich.de&gt; for</span>
<span class="cm"> * keeping me sane. </span>
<span class="cm"> *		Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * - fix the clock turnaround code: it was writing to the wrong ports when</span>
<span class="cm"> *   called for the secondary channel, caching the current clock mode per-</span>
<span class="cm"> *   channel caused the cached register value to get out of sync with the</span>
<span class="cm"> *   actual one, the channels weren&#39;t serialized, the turnaround shouldn&#39;t</span>
<span class="cm"> *   be done on 66 MHz PCI bus</span>
<span class="cm"> * - disable UltraATA/100 for HPT370 by default as the 33 MHz clock being used</span>
<span class="cm"> *   does not allow for this speed anyway</span>
<span class="cm"> * - avoid touching disabled channels (e.g. HPT371/N are single channel chips,</span>
<span class="cm"> *   their primary channel is kind of virtual, it isn&#39;t tied to any pins)</span>
<span class="cm"> * - fix/remove bad/unused timing tables and use one set of tables for the whole</span>
<span class="cm"> *   HPT37x chip family; save space by introducing the separate transfer mode</span>
<span class="cm"> *   table in which the mode lookup is done</span>
<span class="cm"> * - use f_CNT value saved by  the HighPoint BIOS as reading it directly gives</span>
<span class="cm"> *   the wrong PCI frequency since DPLL has already been calibrated by BIOS;</span>
<span class="cm"> *   read it only from the function 0 of HPT374 chips</span>
<span class="cm"> * - fix the hotswap code:  it caused RESET- to glitch when tristating the bus,</span>
<span class="cm"> *   and for HPT36x the obsolete HDIO_TRISTATE_HWIF handler was called instead</span>
<span class="cm"> * - pass to init_chipset() handlers a copy of the IDE PCI device structure as</span>
<span class="cm"> *   they tamper with its fields</span>
<span class="cm"> * - pass  to the init_setup handlers a copy of the ide_pci_device_t structure</span>
<span class="cm"> *   since they may tamper with its fields</span>
<span class="cm"> * - prefix the driver startup messages with the real chip name</span>
<span class="cm"> * - claim the extra 240 bytes of I/O space for all chips</span>
<span class="cm"> * - optimize the UltraDMA filtering and the drive list lookup code</span>
<span class="cm"> * - use pci_get_slot() to get to the function 1 of HPT36x/374</span>
<span class="cm"> * - cache offset of the channel&#39;s misc. control registers (MCRs) being used</span>
<span class="cm"> *   throughout the driver</span>
<span class="cm"> * - only touch the relevant MCR when detecting the cable type on HPT374&#39;s</span>
<span class="cm"> *   function 1</span>
<span class="cm"> * - rename all the register related variables consistently</span>
<span class="cm"> * - move all the interrupt twiddling code from the speedproc handlers into</span>
<span class="cm"> *   init_hwif_hpt366(), also grouping all the DMA related code together there</span>
<span class="cm"> * - merge HPT36x/HPT37x speedproc handlers, fix PIO timing register mask and</span>
<span class="cm"> *   separate the UltraDMA and MWDMA masks there to avoid changing PIO timings</span>
<span class="cm"> *   when setting an UltraDMA mode</span>
<span class="cm"> * - fix hpt3xx_tune_drive() to set the PIO mode requested, not always select</span>
<span class="cm"> *   the best possible one</span>
<span class="cm"> * - clean up DMA timeout handling for HPT370</span>
<span class="cm"> * - switch to using the enumeration type to differ between the numerous chip</span>
<span class="cm"> *   variants, matching PCI device/revision ID with the chip type early, at the</span>
<span class="cm"> *   init_setup stage</span>
<span class="cm"> * - extend the hpt_info structure to hold the DPLL and PCI clock frequencies,</span>
<span class="cm"> *   stop duplicating it for each channel by storing the pointer in the pci_dev</span>
<span class="cm"> *   structure: first, at the init_setup stage, point it to a static &quot;template&quot;</span>
<span class="cm"> *   with only the chip type and its specific base DPLL frequency, the highest</span>
<span class="cm"> *   UltraDMA mode, and the chip settings table pointer filled,  then, at the</span>
<span class="cm"> *   init_chipset stage, allocate per-chip instance  and fill it with the rest</span>
<span class="cm"> *   of the necessary information</span>
<span class="cm"> * - get rid of the constant thresholds in the HPT37x PCI clock detection code,</span>
<span class="cm"> *   switch  to calculating  PCI clock frequency based on the chip&#39;s base DPLL</span>
<span class="cm"> *   frequency</span>
<span class="cm"> * - switch to using the  DPLL clock and enable UltraATA/133 mode by default on</span>
<span class="cm"> *   anything  newer than HPT370/A (except HPT374 that is not capable of this</span>
<span class="cm"> *   mode according to the manual)</span>
<span class="cm"> * - fold PCI clock detection and DPLL setup code into init_chipset_hpt366(),</span>
<span class="cm"> *   also fixing the interchanged 25/40 MHz PCI clock cases for HPT36x chips;</span>
<span class="cm"> *   unify HPT36x/37x timing setup code and the speedproc handlers by joining</span>
<span class="cm"> *   the register setting lists into the table indexed by the clock selected</span>
<span class="cm"> * - set the correct hwif-&gt;ultra_mask for each individual chip</span>
<span class="cm"> * - add Ultra and MW DMA mode filtering for the HPT37[24] based SATA cards</span>
<span class="cm"> * - stop resetting HPT370&#39;s state machine before each DMA transfer as that has</span>
<span class="cm"> *   caused more harm than good</span>
<span class="cm"> *	Sergei Shtylyov, &lt;sshtylyov@ru.mvista.com&gt; or &lt;source@mvista.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;hpt366&quot;</span>

<span class="cm">/* various tuning parameters */</span>
<span class="cp">#undef	HPT_RESET_STATE_ENGINE</span>
<span class="cp">#undef	HPT_DELAY_INTERRUPT</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bad_ata100_5</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;IBM-DTLA-307075&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307060&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307045&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307030&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307020&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307015&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-305040&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-305030&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-305020&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L010AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L020AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L030AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L040AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L060AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;WDC AC310200R&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bad_ata66_4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;IBM-DTLA-307075&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307060&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307045&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307030&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307020&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-307015&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-305040&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-305030&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM-DTLA-305020&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L010AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L020AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L030AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L040AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IC35L060AVER07-0&quot;</span><span class="p">,</span>
	<span class="s">&quot;WDC AC310200R&quot;</span><span class="p">,</span>
	<span class="s">&quot;MAXTOR STM3320620A&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bad_ata66_3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;WDC AC310200R&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bad_ata33</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Maxtor 92720U8&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 92040U6&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91360U4&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91020U3&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90845U3&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90650U2&quot;</span><span class="p">,</span>
	<span class="s">&quot;Maxtor 91360D8&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91190D7&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91020D6&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90845D5&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90680D4&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90510D3&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90340D2&quot;</span><span class="p">,</span>
	<span class="s">&quot;Maxtor 91152D8&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91008D7&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90845D6&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90840D6&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90720D5&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90648D5&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90576D4&quot;</span><span class="p">,</span>
	<span class="s">&quot;Maxtor 90510D4&quot;</span><span class="p">,</span>
	<span class="s">&quot;Maxtor 90432D3&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90288D2&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90256D2&quot;</span><span class="p">,</span>
	<span class="s">&quot;Maxtor 91000D8&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90910D8&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90875D7&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90840D7&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90750D6&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90625D5&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90500D4&quot;</span><span class="p">,</span>
	<span class="s">&quot;Maxtor 91728D8&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91512D7&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91303D6&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 91080D5&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90845D4&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90680D4&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90648D3&quot;</span><span class="p">,</span> <span class="s">&quot;Maxtor 90432D2&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">xfer_speeds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">XFER_UDMA_6</span><span class="p">,</span>
	<span class="n">XFER_UDMA_5</span><span class="p">,</span>
	<span class="n">XFER_UDMA_4</span><span class="p">,</span>
	<span class="n">XFER_UDMA_3</span><span class="p">,</span>
	<span class="n">XFER_UDMA_2</span><span class="p">,</span>
	<span class="n">XFER_UDMA_1</span><span class="p">,</span>
	<span class="n">XFER_UDMA_0</span><span class="p">,</span>

	<span class="n">XFER_MW_DMA_2</span><span class="p">,</span>
	<span class="n">XFER_MW_DMA_1</span><span class="p">,</span>
	<span class="n">XFER_MW_DMA_0</span><span class="p">,</span>

	<span class="n">XFER_PIO_4</span><span class="p">,</span>
	<span class="n">XFER_PIO_3</span><span class="p">,</span>
	<span class="n">XFER_PIO_2</span><span class="p">,</span>
	<span class="n">XFER_PIO_1</span><span class="p">,</span>
	<span class="n">XFER_PIO_0</span>
<span class="p">};</span>

<span class="cm">/* Key for bus clock timings</span>
<span class="cm"> * 36x   37x</span>
<span class="cm"> * bits  bits</span>
<span class="cm"> * 0:3	 0:3	data_high_time. Inactive time of DIOW_/DIOR_ for PIO and MW DMA.</span>
<span class="cm"> *		cycles = value + 1</span>
<span class="cm"> * 4:7	 4:8	data_low_time. Active time of DIOW_/DIOR_ for PIO and MW DMA.</span>
<span class="cm"> *		cycles = value + 1</span>
<span class="cm"> * 8:11  9:12	cmd_high_time. Inactive time of DIOW_/DIOR_ during task file</span>
<span class="cm"> *		register access.</span>
<span class="cm"> * 12:15 13:17	cmd_low_time. Active time of DIOW_/DIOR_ during task file</span>
<span class="cm"> *		register access.</span>
<span class="cm"> * 16:18 18:20	udma_cycle_time. Clock cycles for UDMA xfer.</span>
<span class="cm"> * -	 21	CLK frequency: 0=ATA clock, 1=dual ATA clock.</span>
<span class="cm"> * 19:21 22:24	pre_high_time. Time to initialize the 1st cycle for PIO and</span>
<span class="cm"> *		MW DMA xfer.</span>
<span class="cm"> * 22:24 25:27	cmd_pre_high_time. Time to initialize the 1st PIO cycle for</span>
<span class="cm"> *		task file register access.</span>
<span class="cm"> * 28	 28	UDMA enable.</span>
<span class="cm"> * 29	 29	DMA  enable.</span>
<span class="cm"> * 30	 30	PIO MST enable. If set, the chip is in bus master mode during</span>
<span class="cm"> *		PIO xfer.</span>
<span class="cm"> * 31	 31	FIFO enable.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">forty_base_hpt36x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* XFER_UDMA_6 */</span>	<span class="mh">0x900fd943</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_5 */</span>	<span class="mh">0x900fd943</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_4 */</span>	<span class="mh">0x900fd943</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_3 */</span>	<span class="mh">0x900ad943</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_2 */</span>	<span class="mh">0x900bd943</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_1 */</span>	<span class="mh">0x9008d943</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_0 */</span>	<span class="mh">0x9008d943</span><span class="p">,</span>

	<span class="cm">/* XFER_MW_DMA_2 */</span>	<span class="mh">0xa008d943</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_1 */</span>	<span class="mh">0xa010d955</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_0 */</span>	<span class="mh">0xa010d9fc</span><span class="p">,</span>

	<span class="cm">/* XFER_PIO_4 */</span>	<span class="mh">0xc008d963</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_3 */</span>	<span class="mh">0xc010d974</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_2 */</span>	<span class="mh">0xc010d997</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_1 */</span>	<span class="mh">0xc010d9c7</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_0 */</span>	<span class="mh">0xc018d9d9</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">thirty_three_base_hpt36x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* XFER_UDMA_6 */</span>	<span class="mh">0x90c9a731</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_5 */</span>	<span class="mh">0x90c9a731</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_4 */</span>	<span class="mh">0x90c9a731</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_3 */</span>	<span class="mh">0x90cfa731</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_2 */</span>	<span class="mh">0x90caa731</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_1 */</span>	<span class="mh">0x90cba731</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_0 */</span>	<span class="mh">0x90c8a731</span><span class="p">,</span>

	<span class="cm">/* XFER_MW_DMA_2 */</span>	<span class="mh">0xa0c8a731</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_1 */</span>	<span class="mh">0xa0c8a732</span><span class="p">,</span>	<span class="cm">/* 0xa0c8a733 */</span>
	<span class="cm">/* XFER_MW_DMA_0 */</span>	<span class="mh">0xa0c8a797</span><span class="p">,</span>

	<span class="cm">/* XFER_PIO_4 */</span>	<span class="mh">0xc0c8a731</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_3 */</span>	<span class="mh">0xc0c8a742</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_2 */</span>	<span class="mh">0xc0d0a753</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_1 */</span>	<span class="mh">0xc0d0a7a3</span><span class="p">,</span>	<span class="cm">/* 0xc0d0a793 */</span>
	<span class="cm">/* XFER_PIO_0 */</span>	<span class="mh">0xc0d0a7aa</span>	<span class="cm">/* 0xc0d0a7a7 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">twenty_five_base_hpt36x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* XFER_UDMA_6 */</span>	<span class="mh">0x90c98521</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_5 */</span>	<span class="mh">0x90c98521</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_4 */</span>	<span class="mh">0x90c98521</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_3 */</span>	<span class="mh">0x90cf8521</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_2 */</span>	<span class="mh">0x90cf8521</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_1 */</span>	<span class="mh">0x90cb8521</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_0 */</span>	<span class="mh">0x90cb8521</span><span class="p">,</span>

	<span class="cm">/* XFER_MW_DMA_2 */</span>	<span class="mh">0xa0ca8521</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_1 */</span>	<span class="mh">0xa0ca8532</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_0 */</span>	<span class="mh">0xa0ca8575</span><span class="p">,</span>

	<span class="cm">/* XFER_PIO_4 */</span>	<span class="mh">0xc0ca8521</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_3 */</span>	<span class="mh">0xc0ca8532</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_2 */</span>	<span class="mh">0xc0ca8542</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_1 */</span>	<span class="mh">0xc0d08572</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_0 */</span>	<span class="mh">0xc0d08585</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following are the new timing tables with PIO mode data/taskfile transfer</span>
<span class="cm"> * overclocking fixed...</span>
<span class="cm"> */</span>

<span class="cm">/* This table is taken from the HPT370 data manual rev. 1.02 */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">thirty_three_base_hpt37x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* XFER_UDMA_6 */</span>	<span class="mh">0x16455031</span><span class="p">,</span>	<span class="cm">/* 0x16655031 ?? */</span>
	<span class="cm">/* XFER_UDMA_5 */</span>	<span class="mh">0x16455031</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_4 */</span>	<span class="mh">0x16455031</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_3 */</span>	<span class="mh">0x166d5031</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_2 */</span>	<span class="mh">0x16495031</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_1 */</span>	<span class="mh">0x164d5033</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_0 */</span>	<span class="mh">0x16515097</span><span class="p">,</span>

	<span class="cm">/* XFER_MW_DMA_2 */</span>	<span class="mh">0x26515031</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_1 */</span>	<span class="mh">0x26515033</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_0 */</span>	<span class="mh">0x26515097</span><span class="p">,</span>

	<span class="cm">/* XFER_PIO_4 */</span>	<span class="mh">0x06515021</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_3 */</span>	<span class="mh">0x06515022</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_2 */</span>	<span class="mh">0x06515033</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_1 */</span>	<span class="mh">0x06915065</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_0 */</span>	<span class="mh">0x06d1508a</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">fifty_base_hpt37x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* XFER_UDMA_6 */</span>	<span class="mh">0x1a861842</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_5 */</span>	<span class="mh">0x1a861842</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_4 */</span>	<span class="mh">0x1aae1842</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_3 */</span>	<span class="mh">0x1a8e1842</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_2 */</span>	<span class="mh">0x1a0e1842</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_1 */</span>	<span class="mh">0x1a161854</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_0 */</span>	<span class="mh">0x1a1a18ea</span><span class="p">,</span>

	<span class="cm">/* XFER_MW_DMA_2 */</span>	<span class="mh">0x2a821842</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_1 */</span>	<span class="mh">0x2a821854</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_0 */</span>	<span class="mh">0x2a8218ea</span><span class="p">,</span>

	<span class="cm">/* XFER_PIO_4 */</span>	<span class="mh">0x0a821842</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_3 */</span>	<span class="mh">0x0a821843</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_2 */</span>	<span class="mh">0x0a821855</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_1 */</span>	<span class="mh">0x0ac218a8</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_0 */</span>	<span class="mh">0x0b02190c</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">sixty_six_base_hpt37x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* XFER_UDMA_6 */</span>	<span class="mh">0x1c86fe62</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_5 */</span>	<span class="mh">0x1caefe62</span><span class="p">,</span>	<span class="cm">/* 0x1c8afe62 */</span>
	<span class="cm">/* XFER_UDMA_4 */</span>	<span class="mh">0x1c8afe62</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_3 */</span>	<span class="mh">0x1c8efe62</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_2 */</span>	<span class="mh">0x1c92fe62</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_1 */</span>	<span class="mh">0x1c9afe62</span><span class="p">,</span>
	<span class="cm">/* XFER_UDMA_0 */</span>	<span class="mh">0x1c82fe62</span><span class="p">,</span>

	<span class="cm">/* XFER_MW_DMA_2 */</span>	<span class="mh">0x2c82fe62</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_1 */</span>	<span class="mh">0x2c82fe66</span><span class="p">,</span>
	<span class="cm">/* XFER_MW_DMA_0 */</span>	<span class="mh">0x2c82ff2e</span><span class="p">,</span>

	<span class="cm">/* XFER_PIO_4 */</span>	<span class="mh">0x0c82fe62</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_3 */</span>	<span class="mh">0x0c82fe84</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_2 */</span>	<span class="mh">0x0c82fea6</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_1 */</span>	<span class="mh">0x0d02ff26</span><span class="p">,</span>
	<span class="cm">/* XFER_PIO_0 */</span>	<span class="mh">0x0d42ff7f</span>
<span class="p">};</span>

<span class="cp">#define HPT371_ALLOW_ATA133_6		1</span>
<span class="cp">#define HPT302_ALLOW_ATA133_6		1</span>
<span class="cp">#define HPT372_ALLOW_ATA133_6		1</span>
<span class="cp">#define HPT370_ALLOW_ATA100_5		0</span>
<span class="cp">#define HPT366_ALLOW_ATA66_4		1</span>
<span class="cp">#define HPT366_ALLOW_ATA66_3		1</span>

<span class="cm">/* Supported ATA clock frequencies */</span>
<span class="k">enum</span> <span class="n">ata_clock</span> <span class="p">{</span>
	<span class="n">ATA_CLOCK_25MHZ</span><span class="p">,</span>
	<span class="n">ATA_CLOCK_33MHZ</span><span class="p">,</span>
	<span class="n">ATA_CLOCK_40MHZ</span><span class="p">,</span>
	<span class="n">ATA_CLOCK_50MHZ</span><span class="p">,</span>
	<span class="n">ATA_CLOCK_66MHZ</span><span class="p">,</span>
	<span class="n">NUM_ATA_CLOCKS</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hpt_timings</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pio_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ultra_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">clock_table</span><span class="p">[</span><span class="n">NUM_ATA_CLOCKS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Hold all the HighPoint chip information in one place.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">hpt_info</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">chip_name</span><span class="p">;</span>	<span class="cm">/* Chip name */</span>
	<span class="n">u8</span> <span class="n">chip_type</span><span class="p">;</span>		<span class="cm">/* Chip type */</span>
	<span class="n">u8</span> <span class="n">udma_mask</span><span class="p">;</span>		<span class="cm">/* Allowed UltraDMA modes mask. */</span>
	<span class="n">u8</span> <span class="n">dpll_clk</span><span class="p">;</span>		<span class="cm">/* DPLL clock in MHz */</span>
	<span class="n">u8</span> <span class="n">pci_clk</span><span class="p">;</span>		<span class="cm">/* PCI  clock in MHz */</span>
	<span class="k">struct</span> <span class="n">hpt_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">;</span> <span class="cm">/* Chipset timing data */</span>
	<span class="n">u8</span> <span class="n">clock</span><span class="p">;</span>		<span class="cm">/* ATA clock selected */</span>
<span class="p">};</span>

<span class="cm">/* Supported HighPoint chips */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HPT36x</span><span class="p">,</span>
	<span class="n">HPT370</span><span class="p">,</span>
	<span class="n">HPT370A</span><span class="p">,</span>
	<span class="n">HPT374</span><span class="p">,</span>
	<span class="n">HPT372</span><span class="p">,</span>
	<span class="n">HPT372A</span><span class="p">,</span>
	<span class="n">HPT302</span><span class="p">,</span>
	<span class="n">HPT371</span><span class="p">,</span>
	<span class="n">HPT372N</span><span class="p">,</span>
	<span class="n">HPT302N</span><span class="p">,</span>
	<span class="n">HPT371N</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hpt_timings</span> <span class="n">hpt36x_timings</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="mh">0xc1f8ffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask</span>	<span class="o">=</span> <span class="mh">0x303800ff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ultra_mask</span>	<span class="o">=</span> <span class="mh">0x30070000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_table</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_25MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">twenty_five_base_hpt36x</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_33MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">thirty_three_base_hpt36x</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_40MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">forty_base_hpt36x</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_50MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_66MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hpt_timings</span> <span class="n">hpt37x_timings</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="mh">0xcfc3ffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask</span>	<span class="o">=</span> <span class="mh">0x31c001ff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ultra_mask</span>	<span class="o">=</span> <span class="mh">0x303c0000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_table</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_25MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_33MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">thirty_three_base_hpt37x</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_40MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_50MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifty_base_hpt37x</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ATA_CLOCK_66MHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">sixty_six_base_hpt37x</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt36x</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT36x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT36x</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT366_ALLOW_ATA66_3</span> <span class="o">?</span> <span class="p">(</span><span class="n">HPT366_ALLOW_ATA66_4</span> <span class="o">?</span> <span class="n">ATA_UDMA4</span> <span class="o">:</span> <span class="n">ATA_UDMA3</span><span class="p">)</span> <span class="o">:</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* no DPLL */</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt36x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt370</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT370&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT370</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT370_ALLOW_ATA100_5</span> <span class="o">?</span> <span class="n">ATA_UDMA5</span> <span class="o">:</span> <span class="n">ATA_UDMA4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt370a</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT370A&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT370A</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT370_ALLOW_ATA100_5</span> <span class="o">?</span> <span class="n">ATA_UDMA5</span> <span class="o">:</span> <span class="n">ATA_UDMA4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt374</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT374&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT374</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt372</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT372&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT372</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT372_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt372a</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT372A&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT372A</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT372_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">66</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt302</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT302&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT302</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT302_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">66</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt371</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT371&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT371</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT371_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">66</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt372n</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT372N&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT372N</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT372_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">77</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt302n</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT302N&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT302N</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT302_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">77</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="n">hpt371n</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip_name</span>	<span class="o">=</span> <span class="s">&quot;HPT371N&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_type</span>	<span class="o">=</span> <span class="n">HPT371N</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">HPT371_ALLOW_ATA133_6</span> <span class="o">?</span> <span class="n">ATA_UDMA6</span> <span class="o">:</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">77</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timings</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_timings</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_in_drive_list</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="o">++</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="nf">hpt3xx_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span>	<span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">info</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Marvell bridge chips used on the HighPoint SATA cards do not seem</span>
<span class="cm"> * to support the UltraDMA modes 1, 2, and 3 as well as any MWDMA modes...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">hpt3xx_udma_filter</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> 		<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">ultra_mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPT36x</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HPT366_ALLOW_ATA66_4</span> <span class="o">||</span>
		    <span class="n">check_in_drive_list</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">bad_ata66_4</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">ATA_UDMA3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HPT366_ALLOW_ATA66_3</span> <span class="o">||</span>
		    <span class="n">check_in_drive_list</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">bad_ata66_3</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPT370</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HPT370_ALLOW_ATA100_5</span> <span class="o">||</span>
		    <span class="n">check_in_drive_list</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">bad_ata100_5</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">ATA_UDMA4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPT370A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HPT370_ALLOW_ATA100_5</span> <span class="o">||</span>
		    <span class="n">check_in_drive_list</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">bad_ata100_5</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ATA_UDMA4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPT372</span> :
	<span class="k">case</span> <span class="n">HPT372A</span>:
	<span class="k">case</span> <span class="n">HPT372N</span>:
	<span class="k">case</span> <span class="n">HPT374</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_is_sata</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0e</span><span class="p">;</span>
		<span class="cm">/* Fall thru */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">check_in_drive_list</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">bad_ata33</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">hpt3xx_mdma_filter</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPT372</span> :
	<span class="k">case</span> <span class="n">HPT372A</span>:
	<span class="k">case</span> <span class="n">HPT372N</span>:
	<span class="k">case</span> <span class="n">HPT374</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_is_sata</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="cm">/* Fall thru */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_speed_setting</span><span class="p">(</span><span class="n">u8</span> <span class="n">speed</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lookup the transfer mode table to get the index into</span>
<span class="cm">	 * the timing table.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: For XFER_PIO_SLOW, PIO mode 0 timings will be used.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xfer_speeds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfer_speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">speed</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">clock_table</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt3xx_set_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_timings</span> <span class="o">*</span><span class="n">t</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">itr_addr</span>		<span class="o">=</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">old_itr</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">speed</span>		<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_itr</span>		<span class="o">=</span> <span class="n">get_speed_setting</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">itr_mask</span>		<span class="o">=</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="n">XFER_MW_DMA_0</span> <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">:</span>
				 <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">XFER_UDMA_0</span>   <span class="o">?</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">:</span>
							  <span class="n">t</span><span class="o">-&gt;</span><span class="n">ultra_mask</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">itr_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_itr</span><span class="p">);</span>
	<span class="n">new_itr</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_itr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">itr_mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">new_itr</span> <span class="o">&amp;</span> <span class="n">itr_mask</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable on-chip PIO FIFO/buffer (and PIO MST mode as well)</span>
<span class="cm">	 * to avoid problems handling I/O errors later</span>
<span class="cm">	 */</span>
	<span class="n">new_itr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc0000000</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">itr_addr</span><span class="p">,</span> <span class="n">new_itr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt3xx_set_pio_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">;</span>
	<span class="n">hpt3xx_set_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt3xx_maskproc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_NIEN_QUIRK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT370</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">scr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">scr1</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
				<span class="n">scr1</span> <span class="o">|=</span>  <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">scr1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is specific to the HPT366 UDMA chipset</span>
<span class="cm"> * by HighPoint|Triones Technologies, Inc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt366_dma_lost_irq</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mcr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mcr3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr1</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr3</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: (%s)  mcr1=0x%02x, mcr3=0x%02x, scr1=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mcr1</span><span class="p">,</span> <span class="n">mcr3</span><span class="p">,</span> <span class="n">scr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scr1</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">scr1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">);</span>
	<span class="n">ide_dma_lost_irq</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt370_clear_engine</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">select_data</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt370_irq_timeout</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">bfifo</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">dma_cmd</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">select_data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfifo</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %d bytes in FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bfifo</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">);</span>

	<span class="cm">/* get DMA command mode */</span>
	<span class="n">dma_cmd</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_CMD</span><span class="p">);</span>
	<span class="cm">/* stop DMA */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">dma_cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ATA_DMA_START</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_CMD</span><span class="p">);</span>
	<span class="n">hpt370_clear_engine</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt370_dma_start</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef HPT_RESET_STATE_ENGINE</span>
	<span class="n">hpt370_clear_engine</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ide_dma_start</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpt370_dma_end</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">dma_stat</span>		<span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_stat</span> <span class="o">&amp;</span> <span class="n">ATA_DMA_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait a little */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">dma_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_stat</span> <span class="o">&amp;</span> <span class="n">ATA_DMA_ACTIVE</span><span class="p">)</span>
			<span class="n">hpt370_irq_timeout</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ide_dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* returns 1 if DMA IRQ issued, 0 otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpt374_dma_test_irq</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">bfifo</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">dma_stat</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">select_data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfifo</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>printk("%s: %d bytes in FIFO\n", drive-&gt;name, bfifo);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_STATUS</span><span class="p">);</span>
	<span class="cm">/* return 1 if INTR asserted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_stat</span> <span class="o">&amp;</span> <span class="n">ATA_DMA_INTR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpt374_dma_end</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mcr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mcr_addr</span>	<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">select_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bwsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span>	<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bwsr</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bwsr</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span><span class="p">,</span> <span class="n">mcr</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ide_dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hpt3xxn_set_clock	-	perform clock switching dance</span>
<span class="cm"> *	@hwif: hwif to switch</span>
<span class="cm"> *	@mode: clocking mode (0x21 for write, 0x23 otherwise)</span>
<span class="cm"> *</span>
<span class="cm"> *	Switch the DPLL clock on the HPT3xxN devices. This is a	right mess.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt3xxn_set_clock</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">extra_base</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scr2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x6b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scr2</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Tristate the bus */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x63</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x67</span><span class="p">);</span>

	<span class="cm">/* Switch clock and reset channels */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x6b</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x69</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the state machines.</span>
<span class="cm">	 * NOTE: avoid accidentally enabling the disabled channels.</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">);</span>

	<span class="cm">/* Complete reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x69</span><span class="p">);</span>

	<span class="cm">/* Reconnect channels to bus */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x63</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x67</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hpt3xxn_rw_disk		-	prepare for I/O</span>
<span class="cm"> *	@drive: drive for command</span>
<span class="cm"> *	@rq: block request structure</span>
<span class="cm"> *</span>
<span class="cm"> *	This is called when a disk I/O is issued to HPT3xxN.</span>
<span class="cm"> *	We need it because of the clock switching.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt3xxn_rw_disk</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpt3xxn_set_clock</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x21</span> <span class="o">:</span> <span class="mh">0x23</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hpt37x_calibrate_dpll	-	calibrate the DPLL</span>
<span class="cm"> *	@dev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform a calibration cycle on the DPLL.</span>
<span class="cm"> *	Returns 1 if this succeeds</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpt37x_calibrate_dpll</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">f_low</span><span class="p">,</span> <span class="n">u16</span> <span class="n">f_high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dpll</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">f_low</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">scr2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>

	<span class="cm">/* Wait for oscillator ready */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x5000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scr2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* See if it stays ready (we&#39;ll just bail out if it&#39;s not yet) */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr2</span><span class="p">);</span>
		<span class="cm">/* DPLL destabilized? */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scr2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Turn off tuning, we have the DPLL set */</span>
	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x100</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpt3xx_disable_fast_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mcr_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span>	<span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_priv</span> <span class="o">+</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">u8</span>  <span class="n">chip_type</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">new_mcr</span><span class="p">,</span> <span class="n">old_mcr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the &quot;fast interrupt&quot; prediction.  Don&#39;t hold off</span>
<span class="cm">	 * on interrupts. (== 0x01 despite what the docs say)</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_mcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT374</span><span class="p">)</span>
		<span class="n">new_mcr</span> <span class="o">=</span> <span class="n">old_mcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT370</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_mcr</span> <span class="o">=</span> <span class="n">old_mcr</span><span class="p">;</span>
		<span class="n">new_mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
<span class="cp">#ifdef HPT_DELAY_INTERRUPT</span>
		<span class="n">new_mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">new_mcr</span> <span class="o">|=</span>  <span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>					<span class="cm">/* HPT366 and HPT368  */</span>
		<span class="n">new_mcr</span> <span class="o">=</span> <span class="n">old_mcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mcr</span> <span class="o">!=</span> <span class="n">old_mcr</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_mcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_chipset_hpt366</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_base</span>	<span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_clk</span><span class="p">,</span>  <span class="n">dpll_clk</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* PCI and DPLL clock in MHz */</span>
	<span class="n">u8</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ata_clock</span>	<span class="n">clock</span><span class="p">;</span>

	<span class="n">chip_type</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">;</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">L1_CACHE_BYTES</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MIN_GNT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MAX_LAT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, try to estimate the PCI clock frequency...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT370</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span>  <span class="n">scr1</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">f_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">temp</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Interrupt force enable. */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scr1</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">scr1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * HighPoint does this for HPT372A.</span>
<span class="cm">		 * NOTE: This register is only writeable via I/O space.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">HPT372A</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x0e</span><span class="p">,</span> <span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x9c</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Default to PCI clock. Make sure MA15/16 are set to output</span>
<span class="cm">		 * to prevent drives having problems with 40-pin cables.</span>
<span class="cm">		 */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We&#39;ll have to read f_CNT value in order to determine</span>
<span class="cm">		 * the PCI clock frequency according to the following ratio:</span>
<span class="cm">		 *</span>
<span class="cm">		 * f_CNT = Fpci * 192 / Fdpll</span>
<span class="cm">		 *</span>
<span class="cm">		 * First try reading the register in which the HighPoint BIOS</span>
<span class="cm">		 * saves f_CNT value before  reprogramming the DPLL from its</span>
<span class="cm">		 * default setting (which differs for the various chips).</span>
<span class="cm">		 *</span>
<span class="cm">		 * NOTE: This register is only accessible via I/O space;</span>
<span class="cm">		 * HPT374 BIOS only saves it for the function 0, so we have to</span>
<span class="cm">		 * always read it from there -- no need to check the result of</span>
<span class="cm">		 * pci_get_slot() for the function 0 as the whole device has</span>
<span class="cm">		 * been already &quot;pinned&quot; (via function 1) in init_setup_hpt374()</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">HPT374</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">dev1</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
							     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">temp</span> <span class="o">=</span>	<span class="n">inl</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp</span> <span class="o">=</span>	<span class="n">inl</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * In case the signature check fails, we&#39;ll have to</span>
<span class="cm">		 * resort to reading the f_CNT register itself in hopes</span>
<span class="cm">		 * that nobody has touched the DPLL yet...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xABCDE000</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s %s: no clock data saved by &quot;</span>
				<span class="s">&quot;BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

			<span class="cm">/* Calculate the average value of f_CNT. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f_cnt</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">+=</span> <span class="n">f_cnt</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">f_cnt</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">f_cnt</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>

		<span class="n">dpll_clk</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dpll_clk</span><span class="p">;</span>
		<span class="n">pci_clk</span>  <span class="o">=</span> <span class="p">(</span><span class="n">f_cnt</span> <span class="o">*</span> <span class="n">dpll_clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">192</span><span class="p">;</span>

		<span class="cm">/* Clamp PCI clock to bands. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_clk</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
			<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pci_clk</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)</span>
			<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pci_clk</span> <span class="o">&lt;</span> <span class="mi">55</span><span class="p">)</span>
			<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s: DPLL base: %d MHz, f_CNT: %d, &quot;</span>
			<span class="s">&quot;assuming %d MHz PCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">dpll_clk</span><span class="p">,</span> <span class="n">f_cnt</span><span class="p">,</span> <span class="n">pci_clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">itr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itr1</span><span class="p">);</span>

		<span class="cm">/* Detect PCI clock by looking at cmd_high_time. */</span>
		<span class="k">switch</span><span class="p">((</span><span class="n">itr1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x09</span>:
				<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x05</span>:
				<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="nl">default:</span>
				<span class="n">pci_clk</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Let&#39;s assume we&#39;ll use PCI clock for the ATA clock... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pci_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">25</span>:
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_25MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">33</span>:
		<span class="nl">default:</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_33MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">40</span>:
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_40MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">50</span>:
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_50MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">66</span>:
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_66MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only try the DPLL if we don&#39;t have a table for the PCI clock that</span>
<span class="cm">	 * we are running at for HPT370/A, always use it  for anything newer...</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: Using the internal DPLL results in slow reads on 33 MHz PCI.</span>
<span class="cm">	 * We also  don&#39;t like using  the DPLL because this causes glitches</span>
<span class="cm">	 * on PRST-/SRST- when the state engine gets reset...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT374</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">clock_table</span><span class="p">[</span><span class="n">clock</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">f_low</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">pci_clk</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">adjust</span><span class="p">;</span>

		 <span class="cm">/*</span>
<span class="cm">		  * Select 66 MHz DPLL clock only if UltraATA/133 mode is</span>
<span class="cm">		  * supported/enabled, use 50 MHz DPLL clock otherwise...</span>
<span class="cm">		  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">==</span> <span class="n">ATA_UDMA6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpll_clk</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_66MHZ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dpll_clk</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* HPT36x chips don&#39;t have DPLL */</span>
			<span class="n">dpll_clk</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">ATA_CLOCK_50MHZ</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">clock_table</span><span class="p">[</span><span class="n">clock</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s %s: unknown bus timing!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Select the DPLL clock. */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Adjust the DPLL based upon PCI clock, enable it,</span>
<span class="cm">		 * and wait for stabilization...</span>
<span class="cm">		 */</span>
		<span class="n">f_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_clk</span> <span class="o">*</span> <span class="mi">48</span><span class="p">)</span> <span class="o">/</span> <span class="n">dpll_clk</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">adjust</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">adjust</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">hpt37x_calibrate_dpll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">f_low</span><span class="p">,</span> <span class="n">f_low</span> <span class="o">+</span> <span class="n">delta</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * See if it&#39;ll settle at a fractionally different clock</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">f_low</span> <span class="o">-=</span> <span class="n">adjust</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">f_low</span> <span class="o">+=</span> <span class="n">adjust</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s %s: DPLL did not stabilize!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s: using %d MHz DPLL clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dpll_clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Mark the fact that we&#39;re not using the DPLL. */</span>
		<span class="n">dpll_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %s: using %d MHz PCI clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">pci_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Store the clock frequencies. */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dpll_clk</span>	<span class="o">=</span> <span class="n">dpll_clk</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pci_clk</span>	<span class="o">=</span> <span class="n">pci_clk</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">clock</span>	<span class="o">=</span> <span class="n">clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT370</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span>  <span class="n">mcr1</span><span class="p">,</span> <span class="n">mcr4</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reset the state engines.</span>
<span class="cm">		 * NOTE: Avoid accidentally enabling the disabled channels.</span>
<span class="cm">		 */</span>
		<span class="n">pci_read_config_byte</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr1</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr4</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="p">(</span><span class="n">mcr1</span> <span class="o">|</span> <span class="mh">0x32</span><span class="p">));</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="p">(</span><span class="n">mcr4</span> <span class="o">|</span> <span class="mh">0x32</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * On  HPT371N, if ATA clock is 66 MHz we must set bit 2 in</span>
<span class="cm">	 * the MISC. register to stretch the UltraDMA Tss timing.</span>
<span class="cm">	 * NOTE: This register is only writeable via I/O space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">HPT371N</span> <span class="o">&amp;&amp;</span> <span class="n">clock</span> <span class="o">==</span> <span class="n">ATA_CLOCK_66MHZ</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x9c</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x9c</span><span class="p">);</span>

	<span class="n">hpt3xx_disable_fast_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">hpt3xx_disable_fast_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">hpt3xx_cable_detect</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">chip_type</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ata66</span>	<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The HPT37x uses the CBLID pins as outputs for MA15/MA16</span>
<span class="cm">	 * address lines to access an external EEPROM.  To read valid</span>
<span class="cm">	 * cable detect state the pins must be enabled as inputs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">HPT374</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * HPT374 PCI function 1</span>
<span class="cm">		 * - set bit 15 of reg 0x52 to enable TCBLID as input</span>
<span class="cm">		 * - set bit 15 of reg 0x56 to enable FCBLID as input</span>
<span class="cm">		 */</span>
		<span class="n">u8</span>  <span class="n">mcr_addr</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">select_data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">mcr</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span><span class="p">,</span> <span class="n">mcr</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="cm">/* Debounce, then read cable ID register */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr1</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mcr_addr</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT370</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * HPT370/372 and 374 pcifn 0</span>
<span class="cm">		 * - clear bit 0 of reg 0x5b to enable P/SCBLID as inputs</span>
<span class="cm">		 */</span>
		<span class="n">u8</span> <span class="n">scr2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr2</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="n">scr2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Debounce, then read cable ID register */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr1</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="n">scr2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">scr1</span> <span class="o">&amp;</span> <span class="n">ata66</span><span class="p">)</span> <span class="o">?</span> <span class="n">ATA_CBL_PATA40</span> <span class="o">:</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">init_hwif_hpt366</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span>	<span class="o">=</span> <span class="n">hpt3xx_get_info</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>  <span class="n">chip_type</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">;</span>

	<span class="cm">/* Cache the channel&#39;s MISC. control registers&#39; offset */</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">select_data</span>	<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x54</span> <span class="o">:</span> <span class="mh">0x50</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HPT3xxN chips have some complications:</span>
<span class="cm">	 *</span>
<span class="cm">	 * - on 33 MHz PCI we must clock switch</span>
<span class="cm">	 * - on 66 MHz PCI we must NOT use the PCI clock</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">&gt;=</span> <span class="n">HPT372N</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dpll_clk</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pci_clk</span> <span class="o">&lt;</span> <span class="mi">66</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clock is shared between the channels,</span>
<span class="cm">		 * so we&#39;ll have to serialize them... :-(</span>
<span class="cm">		 */</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">|=</span> <span class="n">IDE_HFLAG_SERIALIZE</span><span class="p">;</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rw_disk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt3xxn_rw_disk</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_dma_hpt366</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">ide_pci_dma_base</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">dma_old</span><span class="p">,</span> <span class="n">dma_new</span><span class="p">,</span> <span class="n">masterdma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slavedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_pci_check_simplex</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dma_new</span> <span class="o">=</span> <span class="n">dma_old</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x4b</span> <span class="o">:</span> <span class="mh">0x43</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">masterdma</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x4f</span> <span class="o">:</span> <span class="mh">0x47</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">slavedma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">masterdma</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span>	<span class="n">dma_new</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">slavedma</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span>	<span class="n">dma_new</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_new</span> <span class="o">!=</span> <span class="n">dma_old</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">dma_new</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    %s: BM-DMA at 0x%04lx-0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">extra_base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_allocate_dma_engine</span><span class="p">(</span><span class="n">hwif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">hpt374_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: we need a core pci_set_interrupt() */</span>
		<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: PCI config space interrupt &quot;</span>
			<span class="s">&quot;fixed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev2</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">hpt371_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mcr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HPT371 chips physically have only one channel, the secondary one,</span>
<span class="cm">	 * but the primary channel registers do exist!  Go figure...</span>
<span class="cm">	 * So,  we manually disable the non-existing channel here</span>
<span class="cm">	 * (if the BIOS hasn&#39;t done this already).</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcr1</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">mcr1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hpt36x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mcr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pin1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pin2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we&#39;ll have to force both channels enabled if</span>
<span class="cm">	 * at least one of them has been enabled by BIOS...</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcr1</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">mcr1</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin1</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pin1</span> <span class="o">!=</span> <span class="n">pin2</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s: onboard version of chipset, &quot;</span>
			<span class="s">&quot;pin1=%d pin2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">pin1</span><span class="p">,</span> <span class="n">pin2</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IDE_HFLAGS_HPT3XX \</span>
<span class="cp">	(IDE_HFLAG_NO_ATAPI_DMA | \</span>
<span class="cp">	 IDE_HFLAG_OFF_BOARD)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">hpt3xx_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">hpt3xx_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">hpt3xx_set_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maskproc</span>		<span class="o">=</span> <span class="n">hpt3xx_maskproc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mdma_filter</span>		<span class="o">=</span> <span class="n">hpt3xx_mdma_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_filter</span>		<span class="o">=</span> <span class="n">hpt3xx_udma_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">hpt3xx_cable_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="n">hpt37x_dma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_host_set</span>		<span class="o">=</span> <span class="n">ide_dma_host_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_setup</span>		<span class="o">=</span> <span class="n">ide_dma_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_start</span>		<span class="o">=</span> <span class="n">ide_dma_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_end</span>		<span class="o">=</span> <span class="n">hpt374_dma_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_test_irq</span>		<span class="o">=</span> <span class="n">hpt374_dma_test_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_lost_irq</span>		<span class="o">=</span> <span class="n">ide_dma_lost_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_timer_expiry</span>	<span class="o">=</span> <span class="n">ide_dma_sff_timer_expiry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_sff_read_status</span>	<span class="o">=</span> <span class="n">ide_dma_sff_read_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="n">hpt370_dma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_host_set</span>		<span class="o">=</span> <span class="n">ide_dma_host_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_setup</span>		<span class="o">=</span> <span class="n">ide_dma_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_start</span>		<span class="o">=</span> <span class="n">hpt370_dma_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_end</span>		<span class="o">=</span> <span class="n">hpt370_dma_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_test_irq</span>		<span class="o">=</span> <span class="n">ide_dma_test_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_lost_irq</span>		<span class="o">=</span> <span class="n">ide_dma_lost_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_timer_expiry</span>	<span class="o">=</span> <span class="n">ide_dma_sff_timer_expiry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_clear</span>		<span class="o">=</span> <span class="n">hpt370_irq_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_sff_read_status</span>	<span class="o">=</span> <span class="n">ide_dma_sff_read_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_dma_ops</span> <span class="n">hpt36x_dma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_host_set</span>		<span class="o">=</span> <span class="n">ide_dma_host_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_setup</span>		<span class="o">=</span> <span class="n">ide_dma_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_start</span>		<span class="o">=</span> <span class="n">ide_dma_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_end</span>		<span class="o">=</span> <span class="n">ide_dma_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_test_irq</span>		<span class="o">=</span> <span class="n">ide_dma_test_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_lost_irq</span>		<span class="o">=</span> <span class="n">hpt366_dma_lost_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_timer_expiry</span>	<span class="o">=</span> <span class="n">ide_dma_sff_timer_expiry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_sff_read_status</span>	<span class="o">=</span> <span class="n">ide_dma_sff_read_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">hpt366_chipsets</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* 0: HPT36x */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_chipset</span>	<span class="o">=</span> <span class="n">init_chipset_hpt366</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_hwif</span>	<span class="o">=</span> <span class="n">init_hwif_hpt366</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_dma</span>	<span class="o">=</span> <span class="n">init_dma_hpt366</span><span class="p">,</span>
		<span class="cm">/*</span>
<span class="cm">		 * HPT36x chips have one channel per function and have</span>
<span class="cm">		 * both channel enable bits located differently and visible</span>
<span class="cm">		 * to both functions -- really stupid design decision... :-(</span>
<span class="cm">		 * Bit 4 is for the primary channel, bit 5 for the secondary.</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">enablebits</span>	<span class="o">=</span> <span class="p">{{</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x10</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x04</span><span class="p">}},</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt3xx_port_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dma_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt36x_dma_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_flags</span>	<span class="o">=</span> <span class="n">IDE_HFLAGS_HPT3XX</span> <span class="o">|</span> <span class="n">IDE_HFLAG_SINGLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* 1: HPT3xx */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_chipset</span>	<span class="o">=</span> <span class="n">init_chipset_hpt366</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_hwif</span>	<span class="o">=</span> <span class="n">init_hwif_hpt366</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init_dma</span>	<span class="o">=</span> <span class="n">init_dma_hpt366</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enablebits</span>	<span class="o">=</span> <span class="p">{{</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x04</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x04</span><span class="p">}},</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt3xx_port_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dma_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt37x_dma_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_flags</span>	<span class="o">=</span> <span class="n">IDE_HFLAGS_HPT3XX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	hpt366_init_one	-	called when an HPT366 is found</span>
<span class="cm"> *	@dev: the hpt366 device</span>
<span class="cm"> *	@id: the matching pci id</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when the PCI registration layer (or the IDE initialization)</span>
<span class="cm"> *	finds a device matching our IDE device tables.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hpt366_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpt_info</span> <span class="o">*</span><span class="n">dyn_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt36x</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt370</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt370a</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt372</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt372n</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">hpt372n</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">hpt372a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">hpt302n</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">hpt302</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">hpt371_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">hpt371n</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">hpt371</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt374</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt372n</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s chipset detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">hpt366_chipsets</span><span class="p">[</span><span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span>

	<span class="n">d</span><span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">udma_mask</span><span class="p">;</span>

	<span class="cm">/* fixup -&gt;dma_ops for HPT370/HPT370A */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hpt370</span> <span class="o">||</span> <span class="n">info</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hpt370a</span><span class="p">)</span>
		<span class="n">d</span><span class="p">.</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpt370_dma_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hpt36x</span> <span class="o">||</span> <span class="n">info</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hpt374</span><span class="p">)</span>
		<span class="n">dev2</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dyn_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dyn_info</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dev2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dyn_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s %s: out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy everything from a static &quot;template&quot; structure</span>
<span class="cm">	 * to just allocated per-chip hpt_info structure.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dyn_info</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dyn_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dyn_info</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dyn_info</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hpt374</span><span class="p">)</span>
			<span class="n">hpt374_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev2</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpt36x_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev2</span><span class="p">))</span>
				<span class="n">d</span><span class="p">.</span><span class="n">host_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_HFLAG_NON_BOOTABLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ide_pci_init_two</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">dyn_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dyn_info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ide_pci_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">dyn_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dyn_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">hpt366_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev2</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ide_pci_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hpt366_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TTI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TTI_HPT366</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TTI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TTI_HPT372</span><span class="p">),</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TTI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TTI_HPT302</span><span class="p">),</span>  <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TTI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TTI_HPT371</span><span class="p">),</span>  <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TTI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TTI_HPT374</span><span class="p">),</span>  <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TTI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TTI_HPT372N</span><span class="p">),</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hpt366_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hpt366_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;HPT366_IDE&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">hpt366_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">hpt366_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hpt366_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ide_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ide_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hpt366_ide_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ide_pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpt366_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hpt366_ide_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpt366_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hpt366_ide_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hpt366_ide_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andre Hedrick&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PCI driver module for Highpoint HPT366 IDE&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
