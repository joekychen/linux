<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-cd_verbose.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-cd_verbose.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Verbose error logging for ATAPI CD/DVD devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1994-1996  Scott Snyder &lt;snyder@fnald0.fnal.gov&gt;</span>
<span class="cm"> * Copyright (C) 1996-1998  Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm"> * Copyright (C) 1998-2000  Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>

<span class="cp">#ifndef CONFIG_BLK_DEV_IDECD_VERBOSE_ERRORS</span>
<span class="kt">void</span> <span class="nf">ide_cd_log_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">failed_command</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Suppress printing unit attention and `in progress of becoming ready&#39;</span>
<span class="cm">	   errors when we&#39;re not being verbose. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">UNIT_ATTENTION</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NOT_READY</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span>
						<span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x3a</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error code: 0x%02x  sense_key: 0x%02x  &quot;</span>
			<span class="s">&quot;asc: 0x%02x  ascq: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cm">/* The generic packet command opcodes for CD/DVD Logical Units,</span>
<span class="cm"> * From Table 57 of the SFF8090 Ver. 3 (Mt. Fuji) draft standard. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">packet_command</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">text</span><span class="p">;</span>
<span class="p">}</span> <span class="n">packet_command_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">GPCMD_TEST_UNIT_READY</span><span class="p">,</span> <span class="s">&quot;Test Unit Ready&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_REQUEST_SENSE</span><span class="p">,</span> <span class="s">&quot;Request Sense&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_FORMAT_UNIT</span><span class="p">,</span> <span class="s">&quot;Format Unit&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_INQUIRY</span><span class="p">,</span> <span class="s">&quot;Inquiry&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_START_STOP_UNIT</span><span class="p">,</span> <span class="s">&quot;Start/Stop Unit&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_PREVENT_ALLOW_MEDIUM_REMOVAL</span><span class="p">,</span> <span class="s">&quot;Prevent/Allow Medium Removal&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_FORMAT_CAPACITIES</span><span class="p">,</span> <span class="s">&quot;Read Format Capacities&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_CDVD_CAPACITY</span><span class="p">,</span> <span class="s">&quot;Read Cd/Dvd Capacity&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_10</span><span class="p">,</span> <span class="s">&quot;Read 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_WRITE_10</span><span class="p">,</span> <span class="s">&quot;Write 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SEEK</span><span class="p">,</span> <span class="s">&quot;Seek&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_WRITE_AND_VERIFY_10</span><span class="p">,</span> <span class="s">&quot;Write and Verify 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_VERIFY_10</span><span class="p">,</span> <span class="s">&quot;Verify 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_FLUSH_CACHE</span><span class="p">,</span> <span class="s">&quot;Flush Cache&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_SUBCHANNEL</span><span class="p">,</span> <span class="s">&quot;Read Subchannel&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_TOC_PMA_ATIP</span><span class="p">,</span> <span class="s">&quot;Read Table of Contents&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_HEADER</span><span class="p">,</span> <span class="s">&quot;Read Header&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_PLAY_AUDIO_10</span><span class="p">,</span> <span class="s">&quot;Play Audio 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">,</span> <span class="s">&quot;Get Configuration&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_PLAY_AUDIO_MSF</span><span class="p">,</span> <span class="s">&quot;Play Audio MSF&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_PLAYAUDIO_TI</span><span class="p">,</span> <span class="s">&quot;Play Audio TrackIndex&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_GET_EVENT_STATUS_NOTIFICATION</span><span class="p">,</span>
		<span class="s">&quot;Get Event Status Notification&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_PAUSE_RESUME</span><span class="p">,</span> <span class="s">&quot;Pause/Resume&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_STOP_PLAY_SCAN</span><span class="p">,</span> <span class="s">&quot;Stop Play/Scan&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_DISC_INFO</span><span class="p">,</span> <span class="s">&quot;Read Disc Info&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_TRACK_RZONE_INFO</span><span class="p">,</span> <span class="s">&quot;Read Track Rzone Info&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_RESERVE_RZONE_TRACK</span><span class="p">,</span> <span class="s">&quot;Reserve Rzone Track&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SEND_OPC</span><span class="p">,</span> <span class="s">&quot;Send OPC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_MODE_SELECT_10</span><span class="p">,</span> <span class="s">&quot;Mode Select 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_REPAIR_RZONE_TRACK</span><span class="p">,</span> <span class="s">&quot;Repair Rzone Track&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_MODE_SENSE_10</span><span class="p">,</span> <span class="s">&quot;Mode Sense 10&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_CLOSE_TRACK</span><span class="p">,</span> <span class="s">&quot;Close Track&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_BLANK</span><span class="p">,</span> <span class="s">&quot;Blank&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SEND_EVENT</span><span class="p">,</span> <span class="s">&quot;Send Event&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SEND_KEY</span><span class="p">,</span> <span class="s">&quot;Send Key&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_REPORT_KEY</span><span class="p">,</span> <span class="s">&quot;Report Key&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_LOAD_UNLOAD</span><span class="p">,</span> <span class="s">&quot;Load/Unload&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SET_READ_AHEAD</span><span class="p">,</span> <span class="s">&quot;Set Read-ahead&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_12</span><span class="p">,</span> <span class="s">&quot;Read 12&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_GET_PERFORMANCE</span><span class="p">,</span> <span class="s">&quot;Get Performance&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SEND_DVD_STRUCTURE</span><span class="p">,</span> <span class="s">&quot;Send DVD Structure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">,</span> <span class="s">&quot;Read DVD Structure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SET_STREAMING</span><span class="p">,</span> <span class="s">&quot;Set Streaming&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_CD_MSF</span><span class="p">,</span> <span class="s">&quot;Read CD MSF&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SCAN</span><span class="p">,</span> <span class="s">&quot;Scan&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_SET_SPEED</span><span class="p">,</span> <span class="s">&quot;Set Speed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_PLAY_CD</span><span class="p">,</span> <span class="s">&quot;Play CD&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_MECHANISM_STATUS</span><span class="p">,</span> <span class="s">&quot;Mechanism Status&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPCMD_READ_CD</span><span class="p">,</span> <span class="s">&quot;Read CD&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* From Table 303 of the SFF8090 Ver. 3 (Mt. Fuji) draft standard. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">sense_key_texts</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;No sense data&quot;</span><span class="p">,</span>
	<span class="s">&quot;Recovered error&quot;</span><span class="p">,</span>
	<span class="s">&quot;Not ready&quot;</span><span class="p">,</span>
	<span class="s">&quot;Medium error&quot;</span><span class="p">,</span>
	<span class="s">&quot;Hardware error&quot;</span><span class="p">,</span>
	<span class="s">&quot;Illegal request&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unit attention&quot;</span><span class="p">,</span>
	<span class="s">&quot;Data protect&quot;</span><span class="p">,</span>
	<span class="s">&quot;Blank check&quot;</span><span class="p">,</span>
	<span class="s">&quot;(reserved)&quot;</span><span class="p">,</span>
	<span class="s">&quot;(reserved)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Aborted command&quot;</span><span class="p">,</span>
	<span class="s">&quot;(reserved)&quot;</span><span class="p">,</span>
	<span class="s">&quot;(reserved)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Miscompare&quot;</span><span class="p">,</span>
	<span class="s">&quot;(reserved)&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* From Table 304 of the SFF8090 Ver. 3 (Mt. Fuji) draft standard. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">asc_ascq</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">text</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sense_data_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x000000</span><span class="p">,</span> <span class="s">&quot;No additional sense information&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000011</span><span class="p">,</span> <span class="s">&quot;Play operation in progress&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000012</span><span class="p">,</span> <span class="s">&quot;Play operation paused&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000013</span><span class="p">,</span> <span class="s">&quot;Play operation successfully completed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000014</span><span class="p">,</span> <span class="s">&quot;Play operation stopped due to error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000015</span><span class="p">,</span> <span class="s">&quot;No current audio status to return&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x010c0a</span><span class="p">,</span> <span class="s">&quot;Write error - padding blocks added&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011700</span><span class="p">,</span> <span class="s">&quot;Recovered data with no error correction applied&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011701</span><span class="p">,</span> <span class="s">&quot;Recovered data with retries&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011702</span><span class="p">,</span> <span class="s">&quot;Recovered data with positive head offset&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011703</span><span class="p">,</span> <span class="s">&quot;Recovered data with negative head offset&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011704</span><span class="p">,</span> <span class="s">&quot;Recovered data with retries and/or CIRC applied&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011705</span><span class="p">,</span> <span class="s">&quot;Recovered data using previous sector ID&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011800</span><span class="p">,</span> <span class="s">&quot;Recovered data with error correction applied&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011801</span><span class="p">,</span> <span class="s">&quot;Recovered data with error correction and retries applied&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011802</span><span class="p">,</span> <span class="s">&quot;Recovered data - the data was auto-reallocated&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011803</span><span class="p">,</span> <span class="s">&quot;Recovered data with CIRC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x011804</span><span class="p">,</span> <span class="s">&quot;Recovered data with L-EC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x015d00</span><span class="p">,</span> <span class="s">&quot;Failure prediction threshold exceeded&quot;</span>
		    <span class="s">&quot; - Predicted logical unit failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x015d01</span><span class="p">,</span> <span class="s">&quot;Failure prediction threshold exceeded&quot;</span>
		    <span class="s">&quot; - Predicted media failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x015dff</span><span class="p">,</span> <span class="s">&quot;Failure prediction threshold exceeded - False&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x017301</span><span class="p">,</span> <span class="s">&quot;Power calibration area almost full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020400</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready - cause not reportable&quot;</span> <span class="p">},</span>
	<span class="cm">/* Following is misspelled in ATAPI 2.6, _and_ in Mt. Fuji */</span>
	<span class="p">{</span> <span class="mh">0x020401</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready&quot;</span>
		    <span class="s">&quot; - in progress [sic] of becoming ready&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020402</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready - initializing command required&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020403</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready - manual intervention required&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020404</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready - format in progress&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020407</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready - operation in progress&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020408</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready - long write in progress&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x020600</span><span class="p">,</span> <span class="s">&quot;No reference position found (media may be upside down)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x023000</span><span class="p">,</span> <span class="s">&quot;Incompatible medium installed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x023a00</span><span class="p">,</span> <span class="s">&quot;Medium not present&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x025300</span><span class="p">,</span> <span class="s">&quot;Media load or eject failed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x025700</span><span class="p">,</span> <span class="s">&quot;Unable to recover table of contents&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030300</span><span class="p">,</span> <span class="s">&quot;Peripheral device write fault&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030301</span><span class="p">,</span> <span class="s">&quot;No write current&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030302</span><span class="p">,</span> <span class="s">&quot;Excessive write errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c00</span><span class="p">,</span> <span class="s">&quot;Write error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c01</span><span class="p">,</span> <span class="s">&quot;Write error - Recovered with auto reallocation&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c02</span><span class="p">,</span> <span class="s">&quot;Write error - auto reallocation failed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c03</span><span class="p">,</span> <span class="s">&quot;Write error - recommend reassignment&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c04</span><span class="p">,</span> <span class="s">&quot;Compression check miscompare error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c05</span><span class="p">,</span> <span class="s">&quot;Data expansion occurred during compress&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c06</span><span class="p">,</span> <span class="s">&quot;Block not compressible&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c07</span><span class="p">,</span> <span class="s">&quot;Write error - recovery needed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c08</span><span class="p">,</span> <span class="s">&quot;Write error - recovery failed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x030c09</span><span class="p">,</span> <span class="s">&quot;Write error - loss of streaming&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x031100</span><span class="p">,</span> <span class="s">&quot;Unrecovered read error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x031106</span><span class="p">,</span> <span class="s">&quot;CIRC unrecovered error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x033101</span><span class="p">,</span> <span class="s">&quot;Format command failed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x033200</span><span class="p">,</span> <span class="s">&quot;No defect spare location available&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x033201</span><span class="p">,</span> <span class="s">&quot;Defect list update failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x035100</span><span class="p">,</span> <span class="s">&quot;Erase failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037200</span><span class="p">,</span> <span class="s">&quot;Session fixation error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037201</span><span class="p">,</span> <span class="s">&quot;Session fixation error writin lead-in&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037202</span><span class="p">,</span> <span class="s">&quot;Session fixation error writin lead-out&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037300</span><span class="p">,</span> <span class="s">&quot;CD control error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037302</span><span class="p">,</span> <span class="s">&quot;Power calibration area is full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037303</span><span class="p">,</span> <span class="s">&quot;Power calibration area error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037304</span><span class="p">,</span> <span class="s">&quot;Program memory area / RMA update failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037305</span><span class="p">,</span> <span class="s">&quot;Program memory area / RMA is full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x037306</span><span class="p">,</span> <span class="s">&quot;Program memory area / RMA is (almost) full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x040200</span><span class="p">,</span> <span class="s">&quot;No seek complete&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x040300</span><span class="p">,</span> <span class="s">&quot;Write fault&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x040900</span><span class="p">,</span> <span class="s">&quot;Track following error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x040901</span><span class="p">,</span> <span class="s">&quot;Tracking servo failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x040902</span><span class="p">,</span> <span class="s">&quot;Focus servo failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x040903</span><span class="p">,</span> <span class="s">&quot;Spindle servo failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x041500</span><span class="p">,</span> <span class="s">&quot;Random positioning error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x041501</span><span class="p">,</span> <span class="s">&quot;Mechanical positioning or changer error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x041502</span><span class="p">,</span> <span class="s">&quot;Positioning error detected by read of medium&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x043c00</span><span class="p">,</span> <span class="s">&quot;Mechanical positioning or changer error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x044000</span><span class="p">,</span> <span class="s">&quot;Diagnostic failure on component (ASCQ)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x044400</span><span class="p">,</span> <span class="s">&quot;Internal CD/DVD logical unit failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04b600</span><span class="p">,</span> <span class="s">&quot;Media load mechanism failed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x051a00</span><span class="p">,</span> <span class="s">&quot;Parameter list length error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052000</span><span class="p">,</span> <span class="s">&quot;Invalid command operation code&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052100</span><span class="p">,</span> <span class="s">&quot;Logical block address out of range&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052102</span><span class="p">,</span> <span class="s">&quot;Invalid address for write&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052400</span><span class="p">,</span> <span class="s">&quot;Invalid field in command packet&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052600</span><span class="p">,</span> <span class="s">&quot;Invalid field in parameter list&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052601</span><span class="p">,</span> <span class="s">&quot;Parameter not supported&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052602</span><span class="p">,</span> <span class="s">&quot;Parameter value invalid&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052700</span><span class="p">,</span> <span class="s">&quot;Write protected media&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052c00</span><span class="p">,</span> <span class="s">&quot;Command sequence error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052c03</span><span class="p">,</span> <span class="s">&quot;Current program area is not empty&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x052c04</span><span class="p">,</span> <span class="s">&quot;Current program area is empty&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x053001</span><span class="p">,</span> <span class="s">&quot;Cannot read medium - unknown format&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x053002</span><span class="p">,</span> <span class="s">&quot;Cannot read medium - incompatible format&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x053900</span><span class="p">,</span> <span class="s">&quot;Saving parameters not supported&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x054e00</span><span class="p">,</span> <span class="s">&quot;Overlapped commands attempted&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x055302</span><span class="p">,</span> <span class="s">&quot;Medium removal prevented&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x055500</span><span class="p">,</span> <span class="s">&quot;System resource failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056300</span><span class="p">,</span> <span class="s">&quot;End of user area encountered on this track&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056400</span><span class="p">,</span> <span class="s">&quot;Illegal mode for this track or incompatible medium&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056f00</span><span class="p">,</span> <span class="s">&quot;Copy protection key exchange failure&quot;</span>
		    <span class="s">&quot; - Authentication failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056f01</span><span class="p">,</span> <span class="s">&quot;Copy protection key exchange failure - Key not present&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056f02</span><span class="p">,</span> <span class="s">&quot;Copy protection key exchange failure&quot;</span>
		     <span class="s">&quot; - Key not established&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056f03</span><span class="p">,</span> <span class="s">&quot;Read of scrambled sector without authentication&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056f04</span><span class="p">,</span> <span class="s">&quot;Media region code is mismatched to logical unit&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x056f05</span><span class="p">,</span> <span class="s">&quot;Drive region must be permanent&quot;</span>
		    <span class="s">&quot; / region reset count error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x057203</span><span class="p">,</span> <span class="s">&quot;Session fixation error - incomplete track in session&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x057204</span><span class="p">,</span> <span class="s">&quot;Empty or partially written reserved track&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x057205</span><span class="p">,</span> <span class="s">&quot;No more RZONE reservations are allowed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05bf00</span><span class="p">,</span> <span class="s">&quot;Loss of streaming&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x062800</span><span class="p">,</span> <span class="s">&quot;Not ready to ready transition, medium may have changed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x062900</span><span class="p">,</span> <span class="s">&quot;Power on, reset or hardware reset occurred&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x062a00</span><span class="p">,</span> <span class="s">&quot;Parameters changed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x062a01</span><span class="p">,</span> <span class="s">&quot;Mode parameters changed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x062e00</span><span class="p">,</span> <span class="s">&quot;Insufficient time for operation&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x063f00</span><span class="p">,</span> <span class="s">&quot;Logical unit operating conditions have changed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x063f01</span><span class="p">,</span> <span class="s">&quot;Microcode has been changed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x065a00</span><span class="p">,</span> <span class="s">&quot;Operator request or state change input (unspecified)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x065a01</span><span class="p">,</span> <span class="s">&quot;Operator medium removal request&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0bb900</span><span class="p">,</span> <span class="s">&quot;Play operation aborted&quot;</span> <span class="p">},</span>
	<span class="cm">/* Here we use 0xff for the key (not a valid key) to signify</span>
<span class="cm">	 * that these can have _any_ key value associated with them... */</span>
	<span class="p">{</span> <span class="mh">0xff0401</span><span class="p">,</span> <span class="s">&quot;Logical unit is in process of becoming ready&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0400</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready, cause not reportable&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0402</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready, initializing command required&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0403</span><span class="p">,</span> <span class="s">&quot;Logical unit not ready, manual intervention required&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0500</span><span class="p">,</span> <span class="s">&quot;Logical unit does not respond to selection&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0800</span><span class="p">,</span> <span class="s">&quot;Logical unit communication failure&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0802</span><span class="p">,</span> <span class="s">&quot;Logical unit communication parity error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff0801</span><span class="p">,</span> <span class="s">&quot;Logical unit communication time-out&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff2500</span><span class="p">,</span> <span class="s">&quot;Logical unit not supported&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff4c00</span><span class="p">,</span> <span class="s">&quot;Logical unit failed self-configuration&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff3e00</span><span class="p">,</span> <span class="s">&quot;Logical unit has not self-configured yet&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ide_cd_log_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">failed_command</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;bad sense key!&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ATAPI device %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">==</span> <span class="mh">0x70</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;  Error: &quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">==</span> <span class="mh">0x71</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  Deferred Error: &quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;  Vendor-specific Error: &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;  Unknown Error Type: &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sense_key_texts</span><span class="p">))</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">sense_key_texts</span><span class="p">[</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s -- (Sense key=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Diagnostic failure on component 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sense_data_texts</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">key</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">&gt;=</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">&lt;=</span> <span class="mh">0xdd</span><span class="p">))</span>
			<span class="n">key</span> <span class="o">|=</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sense_data_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">asc_ascq</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
			    <span class="n">sense_data_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">asc_ascq</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0xff0000</span><span class="o">|</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">sense_data_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">text</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense_data_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">asc_ascq</span> <span class="o">&gt;</span> <span class="n">key</span><span class="p">)</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">&gt;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(vendor-specific error)&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(reserved error code)&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  %s -- (asc=0x%02x, ascq=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed_command</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">packet_command_texts</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">packet_command_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">packet_command</span> <span class="o">==</span>
			    <span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">packet_command_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">text</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">packet_command_texts</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">packet_command</span> <span class="o">&gt;</span>
			    <span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  The failed </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> packet command &quot;</span>
				<span class="s">&quot;was: </span><span class="se">\n</span><span class="s">  </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BLK_MAX_CDB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The SKSV bit specifies validity of the sense_key_specific</span>
<span class="cm">	 * in the next two commands. It is bit 7 of the first byte.</span>
<span class="cm">	 * In the case of NOT_READY, if SKSV is set the drive can</span>
<span class="cm">	 * give us nice ETA readings.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NOT_READY</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  Command is %02d%% complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">progress</span> <span class="o">/</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">ILLEGAL_REQUEST</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  Error in %s byte %d&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span>
				<span class="s">&quot;command packet&quot;</span> <span class="o">:</span> <span class="s">&quot;command data&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; bit %d&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
