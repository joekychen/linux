<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-cd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-cd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ATAPI CD-ROM driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1994-1996   Scott Snyder &lt;snyder@fnald0.fnal.gov&gt;</span>
<span class="cm"> * Copyright (C) 1996-1998   Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm"> * Copyright (C) 1998-2000   Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm"> * Copyright (C) 2005, 2007-2009  Bartlomiej Zolnierkiewicz</span>
<span class="cm"> *</span>
<span class="cm"> * May be copied or modified under the terms of the GNU General Public</span>
<span class="cm"> * License.  See linux/COPYING for more information.</span>
<span class="cm"> *</span>
<span class="cm"> * See Documentation/cdrom/ide-cd for usage information.</span>
<span class="cm"> *</span>
<span class="cm"> * Suggestions are welcome. Patches that work are more welcome though. ;-)</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation:</span>
<span class="cm"> *	Mt. Fuji (SFF8090 version 4) and ATAPI (SFF-8020i rev 2.6) standards.</span>
<span class="cm"> *</span>
<span class="cm"> * For historical changelog please see:</span>
<span class="cm"> *	Documentation/ide/ChangeLog.ide-cd.1994-2004</span>
<span class="cm"> */</span>

<span class="cp">#define DRV_NAME &quot;ide-cd&quot;</span>
<span class="cp">#define PFX DRV_NAME &quot;: &quot;</span>

<span class="cp">#define IDECD_VERSION &quot;5.00&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/bcd.h&gt;</span>

<span class="cm">/* For SCSI -&gt; ATAPI command conversion */</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;ide-cd.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ide_cd_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ide_cd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="nf">ide_cd_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>
	<span class="n">cd</span> <span class="o">=</span> <span class="n">ide_drv_g</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cdrom_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ide_device_get</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">))</span>
			<span class="n">cd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_cd_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">cd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ide_device_put</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic packet command support and error handling routines.</span>
<span class="cm"> */</span>

<span class="cm">/* Mark that we&#39;ve seen a media change and invalidate our internal buffers. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_saw_media_change</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_MEDIA_CHANGED</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_AFLAG_TOC_VALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_log_sense</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span> <span class="o">||</span> <span class="o">!</span><span class="n">rq</span> <span class="o">||</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_QUIET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_SENSE</span><span class="p">,</span> <span class="s">&quot;sense_key: 0x%x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NO_SENSE</span>:
	<span class="k">case</span> <span class="n">RECOVERED_ERROR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NOT_READY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * don&#39;t care about tray state messages for e.g. capacity</span>
<span class="cm">		 * commands or in-progress or becoming ready</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x3a</span> <span class="o">||</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
		<span class="cm">/*</span>
<span class="cm">		 * don&#39;t log START_STOP unit with LoEj set, since we cannot</span>
<span class="cm">		 * reliably check if drive can auto-close</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">GPCMD_START_STOP_UNIT</span> <span class="o">&amp;&amp;</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Make good and sure we&#39;ve seen this potential media change.</span>
<span class="cm">		 * Some drives (i.e. Creative) fail to present the correct sense</span>
<span class="cm">		 * key in the error register.</span>
<span class="cm">		 */</span>
		<span class="n">cdrom_saw_media_change</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">log</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_analyze_sense_data</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">failed_command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bio_sectors</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_SENSE</span><span class="p">,</span> <span class="s">&quot;error_code: 0x%x, sense_key: 0x%x&quot;</span><span class="p">,</span>
				     <span class="n">sense</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed_command</span><span class="p">)</span>
		<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_SENSE</span><span class="p">,</span> <span class="s">&quot;failed cmd: 0x%x&quot;</span><span class="p">,</span>
					     <span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdrom_log_sense</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">failed_command</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a read toc is executed for a CD-R or CD-RW medium where the first</span>
<span class="cm">	 * toc has not been recorded yet, it will fail with 05/24/00 (which is a</span>
<span class="cm">	 * confusing error)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failed_command</span> <span class="o">&amp;&amp;</span> <span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">GPCMD_READ_TOC_PMA_ATIP</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="mh">0x05</span> <span class="o">&amp;&amp;</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* current error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">==</span> <span class="mh">0x70</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MEDIUM_ERROR</span>:
		<span class="k">case</span> <span class="n">VOLUME_OVERFLOW</span>:
		<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">failed_command</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">queue_logical_block_size</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2048</span><span class="p">)</span>
				<span class="cm">/* device sector size is 2K */</span>
				<span class="n">sector</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">bio_sectors</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">bio_sectors</span><span class="p">(</span><span class="n">failed_command</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span> <span class="mi">4U</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">bio_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * The SCSI specification allows for the value</span>
<span class="cm">			 * returned by READ CAPACITY to be up to 75 2K</span>
<span class="cm">			 * sectors past the last readable block.</span>
<span class="cm">			 * Therefore, if we hit a medium error within the</span>
<span class="cm">			 * last 75 2K sectors, we decrease the saved size</span>
<span class="cm">			 * value.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&lt;</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">drive</span><span class="o">-&gt;</span><span class="n">probed_capacity</span> <span class="o">-</span> <span class="n">sector</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">75</span><span class="p">)</span>
				<span class="n">set_capacity</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ide_cd_log_error</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">failed_command</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_cd_complete_failed_rq</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * For REQ_TYPE_SENSE, &quot;rq-&gt;special&quot; points to the original</span>
<span class="cm">	 * failed request.  Also, the sense data should be read</span>
<span class="cm">	 * directly from rq which might be different from the original</span>
<span class="cm">	 * sense buffer if it got copied during mapping.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">failed</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="p">)</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Sense is always read into drive-&gt;sense_data.</span>
<span class="cm">			 * Copy back if the failed request has its</span>
<span class="cm">			 * sense pointer set.</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">failed</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
			<span class="n">failed</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cdrom_analyze_sense_data</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">failed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ide_end_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">failed</span><span class="p">)))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cdrom_analyze_sense_data</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Allow the drive 5 seconds to recover; some devices will return NOT_READY</span>
<span class="cm"> * while flushing data from cache.</span>
<span class="cm"> *</span>
<span class="cm"> * returns: 0 failed (write timeout expired)</span>
<span class="cm"> *	    1 success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cd_breathe</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">write_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>	<span class="n">ATAPI_WAIT_WRITE_BUSY</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">write_timeout</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * take a breather</span>
<span class="cm">		 */</span>
		<span class="n">blk_delay_queue</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * 0: if the request should be continued.</span>
<span class="cm"> * 1: if the request will be going through error recovery.</span>
<span class="cm"> * 2: if the request should be ended.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_decode_status</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">sense_key</span><span class="p">,</span> <span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the IDE error register */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ide_read_error</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">sense_key</span> <span class="o">=</span> <span class="n">err</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_RQ</span><span class="p">,</span> <span class="s">&quot;cmd: 0x%x, rq-&gt;cmd_type: 0x%x, err: 0x%x, &quot;</span>
				  <span class="s">&quot;stat 0x%x&quot;</span><span class="p">,</span>
				  <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We got an error trying to get sense info from the drive</span>
<span class="cm">		 * (probably while trying to recover from a former error).</span>
<span class="cm">		 * Just give up.</span>
<span class="cm">		 */</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we have an error, pass CHECK_CONDITION as the SCSI status byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_noretry_request</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span>
		<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NOT_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span> <span class="o">&amp;&amp;</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ide_cd_breathe</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cdrom_saw_media_change</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_QUIET</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: tray open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
		<span class="n">cdrom_saw_media_change</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Arrange to retry the request but be sure to give up if we&#39;ve</span>
<span class="cm">		 * retried too many times.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&gt;</span> <span class="n">ERROR_MAX</span><span class="p">)</span>
			<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t print error message for this condition -- SFF8090i</span>
<span class="cm">		 * indicates that 5/24/00 is the correct response to a request</span>
<span class="cm">		 * to close the tray if the drive doesn&#39;t have that capability.</span>
<span class="cm">		 *</span>
<span class="cm">		 * cdrom_log_sense() knows this!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">GPCMD_START_STOP_UNIT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">DATA_PROTECT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * No point in retrying after an illegal request or data</span>
<span class="cm">		 * protect error.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_QUIET</span><span class="p">))</span>
			<span class="n">ide_dump_status</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;command error&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIUM_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * No point in re-trying a zillion times on a bad sector.</span>
<span class="cm">		 * If we got here the error is not correctable.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_QUIET</span><span class="p">))</span>
			<span class="n">ide_dump_status</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;media error &quot;</span>
					<span class="s">&quot;(bad sector)&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLANK_CHECK</span>:
		<span class="cm">/* disk appears blank? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_QUIET</span><span class="p">))</span>
			<span class="n">ide_dump_status</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;media error (blank)&quot;</span><span class="p">,</span>
					<span class="n">stat</span><span class="p">);</span>
		<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ATA_ABORTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* go to the default handler for other errors */</span>
			<span class="n">ide_error</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;cdrom_decode_status&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&gt;</span> <span class="n">ERROR_MAX</span><span class="p">)</span>
			<span class="cm">/* we&#39;ve racked up too many retries, abort */</span>
			<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILED</span><span class="p">;</span>
		<span class="n">do_end_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * End a request through request sense analysis when we have sense data.</span>
<span class="cm">	 * We need this in order to perform end of media processing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_end_request</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end_request</span><span class="p">;</span>

	<span class="cm">/* if we got a CHECK_CONDITION status, queue a request sense command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ide_queue_sense_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">end_request:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ide_queue_sense_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_cd_request_sense_fixup</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;rq-&gt;cmd[0]: 0x%x&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some of the trailing request sense fields are optional,</span>
<span class="cm">	 * and some drives don&#39;t send them.  Sigh.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">GPCMD_REQUEST_SENSE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_cd_queue_pc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">bufflen</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">local_sense</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">)</span>
		<span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_sense</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PC</span><span class="p">,</span> <span class="s">&quot;cmd[0]: 0x%x, write: 0x%x, timeout: %d, &quot;</span>
				  <span class="s">&quot;cmd_flags: 0x%x&quot;</span><span class="p">,</span>
				  <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">write</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>

	<span class="cm">/* start of retry loop */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_ATA_PC</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">sense</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">cmd_flags</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
						<span class="o">*</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
			<span class="o">*</span><span class="n">bufflen</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">;</span>
		<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIXME: we should probably abort/retry or something in case of</span>
<span class="cm">		 * failure.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The request failed.  Retry if it was due to a unit</span>
<span class="cm">			 * attention status (usually means media was changed).</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">reqbuf</span> <span class="o">=</span> <span class="n">sense</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span>
				<span class="n">cdrom_saw_media_change</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NOT_READY</span> <span class="o">&amp;&amp;</span>
				 <span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">reqbuf</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The drive is in the process of loading</span>
<span class="cm">				 * a disk.  Retry, but wait a little to give</span>
<span class="cm">				 * the drive time to complete the load.</span>
<span class="cm">				 */</span>
				<span class="n">ssleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* otherwise, don&#39;t retry */</span>
				<span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">--</span><span class="n">retries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* end of retry loop */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_FAILED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">retries</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* return an error if the command failed */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_FAILED</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * returns true if rq has been completed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ide_cd_error_cmd</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_bytes</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf_flags</span> <span class="o">&amp;</span> <span class="n">IDE_TFLAG_WRITE</span><span class="p">)</span>
		<span class="n">nr_bytes</span> <span class="o">-=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">last_xfer_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_complete_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ide_startstop_t</span> <span class="nf">cdrom_newpc_intr</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="n">ide_expiry_t</span> <span class="o">*</span><span class="n">expiry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_SENSE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ireason</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PC</span><span class="p">,</span> <span class="s">&quot;cmd: 0x%x, write: 0x%x&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">write</span><span class="p">);</span>

	<span class="cm">/* check for errors */</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_error</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">ide_dma_unmap_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: DMA %s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">write</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
			<span class="n">ide_dma_off</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check status */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OK_STAT</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAD_R_STAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cdrom_decode_status</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_end</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* using dma, transfer is complete now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ide_error</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;dma error&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_read_bcount_and_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireason</span><span class="p">);</span>

	<span class="n">thislen</span> <span class="o">=</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thislen</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">thislen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PC</span><span class="p">,</span> <span class="s">&quot;DRQ: stat: 0x%x, thislen: %d&quot;</span><span class="p">,</span>
				  <span class="n">stat</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>

	<span class="cm">/* If DRQ is clear, the command has completed. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_DRQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we&#39;re not done reading/writing, complain.</span>
<span class="cm">			 * Otherwise, complete the command normally.</span>
<span class="cm">			 */</span>
			<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: %s: data underrun &quot;</span>
					<span class="s">&quot;(%u bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write</span><span class="p">)</span>
					<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILED</span><span class="p">;</span>
				<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ide_cd_request_sense_fixup</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

			<span class="n">uptodate</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * suck out the remaining bytes from the drive in an</span>
<span class="cm">			 * attempt to complete the data xfer. (see BZ#13399)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uptodate</span> <span class="o">&amp;&amp;</span> <span class="n">thislen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ide_pio_bytes</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">thislen</span><span class="p">);</span>
				<span class="n">uptodate</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span>
				<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_check_ireason</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ireason</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_end</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">last_xfer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PC</span><span class="p">,</span> <span class="s">&quot;data transfer, rq-&gt;cmd_type: 0x%x, &quot;</span>
				  <span class="s">&quot;ireason: 0x%x&quot;</span><span class="p">,</span>
				  <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">,</span> <span class="n">ireason</span><span class="p">);</span>

	<span class="cm">/* transfer data */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">thislen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">blen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">thislen</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ide_pio_bytes</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">blen</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">last_xfer_len</span> <span class="o">+=</span> <span class="n">blen</span><span class="p">;</span>

		<span class="n">thislen</span> <span class="o">-=</span> <span class="n">blen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">blen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="n">write</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">+=</span> <span class="n">blen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pad, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span> <span class="o">||</span> <span class="n">write</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ide_pad_transfer</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: confused, missing data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">blk_dump_rq_flags</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="s">&quot;cdrom_newpc_intr&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">ATAPI_WAIT_PC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
			<span class="n">expiry</span> <span class="o">=</span> <span class="n">ide_cd_expiry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">expiry</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>
	<span class="n">ide_set_handler</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cdrom_newpc_intr</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ide_started</span><span class="p">;</span>

<span class="nl">out_end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">blk_end_request_all</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="n">uptodate</span><span class="p">)</span>
			<span class="n">ide_cd_complete_failed_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ide_cd_error_cmd</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>

		<span class="cm">/* make sure it&#39;s fully ended */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">-=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nleft</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tf_flags</span> <span class="o">&amp;</span> <span class="n">IDE_TFLAG_WRITE</span><span class="p">))</span>
				<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">+=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">last_xfer_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ide_complete_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">uptodate</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ide_error</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;request sense failure&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ide_startstop_t</span> <span class="nf">cdrom_start_rw</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sectors_per_frame</span> <span class="o">=</span>
		<span class="n">queue_logical_block_size</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_BITS</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_RQ</span><span class="p">,</span> <span class="s">&quot;rq-&gt;cmd[0]: 0x%x, rq-&gt;cmd_flags: 0x%x, &quot;</span>
				  <span class="s">&quot;secs_per_frame: %u&quot;</span><span class="p">,</span>
				  <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">,</span> <span class="n">sectors_per_frame</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disk has become write protected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_disk_ro</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We may be retrying this request after an error.  Fix up any</span>
<span class="cm">		 * weirdness which might be present in the request packet.</span>
<span class="cm">		 */</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">prep_rq_fn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* fs requests *must* be hardware frame aligned */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sectors_per_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sectors_per_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>

	<span class="cm">/* use DMA, if possible */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_USING_DMA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
		<span class="n">cd</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">.</span><span class="n">media_written</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ATAPI_WAIT_PC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_started</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_do_block_pc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PC</span><span class="p">,</span> <span class="s">&quot;rq-&gt;cmd[0]: 0x%x, rq-&gt;cmd_type: 0x%x&quot;</span><span class="p">,</span>
				  <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_FAILED</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sg request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alignment</span><span class="p">;</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_USING_DMA</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * check if dma is safe</span>
<span class="cm">		 *</span>
<span class="cm">		 * NOTE! The &quot;len&quot; and &quot;addr&quot; checks should possibly have</span>
<span class="cm">		 * separate masks.</span>
<span class="cm">		 */</span>
		<span class="n">alignment</span> <span class="o">=</span> <span class="n">queue_dma_alignment</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">|</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_pad_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="n">alignment</span>
		    <span class="o">||</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_pad_mask</span>
		    <span class="o">||</span> <span class="n">object_is_on_stack</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ide_startstop_t</span> <span class="nf">ide_cd_do_request</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
					<span class="n">sector_t</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nsectors</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_RQ</span><span class="p">,</span> <span class="s">&quot;cmd: 0x%x, block: %llu&quot;</span><span class="p">,</span>
				  <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">block</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">debug_mask</span> <span class="o">&amp;</span> <span class="n">IDE_DBG_RQ</span><span class="p">)</span>
		<span class="n">blk_dump_rq_flags</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="s">&quot;ide_cd_do_request&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REQ_TYPE_FS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_start_rw</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">ide_stopped</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_end</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REQ_TYPE_SENSE</span>:
	<span class="k">case</span> <span class="n">REQ_TYPE_BLOCK_PC</span>:
	<span class="k">case</span> <span class="n">REQ_TYPE_ATA_PC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ATAPI_WAIT_PC</span><span class="p">;</span>

		<span class="n">cdrom_do_block_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REQ_TYPE_SPECIAL</span>:
		<span class="cm">/* right now this can only be a reset... */</span>
		<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_end</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* prepare sense request for this command */</span>
	<span class="n">ide_prep_sense</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">tf_flags</span> <span class="o">|=</span> <span class="n">IDE_TFLAG_WRITE</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">rq</span> <span class="o">=</span> <span class="n">rq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span> <span class="o">||</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ide_init_sg_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">));</span>
		<span class="n">ide_map_sg</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ide_issue_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">out_end:</span>
	<span class="n">nsectors</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nsectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ide_complete_rq</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">uptodate</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="n">nsectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ide_stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ioctl handling.</span>
<span class="cm"> *</span>
<span class="cm"> * Routines which queue packet commands take as a final argument a pointer to a</span>
<span class="cm"> * request_sense struct. If execution of the command results in an error with a</span>
<span class="cm"> * CHECK CONDITION status, this structure will be filled with the results of the</span>
<span class="cm"> * subsequent request sense command. The pointer can also be NULL, in which case</span>
<span class="cm"> * no sense information is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msf_from_bcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_msf</span> <span class="o">*</span><span class="n">msf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msf</span><span class="o">-&gt;</span><span class="n">minute</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">minute</span><span class="p">);</span>
	<span class="n">msf</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
	<span class="n">msf</span><span class="o">-&gt;</span><span class="n">frame</span>  <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cdrom_check_status</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">BLK_MAX_CDB</span><span class="p">];</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_TEST_UNIT_READY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanyo 3 CD changer uses byte 7 of TEST_UNIT_READY to switch CDs</span>
<span class="cm">	 * instead of supporting the LOAD_UNLOAD opcode.</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_cd_queue_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQ_QUIET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_capacity</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">capacity</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sectors_per_frame</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="n">lba</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="n">blocklen</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">capbuf</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">BLK_MAX_CDB</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">capbuf</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">blocklen</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_CDVD_CAPACITY</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">ide_cd_queue_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">capbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">REQ_QUIET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check the given block size, in so far as making</span>
<span class="cm">	 * sure the sectors_per_frame we give to the caller won&#39;t</span>
<span class="cm">	 * end up being bogus.</span>
<span class="cm">	 */</span>
	<span class="n">blocklen</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">capbuf</span><span class="p">.</span><span class="n">blocklen</span><span class="p">);</span>
	<span class="n">blocklen</span> <span class="o">=</span> <span class="p">(</span><span class="n">blocklen</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_BITS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SECTOR_BITS</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blocklen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">512</span>:
	<span class="k">case</span> <span class="mi">1024</span>:
	<span class="k">case</span> <span class="mi">2048</span>:
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: weird block size %u; &quot;</span>
				<span class="s">&quot;setting default block size to 2048</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">blocklen</span><span class="p">);</span>
		<span class="n">blocklen</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">capbuf</span><span class="p">.</span><span class="n">lba</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sectors_per_frame</span> <span class="o">=</span> <span class="n">blocklen</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_BITS</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;cap: %lu, sectors_per_frame: %lu&quot;</span><span class="p">,</span>
				     <span class="o">*</span><span class="n">capacity</span><span class="p">,</span> <span class="o">*</span><span class="n">sectors_per_frame</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_tocentry</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trackno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msf_flag</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">format</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">BLK_MAX_CDB</span><span class="p">];</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_TOC_PMA_ATIP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackno</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">format</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msf_flag</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_cd_queue_pc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQ_QUIET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Try to read the entire TOC for the disk into our internal buffer. */</span>
<span class="kt">int</span> <span class="nf">ide_cd_read_toc</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">ntracks</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atapi_toc</span> <span class="o">*</span><span class="n">toc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">toc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atapi_toc_header</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">atapi_toc_entry</span>  <span class="n">ent</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ms_tmp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">last_written</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sectors_per_frame</span> <span class="o">=</span> <span class="n">SECTORS_PER_FRAME</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">toc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* try to allocate space */</span>
		<span class="n">toc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_toc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: No cdrom TOC buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">toc</span> <span class="o">=</span> <span class="n">toc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if the existing data is still valid. If it is,</span>
<span class="cm">	 * just return.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cdrom_check_status</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOC_VALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* try to get the total cdrom capacity and sector size */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_read_capacity</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors_per_frame</span><span class="p">,</span>
				   <span class="n">sense</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0x1fffff</span><span class="p">;</span>

	<span class="n">set_capacity</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">*</span> <span class="n">sectors_per_frame</span><span class="p">);</span>
	<span class="cm">/* save a private copy of the TOC capacity for error handling */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">probed_capacity</span> <span class="o">=</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">*</span> <span class="n">sectors_per_frame</span><span class="p">;</span>

	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
				     <span class="n">sectors_per_frame</span> <span class="o">&lt;&lt;</span> <span class="n">SECTOR_BITS</span><span class="p">);</span>

	<span class="cm">/* first read just the header, so we know how long the TOC is */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_read_tocentry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_toc_header</span><span class="p">),</span> <span class="n">sense</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOCTRACKS_AS_BCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span><span class="p">);</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span>  <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ntracks</span> <span class="o">=</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span> <span class="o">-</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntracks</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntracks</span> <span class="o">&gt;</span> <span class="n">MAX_TRACKS</span><span class="p">)</span>
		<span class="n">ntracks</span> <span class="o">=</span> <span class="n">MAX_TRACKS</span><span class="p">;</span>

	<span class="cm">/* now read the whole schmeer */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_read_tocentry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_toc_header</span><span class="p">)</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">ntracks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_toc_entry</span><span class="p">),</span> <span class="n">sense</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;&amp;</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Cds with CDI tracks only don&#39;t have any TOC entries, despite</span>
<span class="cm">		 * of this the returned values are</span>
<span class="cm">		 * first_track == last_track = number of CDI tracks + 1,</span>
<span class="cm">		 * so that this case is indistinguishable from the same layout</span>
<span class="cm">		 * plus an additional audio track. If we get an error for the</span>
<span class="cm">		 * regular case, we assume a CDI without additional audio</span>
<span class="cm">		 * tracks. In this case the readable TOC is empty (CDI tracks</span>
<span class="cm">		 * are not included) and only holds the Leadout entry.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Heiko Eißfeldt.</span>
<span class="cm">		 */</span>
		<span class="n">ntracks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_read_tocentry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">CDROM_LEADOUT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_toc_header</span><span class="p">)</span> <span class="o">+</span>
					   <span class="p">(</span><span class="n">ntracks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atapi_toc_entry</span><span class="p">),</span>
					   <span class="n">sense</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOCTRACKS_AS_BCD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">bin2bcd</span><span class="p">(</span><span class="n">CDROM_LEADOUT</span><span class="p">);</span>
			<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">bin2bcd</span><span class="p">(</span><span class="n">CDROM_LEADOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">=</span> <span class="n">CDROM_LEADOUT</span><span class="p">;</span>
			<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span> <span class="o">=</span> <span class="n">CDROM_LEADOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">toc_length</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">toc_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOCTRACKS_AS_BCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span><span class="p">);</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span>  <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ntracks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOCADDR_AS_BCD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOCTRACKS_AS_BCD</span><span class="p">)</span>
				<span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">track</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">track</span><span class="p">);</span>
			<span class="n">msf_from_bcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span> <span class="n">msf_to_lba</span><span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span>
						  <span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span><span class="p">,</span>
						  <span class="n">toc</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">!=</span> <span class="n">CDROM_LEADOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read the multisession information */</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_read_tocentry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ms_tmp</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_tmp</span><span class="p">),</span> <span class="n">sense</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">last_session_lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ms_tmp</span><span class="p">.</span><span class="n">ent</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">lba</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ms_tmp</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span> <span class="o">=</span> <span class="n">CDROM_LEADOUT</span><span class="p">;</span>
		<span class="n">ms_tmp</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">=</span> <span class="n">ms_tmp</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span><span class="p">;</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">last_session_lba</span> <span class="o">=</span> <span class="n">msf_to_lba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* 0m 2s 0f */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_TOCADDR_AS_BCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* re-read multisession information using MSF format */</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_read_tocentry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ms_tmp</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_tmp</span><span class="p">),</span> <span class="n">sense</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">msf_from_bcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms_tmp</span><span class="p">.</span><span class="n">ent</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">);</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">last_session_lba</span> <span class="o">=</span> <span class="n">msf_to_lba</span><span class="p">(</span><span class="n">ms_tmp</span><span class="p">.</span><span class="n">ent</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span>
						   <span class="n">ms_tmp</span><span class="p">.</span><span class="n">ent</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span><span class="p">,</span>
						   <span class="n">ms_tmp</span><span class="p">.</span><span class="n">ent</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">toc</span><span class="o">-&gt;</span><span class="n">xa_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">ms_tmp</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_track</span> <span class="o">!=</span> <span class="n">ms_tmp</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_track</span><span class="p">);</span>

	<span class="cm">/* now try to get the total cdrom capacity */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_get_last_written</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_written</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">last_written</span> <span class="o">&gt;</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">last_written</span><span class="p">;</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">*</span> <span class="n">sectors_per_frame</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">probed_capacity</span> <span class="o">=</span> <span class="n">toc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">*</span> <span class="n">sectors_per_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remember that we&#39;ve read this stuff. */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">|=</span> <span class="n">IDE_AFLAG_TOC_VALID</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_cdrom_get_capabilities</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ATAPI_CAPABILITIES_PAGE_SIZE</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_FULL_CAPS_PAGE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">ATAPI_CAPABILITIES_PAGE_PAD_SIZE</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CGC_DATA_UNKNOWN</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* we seem to get stat=0x01,err=0x00 the first time (??) */</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_CAPABILITIES_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">attempts</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_cdrom_update_speed</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">curspeed</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_LE_SPEED_FIELDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curspeed</span> <span class="o">=</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]);</span>
		<span class="n">maxspeed</span> <span class="o">=</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">curspeed</span> <span class="o">=</span> <span class="n">be16_to_cpup</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]);</span>
		<span class="n">maxspeed</span> <span class="o">=</span> <span class="n">be16_to_cpup</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;curspeed: %u, maxspeed: %u&quot;</span><span class="p">,</span>
				     <span class="n">curspeed</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">);</span>

	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">current_speed</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">curspeed</span><span class="p">,</span> <span class="mi">176</span><span class="p">);</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">maxspeed</span><span class="p">,</span> <span class="mi">176</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IDE_CD_CAPABILITIES \</span>
<span class="cp">	(CDC_CLOSE_TRAY | CDC_OPEN_TRAY | CDC_LOCK | CDC_SELECT_SPEED | \</span>
<span class="cp">	 CDC_SELECT_DISC | CDC_MULTI_SESSION | CDC_MCN | CDC_MEDIA_CHANGED | \</span>
<span class="cp">	 CDC_PLAY_AUDIO | CDC_RESET | CDC_DRIVE_STATUS | CDC_CD_R | \</span>
<span class="cp">	 CDC_CD_RW | CDC_DVD | CDC_DVD_R | CDC_DVD_RAM | CDC_GENERIC_PACKET | \</span>
<span class="cp">	 CDC_MO_DRIVE | CDC_MRW | CDC_MRW_W | CDC_RAM)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="n">ide_cdrom_dops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">ide_cdrom_open_real</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">ide_cdrom_release_real</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drive_status</span>		<span class="o">=</span> <span class="n">ide_cdrom_drive_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>		<span class="o">=</span> <span class="n">ide_cdrom_check_events_real</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tray_move</span>		<span class="o">=</span> <span class="n">ide_cdrom_tray_move</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_door</span>		<span class="o">=</span> <span class="n">ide_cdrom_lock_door</span><span class="p">,</span>
	<span class="p">.</span><span class="n">select_speed</span>		<span class="o">=</span> <span class="n">ide_cdrom_select_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_last_session</span>	<span class="o">=</span> <span class="n">ide_cdrom_get_last_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mcn</span>		<span class="o">=</span> <span class="n">ide_cdrom_get_mcn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>			<span class="o">=</span> <span class="n">ide_cdrom_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">audio_ioctl</span>		<span class="o">=</span> <span class="n">ide_cdrom_audio_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capability</span>		<span class="o">=</span> <span class="n">IDE_CD_CAPABILITIES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">generic_packet</span>		<span class="o">=</span> <span class="n">ide_cdrom_packet</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cdrom_register</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nslots</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">devinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;nslots: %d&quot;</span><span class="p">,</span> <span class="n">nslots</span><span class="p">);</span>

	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_cdrom_dops</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">nslots</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_NO_SPEED_SELECT</span><span class="p">)</span>
		<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">CDC_SELECT_SPEED</span><span class="p">;</span>

	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">register_cdrom</span><span class="p">(</span><span class="n">devinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cdrom_probe_capabilities</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATAPI_CAPABILITIES_PAGE_SIZE</span><span class="p">];</span>
	<span class="n">mechtype_t</span> <span class="n">mechtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nslots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;media: 0x%x, atapi_flags: 0x%lx&quot;</span><span class="p">,</span>
				     <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span><span class="p">);</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">CDC_CD_R</span> <span class="o">|</span> <span class="n">CDC_CD_RW</span> <span class="o">|</span> <span class="n">CDC_DVD</span> <span class="o">|</span> <span class="n">CDC_DVD_R</span> <span class="o">|</span>
		     <span class="n">CDC_DVD_RAM</span> <span class="o">|</span> <span class="n">CDC_SELECT_DISC</span> <span class="o">|</span> <span class="n">CDC_PLAY_AUDIO</span> <span class="o">|</span>
		     <span class="n">CDC_MO_DRIVE</span> <span class="o">|</span> <span class="n">CDC_RAM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_optical</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CDC_MO_DRIVE</span> <span class="o">|</span> <span class="n">CDC_RAM</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: ATAPI magneto-optical drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nslots</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_PRE_ATAPI12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_AFLAG_NO_EJECT</span><span class="p">;</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">nslots</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to cheat a little here. the packet will eventually be queued</span>
<span class="cm">	 * with ide_cdrom_packet(), which extracts the drive from cdi-&gt;handle.</span>
<span class="cm">	 * Since this device hasn&#39;t been registered with the Uniform layer yet,</span>
<span class="cm">	 * it can&#39;t do this. Same goes for cdi-&gt;ops.</span>
<span class="cm">	 */</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_cdrom_dops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_cdrom_get_capabilities</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_DOORLOCKING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_AFLAG_NO_EJECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_CD_R</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CDC_CD_RW</span> <span class="o">|</span> <span class="n">CDC_RAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_DVD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CDC_DVD_RAM</span> <span class="o">|</span> <span class="n">CDC_RAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_DVD_R</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span><span class="p">))</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">;</span>

	<span class="n">mechtype</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mechtype</span> <span class="o">==</span> <span class="n">mechtype_caddy</span> <span class="o">||</span>
	    <span class="n">mechtype</span> <span class="o">==</span> <span class="n">mechtype_popup</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_NO_AUTOCLOSE</span><span class="p">))</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">CDC_CLOSE_TRAY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_SELECT_DISC</span><span class="p">;</span>
		<span class="n">nslots</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mechtype</span> <span class="o">==</span> <span class="n">mechtype_individual_changer</span> <span class="o">||</span>
		   <span class="n">mechtype</span> <span class="o">==</span> <span class="n">mechtype_cartridge_changer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nslots</span> <span class="o">=</span> <span class="n">cdrom_number_of_slots</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nslots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_SELECT_DISC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_cdrom_update_speed</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;%s: ATAPI&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* don&#39;t print speed if the drive reported 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %dX&quot;</span><span class="p">,</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_DVD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CD-ROM&quot;</span> <span class="o">:</span> <span class="s">&quot;DVD-ROM&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_DVD_R</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_DVD_RAM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; DVD%s%s&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_DVD_R</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;-R&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_DVD_RAM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;/RAM&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_CD_R</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_CD_RW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; CD%s%s&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_CD_R</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;-R&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_CD_RW</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;/RW&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CDC_SELECT_DISC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; changer w/%d slots&quot;</span><span class="p">,</span> <span class="n">nslots</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; drive&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;, %dkB Cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">be16_to_cpup</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]));</span>

	<span class="k">return</span> <span class="n">nslots</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* standard prep_rq_fn that builds 10 byte cmds */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cdrom_prep_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hard_sect</span> <span class="o">=</span> <span class="n">queue_logical_block_size</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hard_sect</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hard_sect</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_WRITE_10</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * fill in lba</span>
<span class="cm">	 */</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * and transfer length</span>
<span class="cm">	 */</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocks</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BLKPREP_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Most of the SCSI commands are supported directly by ATAPI devices.</span>
<span class="cm"> * This transform handles the few exceptions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cdrom_prep_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* transform 6-byte read/write commands to the 10-byte version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span> <span class="o">||</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">READ_10</span> <span class="o">-</span> <span class="n">READ_6</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BLKPREP_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * it&#39;s silly to pretend we understand 6-byte sense commands, just</span>
<span class="cm">	 * reject with ILLEGAL_REQUEST and the caller should take the</span>
<span class="cm">	 * appropriate action</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODE_SENSE</span> <span class="o">||</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODE_SELECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BLKPREP_KILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BLKPREP_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cdrom_prep_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ide_cdrom_prep_fs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ide_cdrom_prep_pc</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cd_list_entry</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">id_model</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">id_firmware</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cd_flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_IDE_PROC_FS</span>
<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">ide_cdrom_capacity</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">sectors_per_frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_read_capacity</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">capacity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors_per_frame</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">capacity</span> <span class="o">*</span> <span class="n">sectors_per_frame</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_capacity_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ide_cdrom_capacity</span><span class="p">(</span><span class="n">drive</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_capacity_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">idecd_capacity_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">idecd_capacity_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">idecd_capacity_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ide_proc_entry_t</span> <span class="n">idecd_proc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;capacity&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idecd_capacity_proc_fops</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ide_proc_entry_t</span> <span class="o">*</span><span class="nf">ide_cd_proc_entries</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idecd_proc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="nf">ide_cd_proc_devsets</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cd_list_entry</span> <span class="n">ide_cd_quirks_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* SCR-3231 doesn&#39;t support the SET_CD_SPEED command. */</span>
	<span class="p">{</span> <span class="s">&quot;SAMSUNG CD-ROM SCR-3231&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_NO_SPEED_SELECT</span>	     <span class="p">},</span>
	<span class="cm">/* Old NEC260 (not R) was released before ATAPI 1.2 spec. */</span>
	<span class="p">{</span> <span class="s">&quot;NEC CD-ROM DRIVE:260&quot;</span><span class="p">,</span>    <span class="s">&quot;1.01&quot;</span><span class="p">,</span> <span class="n">IDE_AFLAG_TOCADDR_AS_BCD</span> <span class="o">|</span>
					     <span class="n">IDE_AFLAG_PRE_ATAPI12</span><span class="p">,</span>	     <span class="p">},</span>
	<span class="cm">/* Vertos 300, some versions of this drive like to talk BCD. */</span>
	<span class="p">{</span> <span class="s">&quot;V003S0DS&quot;</span><span class="p">,</span>		     <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_VERTOS_300_SSD</span><span class="p">,</span>	     <span class="p">},</span>
	<span class="cm">/* Vertos 600 ESD. */</span>
	<span class="p">{</span> <span class="s">&quot;V006E0DS&quot;</span><span class="p">,</span>		     <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_VERTOS_600_ESD</span><span class="p">,</span>	     <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * Sanyo 3 CD changer uses a non-standard command for CD changing</span>
<span class="cm">	 * (by default standard ATAPI support for CD changers is used).</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="s">&quot;CD-ROM CDR-C3 G&quot;</span><span class="p">,</span>	     <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_SANYO_3CD</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CD-ROM CDR-C3G&quot;</span><span class="p">,</span>	     <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_SANYO_3CD</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CD-ROM CDR_C36&quot;</span><span class="p">,</span>	     <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_SANYO_3CD</span>	     <span class="p">},</span>
	<span class="cm">/* Stingray 8X CD-ROM. */</span>
	<span class="p">{</span> <span class="s">&quot;STINGRAY 8422 IDE 8X CD-ROM 7-27-95&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IDE_AFLAG_PRE_ATAPI12</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * ACER 50X CD-ROM and WPI 32X CD-ROM require the full spec length</span>
<span class="cm">	 * mode sense page capabilities size, but older drives break.</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="s">&quot;ATAPI CD ROM DRIVE 50X MAX&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>	<span class="n">IDE_AFLAG_FULL_CAPS_PAGE</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WPI CDS-32X&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>	<span class="n">IDE_AFLAG_FULL_CAPS_PAGE</span>     <span class="p">},</span>
	<span class="cm">/* ACER/AOpen 24X CD-ROM has the speed fields byte-swapped. */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>			     <span class="s">&quot;241N&quot;</span><span class="p">,</span> <span class="n">IDE_AFLAG_LE_SPEED_FIELDS</span>       <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some drives used by Apple don&#39;t advertise audio play</span>
<span class="cm">	 * but they do support reading TOC &amp; audio datas.</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="s">&quot;MATSHITADVD-ROM SR-8187&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MATSHITADVD-ROM SR-8186&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MATSHITADVD-ROM SR-8176&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MATSHITADVD-ROM SR-8174&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Optiarc DVD RW AD-5200A&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Optiarc DVD RW AD-7200A&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_PLAY_AUDIO_OK</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Optiarc DVD RW AD-7543A&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_NO_AUTOCLOSE</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TEAC CD-ROM CD-224E&quot;</span><span class="p">,</span>     <span class="nb">NULL</span><span class="p">,</span>   <span class="n">IDE_AFLAG_NO_AUTOCLOSE</span>	     <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ide_cd_flags</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cd_list_entry</span> <span class="o">*</span><span class="n">cle</span> <span class="o">=</span> <span class="n">ide_cd_quirks_list</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cle</span><span class="o">-&gt;</span><span class="n">id_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cle</span><span class="o">-&gt;</span><span class="n">id_model</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cle</span><span class="o">-&gt;</span><span class="n">id_firmware</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		     <span class="n">strstr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FW_REV</span><span class="p">],</span> <span class="n">cle</span><span class="o">-&gt;</span><span class="n">id_firmware</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">cle</span><span class="o">-&gt;</span><span class="n">cd_flags</span><span class="p">;</span>
		<span class="n">cle</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cdrom_setup</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_rev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FW_REV</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">nslots</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="n">blk_queue_prep_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ide_cdrom_prep_fn</span><span class="p">);</span>
	<span class="n">blk_queue_dma_alignment</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">blk_queue_update_dma_pad</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_MEDIA_CHANGED</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">=</span> <span class="n">IDE_AFLAG_NO_EJECT</span> <span class="o">|</span> <span class="n">ide_cd_flags</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_VERTOS_300_SSD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fw_rev</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">fw_rev</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;2&#39;</span><span class="p">)</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IDE_AFLAG_TOCTRACKS_AS_BCD</span> <span class="o">|</span>
				     <span class="n">IDE_AFLAG_TOCADDR_AS_BCD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_VERTOS_600_ESD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fw_rev</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">fw_rev</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;2&#39;</span><span class="p">)</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">|=</span> <span class="n">IDE_AFLAG_TOCTRACKS_AS_BCD</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">&amp;</span> <span class="n">IDE_AFLAG_SANYO_3CD</span><span class="p">)</span>
		<span class="cm">/* 3 =&gt; use CD in slot 0 */</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">nslots</span> <span class="o">=</span> <span class="n">ide_cdrom_probe_capabilities</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">CD_FRAMESIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_cdrom_register</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">nslots</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: %s failed to register device with the&quot;</span>
				<span class="s">&quot; cdrom driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cd</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_proc_register_driver</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_cd_remove</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="n">ide_proc_unregister_driver</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idecd_ref_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_cd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_ide_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cdrom_info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">devinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;enter&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">toc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">drive</span><span class="p">)</span>
		<span class="n">unregister_cdrom</span><span class="p">(</span><span class="n">devinfo</span><span class="p">);</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk_queue_prep_rq</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ide_cd_probe</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ide_driver</span> <span class="n">ide_cdrom_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen_driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ide-cdrom&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_bus_type</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">ide_cd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">ide_cd_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>		<span class="o">=</span> <span class="n">IDECD_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">do_request</span>		<span class="o">=</span> <span class="n">ide_cd_do_request</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IDE_PROC_FS</span>
	<span class="p">.</span><span class="n">proc_entries</span>		<span class="o">=</span> <span class="n">ide_cd_proc_entries</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_devsets</span>		<span class="o">=</span> <span class="n">ide_cd_proc_devsets</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cd_mutex</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">ide_cd_get</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cdrom_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ide_cd_put</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cd_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ide_drv_g</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cdrom_info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cd_mutex</span><span class="p">);</span>
	<span class="n">cdrom_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">ide_cd_put</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cd_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_set_spindown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">spindown</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spindown</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_UNKNOWN</span><span class="p">);</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_CDROM_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">spindown</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdrom_mode_select</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_get_spindown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">spindown</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_UNKNOWN</span><span class="p">);</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_CDROM_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">spindown</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spindown</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_locked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ide_drv_g</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">,</span> <span class="n">cdrom_info</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMSETSPINDOWN</span>:
		<span class="k">return</span> <span class="n">idecd_set_spindown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMGETSPINDOWN</span>:
		<span class="k">return</span> <span class="n">idecd_get_spindown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_ide_ioctl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cdrom_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cd_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">idecd_locked_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cd_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">idecd_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ide_drv_g</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cdrom_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdrom_check_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">clearing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idecd_revalidate_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ide_drv_g</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cdrom_info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>

	<span class="n">ide_cd_read_toc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">);</span>

	<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">idecd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">idecd_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">idecd_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">idecd_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>		<span class="o">=</span> <span class="n">idecd_check_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">revalidate_disk</span>	<span class="o">=</span> <span class="n">idecd_revalidate_disk</span>
<span class="p">};</span>

<span class="cm">/* module options */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">debug_mask</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_mask</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ATAPI CD-ROM Driver&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_cd_probe</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>

	<span class="n">ide_debug_log</span><span class="p">(</span><span class="n">IDE_DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;driver_req: %s, media: 0x%x&quot;</span><span class="p">,</span>
				     <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_req</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="s">&quot;ide-cdrom&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_req</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">ide_cdrom</span> <span class="o">&amp;&amp;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">ide_optical</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">debug_mask</span> <span class="o">=</span> <span class="n">debug_mask</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">cdrom_newpc_intr</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Can&#39;t allocate a cdrom structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">g</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PARTN_BITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_cd</span><span class="p">;</span>

	<span class="n">ide_init_disk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ide_cd_release</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_disk</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">drive</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_cdrom_driver</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>

	<span class="n">g</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">g</span><span class="o">-&gt;</span><span class="n">minors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">driverfs_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENHD_FL_CD</span> <span class="o">|</span> <span class="n">GENHD_FL_REMOVABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_cdrom_setup</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_cd_read_toc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">);</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idecd_ops</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENHD_FL_REMOVABLE</span> <span class="o">|</span> <span class="n">GENHD_FL_BLOCK_EVENTS_ON_EXCL_WRITE</span><span class="p">;</span>
	<span class="n">add_disk</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_disk:</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
<span class="nl">out_free_cd:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">failed:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ide_cdrom_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cdrom_driver</span><span class="p">.</span><span class="n">gen_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ide_cdrom_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot; driver &quot;</span> <span class="n">IDECD_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cdrom_driver</span><span class="p">.</span><span class="n">gen_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ide:*m-cdrom*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ide-cd&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ide_cdrom_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ide_cdrom_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
