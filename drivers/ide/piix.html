<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › piix.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>piix.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1998-1999 Andrzej Krzysztofowicz, Author and Maintainer</span>
<span class="cm"> *  Copyright (C) 1998-2000 Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> *  Copyright (C) 2003 Red Hat</span>
<span class="cm"> *  Copyright (C) 2006-2007 MontaVista Software, Inc. &lt;source@mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  May be copied or modified under the terms of the GNU General Public License</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation:</span>
<span class="cm"> *</span>
<span class="cm"> *	Publicly available from Intel web site. Errata documentation</span>
<span class="cm"> * is also publicly available. As an aide to anyone hacking on this</span>
<span class="cm"> * driver the list of errata that are relevant is below.going back to</span>
<span class="cm"> * PIIX4. Older device documentation is now a bit tricky to find.</span>
<span class="cm"> *</span>
<span class="cm"> * Errata of note:</span>
<span class="cm"> *</span>
<span class="cm"> * Unfixable</span>
<span class="cm"> *	PIIX4    errata #9	- Only on ultra obscure hw</span>
<span class="cm"> *	ICH3	 errata #13     - Not observed to affect real hw</span>
<span class="cm"> *				  by Intel</span>
<span class="cm"> *</span>
<span class="cm"> * Things we must deal with</span>
<span class="cm"> *	PIIX4	errata #10	- BM IDE hang with non UDMA</span>
<span class="cm"> *				  (must stop/start dma to recover)</span>
<span class="cm"> *	440MX   errata #15	- As PIIX4 errata #10</span>
<span class="cm"> *	PIIX4	errata #15	- Must not read control registers</span>
<span class="cm"> * 				  during a PIO transfer</span>
<span class="cm"> *	440MX   errata #13	- As PIIX4 errata #15</span>
<span class="cm"> *	ICH2	errata #21	- DMA mode 0 doesn&#39;t work right</span>
<span class="cm"> *	ICH0/1  errata #55	- As ICH2 errata #21</span>
<span class="cm"> *	ICH2	spec c #9	- Extra operations needed to handle</span>
<span class="cm"> *				  drive hotswap [NOT YET SUPPORTED]</span>
<span class="cm"> *	ICH2    spec c #20	- IDE PRD must not cross a 64K boundary</span>
<span class="cm"> *				  and must be dword aligned</span>
<span class="cm"> *	ICH2    spec c #24	- UDMA mode 4,5 t85/86 should be 6ns not 3.3</span>
<span class="cm"> *</span>
<span class="cm"> * Should have been BIOS fixed:</span>
<span class="cm"> *	450NX:	errata #19	- DMA hangs on old 450NX</span>
<span class="cm"> *	450NX:  errata #20	- DMA hangs on old 450NX</span>
<span class="cm"> *	450NX:  errata #25	- Corruption with DMA on old 450NX</span>
<span class="cm"> *	ICH3    errata #15      - IDE deadlock under high load</span>
<span class="cm"> *				  (BIOS must set dev 31 fn 0 bit 23)</span>
<span class="cm"> *	ICH3	errata #18	- Don&#39;t use native mode</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;piix&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">no_piix_dma</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_set_pio_mode	-	set host controller for PIO mode</span>
<span class="cm"> *	@port: port</span>
<span class="cm"> *	@drive: drive</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the interface PIO mode based upon the settings done by AMI BIOS.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_set_pio_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_slave</span>		<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">master_port</span>		<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x42</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slave_port</span>		<span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">master_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slave_data</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">tune_lock</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pio</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>

				     <span class="cm">/* ISP  RTC */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">timings</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
					<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
					<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
					<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
					<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Master vs slave is synchronized above us but the slave register is</span>
<span class="cm">	 * shared by the two hwifs so the corner case of two slave timeouts in</span>
<span class="cm">	 * parallel must be locked.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tune_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">master_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Programmable timing on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_disk</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Prefetch, post write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_pio_need_iordy</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">pio</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* IORDY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_slave</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_data</span> <span class="o">|=</span>  <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">master_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0070</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set PPE, IE and TIME */</span>
			<span class="n">master_data</span> <span class="o">|=</span> <span class="n">control</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slave_data</span><span class="p">);</span>
		<span class="n">slave_data</span> <span class="o">&amp;=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x0f</span> <span class="o">:</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">slave_data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span>
			       <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">master_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3307</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enable PPE, IE and TIME */</span>
			<span class="n">master_data</span> <span class="o">|=</span> <span class="n">control</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">master_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master_port</span><span class="p">,</span> <span class="n">master_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_slave</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">,</span> <span class="n">slave_data</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tune_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_set_dma_mode	-	set host controller for DMA mode</span>
<span class="cm"> *	@hwif: port</span>
<span class="cm"> *	@drive: drive</span>
<span class="cm"> *</span>
<span class="cm"> *	Set a PIIX host controller to the desired DMA mode.  This involves</span>
<span class="cm"> *	programming the right timing data into the PCI configuration space.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_set_dma_mode</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">maslave</span>		<span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0x42</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">a_speed</span>		<span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">u_flag</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v_flag</span>		<span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">w_flag</span>		<span class="o">=</span> <span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">u_speed</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">sitre</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">reg4042</span><span class="p">,</span> <span class="n">reg4a</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">reg48</span><span class="p">,</span> <span class="n">reg54</span><span class="p">,</span> <span class="n">reg55</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">speed</span>		<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">maslave</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg4042</span><span class="p">);</span>
	<span class="n">sitre</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg4042</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg48</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg4a</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg54</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg55</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">udma</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span><span class="p">;</span>

		<span class="n">u_speed</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">udma</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">udma</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg48</span> <span class="o">&amp;</span> <span class="n">u_flag</span><span class="p">))</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">reg48</span> <span class="o">|</span> <span class="n">u_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">XFER_UDMA_5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">reg55</span><span class="o">|</span><span class="n">w_flag</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">reg55</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">w_flag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reg4a</span> <span class="o">&amp;</span> <span class="n">a_speed</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u_speed</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="p">(</span><span class="n">reg4a</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">a_speed</span><span class="p">)</span> <span class="o">|</span> <span class="n">u_speed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg54</span> <span class="o">&amp;</span> <span class="n">v_flag</span><span class="p">))</span>
				<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">reg54</span> <span class="o">|</span> <span class="n">v_flag</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">reg54</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">v_flag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">mwdma_to_pio</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg48</span> <span class="o">&amp;</span> <span class="n">u_flag</span><span class="p">)</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">reg48</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">u_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg4a</span> <span class="o">&amp;</span> <span class="n">a_speed</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="n">reg4a</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">a_speed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg54</span> <span class="o">&amp;</span> <span class="n">v_flag</span><span class="p">)</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">reg54</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">v_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg55</span> <span class="o">&amp;</span> <span class="n">w_flag</span><span class="p">)</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">reg55</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">w_flag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">XFER_MW_DMA_0</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span>
				<span class="n">mwdma_to_pio</span><span class="p">[</span><span class="n">speed</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span><span class="p">]</span> <span class="o">+</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">XFER_PIO_2</span><span class="p">;</span> <span class="cm">/* for SWDMA2 */</span>

		<span class="n">piix_set_pio_mode</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	init_chipset_ich	-	set up the ICH chipset</span>
<span class="cm"> *	@dev: PCI device to set up</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize the PCI device as required.  For the ICH this turns</span>
<span class="cm"> *	out to be nice and simple.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_chipset_ich</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extra</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">extra</span> <span class="o">|</span> <span class="mh">0x400</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ich_clear_irq	-	clear BMDMA status</span>
<span class="cm"> *	@drive: IDE drive</span>
<span class="cm"> *</span>
<span class="cm"> *	ICHx contollers set DMA INTR no matter DMA or PIO.</span>
<span class="cm"> *	BMDMA status might need to be cleared even for</span>
<span class="cm"> *	PIO interrupts to prevent spurious/lost IRQ.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ich_clear_irq</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dma_stat</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ide_dma_end() needs BMDMA status for error checking.</span>
<span class="cm">	 * So, skip clearing BMDMA status here and leave it</span>
<span class="cm">	 * to ide_dma_end() if this is DMA interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">||</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* clear the INTR &amp; ERROR bits */</span>
	<span class="n">dma_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_STATUS</span><span class="p">);</span>
	<span class="cm">/* Should we force the bit as well ? */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">dma_stat</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">ATA_DMA_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ich_laptop</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subvendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subdevice</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	List of laptops that use short cables rather than 80 wire</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ich_laptop</span> <span class="n">ich_laptop</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* devid, subvendor, subdev */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0102</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Acer 5602aWLMi */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0280</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Acer 5602WLMi */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0110</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Acer 3682WLMi */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x1267</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Asus W5F */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x30A1</span> <span class="p">},</span>	<span class="cm">/* ICH7 on HP Compaq nc2400 */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1071</span><span class="p">,</span> <span class="mh">0xD221</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Hercules EC-900 */</span>
	<span class="p">{</span> <span class="mh">0x24CA</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0061</span> <span class="p">},</span>	<span class="cm">/* ICH4 on Acer Aspire 2023WLMi */</span>
	<span class="p">{</span> <span class="mh">0x24CA</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x003d</span> <span class="p">},</span>	<span class="cm">/* ICH4 on ACER TM290 */</span>
	<span class="p">{</span> <span class="mh">0x266F</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0066</span> <span class="p">},</span>	<span class="cm">/* ICH6 on ACER Aspire 1694WLMi */</span>
	<span class="p">{</span> <span class="mh">0x2653</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x82D8</span> <span class="p">},</span>	<span class="cm">/* ICH6M on Asus Eee 701 */</span>
	<span class="p">{</span> <span class="mh">0x27df</span><span class="p">,</span> <span class="mh">0x104d</span><span class="p">,</span> <span class="mh">0x900e</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Sony TZ-90 */</span>
	<span class="cm">/* end marker */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">piix_cable_detect</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ich_laptop</span> <span class="o">*</span><span class="n">lap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_laptop</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">reg54h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="mh">0xc0</span> <span class="o">:</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="cm">/* check for specials */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lap</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lap</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lap</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg54h</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg54h</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="n">ATA_CBL_PATA80</span> <span class="o">:</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	init_hwif_piix		-	fill in the hwif for the PIIX</span>
<span class="cm"> *	@hwif: IDE interface</span>
<span class="cm"> *</span>
<span class="cm"> *	Set up the ide_hwif_t for the PIIX interface according to the</span>
<span class="cm"> *	capabilities of the hardware.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">init_hwif_piix</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_piix_dma</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">ultra_mask</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">swdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">piix_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">piix_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">piix_set_dma_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">piix_cable_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="n">ich_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_pio_mode</span>		<span class="o">=</span> <span class="n">piix_set_pio_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dma_mode</span>		<span class="o">=</span> <span class="n">piix_set_dma_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_irq</span>		<span class="o">=</span> <span class="n">ich_clear_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">piix_cable_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DECLARE_PIIX_DEV(udma) \</span>
<span class="cp">	{						\</span>
<span class="cp">		.name		= DRV_NAME,		\</span>
<span class="cp">		.init_hwif	= init_hwif_piix,	\</span>
<span class="cp">		.enablebits	= {{0x41,0x80,0x80}, {0x43,0x80,0x80}}, \</span>
<span class="cp">		.port_ops	= &amp;piix_port_ops,	\</span>
<span class="cp">		.pio_mask	= ATA_PIO4,		\</span>
<span class="cp">		.swdma_mask	= ATA_SWDMA2_ONLY,	\</span>
<span class="cp">		.mwdma_mask	= ATA_MWDMA12_ONLY,	\</span>
<span class="cp">		.udma_mask	= udma,			\</span>
<span class="cp">	}</span>

<span class="cp">#define DECLARE_ICH_DEV(mwdma, udma) \</span>
<span class="cp">	{ \</span>
<span class="cp">		.name		= DRV_NAME, \</span>
<span class="cp">		.init_chipset	= init_chipset_ich, \</span>
<span class="cp">		.init_hwif	= init_hwif_piix, \</span>
<span class="cp">		.enablebits	= {{0x41,0x80,0x80}, {0x43,0x80,0x80}}, \</span>
<span class="cp">		.port_ops	= &amp;ich_port_ops, \</span>
<span class="cp">		.pio_mask	= ATA_PIO4, \</span>
<span class="cp">		.swdma_mask	= ATA_SWDMA2_ONLY, \</span>
<span class="cp">		.mwdma_mask	= mwdma, \</span>
<span class="cp">		.udma_mask	= udma, \</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="n">piix_pci_info</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0: MPIIX */</span>
	<span class="p">{</span>	<span class="cm">/*</span>
<span class="cm">		 * MPIIX actually has only a single IDE channel mapped to</span>
<span class="cm">		 * the primary or secondary ports depending on the value</span>
<span class="cm">		 * of the bit 14 of the IDETIM register at offset 0x6c</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enablebits</span>	<span class="o">=</span> <span class="p">{{</span><span class="mh">0x6d</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x80</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x6d</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">}},</span>
		<span class="p">.</span><span class="n">host_flags</span>	<span class="o">=</span> <span class="n">IDE_HFLAG_ISA_PORTS</span> <span class="o">|</span> <span class="n">IDE_HFLAG_NO_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="cm">/* This is a painful system best to let it self tune for now */</span>
	<span class="p">},</span>
	<span class="cm">/* 1: PIIXa/PIIXb/PIIX3 */</span>
	<span class="n">DECLARE_PIIX_DEV</span><span class="p">(</span><span class="mh">0x00</span><span class="p">),</span> <span class="cm">/* no udma */</span>
	<span class="cm">/* 2: PIIX4 */</span>
	<span class="n">DECLARE_PIIX_DEV</span><span class="p">(</span><span class="n">ATA_UDMA2</span><span class="p">),</span>
	<span class="cm">/* 3: ICH0 */</span>
	<span class="n">DECLARE_ICH_DEV</span><span class="p">(</span><span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">),</span>
	<span class="cm">/* 4: ICH */</span>
	<span class="n">DECLARE_ICH_DEV</span><span class="p">(</span><span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="n">ATA_UDMA4</span><span class="p">),</span>
	<span class="cm">/* 5: PIIX4 */</span>
	<span class="n">DECLARE_PIIX_DEV</span><span class="p">(</span><span class="n">ATA_UDMA4</span><span class="p">),</span>
	<span class="cm">/* 6: ICH[2-6]/ICH[2-3]M/C-ICH/ICH5-SATA/ESB2/ICH8M */</span>
	<span class="n">DECLARE_ICH_DEV</span><span class="p">(</span><span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">),</span>
	<span class="cm">/* 7: ICH7/7-R, no MWDMA1 */</span>
	<span class="n">DECLARE_ICH_DEV</span><span class="p">(</span><span class="n">ATA_MWDMA2_ONLY</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_init_one	-	called when a PIIX is found</span>
<span class="cm"> *	@dev: the piix device</span>
<span class="cm"> *	@id: the matching pci id</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when the PCI registration layer (or the IDE initialization)</span>
<span class="cm"> *	finds a device matching our IDE device tables.</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">piix_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ide_pci_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">piix_pci_info</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_check_450nx	-	Check for problem 450NX setup</span>
<span class="cm"> *	</span>
<span class="cm"> *	Check for the present of 450NX errata #19 and errata #25. If</span>
<span class="cm"> *	they are found, disable use of DMA IDE</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">piix_check_450nx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">while</span><span class="p">((</span><span class="n">pdev</span><span class="o">=</span><span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82454NX</span><span class="p">,</span> <span class="n">pdev</span><span class="p">))</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Look for 450NX PXB. Check for problem configurations</span>
<span class="cm">		   A PCI quirk checks bit 6 already */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="cm">/* Only on the original revision: IDE DMA can hang */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">no_piix_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* On all revisions below 5 PXB bus lock must be disabled for IDE */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">no_piix_dma</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">no_piix_dma</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: 450NX errata present, disabling IDE DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">no_piix_dma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: A BIOS update may resolve this.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>		

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">piix_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82371FB_0</span><span class="p">),</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82371FB_1</span><span class="p">),</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82371MX</span><span class="p">),</span>    <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82371SB_1</span><span class="p">),</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82371AB</span><span class="p">),</span>    <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AB_1</span><span class="p">),</span>  <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82443MX_1</span><span class="p">),</span>  <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AA_1</span><span class="p">),</span>  <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82372FB_1</span><span class="p">),</span>  <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82451NX</span><span class="p">),</span>    <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_9</span><span class="p">),</span>  <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_8</span><span class="p">),</span>  <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801CA_10</span><span class="p">),</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801CA_11</span><span class="p">),</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801DB_11</span><span class="p">),</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801EB_11</span><span class="p">),</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801E_11</span><span class="p">),</span>  <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801DB_10</span><span class="p">),</span> <span class="mi">6</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_IDE_SATA</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801EB_1</span><span class="p">),</span>  <span class="mi">6</span> <span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_ESB_2</span><span class="p">),</span>      <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH6_19</span><span class="p">),</span>    <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_21</span><span class="p">),</span>    <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801DB_1</span><span class="p">),</span>  <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_ESB2_18</span><span class="p">),</span>    <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH8_6</span><span class="p">),</span>     <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">piix_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">piix_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;PIIX_IDE&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">piix_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">piix_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ide_pci_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ide_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ide_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">piix_ide_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">piix_check_450nx</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ide_pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">piix_ide_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">piix_ide_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">piix_ide_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andre Hedrick, Andrzej Krzysztofowicz&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PCI driver module for Intel PIIX IDE&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
