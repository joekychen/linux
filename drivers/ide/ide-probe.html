<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-probe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-probe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1994-1998   Linus Torvalds &amp; authors (see below)</span>
<span class="cm"> *  Copyright (C) 2005, 2007  Bartlomiej Zolnierkiewicz</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Mostly written by Mark Lord &lt;mlord@pobox.com&gt;</span>
<span class="cm"> *                and Gadi Oxman &lt;gadio@netvision.net.il&gt;</span>
<span class="cm"> *                and Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  See linux/MAINTAINERS for address of current maintainer.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the IDE probe module, as evolved from hd.c and ide.c.</span>
<span class="cm"> *</span>
<span class="cm"> * -- increase WAIT_PIDENTIFY to avoid CD-ROM locking at boot</span>
<span class="cm"> *	 by Andrea Arcangeli</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> *	generic_id		-	add a generic drive id</span>
<span class="cm"> *	@drive:	drive to make an ID block for</span>
<span class="cm"> *	</span>
<span class="cm"> *	Add a fake id field to the drive we are passed. This allows</span>
<span class="cm"> *	use to skip a ton of NULL checks (which people always miss) </span>
<span class="cm"> *	and make drive properties unconditional outside of this file</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">generic_id</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_CYLS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">;</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_HEADS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_SECTORS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">]</span>	<span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_disk_init_chs</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Extract geometry if we did not already have one for the drive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">||</span> <span class="o">!</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">||</span> <span class="o">!</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span>  <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_cyl</span>  <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">];</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_head</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">];</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_sect</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Handle logical geometry translation by the drive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_current_chs_valid</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span>  <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_CYLS</span><span class="p">];</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_HEADS</span><span class="p">];</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_SECTORS</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Use physical geometry if what we have still makes no sense */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span>  <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">];</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">];</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_disk_init_mult_count</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_multsect</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAX_MULTSECT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_multsect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">max_multsect</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MULTSECT</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_multsect</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MULTSECT</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1ff</span><span class="p">;</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">mult_req</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MULTSECT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">mult_req</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">special_flags</span> <span class="o">|=</span> <span class="n">IDE_SFLAG_SET_MULTMODE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_classify_ata_dev</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">is_cfa</span> <span class="o">=</span> <span class="n">ata_id_is_cfa</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* CF devices are *not* removable in Linux definition of the term */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_cfa</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)))</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_REMOVABLE</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ide_disk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_id_has_unload</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NO_UNLOAD</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s, %s DISK drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
		<span class="n">is_cfa</span> <span class="o">?</span> <span class="s">&quot;CFA&quot;</span> <span class="o">:</span> <span class="s">&quot;ATA&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_classify_atapi_dev</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s, ATAPI &quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ide_floppy</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;oppy&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;poyp&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ZIP&quot;</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;cdrom or floppy?, assuming &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">ide_cdrom</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;FLOPPY&quot;</span><span class="p">);</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_REMOVABLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Early cdrom models used zero */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">ide_cdrom</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_cdrom</span>:
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_REMOVABLE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC</span>
		<span class="cm">/* kludge for Apple PowerBook internal zip */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ZIP&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;FLOPPY&quot;</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">ide_floppy</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;CD/DVD-ROM&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_tape</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;TAPE&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_optical</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;OPTICAL&quot;</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_REMOVABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;UNKNOWN (type %d)&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="cm">/* an ATAPI device ignores DRDY */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">ready_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_cdb_intr</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">atapi_flags</span> <span class="o">|=</span> <span class="n">IDE_AFLAG_DRQ_INTERRUPT</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_DOORLOCKING</span><span class="p">;</span>
	<span class="cm">/* we don&#39;t do head unloading on ATAPI devices */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NO_UNLOAD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	do_identify	-	identify a drive</span>
<span class="cm"> *	@drive: drive to identify </span>
<span class="cm"> *	@cmd: command used</span>
<span class="cm"> *	@id: buffer for IDENTIFY data</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when we have issued a drive identify command to</span>
<span class="cm"> *	read and parse the results. This function is run with</span>
<span class="cm"> *	interrupts disabled. </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_identify</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bswap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* local CPU only; some systems need this */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* read 512 bytes of id info */</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">input_data</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_ID_READ</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: dumping identify data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ide_dump_identify</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">id</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ide_fix_driveid</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  ATA_CMD_ID_ATA returns little-endian info,</span>
<span class="cm">	 *  ATA_CMD_ID_ATAPI *usually* returns little-endian info.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span><span class="p">)</span> <span class="o">||</span>  <span class="cm">/* NEC */</span>
		    <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="o">||</span>  <span class="cm">/* Mitsumi */</span>
		    <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;i&#39;</span><span class="p">))</span>    <span class="cm">/* Pioneer */</span>
			<span class="cm">/* Vertos drives may still be weird */</span>
			<span class="n">bswap</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_fixstring</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ATA_ID_PROD_LEN</span><span class="p">,</span> <span class="n">bswap</span><span class="p">);</span>
	<span class="n">ide_fixstring</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FW_REV</span><span class="p">],</span> <span class="n">ATA_ID_FW_REV_LEN</span><span class="p">,</span> <span class="n">bswap</span><span class="p">);</span>
	<span class="n">ide_fixstring</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SERNO</span><span class="p">],</span> <span class="n">ATA_ID_SERNO_LEN</span><span class="p">,</span> <span class="n">bswap</span><span class="p">);</span>

	<span class="cm">/* we depend on this a lot! */</span>
	<span class="n">m</span><span class="p">[</span><span class="n">ATA_ID_PROD_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;E X A B Y T E N E S T&quot;</span><span class="p">))</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_dev_read_id	-	send ATA/ATAPI IDENTIFY command</span>
<span class="cm"> *	@drive: drive to identify</span>
<span class="cm"> *	@cmd: command to use</span>
<span class="cm"> *	@id: buffer for IDENTIFY data</span>
<span class="cm"> *	@irq_ctx: flag set when called from the IRQ context</span>
<span class="cm"> *</span>
<span class="cm"> *	Sends an ATA(PI) IDENTIFY request to a drive and waits for a response.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:	0  device was identified</span>
<span class="cm"> *			1  device timed-out (no response to identify request)</span>
<span class="cm"> *			2  device aborted the command (refused to identify itself)</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ide_dev_read_id</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_io_ports</span> <span class="o">*</span><span class="n">io_ports</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_tp_ops</span> <span class="o">*</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_altstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable device IRQ.  Otherwise we&#39;ll get spurious interrupts</span>
<span class="cm">	 * during the identify phase that the IRQ handler isn&#39;t expecting.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_ports</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">)</span>
		<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">write_devctl</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ATA_NIEN</span> <span class="o">|</span> <span class="n">ATA_DEVCTL_OBS</span><span class="p">);</span>

	<span class="cm">/* take a deep breath */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ctx</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_ports</span><span class="o">-&gt;</span><span class="n">ctl_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_BROKEN_ALTSTATUS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_altstatus</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span> <span class="o">^</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ATA_IDX</span><span class="p">)</span>
			<span class="cm">/* ancient Seagate drives, broken interfaces */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: probing with STATUS(0x%02x) &quot;</span>
					 <span class="s">&quot;instead of ALTSTATUS(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* use non-intrusive polling */</span>
			<span class="n">use_altstatus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set features register for atapi</span>
<span class="cm">	 * identify command to be sure of reply</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ide_taskfile</span> <span class="n">tf</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="p">));</span>
		<span class="cm">/* disable DMA &amp; overlap */</span>
		<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">tf_load</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="n">IDE_VALID_FEATURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ask drive for ID */</span>
	<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">exec_command</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">)</span> <span class="o">?</span> <span class="n">WAIT_WORSTCASE</span> <span class="o">:</span> <span class="n">WAIT_PIDENTIFY</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* wait for IRQ and ATA_DRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__ide_wait_stat</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">ATA_DRQ</span><span class="p">,</span> <span class="n">BAD_R_STAT</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_busy_sleep</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">use_altstatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OK_STAT</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ATA_DRQ</span><span class="p">,</span> <span class="n">BAD_R_STAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* drive returned ID */</span>
		<span class="n">do_identify</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="cm">/* drive responded with ID */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* clear drive IRQ */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* drive refused ID */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_busy_sleep</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">altstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>	<span class="cm">/* give drive a breather */</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">altstatus</span> <span class="o">?</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_altstatus</span><span class="p">(</span><span class="n">hwif</span><span class="p">)</span>
				 <span class="o">:</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ATA_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* drive timed-out */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ide_read_device</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_taskfile</span> <span class="n">tf</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">tf_read</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="n">IDE_VALID_DEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	do_probe		-	probe an IDE device</span>
<span class="cm"> *	@drive: drive to probe</span>
<span class="cm"> *	@cmd: command to use</span>
<span class="cm"> *</span>
<span class="cm"> *	do_probe() has the difficult job of finding a drive if it exists,</span>
<span class="cm"> *	without getting hung up if it doesn&#39;t exist, without trampling on</span>
<span class="cm"> *	ethernet cards, and without leaving any IRQs dangling to haunt us later.</span>
<span class="cm"> *</span>
<span class="cm"> *	If a drive is &quot;known&quot; to exist (from CMOS or kernel parameters),</span>
<span class="cm"> *	but does not respond right away, the probe will &quot;hang in there&quot;</span>
<span class="cm"> *	for the maximum wait time (about 30 seconds), otherwise it will</span>
<span class="cm"> *	exit much more quickly.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:	0  device was identified</span>
<span class="cm"> *		1  device timed-out (no response to identify request)</span>
<span class="cm"> *		2  device aborted the command (refused to identify itself)</span>
<span class="cm"> *		3  bad status from device (possible for ATAPI drives)</span>
<span class="cm"> *		4  probe was not attempted because failure was obvious</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_probe</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_tp_ops</span> <span class="o">*</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">present</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">),</span> <span class="n">stat</span><span class="p">;</span>

	<span class="cm">/* avoid waiting for inappropriate probes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">present</span> <span class="o">&amp;&amp;</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">!=</span> <span class="n">ide_disk</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;probing for %s: present=%d, media=%d, probetype=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">present</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">,</span>
		<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ATA&quot;</span> <span class="o">:</span> <span class="s">&quot;ATAPI&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* needed for some systems</span>
<span class="cm">	 * (e.g. crw9624 as drive0 with disk as slave)</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">dev_select</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_read_device</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">!=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">select</span> <span class="o">&amp;&amp;</span> <span class="n">present</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* exit with drive0 selected */</span>
			<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">dev_select</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="cm">/* allow ATA_BUSY to assert &amp; clear */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* no i/f present: mmm.. this should be a 4 -ml */</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OK_STAT</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">ATA_DRDY</span><span class="p">,</span> <span class="n">ATA_BUSY</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">present</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_dev_read_id</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="cm">/* failed: try again */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_dev_read_id</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRDY</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no response (status = 0x%02x), &quot;</span>
					<span class="s">&quot;resetting drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">dev_select</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">exec_command</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ATA_CMD_DEV_RESET</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ide_busy_sleep</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">WAIT_WORSTCASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_dev_read_id</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* ensure drive IRQ is clear */</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no response (status = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* not present or maybe ATAPI */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* exit with drive0 selected */</span>
		<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">dev_select</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="cm">/* ensure drive irq is clear */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	probe_for_drives	-	upper level drive probe</span>
<span class="cm"> *	@drive: drive to probe for</span>
<span class="cm"> *</span>
<span class="cm"> *	probe_for_drive() tests for existence of a given drive using do_probe()</span>
<span class="cm"> *	and presents things to the user as needed.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:	0  no device was found</span>
<span class="cm"> *			1  device was found</span>
<span class="cm"> *			   (note: IDE_DFLAG_PRESENT might still be not set)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">probe_for_drive</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_ID_READ</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">);</span>

	<span class="cm">/* skip probing? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_NOPROBE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if !(success||timed-out) */</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_probe</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* look for ATAPI device */</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">do_probe</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* identification failed? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_ID_READ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_disk</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: non-IDE drive, CHS=%d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_cdrom</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: ATAPI cdrom (?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* nuke it */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown device on bus refused identification. Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">)</span>
				<span class="n">ide_classify_atapi_dev</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ide_classify_ata_dev</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The drive wasn&#39;t being helpful. Add generic info only */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_ID_READ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">generic_id</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_disk_init_chs</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">ide_disk_init_mult_count</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwif_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ide_hwif_t</span><span class="p">,</span> <span class="n">gendev</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev_rel_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_register_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* register with global device tree */</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">,</span> <span class="n">hwif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">hwif_release_dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IDE: %s: device_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">portdev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">ide_port_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">,</span>
				      <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">portdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">portdev</span><span class="p">);</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_port_wait_ready	-	wait for port to become ready</span>
<span class="cm"> *	@hwif: IDE port</span>
<span class="cm"> *</span>
<span class="cm"> *	This is needed on some PPCs and a bunch of BIOS-less embedded</span>
<span class="cm"> *	platforms.  Typical cases are:</span>
<span class="cm"> *</span>
<span class="cm"> *	- The firmware hard reset the disk before booting the kernel,</span>
<span class="cm"> *	  the drive is still doing it&#39;s poweron-reset sequence, that</span>
<span class="cm"> *	  can take up to 30 seconds.</span>
<span class="cm"> *</span>
<span class="cm"> *	- The firmware does nothing (or no firmware), the device is</span>
<span class="cm"> *	  still in POST state (same as above actually).</span>
<span class="cm"> *</span>
<span class="cm"> *	- Some CD/DVD/Writer combo drives tend to drive the bus during</span>
<span class="cm"> *	  their reset sequence even when they are non-selected slave</span>
<span class="cm"> *	  devices, thus preventing discovery of the main HD.</span>
<span class="cm"> *</span>
<span class="cm"> *	Doing this wait-for-non-busy should not harm any existing</span>
<span class="cm"> *	configuration and fix some issues like the above.</span>
<span class="cm"> *</span>
<span class="cm"> *	BenH.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 on success, error code (&lt; 0) otherwise.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_port_wait_ready</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_tp_ops</span> <span class="o">*</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="p">;</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Probing IDE interface %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Let HW settle down a bit from whatever init state we</span>
<span class="cm">	 * come from */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Wait for BSY bit to go away, spec timeout is 30 seconds,</span>
<span class="cm">	 * I know of at least one disk who takes 31 seconds, I use 35</span>
<span class="cm">	 * here to be safe</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_wait_not_busy</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="mi">35000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Now make sure both master &amp; slave are ready */</span>
	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ignore disks that we will not probe for later. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_NOPROBE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">dev_select</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">write_devctl</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ATA_DEVCTL_OBS</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_wait_not_busy</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="mi">35000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ide_wait_not_busy() skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="cm">/* Exit function with master reselected (let&#39;s be sane) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">dev_select</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_undecoded_slave	-	look for bad CF adapters</span>
<span class="cm"> *	@dev1: slave device</span>
<span class="cm"> *</span>
<span class="cm"> *	Analyse the drives on the interface and attempt to decide if we</span>
<span class="cm"> *	have the same drive viewed twice. This occurs with crap CF adapters</span>
<span class="cm"> *	and PCMCIA sometimes.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ide_undecoded_slave</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">dev1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">dev0</span> <span class="o">=</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev0</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If the models don&#39;t match they are not the same product */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev0</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">],</span>
		   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">]))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Serial numbers do not match */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev0</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SERNO</span><span class="p">],</span>
		    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SERNO</span><span class="p">],</span> <span class="n">ATA_ID_SERNO_LEN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* No serial number, thankfully very rare for CF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev0</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SERNO</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Appears to be an IDE flash adapter with decode bugs */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ide-probe: ignoring undecoded slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_undecoded_slave</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_probe_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_NOPROBE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_NOPROBE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must always disable IRQ, as probe_for_drive will assert IRQ, but</span>
<span class="cm">	 * we&#39;ll install our IRQ driver much later...</span>
<span class="cm">	 */</span>
	<span class="n">irqd</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqd</span><span class="p">)</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_port_wait_ready</span><span class="p">(</span><span class="n">hwif</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Wait for ready failed before probe !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Second drive should only exist if first drive was found,</span>
<span class="cm">	 * but a lot of cdrom drives are configured as single slaves.</span>
<span class="cm">	 */</span>
	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">probe_for_drive</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use cached IRQ number. It might be (and is...) changed by probe</span>
<span class="cm">	 * code above</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqd</span><span class="p">)</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">irqd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_port_tune_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_check_nien_quirk_list</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">&amp;&amp;</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">quirkproc</span><span class="p">)</span>
			<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">quirkproc</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_set_max_pio</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NICE1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="p">)</span>
			<span class="n">ide_set_dma</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init request queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_init_queue</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sg_entries</span> <span class="o">=</span> <span class="n">PRD_ENTRIES</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Our default set up assumes the normal IDE case,</span>
<span class="cm">	 *	that is 64K segmenting, standard PRD setup</span>
<span class="cm">	 *	and LBA28. Some drivers then impose their own</span>
<span class="cm">	 *	limits and LBA48 we could raise it but as yet</span>
<span class="cm">	 *	do not.</span>
<span class="cm">	 */</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_init_queue_node</span><span class="p">(</span><span class="n">do_ide_request</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hwif_to_node</span><span class="p">(</span><span class="n">hwif</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">blk_queue_segment_boundary</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rqsize</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">)</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rqsize</span><span class="p">;</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* When we have an IOMMU, we may have a problem where pci_map_sg()</span>
<span class="cm">	 * creates segments that don&#39;t completely match our boundary</span>
<span class="cm">	 * requirements and thus need to be broken up again. Because it</span>
<span class="cm">	 * doesn&#39;t align properly either, we may actually have to break up</span>
<span class="cm">	 * to more segments than what was we got in the first place, a max</span>
<span class="cm">	 * worst case is twice as many.</span>
<span class="cm">	 * This will be fixed once we teach pci_map_sg() about our boundary</span>
<span class="cm">	 * requirements, hopefully soon. *FIXME*</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PCI_DMA_BUS_IS_PHYS</span><span class="p">)</span>
		<span class="n">max_sg_entries</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">max_sg_entries</span><span class="p">);</span>

	<span class="cm">/* assign drive queue */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>

	<span class="cm">/* needs drive-&gt;queue to be set */</span>
	<span class="n">ide_toggle_bounce</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * For any present drive:</span>
<span class="cm"> * - allocate the block device queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_port_setup_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ide_init_queue</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ide: failed to init %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_host_enable_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* clear any pending IRQs */</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="cm">/* unmask IRQs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">)</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="o">-&gt;</span><span class="n">write_devctl</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">ATA_DEVCTL_OBS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine sets up the IRQ for an IDE interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_irq</span> <span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_io_ports</span> <span class="o">*</span><span class="n">io_ports</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">irq_handler</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_handler</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">irq_handler</span> <span class="o">=</span> <span class="n">ide_intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq_handler</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hwif</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_up</span><span class="p">;</span>

<span class="cp">#if !defined(__mc68000__)</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s at 0x%03lx-0x%03lx,0x%03lx on irq %d&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">io_ports</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span> <span class="n">io_ports</span><span class="o">-&gt;</span><span class="n">status_addr</span><span class="p">,</span>
		<span class="n">io_ports</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s at 0x%08lx on irq %d&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">io_ports</span><span class="o">-&gt;</span><span class="n">data_addr</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* __mc68000__ */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_SERIALIZE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; (serialized)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_up:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_lock</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: we want to pin hwif down */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="nf">ata_probe</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span> <span class="o">=</span> <span class="o">*</span><span class="n">part</span> <span class="o">&gt;&gt;</span> <span class="n">PARTN_BITS</span><span class="p">;</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">unit</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_disk</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;ide-disk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_cdrom</span> <span class="o">||</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_optical</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;ide-cd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_tape</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;ide-tape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">==</span> <span class="n">ide_floppy</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;ide-floppy&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="nf">exact_match</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="o">*</span><span class="n">part</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PARTN_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exact_lock</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_disk</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_register_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_register_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="p">),</span>
			    <span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">exact_match</span><span class="p">,</span> <span class="n">exact_lock</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_register_region</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_unregister_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_unregister_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="p">),</span>
			      <span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_unregister_region</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_init_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">&lt;&lt;</span> <span class="n">PARTN_BITS</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;hd%c&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span> <span class="o">+</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_init_disk</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drive_release_dev</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ide_drive_t</span><span class="p">,</span> <span class="n">gendev</span><span class="p">);</span>

	<span class="n">ide_proc_unregister_device</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev_rel_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwif_init</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: disabled, no IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_max_nents</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_max_nents</span> <span class="o">=</span> <span class="n">PRD_ENTRIES</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">)</span><span class="o">*</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_max_nents</span><span class="p">,</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to allocate SG table.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_max_nents</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">init_irq</span><span class="p">(</span><span class="n">hwif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: disabled, unable to get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blk_register_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MAX_DRIVES</span> <span class="o">&lt;&lt;</span> <span class="n">PARTN_BITS</span><span class="p">,</span>
			    <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="n">ata_probe</span><span class="p">,</span> <span class="n">ata_lock</span><span class="p">,</span> <span class="n">hwif</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwif_register_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%u.%u&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_bus_type</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">drive_release_dev</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IDE: %s: device_register error: &quot;</span>
					    <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_port_init_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dn</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_IO_32BIT</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">io_32bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_IO_32BIT</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NO_IO_32BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_UNMASK_IRQS</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_UNMASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_UNMASK_IRQS</span><span class="p">)</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NO_UNMASK</span><span class="p">;</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">&amp;&amp;</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">init_dev</span><span class="p">)</span>
			<span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">init_dev</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_init_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">?</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">:</span> <span class="n">ide_pci</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">init_iops</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">init_iops</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="cm">/* -&gt;host_flags may be set by -&gt;init_iops (or even earlier...) */</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">|=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pio_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">tp_ops</span><span class="p">;</span>

	<span class="cm">/* -&gt;set_pio_mode for DTC2278 is currently limited to port 0 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_DTC2278</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">swdma_mask</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swdma_mask</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">ultra_mask</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">udma_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_DMA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">init_dma</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">init_dma</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_hwif_setup_dma</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: DMA disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">swdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">ultra_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_SERIALIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_SERIALIZE_DMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">))</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">|=</span> <span class="n">IDE_HFLAG_SERIALIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">max_sectors</span><span class="p">)</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rqsize</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">max_sectors</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_LBA48</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NO_LBA48_DMA</span><span class="p">))</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rqsize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">rqsize</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* call chipset specific routine for each enabled port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">init_hwif</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">init_hwif</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_port_cable_detect</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_ops</span> <span class="o">*</span><span class="n">port_ops</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_ops</span> <span class="o">&amp;&amp;</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">cable_detect</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">ultra_mask</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cbl</span> <span class="o">!=</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">)</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cbl</span> <span class="o">=</span> <span class="n">port_ops</span><span class="o">-&gt;</span><span class="n">cable_detect</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ide_hwif_to_major</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="n">IDE0_MAJOR</span><span class="p">,</span> <span class="n">IDE1_MAJOR</span><span class="p">,</span> <span class="n">IDE2_MAJOR</span><span class="p">,</span> <span class="n">IDE3_MAJOR</span><span class="p">,</span> <span class="n">IDE4_MAJOR</span><span class="p">,</span>
	  <span class="n">IDE5_MAJOR</span><span class="p">,</span> <span class="n">IDE6_MAJOR</span><span class="p">,</span> <span class="n">IDE7_MAJOR</span><span class="p">,</span> <span class="n">IDE8_MAJOR</span><span class="p">,</span> <span class="n">IDE9_MAJOR</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_port_init_devices_data</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">saved_id</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drive</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">saved_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">saved_id</span><span class="p">;</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span>			<span class="o">=</span> <span class="n">ide_disk</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">select</span>			<span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATA_DEVICE_OBS</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span>			<span class="o">=</span> <span class="n">hwif</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">ready_stat</span>		<span class="o">=</span> <span class="n">ATA_DRDY</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">bad_wstat</span>		<span class="o">=</span> <span class="n">BAD_W_STAT</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">special_flags</span>		<span class="o">=</span> <span class="n">IDE_SFLAG_RECALIBRATE</span> <span class="o">|</span>
						  <span class="n">IDE_SFLAG_SET_GEOMETRY</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>			<span class="o">=</span> <span class="sc">&#39;h&#39;</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>			<span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>			<span class="o">=</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">max_failures</span>		<span class="o">=</span> <span class="n">IDE_DEFAULT_MAX_FAILURES</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev_rel_comp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_init_port_data</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* fill in any non-zero initial values */</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span>	<span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span>	<span class="o">=</span> <span class="n">ide_hwif_to_major</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="sc">&#39;i&#39;</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ide_timer_expiry</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hwif</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev_rel_comp</span><span class="p">);</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">tp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_tp_ops</span><span class="p">;</span>

	<span class="n">ide_port_init_devices_data</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_init_port_hw</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">io_ports</span><span class="p">));</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">?</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">:</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">config_data</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_indexes</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_find_port_slot	-	find free port slot</span>
<span class="cm"> *	@d: IDE port info</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the new port slot index or -ENOENT if we are out of free slots.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_find_port_slot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bootable</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_NON_BOOTABLE</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_QD_2ND_PORT</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Claim an unassigned slot.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Give preference to claiming other slots before claiming ide0/ide1,</span>
<span class="cm">	 * just in case there&#39;s another interface yet-to-be-scanned</span>
<span class="cm">	 * which uses ports 0x1f0/0x170 (the ide0/ide1 defaults).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unless there is a bootable card that does not use the standard</span>
<span class="cm">	 * ports 0x1f0/0x170 (the ide0/ide1 defaults).</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bootable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ide_indexes</span> <span class="o">|</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_HWIFS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">ide_indexes</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ide_indexes</span> <span class="o">|</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_HWIFS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">ide_indexes</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ide_indexes</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">ide_indexes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ide_indexes</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_free_port_slot</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
	<span class="n">ide_indexes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_port_free_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_port_alloc_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DRIVES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>

		<span class="n">drive</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drive</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * In order to keep things simple we have an id</span>
<span class="cm">		 * block for all drives at all times. If the device</span>
<span class="cm">		 * is pre ATA or refuses ATA/ATAPI identify we</span>
<span class="cm">		 * will add faked data to this.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Also note that 0 everywhere means &quot;can&#39;t do X&quot;</span>
<span class="cm">		 */</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="n">SECTOR_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_nomem:</span>
	<span class="n">ide_port_free_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="nf">ide_host_alloc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">**</span><span class="n">hws</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_ports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">hws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">node</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">?</span> <span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hwif</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hwif</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ide_port_alloc_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">ide_find_port_slot</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no free slot for interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">d</span> <span class="o">?</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;ide&quot;</span><span class="p">);</span>
			<span class="n">ide_port_free_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ide_init_port_data</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hwif</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">init_chipset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">init_chipset</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">get_lock</span>     <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">get_lock</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">release_lock</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">release_lock</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">host_flags</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">host</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_host_alloc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_port_free</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_port_free_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">ide_free_port_slot</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_disable_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: disabling port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HOST_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ide_port_free</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ide_host_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">**</span><span class="n">hws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">,</span> <span class="o">*</span><span class="n">mate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ide_init_port_hw</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">hws</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ide_port_apply_params</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mate</span> <span class="o">=</span> <span class="n">mate</span><span class="p">;</span>
			<span class="n">mate</span><span class="o">-&gt;</span><span class="n">mate</span> <span class="o">=</span> <span class="n">hwif</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mate</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">hwif</span><span class="p">;</span>

		<span class="n">ide_init_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">,</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
		<span class="n">ide_port_cable_detect</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_flags</span> <span class="o">|=</span> <span class="n">IDE_PFLAG_PROBING</span><span class="p">;</span>

		<span class="n">ide_port_init_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ide_probe_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_PFLAG_PROBING</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">IDE_HFLAG_4DRIVES</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mate</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mate</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ide_register_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ide_disable_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
			<span class="n">ide_port_tune_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ide_host_enable_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif_init</span><span class="p">(</span><span class="n">hwif</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: failed to initialize IDE &quot;</span>
					 <span class="s">&quot;interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
			<span class="n">ide_disable_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ide_port_setup_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">j</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ide_acpi_init_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
			<span class="n">ide_acpi_port_init_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ide_sysfs_register_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
		<span class="n">ide_proc_register_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ide_proc_port_register_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
			<span class="n">hwif_register_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">j</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_host_register</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ide_host_add</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ide_port_info</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_hw</span> <span class="o">**</span><span class="n">hws</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_ports</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_host</span> <span class="o">**</span><span class="n">hostp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">ide_host_alloc</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">hws</span><span class="p">,</span> <span class="n">n_ports</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_host_register</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">hws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_host_free</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hostp</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_host_add</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ide_port_unregister_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_present_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev_rel_comp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_port_unregister_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
	<span class="n">__ide_port_unregister_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ide_port_init_devices_data</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_port_unregister_devices</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_unregister		-	free an IDE interface</span>
<span class="cm"> *	@hwif: IDE interface</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform the final unregister of an IDE interface.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking:</span>
<span class="cm"> *	The caller must not hold the IDE locks.</span>
<span class="cm"> *</span>
<span class="cm"> *	It is up to the caller to be sure there is no pending I/O here,</span>
<span class="cm"> *	and that the interface will not be reopened (present/vanishing</span>
<span class="cm"> *	locking isn&#39;t yet done BTW).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_unregister</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ide_port_unregister_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_proc_unregister_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hwif</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">portdev</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">gendev_rel_comp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove us from the kernel&#39;s knowledge</span>
<span class="cm">	 */</span>
	<span class="n">blk_unregister_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MAX_DRIVES</span><span class="o">&lt;&lt;</span><span class="n">PARTN_BITS</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ide_release_dma_engine</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_cfg_mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_host_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="p">)</span>
			<span class="n">ide_port_free</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_host_free</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_host_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_host_for_each_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hwif</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="p">)</span>
			<span class="n">ide_unregister</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ide_host_free</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_host_remove</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_port_scan</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ide_port_apply_params</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">ide_port_cable_detect</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_flags</span> <span class="o">|=</span> <span class="n">IDE_PFLAG_PROBING</span><span class="p">;</span>

	<span class="n">ide_port_init_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_probe_port</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">port_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDE_PFLAG_PROBING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ide_port_tune_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">ide_port_setup_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">ide_acpi_port_init_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">hwif_register_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
	<span class="n">ide_proc_port_register_devices</span><span class="p">(</span><span class="n">hwif</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_port_scan</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
