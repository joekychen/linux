<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide-proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide-proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1997-1998	Mark Lord</span>
<span class="cm"> *  Copyright (C) 2003		Red Hat</span>
<span class="cm"> *</span>
<span class="cm"> *  Some code was moved here from ide.c, see it for original copyrights.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This is the /proc/ide/ filesystem implementation.</span>
<span class="cm"> *</span>
<span class="cm"> * Drive/Driver settings can be retrieved by reading the drive&#39;s</span>
<span class="cm"> * &quot;settings&quot; files.  e.g.    &quot;cat /proc/ide0/hda/settings&quot;</span>
<span class="cm"> * To write a new value &quot;val&quot; into a specific setting &quot;name&quot;, use:</span>
<span class="cm"> *   echo &quot;name:val&quot; &gt;/proc/ide/ide0/hda/settings</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_ide_root</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_imodel_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span>	<span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ide_generic</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;generic&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_pci</span>:		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_cmd640</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmd640&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_dtc2278</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dtc2278&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_ali14xx</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ali14xx&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_qd65xx</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qd65xx&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_umc8672</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;umc8672&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_ht6560b</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ht6560b&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_4drives</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4drives&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_pmac</span>:		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mac-io&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_au1xxx</span>:	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;au1xxx&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_palm3710</span>:      <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;palm3710&quot;</span><span class="p">;</span>      <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_acorn</span>:		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;acorn&quot;</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_imodel_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_imodel_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_imodel_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_imodel_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_mate_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span>	<span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span> <span class="o">&amp;&amp;</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mate</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">mate</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;(none)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_mate_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_mate_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_mate_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_mate_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_channel_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_hwif_t</span>	<span class="o">*</span><span class="n">hwif</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_channel_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_channel_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_channel_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_channel_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_identify_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SECTOR_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">taskfile_lib_get_identify</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SECTOR_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%04x%c&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					<span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">?</span> <span class="sc">&#39;\n&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_identify_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_identify_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_identify_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_identify_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_find_setting	-	find a specific setting</span>
<span class="cm"> *	@st: setting table pointer</span>
<span class="cm"> *	@name: setting name</span>
<span class="cm"> *</span>
<span class="cm"> *	Scan&#39;s the setting table for a matching entry and returns</span>
<span class="cm"> *	this or NULL if no entry is found. The caller must hold the</span>
<span class="cm"> *	setting semaphore</span>
<span class="cm"> */</span>

<span class="k">static</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="nf">ide_find_setting</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span>
					       <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">st</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">st</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_read_setting	-	read an IDE setting</span>
<span class="cm"> *	@drive: drive to read from</span>
<span class="cm"> *	@setting: drive setting</span>
<span class="cm"> *</span>
<span class="cm"> *	Read a drive setting and return the value. The caller</span>
<span class="cm"> *	must hold the ide_setting_mtx when making this call.</span>
<span class="cm"> *</span>
<span class="cm"> *	BUGS: the data return and error are the same return value</span>
<span class="cm"> *	so an error -EINVAL and true return of the same value cannot</span>
<span class="cm"> *	be told apart</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_read_setting</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_devset</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_write_setting	-	read an IDE setting</span>
<span class="cm"> *	@drive: drive to read from</span>
<span class="cm"> *	@setting: drive setting</span>
<span class="cm"> *	@val: value</span>
<span class="cm"> *</span>
<span class="cm"> *	Write a drive setting if it is possible. The caller</span>
<span class="cm"> *	must hold the ide_setting_mtx when making this call.</span>
<span class="cm"> *</span>
<span class="cm"> *	BUGS: the data return and error are the same return value</span>
<span class="cm"> *	so an error -EINVAL and true return of the same value cannot</span>
<span class="cm"> *	be told apart</span>
<span class="cm"> *</span>
<span class="cm"> *	FIXME:  This should be changed to enqueue a special request</span>
<span class="cm"> *	to the driver to change settings, and then wait on a sema for completion.</span>
<span class="cm"> *	The current scheme of polling is kludgy, though safe enough.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_write_setting</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="n">setting</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_devset</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DS_SYNC</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ide_devset_execute</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ide_devset_get</span><span class="p">(</span><span class="n">xfer_rate</span><span class="p">,</span> <span class="n">current_speed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_xfer_rate</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_cmd</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">XFER_PIO_0</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">&gt;</span> <span class="n">XFER_UDMA_6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_SET_FEATURES</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">SETFEATURES_XFER</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">tf</span><span class="p">.</span><span class="n">nsect</span>   <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">tf</span> <span class="o">=</span> <span class="n">IDE_VALID_FEATURE</span> <span class="o">|</span> <span class="n">IDE_VALID_NSECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">tf</span>  <span class="o">=</span> <span class="n">IDE_VALID_NSECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">tf_flags</span>   <span class="o">=</span> <span class="n">IDE_TFLAG_SET_XFER</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ide_no_data_taskfile</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ide_devset_rw</span><span class="p">(</span><span class="n">current_speed</span><span class="p">,</span> <span class="n">xfer_rate</span><span class="p">);</span>
<span class="n">ide_devset_rw_field</span><span class="p">(</span><span class="n">init_speed</span><span class="p">,</span> <span class="n">init_speed</span><span class="p">);</span>
<span class="n">ide_devset_rw_flag</span><span class="p">(</span><span class="n">nice1</span><span class="p">,</span> <span class="n">IDE_DFLAG_NICE1</span><span class="p">);</span>
<span class="n">ide_devset_rw_field</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">dn</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="n">ide_generic_settings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">current_speed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">init_speed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">io_32bit</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">SUPPORT_VLB_SYNC</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">keepsettings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">nice1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">unmaskirq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">IDE_PROC_DEVSET</span><span class="p">(</span><span class="n">using_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_ide_settings_warn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning: /proc/ide/hd?/settings interface is &quot;</span>
			    <span class="s">&quot;obsolete, and will be removed soon!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_settings_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="n">setting</span><span class="p">,</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_devset</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="n">ide_drive_t</span>	<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rc</span><span class="p">,</span> <span class="n">mul_factor</span><span class="p">,</span> <span class="n">div_factor</span><span class="p">;</span>

	<span class="n">proc_ide_settings_warn</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
	<span class="n">g</span> <span class="o">=</span> <span class="n">ide_generic_settings</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;name</span><span class="se">\t\t\t</span><span class="s">value</span><span class="se">\t\t</span><span class="s">min</span><span class="se">\t\t</span><span class="s">max</span><span class="se">\t\t</span><span class="s">mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;----</span><span class="se">\t\t\t</span><span class="s">-----</span><span class="se">\t\t</span><span class="s">---</span><span class="se">\t\t</span><span class="s">---</span><span class="se">\t\t</span><span class="s">----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* read settings in the alphabetical order */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">d</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">setting</span> <span class="o">=</span> <span class="n">g</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setting</span> <span class="o">=</span> <span class="n">d</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">setting</span> <span class="o">=</span> <span class="n">g</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mul_factor</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">mulf</span> <span class="o">?</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">mulf</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">div_factor</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">divf</span> <span class="o">?</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">divf</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-24s&quot;</span><span class="p">,</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ide_read_setting</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16d&quot;</span><span class="p">,</span> <span class="n">rc</span> <span class="o">*</span> <span class="n">mul_factor</span> <span class="o">/</span> <span class="n">div_factor</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s&quot;</span><span class="p">,</span> <span class="s">&quot;write-only&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16d%-16d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">*</span> <span class="n">mul_factor</span> <span class="o">+</span> <span class="n">div_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_factor</span><span class="p">,</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">*</span> <span class="n">mul_factor</span> <span class="o">/</span> <span class="n">div_factor</span><span class="p">);</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_settings_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_settings_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_LEN	30</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ide_settings_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span>	<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="n">MAX_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">for_real</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mul_factor</span><span class="p">,</span> <span class="n">div_factor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">n</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">ide_proc_devset</span> <span class="o">*</span><span class="n">setting</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">proc_ide_settings_warn</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Skip over leading whitespace</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">count</span><span class="p">;</span>
		<span class="o">++</span><span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do one full pass to verify all parameters,</span>
<span class="cm">	 * then do another to actually write the new settings.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">val</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">n</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="n">MAX_LEN</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">);</span>
			<span class="n">name</span><span class="p">[</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">n</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="n">q</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">n</span><span class="p">;</span>
				<span class="o">++</span><span class="n">p</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
			<span class="cm">/* generic settings first, then driver specific ones */</span>
			<span class="n">setting</span> <span class="o">=</span> <span class="n">ide_find_setting</span><span class="p">(</span><span class="n">ide_generic_settings</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setting</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">)</span>
					<span class="n">setting</span> <span class="o">=</span> <span class="n">ide_find_setting</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setting</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">for_real</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mul_factor</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">mulf</span> <span class="o">?</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">mulf</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">div_factor</span> <span class="o">=</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">divf</span> <span class="o">?</span> <span class="n">setting</span><span class="o">-&gt;</span><span class="n">divf</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ide_write_setting</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">val</span> <span class="o">*</span> <span class="n">div_factor</span> <span class="o">/</span> <span class="n">mul_factor</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">for_real</span><span class="o">++</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">parse_error:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(): parse error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_settings_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_settings_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ide_settings_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_capacity_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="mh">0x7fffffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_capacity_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_capacity_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_capacity_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_capacity_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_capacity_proc_fops</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_geometry_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span>	<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;physical     %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;logical      %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_cyl</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_head</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_sect</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_geometry_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_geometry_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_geometry_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_geometry_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ide_geometry_proc_fops</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_dmodel_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span>	<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%.40s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">m</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_dmodel_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_dmodel_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_dmodel_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_dmodel_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_driver_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span>		<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_driver</span>	<span class="o">*</span><span class="n">ide_drv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_drv</span> <span class="o">=</span> <span class="n">to_ide_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ide_drv</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ide-default version 0.9.newide</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_driver_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_driver_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_replace_subdriver</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">device_release_driver</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* FIXME: device can still be in use by previous driver */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_req</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_req</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IDE: %s: device_attach error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">driver_req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;IDE: %s: device_attach(2) error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">driver</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ide_driver_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span>	<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">name</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_replace_subdriver</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_driver_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_driver_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ide_driver_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_media_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span>	<span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">media</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ide_disk</span>:		<span class="n">media</span> <span class="o">=</span> <span class="s">&quot;disk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_cdrom</span>:		<span class="n">media</span> <span class="o">=</span> <span class="s">&quot;cdrom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_tape</span>:		<span class="n">media</span> <span class="o">=</span> <span class="s">&quot;tape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_floppy</span>:	<span class="n">media</span> <span class="o">=</span> <span class="s">&quot;floppy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ide_optical</span>:	<span class="n">media</span> <span class="o">=</span> <span class="s">&quot;optical</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="n">media</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">media</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_media_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ide_media_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_media_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_media_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ide_proc_entry_t</span> <span class="n">generic_drive_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;driver&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>	 <span class="o">&amp;</span><span class="n">ide_driver_proc_fops</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;identify&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUSR</span><span class="p">,</span>	 <span class="o">&amp;</span><span class="n">ide_identify_proc_fops</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;media&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>	 <span class="o">&amp;</span><span class="n">ide_media_proc_fops</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;model&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>	 <span class="o">&amp;</span><span class="n">ide_dmodel_proc_fops</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;settings&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUSR</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ide_settings_proc_fops</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_add_proc_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="n">ide_proc_entry_t</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">proc_fops</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_remove_proc_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="n">ide_proc_entry_t</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_proc_register_driver</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">settings</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">proc_devsets</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>

	<span class="n">ide_add_proc_entries</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">proc_entries</span><span class="p">(</span><span class="n">drive</span><span class="p">),</span> <span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ide_proc_register_driver</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ide_proc_unregister_driver	-	remove driver specific data</span>
<span class="cm"> *	@drive: drive</span>
<span class="cm"> *	@driver: driver</span>
<span class="cm"> *</span>
<span class="cm"> *	Clean up the driver specific /proc files and IDE settings</span>
<span class="cm"> *	for a given drive.</span>
<span class="cm"> *</span>
<span class="cm"> *	Takes ide_setting_mtx.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ide_proc_unregister_driver</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ide_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_remove_proc_entries</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">proc_entries</span><span class="p">(</span><span class="n">drive</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * ide_setting_mtx protects both the settings list and the use</span>
<span class="cm">	 * of settings (we cannot take a setting out that is being used).</span>
<span class="cm">	 */</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">settings</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_setting_mtx</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ide_proc_unregister_driver</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_proc_port_register_devices</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">;</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span>
			<span class="n">ide_add_proc_entries</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span> <span class="n">generic_drive_entries</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ide%d/%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">proc_symlink</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">proc_ide_root</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_proc_unregister_device</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_remove_proc_entries</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span> <span class="n">generic_drive_entries</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">proc_ide_root</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ide_proc_entry_t</span> <span class="n">hwif_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;channel&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ide_channel_proc_fops</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mate&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ide_mate_proc_fops</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;model&quot;</span><span class="p">,</span>	<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ide_imodel_proc_fops</span>	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ide_proc_register_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">proc_ide_root</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ide_add_proc_entries</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span> <span class="n">hwif_entries</span><span class="p">,</span> <span class="n">hwif</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ide_proc_unregister_port</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ide_remove_proc_entries</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span> <span class="n">hwif_entries</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">proc_ide_root</span><span class="p">);</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_print_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ide_driver</span> <span class="o">*</span><span class="n">ide_drv</span> <span class="o">=</span> <span class="n">to_ide_driver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ide_drv</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_drivers_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bus_for_each_drv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">proc_print_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IDE: %s: bus_for_each_drv error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_drivers_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ide_drivers_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ide_drivers_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ide_drivers_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">proc_ide_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_ide_root</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;ide&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_ide_root</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;drivers&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">proc_ide_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ide_drivers_operations</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">proc_ide_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;drivers&quot;</span><span class="p">,</span> <span class="n">proc_ide_root</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;ide&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
