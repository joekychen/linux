<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ide › ide.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ide.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1994-1998	    Linus Torvalds &amp; authors (see below)</span>
<span class="cm"> *  Copyright (C) 2003-2005, 2007   Bartlomiej Zolnierkiewicz</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Mostly written by Mark Lord  &lt;mlord@pobox.com&gt;</span>
<span class="cm"> *                and Gadi Oxman &lt;gadio@netvision.net.il&gt;</span>
<span class="cm"> *                and Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  See linux/MAINTAINERS for address of current maintainer.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the multiple IDE interface driver, as evolved from hd.c.</span>
<span class="cm"> * It supports up to MAX_HWIFS IDE interfaces, on one or more IRQs</span>
<span class="cm"> *   (usually 14 &amp; 15).</span>
<span class="cm"> * There can be up to two drives per interface, as per the ATA-2 spec.</span>
<span class="cm"> *</span>
<span class="cm"> * ...</span>
<span class="cm"> *</span>
<span class="cm"> *  From hd.c:</span>
<span class="cm"> *  |</span>
<span class="cm"> *  | It traverses the request-list, using interrupts to jump between functions.</span>
<span class="cm"> *  | As nearly all functions can be called within interrupts, we may not sleep.</span>
<span class="cm"> *  | Special care is recommended.  Have Fun!</span>
<span class="cm"> *  |</span>
<span class="cm"> *  | modified by Drew Eckhardt to check nr of hd&#39;s from the CMOS.</span>
<span class="cm"> *  |</span>
<span class="cm"> *  | Thanks to Branko Lankester, lankeste@fwi.uva.nl, who found a bug</span>
<span class="cm"> *  | in the early extended-partition checks and added DM partitions.</span>
<span class="cm"> *  |</span>
<span class="cm"> *  | Early work on error handling by Mika Liljeberg (liljeber@cs.Helsinki.FI).</span>
<span class="cm"> *  |</span>
<span class="cm"> *  | IRQ-unmask, drive-id, multiple-mode, support for &quot;&gt;16 heads&quot;,</span>
<span class="cm"> *  | and general streamlining by Mark Lord (mlord@pobox.com).</span>
<span class="cm"> *</span>
<span class="cm"> *  October, 1994 -- Complete line-by-line overhaul for linux 1.1.x, by:</span>
<span class="cm"> *</span>
<span class="cm"> *	Mark Lord	(mlord@pobox.com)		(IDE Perf.Pkg)</span>
<span class="cm"> *	Delman Lee	(delman@ieee.org)		(&quot;Mr. atdisk2&quot;)</span>
<span class="cm"> *	Scott Snyder	(snyder@fnald0.fnal.gov)	(ATAPI IDE cd-rom)</span>
<span class="cm"> *</span>
<span class="cm"> *  This was a rewrite of just about everything from hd.c, though some original</span>
<span class="cm"> *  code is still sprinkled about.  Think of it as a major evolution, with</span>
<span class="cm"> *  inspiration from lots of linux users, esp.  hamish@zot.apana.org.au</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/ide.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>

<span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">ide_port_class</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ide_device_get	-	get an additional reference to a ide_drive_t</span>
<span class="cm"> * @drive:	device to get a reference to</span>
<span class="cm"> *</span>
<span class="cm"> * Gets a reference to the ide_drive_t and increments the use count of the</span>
<span class="cm"> * underlying LLDD module.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ide_device_get</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">host_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">host_dev</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">module</span> <span class="o">=</span> <span class="n">host_dev</span> <span class="o">?</span> <span class="n">host_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">module</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">module</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_device_get</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ide_device_put	-	release a reference to a ide_drive_t</span>
<span class="cm"> * @drive:	device to release a reference on</span>
<span class="cm"> *</span>
<span class="cm"> * Release a reference to the ide_drive_t and decrements the use count of</span>
<span class="cm"> * the underlying LLDD module.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ide_device_put</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MODULE_UNLOAD</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">host_dev</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span> <span class="o">=</span> <span class="n">host_dev</span> <span class="o">?</span> <span class="n">host_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">gendev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_device_put</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">to_ide_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;MEDIA=%s&quot;</span><span class="p">,</span> <span class="n">ide_media_string</span><span class="p">(</span><span class="n">drive</span><span class="p">));</span>
	<span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;DRIVENAME=%s&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;MODALIAS=ide:m-%s&quot;</span><span class="p">,</span> <span class="n">ide_media_string</span><span class="p">(</span><span class="n">drive</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_ide_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">to_ide_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ide_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_ide_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">?</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_ide_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">to_ide_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ide_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_ide_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generic_ide_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span> <span class="o">=</span> <span class="n">to_ide_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ide_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_ide_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bus_type</span> <span class="n">ide_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ide&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">ide_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span>		<span class="o">=</span> <span class="n">ide_uevent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">generic_ide_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">generic_ide_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">generic_ide_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_attrs</span>	<span class="o">=</span> <span class="n">ide_dev_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">generic_ide_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">generic_ide_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_bus_type</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ide_vlb_clk</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_vlb_clk</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">vlb_clock</span><span class="p">,</span> <span class="n">ide_vlb_clk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vlb_clock</span><span class="p">,</span> <span class="s">&quot;VLB clock frequency (in MHz)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ide_pci_clk</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ide_pci_clk</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">pci_clock</span><span class="p">,</span> <span class="n">ide_pci_clk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pci_clock</span><span class="p">,</span> <span class="s">&quot;PCI bus clock frequency (in MHz)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_set_dev_param_mask</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dev_param_mask</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* controller . device (0 or 1) [ : 1 (set) | 0 (clear) ] */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d.%d:%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sscanf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_HWIFS</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dev_param_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">dev_param_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">param_ops_ide_dev_mask</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">ide_set_dev_param_mask</span>
<span class="p">};</span>

<span class="cp">#define param_check_ide_dev_mask(name, p) param_check_uint(name, p)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_nodma</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">nodma</span><span class="p">,</span> <span class="n">ide_nodma</span><span class="p">,</span> <span class="n">ide_dev_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nodma</span><span class="p">,</span> <span class="s">&quot;disallow DMA for a device&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_noflush</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">noflush</span><span class="p">,</span> <span class="n">ide_noflush</span><span class="p">,</span> <span class="n">ide_dev_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noflush</span><span class="p">,</span> <span class="s">&quot;disable flush requests for a device&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_nohpa</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">nohpa</span><span class="p">,</span> <span class="n">ide_nohpa</span><span class="p">,</span> <span class="n">ide_dev_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nohpa</span><span class="p">,</span> <span class="s">&quot;disable Host Protected Area for a device&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_noprobe</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">noprobe</span><span class="p">,</span> <span class="n">ide_noprobe</span><span class="p">,</span> <span class="n">ide_dev_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noprobe</span><span class="p">,</span> <span class="s">&quot;skip probing for a device&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_nowerr</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">nowerr</span><span class="p">,</span> <span class="n">ide_nowerr</span><span class="p">,</span> <span class="n">ide_dev_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowerr</span><span class="p">,</span> <span class="s">&quot;ignore the ATA_DF bit for a device&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_cdroms</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">cdrom</span><span class="p">,</span> <span class="n">ide_cdroms</span><span class="p">,</span> <span class="n">ide_dev_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cdrom</span><span class="p">,</span> <span class="s">&quot;force device as a CD-ROM&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">chs_geom</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cyl</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">head</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">sect</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_disks</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">chs_geom</span> <span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">MAX_HWIFS</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_set_disk_chs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* controller . device (0 or 1) : Cylinders , Heads , Sectors */</span>
	<span class="cm">/* controller . device (0 or 1) : 1 (use CHS) | 0 (ignore CHS) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d.%d:%d,%d,%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sscanf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d.%d:%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_HWIFS</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">||</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
		<span class="n">ide_disks</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ide_disks</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cyl</span>  <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">head</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sect</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span> <span class="n">ide_set_disk_chs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span> <span class="s">&quot;force device as a disk (using CHS)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ide_dev_apply_params</span><span class="p">(</span><span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">,</span> <span class="n">u8</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">MAX_DRIVES</span> <span class="o">+</span> <span class="n">unit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_nodma</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: disallowing DMA for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NODMA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_noflush</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: disabling flush requests for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NOFLUSH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_nohpa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: disabling Host Protected Area for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NOHPA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_noprobe</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: skipping probe for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_NOPROBE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_nowerr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: ignoring the ATA_DF bit for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">bad_wstat</span> <span class="o">=</span> <span class="n">BAD_R_STAT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_cdroms</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: forcing %s as a CD-ROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ide_cdrom</span><span class="p">;</span>
		<span class="cm">/* an ATAPI device ignores DRDY */</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">ready_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ide_disks</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span>  <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_cyl</span>  <span class="o">=</span> <span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cyl</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_head</span> <span class="o">=</span> <span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">head</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">=</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">bios_sect</span> <span class="o">=</span> <span class="n">ide_disks_chs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sect</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: forcing %s as a disk (%d/%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">drive</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">drive</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>

		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">IDE_DFLAG_FORCED_GEOM</span> <span class="o">|</span> <span class="n">IDE_DFLAG_PRESENT</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">ide_disk</span><span class="p">;</span>
		<span class="n">drive</span><span class="o">-&gt;</span><span class="n">ready_stat</span> <span class="o">=</span> <span class="n">ATA_DRDY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ide_ignore_cable</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ide_set_ignore_cable</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* controller (ignore) */</span>
	<span class="cm">/* controller : 1 (ignore) | 0 (use) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d:%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_HWIFS</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
		<span class="n">ide_ignore_cable</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ide_ignore_cable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">ignore_cable</span><span class="p">,</span> <span class="n">ide_set_ignore_cable</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ignore_cable</span><span class="p">,</span> <span class="s">&quot;ignore cable detection&quot;</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ide_port_apply_params</span><span class="p">(</span><span class="n">ide_hwif_t</span> <span class="o">*</span><span class="n">hwif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ide_drive_t</span> <span class="o">*</span><span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ide_ignore_cable</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ide: ignoring cable detection for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">hwif</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">hwif</span><span class="o">-&gt;</span><span class="n">cbl</span> <span class="o">=</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_port_for_each_dev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">hwif</span><span class="p">)</span>
		<span class="n">ide_dev_apply_params</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is gets invoked once during initialization, to set *everything* up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ide_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Uniform Multi-Platform E-IDE driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IDE: bus_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_port_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;ide_port&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ide_port_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ide_port_class</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_port_class</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ide_acpi_init</span><span class="p">();</span>

	<span class="n">proc_ide_create</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_port_class:</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_bus_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ide_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_ide_destroy</span><span class="p">();</span>

	<span class="n">class_destroy</span><span class="p">(</span><span class="n">ide_port_class</span><span class="p">);</span>

	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ide_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ide_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ide_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
