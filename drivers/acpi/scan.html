<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › acpi › scan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>scan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * scan.c - support for transforming the ACPI namespace into individual objects</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>

<span class="cp">#include &quot;internal.h&quot;</span>

<span class="cp">#define _COMPONENT		ACPI_BUS_COMPONENT</span>
<span class="n">ACPI_MODULE_NAME</span><span class="p">(</span><span class="s">&quot;scan&quot;</span><span class="p">);</span>
<span class="cp">#define STRUCT_TO_INT(s)	(*((int*)&amp;s))</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_root</span><span class="p">;</span>

<span class="cp">#define ACPI_BUS_CLASS			&quot;system_bus&quot;</span>
<span class="cp">#define ACPI_BUS_HID			&quot;LNXSYBUS&quot;</span>
<span class="cp">#define ACPI_BUS_DEVICE_NAME		&quot;System Bus&quot;</span>

<span class="cp">#define ACPI_IS_ROOT_DEVICE(device)    (!(device)-&gt;parent)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dummy_hid</span> <span class="o">=</span> <span class="s">&quot;device&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">acpi_device_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">acpi_bus_id_list</span><span class="p">);</span>
<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">acpi_device_lock</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">acpi_wakeup_device_list</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">acpi_device_bus_id</span><span class="p">{</span>
	<span class="kt">char</span> <span class="n">bus_id</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instance_no</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Creates hid/cid(s) string needed for modalias and uevent</span>
<span class="cm"> * e.g. on a device with hid:IBM0001 and cid:ACPI0001 you get:</span>
<span class="cm"> * char *modalias: &quot;acpi:IBM0001:ACPI0001&quot;</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_modalias</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modalias</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_hardware_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">modalias</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;acpi:&quot;</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modalias</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s:&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">modalias</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">acpi_device_modalias_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Device has no HID and no CID or string is &gt;1024 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">create_modalias</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">modalias</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">acpi_device_modalias_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_bus_hot_remove_device</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">arg_list</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ACPI_DEBUG_PRINT</span><span class="p">((</span><span class="n">ACPI_DB_INFO</span><span class="p">,</span>
		<span class="s">&quot;Hot-removing device %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_bus_trim</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span>
				<span class="s">&quot;Removing device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* power off device */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PS3&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">AE_NOT_FOUND</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span>
				<span class="s">&quot;Power-off device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">lockable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg_list</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">arg_list</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">;</span>
		<span class="n">arg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">arg</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_LCK&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">arg_list</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">arg_list</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TBD: _EJD support.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJ0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span>
				<span class="s">&quot;Eject device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">acpi_eject_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_object_type</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_device</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;1&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifndef FORCE_EJECT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_device</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_type</span><span class="p">(</span><span class="n">acpi_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">ejectable</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acpi_os_hotplug_execute</span><span class="p">(</span><span class="n">acpi_bus_hot_remove_device</span><span class="p">,</span> <span class="n">acpi_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">eject</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">acpi_eject_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">acpi_device_hid_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acpi_device_hid</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">acpi_device_hid_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">acpi_device_path_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">path</span> <span class="o">=</span> <span class="p">{</span><span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_get_name</span><span class="p">(</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_FULL_PATHNAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">path</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">acpi_device_path_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_setup_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Devices gotten from FADT don&#39;t have a &quot;path&quot; attribute</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_modalias</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">         * If device has _EJ0, &#39;eject&#39; file is created that is used to trigger</span>
<span class="cm">         * hot-removal function from userland.</span>
<span class="cm">         */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJ0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_eject</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If device has _EJ0, &#39;eject&#39; file is created that is used to trigger</span>
<span class="cm">	 * hot-removal function from userland.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJ0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_eject</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_modalias</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_path</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">			ACPI Bus operations</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>

<span class="kt">int</span> <span class="nf">acpi_match_device_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="o">*</span><span class="n">ids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_hardware_id</span> <span class="o">*</span><span class="n">hwid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device is not present, it is unnecessary to load device</span>
<span class="cm">	 * driver for it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">ids</span><span class="p">;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hwid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">hwid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_match_device_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_free_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_hardware_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">acpi_free_ids</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">acpi_drv</span> <span class="o">=</span> <span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">suspend</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">acpi_drv</span> <span class="o">=</span> <span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">resume</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">acpi_drv</span> <span class="o">=</span> <span class="n">to_acpi_driver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">acpi_match_device_ids</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;MODALIAS=&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">create_modalias</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">env</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_notify</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">notify</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">acpi_device_notify_fixed</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Fixed hardware devices have no handles */</span>
	<span class="n">acpi_device_notify</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ACPI_FIXED_HARDWARE_EVENT</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_install_notify_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">ACPI_BUS_TYPE_POWER_BUTTON</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">acpi_install_fixed_event_handler</span><span class="p">(</span><span class="n">ACPI_EVENT_POWER_BUTTON</span><span class="p">,</span>
						     <span class="n">acpi_device_notify_fixed</span><span class="p">,</span>
						     <span class="n">device</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">ACPI_BUS_TYPE_SLEEP_BUTTON</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">acpi_install_fixed_event_handler</span><span class="p">(</span><span class="n">ACPI_EVENT_SLEEP_BUTTON</span><span class="p">,</span>
						     <span class="n">acpi_device_notify_fixed</span><span class="p">,</span>
						     <span class="n">device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_install_notify_handler</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
						     <span class="n">ACPI_DEVICE_NOTIFY</span><span class="p">,</span>
						     <span class="n">acpi_device_notify</span><span class="p">,</span>
						     <span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_remove_notify_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">ACPI_BUS_TYPE_POWER_BUTTON</span><span class="p">)</span>
		<span class="n">acpi_remove_fixed_event_handler</span><span class="p">(</span><span class="n">ACPI_EVENT_POWER_BUTTON</span><span class="p">,</span>
						<span class="n">acpi_device_notify_fixed</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">ACPI_BUS_TYPE_SLEEP_BUTTON</span><span class="p">)</span>
		<span class="n">acpi_remove_fixed_event_handler</span><span class="p">(</span><span class="n">ACPI_EVENT_SLEEP_BUTTON</span><span class="p">,</span>
						<span class="n">acpi_device_notify_fixed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">acpi_remove_notify_handler</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_DEVICE_NOTIFY</span><span class="p">,</span>
					   <span class="n">acpi_device_notify</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">acpi_bus_driver_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">acpi_start_single_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">acpi_drv</span> <span class="o">=</span> <span class="n">to_acpi_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">acpi_bus_driver_init</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="n">acpi_drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="p">.</span><span class="n">acpi_op_start</span><span class="p">)</span>
			<span class="n">acpi_start_single_object</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">notify</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">acpi_device_install_notify_handler</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">remove</span><span class="p">)</span>
					<span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span>
						     <span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">removal_type</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ACPI_DEBUG_PRINT</span><span class="p">((</span><span class="n">ACPI_DB_INFO</span><span class="p">,</span>
			<span class="s">&quot;Found driver [%s] for device [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">));</span>
		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">to_acpi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">acpi_drv</span> <span class="o">=</span> <span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">notify</span><span class="p">)</span>
			<span class="n">acpi_device_remove_notify_handler</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">remove</span><span class="p">)</span>
			<span class="n">acpi_drv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">acpi_dev</span><span class="p">,</span> <span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">removal_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bus_type</span> <span class="n">acpi_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;acpi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">acpi_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">acpi_device_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">acpi_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">acpi_device_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">acpi_device_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span>		<span class="o">=</span> <span class="n">acpi_device_uevent</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device_bus_id</span> <span class="o">*</span><span class="n">acpi_device_bus_id</span><span class="p">,</span> <span class="o">*</span><span class="n">new_bus_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Linkage</span>
<span class="cm">	 * -------</span>
<span class="cm">	 * Link this device to its parent and siblings.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup_list</span><span class="p">);</span>

	<span class="n">new_bus_id</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device_bus_id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_bus_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Memory allocation error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Find suitable bus_id and instance number in acpi_bus_id_list</span>
<span class="cm">	 * If failed, create one and link it into acpi_bus_id_list</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">acpi_device_bus_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_bus_id_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span>
			    <span class="n">acpi_device_hid</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">instance_no</span><span class="o">++</span><span class="p">;</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_bus_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_device_bus_id</span> <span class="o">=</span> <span class="n">new_bus_id</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">acpi_device_hid</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>
		<span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">instance_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_bus_id_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%02x&quot;</span><span class="p">,</span> <span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">acpi_device_bus_id</span><span class="o">-&gt;</span><span class="n">instance_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_wakeup_device_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acpi_bus_type</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acpi_device_release</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error registering device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_device_setup_files</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Error creating sysfs interface for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">removal_type</span> <span class="o">=</span> <span class="n">ACPI_BUS_REMOVAL_NORMAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">end:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_device_lock</span><span class="p">);</span>

	<span class="n">acpi_detach_data</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">acpi_bus_data_handler</span><span class="p">);</span>

	<span class="n">acpi_device_remove_files</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">                                 Driver Management</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="cm">/**</span>
<span class="cm"> * acpi_bus_driver_init - add a device to a driver</span>
<span class="cm"> * @device: the device to add and initialize</span>
<span class="cm"> * @driver: driver for the device</span>
<span class="cm"> *</span>
<span class="cm"> * Used to initialize a device via its device driver.  Called whenever a</span>
<span class="cm"> * driver is bound to a device.  Invokes the driver&#39;s add() ops.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acpi_bus_driver_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">add</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TBD - Configuration Management: Assign resources to device based</span>
<span class="cm">	 * upon possible configuration and currently allocated resources.</span>
<span class="cm">	 */</span>

	<span class="n">ACPI_DEBUG_PRINT</span><span class="p">((</span><span class="n">ACPI_DB_INFO</span><span class="p">,</span>
			  <span class="s">&quot;Driver successfully bound to device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_start_single_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">driver</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">remove</span><span class="p">)</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_BUS_REMOVAL_NORMAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * acpi_bus_register_driver - register a driver with the ACPI bus</span>
<span class="cm"> * @driver: driver being registered</span>
<span class="cm"> *</span>
<span class="cm"> * Registers a driver with the ACPI bus.  Searches the namespace for all</span>
<span class="cm"> * devices that match the driver&#39;s criteria and binds.  Returns zero for</span>
<span class="cm"> * success or a negative error status for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">acpi_bus_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acpi_bus_type</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_bus_register_driver</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * acpi_bus_unregister_driver - unregisters a driver with the APIC bus</span>
<span class="cm"> * @driver: driver to unregister</span>
<span class="cm"> *</span>
<span class="cm"> * Unregisters a driver with the ACPI bus.  Searches the namespace for all</span>
<span class="cm"> * devices that match the driver&#39;s criteria and unbinds.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">acpi_bus_unregister_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_bus_unregister_driver</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">                                 Device Enumeration</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="nf">acpi_bus_get_parent</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fixed hardware devices do not appear in the namespace and do not</span>
<span class="cm">	 * have handles, but we fabricate acpi_devices for them, so we have</span>
<span class="cm">	 * to deal with them specially.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">acpi_root</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_parent</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">AE_NULL_ENTRY</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">acpi_root</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">acpi_status</span>
<span class="nf">acpi_bus_get_ejd</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">ejd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span><span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJD&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJD&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">ACPI_ROOT_OBJECT</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
					 <span class="n">ejd</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">acpi_bus_get_ejd</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">acpi_bus_data_handler</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* TBD */</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_get_perf_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">performance</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ACPI_STATE_UNKNOWN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span>
<span class="nf">acpi_bus_extract_wakeup_device_power_package</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">acpi_device_wakeup</span> <span class="o">*</span><span class="n">wakeup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">package</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">element</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wakeup</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>

	<span class="cm">/* _PRW */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PRW&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ACPI_EXCEPTION</span><span class="p">((</span><span class="n">AE_INFO</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&quot;Evaluating _PRW&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">package</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">package</span> <span class="o">||</span> <span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_DATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">element</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">element</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_DATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span>
		     <span class="n">ACPI_TYPE_LOCAL_REFERENCE</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_DATA</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">gpe_device</span> <span class="o">=</span>
		    <span class="n">element</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reference</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">gpe_number</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">gpe_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">gpe_number</span> <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_DATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">element</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_DATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">sleep_state</span> <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ACPI_MAX_HANDLES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_NO_MEMORY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_LOCAL_REFERENCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_DATA</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">reference</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acpi_setup_gpe_for_wake</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">gpe_device</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">gpe_number</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_bus_set_run_wake_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">button_device_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="s">&quot;PNP0C0D&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;PNP0C0C&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;PNP0C0E&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_event_status</span> <span class="n">event_status</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">notifier_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Power button, Lid switch always enable wakeup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_match_device_ids</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">button_device_ids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">run_wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_gpe_status</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">gpe_device</span><span class="p">,</span>
					<span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">gpe_number</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">event_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">AE_OK</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">run_wake</span> <span class="o">=</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">event_status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_HANDLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_bus_get_wakeup_device_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">psw_error</span><span class="p">;</span>

	<span class="cm">/* Presence of _PRW indicates wake capable */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PRW&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_bus_extract_wakeup_device_power_package</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ACPI_EXCEPTION</span><span class="p">((</span><span class="n">AE_INFO</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&quot;Extracting _PRW package&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">prepare_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acpi_bus_set_run_wake_flags</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="cm">/* Call _PSW/_DSW object to disable its ability to wake the sleeping</span>
<span class="cm">	 * system for the ACPI device with the _PRW object.</span>
<span class="cm">	 * The _PSW object is depreciated in ACPI 3.0 and is replaced by _DSW.</span>
<span class="cm">	 * So it is necessary to call _DSW object first. Only when it is not</span>
<span class="cm">	 * present will the _PSW object used.</span>
<span class="cm">	 */</span>
	<span class="n">psw_error</span> <span class="o">=</span> <span class="n">acpi_device_sleep_wake</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psw_error</span><span class="p">)</span>
		<span class="n">ACPI_DEBUG_PRINT</span><span class="p">((</span><span class="n">ACPI_DB_INFO</span><span class="p">,</span>
				<span class="s">&quot;error in _DSW or _PSW evaluation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">acpi_bus_add_power_resource</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_get_power_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * Power Management Flags</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PSC&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">explicit_get</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_IRC&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">inrush_current</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enumerate supported power management states</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ACPI_STATE_D0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ACPI_STATE_D3_HOT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_device_power_state</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">object_name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;_&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span> <span class="p">};</span>

		<span class="cm">/* Evaluate &quot;_PRx&quot; to se if power resources are referenced */</span>
		<span class="n">acpi_evaluate_reference</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">power_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">acpi_bus_add_power_resource</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="cm">/* Evaluate &quot;_PSx&quot; to see if we can do explicit sets */</span>
		<span class="n">object_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">explicit_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * State is valid if there are means to put the device into it.</span>
<span class="cm">		 * D3hot is only valid if _PR3 present.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">count</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">explicit_set</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACPI_STATE_D3_HOT</span><span class="p">))</span>
			<span class="n">ps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ps</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Unknown - driver assigned */</span>
		<span class="n">ps</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Unknown - driver assigned */</span>
	<span class="p">}</span>

	<span class="cm">/* Set defaults for D0 and D3 states (always valid) */</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_D0</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_D0</span><span class="p">].</span><span class="n">power</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_D3</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_D3</span><span class="p">].</span><span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set D3cold&#39;s explicit_set flag if _PS3 exists. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_D3_HOT</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">explicit_set</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_D3_COLD</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">explicit_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">acpi_bus_init_power</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_get_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


	<span class="cm">/* Presence of _STA indicates &#39;dynamic_status&#39; */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_STA&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dynamic_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Presence of _RMV indicates &#39;removable&#39; */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_RMV&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">removable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Presence of _EJD|_EJ0 indicates &#39;ejectable&#39; */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJD&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">ejectable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJ0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">ejectable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Presence of _LCK indicates &#39;lockable&#39; */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_LCK&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">lockable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Power resources cannot be power manageable. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">ACPI_BUS_TYPE_POWER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Presence of _PS0|_PR0 indicates &#39;power manageable&#39; */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PS0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PR0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">power_manageable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* TBD: Performance management */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_get_busid</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">bus_id</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;?&#39;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bus_id</span><span class="p">),</span> <span class="n">bus_id</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bus ID</span>
<span class="cm">	 * ------</span>
<span class="cm">	 * The device&#39;s Bus ID is simply the object name.</span>
<span class="cm">	 * TBD: Shouldn&#39;t this value be unique (within the ACPI namespace)?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_IS_ROOT_DEVICE</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span> <span class="s">&quot;ACPI&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_POWER_BUTTON</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span> <span class="s">&quot;PWRF&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_SLEEP_BUTTON</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span> <span class="s">&quot;SLPF&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">acpi_get_name</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_SINGLE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="cm">/* Clean up trailing underscores (if any) */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span>
				<span class="n">bus_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">bus_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * acpi_bay_match - see if a device is an ejectable driver bay</span>
<span class="cm"> *</span>
<span class="cm"> * If an acpi object is ejectable and has one of the ACPI ATA methods defined,</span>
<span class="cm"> * then we can safely call it an ejectable drive bay</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">acpi_bay_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">){</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">phandle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJ0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_GTF&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_GTM&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_STM&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_SDD&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_get_parent</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phandle</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="s">&quot;_GTF&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="s">&quot;_GTM&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="s">&quot;_STM&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="s">&quot;_SDD&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))))</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * acpi_dock_match - see if a device has a _DCK method</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">acpi_dock_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_DCK&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">acpi_device_hid</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_hardware_id</span> <span class="o">*</span><span class="n">hid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dummy_hid</span><span class="p">;</span>

	<span class="n">hid</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acpi_hardware_id</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_device_hid</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_add_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_hardware_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Old IBM workstations have a DSDT bug wherein the SMBus object</span>
<span class="cm"> * lacks the SMBUS01 HID and the methods do not have the necessary &quot;_&quot;</span>
<span class="cm"> * prefix.  Work around this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_ibm_smbus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">h_dummy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">path</span> <span class="o">=</span> <span class="p">{</span><span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi_name_in_vendors</span><span class="p">(</span><span class="s">&quot;IBM&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Look for SMBS object */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_get_name</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_SINGLE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;SMBS&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">pointer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Does it have the necessary (but misnamed) methods? */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;SBI&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h_dummy</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;SBR&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h_dummy</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;SBW&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h_dummy</span><span class="p">)))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_device_set_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpica_device_id_list</span> <span class="o">*</span><span class="n">cid_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_DEVICE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_IS_ROOT_DEVICE</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_SYSTEM_HID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_object_info</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;%s: Error reading device info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">ACPI_VALID_HID</span><span class="p">)</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hardware_id</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">ACPI_VALID_CID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cid_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">compatible_id_list</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cid_list</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">cid_list</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">ACPI_VALID_ADR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">bus_address</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bus_address</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Some devices don&#39;t reliably have _HIDs &amp; _CIDs, so add</span>
<span class="cm">		 * synthetic HIDs to make sure drivers can find them.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_is_video_device</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_VIDEO_HID</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_bay_match</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_BAY_HID</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_dock_match</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_DOCK_HID</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ibm_smbus_match</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_SMBUS_IBM_HID</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_device_hid</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">ACPI_IS_ROOT_DEVICE</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_BUS_HID</span><span class="p">);</span> <span class="cm">/* \_SB, LNXSYBUS */</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ACPI_BUS_DEVICE_NAME</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">device_class</span><span class="p">,</span> <span class="n">ACPI_BUS_CLASS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_POWER</span>:
		<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_POWER_HID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_PROCESSOR</span>:
		<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_PROCESSOR_OBJECT_HID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_THERMAL</span>:
		<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_THERMAL_HID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_POWER_BUTTON</span>:
		<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_BUTTON_HID_POWERF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_BUS_TYPE_SLEEP_BUTTON</span>:
		<span class="n">acpi_add_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ACPI_BUTTON_HID_SLEEPF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_device_set_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Context</span>
<span class="cm">	 * -------</span>
<span class="cm">	 * Attach this &#39;struct acpi_device&#39; to the ACPI object.  This makes</span>
<span class="cm">	 * resolutions from handle-&gt;device very efficient.  Fixed hardware</span>
<span class="cm">	 * devices have no handles, so we skip them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_attach_data</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				  <span class="n">acpi_bus_data_handler</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Error attaching device data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rmdevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">removal_type</span> <span class="o">=</span> <span class="n">ACPI_BUS_REMOVAL_EJECT</span><span class="p">;</span>
	<span class="n">device_release_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmdevice</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * unbind _ADR-Based Devices when hot removal</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bus_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">unbind</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">acpi_device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACPI_BUS_REMOVAL_EJECT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_add_single_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">**</span><span class="n">child</span><span class="p">,</span>
				  <span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">sta</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Memory allocation error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">ids</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">acpi_bus_get_parent</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">bus_ops</span> <span class="o">=</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span> <span class="cm">/* workround for not call .start */</span>
	<span class="n">STRUCT_TO_INT</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>

	<span class="n">acpi_device_get_busid</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flags</span>
<span class="cm">	 * -----</span>
<span class="cm">	 * Note that we only look for object handles -- cannot evaluate objects</span>
<span class="cm">	 * until we know the device is present and properly initialized.</span>
<span class="cm">	 */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_get_flags</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize Device</span>
<span class="cm">	 * -----------------</span>
<span class="cm">	 * TBD: Synch with Core&#39;s enumeration/initialization process.</span>
<span class="cm">	 */</span>
	<span class="n">acpi_device_set_id</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power Management</span>
<span class="cm">	 * ----------------</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">power_manageable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_get_power_flags</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wakeup device management</span>
<span class="cm">	 *-----------------------</span>
<span class="cm">	 */</span>
	<span class="n">acpi_bus_get_wakeup_device_flags</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Performance Management</span>
<span class="cm">	 * ----------------------</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">performance_manageable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_get_perf_flags</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">acpi_device_set_context</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_device_register</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bind _ADR-Based Devices when hot add</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bus_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">bind</span><span class="p">)</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_get_name</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_FULL_PATHNAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">ACPI_DEBUG_PRINT</span><span class="p">((</span><span class="n">ACPI_DB_INFO</span><span class="p">,</span>
			<span class="s">&quot;Adding %s [%s] parent %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
			 <span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">?</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span>
					  <span class="s">&quot;(null)&quot;</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">acpi_device_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ACPI_STA_DEFAULT (ACPI_STA_DEVICE_PRESENT | ACPI_STA_DEVICE_ENABLED | \</span>
<span class="cp">			  ACPI_STA_DEVICE_UI      | ACPI_STA_DEVICE_FUNCTIONING)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_bus_add_power_resource</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">acpi_op_add</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">acpi_op_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="n">acpi_add_single_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_BUS_TYPE_POWER</span><span class="p">,</span>
					<span class="n">ACPI_STA_DEFAULT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_type_and_status</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_object_type</span> <span class="n">acpi_type</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_type</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">acpi_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_ANY</span>:		<span class="cm">/* for ACPI_ROOT_OBJECT */</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_DEVICE</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_BUS_TYPE_DEVICE</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_bus_get_status_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_PROCESSOR</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_BUS_TYPE_PROCESSOR</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_bus_get_status_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_THERMAL</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_BUS_TYPE_THERMAL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">ACPI_STA_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_POWER</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_BUS_TYPE_POWER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">ACPI_STA_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">acpi_bus_check_add</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lvl</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">return_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_type_and_status</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span> <span class="o">&amp;</span> <span class="n">ACPI_STA_DEVICE_PRESENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sta</span> <span class="o">&amp;</span> <span class="n">ACPI_STA_DEVICE_FUNCTIONING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acpi_device_wakeup</span> <span class="n">wakeup</span><span class="p">;</span>
		<span class="n">acpi_handle</span> <span class="n">temp</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_PRW&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">acpi_bus_extract_wakeup_device_power_package</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
								     <span class="o">&amp;</span><span class="n">wakeup</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_CTRL_DEPTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We may already have an acpi_device from a previous enumeration.  If</span>
<span class="cm">	 * so, we needn&#39;t add it again, but we may still have to start it.</span>
<span class="cm">	 */</span>
	<span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">acpi_op_add</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="n">acpi_add_single_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_CTRL_DEPTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">acpi_op_start</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">acpi_op_add</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_start_single_object</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">AE_CTRL_DEPTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">return_value</span><span class="p">)</span>
		<span class="o">*</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_scan</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">**</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_bus_check_add</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">acpi_walk_namespace</span><span class="p">(</span><span class="n">ACPI_TYPE_ANY</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">ACPI_UINT32_MAX</span><span class="p">,</span>
				    <span class="n">acpi_bus_check_add</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span>
		<span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * acpi_bus_add and acpi_bus_start</span>
<span class="cm"> *</span>
<span class="cm"> * scan a given ACPI tree and (probably recently hot-plugged)</span>
<span class="cm"> * create and add or starts found devices.</span>
<span class="cm"> *</span>
<span class="cm"> * If no devices were found -ENODEV is returned which does not</span>
<span class="cm"> * mean that this is a real error, there just have been no suitable</span>
<span class="cm"> * ACPI objects in the table trunk from which the kernel could create</span>
<span class="cm"> * a device and add/start an appropriate driver.</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">acpi_bus_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">**</span><span class="n">child</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">acpi_op_add</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">acpi_bus_scan</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_bus_add</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">acpi_bus_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">acpi_op_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_scan</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">acpi_update_all_gpes</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_bus_start</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">acpi_bus_trim</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rmdevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">phandle</span><span class="p">,</span> <span class="n">chandle</span><span class="p">;</span>
	<span class="n">acpi_object_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="o">=</span> <span class="n">start</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">child</span> <span class="o">=</span> <span class="n">chandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_next_object</span><span class="p">(</span><span class="n">ACPI_TYPE_ANY</span><span class="p">,</span> <span class="n">phandle</span><span class="p">,</span>
					      <span class="n">chandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chandle</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this scope is exhausted then move our way back up.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">level</span><span class="o">--</span><span class="p">;</span>
			<span class="n">chandle</span> <span class="o">=</span> <span class="n">phandle</span><span class="p">;</span>
			<span class="n">acpi_get_parent</span><span class="p">(</span><span class="n">phandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phandle</span><span class="p">);</span>
			<span class="n">child</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
			<span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">acpi_bus_remove</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">rmdevice</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">acpi_bus_remove</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_type</span><span class="p">(</span><span class="n">chandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If there is a device corresponding to chandle then</span>
<span class="cm">		 * parse it (depth-first).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">chandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">level</span><span class="o">++</span><span class="p">;</span>
			<span class="n">phandle</span> <span class="o">=</span> <span class="n">chandle</span><span class="p">;</span>
			<span class="n">chandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">parent</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">acpi_bus_trim</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_bus_scan_fixed</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">acpi_op_add</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">acpi_op_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enumerate all fixed-feature devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_FADT_POWER_BUTTON</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_add_single_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">ACPI_BUS_TYPE_POWER_BUTTON</span><span class="p">,</span>
						<span class="n">ACPI_STA_DEFAULT</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
		<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACPI_FADT_SLEEP_BUTTON</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_add_single_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">ACPI_BUS_TYPE_SLEEP_BUTTON</span><span class="p">,</span>
						<span class="n">ACPI_STA_DEFAULT</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_scan_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_bus_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ops</span><span class="p">));</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">acpi_op_add</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">acpi_op_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We don&#39;t want to quit even if we failed to add suspend/resume */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Could not register bus type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">acpi_power_init</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enumerate devices in the ACPI namespace.</span>
<span class="cm">	 */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_scan</span><span class="p">(</span><span class="n">ACPI_ROOT_OBJECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_root</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_scan_fixed</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">acpi_device_unregister</span><span class="p">(</span><span class="n">acpi_root</span><span class="p">,</span> <span class="n">ACPI_BUS_REMOVAL_NORMAL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">acpi_update_all_gpes</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
