<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › acpi › sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sysfs.c - ACPI sysfs interface to userspace.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>

<span class="cp">#define _COMPONENT		ACPI_SYSTEM_COMPONENT</span>
<span class="n">ACPI_MODULE_NAME</span><span class="p">(</span><span class="s">&quot;sysfs&quot;</span><span class="p">);</span>

<span class="cp">#define PREFIX &quot;ACPI: &quot;</span>

<span class="cp">#ifdef CONFIG_ACPI_DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * ACPI debug sysfs I/F, including:</span>
<span class="cm"> * /sys/modules/acpi/parameters/debug_layer</span>
<span class="cm"> * /sys/modules/acpi/parameters/debug_level</span>
<span class="cm"> * /sys/modules/acpi/parameters/trace_method_name</span>
<span class="cm"> * /sys/modules/acpi/parameters/trace_state</span>
<span class="cm"> * /sys/modules/acpi/parameters/trace_debug_layer</span>
<span class="cm"> * /sys/modules/acpi/parameters/trace_debug_level</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">acpi_dlayer</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">acpi_dlevel</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define ACPI_DEBUG_INIT(v)	{ .name = #v, .value = v }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_dlayer</span> <span class="n">acpi_debug_layers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_UTILITIES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_HARDWARE</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_EVENTS</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_TABLES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_NAMESPACE</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_PARSER</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_DISPATCHER</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_EXECUTER</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_RESOURCES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_CA_DEBUGGER</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_OS_SERVICES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_CA_DISASSEMBLER</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_COMPILER</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_TOOLS</span><span class="p">),</span>

	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_BUS_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_AC_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_BATTERY_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_BUTTON_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_SBS_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_FAN_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_PCI_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_POWER_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_CONTAINER_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_SYSTEM_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_THERMAL_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_MEMORY_DEVICE_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_VIDEO_COMPONENT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_PROCESSOR_COMPONENT</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_dlevel</span> <span class="n">acpi_debug_levels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_INIT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_DEBUG_OBJECT</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_INFO</span><span class="p">),</span>

	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_INIT_NAMES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_PARSE</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_LOAD</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_DISPATCH</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_EXEC</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_NAMES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_OPREGION</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_BFIELD</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_TABLES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_VALUES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_OBJECTS</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_RESOURCES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_USER_REQUESTS</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_PACKAGE</span><span class="p">),</span>

	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_ALLOCATIONS</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_FUNCTIONS</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_OPTIMIZATIONS</span><span class="p">),</span>

	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_MUTEX</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_THREADS</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_IO</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_INTERRUPTS</span><span class="p">),</span>

	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_AML_DISASSEMBLE</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_VERBOSE_INFO</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_FULL_TABLES</span><span class="p">),</span>
	<span class="n">ACPI_DEBUG_INIT</span><span class="p">(</span><span class="n">ACPI_LV_EVENTS</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_get_debug_layer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%-25s</span><span class="se">\t</span><span class="s">Hex        SET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Description&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">acpi_debug_layers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">result</span><span class="p">,</span> <span class="s">&quot;%-25s</span><span class="se">\t</span><span class="s">0x%08lX [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">acpi_debug_layers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				  <span class="n">acpi_debug_layers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">acpi_dbg_layer</span> <span class="o">&amp;</span> <span class="n">acpi_debug_layers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
				  <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">result</span><span class="p">,</span> <span class="s">&quot;%-25s</span><span class="se">\t</span><span class="s">0x%08X [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;ACPI_ALL_DRIVERS&quot;</span><span class="p">,</span>
		    <span class="n">ACPI_ALL_DRIVERS</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">acpi_dbg_layer</span> <span class="o">&amp;</span> <span class="n">ACPI_ALL_DRIVERS</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">ACPI_ALL_DRIVERS</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="n">acpi_dbg_layer</span> <span class="o">&amp;</span> <span class="n">ACPI_ALL_DRIVERS</span><span class="p">)</span>
		    <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">result</span><span class="p">,</span>
		    <span class="s">&quot;--</span><span class="se">\n</span><span class="s">debug_layer = 0x%08X ( * = enabled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">acpi_dbg_layer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_get_debug_level</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%-25s</span><span class="se">\t</span><span class="s">Hex        SET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Description&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">acpi_debug_levels</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">result</span><span class="p">,</span> <span class="s">&quot;%-25s</span><span class="se">\t</span><span class="s">0x%08lX [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">acpi_debug_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				  <span class="n">acpi_debug_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">acpi_dbg_level</span> <span class="o">&amp;</span> <span class="n">acpi_debug_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
				  <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">result</span><span class="p">,</span> <span class="s">&quot;--</span><span class="se">\n</span><span class="s">debug_level = 0x%08X (* = enabled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">acpi_dbg_level</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">param_ops_debug_layer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">param_set_uint</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">param_get_debug_layer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">param_ops_debug_level</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">param_set_uint</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">param_get_debug_level</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_param_cb</span><span class="p">(</span><span class="n">debug_layer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param_ops_debug_layer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_dbg_layer</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_cb</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param_ops_debug_level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_dbg_level</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">trace_method_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">trace_method_name</span><span class="p">,</span> <span class="n">trace_method_name</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trace_debug_layer</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">trace_debug_layer</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trace_debug_level</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">trace_debug_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_set_trace_state</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;enable&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_debug_trace</span><span class="p">(</span><span class="n">trace_method_name</span><span class="p">,</span> <span class="n">trace_debug_level</span><span class="p">,</span>
					  <span class="n">trace_debug_layer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;disable&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_debug_trace</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">trace_debug_level</span><span class="p">,</span>
					  <span class="n">trace_debug_layer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_debug_trace</span><span class="p">(</span><span class="n">trace_method_name</span><span class="p">,</span> <span class="n">trace_debug_level</span><span class="p">,</span>
					  <span class="n">trace_debug_layer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_get_trace_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_gbl_trace_method_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gbl_trace_flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">trace_state</span><span class="p">,</span> <span class="n">param_set_trace_state</span><span class="p">,</span> <span class="n">param_get_trace_state</span><span class="p">,</span>
		  <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ACPI_DEBUG */</span><span class="cp"></span>


<span class="cm">/* /sys/modules/acpi/parameters/aml_debug_output */</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">aml_debug_output</span><span class="p">,</span> <span class="n">acpi_gbl_enable_aml_debug_object</span><span class="p">,</span>
		   <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aml_debug_output</span><span class="p">,</span>
		 <span class="s">&quot;To enable/disable the ACPI Debug Object output.&quot;</span><span class="p">);</span>

<span class="cm">/* /sys/module/acpi/parameters/acpica_version */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_get_acpica_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="n">ACPI_CA_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">acpica_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">param_get_acpica_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ACPI table sysfs I/F:</span>
<span class="cm"> * /sys/firmware/acpi/tables/</span>
<span class="cm"> * /sys/firmware/acpi/tables/dynamic/</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">acpi_table_attr_list</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">tables_kobj</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">dynamic_tables_kobj</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">acpi_table_attr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">acpi_table_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_attr</span> <span class="o">*</span><span class="n">table_attr</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">bin_attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acpi_table_attr</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">ACPI_NAME_SIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ACPI_NAME_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\0\0\0\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table_header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span>
				       <span class="n">table_header</span><span class="p">,</span> <span class="n">table_header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_table_attr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_attr</span> <span class="o">*</span><span class="n">table_attr</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table_header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_table_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table_header</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">table_header</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">,</span>
		       <span class="n">ACPI_NAME_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_table_attr_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ACPI_NAME_SIZE</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">&lt;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">)</span>
				<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
					 <span class="o">!</span><span class="n">acpi_get_table</span>
					 <span class="p">(</span><span class="n">table_header</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">)))</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">+</span> <span class="n">ACPI_NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
			<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">);</span>

	<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">acpi_table_show</span><span class="p">;</span>
	<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0400</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span>
<span class="nf">acpi_sysfs_table_handler</span><span class="p">(</span><span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_attr</span> <span class="o">*</span><span class="n">table_attr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_TABLE_EVENT_LOAD</span>:
		<span class="n">table_attr</span> <span class="o">=</span>
		    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_attr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table_attr</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_NO_MEMORY</span><span class="p">;</span>

		<span class="n">acpi_table_attr_init</span><span class="p">(</span><span class="n">table_attr</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="n">dynamic_tables_kobj</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">table_attr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_table_attr_list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_TABLE_EVENT_UNLOAD</span>:
		<span class="cm">/*</span>
<span class="cm">		 * we do not need to do anything right now</span>
<span class="cm">		 * because the table is not deleted from the</span>
<span class="cm">		 * global table list when unloading it.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_tables_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_attr</span> <span class="o">*</span><span class="n">table_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">table_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">tables_kobj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">&quot;tables&quot;</span><span class="p">,</span> <span class="n">acpi_kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tables_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dynamic_tables_kobj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">&quot;dynamic&quot;</span><span class="p">,</span> <span class="n">tables_kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dynamic_tables_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dynamic_tables</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_get_table_by_index</span><span class="p">(</span><span class="n">table_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table_header</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">table_index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">table_attr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">table_attr</span> <span class="o">=</span>
			    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_attr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table_attr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">acpi_table_attr_init</span><span class="p">(</span><span class="n">table_attr</span><span class="p">,</span> <span class="n">table_header</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span>
			    <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="n">tables_kobj</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">table_attr</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table_attr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">acpi_table_attr_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">);</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="n">tables_kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="n">dynamic_tables_kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_install_table_handler</span><span class="p">(</span><span class="n">acpi_sysfs_table_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="n">AE_OK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">err_dynamic_tables:</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="n">tables_kobj</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detailed ACPI IRQ counters:</span>
<span class="cm"> * /sys/firmware/acpi/interrupts/</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="n">acpi_irq_handled</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">acpi_irq_not_handled</span><span class="p">;</span>

<span class="cp">#define COUNT_GPE 0</span>
<span class="cp">#define COUNT_SCI 1		</span><span class="cm">/* acpi_irq_handled */</span><span class="cp"></span>
<span class="cp">#define COUNT_SCI_NOT 2		</span><span class="cm">/* acpi_irq_not_handled */</span><span class="cp"></span>
<span class="cp">#define COUNT_ERROR 3		</span><span class="cm">/* other */</span><span class="cp"></span>
<span class="cp">#define NUM_COUNTERS_EXTRA 4</span>

<span class="k">struct</span> <span class="n">event_counter</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_counter</span> <span class="o">*</span><span class="n">all_counters</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">num_gpes</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">num_counters</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">**</span><span class="n">all_attrs</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">acpi_gpe_count</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">interrupt_stats_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">counter_attrs</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_gpe_attr_array</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_counter</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">all_counters</span><span class="p">;</span>

	<span class="n">all_counters</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">counter_attrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_gpes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">counter_attrs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gpe_count</span><span class="p">(</span><span class="n">u32</span> <span class="n">gpe_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_gpe_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_counters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpe_number</span> <span class="o">&lt;</span> <span class="n">num_gpes</span><span class="p">)</span>
		<span class="n">all_counters</span><span class="p">[</span><span class="n">gpe_number</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">all_counters</span><span class="p">[</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span>
			     <span class="n">COUNT_ERROR</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fixed_event_count</span><span class="p">(</span><span class="n">u32</span> <span class="n">event_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_counters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_number</span> <span class="o">&lt;</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span><span class="p">)</span>
		<span class="n">all_counters</span><span class="p">[</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">event_number</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">all_counters</span><span class="p">[</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span>
			     <span class="n">COUNT_ERROR</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_gbl_event_handler</span><span class="p">(</span><span class="n">u32</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">acpi_handle</span> <span class="n">device</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">event_number</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">ACPI_EVENT_TYPE_GPE</span><span class="p">)</span>
		<span class="n">gpe_count</span><span class="p">(</span><span class="n">event_number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">ACPI_EVENT_TYPE_FIXED</span><span class="p">)</span>
		<span class="n">fixed_event_count</span><span class="p">(</span><span class="n">event_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_status</span><span class="p">(</span><span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">acpi_event_status</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		      <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_gpes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_get_gpe_device</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACPI_EXCEPTION</span><span class="p">((</span><span class="n">AE_INFO</span><span class="p">,</span> <span class="n">AE_NOT_FOUND</span><span class="p">,</span>
					<span class="s">&quot;Invalid GPE 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_get_gpe_status</span><span class="p">(</span><span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_get_event_status</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">num_gpes</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">counter_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">-</span> <span class="n">counter_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">acpi_event_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">all_counters</span><span class="p">[</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_SCI</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_irq_handled</span><span class="p">;</span>
	<span class="n">all_counters</span><span class="p">[</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_SCI_NOT</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_irq_not_handled</span><span class="p">;</span>
	<span class="n">all_counters</span><span class="p">[</span><span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_GPE</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_gpe_count</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%8d&quot;</span><span class="p">,</span> <span class="n">all_counters</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/* &quot;gpe_all&quot; or &quot;sci&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_HANDLE</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;   invalid&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_ENABLED</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;   enabled&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_WAKE_ENABLED</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;   wake_enabled&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;   disabled&quot;</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * counter_set() sets the specified counter.</span>
<span class="cm"> * setting the total &quot;sci&quot; file to any value clears all counters.</span>
<span class="cm"> * enable/disable/clear a gpe/fixed event in user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">counter_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">-</span> <span class="n">counter_attrs</span><span class="p">;</span>
	<span class="n">acpi_event_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_SCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_counters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">all_counters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acpi_gpe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acpi_irq_handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acpi_irq_not_handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* show the event status for both GPEs and Fixed Events */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_HANDLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span>
		       <span class="s">&quot;Can not change Invalid GPE/Fixed Event status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_gpes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_ENABLED</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_disable_gpe</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_ENABLED</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_enable_gpe</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_SET</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_clear_gpe</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">all_counters</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="n">num_gpes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_ENABLED</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_disable_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">ACPI_NOT_ISR</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_ENABLED</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_enable_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">ACPI_NOT_ISR</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ACPI_EVENT_FLAG_SET</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_clear_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">all_counters</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">all_counters</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">acpi_irq_stats_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all_counters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">num_gpes</span> <span class="o">=</span> <span class="n">acpi_current_gpe_count</span><span class="p">;</span>
	<span class="n">num_counters</span> <span class="o">=</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">NUM_COUNTERS_EXTRA</span><span class="p">;</span>

	<span class="n">all_attrs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_counters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">all_attrs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">all_counters</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_counter</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_counters</span><span class="p">),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">all_counters</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_install_global_event_handler</span><span class="p">(</span><span class="n">acpi_gbl_event_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">counter_attrs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobj_attribute</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_counters</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">counter_attrs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_counters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_gpes</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;gpe%02X&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_EVENT_PMTIMER</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ff_pmtimer&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_EVENT_GLOBAL</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ff_gbl_lock&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_EVENT_POWER_BUTTON</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ff_pwr_btn&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_EVENT_SLEEP_BUTTON</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ff_slp_btn&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_EVENT_RTC</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ff_rt_clk&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_GPE</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;gpe_all&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_SCI</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;sci&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_SCI_NOT</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;sci_not&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_gpes</span> <span class="o">+</span> <span class="n">ACPI_NUM_FIXED_EVENTS</span> <span class="o">+</span> <span class="n">COUNT_ERROR</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;bug%02X&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0644</span><span class="p">;</span>
		<span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">show</span> <span class="o">=</span> <span class="n">counter_show</span><span class="p">;</span>
		<span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">store</span> <span class="o">=</span> <span class="n">counter_set</span><span class="p">;</span>

		<span class="n">all_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">counter_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">interrupt_stats_attr_group</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">all_attrs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysfs_create_group</span><span class="p">(</span><span class="n">acpi_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interrupt_stats_attr_group</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">delete_gpe_attr_array</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">interrupt_stats_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">acpi_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interrupt_stats_attr_group</span><span class="p">);</span>

	<span class="n">delete_gpe_attr_array</span><span class="p">();</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">acpi_show_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">preferred_profile</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">pm_profile_attr</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pm_profile</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">acpi_show_profile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_tables_sysfs_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="n">acpi_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pm_profile_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
