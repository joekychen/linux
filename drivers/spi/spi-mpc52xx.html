<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › spi › spi-mpc52xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>spi-mpc52xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * MPC52xx SPI bus driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Secret Lab Technologies Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPLv2</span>
<span class="cm"> *</span>
<span class="cm"> * This is the driver for the MPC5200&#39;s dedicated SPI controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: this driver does not support the MPC5200 PSC in SPI mode.  For</span>
<span class="cm"> * that driver see drivers/spi/mpc52xx_psc_spi.c</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/mpc52xx.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Grant Likely &lt;grant.likely@secretlab.ca&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MPC52xx SPI (non-PSC) Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* Register offsets */</span>
<span class="cp">#define SPI_CTRL1	0x00</span>
<span class="cp">#define SPI_CTRL1_SPIE		(1 &lt;&lt; 7)</span>
<span class="cp">#define SPI_CTRL1_SPE		(1 &lt;&lt; 6)</span>
<span class="cp">#define SPI_CTRL1_MSTR		(1 &lt;&lt; 4)</span>
<span class="cp">#define SPI_CTRL1_CPOL		(1 &lt;&lt; 3)</span>
<span class="cp">#define SPI_CTRL1_CPHA		(1 &lt;&lt; 2)</span>
<span class="cp">#define SPI_CTRL1_SSOE		(1 &lt;&lt; 1)</span>
<span class="cp">#define SPI_CTRL1_LSBFE		(1 &lt;&lt; 0)</span>

<span class="cp">#define SPI_CTRL2	0x01</span>
<span class="cp">#define SPI_BRR		0x04</span>

<span class="cp">#define SPI_STATUS	0x05</span>
<span class="cp">#define SPI_STATUS_SPIF		(1 &lt;&lt; 7)</span>
<span class="cp">#define SPI_STATUS_WCOL		(1 &lt;&lt; 6)</span>
<span class="cp">#define SPI_STATUS_MODF		(1 &lt;&lt; 4)</span>

<span class="cp">#define SPI_DATA	0x09</span>
<span class="cp">#define SPI_PORTDATA	0x0d</span>
<span class="cp">#define SPI_DATADIR	0x10</span>

<span class="cm">/* FSM state return values */</span>
<span class="cp">#define FSM_STOP	0	</span><span class="cm">/* Nothing more for the state machine to */</span><span class="cp"></span>
				<span class="cm">/* do.  If something interesting happens */</span>
				<span class="cm">/* then an IRQ will be received */</span>
<span class="cp">#define FSM_POLL	1	</span><span class="cm">/* need to poll for completion, an IRQ is */</span><span class="cp"></span>
				<span class="cm">/* not expected */</span>
<span class="cp">#define FSM_CONTINUE	2	</span><span class="cm">/* Keep iterating the state machine */</span><span class="cp"></span>

<span class="cm">/* Driver internal data */</span>
<span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq0</span><span class="p">;</span>	<span class="cm">/* MODF irq */</span>
	<span class="kt">int</span> <span class="n">irq1</span><span class="p">;</span>	<span class="cm">/* SPIF irq */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipb_freq</span><span class="p">;</span>

	<span class="cm">/* Statistics; not used now, but will be reintroduced for debugfs */</span>
	<span class="kt">int</span> <span class="n">msg_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wcol_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wcol_ticks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wcol_tx_timestamp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modf_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>		<span class="cm">/* queue of pending messages */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>

	<span class="cm">/* Details of current transfer (length, and buffer pointers) */</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>	<span class="cm">/* current message */</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">transfer</span><span class="p">;</span>	<span class="cm">/* current transfer */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">)(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cs_change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_cs_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">gpio_cs</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * CS control function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_spi_chipsel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">;</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">[</span><span class="n">cs</span><span class="p">],</span> <span class="n">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_PORTDATA</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start a new transfer.  This is called both by the idle state</span>
<span class="cm"> * for the first transfer in a message, and by the wait state when the</span>
<span class="cm"> * previous transfer in a message is complete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_spi_start_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Activate the chip select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
		<span class="n">mpc52xx_spi_chipsel</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">cs_change</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">;</span>

	<span class="cm">/* Write out the first byte */</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">wcol_tx_timestamp</span> <span class="o">=</span> <span class="n">get_tbl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="o">++</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Forward declaration of state handlers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpc52xx_spi_fsmstate_transfer</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpc52xx_spi_fsmstate_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * IDLE state</span>
<span class="cm"> *</span>
<span class="cm"> * No transfers are in progress; if another transfer is pending then retrieve</span>
<span class="cm"> * it and kick it off.  Otherwise, stop processing the state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_spi_fsmstate_idle</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spr</span><span class="p">,</span> <span class="n">sppr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spurious irq, status=0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Check if there is another transfer waiting. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FSM_STOP</span><span class="p">;</span>

	<span class="cm">/* get the head of the queue */</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* Setup the controller parameters */</span>
	<span class="n">ctrl1</span> <span class="o">=</span> <span class="n">SPI_CTRL1_SPIE</span> <span class="o">|</span> <span class="n">SPI_CTRL1_SPE</span> <span class="o">|</span> <span class="n">SPI_CTRL1_MSTR</span><span class="p">;</span>
	<span class="n">spi</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CPHA</span><span class="p">)</span>
		<span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">SPI_CTRL1_CPHA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CPOL</span><span class="p">)</span>
		<span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">SPI_CTRL1_CPOL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_LSB_FIRST</span><span class="p">)</span>
		<span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">SPI_CTRL1_LSBFE</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_CTRL1</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">);</span>

	<span class="cm">/* Setup the controller speed */</span>
	<span class="cm">/* minimum divider is &#39;2&#39;.  Also, add &#39;1&#39; to force rounding the</span>
<span class="cm">	 * divider up. */</span>
	<span class="n">sppr</span> <span class="o">=</span> <span class="p">((</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">ipb_freq</span> <span class="o">/</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sppr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sppr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">sppr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sppr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sppr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* add &#39;1&#39; to force rounding up */</span>
		<span class="n">spr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sppr</span><span class="o">--</span><span class="p">;</span>		<span class="cm">/* sppr quantity in register is offset by 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spr</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t overrun limits of SPI baudrate register */</span>
		<span class="n">spr</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">sppr</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_BRR</span><span class="p">,</span> <span class="n">sppr</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">spr</span><span class="p">);</span> <span class="cm">/* Set speed */</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">cs_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span> <span class="n">transfer_list</span><span class="p">);</span>

	<span class="n">mpc52xx_spi_start_transfer</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpc52xx_spi_fsmstate_transfer</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TRANSFER state</span>
<span class="cm"> *</span>
<span class="cm"> * In the middle of a transfer.  If the SPI core has completed processing</span>
<span class="cm"> * a byte, then read out the received data and write out the next byte</span>
<span class="cm"> * (unless this transfer is finished; in which case go on to the wait</span>
<span class="cm"> * state)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_spi_fsmstate_transfer</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span> <span class="o">?</span> <span class="n">FSM_STOP</span> <span class="o">:</span> <span class="n">FSM_POLL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SPI_STATUS_WCOL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The SPI controller is stoopid.  At slower speeds, it may</span>
<span class="cm">		 * raise the SPIF flag before the state machine is actually</span>
<span class="cm">		 * finished, which causes a collision (internal to the state</span>
<span class="cm">		 * machine only).  The manual recommends inserting a delay</span>
<span class="cm">		 * between receiving the interrupt and sending the next byte,</span>
<span class="cm">		 * but it can also be worked around simply by retrying the</span>
<span class="cm">		 * transfer which is what we do here. */</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">wcol_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">wcol_ticks</span> <span class="o">+=</span> <span class="n">get_tbl</span><span class="p">()</span> <span class="o">-</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">wcol_tx_timestamp</span><span class="p">;</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">wcol_tx_timestamp</span> <span class="o">=</span> <span class="n">get_tbl</span><span class="p">();</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span> <span class="cm">/* try again */</span>
		<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SPI_STATUS_MODF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">modf_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mode fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mpc52xx_spi_chipsel</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpc52xx_spi_fsmstate_idle</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read data out of the spi device */</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">byte_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Is the transfer complete? */</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">get_tbl</span><span class="p">();</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">+=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">delay_usecs</span> <span class="o">*</span> <span class="n">tb_ticks_per_usec</span><span class="p">;</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpc52xx_spi_fsmstate_wait</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write out the next byte */</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">wcol_tx_timestamp</span> <span class="o">=</span> <span class="n">get_tbl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="o">++</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * WAIT state</span>
<span class="cm"> *</span>
<span class="cm"> * A transfer has completed; need to wait for the delay period to complete</span>
<span class="cm"> * before starting the next transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_spi_fsmstate_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spurious irq, status=0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">get_tbl</span><span class="p">())</span> <span class="o">-</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FSM_POLL</span><span class="p">;</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Check if there is another transfer in this message.  If there</span>
<span class="cm">	 * aren&#39;t then deactivate CS, notify sender, and drop back to idle</span>
<span class="cm">	 * to start the next message. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mpc52xx_spi_chipsel</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpc52xx_spi_fsmstate_idle</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* There is another transfer; kick it off */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
		<span class="n">mpc52xx_spi_chipsel</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span> <span class="n">transfer_list</span><span class="p">);</span>
	<span class="n">mpc52xx_spi_start_transfer</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpc52xx_spi_fsmstate_transfer</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_spi_fsm_process - Finite State Machine iteration function</span>
<span class="cm"> * @irq: irq number that triggered the FSM or 0 for polling</span>
<span class="cm"> * @ms: pointer to mpc52xx_spi driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_spi_fsm_process</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">FSM_CONTINUE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">FSM_CONTINUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Interrupt cleared by read of STATUS followed by</span>
<span class="cm">		 * read of DATA registers */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_STATUS</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">FSM_POLL</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_spi_irq - IRQ handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mpc52xx_spi_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">_ms</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mpc52xx_spi_fsm_process</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_spi_wq - Workqueue function for polling the state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_spi_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_spi</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mpc52xx_spi_fsm_process</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * spi_master ops</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_spi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SPI_CPOL</span> <span class="o">|</span> <span class="n">SPI_CPHA</span> <span class="o">|</span> <span class="n">SPI_LSB_FIRST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">chip_select</span> <span class="o">&gt;=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_spi_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OF Platform Bus Binding</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mpc52xx_spi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_cs</span><span class="p">;</span>

	<span class="cm">/* MMIO registers */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing mpc5200 SPI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* initialize the device */</span>
	<span class="n">ctrl1</span> <span class="o">=</span> <span class="n">SPI_CTRL1_SPIE</span> <span class="o">|</span> <span class="n">SPI_CTRL1_SPE</span> <span class="o">|</span> <span class="n">SPI_CTRL1_MSTR</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_CTRL1</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_CTRL2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATADIR</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>	<span class="cm">/* Set output pins */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_PORTDATA</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>	<span class="cm">/* Deassert /SS signal */</span>

	<span class="cm">/* Clear the status register and re-read it to check for a MODF</span>
<span class="cm">	 * failure.  This driver cannot currently handle multiple masters</span>
<span class="cm">	 * on the SPI bus.  This fault will also occur if the SPI signals</span>
<span class="cm">	 * are not connected to any pins (port_config setting) */</span>
	<span class="n">in_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_STATUS</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_CTRL1</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">);</span>

	<span class="n">in_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SPI_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SPI_STATUS_MODF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mode fault; is port_config correct?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;allocating spi_master struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">master</span> <span class="o">=</span> <span class="n">spi_alloc_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ms</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">mpc52xx_spi_setup</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">mpc52xx_spi_transfer</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">mode_bits</span> <span class="o">=</span> <span class="n">SPI_CPOL</span> <span class="o">|</span> <span class="n">SPI_CPHA</span> <span class="o">|</span> <span class="n">SPI_LSB_FIRST</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>

	<span class="n">ms</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpc52xx_spi_fsmstate_idle</span><span class="p">;</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">ipb_freq</span> <span class="o">=</span> <span class="n">mpc5xxx_get_bus_frequency</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span> <span class="o">=</span> <span class="n">of_gpio_count</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span><span class="p">;</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio_cs</span> <span class="o">=</span> <span class="n">of_get_gpio</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpio_cs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;could not parse the gpio field &quot;</span>
					<span class="s">&quot;in oftree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_gpio</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio_cs</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;can&#39;t request spi cs gpio #%d &quot;</span>
					<span class="s">&quot;on gpio line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gpio_cs</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_gpio</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">gpio_cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio_cs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">mpc52xx_spi_wq</span><span class="p">);</span>

	<span class="cm">/* Decide if interrupts can be used */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span> <span class="o">&amp;&amp;</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span><span class="p">,</span> <span class="n">mpc52xx_spi_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;mpc5200-spi-modf&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span><span class="p">,</span> <span class="n">mpc52xx_spi_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;mpc5200-spi-spif&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
			<span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* operate in polled mode */</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using polled mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registering spi_master struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">spi_register_master</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered MPC5200 SPI bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

 <span class="nl">err_register:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
 <span class="nl">err_gpio:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">);</span>
 <span class="nl">err_alloc:</span>
 <span class="nl">err_init:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mpc52xx_spi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc52xx_spi</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq0</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">irq1</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">gpio_cs</span><span class="p">);</span>
	<span class="n">spi_unregister_master</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_spi_match</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-spi&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">mpc52xx_spi_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mpc52xx_spi_of_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mpc52xx-spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">mpc52xx_spi_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mpc52xx_spi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mpc52xx_spi_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mpc52xx_spi_of_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
