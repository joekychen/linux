<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › spi › spi-rspi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>spi-rspi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SH RSPI driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2012  Renesas Solutions Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on spi-sh.c:</span>
<span class="cm"> * Copyright (C) 2011 Renesas Solutions Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/sh_dma.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/rspi.h&gt;</span>

<span class="cp">#define RSPI_SPCR		0x00</span>
<span class="cp">#define RSPI_SSLP		0x01</span>
<span class="cp">#define RSPI_SPPCR		0x02</span>
<span class="cp">#define RSPI_SPSR		0x03</span>
<span class="cp">#define RSPI_SPDR		0x04</span>
<span class="cp">#define RSPI_SPSCR		0x08</span>
<span class="cp">#define RSPI_SPSSR		0x09</span>
<span class="cp">#define RSPI_SPBR		0x0a</span>
<span class="cp">#define RSPI_SPDCR		0x0b</span>
<span class="cp">#define RSPI_SPCKD		0x0c</span>
<span class="cp">#define RSPI_SSLND		0x0d</span>
<span class="cp">#define RSPI_SPND		0x0e</span>
<span class="cp">#define RSPI_SPCR2		0x0f</span>
<span class="cp">#define RSPI_SPCMD0		0x10</span>
<span class="cp">#define RSPI_SPCMD1		0x12</span>
<span class="cp">#define RSPI_SPCMD2		0x14</span>
<span class="cp">#define RSPI_SPCMD3		0x16</span>
<span class="cp">#define RSPI_SPCMD4		0x18</span>
<span class="cp">#define RSPI_SPCMD5		0x1a</span>
<span class="cp">#define RSPI_SPCMD6		0x1c</span>
<span class="cp">#define RSPI_SPCMD7		0x1e</span>

<span class="cm">/* SPCR */</span>
<span class="cp">#define SPCR_SPRIE		0x80</span>
<span class="cp">#define SPCR_SPE		0x40</span>
<span class="cp">#define SPCR_SPTIE		0x20</span>
<span class="cp">#define SPCR_SPEIE		0x10</span>
<span class="cp">#define SPCR_MSTR		0x08</span>
<span class="cp">#define SPCR_MODFEN		0x04</span>
<span class="cp">#define SPCR_TXMD		0x02</span>
<span class="cp">#define SPCR_SPMS		0x01</span>

<span class="cm">/* SSLP */</span>
<span class="cp">#define SSLP_SSL1P		0x02</span>
<span class="cp">#define SSLP_SSL0P		0x01</span>

<span class="cm">/* SPPCR */</span>
<span class="cp">#define SPPCR_MOIFE		0x20</span>
<span class="cp">#define SPPCR_MOIFV		0x10</span>
<span class="cp">#define SPPCR_SPOM		0x04</span>
<span class="cp">#define SPPCR_SPLP2		0x02</span>
<span class="cp">#define SPPCR_SPLP		0x01</span>

<span class="cm">/* SPSR */</span>
<span class="cp">#define SPSR_SPRF		0x80</span>
<span class="cp">#define SPSR_SPTEF		0x20</span>
<span class="cp">#define SPSR_PERF		0x08</span>
<span class="cp">#define SPSR_MODF		0x04</span>
<span class="cp">#define SPSR_IDLNF		0x02</span>
<span class="cp">#define SPSR_OVRF		0x01</span>

<span class="cm">/* SPSCR */</span>
<span class="cp">#define SPSCR_SPSLN_MASK	0x07</span>

<span class="cm">/* SPSSR */</span>
<span class="cp">#define SPSSR_SPECM_MASK	0x70</span>
<span class="cp">#define SPSSR_SPCP_MASK		0x07</span>

<span class="cm">/* SPDCR */</span>
<span class="cp">#define SPDCR_SPLW		0x20</span>
<span class="cp">#define SPDCR_SPRDTD		0x10</span>
<span class="cp">#define SPDCR_SLSEL1		0x08</span>
<span class="cp">#define SPDCR_SLSEL0		0x04</span>
<span class="cp">#define SPDCR_SLSEL_MASK	0x0c</span>
<span class="cp">#define SPDCR_SPFC1		0x02</span>
<span class="cp">#define SPDCR_SPFC0		0x01</span>

<span class="cm">/* SPCKD */</span>
<span class="cp">#define SPCKD_SCKDL_MASK	0x07</span>

<span class="cm">/* SSLND */</span>
<span class="cp">#define SSLND_SLNDL_MASK	0x07</span>

<span class="cm">/* SPND */</span>
<span class="cp">#define SPND_SPNDL_MASK		0x07</span>

<span class="cm">/* SPCR2 */</span>
<span class="cp">#define SPCR2_PTE		0x08</span>
<span class="cp">#define SPCR2_SPIE		0x04</span>
<span class="cp">#define SPCR2_SPOE		0x02</span>
<span class="cp">#define SPCR2_SPPE		0x01</span>

<span class="cm">/* SPCMDn */</span>
<span class="cp">#define SPCMD_SCKDEN		0x8000</span>
<span class="cp">#define SPCMD_SLNDEN		0x4000</span>
<span class="cp">#define SPCMD_SPNDEN		0x2000</span>
<span class="cp">#define SPCMD_LSBF		0x1000</span>
<span class="cp">#define SPCMD_SPB_MASK		0x0f00</span>
<span class="cp">#define SPCMD_SPB_8_TO_16(bit)	(((bit - 1) &lt;&lt; 8) &amp; SPCMD_SPB_MASK)</span>
<span class="cp">#define SPCMD_SPB_20BIT		0x0000</span>
<span class="cp">#define SPCMD_SPB_24BIT		0x0100</span>
<span class="cp">#define SPCMD_SPB_32BIT		0x0200</span>
<span class="cp">#define SPCMD_SSLKP		0x0080</span>
<span class="cp">#define SPCMD_SSLA_MASK		0x0030</span>
<span class="cp">#define SPCMD_BRDV_MASK		0x000c</span>
<span class="cp">#define SPCMD_CPOL		0x0002</span>
<span class="cp">#define SPCMD_CPHA		0x0001</span>

<span class="k">struct</span> <span class="n">rspi_data</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_speed_hz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">ws</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spsr</span><span class="p">;</span>

	<span class="cm">/* for dmaengine */</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span> <span class="n">dma_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span> <span class="n">dma_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">dma_width_16bit</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dma_callbacked</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rspi_read8</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">rspi_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">rspi_calc_spbr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spbr</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spbr</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">spbr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">enable</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">disable</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_wait_for_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">wait_mask</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">enable_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">spsr</span> <span class="o">=</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPSR</span><span class="p">);</span>
	<span class="n">rspi_enable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">enable_bit</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">spsr</span> <span class="o">&amp;</span> <span class="n">wait_mask</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">spsr</span> <span class="o">&amp;</span> <span class="n">wait_mask</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_assert_ssl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPCR_SPE</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_negate_ssl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPCR_SPE</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_set_config_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">access_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Sets output mode(CMOS) and MOSI signal(from previous transfer) */</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SPPCR</span><span class="p">);</span>

	<span class="cm">/* Sets transfer bit rate */</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_calc_spbr</span><span class="p">(</span><span class="n">rspi</span><span class="p">),</span> <span class="n">RSPI_SPBR</span><span class="p">);</span>

	<span class="cm">/* Sets number of frames to be used: 1 frame */</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SPDCR</span><span class="p">);</span>

	<span class="cm">/* Sets RSPCK, SSL, next-access delay value */</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SPCKD</span><span class="p">);</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SSLND</span><span class="p">);</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SPND</span><span class="p">);</span>

	<span class="cm">/* Sets parity, interrupt mask */</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SPCR2</span><span class="p">);</span>

	<span class="cm">/* Sets SPCMD */</span>
	<span class="n">rspi_write16</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPCMD_SPB_8_TO_16</span><span class="p">(</span><span class="n">access_size</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPCMD_SSLKP</span><span class="p">,</span>
		     <span class="n">RSPI_SPCMD0</span><span class="p">);</span>

	<span class="cm">/* Sets RSPI mode */</span>
	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPCR_MSTR</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_send_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">remain</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPCR_TXMD</span><span class="p">,</span>
			    <span class="n">RSPI_SPCR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rspi_wait_for_interrupt</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPSR_SPTEF</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: tx empty timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rspi_write16</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">RSPI_SPDR</span><span class="p">);</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">remain</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Waiting for the last transmition */</span>
	<span class="n">rspi_wait_for_interrupt</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPSR_SPTEF</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_dma_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_dma_map_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_buf</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_dma_unmap_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_memory_to_8bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_memory_from_8bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_send_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_width_16bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If DMAC bus width is 16-bit, the driver allocates a dummy</span>
<span class="cm">		 * buffer. And, the driver converts original data into the</span>
<span class="cm">		 * DMAC data as the following format:</span>
<span class="cm">		 *  original data: 1st byte, 2nd byte ...</span>
<span class="cm">		 *  DMAC data:     1st byte, dummy, 2nd byte, dummy ...</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">rspi_memory_to_8bit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspi_dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end_nomap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
				       <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMAC needs SPTIE, but if SPTIE is set, this IRQ routine will be</span>
<span class="cm">	 * called. So, this driver disables the IRQ while DMA transfer.</span>
<span class="cm">	 */</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPCR_TXMD</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>
	<span class="n">rspi_enable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span><span class="p">);</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">rspi_dma_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">rspi</span><span class="p">;</span>
	<span class="n">dmaengine_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					       <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="n">rspi_disable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">rspi_dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="nl">end_nomap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_width_16bit</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_receive_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spsr</span><span class="p">;</span>

	<span class="n">spsr</span> <span class="o">=</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spsr</span> <span class="o">&amp;</span> <span class="n">SPSR_SPRF</span><span class="p">)</span>
		<span class="n">rspi_read16</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPDR</span><span class="p">);</span>	<span class="cm">/* dummy read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spsr</span> <span class="o">&amp;</span> <span class="n">SPSR_OVRF</span><span class="p">)</span>
		<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPSR_OVRF</span><span class="p">,</span>
			    <span class="n">RSPI_SPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_receive_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">remain</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">rspi_receive_init</span><span class="p">(</span><span class="n">rspi</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPCR_TXMD</span><span class="p">,</span>
			    <span class="n">RSPI_SPCR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rspi_wait_for_interrupt</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPSR_SPTEF</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: tx empty timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* dummy write for generate clock */</span>
		<span class="n">rspi_write16</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">RSPI_SPDR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rspi_wait_for_interrupt</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPSR_SPRF</span><span class="p">,</span> <span class="n">SPCR_SPRIE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: receive timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* SPDR allows 16 or 32-bit access only */</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rspi_read16</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPDR</span><span class="p">);</span>

		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">remain</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_receive_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_dummy</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">desc_dummy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_width_16bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If DMAC bus width is 16-bit, the driver allocates a dummy</span>
<span class="cm">		 * buffer. And, finally the driver converts the DMAC data into</span>
<span class="cm">		 * actual data as the following format:</span>
<span class="cm">		 *  DMAC data:   1st byte, dummy, 2nd byte, dummy ...</span>
<span class="cm">		 *  actual data: 1st byte, 2nd byte ...</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">rx_buf</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare dummy transfer to generate SPI clocks */</span>
	<span class="n">dummy</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dummy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end_nomap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspi_dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg_dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span>
			     <span class="n">DMA_TO_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end_nomap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc_dummy</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg_dummy</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_dummy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end_dummy_mapped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare receive transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspi_dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">rx_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">,</span>
			     <span class="n">DMA_FROM_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end_dummy_mapped</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
				       <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rspi_receive_init</span><span class="p">(</span><span class="n">rspi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMAC needs SPTIE, but if SPTIE is set, this IRQ routine will be</span>
<span class="cm">	 * called. So, this driver disables the IRQ while DMA transfer.</span>
<span class="cm">	 */</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">rspi_write8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPCR_TXMD</span><span class="p">,</span> <span class="n">RSPI_SPCR</span><span class="p">);</span>
	<span class="n">rspi_enable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span> <span class="o">|</span> <span class="n">SPCR_SPRIE</span><span class="p">);</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">rspi_dma_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">rspi</span><span class="p">;</span>
	<span class="n">dmaengine_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">);</span>

	<span class="n">desc_dummy</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* No callback */</span>
	<span class="n">dmaengine_submit</span><span class="p">(</span><span class="n">desc_dummy</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					       <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_callbacked</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="n">rspi_disable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">SPCR_SPTIE</span> <span class="o">|</span> <span class="n">SPCR_SPRIE</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">rspi_dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="nl">end_dummy_mapped:</span>
	<span class="n">rspi_dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg_dummy</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="nl">end_nomap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_width_16bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">rspi_memory_from_8bit</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">rx_buf</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rx_buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_is_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">&amp;&amp;</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* If the module receives data by DMAC, it also needs TX DMAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">&amp;&amp;</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">&amp;&amp;</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rspi_data</span><span class="p">,</span> <span class="n">ws</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mesg</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">rspi_assert_ssl</span><span class="p">(</span><span class="n">rspi</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mesg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">,</span> <span class="n">transfer_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rspi_is_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">rspi_send_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">rspi_send_pio</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rspi_is_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">rspi_receive_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">rspi_receive_pio</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rspi_negate_ssl</span><span class="p">(</span><span class="n">rspi</span><span class="p">);</span>

		<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">mesg</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">mesg</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">)</span>
		<span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">;</span>

	<span class="n">rspi_set_config_register</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rspi_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mesg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mesg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">ws</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rspi_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">rspi_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="p">)</span><span class="n">_sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spsr</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">disable_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">spsr</span> <span class="o">=</span> <span class="n">spsr</span> <span class="o">=</span> <span class="n">rspi_read8</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">RSPI_SPSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spsr</span> <span class="o">&amp;</span> <span class="n">SPSR_SPRF</span><span class="p">)</span>
		<span class="n">disable_irq</span> <span class="o">|=</span> <span class="n">SPCR_SPRIE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spsr</span> <span class="o">&amp;</span> <span class="n">SPSR_SPTEF</span><span class="p">)</span>
		<span class="n">disable_irq</span> <span class="o">|=</span> <span class="n">SPCR_SPTIE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">rspi_disable_irq</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">disable_irq</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rspi_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">filter_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">filter_param</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">rspi_request_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_plat_data</span> <span class="o">*</span><span class="n">rspi_pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspi_pd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_width_16bit</span> <span class="o">=</span> <span class="n">rspi_pd</span><span class="o">-&gt;</span><span class="n">dma_width_16bit</span><span class="p">;</span>

	<span class="cm">/* If the module receives data by DMAC, it also needs TX DMAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi_pd</span><span class="o">-&gt;</span><span class="n">dma_rx_id</span> <span class="o">&amp;&amp;</span> <span class="n">rspi_pd</span><span class="o">-&gt;</span><span class="n">dma_tx_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_rx</span><span class="p">.</span><span class="n">slave_id</span> <span class="o">=</span> <span class="n">rspi_pd</span><span class="o">-&gt;</span><span class="n">dma_rx_id</span><span class="p">;</span>
		<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">rspi_filter</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Use DMA when rx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi_pd</span><span class="o">-&gt;</span><span class="n">dma_tx_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_tx</span><span class="p">.</span><span class="n">slave_id</span> <span class="o">=</span> <span class="n">rspi_pd</span><span class="o">-&gt;</span><span class="n">dma_tx_id</span><span class="p">;</span>
		<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">rspi_filter</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">dma_tx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Use DMA when tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rspi_release_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">rspi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spi_unregister_master</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="n">rspi_release_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rspi</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rspi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rspi_data</span> <span class="o">*</span><span class="n">rspi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">clk_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* get base addr */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform_get_irq error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">spi_alloc_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rspi_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spi_alloc_master error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rspi</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rspi</span><span class="p">);</span>

	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">clk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clk_name</span><span class="p">),</span> <span class="s">&quot;rspi%d&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">clk_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">ws</span><span class="p">,</span> <span class="n">rspi_work</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">rspi_setup</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">rspi_transfer</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">rspi_cleanup</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">rspi_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rspi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">rspi_request_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_register_master</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spi_register_master error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error4:</span>
	<span class="n">rspi_release_dma</span><span class="p">(</span><span class="n">rspi</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">rspi</span><span class="p">);</span>
<span class="nl">error3:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">error2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="nl">error1:</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">rspi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">rspi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">rspi_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rspi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">rspi_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Renesas RSPI bus driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yoshihiro Shimoda&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:rspi&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
