<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › spi › spi-pl022.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>spi-pl022.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * A driver for the ARM PL022 PrimeCell SSP/SPI bus master.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008-2009 ST-Ericsson AB</span>
<span class="cm"> * Copyright (C) 2006 STMicroelectronics Pvt. Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Linus Walleij &lt;linus.walleij@stericsson.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Initial version inspired by:</span>
<span class="cm"> *	linux-2.6.17-rc3-mm1/drivers/spi/pxa2xx_spi.c</span>
<span class="cm"> * Initial adoption to PL022 by:</span>
<span class="cm"> *      Sachin Verma &lt;sachin.verma@st.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;linux/amba/pl022.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * This macro is used to define some register default values.</span>
<span class="cm"> * reg is masked with mask, the OR:ed with an (again masked)</span>
<span class="cm"> * val shifted sb steps to the left.</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_WRITE_BITS(reg, val, mask, sb) \</span>
<span class="cp"> ((reg) = (((reg) &amp; ~(mask)) | (((val)&lt;&lt;(sb)) &amp; (mask))))</span>

<span class="cm">/*</span>
<span class="cm"> * This macro is also used to define some default values.</span>
<span class="cm"> * It will just shift val by sb steps to the left and mask</span>
<span class="cm"> * the result with mask.</span>
<span class="cm"> */</span>
<span class="cp">#define GEN_MASK_BITS(val, mask, sb) \</span>
<span class="cp"> (((val)&lt;&lt;(sb)) &amp; (mask))</span>

<span class="cp">#define DRIVE_TX		0</span>
<span class="cp">#define DO_NOT_DRIVE_TX		1</span>

<span class="cp">#define DO_NOT_QUEUE_DMA	0</span>
<span class="cp">#define QUEUE_DMA		1</span>

<span class="cp">#define RX_TRANSFER		1</span>
<span class="cp">#define TX_TRANSFER		2</span>

<span class="cm">/*</span>
<span class="cm"> * Macros to access SSP Registers with their offsets</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_CR0(r)	(r + 0x000)</span>
<span class="cp">#define SSP_CR1(r)	(r + 0x004)</span>
<span class="cp">#define SSP_DR(r)	(r + 0x008)</span>
<span class="cp">#define SSP_SR(r)	(r + 0x00C)</span>
<span class="cp">#define SSP_CPSR(r)	(r + 0x010)</span>
<span class="cp">#define SSP_IMSC(r)	(r + 0x014)</span>
<span class="cp">#define SSP_RIS(r)	(r + 0x018)</span>
<span class="cp">#define SSP_MIS(r)	(r + 0x01C)</span>
<span class="cp">#define SSP_ICR(r)	(r + 0x020)</span>
<span class="cp">#define SSP_DMACR(r)	(r + 0x024)</span>
<span class="cp">#define SSP_ITCR(r)	(r + 0x080)</span>
<span class="cp">#define SSP_ITIP(r)	(r + 0x084)</span>
<span class="cp">#define SSP_ITOP(r)	(r + 0x088)</span>
<span class="cp">#define SSP_TDR(r)	(r + 0x08C)</span>

<span class="cp">#define SSP_PID0(r)	(r + 0xFE0)</span>
<span class="cp">#define SSP_PID1(r)	(r + 0xFE4)</span>
<span class="cp">#define SSP_PID2(r)	(r + 0xFE8)</span>
<span class="cp">#define SSP_PID3(r)	(r + 0xFEC)</span>

<span class="cp">#define SSP_CID0(r)	(r + 0xFF0)</span>
<span class="cp">#define SSP_CID1(r)	(r + 0xFF4)</span>
<span class="cp">#define SSP_CID2(r)	(r + 0xFF8)</span>
<span class="cp">#define SSP_CID3(r)	(r + 0xFFC)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Control Register 0  - SSP_CR0</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_CR0_MASK_DSS	(0x0FUL &lt;&lt; 0)</span>
<span class="cp">#define SSP_CR0_MASK_FRF	(0x3UL &lt;&lt; 4)</span>
<span class="cp">#define SSP_CR0_MASK_SPO	(0x1UL &lt;&lt; 6)</span>
<span class="cp">#define SSP_CR0_MASK_SPH	(0x1UL &lt;&lt; 7)</span>
<span class="cp">#define SSP_CR0_MASK_SCR	(0xFFUL &lt;&lt; 8)</span>

<span class="cm">/*</span>
<span class="cm"> * The ST version of this block moves som bits</span>
<span class="cm"> * in SSP_CR0 and extends it to 32 bits</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_CR0_MASK_DSS_ST	(0x1FUL &lt;&lt; 0)</span>
<span class="cp">#define SSP_CR0_MASK_HALFDUP_ST	(0x1UL &lt;&lt; 5)</span>
<span class="cp">#define SSP_CR0_MASK_CSS_ST	(0x1FUL &lt;&lt; 16)</span>
<span class="cp">#define SSP_CR0_MASK_FRF_ST	(0x3UL &lt;&lt; 21)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Control Register 0  - SSP_CR1</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_CR1_MASK_LBM	(0x1UL &lt;&lt; 0)</span>
<span class="cp">#define SSP_CR1_MASK_SSE	(0x1UL &lt;&lt; 1)</span>
<span class="cp">#define SSP_CR1_MASK_MS		(0x1UL &lt;&lt; 2)</span>
<span class="cp">#define SSP_CR1_MASK_SOD	(0x1UL &lt;&lt; 3)</span>

<span class="cm">/*</span>
<span class="cm"> * The ST version of this block adds some bits</span>
<span class="cm"> * in SSP_CR1</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_CR1_MASK_RENDN_ST	(0x1UL &lt;&lt; 4)</span>
<span class="cp">#define SSP_CR1_MASK_TENDN_ST	(0x1UL &lt;&lt; 5)</span>
<span class="cp">#define SSP_CR1_MASK_MWAIT_ST	(0x1UL &lt;&lt; 6)</span>
<span class="cp">#define SSP_CR1_MASK_RXIFLSEL_ST (0x7UL &lt;&lt; 7)</span>
<span class="cp">#define SSP_CR1_MASK_TXIFLSEL_ST (0x7UL &lt;&lt; 10)</span>
<span class="cm">/* This one is only in the PL023 variant */</span>
<span class="cp">#define SSP_CR1_MASK_FBCLKDEL_ST (0x7UL &lt;&lt; 13)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Status Register - SSP_SR</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_SR_MASK_TFE		(0x1UL &lt;&lt; 0) </span><span class="cm">/* Transmit FIFO empty */</span><span class="cp"></span>
<span class="cp">#define SSP_SR_MASK_TNF		(0x1UL &lt;&lt; 1) </span><span class="cm">/* Transmit FIFO not full */</span><span class="cp"></span>
<span class="cp">#define SSP_SR_MASK_RNE		(0x1UL &lt;&lt; 2) </span><span class="cm">/* Receive FIFO not empty */</span><span class="cp"></span>
<span class="cp">#define SSP_SR_MASK_RFF		(0x1UL &lt;&lt; 3) </span><span class="cm">/* Receive FIFO full */</span><span class="cp"></span>
<span class="cp">#define SSP_SR_MASK_BSY		(0x1UL &lt;&lt; 4) </span><span class="cm">/* Busy Flag */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * SSP Clock Prescale Register  - SSP_CPSR</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_CPSR_MASK_CPSDVSR	(0xFFUL &lt;&lt; 0)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Interrupt Mask Set/Clear Register - SSP_IMSC</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_IMSC_MASK_RORIM (0x1UL &lt;&lt; 0) </span><span class="cm">/* Receive Overrun Interrupt mask */</span><span class="cp"></span>
<span class="cp">#define SSP_IMSC_MASK_RTIM  (0x1UL &lt;&lt; 1) </span><span class="cm">/* Receive timeout Interrupt mask */</span><span class="cp"></span>
<span class="cp">#define SSP_IMSC_MASK_RXIM  (0x1UL &lt;&lt; 2) </span><span class="cm">/* Receive FIFO Interrupt mask */</span><span class="cp"></span>
<span class="cp">#define SSP_IMSC_MASK_TXIM  (0x1UL &lt;&lt; 3) </span><span class="cm">/* Transmit FIFO Interrupt mask */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * SSP Raw Interrupt Status Register - SSP_RIS</span>
<span class="cm"> */</span>
<span class="cm">/* Receive Overrun Raw Interrupt status */</span>
<span class="cp">#define SSP_RIS_MASK_RORRIS		(0x1UL &lt;&lt; 0)</span>
<span class="cm">/* Receive Timeout Raw Interrupt status */</span>
<span class="cp">#define SSP_RIS_MASK_RTRIS		(0x1UL &lt;&lt; 1)</span>
<span class="cm">/* Receive FIFO Raw Interrupt status */</span>
<span class="cp">#define SSP_RIS_MASK_RXRIS		(0x1UL &lt;&lt; 2)</span>
<span class="cm">/* Transmit FIFO Raw Interrupt status */</span>
<span class="cp">#define SSP_RIS_MASK_TXRIS		(0x1UL &lt;&lt; 3)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Masked Interrupt Status Register - SSP_MIS</span>
<span class="cm"> */</span>
<span class="cm">/* Receive Overrun Masked Interrupt status */</span>
<span class="cp">#define SSP_MIS_MASK_RORMIS		(0x1UL &lt;&lt; 0)</span>
<span class="cm">/* Receive Timeout Masked Interrupt status */</span>
<span class="cp">#define SSP_MIS_MASK_RTMIS		(0x1UL &lt;&lt; 1)</span>
<span class="cm">/* Receive FIFO Masked Interrupt status */</span>
<span class="cp">#define SSP_MIS_MASK_RXMIS		(0x1UL &lt;&lt; 2)</span>
<span class="cm">/* Transmit FIFO Masked Interrupt status */</span>
<span class="cp">#define SSP_MIS_MASK_TXMIS		(0x1UL &lt;&lt; 3)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Interrupt Clear Register - SSP_ICR</span>
<span class="cm"> */</span>
<span class="cm">/* Receive Overrun Raw Clear Interrupt bit */</span>
<span class="cp">#define SSP_ICR_MASK_RORIC		(0x1UL &lt;&lt; 0)</span>
<span class="cm">/* Receive Timeout Clear Interrupt bit */</span>
<span class="cp">#define SSP_ICR_MASK_RTIC		(0x1UL &lt;&lt; 1)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP DMA Control Register - SSP_DMACR</span>
<span class="cm"> */</span>
<span class="cm">/* Receive DMA Enable bit */</span>
<span class="cp">#define SSP_DMACR_MASK_RXDMAE		(0x1UL &lt;&lt; 0)</span>
<span class="cm">/* Transmit DMA Enable bit */</span>
<span class="cp">#define SSP_DMACR_MASK_TXDMAE		(0x1UL &lt;&lt; 1)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Integration Test control Register - SSP_ITCR</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_ITCR_MASK_ITEN		(0x1UL &lt;&lt; 0)</span>
<span class="cp">#define SSP_ITCR_MASK_TESTFIFO		(0x1UL &lt;&lt; 1)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Integration Test Input Register - SSP_ITIP</span>
<span class="cm"> */</span>
<span class="cp">#define ITIP_MASK_SSPRXD		 (0x1UL &lt;&lt; 0)</span>
<span class="cp">#define ITIP_MASK_SSPFSSIN		 (0x1UL &lt;&lt; 1)</span>
<span class="cp">#define ITIP_MASK_SSPCLKIN		 (0x1UL &lt;&lt; 2)</span>
<span class="cp">#define ITIP_MASK_RXDMAC		 (0x1UL &lt;&lt; 3)</span>
<span class="cp">#define ITIP_MASK_TXDMAC		 (0x1UL &lt;&lt; 4)</span>
<span class="cp">#define ITIP_MASK_SSPTXDIN		 (0x1UL &lt;&lt; 5)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Integration Test output Register - SSP_ITOP</span>
<span class="cm"> */</span>
<span class="cp">#define ITOP_MASK_SSPTXD		 (0x1UL &lt;&lt; 0)</span>
<span class="cp">#define ITOP_MASK_SSPFSSOUT		 (0x1UL &lt;&lt; 1)</span>
<span class="cp">#define ITOP_MASK_SSPCLKOUT		 (0x1UL &lt;&lt; 2)</span>
<span class="cp">#define ITOP_MASK_SSPOEn		 (0x1UL &lt;&lt; 3)</span>
<span class="cp">#define ITOP_MASK_SSPCTLOEn		 (0x1UL &lt;&lt; 4)</span>
<span class="cp">#define ITOP_MASK_RORINTR		 (0x1UL &lt;&lt; 5)</span>
<span class="cp">#define ITOP_MASK_RTINTR		 (0x1UL &lt;&lt; 6)</span>
<span class="cp">#define ITOP_MASK_RXINTR		 (0x1UL &lt;&lt; 7)</span>
<span class="cp">#define ITOP_MASK_TXINTR		 (0x1UL &lt;&lt; 8)</span>
<span class="cp">#define ITOP_MASK_INTR			 (0x1UL &lt;&lt; 9)</span>
<span class="cp">#define ITOP_MASK_RXDMABREQ		 (0x1UL &lt;&lt; 10)</span>
<span class="cp">#define ITOP_MASK_RXDMASREQ		 (0x1UL &lt;&lt; 11)</span>
<span class="cp">#define ITOP_MASK_TXDMABREQ		 (0x1UL &lt;&lt; 12)</span>
<span class="cp">#define ITOP_MASK_TXDMASREQ		 (0x1UL &lt;&lt; 13)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Test Data Register - SSP_TDR</span>
<span class="cm"> */</span>
<span class="cp">#define TDR_MASK_TESTDATA		(0xFFFFFFFF)</span>

<span class="cm">/*</span>
<span class="cm"> * Message State</span>
<span class="cm"> * we use the spi_message.state (void *) pointer to</span>
<span class="cm"> * hold a single state value, that&#39;s why all this</span>
<span class="cm"> * (void *) casting is done here.</span>
<span class="cm"> */</span>
<span class="cp">#define STATE_START			((void *) 0)</span>
<span class="cp">#define STATE_RUNNING			((void *) 1)</span>
<span class="cp">#define STATE_DONE			((void *) 2)</span>
<span class="cp">#define STATE_ERROR			((void *) -1)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP State - Whether Enabled or Disabled</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_DISABLED			(0)</span>
<span class="cp">#define SSP_ENABLED			(1)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP DMA State - Whether DMA Enabled or Disabled</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_DMA_DISABLED		(0)</span>
<span class="cp">#define SSP_DMA_ENABLED			(1)</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Clock Defaults</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_DEFAULT_CLKRATE 0x2</span>
<span class="cp">#define SSP_DEFAULT_PRESCALE 0x40</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Clock Parameter ranges</span>
<span class="cm"> */</span>
<span class="cp">#define CPSDVR_MIN 0x02</span>
<span class="cp">#define CPSDVR_MAX 0xFE</span>
<span class="cp">#define SCR_MIN 0x00</span>
<span class="cp">#define SCR_MAX 0xFF</span>

<span class="cm">/*</span>
<span class="cm"> * SSP Interrupt related Macros</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_SSP_REG_IMSC  0x0UL</span>
<span class="cp">#define DISABLE_ALL_INTERRUPTS DEFAULT_SSP_REG_IMSC</span>
<span class="cp">#define ENABLE_ALL_INTERRUPTS (~DEFAULT_SSP_REG_IMSC)</span>

<span class="cp">#define CLEAR_ALL_INTERRUPTS  0x3</span>

<span class="cp">#define SPI_POLLING_TIMEOUT 1000</span>

<span class="cm">/*</span>
<span class="cm"> * The type of reading going on on this chip</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ssp_reading</span> <span class="p">{</span>
	<span class="n">READING_NULL</span><span class="p">,</span>
	<span class="n">READING_U8</span><span class="p">,</span>
	<span class="n">READING_U16</span><span class="p">,</span>
	<span class="n">READING_U32</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * The type of writing going on on this chip</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ssp_writing</span> <span class="p">{</span>
	<span class="n">WRITING_NULL</span><span class="p">,</span>
	<span class="n">WRITING_U8</span><span class="p">,</span>
	<span class="n">WRITING_U16</span><span class="p">,</span>
	<span class="n">WRITING_U32</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct vendor_data - vendor-specific config parameters</span>
<span class="cm"> * for PL022 derivates</span>
<span class="cm"> * @fifodepth: depth of FIFOs (both)</span>
<span class="cm"> * @max_bpw: maximum number of bits per word</span>
<span class="cm"> * @unidir: supports unidirection transfers</span>
<span class="cm"> * @extended_cr: 32 bit wide control register 0 with extra</span>
<span class="cm"> * features and extra features in CR1 as found in the ST variants</span>
<span class="cm"> * @pl023: supports a subset of the ST extensions called &quot;PL023&quot;</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">vendor_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">fifodepth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_bpw</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">unidir</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">extended_cr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pl023</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">loopback</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct pl022 - This is the private SSP driver data structure</span>
<span class="cm"> * @adev: AMBA device model hookup</span>
<span class="cm"> * @vendor: vendor data for the IP block</span>
<span class="cm"> * @phybase: the physical memory where the SSP device resides</span>
<span class="cm"> * @virtbase: the virtual memory where the SSP is mapped</span>
<span class="cm"> * @clk: outgoing clock &quot;SPICLK&quot; for the SPI bus</span>
<span class="cm"> * @master: SPI framework hookup</span>
<span class="cm"> * @master_info: controller-specific data from machine setup</span>
<span class="cm"> * @kworker: thread struct for message pump</span>
<span class="cm"> * @kworker_task: pointer to task for message pump kworker thread</span>
<span class="cm"> * @pump_messages: work struct for scheduling work to the message pump</span>
<span class="cm"> * @queue_lock: spinlock to syncronise access to message queue</span>
<span class="cm"> * @queue: message queue</span>
<span class="cm"> * @busy: message pump is busy</span>
<span class="cm"> * @running: message pump is running</span>
<span class="cm"> * @pump_transfers: Tasklet used in Interrupt Transfer mode</span>
<span class="cm"> * @cur_msg: Pointer to current spi_message being processed</span>
<span class="cm"> * @cur_transfer: Pointer to current spi_transfer</span>
<span class="cm"> * @cur_chip: pointer to current clients chip(assigned from controller_state)</span>
<span class="cm"> * @next_msg_cs_active: the next message in the queue has been examined</span>
<span class="cm"> *  and it was found that it uses the same chip select as the previous</span>
<span class="cm"> *  message, so we left it active after the previous transfer, and it&#39;s</span>
<span class="cm"> *  active already.</span>
<span class="cm"> * @tx: current position in TX buffer to be read</span>
<span class="cm"> * @tx_end: end position in TX buffer to be read</span>
<span class="cm"> * @rx: current position in RX buffer to be written</span>
<span class="cm"> * @rx_end: end position in RX buffer to be written</span>
<span class="cm"> * @read: the type of read currently going on</span>
<span class="cm"> * @write: the type of write currently going on</span>
<span class="cm"> * @exp_fifo_level: expected FIFO level</span>
<span class="cm"> * @dma_rx_channel: optional channel for RX DMA</span>
<span class="cm"> * @dma_tx_channel: optional channel for TX DMA</span>
<span class="cm"> * @sgt_rx: scattertable for the RX transfer</span>
<span class="cm"> * @sgt_tx: scattertable for the TX transfer</span>
<span class="cm"> * @dummypage: a dummy page used for driving data on the bus with DMA</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pl022</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">amba_device</span>		<span class="o">*</span><span class="n">adev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vendor_data</span>		<span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">resource_size_t</span>			<span class="n">phybase</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">virtbase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_master</span>		<span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl022_ssp_controller</span>	<span class="o">*</span><span class="n">master_info</span><span class="p">;</span>
	<span class="cm">/* Message per-transfer pump */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">pump_transfers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span>		<span class="o">*</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span>		<span class="o">*</span><span class="n">cur_transfer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chip_data</span>		<span class="o">*</span><span class="n">cur_chip</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">next_msg_cs_active</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">tx_end</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">rx</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">rx_end</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssp_reading</span>		<span class="n">read</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssp_writing</span>		<span class="n">write</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">exp_fifo_level</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssp_rx_level_trig</span>		<span class="n">rx_lev_trig</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssp_tx_level_trig</span>		<span class="n">tx_lev_trig</span><span class="p">;</span>
	<span class="cm">/* DMA settings */</span>
<span class="cp">#ifdef CONFIG_DMA_ENGINE</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">dma_rx_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">dma_tx_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sg_table</span>			<span class="n">sgt_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sg_table</span>			<span class="n">sgt_tx</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">dummypage</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">dma_running</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct chip_data - To maintain runtime state of SSP for each client chip</span>
<span class="cm"> * @cr0: Value of control register CR0 of SSP - on later ST variants this</span>
<span class="cm"> *       register is 32 bits wide rather than just 16</span>
<span class="cm"> * @cr1: Value of control register CR1 of SSP</span>
<span class="cm"> * @dmacr: Value of DMA control Register of SSP</span>
<span class="cm"> * @cpsr: Value of Clock prescale register</span>
<span class="cm"> * @n_bytes: how many bytes(power of 2) reqd for a given data width of client</span>
<span class="cm"> * @enable_dma: Whether to enable DMA or not</span>
<span class="cm"> * @read: function ptr to be used to read when doing xfer for this chip</span>
<span class="cm"> * @write: function ptr to be used to write when doing xfer for this chip</span>
<span class="cm"> * @cs_control: chip select callback provided by chip</span>
<span class="cm"> * @xfer_type: polling/interrupt/DMA</span>
<span class="cm"> *</span>
<span class="cm"> * Runtime state of the SSP controller, maintained per chip,</span>
<span class="cm"> * This would be set according to the current message that would be served</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">chip_data</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cr0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cr1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dmacr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cpsr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n_bytes</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enable_dma</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssp_reading</span> <span class="n">read</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssp_writing</span> <span class="n">write</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cs_control</span><span class="p">)</span> <span class="p">(</span><span class="n">u32</span> <span class="n">command</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">xfer_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * null_cs_control - Dummy chip select function</span>
<span class="cm"> * @command: select/delect the chip</span>
<span class="cm"> *</span>
<span class="cm"> * If no chip select function is provided by client this is used as dummy</span>
<span class="cm"> * chip select</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">null_cs_control</span><span class="p">(</span><span class="n">u32</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pl022: dummy chip select control, CS=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * giveback - current spi_message is over, schedule next message and call</span>
<span class="cm"> * callback of this message. Assumes that caller already</span>
<span class="cm"> * set message-&gt;status; dma and pio irqs are blocked</span>
<span class="cm"> * @pl022: SSP driver private data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">giveback</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">last_transfer</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">next_msg_cs_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">last_transfer</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span>
					<span class="n">transfer_list</span><span class="p">);</span>

	<span class="cm">/* Delay if requested before any change in chip select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_transfer</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: This runs in interrupt context.</span>
<span class="cm">		 * Is this really smart?</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">last_transfer</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">next_msg</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * cs_change was not set. We can keep the chip select</span>
<span class="cm">		 * enabled if there is message in the queue and it is</span>
<span class="cm">		 * for the same spi device.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We cannot postpone this until pump_messages, because</span>
<span class="cm">		 * after calling msg-&gt;complete (below) the driver that</span>
<span class="cm">		 * sent the current message could be unloaded, which</span>
<span class="cm">		 * could invalidate the cs_control() callback...</span>
<span class="cm">		 */</span>
		<span class="cm">/* get a pointer to the next message, if any */</span>
		<span class="n">next_msg</span> <span class="o">=</span> <span class="n">spi_get_next_queued_message</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * see if the next and current messages point</span>
<span class="cm">		 * to the same spi device.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_msg</span> <span class="o">&amp;&amp;</span> <span class="n">next_msg</span><span class="o">-&gt;</span><span class="n">spi</span> <span class="o">!=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">)</span>
			<span class="n">next_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_msg</span> <span class="o">||</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_ERROR</span><span class="p">)</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_DESELECT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">next_msg_cs_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spi_finalize_current_message</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * flush - flush the FIFO to reach a clean state</span>
<span class="cm"> * @pl022: SSP driver private data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">loops_per_jiffy</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;flush</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_SR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SSP_SR_MASK_RNE</span><span class="p">)</span>
			<span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_SR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SSP_SR_MASK_BSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">);</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">exp_fifo_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * restore_state - Load configuration of current chip</span>
<span class="cm"> * @pl022: SSP driver private data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">restore_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">extended_cr</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">SSP_CR0</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">SSP_CR0</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">SSP_DMACR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cpsr</span><span class="p">,</span> <span class="n">SSP_CPSR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">DISABLE_ALL_INTERRUPTS</span><span class="p">,</span> <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CLEAR_ALL_INTERRUPTS</span><span class="p">,</span> <span class="n">SSP_ICR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Default SSP Register Values</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_SSP_REG_CR0 ( \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DATA_BITS_12, SSP_CR0_MASK_DSS, 0)	| \</span>
<span class="cp">	GEN_MASK_BITS(SSP_INTERFACE_MOTOROLA_SPI, SSP_CR0_MASK_FRF, 4) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_CLK_POL_IDLE_LOW, SSP_CR0_MASK_SPO, 6) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_CLK_SECOND_EDGE, SSP_CR0_MASK_SPH, 7) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DEFAULT_CLKRATE, SSP_CR0_MASK_SCR, 8) \</span>
<span class="cp">)</span>

<span class="cm">/* ST versions have slightly different bit layout */</span>
<span class="cp">#define DEFAULT_SSP_REG_CR0_ST ( \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DATA_BITS_12, SSP_CR0_MASK_DSS_ST, 0)	| \</span>
<span class="cp">	GEN_MASK_BITS(SSP_MICROWIRE_CHANNEL_FULL_DUPLEX, SSP_CR0_MASK_HALFDUP_ST, 5) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_CLK_POL_IDLE_LOW, SSP_CR0_MASK_SPO, 6) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_CLK_SECOND_EDGE, SSP_CR0_MASK_SPH, 7) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DEFAULT_CLKRATE, SSP_CR0_MASK_SCR, 8) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_BITS_8, SSP_CR0_MASK_CSS_ST, 16)	| \</span>
<span class="cp">	GEN_MASK_BITS(SSP_INTERFACE_MOTOROLA_SPI, SSP_CR0_MASK_FRF_ST, 21) \</span>
<span class="cp">)</span>

<span class="cm">/* The PL023 version is slightly different again */</span>
<span class="cp">#define DEFAULT_SSP_REG_CR0_ST_PL023 ( \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DATA_BITS_12, SSP_CR0_MASK_DSS_ST, 0)	| \</span>
<span class="cp">	GEN_MASK_BITS(SSP_CLK_POL_IDLE_LOW, SSP_CR0_MASK_SPO, 6) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_CLK_SECOND_EDGE, SSP_CR0_MASK_SPH, 7) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DEFAULT_CLKRATE, SSP_CR0_MASK_SCR, 8) \</span>
<span class="cp">)</span>

<span class="cp">#define DEFAULT_SSP_REG_CR1 ( \</span>
<span class="cp">	GEN_MASK_BITS(LOOPBACK_DISABLED, SSP_CR1_MASK_LBM, 0) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DISABLED, SSP_CR1_MASK_SSE, 1) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_MASTER, SSP_CR1_MASK_MS, 2) | \</span>
<span class="cp">	GEN_MASK_BITS(DO_NOT_DRIVE_TX, SSP_CR1_MASK_SOD, 3) \</span>
<span class="cp">)</span>

<span class="cm">/* ST versions extend this register to use all 16 bits */</span>
<span class="cp">#define DEFAULT_SSP_REG_CR1_ST ( \</span>
<span class="cp">	DEFAULT_SSP_REG_CR1 | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_RX_MSB, SSP_CR1_MASK_RENDN_ST, 4) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_TX_MSB, SSP_CR1_MASK_TENDN_ST, 5) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_MWIRE_WAIT_ZERO, SSP_CR1_MASK_MWAIT_ST, 6) |\</span>
<span class="cp">	GEN_MASK_BITS(SSP_RX_1_OR_MORE_ELEM, SSP_CR1_MASK_RXIFLSEL_ST, 7) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_TX_1_OR_MORE_EMPTY_LOC, SSP_CR1_MASK_TXIFLSEL_ST, 10) \</span>
<span class="cp">)</span>

<span class="cm">/*</span>
<span class="cm"> * The PL023 variant has further differences: no loopback mode, no microwire</span>
<span class="cm"> * support, and a new clock feedback delay setting.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_SSP_REG_CR1_ST_PL023 ( \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DISABLED, SSP_CR1_MASK_SSE, 1) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_MASTER, SSP_CR1_MASK_MS, 2) | \</span>
<span class="cp">	GEN_MASK_BITS(DO_NOT_DRIVE_TX, SSP_CR1_MASK_SOD, 3) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_RX_MSB, SSP_CR1_MASK_RENDN_ST, 4) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_TX_MSB, SSP_CR1_MASK_TENDN_ST, 5) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_RX_1_OR_MORE_ELEM, SSP_CR1_MASK_RXIFLSEL_ST, 7) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_TX_1_OR_MORE_EMPTY_LOC, SSP_CR1_MASK_TXIFLSEL_ST, 10) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_FEEDBACK_CLK_DELAY_NONE, SSP_CR1_MASK_FBCLKDEL_ST, 13) \</span>
<span class="cp">)</span>

<span class="cp">#define DEFAULT_SSP_REG_CPSR ( \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DEFAULT_PRESCALE, SSP_CPSR_MASK_CPSDVSR, 0) \</span>
<span class="cp">)</span>

<span class="cp">#define DEFAULT_SSP_REG_DMACR (\</span>
<span class="cp">	GEN_MASK_BITS(SSP_DMA_DISABLED, SSP_DMACR_MASK_RXDMAE, 0) | \</span>
<span class="cp">	GEN_MASK_BITS(SSP_DMA_DISABLED, SSP_DMACR_MASK_TXDMAE, 1) \</span>
<span class="cp">)</span>

<span class="cm">/**</span>
<span class="cm"> * load_ssp_default_config - Load default configuration for SSP</span>
<span class="cm"> * @pl022: SSP driver private data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_ssp_default_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">pl023</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CR0_ST_PL023</span><span class="p">,</span> <span class="n">SSP_CR0</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CR1_ST_PL023</span><span class="p">,</span> <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">extended_cr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CR0_ST</span><span class="p">,</span> <span class="n">SSP_CR0</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CR1_ST</span><span class="p">,</span> <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CR0</span><span class="p">,</span> <span class="n">SSP_CR0</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CR1</span><span class="p">,</span> <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_DMACR</span><span class="p">,</span> <span class="n">SSP_DMACR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">DEFAULT_SSP_REG_CPSR</span><span class="p">,</span> <span class="n">SSP_CPSR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">DISABLE_ALL_INTERRUPTS</span><span class="p">,</span> <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">CLEAR_ALL_INTERRUPTS</span><span class="p">,</span> <span class="n">SSP_ICR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This will write to TX and read from RX according to the parameters</span>
<span class="cm"> * set in pl022.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">readwriter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * The FIFO depth is different between primecell variants.</span>
<span class="cm">	 * I believe filling in too much in the FIFO might cause</span>
<span class="cm">	 * errons in 8bit wide transfers on ARM variants (just 8 words</span>
<span class="cm">	 * FIFO, means only 8x8 = 64 bits in FIFO) at least.</span>
<span class="cm">	 *</span>
<span class="cm">	 * To prevent this issue, the TX FIFO is only filled to the</span>
<span class="cm">	 * unused RX FIFO fill length, regardless of what the TX</span>
<span class="cm">	 * FIFO status flag indicates.</span>
<span class="cm">	 */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s, rx: %p, rxend: %p, tx: %p, txend: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">);</span>

	<span class="cm">/* Read as much as you can */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_SR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SSP_SR_MASK_RNE</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">READING_NULL</span>:
			<span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READING_U8</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFU</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READING_U16</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READING_U32</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">);</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">exp_fifo_level</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Write as much as possible up to the RX FIFO size</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">exp_fifo_level</span> <span class="o">&lt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">&lt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WRITING_NULL</span>:
			<span class="n">writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WRITING_U8</span>:
			<span class="n">writew</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">),</span> <span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WRITING_U16</span>:
			<span class="n">writew</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)),</span> <span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WRITING_U32</span>:
			<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">),</span> <span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">);</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">exp_fifo_level</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * This inner reader takes care of things appearing in the RX</span>
<span class="cm">		 * FIFO as we&#39;re transmitting. This will happen a lot since the</span>
<span class="cm">		 * clock starts running when you put things into the TX FIFO,</span>
<span class="cm">		 * and then things are continuously clocked into the RX FIFO.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_SR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SSP_SR_MASK_RNE</span><span class="p">)</span>
		       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">READING_NULL</span>:
				<span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">READING_U8</span>:
				<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span>
					<span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFU</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">READING_U16</span>:
				<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">readw</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">READING_U32</span>:
				<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span>
					<span class="n">readl</span><span class="p">(</span><span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">);</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">exp_fifo_level</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * When we exit here the TX FIFO should be full and the RX FIFO</span>
<span class="cm">	 * should be empty</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * next_transfer - Move to the Next transfer in the current spi message</span>
<span class="cm"> * @pl022: SSP driver private data structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function moves though the linked list of spi transfers in the</span>
<span class="cm"> * current spi message and returns with the state of current spi</span>
<span class="cm"> * message i.e whether its last transfer is done(STATE_DONE) or</span>
<span class="cm"> * Next transfer is ready(STATE_RUNNING)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">next_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">trans</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="p">;</span>

	<span class="cm">/* Move to next transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span>
		    <span class="n">list_entry</span><span class="p">(</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span> <span class="n">transfer_list</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATE_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">STATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This DMA functionality is only compiled in if we have</span>
<span class="cm"> * access to the generic DMA devices/DMA engine.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_DMA_ENGINE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unmap_free_dma_scatter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Unmap and free the SG tables */</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
		     <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
		     <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">sg_free_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">);</span>
	<span class="n">sg_free_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">);</span>

<span class="cp">#ifdef VERBOSE_DEBUG</span>
	<span class="cm">/*</span>
<span class="cm">	 * Optionally dump out buffers to inspect contents, this is</span>
<span class="cm">	 * good if you want to convince yourself that the loopback</span>
<span class="cm">	 * read/write contents are the same, when adopting to a new</span>
<span class="cm">	 * DMA engine.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dma_sync_sg_for_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
				    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span>
				    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI RX SG ENTRY: %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;SPI RX: &quot;</span><span class="p">,</span>
				       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				       <span class="mi">16</span><span class="p">,</span>
				       <span class="mi">1</span><span class="p">,</span>
				       <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
				       <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
				       <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI TX SG ENTRY: %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;SPI TX: &quot;</span><span class="p">,</span>
				       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				       <span class="mi">16</span><span class="p">,</span>
				       <span class="mi">1</span><span class="p">,</span>
				       <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
				       <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
				       <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">unmap_free_dma_scatter</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="cm">/* Update total bytes transferred */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span>
			<span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_DESELECT</span><span class="p">);</span>

	<span class="cm">/* Move to next transfer */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_dma_scatter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sg_table</span> <span class="o">*</span><span class="n">sgtab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytesleft</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mapbytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgtab</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sgtab</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there are less bytes left than what fits</span>
<span class="cm">			 * in the current page (plus page alignment offset)</span>
<span class="cm">			 * we just feed in this, else we stuff in as much</span>
<span class="cm">			 * as we can.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytesleft</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">bufp</span><span class="p">)))</span>
				<span class="n">mapbytes</span> <span class="o">=</span> <span class="n">bytesleft</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mapbytes</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">bufp</span><span class="p">);</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">bufp</span><span class="p">),</span>
				    <span class="n">mapbytes</span><span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">bufp</span><span class="p">));</span>
			<span class="n">bufp</span> <span class="o">+=</span> <span class="n">mapbytes</span><span class="p">;</span>
			<span class="n">bytesleft</span> <span class="o">-=</span> <span class="n">mapbytes</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;set RX/TX target page @ %p, %d bytes, %d left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bufp</span><span class="p">,</span> <span class="n">mapbytes</span><span class="p">,</span> <span class="n">bytesleft</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Map the dummy buffer on every page */</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgtab</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sgtab</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytesleft</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="n">mapbytes</span> <span class="o">=</span> <span class="n">bytesleft</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mapbytes</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dummypage</span><span class="p">),</span>
				    <span class="n">mapbytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bytesleft</span> <span class="o">-=</span> <span class="n">mapbytes</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;set RX/TX to dummy page %d bytes, %d left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mapbytes</span><span class="p">,</span> <span class="n">bytesleft</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bytesleft</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * configure_dma - configures the channels for the next transfer</span>
<span class="cm"> * @pl022: SSP driver&#39;s private data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="n">rx_conf</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">phybase</span><span class="p">),</span>
		<span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device_fc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="n">tx_conf</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">SSP_DR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">phybase</span><span class="p">),</span>
		<span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device_fc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_sglen</span><span class="p">,</span> <span class="n">tx_sglen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">rxchan</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">txchan</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">;</span>

	<span class="cm">/* Check that the channels are available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxchan</span> <span class="o">||</span> <span class="o">!</span><span class="n">txchan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If supplied, the DMA burstsize should equal the FIFO trigger level.</span>
<span class="cm">	 * Notice that the DMA engine uses one-to-one mapping. Since we can</span>
<span class="cm">	 * not trigger on 2 elements this needs explicit mapping rather than</span>
<span class="cm">	 * calculation.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_lev_trig</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSP_RX_1_OR_MORE_ELEM</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_RX_4_OR_MORE_ELEM</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_RX_8_OR_MORE_ELEM</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_RX_16_OR_MORE_ELEM</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_RX_32_OR_MORE_ELEM</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_lev_trig</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSP_TX_1_OR_MORE_EMPTY_LOC</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_TX_4_OR_MORE_EMPTY_LOC</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_TX_8_OR_MORE_EMPTY_LOC</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_TX_16_OR_MORE_EMPTY_LOC</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_TX_32_OR_MORE_EMPTY_LOC</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READING_NULL</span>:
		<span class="cm">/* Use the same as for writing */</span>
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_UNDEFINED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READING_U8</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READING_U16</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READING_U32</span>:
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WRITING_NULL</span>:
		<span class="cm">/* Use the same as for reading */</span>
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_UNDEFINED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITING_U8</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITING_U16</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITING_U32</span>:
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SPI pecularity: we need to read and write the same width */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">==</span> <span class="n">DMA_SLAVE_BUSWIDTH_UNDEFINED</span><span class="p">)</span>
		<span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">==</span> <span class="n">DMA_SLAVE_BUSWIDTH_UNDEFINED</span><span class="p">)</span>
		<span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rx_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">!=</span> <span class="n">tx_conf</span><span class="p">.</span><span class="n">dst_addr_width</span><span class="p">);</span>

	<span class="n">dmaengine_slave_config</span><span class="p">(</span><span class="n">rxchan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_conf</span><span class="p">);</span>
	<span class="n">dmaengine_slave_config</span><span class="p">(</span><span class="n">txchan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_conf</span><span class="p">);</span>

	<span class="cm">/* Create sglists for the transfers */</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using %d pages for transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sg_alloc_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_alloc_rx_sg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sg_alloc_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_alloc_tx_sg</span><span class="p">;</span>

	<span class="cm">/* Fill in the scatterlists for the RX+TX buffers */</span>
	<span class="n">setup_dma_scatter</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span>
			  <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">);</span>
	<span class="n">setup_dma_scatter</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">,</span>
			  <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">);</span>

	<span class="cm">/* Map DMA buffers */</span>
	<span class="n">rx_sglen</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">rxchan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
			   <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_sglen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rx_sgmap</span><span class="p">;</span>

	<span class="n">tx_sglen</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">txchan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
			   <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_sglen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_tx_sgmap</span><span class="p">;</span>

	<span class="cm">/* Send both scatterlists */</span>
	<span class="n">rxdesc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">rxchan</span><span class="p">,</span>
				      <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
				      <span class="n">rx_sglen</span><span class="p">,</span>
				      <span class="n">DMA_DEV_TO_MEM</span><span class="p">,</span>
				      <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxdesc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rxdesc</span><span class="p">;</span>

	<span class="n">txdesc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">txchan</span><span class="p">,</span>
				      <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
				      <span class="n">tx_sglen</span><span class="p">,</span>
				      <span class="n">DMA_MEM_TO_DEV</span><span class="p">,</span>
				      <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txdesc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_txdesc</span><span class="p">;</span>

	<span class="cm">/* Put the callback on the RX transfer only, that should finish last */</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dma_callback</span><span class="p">;</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">pl022</span><span class="p">;</span>

	<span class="cm">/* Submit and fire RX and TX with TX last so we&#39;re ready to read! */</span>
	<span class="n">dmaengine_submit</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="n">dmaengine_submit</span><span class="p">(</span><span class="n">txdesc</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">rxchan</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">txchan</span><span class="p">);</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_txdesc:</span>
	<span class="n">dmaengine_terminate_all</span><span class="p">(</span><span class="n">txchan</span><span class="p">);</span>
<span class="nl">err_rxdesc:</span>
	<span class="n">dmaengine_terminate_all</span><span class="p">(</span><span class="n">rxchan</span><span class="p">);</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">txchan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
		     <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="nl">err_tx_sgmap:</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">rxchan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
		     <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="nl">err_rx_sgmap:</span>
	<span class="n">sg_free_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_tx</span><span class="p">);</span>
<span class="nl">err_alloc_tx_sg:</span>
	<span class="n">sg_free_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">sgt_rx</span><span class="p">);</span>
<span class="nl">err_alloc_rx_sg:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pl022_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Try to acquire a generic DMA engine slave channel */</span>
	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need both RX and TX channels to do DMA, else do none</span>
<span class="cm">	 * of them.</span>
<span class="cm">	 */</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
					    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="o">-&gt;</span><span class="n">dma_filter</span><span class="p">,</span>
					    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="o">-&gt;</span><span class="n">dma_rx_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no RX DMA channel!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_rxchan</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
					    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="o">-&gt;</span><span class="n">dma_filter</span><span class="p">,</span>
					    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="o">-&gt;</span><span class="n">dma_tx_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no TX DMA channel!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_txchan</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dummypage</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dummypage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no DMA dummypage!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_dummypage</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup for DMA on RX %s, TX %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dma_chan_name</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">),</span>
		 <span class="n">dma_chan_name</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_no_dummypage:</span>
	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">);</span>
<span class="nl">err_no_txchan:</span>
	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">);</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_no_rxchan:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to work in dma mode, work without dma!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">terminate_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">rxchan</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">txchan</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">;</span>

	<span class="n">dmaengine_terminate_all</span><span class="p">(</span><span class="n">rxchan</span><span class="p">);</span>
	<span class="n">dmaengine_terminate_all</span><span class="p">(</span><span class="n">txchan</span><span class="p">);</span>
	<span class="n">unmap_free_dma_scatter</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl022_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_running</span><span class="p">)</span>
		<span class="n">terminate_dma</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_tx_channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dma_rx_channel</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">dummypage</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">configure_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pl022_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pl022_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * pl022_interrupt_handler - Interrupt handler for SSP controller</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles interrupts generated for an interrupt based transfer.</span>
<span class="cm"> * If a receive overrun (ROR) interrupt is there then we disable SSP, flag the</span>
<span class="cm"> * current message&#39;s state as STATE_ERROR and schedule the tasklet</span>
<span class="cm"> * pump_transfers which will do the postprocessing of the current message by</span>
<span class="cm"> * calling giveback(). Otherwise it reads data from RX FIFO till there is no</span>
<span class="cm"> * more data, and writes data in TX FIFO till it is not full. If we complete</span>
<span class="cm"> * the transfer we move to the next transfer and schedule the tasklet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pl022_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;bad message state in interrupt handler&quot;</span><span class="p">);</span>
		<span class="cm">/* Never fail */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the Interrupt Status Register */</span>
	<span class="n">irq_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">SSP_MIS</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">irq_status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This handles the FIFO interrupts, the timeout</span>
<span class="cm">	 * interrupts are flatly ignored, they cannot be</span>
<span class="cm">	 * trusted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">SSP_MIS_MASK_RORMIS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Overrun interrupt - bail out since our Data has been</span>
<span class="cm">		 * corrupted</span>
<span class="cm">		 */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FIFO overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_SR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SSP_SR_MASK_RFF</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;RXFIFO is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_SR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SSP_SR_MASK_TNF</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;TXFIFO is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disable and clear interrupts, disable SSP,</span>
<span class="cm">		 * mark message with bad status so it can be</span>
<span class="cm">		 * retried.</span>
<span class="cm">		 */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">DISABLE_ALL_INTERRUPTS</span><span class="p">,</span>
		       <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">CLEAR_ALL_INTERRUPTS</span><span class="p">,</span> <span class="n">SSP_ICR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="o">~</span><span class="n">SSP_CR1_MASK_SSE</span><span class="p">)),</span> <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_ERROR</span><span class="p">;</span>

		<span class="cm">/* Schedule message queue handler */</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">readwriter</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">==</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Disable Transmit interrupt, enable receive interrupt */</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span>
		       <span class="o">~</span><span class="n">SSP_IMSC_MASK_TXIM</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSP_IMSC_MASK_RXIM</span><span class="p">,</span>
		       <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since all transactions must write as much as shall be read,</span>
<span class="cm">	 * we can conclude the entire transaction once RX is complete.</span>
<span class="cm">	 * At this point, all TX will always be finished.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&gt;=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">DISABLE_ALL_INTERRUPTS</span><span class="p">,</span>
		       <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">CLEAR_ALL_INTERRUPTS</span><span class="p">,</span> <span class="n">SSP_ICR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&gt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read %u surplus &quot;</span>
				 <span class="s">&quot;bytes (did you request an odd &quot;</span>
				 <span class="s">&quot;number of bytes on a 16bit bus?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">-</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Update total bytes transferred */</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span>
				<span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_DESELECT</span><span class="p">);</span>
		<span class="cm">/* Move to next transfer */</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This sets up the pointers to memory for the next message to</span>
<span class="cm"> * send out on the SPI bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_up_next_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">transfer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">residue</span><span class="p">;</span>

	<span class="cm">/* Sanity check the message for this bus width */</span>
	<span class="n">residue</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">%</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">residue</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;message of %u bytes to transmit but the current &quot;</span>
			<span class="s">&quot;chip bus has a data width of %u bytes!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;skipping this message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">+</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">+</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span>
	    <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">?</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">:</span> <span class="n">WRITING_NULL</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">?</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">:</span> <span class="n">READING_NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pump_transfers - Tasklet function which schedules next transfer</span>
<span class="cm"> * when running in interrupt or DMA transfer mode.</span>
<span class="cm"> * @data: SSP driver private data structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pump_transfers</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">transfer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">previous</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Get current state information */</span>
	<span class="n">message</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="n">transfer</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="p">;</span>

	<span class="cm">/* Handle for abort */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">giveback</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle end of message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">giveback</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delay if requested at end of transfer before CS change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span>
					<span class="n">transfer_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: This runs in interrupt context.</span>
<span class="cm">			 * Is this really smart?</span>
<span class="cm">			 */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">);</span>

		<span class="cm">/* Reselect chip select only if cs_change was requested */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_SELECT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* STATE_START */</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_up_next_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span> <span class="n">transfer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_ERROR</span><span class="p">;</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">giveback</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Flush the FIFOs and let&#39;s go! */</span>
	<span class="n">flush</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">configure_dma</span><span class="p">(</span><span class="n">pl022</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;configuration of DMA failed, fall back to interrupt mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_config_dma</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_config_dma:</span>
	<span class="cm">/* enable all interrupts except RX */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">ENABLE_ALL_INTERRUPTS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SSP_IMSC_MASK_RXIM</span><span class="p">,</span> <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_interrupt_dma_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Default is to enable all interrupts except RX -</span>
<span class="cm">	 * this will be enabled once TX is complete</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">irqflags</span> <span class="o">=</span> <span class="n">ENABLE_ALL_INTERRUPTS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SSP_IMSC_MASK_RXIM</span><span class="p">;</span>

	<span class="cm">/* Enable target chip, if not already active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">next_msg_cs_active</span><span class="p">)</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_SELECT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_up_next_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Error path */</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_ERROR</span><span class="p">;</span>
		<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">giveback</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If we&#39;re using DMA, set up DMA here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Configure DMA transfer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">configure_dma</span><span class="p">(</span><span class="n">pl022</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;configuration of DMA failed, fall back to interrupt mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_config_dma</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Disable interrupts in DMA mode, IRQ from DMA controller */</span>
		<span class="n">irqflags</span> <span class="o">=</span> <span class="n">DISABLE_ALL_INTERRUPTS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err_config_dma:</span>
	<span class="cm">/* Enable SSP, turn on interrupts */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">|</span> <span class="n">SSP_CR1_MASK_SSE</span><span class="p">),</span>
	       <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">irqflags</span><span class="p">,</span> <span class="n">SSP_IMSC</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_polling_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">transfer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">previous</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="p">;</span>
	<span class="n">message</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Handle for abort */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_ERROR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">transfer</span> <span class="o">=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="p">;</span>

		<span class="cm">/* Delay if requested at end of transfer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">previous</span> <span class="o">=</span>
			    <span class="n">list_entry</span><span class="p">(</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span> <span class="n">transfer_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
				<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_SELECT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* STATE_START */</span>
			<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_RUNNING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">next_msg_cs_active</span><span class="p">)</span>
				<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_SELECT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Configuration Changing Per Transfer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_up_next_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span> <span class="n">transfer</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Error path */</span>
			<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Flush FIFOs and enable SSP */</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">|</span> <span class="n">SSP_CR1_MASK_SSE</span><span class="p">),</span>
		       <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;polling transfer ongoing ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SPI_POLLING_TIMEOUT</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">&lt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">||</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">readwriter</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_ERROR</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="cm">/* Update total byte transferred */</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">)</span>
			<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">SSP_CHIP_DESELECT</span><span class="p">);</span>
		<span class="cm">/* Move to next transfer */</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="cm">/* Handle end of message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DONE</span><span class="p">)</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">giveback</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_transfer_one_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="cm">/* Initial message state */</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_START</span><span class="p">;</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span> <span class="n">transfer_list</span><span class="p">);</span>

	<span class="cm">/* Setup the SPI using the per chip configuration */</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span> <span class="o">=</span> <span class="n">spi_get_ctldata</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">);</span>

	<span class="n">restore_state</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="n">flush</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">xfer_type</span> <span class="o">==</span> <span class="n">POLLING_TRANSFER</span><span class="p">)</span>
		<span class="n">do_polling_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">do_interrupt_dma_transfer</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_prepare_transfer_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Just make sure we have all we need to run the transfer by syncing</span>
<span class="cm">	 * with the runtime PM framework.</span>
<span class="cm">	 */</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_unprepare_transfer_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="cm">/* nothing more to do - disable spi/ssp and power off */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="o">~</span><span class="n">SSP_CR1_MASK_SSE</span><span class="p">)),</span> <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="o">-&gt;</span><span class="n">autosuspend_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_controller_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pl022_config_chip</span> <span class="k">const</span> <span class="o">*</span><span class="n">chip_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">&lt;</span> <span class="n">SSP_INTERFACE_MOTOROLA_SPI</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">&gt;</span> <span class="n">SSP_INTERFACE_UNIDIRECTIONAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;interface is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">==</span> <span class="n">SSP_INTERFACE_UNIDIRECTIONAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">unidir</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unidirectional mode not supported in this &quot;</span>
			<span class="s">&quot;hardware version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">!=</span> <span class="n">SSP_MASTER</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">!=</span> <span class="n">SSP_SLAVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;hierarchy is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">com_mode</span> <span class="o">!=</span> <span class="n">INTERRUPT_TRANSFER</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">com_mode</span> <span class="o">!=</span> <span class="n">DMA_TRANSFER</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">com_mode</span> <span class="o">!=</span> <span class="n">POLLING_TRANSFER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Communication mode is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">rx_lev_trig</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSP_RX_1_OR_MORE_ELEM</span>:
	<span class="k">case</span> <span class="n">SSP_RX_4_OR_MORE_ELEM</span>:
	<span class="k">case</span> <span class="n">SSP_RX_8_OR_MORE_ELEM</span>:
		<span class="cm">/* These are always OK, all variants can handle this */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_RX_16_OR_MORE_ELEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;RX FIFO Trigger Level is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_RX_32_OR_MORE_ELEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;RX FIFO Trigger Level is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;RX FIFO Trigger Level is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">tx_lev_trig</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSP_TX_1_OR_MORE_EMPTY_LOC</span>:
	<span class="k">case</span> <span class="n">SSP_TX_4_OR_MORE_EMPTY_LOC</span>:
	<span class="k">case</span> <span class="n">SSP_TX_8_OR_MORE_EMPTY_LOC</span>:
		<span class="cm">/* These are always OK, all variants can handle this */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_TX_16_OR_MORE_EMPTY_LOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;TX FIFO Trigger Level is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSP_TX_32_OR_MORE_EMPTY_LOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">fifodepth</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;TX FIFO Trigger Level is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;TX FIFO Trigger Level is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">==</span> <span class="n">SSP_INTERFACE_NATIONAL_MICROWIRE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">ctrl_len</span> <span class="o">&lt;</span> <span class="n">SSP_BITS_4</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">ctrl_len</span> <span class="o">&gt;</span> <span class="n">SSP_BITS_32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;CTRL LEN is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">wait_state</span> <span class="o">!=</span> <span class="n">SSP_MWIRE_WAIT_ZERO</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">wait_state</span> <span class="o">!=</span> <span class="n">SSP_MWIRE_WAIT_ONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Wait State is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Half duplex is only available in the ST Micro version */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">extended_cr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span>
			     <span class="n">SSP_MICROWIRE_CHANNEL_FULL_DUPLEX</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span>
				<span class="n">SSP_MICROWIRE_CHANNEL_HALF_DUPLEX</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Microwire duplex mode is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">SSP_MICROWIRE_CHANNEL_FULL_DUPLEX</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Microwire half duplex mode requested,&quot;</span>
					<span class="s">&quot; but this is only available in the&quot;</span>
					<span class="s">&quot; ST version of PL022</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">spi_rate</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cpsdvsr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">scr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">cpsdvsr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">scr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calculate_effective_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="k">struct</span>
				    <span class="n">ssp_clock_params</span> <span class="o">*</span> <span class="n">clk_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Lets calculate the frequency parameters */</span>
	<span class="n">u16</span> <span class="n">cpsdvsr</span> <span class="o">=</span> <span class="n">CPSDVR_MIN</span><span class="p">,</span> <span class="n">scr</span> <span class="o">=</span> <span class="n">SCR_MIN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">max_tclk</span><span class="p">,</span> <span class="n">min_tclk</span><span class="p">,</span> <span class="n">best_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">best_cpsdvsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">best_scr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="cm">/* cpsdvscr = 2 &amp; scr 0 */</span>
	<span class="n">max_tclk</span> <span class="o">=</span> <span class="n">spi_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">CPSDVR_MIN</span><span class="p">,</span> <span class="n">SCR_MIN</span><span class="p">);</span>
	<span class="cm">/* cpsdvsr = 254 &amp; scr = 255 */</span>
	<span class="n">min_tclk</span> <span class="o">=</span> <span class="n">spi_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">CPSDVR_MAX</span><span class="p">,</span> <span class="n">SCR_MAX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">max_tclk</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Max speed that can be programmed is %d Hz, you requested %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">max_tclk</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">min_tclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Requested frequency: %d Hz is less than minimum possible %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span><span class="p">,</span> <span class="n">min_tclk</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * best_freq will give closest possible available rate (&lt;= requested</span>
<span class="cm">	 * freq) for all values of scr &amp; cpsdvsr.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cpsdvsr</span> <span class="o">&lt;=</span> <span class="n">CPSDVR_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">scr</span> <span class="o">&lt;=</span> <span class="n">SCR_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">spi_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">cpsdvsr</span><span class="p">,</span> <span class="n">scr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we need lower freq */</span>
				<span class="n">scr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * If found exact value, mark found and break.</span>
<span class="cm">			 * If found more closer value, update and break.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">best_freq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">best_freq</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">best_cpsdvsr</span> <span class="o">=</span> <span class="n">cpsdvsr</span><span class="p">;</span>
				<span class="n">best_scr</span> <span class="o">=</span> <span class="n">scr</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * increased scr will give lower rates, which are not</span>
<span class="cm">			 * required</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cpsdvsr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">scr</span> <span class="o">=</span> <span class="n">SCR_MIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">best_freq</span><span class="p">,</span> <span class="s">&quot;pl022: Matching cpsdvsr and scr not found for %d Hz rate </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span><span class="p">);</span>

	<span class="n">clk_freq</span><span class="o">-&gt;</span><span class="n">cpsdvsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">best_cpsdvsr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">clk_freq</span><span class="o">-&gt;</span><span class="n">scr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">best_scr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;SSP Target Frequency is: %u, Effective Frequency is %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">freq</span><span class="p">,</span> <span class="n">best_freq</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SSP cpsdvsr = %d, scr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clk_freq</span><span class="o">-&gt;</span><span class="n">cpsdvsr</span><span class="p">,</span> <span class="n">clk_freq</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A piece of default chip info unless the platform</span>
<span class="cm"> * supplies it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pl022_config_chip</span> <span class="n">pl022_default_chip_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">com_mode</span> <span class="o">=</span> <span class="n">POLLING_TRANSFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SSP_INTERFACE_MOTOROLA_SPI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">SSP_SLAVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_tx_disable</span> <span class="o">=</span> <span class="n">DO_NOT_DRIVE_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_lev_trig</span> <span class="o">=</span> <span class="n">SSP_RX_1_OR_MORE_ELEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_lev_trig</span> <span class="o">=</span> <span class="n">SSP_TX_1_OR_MORE_EMPTY_LOC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctrl_len</span> <span class="o">=</span> <span class="n">SSP_BITS_8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_state</span> <span class="o">=</span> <span class="n">SSP_MWIRE_WAIT_ZERO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">SSP_MICROWIRE_CHANNEL_FULL_DUPLEX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cs_control</span> <span class="o">=</span> <span class="n">null_cs_control</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * pl022_setup - setup function registered to SPI master framework</span>
<span class="cm"> * @spi: spi device which is requesting setup</span>
<span class="cm"> *</span>
<span class="cm"> * This function is registered to the SPI framework for this SPI master</span>
<span class="cm"> * controller. If it is the first time when setup is called by this device,</span>
<span class="cm"> * this function will initialize the runtime state for this chip and save</span>
<span class="cm"> * the same in the device structure. Else it will update the runtime info</span>
<span class="cm"> * with the updated chip info. Nothing is really being written to the</span>
<span class="cm"> * controller hardware here, that is not done until the actual transfer</span>
<span class="cm"> * commence.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022_config_chip</span> <span class="k">const</span> <span class="o">*</span><span class="n">chip_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_clock_params</span> <span class="n">clk_freq</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">cpsdvsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">scr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get controller_state if one is supplied */</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">spi_get_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chip_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cannot allocate controller state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;allocated memory for controller&#39;s runtime state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get controller data if one is supplied */</span>
	<span class="n">chip_info</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">controller_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl022_default_chip_info</span><span class="p">;</span>
		<span class="cm">/* spi_board_info.controller_data not is supplied */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;using default controller_data settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;using user supplied controller_data settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can override with custom divisors, else we use the board</span>
<span class="cm">	 * frequency setting</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">clk_freq</span><span class="p">.</span><span class="n">scr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">calculate_effective_freq</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span>
						  <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">clk_freq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_config_params</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">clk_freq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clk_freq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span> <span class="o">=</span>
				<span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span> <span class="o">&lt;</span> <span class="n">CPSDVR_MIN</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span> <span class="o">&gt;</span> <span class="n">CPSDVR_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cpsdvsr is configured incorrectly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_config_params</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">verify_controller_parameters</span><span class="p">(</span><span class="n">pl022</span><span class="p">,</span> <span class="n">chip_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller data is incorrect&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_config_params</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">rx_lev_trig</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">rx_lev_trig</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">tx_lev_trig</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">tx_lev_trig</span><span class="p">;</span>

	<span class="cm">/* Now set controller state based on controller data */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">xfer_type</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">com_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cs_control</span> <span class="o">=</span> <span class="n">null_cs_control</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;chip select function is NULL for this chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cs_control</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">;</span>

	<span class="cm">/* Check bits per word with vendor specific range */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">max_bpw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;illegal data size for this controller!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;This controller can only handle 4 &lt;= n &lt;= %d bit words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">max_bpw</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_config_params</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;4 &lt;= n &lt;=8 bits per word</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">READING_U8</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">WRITING_U8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;9 &lt;= n &lt;= 16 bits per word</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">READING_U16</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">WRITING_U16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;17 &lt;= n &lt;= 32 bits per word</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">READING_U32</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">WRITING_U32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now Initialize all register settings required for this chip */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dmacr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cpsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">com_mode</span> <span class="o">==</span> <span class="n">DMA_TRANSFER</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">enable_dma</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode set in controller state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">SSP_DMA_ENABLED</span><span class="p">,</span>
			       <span class="n">SSP_DMACR_MASK_RXDMAE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">SSP_DMA_ENABLED</span><span class="p">,</span>
			       <span class="n">SSP_DMACR_MASK_TXDMAE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">enable_dma</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode NOT set in controller state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">SSP_DMA_DISABLED</span><span class="p">,</span>
			       <span class="n">SSP_DMACR_MASK_RXDMAE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">SSP_DMA_DISABLED</span><span class="p">,</span>
			       <span class="n">SSP_DMACR_MASK_TXDMAE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cpsr</span> <span class="o">=</span> <span class="n">clk_freq</span><span class="p">.</span><span class="n">cpsdvsr</span><span class="p">;</span>

	<span class="cm">/* Special setup for the ST micro extended control registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">extended_cr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">etx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">pl023</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* These bits are only in the PL023 */</span>
			<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">clkdelay</span><span class="p">,</span>
				       <span class="n">SSP_CR1_MASK_FBCLKDEL_ST</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* These bits are in the PL022 but not PL023 */</span>
			<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span>
				       <span class="n">SSP_CR0_MASK_HALFDUP_ST</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">ctrl_len</span><span class="p">,</span>
				       <span class="n">SSP_CR0_MASK_CSS_ST</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span>
				       <span class="n">SSP_CR0_MASK_FRF_ST</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
			<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">wait_state</span><span class="p">,</span>
				       <span class="n">SSP_CR1_MASK_MWAIT_ST</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">SSP_CR0_MASK_DSS_ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_LSB_FIRST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">SSP_RX_LSB</span><span class="p">;</span>
			<span class="n">etx</span> <span class="o">=</span> <span class="n">SSP_TX_LSB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">SSP_RX_MSB</span><span class="p">;</span>
			<span class="n">etx</span> <span class="o">=</span> <span class="n">SSP_TX_MSB</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SSP_CR1_MASK_RENDN_ST</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">etx</span><span class="p">,</span> <span class="n">SSP_CR1_MASK_TENDN_ST</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">rx_lev_trig</span><span class="p">,</span>
			       <span class="n">SSP_CR1_MASK_RXIFLSEL_ST</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">tx_lev_trig</span><span class="p">,</span>
			       <span class="n">SSP_CR1_MASK_TXIFLSEL_ST</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">SSP_CR0_MASK_DSS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span>
			       <span class="n">SSP_CR0_MASK_FRF</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Stuff that is common for all versions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CPOL</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">SSP_CLK_POL_IDLE_HIGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">SSP_CLK_POL_IDLE_LOW</span><span class="p">;</span>
	<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SSP_CR0_MASK_SPO</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CPHA</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">SSP_CLK_SECOND_EDGE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">SSP_CLK_FIRST_EDGE</span><span class="p">;</span>
	<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SSP_CR0_MASK_SPH</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="n">clk_freq</span><span class="p">.</span><span class="n">scr</span><span class="p">,</span> <span class="n">SSP_CR0_MASK_SCR</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* Loopback is available on all versions except PL023 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_LOOP</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">LOOPBACK_ENABLED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">LOOPBACK_DISABLED</span><span class="p">;</span>
		<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SSP_CR1_MASK_LBM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">SSP_DISABLED</span><span class="p">,</span> <span class="n">SSP_CR1_MASK_SSE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">SSP_CR1_MASK_MS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">SSP_WRITE_BITS</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr1</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">slave_tx_disable</span><span class="p">,</span> <span class="n">SSP_CR1_MASK_SOD</span><span class="p">,</span>
		<span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Save controller_state */</span>
	<span class="n">spi_set_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
 <span class="nl">err_config_params:</span>
	<span class="n">spi_set_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pl022_cleanup - cleanup function registered to SPI master framework</span>
<span class="cm"> * @spi: spi device which is requesting cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * This function is registered to the SPI framework for this SPI master</span>
<span class="cm"> * controller. It will free the runtime state of chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl022_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">spi_get_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>

	<span class="n">spi_set_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">pl022_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">amba_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">amba_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl022_ssp_controller</span> <span class="o">*</span><span class="n">platform_info</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/*Data for this driver */</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;ARM PL022 driver, device ID: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">periphid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe - no platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_pdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate master with space for data */</span>
	<span class="n">master</span> <span class="o">=</span> <span class="n">spi_alloc_master</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl022</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe - cannot alloc SPI master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_master</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pl022</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span> <span class="o">=</span> <span class="n">platform_info</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">adev</span> <span class="o">=</span> <span class="n">adev</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bus Number Which has been Assigned to this SSP controller</span>
<span class="cm">	 * on this board</span>
<span class="cm">	 */</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">num_chipselect</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">pl022_cleanup</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">pl022_setup</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">prepare_transfer_hardware</span> <span class="o">=</span> <span class="n">pl022_prepare_transfer_hardware</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">transfer_one_message</span> <span class="o">=</span> <span class="n">pl022_transfer_one_message</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">unprepare_transfer_hardware</span> <span class="o">=</span> <span class="n">pl022_unprepare_transfer_hardware</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">rt</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">rt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Supports mode 0-3, loopback, and active low CS. Transfers are</span>
<span class="cm">	 * always MS bit first on the original pl022.</span>
<span class="cm">	 */</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">mode_bits</span> <span class="o">=</span> <span class="n">SPI_CPOL</span> <span class="o">|</span> <span class="n">SPI_CPHA</span> <span class="o">|</span> <span class="n">SPI_CS_HIGH</span> <span class="o">|</span> <span class="n">SPI_LOOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="o">-&gt;</span><span class="n">extended_cr</span><span class="p">)</span>
		<span class="n">master</span><span class="o">-&gt;</span><span class="n">mode_bits</span> <span class="o">|=</span> <span class="n">SPI_LSB_FIRST</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUSNO: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">amba_request_regions</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_ioregion</span><span class="p">;</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">phybase</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_ioremap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pl022: mapped registers from 0x%08x to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">);</span>

	<span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not retrieve SSP/SPI bus clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">clk_prepare</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not prepare SSP/SPI bus clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span>  <span class="n">err_clk_prep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not enable SSP/SPI bus clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_clk_en</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize transfer pump */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">,</span> <span class="n">pump_transfers</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pl022</span><span class="p">);</span>

	<span class="cm">/* Disable SSP */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">SSP_CR1_MASK_SSE</span><span class="p">)),</span>
	       <span class="n">SSP_CR1</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">));</span>
	<span class="n">load_ssp_default_config</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pl022_interrupt_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pl022&quot;</span><span class="p">,</span>
			     <span class="n">pl022</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe - cannot get IRQ (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get DMA channels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pl022_dma_probe</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">enable_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register with the SPI framework */</span>
	<span class="n">amba_set_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">pl022</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">spi_register_master</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;probe - problem registering spi master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_spi_register</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* let runtime pm put suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">autosuspend_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;will use autosuspend for runtime pm, delay %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">autosuspend_delay</span><span class="p">);</span>
		<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">autosuspend_delay</span><span class="p">);</span>
		<span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_spi_register:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_info</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span>
		<span class="n">pl022_dma_remove</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pl022</span><span class="p">);</span>
 <span class="nl">err_no_irq:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
 <span class="nl">err_no_clk_en:</span>
	<span class="n">clk_unprepare</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
 <span class="nl">err_clk_prep:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
 <span class="nl">err_no_clk:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">);</span>
 <span class="nl">err_no_ioremap:</span>
	<span class="n">amba_release_regions</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
 <span class="nl">err_no_ioregion:</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
 <span class="nl">err_no_master:</span>
 <span class="nl">err_no_pdata:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">pl022_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">amba_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">amba_get_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl022</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * undo pm_runtime_put() in probe.  I assume that we&#39;re not</span>
<span class="cm">	 * accessing the primecell here.</span>
<span class="cm">	 */</span>
	<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">load_ssp_default_config</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master_info</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span>
		<span class="n">pl022_dma_remove</span><span class="p">(</span><span class="n">pl022</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pl022</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_unprepare</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">);</span>
	<span class="n">amba_release_regions</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>
	<span class="n">spi_unregister_master</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="n">amba_set_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SUSPEND</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_master_suspend</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot suspend master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Start the queue running */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_master_resume</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;problem starting queue (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resumed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl022_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl022</span> <span class="o">*</span><span class="n">pl022</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">pl022</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">pl022_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">pl022_suspend</span><span class="p">,</span> <span class="n">pl022_resume</span><span class="p">)</span>
	<span class="n">SET_RUNTIME_PM_OPS</span><span class="p">(</span><span class="n">pl022_runtime_suspend</span><span class="p">,</span> <span class="n">pl022_runtime_resume</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_arm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fifodepth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_bpw</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unidir</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extended_cr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pl023</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_st</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fifodepth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_bpw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unidir</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extended_cr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pl023</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_st_pl023</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fifodepth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_bpw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unidir</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extended_cr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pl023</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_db5500_pl023</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fifodepth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_bpw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unidir</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extended_cr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pl023</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_id</span> <span class="n">pl022_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ARM PL022 variant, this has a 16bit wide</span>
<span class="cm">		 * and 8 locations deep TX/RX FIFO</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x00041022</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x000fffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_arm</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ST Micro derivative, this has 32bit wide</span>
<span class="cm">		 * and 32 locations deep TX/RX FIFO</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x01080022</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_st</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ST-Ericsson derivative &quot;PL023&quot; (this is not</span>
<span class="cm">		 * an official ARM number), this is a PL022 SSP block</span>
<span class="cm">		 * stripped to SPI mode only, it has 32bit wide</span>
<span class="cm">		 * and 32 locations deep TX/RX FIFO but no extended</span>
<span class="cm">		 * CR0/CR1 register</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x00080023</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_st_pl023</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x10080023</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_db5500_pl023</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">amba</span><span class="p">,</span> <span class="n">pl022_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_driver</span> <span class="n">pl022_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ssp-pl022&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pl022_dev_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pl022_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pl022_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pl022_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pl022_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">amba_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">pl022_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pl022_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amba_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl022_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pl022_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linus Walleij &lt;linus.walleij@stericsson.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PL022 SSP Controller Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
