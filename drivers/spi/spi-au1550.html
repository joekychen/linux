<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › spi › spi-au1550.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>spi-au1550.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * au1550 psc spi controller driver</span>
<span class="cm"> * may work also with au1200, au1210, au1250</span>
<span class="cm"> * will not work on au1000, au1100 and au1500 (no full spi controller there)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006 ATRON electronic GmbH</span>
<span class="cm"> * Author: Jan Nikitenko &lt;jan.nikitenko@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/resource.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi_bitbang.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1000.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1xxx_psc.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1xxx_dbdma.h&gt;</span>

<span class="cp">#include &lt;asm/mach-au1x00/au1550_spi.h&gt;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">usedma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">usedma</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">#define AU1550_SPI_DEBUG_LOOPBACK</span>
<span class="cm">*/</span>


<span class="cp">#define AU1550_SPI_DBDMA_DESCRIPTORS 1</span>
<span class="cp">#define AU1550_SPI_DMA_RXTMP_MINSIZE 2048U</span>

<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_bitbang</span> <span class="n">bitbang</span><span class="p">;</span>

	<span class="k">volatile</span> <span class="n">psc_spi_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">freq_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">freq_min</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tx_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rx_count</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rx_word</span><span class="p">)(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">tx_word</span><span class="p">)(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">txrx_bufs</span><span class="p">)(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">irq_callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">completion</span> <span class="n">master_done</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">usedma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_tx_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_rx_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_tx_ch</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_rx_ch</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">dma_rx_tmpbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dma_rx_tmpbuf_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_rx_tmpbuf_addr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">au1550_spi_info</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ioarea</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* we use an 8-bit memory device for dma transfers to/from spi fifo */</span>
<span class="k">static</span> <span class="n">dbdev_tab_t</span> <span class="n">au1550_spi_mem_dbdev</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">dev_id</span>			<span class="o">=</span> <span class="n">DBDMA_MEM_CHAN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_flags</span>		<span class="o">=</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="o">|</span><span class="n">DEV_FLAGS_SYNC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_tsize</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_devwidth</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_physaddr</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_intlevel</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_intpolarity</span>	<span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ddma_memid</span><span class="p">;</span>	<span class="cm">/* id to above mem dma device */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">au1550_spi_bits_handlers_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpw</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> *  compute BRG and DIV bits to setup spi clock based on main input clock rate</span>
<span class="cm"> *  that was specified in platform data structure</span>
<span class="cm"> *  according to au1550 datasheet:</span>
<span class="cm"> *    psc_tempclk = psc_mainclk / (2 &lt;&lt; DIV)</span>
<span class="cm"> *    spiclk = psc_tempclk / (2 * (BRG + 1))</span>
<span class="cm"> *    BRG valid range is 4..63</span>
<span class="cm"> *    DIV valid range is 0..3</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">au1550_spi_baudcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">speed_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mainclk_hz</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mainclk_hz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">,</span> <span class="n">brg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">div</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brg</span> <span class="o">=</span> <span class="n">mainclk_hz</span> <span class="o">/</span> <span class="n">speed_hz</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">div</span><span class="p">);</span>
		<span class="cm">/* now we have BRG+1 in brg, so count with that */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brg</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* speed_hz too big */</span>
			<span class="k">break</span><span class="p">;</span>		<span class="cm">/* set lowest brg (div is == 0) */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brg</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">63</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>		<span class="cm">/* we have valid brg and div */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* speed_hz too small */</span>
		<span class="n">brg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">63</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* set highest brg and div */</span>
	<span class="p">}</span>
	<span class="n">brg</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PSC_SPICFG_SET_BAUD</span><span class="p">(</span><span class="n">brg</span><span class="p">)</span> <span class="o">|</span> <span class="n">PSC_SPICFG_SET_DIV</span><span class="p">(</span><span class="n">div</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spimsk</span> <span class="o">=</span>
		  <span class="n">PSC_SPIMSK_MM</span> <span class="o">|</span> <span class="n">PSC_SPIMSK_RR</span> <span class="o">|</span> <span class="n">PSC_SPIMSK_RO</span>
		<span class="o">|</span> <span class="n">PSC_SPIMSK_RU</span> <span class="o">|</span> <span class="n">PSC_SPIMSK_TR</span> <span class="o">|</span> <span class="n">PSC_SPIMSK_TO</span>
		<span class="o">|</span> <span class="n">PSC_SPIMSK_TU</span> <span class="o">|</span> <span class="n">PSC_SPIMSK_SD</span> <span class="o">|</span> <span class="n">PSC_SPIMSK_MD</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spievent</span> <span class="o">=</span>
		  <span class="n">PSC_SPIEVNT_MM</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_RR</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_RO</span>
		<span class="o">|</span> <span class="n">PSC_SPIEVNT_RU</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_TR</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_TO</span>
		<span class="o">|</span> <span class="n">PSC_SPIEVNT_TU</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_SD</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_MD</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1550_spi_reset_fifos</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pcr</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spipcr</span> <span class="o">=</span> <span class="n">PSC_SPIPCR_RC</span> <span class="o">|</span> <span class="n">PSC_SPIPCR_TC</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pcr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spipcr</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dma transfers are used for the most common spi word size of 8-bits</span>
<span class="cm"> * we cannot easily change already set up dma channels&#39; width, so if we wanted</span>
<span class="cm"> * dma support for more than 8-bit words (up to 24 bits), we would need to</span>
<span class="cm"> * setup dma channels from scratch on each spi transfer, based on bits_per_word</span>
<span class="cm"> * instead we have pre set up 8 bit dma channels supporting spi 4 to 8 bits</span>
<span class="cm"> * transfers, and 9 to 24 bits spi transfers will be done in pio irq based mode</span>
<span class="cm"> * callbacks to handle dma or pio are set up in au1550_spi_bits_handlers_set()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1550_spi_chipsel</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">cspol</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CS_HIGH</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BITBANG_CS_INACTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">deactivate_cs</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">deactivate_cs</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">,</span>
					<span class="n">cspol</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BITBANG_CS_ACTIVE</span>:
		<span class="n">au1550_spi_bits_handlers_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">);</span>

		<span class="n">cfg</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">=</span> <span class="n">cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PSC_SPICFG_DE_ENABLE</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CPOL</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_BI</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_BI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CPHA</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_CDE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_CDE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_LSB_FIRST</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_MLF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_MLF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">&amp;&amp;</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_DD_DISABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_DD_DISABLE</span><span class="p">;</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">PSC_SPICFG_CLR_LEN</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_SET_LEN</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">);</span>

		<span class="n">cfg</span> <span class="o">=</span> <span class="n">PSC_SPICFG_CLR_BAUD</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_SET_DIV</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">au1550_spi_baudcfg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">=</span> <span class="n">cfg</span> <span class="o">|</span> <span class="n">PSC_SPICFG_DE_ENABLE</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
			<span class="n">au_sync</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_DR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">activate_cs</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">activate_cs</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">,</span>
					<span class="n">cspol</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1550_spi_setupxfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">bpw</span><span class="p">,</span> <span class="n">hz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">bpw</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>
	<span class="n">hz</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">)</span>
			<span class="n">bpw</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">)</span>
			<span class="n">hz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpw</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">bpw</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setupxfer: invalid bits_per_word=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bpw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hz</span> <span class="o">&gt;</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span> <span class="o">||</span> <span class="n">hz</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_max</span> <span class="o">||</span> <span class="n">hz</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setupxfer: clock rate=%d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hz</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">au1550_spi_bits_handlers_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">=</span> <span class="n">cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PSC_SPICFG_DE_ENABLE</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">&amp;&amp;</span> <span class="n">bpw</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_DD_DISABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_DD_DISABLE</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">PSC_SPICFG_CLR_LEN</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_SET_LEN</span><span class="p">(</span><span class="n">bpw</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">PSC_SPICFG_CLR_BAUD</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSC_SPICFG_SET_DIV</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">au1550_spi_baudcfg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hz</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">PSC_SPICFG_DE_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
			<span class="n">au_sync</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_DR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">au1550_spi_reset_fifos</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1550_spi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup: invalid bits_per_word=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_max</span>
			<span class="o">||</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_min</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE: cannot change speed and other hw settings immediately,</span>
<span class="cm">	 *       otherwise sharing of spi bus is not possible,</span>
<span class="cm">	 *       so do not call setupxfer(spi, NULL) here</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * for dma spi transfers, we have to setup rx channel, otherwise there is</span>
<span class="cm"> * no reliable way how to recognize that spi transfer is done</span>
<span class="cm"> * dma complete callbacks are called before real spi transfer is finished</span>
<span class="cm"> * and if only tx dma channel is set up (and rx fifo overflow event masked)</span>
<span class="cm"> * spi master done event irq is not generated unless rx fifo is empty (emptied)</span>
<span class="cm"> * so we need rx tmp buffer to use for rx dma if user does not provide one</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1550_spi_dma_rxtmp_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span><span class="p">,</span>
			<span class="n">size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1550_spi_dma_rxtmp_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_addr</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1550_spi_dma_txrxb</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_tx_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_rx_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">dma_tx_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">;</span>
	<span class="n">dma_rx_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check if buffers are already dma mapped, map them otherwise:</span>
<span class="cm">	 * - first map the TX buffer, so cache data gets written to memory</span>
<span class="cm">	 * - then map the RX buffer, so that cache entries (with</span>
<span class="cm">	 *   soon-to-be-stale data) get removed</span>
<span class="cm">	 * use rx buffer in place of tx if tx buffer was not provided</span>
<span class="cm">	 * use temp rx buffer (preallocated or realloc to fit) for rx dma</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* if DMA_ADDR_INVALID, map it */</span>
			<span class="n">dma_tx_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span>
					<span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_tx_addr</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx dma map error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* if DMA_ADDR_INVALID, map it */</span>
			<span class="n">dma_rx_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span>
					<span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_rx_addr</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx dma map error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">au1550_spi_dma_rxtmp_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">au1550_spi_dma_rxtmp_alloc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">AU1550_SPI_DMA_RXTMP_MINSIZE</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf</span><span class="p">;</span>
		<span class="n">dma_rx_addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_tmpbuf_addr</span><span class="p">;</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_rx_addr</span><span class="p">,</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_rx_addr</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* put buffers on the ring */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">au1xxx_dbdma_put_dest</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">,</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">),</span>
				    <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DDMA_FLAGS_IE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx dma put dest error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">au1xxx_dbdma_put_source</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">,</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">),</span>
				      <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DDMA_FLAGS_IE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx dma put source error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">au1xxx_dbdma_start</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>
	<span class="n">au1xxx_dbdma_start</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>

	<span class="cm">/* by default enable nearly all events interrupt */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spimsk</span> <span class="o">=</span> <span class="n">PSC_SPIMSK_SD</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="cm">/* start the transfer */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spipcr</span> <span class="o">=</span> <span class="n">PSC_SPIPCR_MS</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>

	<span class="n">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>
	<span class="n">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* using the temporal preallocated and premapped buffer */</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_rx_addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* unmap buffers if mapped above */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_rx_addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_tx_addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">?</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">:</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">au1550_spi_dma_irq_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">evnt</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
	<span class="n">evnt</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spievent</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_DI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">evnt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSC_SPIEVNT_MM</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_RO</span>
				<span class="o">|</span> <span class="n">PSC_SPIEVNT_RU</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_TO</span>
				<span class="o">|</span> <span class="n">PSC_SPIEVNT_TU</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_SD</span><span class="p">))</span>
			<span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * due to an spi error we consider transfer as done,</span>
<span class="cm">		 * so mask all events until before next transfer start</span>
<span class="cm">		 * and stop the possibly running dma immediatelly</span>
<span class="cm">		 */</span>
		<span class="n">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>
		<span class="n">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>

		<span class="cm">/* get number of transferred bytes */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">au1xxx_get_dma_residue</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">au1xxx_get_dma_residue</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>

		<span class="n">au1xxx_dbdma_reset</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>
		<span class="n">au1xxx_dbdma_reset</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>
		<span class="n">au1550_spi_reset_fifos</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">evnt</span> <span class="o">==</span> <span class="n">PSC_SPIEVNT_RO</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;dma transfer: receive FIFO overflow!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;dma transfer: unexpected SPI error &quot;</span>
				<span class="s">&quot;(event=0x%x stat=0x%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">evnt</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">evnt</span> <span class="o">&amp;</span> <span class="n">PSC_SPIEVNT_MD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* transfer completed successfully */</span>
		<span class="n">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* routines to handle different word sizes in pio mode */</span>
<span class="cp">#define AU1550_SPI_RX_WORD(size, mask)					\</span>
<span class="cp">static void au1550_spi_rx_word_##size(struct au1550_spi *hw)		\</span>
<span class="cp">{									\</span>
<span class="cp">	u32 fifoword = hw-&gt;regs-&gt;psc_spitxrx &amp; (u32)(mask);		\</span>
<span class="cp">	au_sync();							\</span>
<span class="cp">	if (hw-&gt;rx) {							\</span>
<span class="cp">		*(u##size *)hw-&gt;rx = (u##size)fifoword;			\</span>
<span class="cp">		hw-&gt;rx += (size) / 8;					\</span>
<span class="cp">	}								\</span>
<span class="cp">	hw-&gt;rx_count += (size) / 8;					\</span>
<span class="cp">}</span>

<span class="cp">#define AU1550_SPI_TX_WORD(size, mask)					\</span>
<span class="cp">static void au1550_spi_tx_word_##size(struct au1550_spi *hw)		\</span>
<span class="cp">{									\</span>
<span class="cp">	u32 fifoword = 0;						\</span>
<span class="cp">	if (hw-&gt;tx) {							\</span>
<span class="cp">		fifoword = *(u##size *)hw-&gt;tx &amp; (u32)(mask);		\</span>
<span class="cp">		hw-&gt;tx += (size) / 8;					\</span>
<span class="cp">	}								\</span>
<span class="cp">	hw-&gt;tx_count += (size) / 8;					\</span>
<span class="cp">	if (hw-&gt;tx_count &gt;= hw-&gt;len)					\</span>
<span class="cp">		fifoword |= PSC_SPITXRX_LC;				\</span>
<span class="cp">	hw-&gt;regs-&gt;psc_spitxrx = fifoword;				\</span>
<span class="cp">	au_sync();							\</span>
<span class="cp">}</span>

<span class="n">AU1550_SPI_RX_WORD</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0xff</span><span class="p">)</span>
<span class="n">AU1550_SPI_RX_WORD</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mh">0xffff</span><span class="p">)</span>
<span class="n">AU1550_SPI_RX_WORD</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mh">0xffffff</span><span class="p">)</span>
<span class="n">AU1550_SPI_TX_WORD</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0xff</span><span class="p">)</span>
<span class="n">AU1550_SPI_TX_WORD</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mh">0xffff</span><span class="p">)</span>
<span class="n">AU1550_SPI_TX_WORD</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mh">0xffffff</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">au1550_spi_pio_txrxb</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* by default enable nearly all events after filling tx fifo */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">PSC_SPIMSK_SD</span><span class="p">;</span>

	<span class="cm">/* fill the transmit FIFO */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_word</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mask tx fifo request interrupt as we are done */</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">PSC_SPIMSK_TR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_TF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable event interrupts */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spimsk</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="cm">/* start the transfer */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spipcr</span> <span class="o">=</span> <span class="n">PSC_SPIPCR_MS</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">?</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">:</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">au1550_spi_pio_irq_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">busy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">evnt</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
	<span class="n">evnt</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spievent</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_DI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">evnt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSC_SPIEVNT_MM</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_RO</span>
				<span class="o">|</span> <span class="n">PSC_SPIEVNT_RU</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_TO</span>
				<span class="o">|</span> <span class="n">PSC_SPIEVNT_SD</span><span class="p">))</span>
			<span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * due to an error we consider transfer as done,</span>
<span class="cm">		 * so mask all events until before next transfer start</span>
<span class="cm">		 */</span>
		<span class="n">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">au1550_spi_reset_fifos</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pio transfer: unexpected SPI error &quot;</span>
			<span class="s">&quot;(event=0x%x stat=0x%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">evnt</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * while there is something to read from rx fifo</span>
<span class="cm">	 * or there is a space to write to tx fifo:</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * Take care to not let the Rx FIFO overflow.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We only write a byte if we have read one at least. Initially,</span>
<span class="cm">		 * the write fifo is full, so we should read from the read fifo</span>
<span class="cm">		 * first.</span>
<span class="cm">		 * In case we miss a word from the read fifo, we should get a</span>
<span class="cm">		 * RO event and should back out.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_RE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_word</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_TF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_word</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">busy</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spievent</span> <span class="o">=</span> <span class="n">PSC_SPIEVNT_RR</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_TR</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restart the SPI transmission in case of a transmit underflow.</span>
<span class="cm">	 * This seems to work despite the notes in the Au1550 data book</span>
<span class="cm">	 * of Figure 8-4 with flowchart for SPI master operation:</span>
<span class="cm">	 *</span>
<span class="cm">	 * &quot;&quot;&quot;Note 1: An XFR Error Interrupt occurs, unless masked,</span>
<span class="cm">	 * for any of the following events: Tx FIFO Underflow,</span>
<span class="cm">	 * Rx FIFO Overflow, or Multiple-master Error</span>
<span class="cm">	 *    Note 2: In case of a Tx Underflow Error, all zeroes are</span>
<span class="cm">	 * transmitted.&quot;&quot;&quot;</span>
<span class="cm">	 *</span>
<span class="cm">	 * By simply restarting the spi transfer on Tx Underflow Error,</span>
<span class="cm">	 * we assume that spi transfer was paused instead of zeroes</span>
<span class="cm">	 * transmittion mentioned in the Note 2 of Au1550 data book.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evnt</span> <span class="o">&amp;</span> <span class="n">PSC_SPIEVNT_TU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spievent</span> <span class="o">=</span> <span class="n">PSC_SPIEVNT_TU</span> <span class="o">|</span> <span class="n">PSC_SPIEVNT_MD</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spipcr</span> <span class="o">=</span> <span class="n">PSC_SPIPCR_MS</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* transfer completed successfully */</span>
		<span class="n">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">au1550_spi_txrx_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrx_bufs</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">au1550_spi_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">au1550_spi_bits_handlers_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpw</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrx_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_dma_txrxb</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_dma_irq_callback</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_word</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_rx_word_8</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_word</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_tx_word_8</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrx_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_pio_txrxb</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_pio_irq_callback</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpw</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_word</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_rx_word_16</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_word</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_tx_word_16</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrx_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_pio_txrxb</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_pio_irq_callback</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_word</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_rx_word_32</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_word</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_tx_word_32</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrx_bufs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_pio_txrxb</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1550_spi_pio_irq_callback</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">au1550_spi_setup_psc_as_spi</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* set up the PSC for SPI mode */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_ctrl</span> <span class="o">=</span> <span class="n">PSC_CTRL_DISABLE</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_sel</span> <span class="o">=</span> <span class="n">PSC_SEL_PS_SPIMODE</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_ctrl</span> <span class="o">=</span> <span class="n">PSC_CTRL_ENABLE</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_SR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>


	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">PSC_SPICFG_DD_DISABLE</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_SET_LEN</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_RT_FIFO8</span> <span class="o">|</span> <span class="n">PSC_SPICFG_TT_FIFO8</span><span class="p">;</span>
	<span class="cm">/* use minimal allowed brg and div values as initial setting: */</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_SET_BAUD</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">PSC_SPICFG_SET_DIV</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef AU1550_SPI_DEBUG_LOOPBACK</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_LB</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">au1550_spi_mask_ack_all</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spicfg</span> <span class="o">|=</span> <span class="n">PSC_SPICFG_DE_ENABLE</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psc_spistat</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PSC_SPISTAT_DR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">au1550_spi_reset_fifos</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">au1550_spi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">spi_alloc_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">au1550_spi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory for spi_master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the spi-&gt;mode bits understood by this driver: */</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">mode_bits</span> <span class="o">=</span> <span class="n">SPI_CPOL</span> <span class="o">|</span> <span class="n">SPI_CPHA</span> <span class="o">|</span> <span class="n">SPI_CS_HIGH</span> <span class="o">|</span> <span class="n">SPI_LSB_FIRST</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">spi_master_get</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_pdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_iores</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usedma</span> <span class="o">&amp;&amp;</span> <span class="n">ddma_memid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no dma mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mmio resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_iores</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ioarea</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psc_spi_t</span><span class="p">),</span>
					<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ioarea</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot reserve iomem region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_iores</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="n">psc_spi_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psc_spi_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot ioremap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master_done</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">setup_transfer</span> <span class="o">=</span> <span class="n">au1550_spi_setupxfer</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">chipselect</span> <span class="o">=</span> <span class="n">au1550_spi_chipsel</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">au1550_spi_setup</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">txrx_bufs</span> <span class="o">=</span> <span class="n">au1550_spi_txrx_bufs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span> <span class="o">=</span> <span class="n">au1xxx_dbdma_chan_alloc</span><span class="p">(</span><span class="n">ddma_memid</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot allocate tx dma channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_no_txdma</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">au1xxx_dbdma_set_devwidth</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">au1xxx_dbdma_ring_alloc</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">,</span>
			<span class="n">AU1550_SPI_DBDMA_DESCRIPTORS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot allocate tx dma descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_no_txdma_descr</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span> <span class="o">=</span> <span class="n">au1xxx_dbdma_chan_alloc</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_id</span><span class="p">,</span>
			<span class="n">ddma_memid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot allocate rx dma channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_no_rxdma</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">au1xxx_dbdma_set_devwidth</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">au1xxx_dbdma_ring_alloc</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">,</span>
			<span class="n">AU1550_SPI_DBDMA_DESCRIPTORS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot allocate rx dma descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_no_rxdma_descr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">au1550_spi_dma_rxtmp_alloc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">AU1550_SPI_DMA_RXTMP_MINSIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot allocate initial rx dma tmp buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_dma_rxtmp_alloc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">au1550_spi_bits_handlers_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">au1550_spi_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot claim IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_chipselect</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  precompute valid range for spi freq - from au1550 datasheet:</span>
<span class="cm">	 *    psc_tempclk = psc_mainclk / (2 &lt;&lt; DIV)</span>
<span class="cm">	 *    spiclk = psc_tempclk / (2 * (BRG + 1))</span>
<span class="cm">	 *    BRG valid range is 4..63</span>
<span class="cm">	 *    DIV valid range is 0..3</span>
<span class="cm">	 *  round the min and max frequencies to values that would still</span>
<span class="cm">	 *  produce valid brg and div</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">min_div</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">max_div</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">63</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_max</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mainclk_hz</span> <span class="o">/</span> <span class="n">min_div</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">freq_min</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mainclk_hz</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">au1550_spi_setup_psc_as_spi</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">spi_bitbang_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register SPI master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;spi master registered: bus_num=%d num_chipselect=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_register:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

<span class="nl">err_no_irq:</span>
	<span class="n">au1550_spi_dma_rxtmp_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="nl">err_dma_rxtmp_alloc:</span>
<span class="nl">err_no_rxdma_descr:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span>
		<span class="n">au1xxx_dbdma_chan_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>

<span class="nl">err_no_rxdma:</span>
<span class="nl">err_no_txdma_descr:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span>
		<span class="n">au1xxx_dbdma_chan_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>

<span class="nl">err_no_txdma:</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

<span class="nl">err_ioremap:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ioarea</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ioarea</span><span class="p">);</span>

<span class="nl">err_no_iores:</span>
<span class="nl">err_no_pdata:</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

<span class="nl">err_nomem:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="n">au1550_spi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">au1550_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spi master remove: bus_num=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">);</span>

	<span class="n">spi_bitbang_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ioarea</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ioarea</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usedma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">au1550_spi_dma_rxtmp_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">au1xxx_dbdma_chan_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_rx_ch</span><span class="p">);</span>
		<span class="n">au1xxx_dbdma_chan_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma_tx_ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* work with hotplug and coldplug */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:au1550-spi&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">au1550_spi_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">au1550_spi_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;au1550-spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">au1550_spi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * create memory device with 8 bits dev_devwidth</span>
<span class="cm">	 * needed for proper byte ordering to spi fifo</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usedma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddma_memid</span> <span class="o">=</span> <span class="n">au1xxx_ddma_add_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1550_spi_mem_dbdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddma_memid</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;au1550-spi: cannot add memory&quot;</span>
					<span class="s">&quot;dbdma device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1550_spi_drv</span><span class="p">,</span> <span class="n">au1550_spi_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">au1550_spi_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">au1550_spi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usedma</span> <span class="o">&amp;&amp;</span> <span class="n">ddma_memid</span><span class="p">)</span>
		<span class="n">au1xxx_ddma_del_device</span><span class="p">(</span><span class="n">ddma_memid</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1550_spi_drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">au1550_spi_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Au1550 PSC SPI Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jan Nikitenko &lt;jan.nikitenko@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
