<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › spi › spi-dw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>spi-dw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Designware SPI core controller driver (refer pxa2xx_spi.c)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>

<span class="cp">#include &quot;spi-dw.h&quot;</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define START_STATE	((void *)0)</span>
<span class="cp">#define RUNNING_STATE	((void *)1)</span>
<span class="cp">#define DONE_STATE	((void *)2)</span>
<span class="cp">#define ERROR_STATE	((void *)-1)</span>

<span class="cp">#define QUEUE_RUNNING	0</span>
<span class="cp">#define QUEUE_STOPPED	1</span>

<span class="cp">#define MRST_SPI_DEASSERT	0</span>
<span class="cp">#define MRST_SPI_ASSERT		1</span>

<span class="cm">/* Slave spi_dev related */</span>
<span class="k">struct</span> <span class="n">chip_data</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">cr0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cs</span><span class="p">;</span>			<span class="cm">/* chip select pin */</span>
	<span class="n">u8</span> <span class="n">n_bytes</span><span class="p">;</span>		<span class="cm">/* current is a 1/2/4 byte op */</span>
	<span class="n">u8</span> <span class="n">tmode</span><span class="p">;</span>		<span class="cm">/* TR/TO/RO/EEPROM */</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>		<span class="cm">/* SPI/SSP/MicroWire */</span>

	<span class="n">u8</span> <span class="n">poll_mode</span><span class="p">;</span>		<span class="cm">/* 1 means use poll mode */</span>

	<span class="n">u32</span> <span class="n">dma_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_threshold</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_threshold</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_dma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bits_per_word</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk_div</span><span class="p">;</span>		<span class="cm">/* baud rate divider */</span>
	<span class="n">u32</span> <span class="n">speed_hz</span><span class="p">;</span>		<span class="cm">/* baud rate */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cs_control</span><span class="p">)(</span><span class="n">u32</span> <span class="n">command</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="cp">#define SPI_REGS_BUFSIZE	1024</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="nf">spi_show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dws</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SPI_REGS_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;MRST SPI0 registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;=================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;CTRL0: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_CTRL0</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;CTRL1: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_CTRL1</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;SSIENR: </span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_SSIENR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;SER: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_SER</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;BAUDR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_BAUDR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;TXFTLR: </span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLTR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;RXFTLR: </span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_RXFLTR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;TXFLR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;RXFLR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_RXFLR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;SR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_SR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;IMR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_IMR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;ISR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_ISR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;DMACR: </span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_DMACR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;DMATDLR: </span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_DMATDLR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;DMARDLR: </span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_DMARDLR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">SPI_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;=================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mrst_spi_regs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">spi_show_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mrst_spi_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;mrst_spi&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dws</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrst_spi_regs_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mrst_spi_debugfs_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span>
		<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mrst_spi_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mrst_spi_debugfs_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="cm">/* Return the max entries we can fill into tx fifo */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">tx_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tx_left</span><span class="p">,</span> <span class="n">tx_room</span><span class="p">,</span> <span class="n">rxtx_gap</span><span class="p">;</span>

	<span class="n">tx_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">-</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span> <span class="o">/</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>
	<span class="n">tx_room</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">-</span> <span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Another concern is about the tx/rx mismatch, we</span>
<span class="cm">	 * though to use (dws-&gt;fifo_len - rxflr - txflr) as</span>
<span class="cm">	 * one maximum value for tx, but it doesn&#39;t cover the</span>
<span class="cm">	 * data which is out of tx/rx fifo and inside the</span>
<span class="cm">	 * shift registers. So a control from sw point of</span>
<span class="cm">	 * view is taken.</span>
<span class="cm">	 */</span>
	<span class="n">rxtx_gap</span> <span class="o">=</span>  <span class="p">((</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">-</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">-</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">))</span>
			<span class="o">/</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">min3</span><span class="p">(</span><span class="n">tx_left</span><span class="p">,</span> <span class="n">tx_room</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">-</span> <span class="n">rxtx_gap</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Return the max entries we should read out of rx fifo */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rx_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rx_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">-</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">/</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">rx_left</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_RXFLR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_writer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max</span> <span class="o">=</span> <span class="n">tx_max</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">txw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">max</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the tx word if the transfer&#39;s original &quot;tx&quot; is not null */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">-</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">txw</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">txw</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dw_writew</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_DR</span><span class="p">,</span> <span class="n">txw</span><span class="p">);</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_reader</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max</span> <span class="o">=</span> <span class="n">rx_max</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">rxw</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">max</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxw</span> <span class="o">=</span> <span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_DR</span><span class="p">);</span>
		<span class="cm">/* Care rx only if the transfer&#39;s original &quot;rx&quot; is not null */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">-</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span> <span class="n">rxw</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="o">=</span> <span class="n">rxw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">next_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">trans</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="p">;</span>

	<span class="cm">/* Move to next transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">trans</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span>
					<span class="n">transfer_list</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RUNNING_STATE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">DONE_STATE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: first step is the protocol driver prepares</span>
<span class="cm"> * a dma-capable memory, and this func just need translate</span>
<span class="cm"> * the virt addr to physical</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_dma_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">is_dma_mapped</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_inited</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="o">-&gt;</span><span class="n">enable_dma</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">)</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">)</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Caller already set message-&gt;status; dma and pio irqs are blocked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">giveback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">last_transfer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">prev_chip</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_messages</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">last_transfer</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span>
					<span class="n">transfer_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span> <span class="o">&amp;&amp;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">)</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">(</span><span class="n">MRST_SPI_DEASSERT</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_error_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Stop the hw */</span>
	<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ERROR_STATE</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dw_spi_xfer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Update total byte transferred return count actual bytes read */</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Move to next transfer */</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_transfer</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>

	<span class="cm">/* Handle end of message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DONE_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">giveback</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dw_spi_xfer_done</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">irq_status</span> <span class="o">=</span> <span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_ISR</span><span class="p">);</span>

	<span class="cm">/* Error handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SPI_INT_TXOI</span> <span class="o">|</span> <span class="n">SPI_INT_RXOI</span> <span class="o">|</span> <span class="n">SPI_INT_RXUI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXOICR</span><span class="p">);</span>
		<span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_RXOICR</span><span class="p">);</span>
		<span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_RXUICR</span><span class="p">);</span>
		<span class="n">int_error_stop</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="s">&quot;interrupt_transfer: fifo overrun/underrun&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dw_reader</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">==</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_mask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">SPI_INT_TXEI</span><span class="p">);</span>
		<span class="n">dw_spi_xfer_done</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">SPI_INT_TXEI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_mask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">SPI_INT_TXEI</span><span class="p">);</span>
		<span class="n">dw_writer</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
		<span class="cm">/* Enable TX irq always, it will be disabled when RX finished */</span>
		<span class="n">spi_umask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">SPI_INT_TXEI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dw_spi_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_status</span> <span class="o">=</span> <span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_ISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_mask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">SPI_INT_TXEI</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">transfer_handler</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Must be called inside pump_transfers() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">poll_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dw_writer</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
		<span class="n">dw_reader</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">&gt;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

	<span class="n">dw_spi_xfer_done</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pump_transfers</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">transfer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">previous</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">imask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cs_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txint_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get current state information */</span>
	<span class="n">message</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">;</span>
	<span class="n">transfer</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="p">;</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_chip</span><span class="p">;</span>
	<span class="n">spi</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">max_freq</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ERROR_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">early_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle end of message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DONE_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">early_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delay if requested at end of transfer*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RUNNING_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">transfer_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span>
					<span class="n">transfer_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">delay_usecs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_width</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_width</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cs_control</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">;</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx_end</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">+</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">+</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cs_change</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">cs_change</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">prev_chip</span><span class="p">)</span>
		<span class="n">cs_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cr0</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">;</span>

	<span class="cm">/* Handle per transfer options for bpw and speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">speed_hz</span> <span class="o">!=</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MRST SPI0: unsupported&quot;</span>
					<span class="s">&quot;freq: %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
				<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">early_exit</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* clk_div doesn&#39;t support odd number */</span>
			<span class="n">clk_div</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">max_freq</span> <span class="o">/</span> <span class="n">speed</span><span class="p">;</span>
			<span class="n">clk_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk_div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">;</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">speed_hz</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="n">clk_div</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_width</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MRST SPI0: unsupported bits:&quot;</span>
				<span class="s">&quot;%db</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
			<span class="n">message</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">early_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_FRF_OFFSET</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_MODE_OFFSET</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_TMOD_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">message</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RUNNING_STATE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust transfer mode if necessary. Requires platform dependent</span>
<span class="cm">	 * chipselect mechanism.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&amp;&amp;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">=</span> <span class="n">SPI_TMOD_TR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">=</span> <span class="n">SPI_TMOD_RO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">=</span> <span class="n">SPI_TMOD_TO</span><span class="p">;</span>

		<span class="n">cr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SPI_TMOD_MASK</span><span class="p">;</span>
		<span class="n">cr0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_TMOD_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check if current transfer is a DMA transaction */</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_mapped</span> <span class="o">=</span> <span class="n">map_dma_buffers</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupt mode</span>
<span class="cm">	 * we only need set the TXEI IRQ, as TX/RX always happen syncronizely</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_mapped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">poll_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">templen</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">n_bytes</span><span class="p">;</span>
		<span class="n">txint_level</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">txint_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">templen</span> <span class="o">&gt;</span> <span class="n">txint_level</span><span class="p">)</span> <span class="o">?</span> <span class="n">txint_level</span> <span class="o">:</span> <span class="n">templen</span><span class="p">;</span>

		<span class="n">imask</span> <span class="o">|=</span> <span class="n">SPI_INT_TXEI</span> <span class="o">|</span> <span class="n">SPI_INT_TXOI</span> <span class="o">|</span> <span class="n">SPI_INT_RXUI</span> <span class="o">|</span> <span class="n">SPI_INT_RXOI</span><span class="p">;</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">transfer_handler</span> <span class="o">=</span> <span class="n">interrupt_transfer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reprogram registers only if</span>
<span class="cm">	 *	1. chip select changes</span>
<span class="cm">	 *	2. clk_div is changed</span>
<span class="cm">	 *	3. control value changes</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_CTRL0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cr0</span> <span class="o">||</span> <span class="n">cs_change</span> <span class="o">||</span> <span class="n">clk_div</span> <span class="o">||</span> <span class="n">imask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_CTRL0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cr0</span><span class="p">)</span>
			<span class="n">dw_writew</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_CTRL0</span><span class="p">,</span> <span class="n">cr0</span><span class="p">);</span>

		<span class="n">spi_set_clk</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">clk_div</span> <span class="o">?</span> <span class="n">clk_div</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">);</span>
		<span class="n">spi_chip_sel</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">);</span>

		<span class="cm">/* Set the interrupt mask, for poll mode just disable all int */</span>
		<span class="n">spi_mask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imask</span><span class="p">)</span>
			<span class="n">spi_umask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txint_level</span><span class="p">)</span>
			<span class="n">dw_writew</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLTR</span><span class="p">,</span> <span class="n">txint_level</span><span class="p">);</span>

		<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs_change</span><span class="p">)</span>
			<span class="n">dws</span><span class="o">-&gt;</span><span class="n">prev_chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_mapped</span><span class="p">)</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_transfer</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">cs_change</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">poll_mode</span><span class="p">)</span>
		<span class="n">poll_transfer</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">early_exit:</span>
	<span class="n">giveback</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pump_messages</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dw_spi</span><span class="p">,</span> <span class="n">pump_messages</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Lock queue and check for queue work */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">==</span> <span class="n">QUEUE_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we are not already running a message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Extract head of queue */</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* Initial message state*/</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">START_STATE</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">transfers</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">spi_transfer</span><span class="p">,</span>
						<span class="n">transfer_list</span><span class="p">);</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_chip</span> <span class="o">=</span> <span class="n">spi_get_ctldata</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">);</span>

	<span class="cm">/* Mark as busy and launch transfers */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">);</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* spi_device use this to queue in their spi_msg */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dw_spi_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">==</span> <span class="n">QUEUE_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">START_STATE</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">==</span> <span class="n">QUEUE_RUNNING</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">||</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span><span class="p">)</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_messages</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If no other data transaction in air, just go */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">pump_messages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_messages</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This may be called twice for each spi dev */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dw_spi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_spi_chip</span> <span class="o">*</span><span class="n">chip_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Only alloc on first setup */</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">spi_get_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chip_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Protocol drivers may change the chip settings, so...</span>
<span class="cm">	 * if chip_info exists, use it</span>
<span class="cm">	 */</span>
	<span class="n">chip_info</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">controller_data</span><span class="p">;</span>

	<span class="cm">/* chip_info doesn&#39;t always exist */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cs_control</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">cs_control</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">poll_mode</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">poll_mode</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rx_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tx_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">enable_dma</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Never take &gt;16b case for MRST SPIC */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid wordsize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No max speed HZ parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">speed_hz</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Tx &amp; Rx */</span>
	<span class="cm">/* Default SPI mode is SCPOL = 0, SCPH = 0 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_FRF_OFFSET</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span>  <span class="o">&lt;&lt;</span> <span class="n">SPI_MODE_OFFSET</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">tmode</span> <span class="o">&lt;&lt;</span> <span class="n">SPI_TMOD_OFFSET</span><span class="p">);</span>

	<span class="n">spi_set_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_spi_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chip_data</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">spi_get_ctldata</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="n">QUEUE_STOPPED</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_transfers</span><span class="p">,</span>
			<span class="n">pump_transfers</span><span class="p">,</span>	<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dws</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_messages</span><span class="p">,</span> <span class="n">pump_messages</span><span class="p">);</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span>
					<span class="n">dev_name</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">==</span> <span class="n">QUEUE_RUNNING</span> <span class="o">||</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="n">QUEUE_RUNNING</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_transfer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cur_chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">prev_chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">pump_messages</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="n">QUEUE_STOPPED</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">destroy_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">stop_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Restart the controller, disable all interrupts, clean rx fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spi_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spi_mask_intr</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to detect the FIFO depth if not set by interface driver,</span>
<span class="cm">	 * the depth could be from 2 to 256 from HW spec</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fifo</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">fifo</span> <span class="o">&lt;=</span> <span class="mi">257</span><span class="p">;</span> <span class="n">fifo</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dw_writew</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLTR</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">!=</span> <span class="n">dw_readw</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLTR</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">==</span> <span class="mi">257</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">fifo</span><span class="p">;</span>
		<span class="n">dw_writew</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="n">DW_SPI_TXFLTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dw_spi_add_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dws</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">spi_alloc_master</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SSI_MOTO_SPI</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">prev_chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;dw_spi%d&quot;</span><span class="p">,</span>
			<span class="n">dws</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dw_spi_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">dws</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can not get IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_master</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">mode_bits</span> <span class="o">=</span> <span class="n">SPI_CPOL</span> <span class="o">|</span> <span class="n">SPI_CPHA</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">num_cs</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">dw_spi_cleanup</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">dw_spi_setup</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">dw_spi_transfer</span><span class="p">;</span>

	<span class="cm">/* Basic HW init */</span>
	<span class="n">spi_hw_init</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span> <span class="o">&amp;&amp;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_init</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initial and start queue */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;problem initializing queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_diable_hw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">start_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;problem starting queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_diable_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_master_set_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">dws</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_register_master</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;problem registering spi master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_queue_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mrst_spi_debugfs_init</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_queue_alloc:</span>
	<span class="n">destroy_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span> <span class="o">&amp;&amp;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_exit</span><span class="p">)</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_exit</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
<span class="nl">err_diable_hw:</span>
	<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dws</span><span class="p">);</span>
<span class="nl">err_free_master:</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dw_spi_add_host</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">dw_spi_remove_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dws</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mrst_spi_debugfs_remove</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>

	<span class="cm">/* Remove the queue */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">destroy_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dw_spi_remove: workqueue will not &quot;</span>
			<span class="s">&quot;complete, message memory not freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span> <span class="o">&amp;&amp;</span> <span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_exit</span><span class="p">)</span>
		<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_ops</span><span class="o">-&gt;</span><span class="n">dma_exit</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Disable clk */</span>
	<span class="n">spi_set_clk</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dws</span><span class="p">);</span>

	<span class="cm">/* Disconnect from the SPI framework */</span>
	<span class="n">spi_unregister_master</span><span class="p">(</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dw_spi_remove_host</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dw_spi_suspend_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">stop_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">spi_enable_chip</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spi_set_clk</span><span class="p">(</span><span class="n">dws</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dw_spi_suspend_host</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dw_spi_resume_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_spi</span> <span class="o">*</span><span class="n">dws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spi_hw_init</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">start_queue</span><span class="p">(</span><span class="n">dws</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dws</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fail to start queue (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dw_spi_resume_host</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Feng Tang &lt;feng.tang@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for DesignWare SPI controller core&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
