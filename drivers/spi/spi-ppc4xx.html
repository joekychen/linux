<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › spi › spi-ppc4xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>spi-ppc4xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SPI_PPC4XX SPI controller driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Gary Jennejohn &lt;garyj@denx.de&gt;</span>
<span class="cm"> * Copyright 2008 Stefan Roese &lt;sr@denx.de&gt;, DENX Software Engineering</span>
<span class="cm"> * Copyright 2009 Harris Corporation, Steven A. Falco &lt;sfalco@harris.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based in part on drivers/spi/spi_s3c24xx.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006 Ben Dooks</span>
<span class="cm"> * Copyright (c) 2006 Simtec Electronics</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The PPC4xx SPI controller has no FIFO so each sent/received byte will</span>
<span class="cm"> * generate an interrupt to the CPU. This can cause high CPU utilization.</span>
<span class="cm"> * This driver allows platforms to reduce the interrupt load on the CPU</span>
<span class="cm"> * during SPI transfers by setting max_speed_hz via the device tree.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi_bitbang.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dcr.h&gt;</span>
<span class="cp">#include &lt;asm/dcr-regs.h&gt;</span>

<span class="cm">/* bits in mode register - bit 0 is MSb */</span>

<span class="cm">/*</span>
<span class="cm"> * SPI_PPC4XX_MODE_SCP = 0 means &quot;data latched on trailing edge of clock&quot;</span>
<span class="cm"> * SPI_PPC4XX_MODE_SCP = 1 means &quot;data latched on leading edge of clock&quot;</span>
<span class="cm"> * Note: This is the inverse of CPHA.</span>
<span class="cm"> */</span>
<span class="cp">#define SPI_PPC4XX_MODE_SCP	(0x80 &gt;&gt; 3)</span>

<span class="cm">/* SPI_PPC4XX_MODE_SPE = 1 means &quot;port enabled&quot; */</span>
<span class="cp">#define SPI_PPC4XX_MODE_SPE	(0x80 &gt;&gt; 4)</span>

<span class="cm">/*</span>
<span class="cm"> * SPI_PPC4XX_MODE_RD = 0 means &quot;MSB first&quot; - this is the normal mode</span>
<span class="cm"> * SPI_PPC4XX_MODE_RD = 1 means &quot;LSB first&quot; - this is bit-reversed mode</span>
<span class="cm"> * Note: This is identical to SPI_LSB_FIRST.</span>
<span class="cm"> */</span>
<span class="cp">#define SPI_PPC4XX_MODE_RD	(0x80 &gt;&gt; 5)</span>

<span class="cm">/*</span>
<span class="cm"> * SPI_PPC4XX_MODE_CI = 0 means &quot;clock idles low&quot;</span>
<span class="cm"> * SPI_PPC4XX_MODE_CI = 1 means &quot;clock idles high&quot;</span>
<span class="cm"> * Note: This is identical to CPOL.</span>
<span class="cm"> */</span>
<span class="cp">#define SPI_PPC4XX_MODE_CI	(0x80 &gt;&gt; 6)</span>

<span class="cm">/*</span>
<span class="cm"> * SPI_PPC4XX_MODE_IL = 0 means &quot;loopback disable&quot;</span>
<span class="cm"> * SPI_PPC4XX_MODE_IL = 1 means &quot;loopback enable&quot;</span>
<span class="cm"> */</span>
<span class="cp">#define SPI_PPC4XX_MODE_IL	(0x80 &gt;&gt; 7)</span>

<span class="cm">/* bits in control register */</span>
<span class="cm">/* starts a transfer when set */</span>
<span class="cp">#define SPI_PPC4XX_CR_STR	(0x80 &gt;&gt; 7)</span>

<span class="cm">/* bits in status register */</span>
<span class="cm">/* port is busy with a transfer */</span>
<span class="cp">#define SPI_PPC4XX_SR_BSY	(0x80 &gt;&gt; 6)</span>
<span class="cm">/* RxD ready */</span>
<span class="cp">#define SPI_PPC4XX_SR_RBR	(0x80 &gt;&gt; 7)</span>

<span class="cm">/* clock settings (SCP and CI) for various SPI modes */</span>
<span class="cp">#define SPI_CLK_MODE0	(SPI_PPC4XX_MODE_SCP | 0)</span>
<span class="cp">#define SPI_CLK_MODE1	(0 | 0)</span>
<span class="cp">#define SPI_CLK_MODE2	(SPI_PPC4XX_MODE_SCP | SPI_PPC4XX_MODE_CI)</span>
<span class="cp">#define SPI_CLK_MODE3	(0 | SPI_PPC4XX_MODE_CI)</span>

<span class="cp">#define DRIVER_NAME	&quot;spi_ppc4xx_of&quot;</span>

<span class="k">struct</span> <span class="n">spi_ppc4xx_regs</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rxd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divisor modulus register</span>
<span class="cm">	 * This uses the follwing formula:</span>
<span class="cm">	 *    SCPClkOut = OPBCLK/(4(CDM + 1))</span>
<span class="cm">	 * or</span>
<span class="cm">	 *    CDM = (OPBCLK/4*SCPClkOut) - 1</span>
<span class="cm">	 * bit 0 is the MSb!</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">cdm</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SPI Controller driver&#39;s private data. */</span>
<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="p">{</span>
	<span class="cm">/* bitbang has to be first */</span>
	<span class="k">struct</span> <span class="n">spi_bitbang</span> <span class="n">bitbang</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">mapbase</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mapsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irqnum</span><span class="p">;</span>
	<span class="cm">/* need this to set the SPI clock */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opb_freq</span><span class="p">;</span>

	<span class="cm">/* for transfers */</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/* data buffers */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>

	<span class="kt">int</span> <span class="o">*</span><span class="n">gpios</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">spi_ppc4xx_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span> <span class="cm">/* pointer to the registers */</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* need this so we can set the clock in the chipselect routine */</span>
<span class="k">struct</span> <span class="n">spi_ppc4xx_cs</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">spi_ppc4xx_txrx</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;txrx: tx %p, rx %p, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send the first byte */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">?</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">,</span> <span class="n">SPI_PPC4XX_CR_STR</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">spi_ppc4xx_setupxfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_transfer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">spi_ppc4xx_cs</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">controller_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cdm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bits_per_word</span><span class="p">;</span>

	<span class="cm">/* Start with the generic configuration for this device. */</span>
	<span class="n">bits_per_word</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Modify the configuration if the transfer overrides it.  Do not allow</span>
<span class="cm">	 * the transfer to overwrite the generic configuration with zeros.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">)</span>
			<span class="n">bits_per_word</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">speed_hz</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits_per_word</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid bits-per-word (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bits_per_word</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">speed</span> <span class="o">||</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid speed_hz (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write new configration */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* Set the clock */</span>
	<span class="cm">/* opb_freq was already divided by 4 */</span>
	<span class="n">scr</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">opb_freq</span> <span class="o">/</span> <span class="n">speed</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cdm</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting pre-scaler to %d (hz %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdm</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cdm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cdm</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cdm</span><span class="p">,</span> <span class="n">cdm</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">chipselect</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="n">BITBANG_CS_INACTIVE</span><span class="p">);</span>
		<span class="cm">/* Need to ndelay here? */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">spi_ppc4xx_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_ppc4xx_cs</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">controller_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid bits-per-word (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">max_speed_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid max_speed_hz (must be non-zero)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">spi</span><span class="o">-&gt;</span><span class="n">controller_state</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We set all bits of the SPI0_MODE register, so,</span>
<span class="cm">	 * no need to read-modify-write</span>
<span class="cm">	 */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SPI_PPC4XX_MODE_SPE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SPI_CPHA</span> <span class="o">|</span> <span class="n">SPI_CPOL</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPI_MODE_0</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SPI_CLK_MODE0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPI_MODE_1</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SPI_CLK_MODE1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPI_MODE_2</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SPI_CLK_MODE2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPI_MODE_3</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SPI_CLK_MODE3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_LSB_FIRST</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SPI_PPC4XX_MODE_RD</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spi_ppc4xx_chipsel</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cspol</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there are no chip selects at all, or if this is the special</span>
<span class="cm">	 * case of a non-existent (dummy) chip select, do nothing.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cspol</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CS_HIGH</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">BITBANG_CS_INACTIVE</span><span class="p">)</span>
		<span class="n">cspol</span> <span class="o">=</span> <span class="o">!</span><span class="n">cspol</span><span class="p">;</span>

	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">[</span><span class="n">cs</span><span class="p">],</span> <span class="n">cspol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">spi_ppc4xx_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BSY de-asserts one cycle after the transfer is complete.  The</span>
<span class="cm">	 * interrupt is asserted after the transfer is complete.  The exact</span>
<span class="cm">	 * relationship is not documented, hence this code.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SPI_PPC4XX_SR_BSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">lstatus</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;got interrupt but spi still busy?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ndelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">lstatus</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">SPI_PPC4XX_SR_BSY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;busywait: too many loops!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* status is always 1 (RBR) here */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;loops %d status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* RBR triggered this interrupt.  Therefore, data must be ready. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">?</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">,</span> <span class="n">SPI_PPC4XX_CR_STR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spi_ppc4xx_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">controller_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spi_ppc4xx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * On all 4xx PPC&#39;s the SPI bus is shared/multiplexed with</span>
<span class="cm">	 * the 2nd I2C bus. We need to enable the the SPI bus before</span>
<span class="cm">	 * using it.</span>
<span class="cm">	 */</span>

	<span class="cm">/* need to clear bit 14 to enable SPC */</span>
	<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">SDR0_PFC1</span><span class="p">,</span> <span class="mh">0x80000000</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_gpios</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">gpio_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * platform_device layer stuff...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">spi_ppc4xx_of_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_bitbang</span> <span class="o">*</span><span class="n">bbp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">opbnp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_gpios</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">spi_alloc_master</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">spi_master_get</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A count of zero implies a single SPI device without any chip-select.</span>
<span class="cm">	 * Note that of_gpio_count counts all gpios assigned to this spi master.</span>
<span class="cm">	 * This includes both &quot;null&quot; gpio&#39;s and real ones.</span>
<span class="cm">	 */</span>
	<span class="n">num_gpios</span> <span class="o">=</span> <span class="n">of_gpio_count</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_gpios</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_gpios</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_master</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_gpios</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">gpio</span><span class="p">;</span>
			<span class="k">enum</span> <span class="n">of_gpio_flags</span> <span class="n">flags</span><span class="p">;</span>

			<span class="n">gpio</span> <span class="o">=</span> <span class="n">of_get_gpio_flags</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">gpios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">gpio</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Real CS - set the initial state. */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t request gpio &quot;</span>
							<span class="s">&quot;#%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span>
						<span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OF_GPIO_ACTIVE_LOW</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">;</span> <span class="cm">/* No CS, but that&#39;s OK. */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid gpio #%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the state for the bitbang driver */</span>
	<span class="n">bbp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">setup_transfer</span> <span class="o">=</span> <span class="n">spi_ppc4xx_setupxfer</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">chipselect</span> <span class="o">=</span> <span class="n">spi_ppc4xx_chipsel</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">txrx_bufs</span> <span class="o">=</span> <span class="n">spi_ppc4xx_txrx</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">spi_ppc4xx_setup</span><span class="p">;</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">spi_ppc4xx_cleanup</span><span class="p">;</span>

	<span class="cm">/* the spi-&gt;mode bits understood by this driver: */</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">mode_bits</span> <span class="o">=</span>
		<span class="n">SPI_CPHA</span> <span class="o">|</span> <span class="n">SPI_CPOL</span> <span class="o">|</span> <span class="n">SPI_CS_HIGH</span> <span class="o">|</span> <span class="n">SPI_LSB_FIRST</span><span class="p">;</span>

	<span class="cm">/* this many pins in all GPIO controllers */</span>
	<span class="n">bbp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="n">num_gpios</span><span class="p">;</span>

	<span class="cm">/* Get the clock for the OPB */</span>
	<span class="n">opbnp</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,opb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opbnp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OPB: cannot find node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get the clock (Hz) for the OPB */</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">opbnp</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OPB: no clock-frequency property set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">opbnp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">opb_freq</span> <span class="o">=</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">opb_freq</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">opbnp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error while parsing device node resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">resource</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapsize</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource</span><span class="p">);</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapsize</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_ppc4xx_regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;too small to map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request IRQ */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irqnum</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irqnum</span><span class="p">,</span> <span class="n">spi_ppc4xx_int</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;spi_ppc4xx_of&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_gpios</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resource unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">request_mem_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_ppc4xx_regs</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to memory map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">map_io_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_ppc4xx_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Finally register our spi controller */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_bitbang_start</span><span class="p">(</span><span class="n">bbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register SPI master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap_regs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unmap_regs:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">map_io_error:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapsize</span><span class="p">);</span>
<span class="nl">request_mem_error:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irqnum</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
<span class="nl">free_gpios:</span>
	<span class="n">free_gpios</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">free_master:</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spi_master_put</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">spi_ppc4xx_of_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ppc4xx_spi</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">spi_master_get_devdata</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="n">spi_bitbang_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bitbang</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mapsize</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irqnum</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">free_gpios</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">spi_ppc4xx_of_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ibm,ppc4xx-spi&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">spi_ppc4xx_of_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">spi_ppc4xx_of_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">spi_ppc4xx_of_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">spi_ppc4xx_of_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">spi_ppc4xx_of_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">spi_ppc4xx_of_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gary Jennejohn &amp; Stefan Roese&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Simple PPC4xx SPI Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
