<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › savage › savage_drv.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>savage_drv.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* savage_drv.h -- Private header for the savage driver */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright 2004  Felix Kuehling</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sub license,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the</span>
<span class="cm"> * next paragraph) shall be included in all copies or substantial portions</span>
<span class="cm"> * of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NON-INFRINGEMENT. IN NO EVENT SHALL FELIX KUEHLING BE LIABLE FOR</span>
<span class="cm"> * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF</span>
<span class="cm"> * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION</span>
<span class="cm"> * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __SAVAGE_DRV_H__</span>
<span class="cp">#define __SAVAGE_DRV_H__</span>

<span class="cp">#define DRIVER_AUTHOR	&quot;Felix Kuehling&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;savage&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;Savage3D/MX/IX, Savage4, SuperSavage, Twister, ProSavage[DDR]&quot;</span>
<span class="cp">#define DRIVER_DATE	&quot;20050313&quot;</span>

<span class="cp">#define DRIVER_MAJOR		2</span>
<span class="cp">#define DRIVER_MINOR		4</span>
<span class="cp">#define DRIVER_PATCHLEVEL	1</span>
<span class="cm">/* Interface history:</span>
<span class="cm"> *</span>
<span class="cm"> * 1.x   The DRM driver from the VIA/S3 code drop, basically a dummy</span>
<span class="cm"> * 2.0   The first real DRM</span>
<span class="cm"> * 2.1   Scissors registers managed by the DRM, 3D operations clipped by</span>
<span class="cm"> *       cliprects of the cmdbuf ioctl</span>
<span class="cm"> * 2.2   Implemented SAVAGE_CMD_DMA_IDX and SAVAGE_CMD_VB_IDX</span>
<span class="cm"> * 2.3   Event counters used by BCI_EVENT_EMIT/WAIT ioctls are now 32 bits</span>
<span class="cm"> *       wide and thus very long lived (unlikely to ever wrap). The size</span>
<span class="cm"> *       in the struct was 32 bits before, but only 16 bits were used</span>
<span class="cm"> * 2.4   Implemented command DMA. Now drm_savage_init_t.cmd_dma_offset is</span>
<span class="cm"> *       actually used</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_savage_age</span> <span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wrap</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_savage_age_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_savage_buf_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_savage_buf_priv</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_savage_buf_priv</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">drm_savage_age_t</span> <span class="n">age</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_savage_buf_priv_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_savage_dma_page</span> <span class="p">{</span>
	<span class="n">drm_savage_age_t</span> <span class="n">age</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">used</span><span class="p">,</span> <span class="n">flushed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_savage_dma_page_t</span><span class="p">;</span>
<span class="cp">#define SAVAGE_DMA_PAGE_SIZE 1024	</span><span class="cm">/* in dwords */</span><span class="cp"></span>
<span class="cm">/* Fake DMA buffer size in bytes. 4 pages. Allows a maximum command</span>
<span class="cm"> * size of 16kbytes or 4k entries. Minimum requirement would be</span>
<span class="cm"> * 10kbytes for 255 40-byte vertices in one drawing command. */</span>
<span class="cp">#define SAVAGE_FAKE_DMA_SIZE (SAVAGE_DMA_PAGE_SIZE*4*4)</span>

<span class="cm">/* interesting bits of hardware state that are saved in dev_priv */</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_savage_common_state</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">vbaddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pad</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_savage_common_state</span><span class="p">)];</span>
		<span class="kt">uint32_t</span> <span class="n">texctrl</span><span class="p">,</span> <span class="n">texaddr</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">scstart</span><span class="p">,</span> <span class="n">new_scstart</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">scend</span><span class="p">,</span> <span class="n">new_scend</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">s3d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pad</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_savage_common_state</span><span class="p">)];</span>
		<span class="kt">uint32_t</span> <span class="n">texdescr</span><span class="p">,</span> <span class="n">texaddr0</span><span class="p">,</span> <span class="n">texaddr1</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">drawctrl0</span><span class="p">,</span> <span class="n">new_drawctrl0</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">drawctrl1</span><span class="p">,</span> <span class="n">new_drawctrl1</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">s4</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_savage_state_t</span><span class="p">;</span>

<span class="cm">/* these chip tags should match the ones in the 2D driver in savage_regs.h. */</span>
<span class="k">enum</span> <span class="n">savage_family</span> <span class="p">{</span>
	<span class="n">S3_UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">S3_SAVAGE3D</span><span class="p">,</span>
	<span class="n">S3_SAVAGE_MX</span><span class="p">,</span>
	<span class="n">S3_SAVAGE4</span><span class="p">,</span>
	<span class="n">S3_PROSAVAGE</span><span class="p">,</span>
	<span class="n">S3_TWISTER</span><span class="p">,</span>
	<span class="n">S3_PROSAVAGEDDR</span><span class="p">,</span>
	<span class="n">S3_SUPERSAVAGE</span><span class="p">,</span>
	<span class="n">S3_SAVAGE2000</span><span class="p">,</span>
	<span class="n">S3_LAST</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">drm_ioctl_desc</span> <span class="n">savage_ioctls</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">savage_max_ioctl</span><span class="p">;</span>

<span class="cp">#define S3_SAVAGE3D_SERIES(chip)  ((chip&gt;=S3_SAVAGE3D) &amp;&amp; (chip&lt;=S3_SAVAGE_MX))</span>

<span class="cp">#define S3_SAVAGE4_SERIES(chip)  ((chip==S3_SAVAGE4)            \</span>
<span class="cp">                                  || (chip==S3_PROSAVAGE)       \</span>
<span class="cp">                                  || (chip==S3_TWISTER)         \</span>
<span class="cp">                                  || (chip==S3_PROSAVAGEDDR))</span>

<span class="cp">#define	S3_SAVAGE_MOBILE_SERIES(chip)	((chip==S3_SAVAGE_MX) || (chip==S3_SUPERSAVAGE))</span>

<span class="cp">#define S3_SAVAGE_SERIES(chip)    ((chip&gt;=S3_SAVAGE3D) &amp;&amp; (chip&lt;=S3_SAVAGE2000))</span>

<span class="cp">#define S3_MOBILE_TWISTER_SERIES(chip)   ((chip==S3_TWISTER)    \</span>
<span class="cp">                                          ||(chip==S3_PROSAVAGEDDR))</span>

<span class="cm">/* flags */</span>
<span class="cp">#define SAVAGE_IS_AGP 1</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_savage_private</span> <span class="p">{</span>
	<span class="n">drm_savage_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">drm_savage_buf_priv_t</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>

	<span class="cm">/* who am I? */</span>
	<span class="k">enum</span> <span class="n">savage_family</span> <span class="n">chipset</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cob_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bci_threshold_lo</span><span class="p">,</span> <span class="n">bci_threshold_hi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_type</span><span class="p">;</span>

	<span class="cm">/* frame buffer layout */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fb_bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">front_offset</span><span class="p">,</span> <span class="n">front_pitch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">back_offset</span><span class="p">,</span> <span class="n">back_pitch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_offset</span><span class="p">,</span> <span class="n">depth_pitch</span><span class="p">;</span>

	<span class="cm">/* bitmap descriptors for swap and clear */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">front_bd</span><span class="p">,</span> <span class="n">back_bd</span><span class="p">,</span> <span class="n">depth_bd</span><span class="p">;</span>

	<span class="cm">/* local textures */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">texture_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">texture_size</span><span class="p">;</span>

	<span class="cm">/* memory regions in physical memory */</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">sarea</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">aperture</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">agp_textures</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">cmd_dma</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="n">fake_dma</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">handle</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mtrr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* BCI and status-related stuff */</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">status_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">bci_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status_used_mask</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">event_counter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_wrap</span><span class="p">;</span>

	<span class="cm">/* Savage4 command DMA */</span>
	<span class="n">drm_savage_dma_page_t</span> <span class="o">*</span><span class="n">dma_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_dma_pages</span><span class="p">,</span> <span class="n">first_dma_page</span><span class="p">,</span> <span class="n">current_dma_page</span><span class="p">;</span>
	<span class="n">drm_savage_age_t</span> <span class="n">last_dma_age</span><span class="p">;</span>

	<span class="cm">/* saved hw state for global/local check on S3D */</span>
	<span class="kt">uint32_t</span> <span class="n">hw_draw_ctrl</span><span class="p">,</span> <span class="n">hw_zbuf_ctrl</span><span class="p">;</span>
	<span class="cm">/* and for scissors (global, so don&#39;t emit if not changed) */</span>
	<span class="kt">uint32_t</span> <span class="n">hw_scissors_start</span><span class="p">,</span> <span class="n">hw_scissors_end</span><span class="p">;</span>

	<span class="n">drm_savage_state_t</span> <span class="n">state</span><span class="p">;</span>

	<span class="cm">/* after emitting a wait cmd Savage3D needs 63 nops before next DMA */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">waiting</span><span class="p">;</span>

	<span class="cm">/* config/hardware-dependent function pointers */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">wait_fifo</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_savage_private</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">wait_evnt</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_savage_private</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">e</span><span class="p">);</span>
	<span class="cm">/* Err, there is a macro wait_event in include/linux/wait.h.</span>
<span class="cm">	 * Avoid unwanted macro expansion. */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">emit_clip_rect</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_savage_private</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span> <span class="n">pbox</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dma_flush</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_savage_private</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span> <span class="n">drm_savage_private_t</span><span class="p">;</span>

<span class="cm">/* ioctls */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">savage_bci_cmdbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">savage_bci_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>

<span class="cm">/* BCI functions */</span>
<span class="k">extern</span> <span class="kt">uint16_t</span> <span class="n">savage_bci_emit_event</span><span class="p">(</span><span class="n">drm_savage_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_freelist_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span> <span class="n">buf</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_dma_reset</span><span class="p">(</span><span class="n">drm_savage_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_dma_wait</span><span class="p">(</span><span class="n">drm_savage_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">savage_dma_alloc</span><span class="p">(</span><span class="n">drm_savage_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">savage_driver_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chipset</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">savage_driver_firstopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_driver_lastclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">savage_driver_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_reclaim_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>

<span class="cm">/* state functions */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_emit_clip_rect_s3d</span><span class="p">(</span><span class="n">drm_savage_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span> <span class="n">pbox</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">savage_emit_clip_rect_s4</span><span class="p">(</span><span class="n">drm_savage_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span> <span class="n">pbox</span><span class="p">);</span>

<span class="cp">#define SAVAGE_FB_SIZE_S3	0x01000000	</span><span class="cm">/*  16MB */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_FB_SIZE_S4	0x02000000	</span><span class="cm">/*  32MB */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_MMIO_SIZE        0x00080000	</span><span class="cm">/* 512kB */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_APERTURE_OFFSET  0x02000000	</span><span class="cm">/*  32MB */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_APERTURE_SIZE    0x05000000	</span><span class="cm">/* 5 tiled surfaces, 16MB each */</span><span class="cp"></span>

<span class="cp">#define SAVAGE_BCI_OFFSET       0x00010000	</span><span class="cm">/* offset of the BCI region</span>
<span class="cm">						 * inside the MMIO region */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_BCI_FIFO_SIZE	32	</span><span class="cm">/* number of entries in on-chip</span>
<span class="cm">					 * BCI FIFO */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * MMIO registers</span>
<span class="cm"> */</span>
<span class="cp">#define SAVAGE_STATUS_WORD0		0x48C00</span>
<span class="cp">#define SAVAGE_STATUS_WORD1		0x48C04</span>
<span class="cp">#define SAVAGE_ALT_STATUS_WORD0 	0x48C60</span>

<span class="cp">#define SAVAGE_FIFO_USED_MASK_S3D	0x0001ffff</span>
<span class="cp">#define SAVAGE_FIFO_USED_MASK_S4	0x001fffff</span>

<span class="cm">/* Copied from savage_bci.h in the 2D driver with some renaming. */</span>

<span class="cm">/* Bitmap descriptors */</span>
<span class="cp">#define SAVAGE_BD_STRIDE_SHIFT 0</span>
<span class="cp">#define SAVAGE_BD_BPP_SHIFT   16</span>
<span class="cp">#define SAVAGE_BD_TILE_SHIFT  24</span>
<span class="cp">#define SAVAGE_BD_BW_DISABLE  (1&lt;&lt;28)</span>
<span class="cm">/* common: */</span>
<span class="cp">#define	SAVAGE_BD_TILE_LINEAR		0</span>
<span class="cm">/* savage4, MX, IX, 3D */</span>
<span class="cp">#define	SAVAGE_BD_TILE_16BPP		2</span>
<span class="cp">#define	SAVAGE_BD_TILE_32BPP		3</span>
<span class="cm">/* twister, prosavage, DDR, supersavage, 2000 */</span>
<span class="cp">#define	SAVAGE_BD_TILE_DEST		1</span>
<span class="cp">#define	SAVAGE_BD_TILE_TEXTURE		2</span>
<span class="cm">/* GBD - BCI enable */</span>
<span class="cm">/* savage4, MX, IX, 3D */</span>
<span class="cp">#define SAVAGE_GBD_BCI_ENABLE                    8</span>
<span class="cm">/* twister, prosavage, DDR, supersavage, 2000 */</span>
<span class="cp">#define SAVAGE_GBD_BCI_ENABLE_TWISTER            0</span>

<span class="cp">#define SAVAGE_GBD_BIG_ENDIAN                    4</span>
<span class="cp">#define SAVAGE_GBD_LITTLE_ENDIAN                 0</span>
<span class="cp">#define SAVAGE_GBD_64                            1</span>

<span class="cm">/*  Global Bitmap Descriptor */</span>
<span class="cp">#define SAVAGE_BCI_GLB_BD_LOW             0x8168</span>
<span class="cp">#define SAVAGE_BCI_GLB_BD_HIGH            0x816C</span>

<span class="cm">/*</span>
<span class="cm"> * BCI registers</span>
<span class="cm"> */</span>
<span class="cm">/* Savage4/Twister/ProSavage 3D registers */</span>
<span class="cp">#define SAVAGE_DRAWLOCALCTRL_S4		0x1e</span>
<span class="cp">#define SAVAGE_TEXPALADDR_S4		0x1f</span>
<span class="cp">#define SAVAGE_TEXCTRL0_S4		0x20</span>
<span class="cp">#define SAVAGE_TEXCTRL1_S4		0x21</span>
<span class="cp">#define SAVAGE_TEXADDR0_S4		0x22</span>
<span class="cp">#define SAVAGE_TEXADDR1_S4		0x23</span>
<span class="cp">#define SAVAGE_TEXBLEND0_S4		0x24</span>
<span class="cp">#define SAVAGE_TEXBLEND1_S4		0x25</span>
<span class="cp">#define SAVAGE_TEXXPRCLR_S4		0x26	</span><span class="cm">/* never used */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_TEXDESCR_S4		0x27</span>
<span class="cp">#define SAVAGE_FOGTABLE_S4		0x28</span>
<span class="cp">#define SAVAGE_FOGCTRL_S4		0x30</span>
<span class="cp">#define SAVAGE_STENCILCTRL_S4		0x31</span>
<span class="cp">#define SAVAGE_ZBUFCTRL_S4		0x32</span>
<span class="cp">#define SAVAGE_ZBUFOFF_S4		0x33</span>
<span class="cp">#define SAVAGE_DESTCTRL_S4		0x34</span>
<span class="cp">#define SAVAGE_DRAWCTRL0_S4		0x35</span>
<span class="cp">#define SAVAGE_DRAWCTRL1_S4		0x36</span>
<span class="cp">#define SAVAGE_ZWATERMARK_S4		0x37</span>
<span class="cp">#define SAVAGE_DESTTEXRWWATERMARK_S4	0x38</span>
<span class="cp">#define SAVAGE_TEXBLENDCOLOR_S4		0x39</span>
<span class="cm">/* Savage3D/MX/IX 3D registers */</span>
<span class="cp">#define SAVAGE_TEXPALADDR_S3D		0x18</span>
<span class="cp">#define SAVAGE_TEXXPRCLR_S3D		0x19	</span><span class="cm">/* never used */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_TEXADDR_S3D		0x1A</span>
<span class="cp">#define SAVAGE_TEXDESCR_S3D		0x1B</span>
<span class="cp">#define SAVAGE_TEXCTRL_S3D		0x1C</span>
<span class="cp">#define SAVAGE_FOGTABLE_S3D		0x20</span>
<span class="cp">#define SAVAGE_FOGCTRL_S3D		0x30</span>
<span class="cp">#define SAVAGE_DRAWCTRL_S3D		0x31</span>
<span class="cp">#define SAVAGE_ZBUFCTRL_S3D		0x32</span>
<span class="cp">#define SAVAGE_ZBUFOFF_S3D		0x33</span>
<span class="cp">#define SAVAGE_DESTCTRL_S3D		0x34</span>
<span class="cp">#define SAVAGE_SCSTART_S3D		0x35</span>
<span class="cp">#define SAVAGE_SCEND_S3D		0x36</span>
<span class="cp">#define SAVAGE_ZWATERMARK_S3D		0x37</span>
<span class="cp">#define SAVAGE_DESTTEXRWWATERMARK_S3D	0x38</span>
<span class="cm">/* common stuff */</span>
<span class="cp">#define SAVAGE_VERTBUFADDR		0x3e</span>
<span class="cp">#define SAVAGE_BITPLANEWTMASK		0xd7</span>
<span class="cp">#define SAVAGE_DMABUFADDR		0x51</span>

<span class="cm">/* texture enable bits (needed for tex addr checking) */</span>
<span class="cp">#define SAVAGE_TEXCTRL_TEXEN_MASK	0x00010000	</span><span class="cm">/* S3D */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_TEXDESCR_TEX0EN_MASK	0x02000000	</span><span class="cm">/* S4 */</span><span class="cp"></span>
<span class="cp">#define SAVAGE_TEXDESCR_TEX1EN_MASK	0x04000000	</span><span class="cm">/* S4 */</span><span class="cp"></span>

<span class="cm">/* Global fields in Savage4/Twister/ProSavage 3D registers:</span>
<span class="cm"> *</span>
<span class="cm"> * All texture registers and DrawLocalCtrl are local. All other</span>
<span class="cm"> * registers are global. */</span>

<span class="cm">/* Global fields in Savage3D/MX/IX 3D registers:</span>
<span class="cm"> *</span>
<span class="cm"> * All texture registers are local. DrawCtrl and ZBufCtrl are</span>
<span class="cm"> * partially local. All other registers are global.</span>
<span class="cm"> *</span>
<span class="cm"> * DrawCtrl global fields: cullMode, alphaTestCmpFunc, alphaTestEn, alphaRefVal</span>
<span class="cm"> * ZBufCtrl global fields: zCmpFunc, zBufEn</span>
<span class="cm"> */</span>
<span class="cp">#define SAVAGE_DRAWCTRL_S3D_GLOBAL	0x03f3c00c</span>
<span class="cp">#define SAVAGE_ZBUFCTRL_S3D_GLOBAL	0x00000027</span>

<span class="cm">/* Masks for scissor bits (drawCtrl[01] on s4, scissorStart/End on s3d)</span>
<span class="cm"> */</span>
<span class="cp">#define SAVAGE_SCISSOR_MASK_S4		0x00fff7ff</span>
<span class="cp">#define SAVAGE_SCISSOR_MASK_S3D		0x07ff07ff</span>

<span class="cm">/*</span>
<span class="cm"> * BCI commands</span>
<span class="cm"> */</span>
<span class="cp">#define BCI_CMD_NOP                  0x40000000</span>
<span class="cp">#define BCI_CMD_RECT                 0x48000000</span>
<span class="cp">#define BCI_CMD_RECT_XP              0x01000000</span>
<span class="cp">#define BCI_CMD_RECT_YP              0x02000000</span>
<span class="cp">#define BCI_CMD_SCANLINE             0x50000000</span>
<span class="cp">#define BCI_CMD_LINE                 0x5C000000</span>
<span class="cp">#define BCI_CMD_LINE_LAST_PIXEL      0x58000000</span>
<span class="cp">#define BCI_CMD_BYTE_TEXT            0x63000000</span>
<span class="cp">#define BCI_CMD_NT_BYTE_TEXT         0x67000000</span>
<span class="cp">#define BCI_CMD_BIT_TEXT             0x6C000000</span>
<span class="cp">#define BCI_CMD_GET_ROP(cmd)         (((cmd) &gt;&gt; 16) &amp; 0xFF)</span>
<span class="cp">#define BCI_CMD_SET_ROP(cmd, rop)    ((cmd) |= ((rop &amp; 0xFF) &lt;&lt; 16))</span>
<span class="cp">#define BCI_CMD_SEND_COLOR           0x00008000</span>

<span class="cp">#define BCI_CMD_CLIP_NONE            0x00000000</span>
<span class="cp">#define BCI_CMD_CLIP_CURRENT         0x00002000</span>
<span class="cp">#define BCI_CMD_CLIP_LR              0x00004000</span>
<span class="cp">#define BCI_CMD_CLIP_NEW             0x00006000</span>

<span class="cp">#define BCI_CMD_DEST_GBD             0x00000000</span>
<span class="cp">#define BCI_CMD_DEST_PBD             0x00000800</span>
<span class="cp">#define BCI_CMD_DEST_PBD_NEW         0x00000C00</span>
<span class="cp">#define BCI_CMD_DEST_SBD             0x00001000</span>
<span class="cp">#define BCI_CMD_DEST_SBD_NEW         0x00001400</span>

<span class="cp">#define BCI_CMD_SRC_TRANSPARENT      0x00000200</span>
<span class="cp">#define BCI_CMD_SRC_SOLID            0x00000000</span>
<span class="cp">#define BCI_CMD_SRC_GBD              0x00000020</span>
<span class="cp">#define BCI_CMD_SRC_COLOR            0x00000040</span>
<span class="cp">#define BCI_CMD_SRC_MONO             0x00000060</span>
<span class="cp">#define BCI_CMD_SRC_PBD_COLOR        0x00000080</span>
<span class="cp">#define BCI_CMD_SRC_PBD_MONO         0x000000A0</span>
<span class="cp">#define BCI_CMD_SRC_PBD_COLOR_NEW    0x000000C0</span>
<span class="cp">#define BCI_CMD_SRC_PBD_MONO_NEW     0x000000E0</span>
<span class="cp">#define BCI_CMD_SRC_SBD_COLOR        0x00000100</span>
<span class="cp">#define BCI_CMD_SRC_SBD_MONO         0x00000120</span>
<span class="cp">#define BCI_CMD_SRC_SBD_COLOR_NEW    0x00000140</span>
<span class="cp">#define BCI_CMD_SRC_SBD_MONO_NEW     0x00000160</span>

<span class="cp">#define BCI_CMD_PAT_TRANSPARENT      0x00000010</span>
<span class="cp">#define BCI_CMD_PAT_NONE             0x00000000</span>
<span class="cp">#define BCI_CMD_PAT_COLOR            0x00000002</span>
<span class="cp">#define BCI_CMD_PAT_MONO             0x00000003</span>
<span class="cp">#define BCI_CMD_PAT_PBD_COLOR        0x00000004</span>
<span class="cp">#define BCI_CMD_PAT_PBD_MONO         0x00000005</span>
<span class="cp">#define BCI_CMD_PAT_PBD_COLOR_NEW    0x00000006</span>
<span class="cp">#define BCI_CMD_PAT_PBD_MONO_NEW     0x00000007</span>
<span class="cp">#define BCI_CMD_PAT_SBD_COLOR        0x00000008</span>
<span class="cp">#define BCI_CMD_PAT_SBD_MONO         0x00000009</span>
<span class="cp">#define BCI_CMD_PAT_SBD_COLOR_NEW    0x0000000A</span>
<span class="cp">#define BCI_CMD_PAT_SBD_MONO_NEW     0x0000000B</span>

<span class="cp">#define BCI_BD_BW_DISABLE            0x10000000</span>
<span class="cp">#define BCI_BD_TILE_MASK             0x03000000</span>
<span class="cp">#define BCI_BD_TILE_NONE             0x00000000</span>
<span class="cp">#define BCI_BD_TILE_16               0x02000000</span>
<span class="cp">#define BCI_BD_TILE_32               0x03000000</span>
<span class="cp">#define BCI_BD_GET_BPP(bd)           (((bd) &gt;&gt; 16) &amp; 0xFF)</span>
<span class="cp">#define BCI_BD_SET_BPP(bd, bpp)      ((bd) |= (((bpp) &amp; 0xFF) &lt;&lt; 16))</span>
<span class="cp">#define BCI_BD_GET_STRIDE(bd)        ((bd) &amp; 0xFFFF)</span>
<span class="cp">#define BCI_BD_SET_STRIDE(bd, st)    ((bd) |= ((st) &amp; 0xFFFF))</span>

<span class="cp">#define BCI_CMD_SET_REGISTER            0x96000000</span>

<span class="cp">#define BCI_CMD_WAIT                    0xC0000000</span>
<span class="cp">#define BCI_CMD_WAIT_3D                 0x00010000</span>
<span class="cp">#define BCI_CMD_WAIT_2D                 0x00020000</span>

<span class="cp">#define BCI_CMD_UPDATE_EVENT_TAG        0x98000000</span>

<span class="cp">#define BCI_CMD_DRAW_PRIM               0x80000000</span>
<span class="cp">#define BCI_CMD_DRAW_INDEXED_PRIM       0x88000000</span>
<span class="cp">#define BCI_CMD_DRAW_CONT               0x01000000</span>
<span class="cp">#define BCI_CMD_DRAW_TRILIST            0x00000000</span>
<span class="cp">#define BCI_CMD_DRAW_TRISTRIP           0x02000000</span>
<span class="cp">#define BCI_CMD_DRAW_TRIFAN             0x04000000</span>
<span class="cp">#define BCI_CMD_DRAW_SKIPFLAGS          0x000000ff</span>
<span class="cp">#define BCI_CMD_DRAW_NO_Z		0x00000001</span>
<span class="cp">#define BCI_CMD_DRAW_NO_W		0x00000002</span>
<span class="cp">#define BCI_CMD_DRAW_NO_CD		0x00000004</span>
<span class="cp">#define BCI_CMD_DRAW_NO_CS		0x00000008</span>
<span class="cp">#define BCI_CMD_DRAW_NO_U0		0x00000010</span>
<span class="cp">#define BCI_CMD_DRAW_NO_V0		0x00000020</span>
<span class="cp">#define BCI_CMD_DRAW_NO_UV0		0x00000030</span>
<span class="cp">#define BCI_CMD_DRAW_NO_U1		0x00000040</span>
<span class="cp">#define BCI_CMD_DRAW_NO_V1		0x00000080</span>
<span class="cp">#define BCI_CMD_DRAW_NO_UV1		0x000000c0</span>

<span class="cp">#define BCI_CMD_DMA			0xa8000000</span>

<span class="cp">#define BCI_W_H(w, h)                ((((h) &lt;&lt; 16) | (w)) &amp; 0x0FFF0FFF)</span>
<span class="cp">#define BCI_X_Y(x, y)                ((((y) &lt;&lt; 16) | (x)) &amp; 0x0FFF0FFF)</span>
<span class="cp">#define BCI_X_W(x, y)                ((((w) &lt;&lt; 16) | (x)) &amp; 0x0FFF0FFF)</span>
<span class="cp">#define BCI_CLIP_LR(l, r)            ((((r) &lt;&lt; 16) | (l)) &amp; 0x0FFF0FFF)</span>
<span class="cp">#define BCI_CLIP_TL(t, l)            ((((t) &lt;&lt; 16) | (l)) &amp; 0x0FFF0FFF)</span>
<span class="cp">#define BCI_CLIP_BR(b, r)            ((((b) &lt;&lt; 16) | (r)) &amp; 0x0FFF0FFF)</span>

<span class="cp">#define BCI_LINE_X_Y(x, y)           (((y) &lt;&lt; 16) | ((x) &amp; 0xFFFF))</span>
<span class="cp">#define BCI_LINE_STEPS(diag, axi)    (((axi) &lt;&lt; 16) | ((diag) &amp; 0xFFFF))</span>
<span class="cp">#define BCI_LINE_MISC(maj, ym, xp, yp, err) \</span>
<span class="cp">	(((maj) &amp; 0x1FFF) | \</span>
<span class="cp">	((ym) ? 1&lt;&lt;13 : 0) | \</span>
<span class="cp">	((xp) ? 1&lt;&lt;14 : 0) | \</span>
<span class="cp">	((yp) ? 1&lt;&lt;15 : 0) | \</span>
<span class="cp">	((err) &lt;&lt; 16))</span>

<span class="cm">/*</span>
<span class="cm"> * common commands</span>
<span class="cm"> */</span>
<span class="cp">#define BCI_SET_REGISTERS( first, n )			\</span>
<span class="cp">	BCI_WRITE(BCI_CMD_SET_REGISTER |		\</span>
<span class="cp">		  ((uint32_t)(n) &amp; 0xff) &lt;&lt; 16 |	\</span>
<span class="cp">		  ((uint32_t)(first) &amp; 0xffff))</span>
<span class="cp">#define DMA_SET_REGISTERS( first, n )			\</span>
<span class="cp">	DMA_WRITE(BCI_CMD_SET_REGISTER |		\</span>
<span class="cp">		  ((uint32_t)(n) &amp; 0xff) &lt;&lt; 16 |	\</span>
<span class="cp">		  ((uint32_t)(first) &amp; 0xffff))</span>

<span class="cp">#define BCI_DRAW_PRIMITIVE(n, type, skip)         \</span>
<span class="cp">        BCI_WRITE(BCI_CMD_DRAW_PRIM | (type) | (skip) | \</span>
<span class="cp">		  ((n) &lt;&lt; 16))</span>
<span class="cp">#define DMA_DRAW_PRIMITIVE(n, type, skip)         \</span>
<span class="cp">        DMA_WRITE(BCI_CMD_DRAW_PRIM | (type) | (skip) | \</span>
<span class="cp">		  ((n) &lt;&lt; 16))</span>

<span class="cp">#define BCI_DRAW_INDICES_S3D(n, type, i0)         \</span>
<span class="cp">        BCI_WRITE(BCI_CMD_DRAW_INDEXED_PRIM | (type) |  \</span>
<span class="cp">		  ((n) &lt;&lt; 16) | (i0))</span>

<span class="cp">#define BCI_DRAW_INDICES_S4(n, type, skip)        \</span>
<span class="cp">        BCI_WRITE(BCI_CMD_DRAW_INDEXED_PRIM | (type) |  \</span>
<span class="cp">                  (skip) | ((n) &lt;&lt; 16))</span>

<span class="cp">#define BCI_DMA(n)	\</span>
<span class="cp">	BCI_WRITE(BCI_CMD_DMA | (((n) &gt;&gt; 1) - 1))</span>

<span class="cm">/*</span>
<span class="cm"> * access to MMIO</span>
<span class="cm"> */</span>
<span class="cp">#define SAVAGE_READ(reg)	DRM_READ32(  dev_priv-&gt;mmio, (reg) )</span>
<span class="cp">#define SAVAGE_WRITE(reg)	DRM_WRITE32( dev_priv-&gt;mmio, (reg) )</span>

<span class="cm">/*</span>
<span class="cm"> * access to the burst command interface (BCI)</span>
<span class="cm"> */</span>
<span class="cp">#define SAVAGE_BCI_DEBUG 1</span>

<span class="cp">#define BCI_LOCALS    volatile uint32_t *bci_ptr;</span>

<span class="cp">#define BEGIN_BCI( n ) do {			\</span>
<span class="cp">	dev_priv-&gt;wait_fifo(dev_priv, (n));	\</span>
<span class="cp">	bci_ptr = dev_priv-&gt;bci_ptr;		\</span>
<span class="cp">} while(0)</span>

<span class="cp">#define BCI_WRITE( val ) *bci_ptr++ = (uint32_t)(val)</span>

<span class="cm">/*</span>
<span class="cm"> * command DMA support</span>
<span class="cm"> */</span>
<span class="cp">#define SAVAGE_DMA_DEBUG 1</span>

<span class="cp">#define DMA_LOCALS   uint32_t *dma_ptr;</span>

<span class="cp">#define BEGIN_DMA( n ) do {						\</span>
<span class="cp">	unsigned int cur = dev_priv-&gt;current_dma_page;			\</span>
<span class="cp">	unsigned int rest = SAVAGE_DMA_PAGE_SIZE -			\</span>
<span class="cp">		dev_priv-&gt;dma_pages[cur].used;				\</span>
<span class="cp">	if ((n) &gt; rest) {						\</span>
<span class="cp">		dma_ptr = savage_dma_alloc(dev_priv, (n));		\</span>
<span class="cp">	} else { </span><span class="cm">/* fast path for small allocations */</span><span class="cp">			\</span>
<span class="cp">		dma_ptr = (uint32_t *)dev_priv-&gt;cmd_dma-&gt;handle +	\</span>
<span class="cp">			cur * SAVAGE_DMA_PAGE_SIZE +			\</span>
<span class="cp">			dev_priv-&gt;dma_pages[cur].used;			\</span>
<span class="cp">		if (dev_priv-&gt;dma_pages[cur].used == 0)			\</span>
<span class="cp">			savage_dma_wait(dev_priv, cur);			\</span>
<span class="cp">		dev_priv-&gt;dma_pages[cur].used += (n);			\</span>
<span class="cp">	}								\</span>
<span class="cp">} while(0)</span>

<span class="cp">#define DMA_WRITE( val ) *dma_ptr++ = (uint32_t)(val)</span>

<span class="cp">#define DMA_COPY(src, n) do {					\</span>
<span class="cp">	memcpy(dma_ptr, (src), (n)*4);				\</span>
<span class="cp">	dma_ptr += n;						\</span>
<span class="cp">} while(0)</span>

<span class="cp">#if SAVAGE_DMA_DEBUG</span>
<span class="cp">#define DMA_COMMIT() do {						\</span>
<span class="cp">	unsigned int cur = dev_priv-&gt;current_dma_page;			\</span>
<span class="cp">	uint32_t *expected = (uint32_t *)dev_priv-&gt;cmd_dma-&gt;handle +	\</span>
<span class="cp">			cur * SAVAGE_DMA_PAGE_SIZE +			\</span>
<span class="cp">			dev_priv-&gt;dma_pages[cur].used;			\</span>
<span class="cp">	if (dma_ptr != expected) {					\</span>
<span class="cp">		DRM_ERROR(&quot;DMA allocation and use don&#39;t match: &quot;	\</span>
<span class="cp">			  &quot;%p != %p\n&quot;, expected, dma_ptr);		\</span>
<span class="cp">		savage_dma_reset(dev_priv);				\</span>
<span class="cp">	}								\</span>
<span class="cp">} while(0)</span>
<span class="cp">#else</span>
<span class="cp">#define DMA_COMMIT() do {</span><span class="cm">/* nothing */</span><span class="cp">} while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#define DMA_FLUSH() dev_priv-&gt;dma_flush(dev_priv)</span>

<span class="cm">/* Buffer aging via event tag</span>
<span class="cm"> */</span>

<span class="cp">#define UPDATE_EVENT_COUNTER( ) do {			\</span>
<span class="cp">	if (dev_priv-&gt;status_ptr) {			\</span>
<span class="cp">		uint16_t count;				\</span>
<span class="cp">		</span><span class="cm">/* coordinate with Xserver */</span><span class="cp">		\</span>
<span class="cp">		count = dev_priv-&gt;status_ptr[1023];	\</span>
<span class="cp">		if (count &lt; dev_priv-&gt;event_counter)	\</span>
<span class="cp">			dev_priv-&gt;event_wrap++;		\</span>
<span class="cp">		dev_priv-&gt;event_counter = count;	\</span>
<span class="cp">	}						\</span>
<span class="cp">} while(0)</span>

<span class="cp">#define SET_AGE( age, e, w ) do {	\</span>
<span class="cp">	(age)-&gt;event = e;		\</span>
<span class="cp">	(age)-&gt;wrap = w;		\</span>
<span class="cp">} while(0)</span>

<span class="cp">#define TEST_AGE( age, e, w )				\</span>
<span class="cp">	( (age)-&gt;wrap &lt; (w) || ( (age)-&gt;wrap == (w) &amp;&amp; (age)-&gt;event &lt;= (e) ) )</span>

<span class="cp">#endif				</span><span class="cm">/* __SAVAGE_DRV_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
