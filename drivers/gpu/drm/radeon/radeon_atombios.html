<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_atombios.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_atombios.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2007-8 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>

<span class="cp">#include &quot;atom.h&quot;</span>
<span class="cp">#include &quot;atom-bits.h&quot;</span>

<span class="cm">/* from radeon_encoder.c */</span>
<span class="k">extern</span> <span class="kt">uint32_t</span>
<span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span>
			<span class="kt">uint8_t</span> <span class="n">dac</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_link_encoder_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>
<span class="n">radeon_add_atom_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">encoder_enum</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span> <span class="n">u16</span> <span class="n">caps</span><span class="p">);</span>

<span class="cm">/* from radeon_connector.c */</span>
<span class="k">extern</span> <span class="kt">void</span>
<span class="n">radeon_add_atom_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">connector_id</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">connector_type</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="o">*</span><span class="n">i2c_bus</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">igp_lane_info</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">connector_object_id</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="o">*</span><span class="n">hpd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">radeon_router</span> <span class="o">*</span><span class="n">router</span><span class="p">);</span>

<span class="cm">/* from radeon_legacy_encoder.c */</span>
<span class="k">extern</span> <span class="kt">void</span>
<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">encoder_enum</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">);</span>

<span class="cm">/* local */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radeon_atom_get_max_vddc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">voltage_type</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">voltage_id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">voltage</span><span class="p">);</span>

<span class="k">union</span> <span class="n">atom_supported_devices</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_SUPPORTED_DEVICES_INFO</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_SUPPORTED_DEVICES_INFO_2</span> <span class="n">info_2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_SUPPORTED_DEVICES_INFO_2d1</span> <span class="n">info_2d1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_lookup_i2c_gpio_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					  <span class="n">ATOM_GPIO_I2C_ASSIGMENT</span> <span class="o">*</span><span class="n">gpio</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* r4xx mask is technically not used by the hw, so patch in the legacy mask bits */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R420</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R423</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RV410</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkMaskRegisterIndex</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0018</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkMaskRegisterIndex</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0019</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkMaskRegisterIndex</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x001a</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucClkMaskShift</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataMaskShift</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* some evergreen boards have bad data for this entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkMaskRegisterIndex</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1936</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span> <span class="o">=</span> <span class="mh">0x97</span><span class="p">;</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataMaskShift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataEnShift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataY_Shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataA_Shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* some DCE3 boards have bad data for this entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE3</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkMaskRegisterIndex</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1fda</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span> <span class="o">==</span> <span class="mh">0x94</span><span class="p">))</span>
			<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="nf">radeon_get_bus_rec_for_i2c_gpio</span><span class="p">(</span><span class="n">ATOM_GPIO_I2C_ASSIGMENT</span> <span class="o">*</span><span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span><span class="p">));</span>

	<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkMaskRegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usDataMaskRegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkEnRegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usDataEnRegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkY_RegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usDataY_RegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usClkA_RegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">usDataA_RegisterIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucClkMaskShift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataMaskShift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucClkEnShift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataEnShift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucClkY_Shift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataY_Shift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucClkA_Shift</span><span class="p">);</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ucDataA_Shift</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">sbfAccess</span><span class="p">.</span><span class="n">bfHW_Capable</span><span class="p">)</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">)</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mm_i2c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mm_i2c</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">i2c</span><span class="p">.</span><span class="n">i2c_id</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_reg</span><span class="p">)</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="nf">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
							       <span class="kt">uint8_t</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atom_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">;</span>
	<span class="n">ATOM_GPIO_I2C_ASSIGMENT</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">GPIO_I2C_Info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_ATOM_GPIO_I2C_INFO</span> <span class="o">*</span><span class="n">i2c_info</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_indices</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span><span class="p">));</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2c_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_GPIO_I2C_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_GPIO_I2C_ASSIGMENT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">asGPIO_Info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">radeon_lookup_i2c_gpio_quirks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i2c</span> <span class="o">=</span> <span class="n">radeon_get_bus_rec_for_i2c_gpio</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i2c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atombios_i2c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atom_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">;</span>
	<span class="n">ATOM_GPIO_I2C_ASSIGMENT</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">GPIO_I2C_Info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_ATOM_GPIO_I2C_INFO</span> <span class="o">*</span><span class="n">i2c_info</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_indices</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">stmp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2c_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_GPIO_I2C_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_GPIO_I2C_ASSIGMENT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">asGPIO_Info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">radeon_lookup_i2c_gpio_quirks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">i2c</span> <span class="o">=</span> <span class="n">radeon_get_bus_rec_for_i2c_gpio</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">stmp</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">i2c</span><span class="p">.</span><span class="n">i2c_id</span><span class="p">);</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">stmp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_gpio_rec</span> <span class="nf">radeon_lookup_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
							<span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atom_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_gpio_rec</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">GPIO_Pin_LUT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_ATOM_GPIO_PIN_LUT</span> <span class="o">*</span><span class="n">gpio_info</span><span class="p">;</span>
	<span class="n">ATOM_GPIO_PIN_ASSIGNMENT</span> <span class="o">*</span><span class="n">pin</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_indices</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_gpio_rec</span><span class="p">));</span>
	<span class="n">gpio</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gpio_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_GPIO_PIN_LUT</span> <span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_GPIO_PIN_ASSIGNMENT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pin</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gpio_info</span><span class="o">-&gt;</span><span class="n">asGPIO_Pin</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">pin</span><span class="o">-&gt;</span><span class="n">ucGPIO_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gpio</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pin</span><span class="o">-&gt;</span><span class="n">ucGPIO_ID</span><span class="p">;</span>
				<span class="n">gpio</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">usGpioPin_AIndex</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">gpio</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin</span><span class="o">-&gt;</span><span class="n">ucGpioPinBitShift</span><span class="p">);</span>
				<span class="n">gpio</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">gpio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="nf">radeon_atom_get_hpd_info_from_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
							    <span class="k">struct</span> <span class="n">radeon_gpio_rec</span> <span class="o">*</span><span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="n">hpd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_hpd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE6</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">SI_DC_GPIO_HPD_A</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">EVERGREEN_DC_GPIO_HPD_A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AVIVO_DC_GPIO_HPD_A</span><span class="p">;</span>

	<span class="n">hpd</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span>:
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>:
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>:
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>:
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span>:
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>:
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hpd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_atom_apply_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">connector_type</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="o">*</span><span class="n">i2c_bus</span><span class="p">,</span>
				     <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">line_mux</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="o">*</span><span class="n">hpd</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Asus M2A-VM HDMI board lists the DVI port as HDMI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x791e</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x826d</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">))</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Asrock RS600 board lists the DVI port as HDMI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x7941</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1849</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x7941</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">))</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MSI K9A2GM V2/V3 board has no HDMI or DVI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x796e</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1462</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x7302</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* a-bit f-i90hd - ciaranm on #radeonhd - this board has no DVI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x7941</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x147b</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x2412</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Falcon NW laptop lists vga ddc line for LVDS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5653</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1462</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0291</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="o">*</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* HIS X1300 is DVI+VGA, not DVI+DVI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x7146</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x17af</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x2058</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Gigabyte X1300 is DVI+VGA, not DVI+DVI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x7142</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1458</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x2134</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Funky macbooks */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x71C5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x106b</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0080</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span>
			<span class="o">*</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mac rv630, rv730, others */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_9PinDIN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">line_mux</span> <span class="o">=</span> <span class="n">CONNECTOR_7PIN_DIN_ENUM_ID1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ASUS HD 3600 XT board lists the DVI port as HDMI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x9598</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x01da</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ASUS HD 3600 board lists the DVI port as HDMI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x9598</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x01e4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ASUS HD 3450 board lists the DVI port as HDMI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x95C5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x01e2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* some BIOSes seem to report DAC on HDMI - usually this is a board with</span>
<span class="cm">	 * HDMI + VGA reporting as HDMI</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">supported_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">;</span>
			<span class="o">*</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Acer laptop (Acer TravelMate 5730/5730G) has an HDMI port</span>
<span class="cm">	 * on the laptop and a DVI port on the docking station and</span>
<span class="cm">	 * both share the same encoder, hpd pin, and ddc line.</span>
<span class="cm">	 * So while the bios table is technically correct,</span>
<span class="cm">	 * we drop the DVI port here since xrandr has no concept of</span>
<span class="cm">	 * encoders and will try and drive both connectors</span>
<span class="cm">	 * with different crtcs which isn&#39;t possible on the hardware</span>
<span class="cm">	 * side and leaves no crtcs for LVDS or VGA.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x95c4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x9591</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1025</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x013c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">supported_device</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* actually it&#39;s a DVI-D port not DVI-I */</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* XFX Pine Group device rv730 reports no VGA DDC lines</span>
<span class="cm">	 * even though they are wired up to record 0x93</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x9498</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1682</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x2452</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">supported_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
		<span class="o">*</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Fujitsu D3003-S2 board lists DVI-I as DVI-D and VGA */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x9802</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1734</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x11bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">;</span>
			<span class="o">*</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mh">0x3103</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">supported_devices_connector_convert</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVIA</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Composite</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_HDMIB</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_9PinDIN</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DisplayPort</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">supported_devices_connector_object_id_convert</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CONNECTOR_OBJECT_ID_NONE</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I</span><span class="p">,</span> <span class="cm">/* not all boards support DL */</span>
	<span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D</span><span class="p">,</span> <span class="cm">/* not all boards support DL */</span>
	<span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span> <span class="cm">/* technically DVI-A */</span>
	<span class="n">CONNECTOR_OBJECT_ID_COMPOSITE</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_9PIN_DIN</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_9PIN_DIN</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_DISPLAYPORT</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_HDMI_TYPE_A</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_HDMI_TYPE_B</span><span class="p">,</span>
	<span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">object_connector_convert</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Composite</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_9PinDIN</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_HDMIB</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_9PinDIN</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DisplayPort</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">radeon_get_atom_connector_info_from_object_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atom_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">Object_Header</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="n">ATOM_CONNECTOR_OBJECT_TABLE</span> <span class="o">*</span><span class="n">con_obj</span><span class="p">;</span>
	<span class="n">ATOM_ENCODER_OBJECT_TABLE</span> <span class="o">*</span><span class="n">enc_obj</span><span class="p">;</span>
	<span class="n">ATOM_OBJECT_TABLE</span> <span class="o">*</span><span class="n">router_obj</span><span class="p">;</span>
	<span class="n">ATOM_DISPLAY_OBJECT_PATH_TABLE</span> <span class="o">*</span><span class="n">path_obj</span><span class="p">;</span>
	<span class="n">ATOM_OBJECT_HEADER</span> <span class="o">*</span><span class="n">obj_header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">path_size</span><span class="p">,</span> <span class="n">device_support</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connector_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">igp_lane_info</span><span class="p">,</span> <span class="n">conn_id</span><span class="p">,</span> <span class="n">connector_object_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">ddc_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_router</span> <span class="n">router</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_gpio_rec</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="n">hpd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">obj_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_OBJECT_HEADER</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
	<span class="n">path_obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_DISPLAY_OBJECT_PATH_TABLE</span> <span class="o">*</span><span class="p">)</span>
	    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
	     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">obj_header</span><span class="o">-&gt;</span><span class="n">usDisplayPathTableOffset</span><span class="p">));</span>
	<span class="n">con_obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_CONNECTOR_OBJECT_TABLE</span> <span class="o">*</span><span class="p">)</span>
	    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
	     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">obj_header</span><span class="o">-&gt;</span><span class="n">usConnectorObjectTableOffset</span><span class="p">));</span>
	<span class="n">enc_obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_ENCODER_OBJECT_TABLE</span> <span class="o">*</span><span class="p">)</span>
	    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
	     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">obj_header</span><span class="o">-&gt;</span><span class="n">usEncoderObjectTableOffset</span><span class="p">));</span>
	<span class="n">router_obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_OBJECT_TABLE</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">obj_header</span><span class="o">-&gt;</span><span class="n">usRouterObjectTableOffset</span><span class="p">));</span>
	<span class="n">device_support</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">obj_header</span><span class="o">-&gt;</span><span class="n">usDeviceSupport</span><span class="p">);</span>

	<span class="n">path_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">path_obj</span><span class="o">-&gt;</span><span class="n">ucNumOfDispPath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">path_obj</span><span class="o">-&gt;</span><span class="n">asDispPath</span><span class="p">;</span>
		<span class="n">ATOM_DISPLAY_OBJECT_PATH</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">path_size</span><span class="p">;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_DISPLAY_OBJECT_PATH</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">path_size</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usSize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device_support</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usDeviceTag</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">con_obj_id</span><span class="p">,</span> <span class="n">con_obj_num</span><span class="p">,</span> <span class="n">con_obj_type</span><span class="p">;</span>

			<span class="n">con_obj_id</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usConnObjectId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBJECT_ID_MASK</span><span class="p">)</span>
			    <span class="o">&gt;&gt;</span> <span class="n">OBJECT_ID_SHIFT</span><span class="p">;</span>
			<span class="n">con_obj_num</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usConnObjectId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENUM_ID_MASK</span><span class="p">)</span>
			    <span class="o">&gt;&gt;</span> <span class="n">ENUM_ID_SHIFT</span><span class="p">;</span>
			<span class="n">con_obj_type</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usConnObjectId</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">OBJECT_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OBJECT_TYPE_SHIFT</span><span class="p">;</span>

			<span class="cm">/* TODO CV support */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usDeviceTag</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* IGP chips */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">con_obj_id</span> <span class="o">==</span>
			     <span class="n">CONNECTOR_OBJECT_ID_PCIE_CONNECTOR</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">uint16_t</span> <span class="n">igp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ATOM_INTEGRATED_SYSTEM_INFO_V2</span> <span class="o">*</span><span class="n">igp_obj</span><span class="p">;</span>

				<span class="n">index</span> <span class="o">=</span>
				    <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span>
							    <span class="n">IntegratedSystemInfo</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igp_offset</span><span class="p">))</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">igp_obj</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">ATOM_INTEGRATED_SYSTEM_INFO_V2</span>
							 <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">igp_offset</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">igp_obj</span><span class="p">)</span> <span class="p">{</span>
							<span class="kt">uint32_t</span> <span class="n">slot_config</span><span class="p">,</span> <span class="n">ct</span><span class="p">;</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">con_obj_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
								<span class="n">slot_config</span> <span class="o">=</span>
									<span class="n">igp_obj</span><span class="o">-&gt;</span>
									<span class="n">ulDDISlot1Config</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">slot_config</span> <span class="o">=</span>
									<span class="n">igp_obj</span><span class="o">-&gt;</span>
									<span class="n">ulDDISlot2Config</span><span class="p">;</span>

							<span class="n">ct</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot_config</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
							<span class="n">connector_type</span> <span class="o">=</span>
								<span class="n">object_connector_convert</span>
								<span class="p">[</span><span class="n">ct</span><span class="p">];</span>
							<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
							<span class="n">igp_lane_info</span> <span class="o">=</span>
								<span class="n">slot_config</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">igp_lane_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">connector_type</span> <span class="o">=</span>
						<span class="n">object_connector_convert</span><span class="p">[</span><span class="n">con_obj_id</span><span class="p">];</span>
					<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">con_obj_id</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">igp_lane_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">connector_type</span> <span class="o">=</span>
				    <span class="n">object_connector_convert</span><span class="p">[</span><span class="n">con_obj_id</span><span class="p">];</span>
				<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">con_obj_id</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">router</span><span class="p">.</span><span class="n">ddc_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">router</span><span class="p">.</span><span class="n">cd_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usSize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">uint8_t</span> <span class="n">grph_obj_id</span><span class="p">,</span> <span class="n">grph_obj_num</span><span class="p">,</span> <span class="n">grph_obj_type</span><span class="p">;</span>

				<span class="n">grph_obj_id</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usGraphicObjIds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span>
				     <span class="n">OBJECT_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OBJECT_ID_SHIFT</span><span class="p">;</span>
				<span class="n">grph_obj_num</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usGraphicObjIds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span>
				     <span class="n">ENUM_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ENUM_ID_SHIFT</span><span class="p">;</span>
				<span class="n">grph_obj_type</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usGraphicObjIds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span>
				     <span class="n">OBJECT_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OBJECT_TYPE_SHIFT</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">grph_obj_type</span> <span class="o">==</span> <span class="n">GRAPH_OBJECT_TYPE_ENCODER</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">enc_obj</span><span class="o">-&gt;</span><span class="n">ucNumberOfObjects</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">u16</span> <span class="n">encoder_obj</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">enc_obj</span><span class="o">-&gt;</span><span class="n">asObjects</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">usObjectID</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usGraphicObjIds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="n">encoder_obj</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ATOM_COMMON_RECORD_HEADER</span> <span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_COMMON_RECORD_HEADER</span> <span class="o">*</span><span class="p">)</span>
								<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
								 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">enc_obj</span><span class="o">-&gt;</span><span class="n">asObjects</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">usRecordOffset</span><span class="p">));</span>
							<span class="n">ATOM_ENCODER_CAP_RECORD</span> <span class="o">*</span><span class="n">cap_record</span><span class="p">;</span>
							<span class="n">u16</span> <span class="n">caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

							<span class="k">while</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
							       <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
							       <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span> <span class="o">&lt;=</span> <span class="n">ATOM_MAX_OBJECT_RECORD_NUMBER</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">switch</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">case</span> <span class="n">ATOM_ENCODER_CAP_RECORD_TYPE</span>:
									<span class="n">cap_record</span> <span class="o">=</span><span class="p">(</span><span class="n">ATOM_ENCODER_CAP_RECORD</span> <span class="o">*</span><span class="p">)</span>
										<span class="n">record</span><span class="p">;</span>
									<span class="n">caps</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_record</span><span class="o">-&gt;</span><span class="n">usEncoderCap</span><span class="p">);</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_COMMON_RECORD_HEADER</span> <span class="o">*</span><span class="p">)</span>
									<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">record</span> <span class="o">+</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordSize</span><span class="p">);</span>
							<span class="p">}</span>
							<span class="n">radeon_add_atom_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
										<span class="n">encoder_obj</span><span class="p">,</span>
										<span class="n">le16_to_cpu</span>
										<span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span>
										 <span class="n">usDeviceTag</span><span class="p">),</span>
										<span class="n">caps</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">grph_obj_type</span> <span class="o">==</span> <span class="n">GRAPH_OBJECT_TYPE_ROUTER</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">router_obj</span><span class="o">-&gt;</span><span class="n">ucNumberOfObjects</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">u16</span> <span class="n">router_obj_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">router_obj</span><span class="o">-&gt;</span><span class="n">asObjects</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">usObjectID</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usGraphicObjIds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="n">router_obj_id</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ATOM_COMMON_RECORD_HEADER</span> <span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_COMMON_RECORD_HEADER</span> <span class="o">*</span><span class="p">)</span>
								<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
								 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">router_obj</span><span class="o">-&gt;</span><span class="n">asObjects</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">usRecordOffset</span><span class="p">));</span>
							<span class="n">ATOM_I2C_RECORD</span> <span class="o">*</span><span class="n">i2c_record</span><span class="p">;</span>
							<span class="n">ATOM_I2C_ID_CONFIG_ACCESS</span> <span class="o">*</span><span class="n">i2c_config</span><span class="p">;</span>
							<span class="n">ATOM_ROUTER_DDC_PATH_SELECT_RECORD</span> <span class="o">*</span><span class="n">ddc_path</span><span class="p">;</span>
							<span class="n">ATOM_ROUTER_DATA_CLOCK_PATH_SELECT_RECORD</span> <span class="o">*</span><span class="n">cd_path</span><span class="p">;</span>
							<span class="n">ATOM_SRC_DST_TABLE_FOR_ONE_OBJECT</span> <span class="o">*</span><span class="n">router_src_dst_table</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">ATOM_SRC_DST_TABLE_FOR_ONE_OBJECT</span> <span class="o">*</span><span class="p">)</span>
								<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
								 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">router_obj</span><span class="o">-&gt;</span><span class="n">asObjects</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">usSrcDstTableOffset</span><span class="p">));</span>
							<span class="kt">int</span> <span class="n">enum_id</span><span class="p">;</span>

							<span class="n">router</span><span class="p">.</span><span class="n">router_id</span> <span class="o">=</span> <span class="n">router_obj_id</span><span class="p">;</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">enum_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">enum_id</span> <span class="o">&lt;</span> <span class="n">router_src_dst_table</span><span class="o">-&gt;</span><span class="n">ucNumberOfDst</span><span class="p">;</span>
							     <span class="n">enum_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usConnObjectId</span><span class="p">)</span> <span class="o">==</span>
								    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">router_src_dst_table</span><span class="o">-&gt;</span><span class="n">usDstObjectID</span><span class="p">[</span><span class="n">enum_id</span><span class="p">]))</span>
									<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="k">while</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
							       <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
							       <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span> <span class="o">&lt;=</span> <span class="n">ATOM_MAX_OBJECT_RECORD_NUMBER</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">switch</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">case</span> <span class="n">ATOM_I2C_RECORD_TYPE</span>:
									<span class="n">i2c_record</span> <span class="o">=</span>
										<span class="p">(</span><span class="n">ATOM_I2C_RECORD</span> <span class="o">*</span><span class="p">)</span>
										<span class="n">record</span><span class="p">;</span>
									<span class="n">i2c_config</span> <span class="o">=</span>
										<span class="p">(</span><span class="n">ATOM_I2C_ID_CONFIG_ACCESS</span> <span class="o">*</span><span class="p">)</span>
										<span class="o">&amp;</span><span class="n">i2c_record</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">i2c_info</span> <span class="o">=</span>
										<span class="n">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
												       <span class="n">i2c_config</span><span class="o">-&gt;</span>
												       <span class="n">ucAccess</span><span class="p">);</span>
									<span class="n">router</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">i2c_record</span><span class="o">-&gt;</span><span class="n">ucI2CAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="n">ATOM_ROUTER_DDC_PATH_SELECT_RECORD_TYPE</span>:
									<span class="n">ddc_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_ROUTER_DDC_PATH_SELECT_RECORD</span> <span class="o">*</span><span class="p">)</span>
										<span class="n">record</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">ddc_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">ddc_mux_type</span> <span class="o">=</span> <span class="n">ddc_path</span><span class="o">-&gt;</span><span class="n">ucMuxType</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">ddc_mux_control_pin</span> <span class="o">=</span> <span class="n">ddc_path</span><span class="o">-&gt;</span><span class="n">ucMuxControlPin</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">ddc_mux_state</span> <span class="o">=</span> <span class="n">ddc_path</span><span class="o">-&gt;</span><span class="n">ucMuxState</span><span class="p">[</span><span class="n">enum_id</span><span class="p">];</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="n">ATOM_ROUTER_DATA_CLOCK_PATH_SELECT_RECORD_TYPE</span>:
									<span class="n">cd_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_ROUTER_DATA_CLOCK_PATH_SELECT_RECORD</span> <span class="o">*</span><span class="p">)</span>
										<span class="n">record</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">cd_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">cd_mux_type</span> <span class="o">=</span> <span class="n">cd_path</span><span class="o">-&gt;</span><span class="n">ucMuxType</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">cd_mux_control_pin</span> <span class="o">=</span> <span class="n">cd_path</span><span class="o">-&gt;</span><span class="n">ucMuxControlPin</span><span class="p">;</span>
									<span class="n">router</span><span class="p">.</span><span class="n">cd_mux_state</span> <span class="o">=</span> <span class="n">cd_path</span><span class="o">-&gt;</span><span class="n">ucMuxState</span><span class="p">[</span><span class="n">enum_id</span><span class="p">];</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_COMMON_RECORD_HEADER</span> <span class="o">*</span><span class="p">)</span>
									<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">record</span> <span class="o">+</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordSize</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* look up gpio for ddc, hpd */</span>
			<span class="n">ddc_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usDeviceTag</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">con_obj</span><span class="o">-&gt;</span><span class="n">ucNumberOfObjects</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usConnObjectId</span><span class="p">)</span> <span class="o">==</span>
					    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">con_obj</span><span class="o">-&gt;</span><span class="n">asObjects</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
							<span class="n">usObjectID</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">ATOM_COMMON_RECORD_HEADER</span>
						    <span class="o">*</span><span class="n">record</span> <span class="o">=</span>
						    <span class="p">(</span><span class="n">ATOM_COMMON_RECORD_HEADER</span>
						     <span class="o">*</span><span class="p">)</span>
						    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
						     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">con_obj</span><span class="o">-&gt;</span>
								 <span class="n">asObjects</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
								 <span class="n">usRecordOffset</span><span class="p">));</span>
						<span class="n">ATOM_I2C_RECORD</span> <span class="o">*</span><span class="n">i2c_record</span><span class="p">;</span>
						<span class="n">ATOM_HPD_INT_RECORD</span> <span class="o">*</span><span class="n">hpd_record</span><span class="p">;</span>
						<span class="n">ATOM_I2C_ID_CONFIG_ACCESS</span> <span class="o">*</span><span class="n">i2c_config</span><span class="p">;</span>

						<span class="k">while</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
						       <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
						       <span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span> <span class="o">&lt;=</span> <span class="n">ATOM_MAX_OBJECT_RECORD_NUMBER</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ucRecordType</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="n">ATOM_I2C_RECORD_TYPE</span>:
								<span class="n">i2c_record</span> <span class="o">=</span>
								    <span class="p">(</span><span class="n">ATOM_I2C_RECORD</span> <span class="o">*</span><span class="p">)</span>
									<span class="n">record</span><span class="p">;</span>
								<span class="n">i2c_config</span> <span class="o">=</span>
									<span class="p">(</span><span class="n">ATOM_I2C_ID_CONFIG_ACCESS</span> <span class="o">*</span><span class="p">)</span>
									<span class="o">&amp;</span><span class="n">i2c_record</span><span class="o">-&gt;</span><span class="n">sucI2cId</span><span class="p">;</span>
								<span class="n">ddc_bus</span> <span class="o">=</span> <span class="n">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
												 <span class="n">i2c_config</span><span class="o">-&gt;</span>
												 <span class="n">ucAccess</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="k">case</span> <span class="n">ATOM_HPD_INT_RECORD_TYPE</span>:
								<span class="n">hpd_record</span> <span class="o">=</span>
									<span class="p">(</span><span class="n">ATOM_HPD_INT_RECORD</span> <span class="o">*</span><span class="p">)</span>
									<span class="n">record</span><span class="p">;</span>
								<span class="n">gpio</span> <span class="o">=</span> <span class="n">radeon_lookup_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
											  <span class="n">hpd_record</span><span class="o">-&gt;</span><span class="n">ucHPDIntGPIOID</span><span class="p">);</span>
								<span class="n">hpd</span> <span class="o">=</span> <span class="n">radeon_atom_get_hpd_info_from_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="p">);</span>
								<span class="n">hpd</span><span class="p">.</span><span class="n">plugged_state</span> <span class="o">=</span> <span class="n">hpd_record</span><span class="o">-&gt;</span><span class="n">ucPlugged_PinState</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">record</span> <span class="o">=</span>
							    <span class="p">(</span><span class="n">ATOM_COMMON_RECORD_HEADER</span>
							     <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">record</span>
								 <span class="o">+</span>
								 <span class="n">record</span><span class="o">-&gt;</span>
								 <span class="n">ucRecordSize</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* needed for aux chan transactions */</span>
			<span class="n">ddc_bus</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span><span class="p">;</span>

			<span class="n">conn_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usConnObjectId</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_atom_apply_quirks</span>
			    <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">usDeviceTag</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">connector_type</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ddc_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hpd</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">radeon_add_atom_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">conn_id</span><span class="p">,</span>
						  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span>
							      <span class="n">usDeviceTag</span><span class="p">),</span>
						  <span class="n">connector_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_bus</span><span class="p">,</span>
						  <span class="n">igp_lane_info</span><span class="p">,</span>
						  <span class="n">connector_object_id</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">hpd</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">router</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">radeon_link_encoder_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">atombios_get_connector_object_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">connector_type</span><span class="p">,</span>
						 <span class="kt">uint16_t</span> <span class="n">devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">supported_devices_connector_object_id_convert</span>
			<span class="p">[</span><span class="n">connector_type</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">))</span>  <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">atom_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">XTMDS_Info</span><span class="p">);</span>
		<span class="kt">uint16_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
		<span class="n">ATOM_XTMDS_INFO</span> <span class="o">*</span><span class="n">xtmds</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xtmds</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_XTMDS_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">xtmds</span><span class="o">-&gt;</span><span class="n">ucSupportedLink</span> <span class="o">&amp;</span> <span class="n">ATOM_XTMDS_SUPPORTED_DUALLINK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">supported_devices_connector_object_id_convert</span>
				<span class="p">[</span><span class="n">connector_type</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">supported_devices_connector_object_id_convert</span>
			<span class="p">[</span><span class="n">connector_type</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bios_connector</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">line_mux</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">devices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connector_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">ddc_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="n">hpd</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">radeon_get_atom_connector_info_from_supported_devices_table</span><span class="p">(</span><span class="k">struct</span>
								 <span class="n">drm_device</span>
								 <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atom_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">SupportedDevicesInfo</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">device_support</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">atom_supported_devices</span> <span class="o">*</span><span class="n">supported_devices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bios_connector</span> <span class="o">*</span><span class="n">bios_connectors</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bc_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bios_connectors</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATOM_MAX_SUPPORTED_DEVICE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_router</span> <span class="n">router</span><span class="p">;</span>

	<span class="n">router</span><span class="p">.</span><span class="n">ddc_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">router</span><span class="p">.</span><span class="n">cd_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bios_connectors</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">bc_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bios_connectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bios_connectors</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">supported_devices</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">union</span> <span class="n">atom_supported_devices</span> <span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="n">device_support</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">supported_devices</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usDeviceSupport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">max_device</span> <span class="o">=</span> <span class="n">ATOM_MAX_SUPPORTED_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_device</span> <span class="o">=</span> <span class="n">ATOM_MAX_SUPPORTED_DEVICE_INFO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_device</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATOM_CONNECTOR_INFO_I2C</span> <span class="n">ci</span> <span class="o">=</span>
		    <span class="n">supported_devices</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asConnInfo</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">device_support</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_CV_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Skipping Component Video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">connector_type</span> <span class="o">=</span>
		    <span class="n">supported_devices_connector_convert</span><span class="p">[</span><span class="n">ci</span><span class="p">.</span><span class="n">sucConnectorInfo</span><span class="p">.</span>
							<span class="n">sbfAccess</span><span class="p">.</span>
							<span class="n">bfConnectorType</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">connector_type</span> <span class="o">==</span>
		    <span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dac</span> <span class="o">=</span> <span class="n">ci</span><span class="p">.</span><span class="n">sucConnectorInfo</span><span class="p">.</span><span class="n">sbfAccess</span><span class="p">.</span><span class="n">bfAssociatedDAC</span><span class="p">;</span>

		<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">=</span>
			<span class="n">ci</span><span class="p">.</span><span class="n">sucI2cId</span><span class="p">.</span><span class="n">ucAccess</span><span class="p">;</span>

		<span class="cm">/* give tv unique connector ids */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_TV1_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_TV2_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">51</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_CV_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span> <span class="o">=</span>
			    <span class="n">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
						   <span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">crev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">isb</span> <span class="o">=</span> <span class="n">supported_devices</span><span class="o">-&gt;</span><span class="n">info_2d1</span><span class="p">.</span><span class="n">asIntSrcInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucIntSrcBitmap</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">isb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x4</span>:
				<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xa</span>:
				<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP1_INDEX</span><span class="p">)</span>
				<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_DFP2_INDEX</span><span class="p">)</span>
				<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Always set the connector type to VGA for CRT1/CRT2. if they are</span>
<span class="cm">		 * shared with a DVI port, we&#39;ll pick up the DVI connector when we</span>
<span class="cm">		 * merge the outputs.  Some bioses incorrectly list VGA ports as DVI.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_CRT1_INDEX</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ATOM_DEVICE_CRT2_INDEX</span><span class="p">)</span>
			<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">connector_type</span> <span class="o">=</span>
			    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_atom_apply_quirks</span>
		    <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">connector_type</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">radeon_r4xx_atom</span><span class="p">)</span>
			<span class="n">radeon_add_atom_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">),</span>
								      <span class="n">dac</span><span class="p">),</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">),</span>
									<span class="n">dac</span><span class="p">),</span>
						  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* combine shared connectors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_device</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_device</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">==</span>
					    <span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">line_mux</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* make sure not to combine LVDS */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">line_mux</span> <span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* combine analog and digital for DVI-I */</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
						     <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">)))</span> <span class="o">||</span>
						    <span class="p">((</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
						     <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))))</span> <span class="p">{</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span> <span class="o">|=</span>
								<span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devices</span><span class="p">;</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">connector_type</span> <span class="o">=</span>
								<span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span>
								<span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span> <span class="o">=</span>
									<span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hpd</span><span class="p">;</span>
							<span class="n">bios_connectors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* add the connectors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_device</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint16_t</span> <span class="n">connector_object_id</span> <span class="o">=</span>
				<span class="n">atombios_get_connector_object_id</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">connector_type</span><span class="p">,</span>
						      <span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span><span class="p">);</span>
			<span class="n">radeon_add_atom_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line_mux</span><span class="p">,</span>
						  <span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devices</span><span class="p">,</span>
						  <span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						  <span class="n">connector_type</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddc_bus</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span>
						  <span class="n">connector_object_id</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">bios_connectors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hpd</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">router</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">radeon_link_encoder_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bios_connectors</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">firmware_info</span> <span class="p">{</span>
	<span class="n">ATOM_FIRMWARE_INFO</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">ATOM_FIRMWARE_INFO_V1_2</span> <span class="n">info_12</span><span class="p">;</span>
	<span class="n">ATOM_FIRMWARE_INFO_V1_3</span> <span class="n">info_13</span><span class="p">;</span>
	<span class="n">ATOM_FIRMWARE_INFO_V1_4</span> <span class="n">info_14</span><span class="p">;</span>
	<span class="n">ATOM_FIRMWARE_INFO_V2_1</span> <span class="n">info_21</span><span class="p">;</span>
	<span class="n">ATOM_FIRMWARE_INFO_V2_2</span> <span class="n">info_22</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">radeon_atom_get_clock_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">FirmwareInfo</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">firmware_info</span> <span class="o">*</span><span class="n">firmware_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">p1pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">p1pll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">p2pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">p2pll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">dcpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">dcpll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">spll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">spll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">mpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">mpll</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">firmware_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">union</span> <span class="n">firmware_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span>
						<span class="n">data_offset</span><span class="p">);</span>
		<span class="cm">/* pixel clocks */</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usReferenceClock</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">reference_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMinPixelClockPLL_Output</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_12</span><span class="p">.</span><span class="n">ulMinPixelClockPLL_Output</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ulMaxPixelClockPLL_Output</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_min</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_14</span><span class="p">.</span><span class="n">usLcdMinPixelClockPLL_Output</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_min</span> <span class="o">=</span> <span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span><span class="p">;</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_max</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_14</span><span class="p">.</span><span class="n">usLcdMaxPixelClockPLL_Output</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_max</span> <span class="o">=</span> <span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_min</span> <span class="o">=</span> <span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span><span class="p">;</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_max</span> <span class="o">=</span> <span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="mi">64800</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMinPixelClockPLL_Input</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMaxPixelClockPLL_Input</span><span class="p">);</span>

		<span class="o">*</span><span class="n">p2pll</span> <span class="o">=</span> <span class="o">*</span><span class="n">p1pll</span><span class="p">;</span>

		<span class="cm">/* system clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">spll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_21</span><span class="p">.</span><span class="n">usCoreReferenceClock</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">spll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usReferenceClock</span><span class="p">);</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">reference_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMinEngineClockPLL_Output</span><span class="p">);</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ulMaxEngineClockPLL_Output</span><span class="p">);</span>

		<span class="cm">/* ??? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="mi">64800</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMinEngineClockPLL_Input</span><span class="p">);</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMaxEngineClockPLL_Input</span><span class="p">);</span>

		<span class="cm">/* memory clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_21</span><span class="p">.</span><span class="n">usMemoryReferenceClock</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usReferenceClock</span><span class="p">);</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">reference_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMinMemoryClockPLL_Output</span><span class="p">);</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ulMaxMemoryClockPLL_Output</span><span class="p">);</span>

		<span class="cm">/* ??? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="mi">64800</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMinMemoryClockPLL_Input</span><span class="p">);</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMaxMemoryClockPLL_Input</span><span class="p">);</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ulDefaultEngineClock</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ulDefaultMemoryClock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_dispclk</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_21</span><span class="p">.</span><span class="n">ulDefaultDispEngineClkFreq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_dispclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_dispclk</span> <span class="o">=</span> <span class="mi">54000</span><span class="p">;</span> <span class="cm">/* 540 Mhz */</span>
				<span class="k">else</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_dispclk</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span> <span class="cm">/* 600 Mhz */</span>
			<span class="p">}</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">dp_extclk</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_21</span><span class="p">.</span><span class="n">usUniphyDPModeExtClkFreq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dcpll</span> <span class="o">=</span> <span class="o">*</span><span class="n">p1pll</span><span class="p">;</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">max_pixel_clock</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usMaxPixelClock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">max_pixel_clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">max_pixel_clock</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">;</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">igp_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_INTEGRATED_SYSTEM_INFO</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_INTEGRATED_SYSTEM_INFO_V2</span> <span class="n">info_2</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">radeon_atombios_sideport_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">IntegratedSystemInfo</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">igp_info</span> <span class="o">*</span><span class="n">igp_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_offset</span><span class="p">;</span>

	<span class="cm">/* sideport is AMD only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">igp_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">igp_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span>
				      <span class="n">data_offset</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ulBootUpMemoryClock</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">ulBootUpSidePortClock</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unsupported IGP table: %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_atombios_get_tmds_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">radeon_encoder_int_tmds</span> <span class="o">*</span><span class="n">tmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">TMDS_Info</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_TMDS_INFO</span> <span class="o">*</span><span class="n">tmds_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">maxfreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmds_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_TMDS_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span>
						   <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">maxfreq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmds_info</span><span class="o">-&gt;</span><span class="n">usMaxFrequency</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmds_info</span><span class="o">-&gt;</span><span class="n">asMiscInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usFrequency</span><span class="p">);</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
			    <span class="n">tmds_info</span><span class="o">-&gt;</span><span class="n">asMiscInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucPLL_ChargePump</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">tmds_info</span><span class="o">-&gt;</span><span class="n">asMiscInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
			     <span class="n">ucPLL_VCO_Gain</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">tmds_info</span><span class="o">-&gt;</span><span class="n">asMiscInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
			     <span class="n">ucPLL_DutyCycle</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">tmds_info</span><span class="o">-&gt;</span><span class="n">asMiscInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
			     <span class="n">ucPLL_VoltageSwing</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TMDS PLL From ATOMBIOS %u %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">,</span>
				  <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">maxfreq</span> <span class="o">==</span> <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_atombios_get_ppll_ss_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">radeon_atom_ss</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">PPLL_SS_Info</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_SPREAD_SPECTRUM_INFO</span> <span class="o">*</span><span class="n">ss_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_indices</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_atom_ss</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ss_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_SPREAD_SPECTRUM_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_SPREAD_SPECTRUM_ASSIGNMENT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSS_Id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ss</span><span class="o">-&gt;</span><span class="n">percentage</span> <span class="o">=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadSpectrumPercentage</span><span class="p">);</span>
				<span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSpreadSpectrumType</span><span class="p">;</span>
				<span class="n">ss</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSS_Step</span><span class="p">;</span>
				<span class="n">ss</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSS_Delay</span><span class="p">;</span>
				<span class="n">ss</span><span class="o">-&gt;</span><span class="n">range</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSS_Range</span><span class="p">;</span>
				<span class="n">ss</span><span class="o">-&gt;</span><span class="n">refdiv</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">asSS_Info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucRecommendedRef_Div</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atombios_get_igp_ss_overrides</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">radeon_atom_ss</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">IntegratedSystemInfo</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_INTEGRATED_SYSTEM_INFO_V6</span> <span class="o">*</span><span class="n">igp_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get any igp specific overrides */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">igp_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_INTEGRATED_SYSTEM_INFO_V6</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ASIC_INTERNAL_SS_ON_TMDS</span>:
			<span class="n">percentage</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">usDVISSPercentage</span><span class="p">);</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">usDVISSpreadRateIn10Hz</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ASIC_INTERNAL_SS_ON_HDMI</span>:
			<span class="n">percentage</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">usHDMISSPercentage</span><span class="p">);</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">usHDMISSpreadRateIn10Hz</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ASIC_INTERNAL_SS_ON_LVDS</span>:
			<span class="n">percentage</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">usLvdsSSPercentage</span><span class="p">);</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">igp_info</span><span class="o">-&gt;</span><span class="n">usLvdsSSpreadRateIn10Hz</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">percentage</span><span class="p">)</span>
			<span class="n">ss</span><span class="o">-&gt;</span><span class="n">percentage</span> <span class="o">=</span> <span class="n">percentage</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span>
			<span class="n">ss</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">asic_ss_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_ASIC_INTERNAL_SS_INFO</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_ASIC_INTERNAL_SS_INFO_V2</span> <span class="n">info_2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_ASIC_INTERNAL_SS_INFO_V3</span> <span class="n">info_3</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">radeon_atombios_get_asic_ss_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">radeon_atom_ss</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">ASIC_InternalSS_Info</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">asic_ss_info</span> <span class="o">*</span><span class="n">ss_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_indices</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_atom_ss</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ss_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">union</span> <span class="n">asic_ss_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_ASIC_SS_ASSIGNMENT</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucClockIndication</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulTargetClockRange</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">percentage</span> <span class="o">=</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadSpectrumPercentage</span><span class="p">);</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSpreadSpectrumMode</span><span class="p">;</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadRateInKhz</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_ASIC_SS_ASSIGNMENT_V2</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucClockIndication</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulTargetClockRange</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">percentage</span> <span class="o">=</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadSpectrumPercentage</span><span class="p">);</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSpreadSpectrumMode</span><span class="p">;</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadRateIn10Hz</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">num_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_COMMON_TABLE_HEADER</span><span class="p">))</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_ASIC_SS_ASSIGNMENT_V3</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_indices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucClockIndication</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulTargetClockRange</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">percentage</span> <span class="o">=</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadSpectrumPercentage</span><span class="p">);</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucSpreadSpectrumMode</span><span class="p">;</span>
					<span class="n">ss</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asSpreadSpectrum</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usSpreadRateIn10Hz</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span>
						<span class="n">radeon_atombios_get_igp_ss_overrides</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unsupported ASIC_InternalSS_Info table: %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">lvds_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_LVDS_INFO</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_LVDS_INFO_V12</span> <span class="n">info_12</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="nf">radeon_atombios_get_lvds_info</span><span class="p">(</span><span class="k">struct</span>
							      <span class="n">radeon_encoder</span>
							      <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">LVDS_Info</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">misc</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">lvds_info</span> <span class="o">*</span><span class="n">lvds_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">lvds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encoder_enum</span> <span class="o">=</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_enum</span> <span class="o">&amp;</span> <span class="n">ENUM_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ENUM_ID_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lvds_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">union</span> <span class="n">lvds_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="n">lvds</span> <span class="o">=</span>
		    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lvds</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usPixClk</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usHActive</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usVActive</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usHBlanking_Time</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usHSyncOffset</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hsync_start</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usHSyncWidth</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usVBlanking_Time</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usVSyncOffset</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vsync_start</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usVSyncWidth</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_pwr_delay</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usOffDelayInMs</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">=</span> <span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucLVDS_Misc</span><span class="p">;</span>

		<span class="n">misc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">susModeMiscInfo</span><span class="p">.</span><span class="n">usAccess</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_VSYNC_POLARITY</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_HSYNC_POLARITY</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_COMPOSITESYNC</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_CSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_INTERLACE</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_DOUBLE_CLOCK_MODE</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">;</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">width_mm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usImageHSize</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">height_mm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">sLCDTiming</span><span class="p">.</span><span class="n">usImageVSize</span><span class="p">);</span>

		<span class="cm">/* set crtc values */</span>
		<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">,</span> <span class="n">CRTC_INTERLACE_HALVE_V</span><span class="p">);</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lcd_ss_id</span> <span class="o">=</span> <span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucSS_Id</span><span class="p">;</span>

		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">native_mode</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder_enum</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">linkb</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">linkb</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* parse the lcd record table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usModePatchTableOffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATOM_FAKE_EDID_PATCH_RECORD</span> <span class="o">*</span><span class="n">fake_edid_record</span><span class="p">;</span>
			<span class="n">ATOM_PANEL_RESOLUTION_PATCH_RECORD</span> <span class="o">*</span><span class="n">panel_res_record</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">bad_record</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">record</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">frev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
				<span class="cm">/* absolute */</span>
				<span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usModePatchTableOffset</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="cm">/* relative */</span>
				<span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span>
						<span class="n">data_offset</span> <span class="o">+</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lvds_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">usModePatchTableOffset</span><span class="p">));</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">record</span> <span class="o">!=</span> <span class="n">ATOM_RECORD_END_TYPE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">LCD_MODE_PATCH_RECORD_MODE_TYPE</span>:
					<span class="n">record</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_PATCH_RECORD_MODE</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LCD_RTS_RECORD_TYPE</span>:
					<span class="n">record</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_LCD_RTS_RECORD</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LCD_CAP_RECORD_TYPE</span>:
					<span class="n">record</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_LCD_MODE_CONTROL_CAP</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LCD_FAKE_EDID_PATCH_RECORD_TYPE</span>:
					<span class="n">fake_edid_record</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_FAKE_EDID_PATCH_RECORD</span> <span class="o">*</span><span class="p">)</span><span class="n">record</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">fake_edid_record</span><span class="o">-&gt;</span><span class="n">ucFakeEDIDLength</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
						<span class="kt">int</span> <span class="n">edid_size</span> <span class="o">=</span>
							<span class="n">max</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">EDID_LENGTH</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fake_edid_record</span><span class="o">-&gt;</span><span class="n">ucFakeEDIDLength</span><span class="p">);</span>
						<span class="n">edid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">edid_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">edid</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fake_edid_record</span><span class="o">-&gt;</span><span class="n">ucFakeEDIDString</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							       <span class="n">fake_edid_record</span><span class="o">-&gt;</span><span class="n">ucFakeEDIDLength</span><span class="p">);</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">drm_edid_is_valid</span><span class="p">(</span><span class="n">edid</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid</span> <span class="o">=</span> <span class="n">edid</span><span class="p">;</span>
								<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid_size</span> <span class="o">=</span> <span class="n">edid_size</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span>
								<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">record</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_FAKE_EDID_PATCH_RECORD</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LCD_PANEL_RESOLUTION_RECORD_TYPE</span>:
					<span class="n">panel_res_record</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_PANEL_RESOLUTION_PATCH_RECORD</span> <span class="o">*</span><span class="p">)</span><span class="n">record</span><span class="p">;</span>
					<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">width_mm</span> <span class="o">=</span> <span class="n">panel_res_record</span><span class="o">-&gt;</span><span class="n">usHSize</span><span class="p">;</span>
					<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">height_mm</span> <span class="o">=</span> <span class="n">panel_res_record</span><span class="o">-&gt;</span><span class="n">usVSize</span><span class="p">;</span>
					<span class="n">record</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ATOM_PANEL_RESOLUTION_PATCH_RECORD</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Bad LCD record %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">record</span><span class="p">);</span>
					<span class="n">bad_record</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bad_record</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lvds</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span> <span class="o">*</span>
<span class="nf">radeon_atombios_get_primary_dac_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">CompassionateData</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_COMPASSIONATE_DATA</span> <span class="o">*</span><span class="n">dac_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bg</span><span class="p">,</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span> <span class="o">*</span><span class="n">p_dac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dac_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_COMPASSIONATE_DATA</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">p_dac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dac</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">bg</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC1_BG_Adjustment</span><span class="p">;</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC1_DAC_Adjustment</span><span class="p">;</span>
		<span class="n">p_dac</span><span class="o">-&gt;</span><span class="n">ps2_pdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p_dac</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_atom_get_tv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="n">ATOM_ANALOG_TV_INFO</span> <span class="o">*</span><span class="n">tv_info</span><span class="p">;</span>
	<span class="n">ATOM_ANALOG_TV_INFO_V1_2</span> <span class="o">*</span><span class="n">tv_info_v1_2</span><span class="p">;</span>
	<span class="n">ATOM_DTD_FORMAT</span> <span class="o">*</span><span class="n">dtd_timings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">AnalogTV_Info</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">misc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">data_index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tv_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_ANALOG_TV_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_SUPPORTED_TV_TIMING</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_H_Total</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_H_Disp</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_H_SyncStart</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_H_SyncStart</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_H_SyncWidth</span><span class="p">);</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_V_Total</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_V_Disp</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_V_SyncStart</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_V_SyncStart</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usCRTC_V_SyncWidth</span><span class="p">);</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">misc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">susModeMiscInfo</span><span class="p">.</span><span class="n">usAccess</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_VSYNC_POLARITY</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_HSYNC_POLARITY</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_COMPOSITESYNC</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_CSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_INTERLACE</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_DOUBLE_CLOCK_MODE</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">;</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">usPixelClock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PAL timings appear to have wrong values for totals */</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tv_info_v1_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATOM_ANALOG_TV_INFO_V1_2</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_SUPPORTED_TV_TIMING_V1_2</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">dtd_timings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tv_info_v1_2</span><span class="o">-&gt;</span><span class="n">aModeTimings</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usHActive</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usHBlanking_Time</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usHActive</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usHActive</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usHSyncOffset</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usHSyncWidth</span><span class="p">);</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usVActive</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usVBlanking_Time</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usVActive</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usVActive</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usVSyncOffset</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usVSyncWidth</span><span class="p">);</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">misc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">susModeMiscInfo</span><span class="p">.</span><span class="n">usAccess</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_VSYNC_POLARITY</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_HSYNC_POLARITY</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_COMPOSITESYNC</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_CSYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_INTERLACE</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_DOUBLE_CLOCK_MODE</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">;</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dtd_timings</span><span class="o">-&gt;</span><span class="n">usPixClk</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">radeon_tv_std</span>
<span class="nf">radeon_atombios_get_tv_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">AnalogTV_Info</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_ANALOG_TV_INFO</span> <span class="o">*</span><span class="n">tv_info</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_tv_std</span> <span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">tv_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_ANALOG_TV_INFO</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tv_info</span><span class="o">-&gt;</span><span class="n">ucTV_BootUpDefaultStandard</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATOM_TV_NTSC</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_NTSCJ</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC_J</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: NTSC-J</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_PAL</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_PALM</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL_M</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL-M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_PALN</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL_N</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL-N</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_PALCN</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL_CN</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL-CN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_PAL60</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL_60</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL-60</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATOM_TV_SECAM</span>:
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_SECAM</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: SECAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown TV standard; defaulting to NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tv_std</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span> <span class="o">*</span>
<span class="nf">radeon_atombios_get_tv_dac_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">CompassionateData</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_COMPASSIONATE_DATA</span> <span class="o">*</span><span class="n">dac_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bg</span><span class="p">,</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span> <span class="o">*</span><span class="n">tv_dac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">dac_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_COMPASSIONATE_DATA</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

		<span class="n">tv_dac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_dac</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">bg</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC2_CRT2_BG_Adjustment</span><span class="p">;</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC2_CRT2_DAC_Adjustment</span><span class="p">;</span>
		<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

		<span class="n">bg</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC2_PAL_BG_Adjustment</span><span class="p">;</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC2_PAL_DAC_Adjustment</span><span class="p">;</span>
		<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">pal_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

		<span class="n">bg</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC2_NTSC_BG_Adjustment</span><span class="p">;</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">ucDAC2_NTSC_DAC_Adjustment</span><span class="p">;</span>
		<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ntsc_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

		<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">tv_std</span> <span class="o">=</span> <span class="n">radeon_atombios_get_tv_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tv_dac</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">thermal_controller_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;lm63&quot;</span><span class="p">,</span>
	<span class="s">&quot;adm1032&quot;</span><span class="p">,</span>
	<span class="s">&quot;adm1030&quot;</span><span class="p">,</span>
	<span class="s">&quot;max6649&quot;</span><span class="p">,</span>
	<span class="s">&quot;lm64&quot;</span><span class="p">,</span>
	<span class="s">&quot;f75375&quot;</span><span class="p">,</span>
	<span class="s">&quot;asc7xxx&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pp_lib_thermal_controller_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;lm63&quot;</span><span class="p">,</span>
	<span class="s">&quot;adm1032&quot;</span><span class="p">,</span>
	<span class="s">&quot;adm1030&quot;</span><span class="p">,</span>
	<span class="s">&quot;max6649&quot;</span><span class="p">,</span>
	<span class="s">&quot;lm64&quot;</span><span class="p">,</span>
	<span class="s">&quot;f75375&quot;</span><span class="p">,</span>
	<span class="s">&quot;RV6xx&quot;</span><span class="p">,</span>
	<span class="s">&quot;RV770&quot;</span><span class="p">,</span>
	<span class="s">&quot;adt7473&quot;</span><span class="p">,</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;External GPIO&quot;</span><span class="p">,</span>
	<span class="s">&quot;Evergreen&quot;</span><span class="p">,</span>
	<span class="s">&quot;emc2103&quot;</span><span class="p">,</span>
	<span class="s">&quot;Sumo&quot;</span><span class="p">,</span>
	<span class="s">&quot;Northern Islands&quot;</span><span class="p">,</span>
	<span class="s">&quot;Southern Islands&quot;</span><span class="p">,</span>
	<span class="s">&quot;lm96163&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">power_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_POWERPLAY_INFO</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_POWERPLAY_INFO_V2</span> <span class="n">info_2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_POWERPLAY_INFO_V3</span> <span class="n">info_3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_POWERPLAYTABLE</span> <span class="n">pplib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_POWERPLAYTABLE2</span> <span class="n">pplib2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_POWERPLAYTABLE3</span> <span class="n">pplib3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">pplib_clock_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_R600_CLOCK_INFO</span> <span class="n">r600</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_RS780_CLOCK_INFO</span> <span class="n">rs780</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_EVERGREEN_CLOCK_INFO</span> <span class="n">evergreen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_SUMO_CLOCK_INFO</span> <span class="n">sumo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_SI_CLOCK_INFO</span> <span class="n">si</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">pplib_power_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_STATE</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_STATE_V2</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atombios_parse_misc_flags_1_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">state_index</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="n">misc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">misc2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc2</span> <span class="o">=</span> <span class="n">misc2</span><span class="p">;</span>
	<span class="cm">/* order matters! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_POWER_SAVING_MODE</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_POWERSAVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_DEFAULT_DC_STATE_ENTRY_TRUE</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_BATTERY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_DEFAULT_LOW_DC_STATE_ENTRY_TRUE</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_BATTERY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_LOAD_BALANCE_EN</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_BALANCED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_3D_ACCELERATION_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_PERFORMANCE</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO2_SYSTEM_AC_LITE_MODE</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_BALANCED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_DRIVER_DEFAULT_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="n">state_index</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			<span class="n">RADEON_PM_MODE_NO_DISPLAY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_atombios_parse_power_table_1_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc</span><span class="p">,</span> <span class="n">misc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_modes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c_bus</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_info</span> <span class="o">*</span><span class="n">power_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">PowerPlayInfo</span><span class="p">);</span>
        <span class="n">u16</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="n">power_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">power_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="cm">/* add the i2c bus for thermal/fan chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucOverdriveThermalController</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Possible %s thermal controller at 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">thermal_controller_names</span><span class="p">[</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucOverdriveThermalController</span><span class="p">],</span>
			 <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucOverdriveControllerAddress</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucOverdriveI2cLine</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">thermal_controller_names</span><span class="p">[</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span>
								    <span class="n">ucOverdriveThermalController</span><span class="p">];</span>
			<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucOverdriveControllerAddress</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
			<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">num_modes</span> <span class="o">=</span> <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ucNumOfPowerModeEntries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_modes</span> <span class="o">&gt;</span> <span class="n">ATOM_MAX_NUMBEROF_POWER_BLOCK</span><span class="p">)</span>
		<span class="n">num_modes</span> <span class="o">=</span> <span class="n">ATOM_MAX_NUMBEROF_POWER_BLOCK</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_power_state</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_modes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="cm">/* last mode is usually default, array is low to high */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_pm_clock_info</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VOLTAGE_NONE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usMemoryClock</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usEngineClock</span><span class="p">);</span>
			<span class="cm">/* skip invalid modes */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span>
				<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucNumPciELanes</span><span class="p">;</span>
			<span class="n">misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMiscInfo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">VOLTAGE_GPIO</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span>
					<span class="n">radeon_lookup_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
							   <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVoltageDropIndex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH</span><span class="p">)</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_PROGRAM_VOLTAGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">VOLTAGE_VDDC</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddc_id</span> <span class="o">=</span>
					<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVoltageDropIndex</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
			<span class="n">radeon_atombios_parse_misc_flags_1_3</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">state_index</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMemoryClock</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulEngineClock</span><span class="p">);</span>
			<span class="cm">/* skip invalid modes */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span>
				<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucNumPciELanes</span><span class="p">;</span>
			<span class="n">misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMiscInfo</span><span class="p">);</span>
			<span class="n">misc2</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMiscInfo2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">VOLTAGE_GPIO</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span>
					<span class="n">radeon_lookup_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
							   <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVoltageDropIndex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH</span><span class="p">)</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_PROGRAM_VOLTAGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">VOLTAGE_VDDC</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddc_id</span> <span class="o">=</span>
					<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_2</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVoltageDropIndex</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
			<span class="n">radeon_atombios_parse_misc_flags_1_3</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">state_index</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">misc2</span><span class="p">);</span>
			<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMemoryClock</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulEngineClock</span><span class="p">);</span>
			<span class="cm">/* skip invalid modes */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span>
				<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucNumPciELanes</span><span class="p">;</span>
			<span class="n">misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMiscInfo</span><span class="p">);</span>
			<span class="n">misc2</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ulMiscInfo2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">VOLTAGE_GPIO</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span>
					<span class="n">radeon_lookup_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
							   <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVoltageDropIndex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH</span><span class="p">)</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO_PROGRAM_VOLTAGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">VOLTAGE_VDDC</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddc_id</span> <span class="o">=</span>
					<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVoltageDropIndex</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">ATOM_PM_MISCINFO2_VDDCI_DYNAMIC_VOLTAGE_EN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddci_enabled</span> <span class="o">=</span>
						<span class="nb">true</span><span class="p">;</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddci_id</span> <span class="o">=</span>
						<span class="n">power_info</span><span class="o">-&gt;</span><span class="n">info_3</span><span class="p">.</span><span class="n">asPowerPlayInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ucVDDCI_VoltageDropIndex</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
			<span class="n">radeon_atombios_parse_misc_flags_1_3</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">state_index</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">misc2</span><span class="p">);</span>
			<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* last mode is usually default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="n">state_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atombios_add_pplib_thermal_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
							 <span class="n">ATOM_PPLIB_THERMALCONTROLLER</span> <span class="o">*</span><span class="n">controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c_bus</span><span class="p">;</span>

	<span class="cm">/* add the i2c bus for thermal/fan chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span> <span class="n">ATOM_PP_THERMALCONTROLLER_RV6xx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Internal thermal controller %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_RV6XX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span> <span class="n">ATOM_PP_THERMALCONTROLLER_RV770</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Internal thermal controller %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_RV770</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span> <span class="n">ATOM_PP_THERMALCONTROLLER_EVERGREEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Internal thermal controller %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_EVERGREEN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span> <span class="n">ATOM_PP_THERMALCONTROLLER_SUMO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Internal thermal controller %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_SUMO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span> <span class="n">ATOM_PP_THERMALCONTROLLER_NISLANDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Internal thermal controller %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_NI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span> <span class="n">ATOM_PP_THERMALCONTROLLER_SISLANDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Internal thermal controller %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_SI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span>
			    <span class="n">ATOM_PP_THERMALCONTROLLER_EXTERNAL_GPIO</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span>
			    <span class="n">ATOM_PP_THERMALCONTROLLER_ADT7473_WITH_INTERNAL</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span> <span class="o">==</span>
			    <span class="n">ATOM_PP_THERMALCONTROLLER_EMC2103_WITH_INTERNAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Special thermal controller config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Possible %s thermal controller at 0x%02x %s fan control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">pp_lib_thermal_controller_names</span><span class="p">[</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span><span class="p">],</span>
				 <span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucI2cAddress</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucFanParameters</span> <span class="o">&amp;</span>
				  <span class="n">ATOM_PP_FANPARAMETERS_NOFAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;without&quot;</span> <span class="o">:</span> <span class="s">&quot;with&quot;</span><span class="p">);</span>
			<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_lookup_i2c_gpio</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucI2cLine</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">pp_lib_thermal_controller_names</span><span class="p">[</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucType</span><span class="p">];</span>
				<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">ucI2cAddress</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
				<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atombios_get_default_voltages</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						 <span class="n">u16</span> <span class="o">*</span><span class="n">vddc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">vddci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">FirmwareInfo</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">firmware_info</span> <span class="o">*</span><span class="n">firmware_info</span><span class="p">;</span>

	<span class="o">*</span><span class="n">vddc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vddci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">firmware_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">union</span> <span class="n">firmware_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span>
						<span class="n">data_offset</span><span class="p">);</span>
		<span class="o">*</span><span class="n">vddc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_14</span><span class="p">.</span><span class="n">usBootUpVDDCVoltage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">frev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
			<span class="o">*</span><span class="n">vddci</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">firmware_info</span><span class="o">-&gt;</span><span class="n">info_22</span><span class="p">.</span><span class="n">usBootUpVDDCIVoltage</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atombios_parse_pplib_non_clock_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						       <span class="kt">int</span> <span class="n">state_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_index</span><span class="p">,</span>
						       <span class="k">struct</span> <span class="n">_ATOM_PPLIB_NONCLOCK_INFO</span> <span class="o">*</span><span class="n">non_clock_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">non_clock_info</span><span class="o">-&gt;</span><span class="n">ulCapsAndSettings</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">misc2</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">non_clock_info</span><span class="o">-&gt;</span><span class="n">usClassification</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">vddc</span><span class="p">,</span> <span class="n">vddci</span><span class="p">;</span>

	<span class="n">radeon_atombios_get_default_voltages</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vddc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vddci</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc2</span> <span class="o">=</span> <span class="n">misc2</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PPLIB_PCIE_LINK_WIDTH_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		 <span class="n">ATOM_PPLIB_PCIE_LINK_WIDTH_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_UI_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_UI_BATTERY</span>:
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_BATTERY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_UI_BALANCED</span>:
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_BALANCED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_UI_PERFORMANCE</span>:
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_PERFORMANCE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_UI_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_3DPERFORMANCE</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">POWER_STATE_TYPE_PERFORMANCE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PPLIB_SINGLE_DISPLAY_ONLY</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			<span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">ATOM_PPLIB_CLASSIFICATION_BOOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="n">state_index</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* NI chips post without MC ucode, so default clocks are strobe mode only */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddc</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddci</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddci</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* patch the table values with the default slck/mclk from firmware info */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">mode_index</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vddc</span><span class="p">)</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span> <span class="o">=</span>
						<span class="n">vddc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_atombios_parse_pplib_clock_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="n">state_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_index</span><span class="p">,</span>
						   <span class="k">union</span> <span class="n">pplib_clock_info</span> <span class="o">*</span><span class="n">clock_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sclk</span><span class="p">,</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vddc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_PALM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">sumo</span><span class="p">.</span><span class="n">usEngineClockLow</span><span class="p">);</span>
			<span class="n">sclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">sumo</span><span class="p">.</span><span class="n">ucEngineClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">rs780</span><span class="p">.</span><span class="n">usLowEngineClockLow</span><span class="p">);</span>
			<span class="n">sclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">rs780</span><span class="p">.</span><span class="n">ucLowEngineClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE6</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">usEngineClockLow</span><span class="p">);</span>
		<span class="n">sclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">ucEngineClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">mclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">usMemoryClockLow</span><span class="p">);</span>
		<span class="n">mclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">ucMemoryClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">VOLTAGE_SW</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">usVDDC</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddci</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">.</span><span class="n">usVDDCI</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">evergreen</span><span class="p">.</span><span class="n">usEngineClockLow</span><span class="p">);</span>
		<span class="n">sclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">evergreen</span><span class="p">.</span><span class="n">ucEngineClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">mclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">evergreen</span><span class="p">.</span><span class="n">usMemoryClockLow</span><span class="p">);</span>
		<span class="n">mclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">evergreen</span><span class="p">.</span><span class="n">ucMemoryClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">VOLTAGE_SW</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">evergreen</span><span class="p">.</span><span class="n">usVDDC</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddci</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">evergreen</span><span class="p">.</span><span class="n">usVDDCI</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">r600</span><span class="p">.</span><span class="n">usEngineClockLow</span><span class="p">);</span>
		<span class="n">sclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">r600</span><span class="p">.</span><span class="n">ucEngineClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">mclk</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">r600</span><span class="p">.</span><span class="n">usMemoryClockLow</span><span class="p">);</span>
		<span class="n">mclk</span> <span class="o">|=</span> <span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">r600</span><span class="p">.</span><span class="n">ucMemoryClockHigh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">VOLTAGE_SW</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">r600</span><span class="p">.</span><span class="n">usVDDC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* patch up vddc if necessary */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATOM_VIRTUAL_VOLTAGE_ID0</span>:
	<span class="k">case</span> <span class="n">ATOM_VIRTUAL_VOLTAGE_ID1</span>:
	<span class="k">case</span> <span class="n">ATOM_VIRTUAL_VOLTAGE_ID2</span>:
	<span class="k">case</span> <span class="n">ATOM_VIRTUAL_VOLTAGE_ID3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_atom_get_max_vddc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">VOLTAGE_TYPE_VDDC</span><span class="p">,</span>
					     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">vddc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">vddc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip invalid modes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* skip invalid modes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="n">mode_index</span><span class="p">].</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_atombios_parse_power_table_4_5</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_NONCLOCK_INFO</span> <span class="o">*</span><span class="n">non_clock_info</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pplib_power_state</span> <span class="o">*</span><span class="n">power_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pplib_clock_info</span> <span class="o">*</span><span class="n">clock_info</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_info</span> <span class="o">*</span><span class="n">power_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">PowerPlayInfo</span><span class="p">);</span>
        <span class="n">u16</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="n">power_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">power_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="n">radeon_atombios_add_pplib_thermal_controller</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">sThermalController</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_power_state</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucNumStates</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="cm">/* first mode is usually default, followed by low to high */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucNumStates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">power_state</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">pplib_power_state</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">usStateArrayOffset</span><span class="p">)</span> <span class="o">+</span>
			 <span class="n">i</span> <span class="o">*</span> <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucStateEntrySize</span><span class="p">);</span>
		<span class="n">non_clock_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_PPLIB_NONCLOCK_INFO</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">usNonClockInfoArrayOffset</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">ucNonClockStateIndex</span> <span class="o">*</span>
			  <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucNonClockSize</span><span class="p">));</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_pm_clock_info</span><span class="p">)</span> <span class="o">*</span>
							     <span class="p">((</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucStateEntrySize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
							      <span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucStateEntrySize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span>
							     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock_info</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucStateEntrySize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucStateEntrySize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">clock_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">pplib_clock_info</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
					 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">usClockInfoArrayOffset</span><span class="p">)</span> <span class="o">+</span>
					 <span class="p">(</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">ucClockStateIndices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span>
					  <span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">ucClockInfoSize</span><span class="p">));</span>
				<span class="n">valid</span> <span class="o">=</span> <span class="n">radeon_atombios_parse_pplib_clock_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
									       <span class="n">state_index</span><span class="p">,</span> <span class="n">mode_index</span><span class="p">,</span>
									       <span class="n">clock_info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span>
					<span class="n">mode_index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
			<span class="n">mode_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">=</span> <span class="n">mode_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_atombios_parse_pplib_non_clock_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">state_index</span><span class="p">,</span> <span class="n">mode_index</span><span class="p">,</span>
								   <span class="n">non_clock_info</span><span class="p">);</span>
			<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if multiple clock modes, mark the lowest as no display */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">RADEON_PM_MODE_NO_DISPLAY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* first mode is usually default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_atombios_parse_power_table_6</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ATOM_PPLIB_NONCLOCK_INFO</span> <span class="o">*</span><span class="n">non_clock_info</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pplib_power_state</span> <span class="o">*</span><span class="n">power_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">non_clock_array_index</span><span class="p">,</span> <span class="n">clock_array_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pplib_clock_info</span> <span class="o">*</span><span class="n">clock_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_StateArray</span> <span class="o">*</span><span class="n">state_array</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_ClockInfoArray</span> <span class="o">*</span><span class="n">clock_info_array</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_NonClockInfoArray</span> <span class="o">*</span><span class="n">non_clock_info_array</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_info</span> <span class="o">*</span><span class="n">power_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">PowerPlayInfo</span><span class="p">);</span>
        <span class="n">u16</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="n">power_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">power_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="n">radeon_atombios_add_pplib_thermal_controller</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">sThermalController</span><span class="p">);</span>
	<span class="n">state_array</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_StateArray</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">usStateArrayOffset</span><span class="p">));</span>
	<span class="n">clock_info_array</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ClockInfoArray</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">usClockInfoArrayOffset</span><span class="p">));</span>
	<span class="n">non_clock_info_array</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_NonClockInfoArray</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">data_offset</span> <span class="o">+</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">power_info</span><span class="o">-&gt;</span><span class="n">pplib</span><span class="p">.</span><span class="n">usNonClockInfoArrayOffset</span><span class="p">));</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_power_state</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">state_array</span><span class="o">-&gt;</span><span class="n">ucNumEntries</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state_array</span><span class="o">-&gt;</span><span class="n">ucNumEntries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">power_state</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">pplib_power_state</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">state_array</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* XXX this might be an inagua bug... */</span>
		<span class="n">non_clock_array_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* power_state-&gt;v2.nonClockInfoIndex */</span>
		<span class="n">non_clock_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_ATOM_PPLIB_NONCLOCK_INFO</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">non_clock_info_array</span><span class="o">-&gt;</span><span class="n">nonClockInfo</span><span class="p">[</span><span class="n">non_clock_array_index</span><span class="p">];</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_pm_clock_info</span><span class="p">)</span> <span class="o">*</span>
							     <span class="p">(</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">ucNumDPMLevels</span> <span class="o">?</span>
							      <span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">ucNumDPMLevels</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span>
							     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock_info</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">ucNumDPMLevels</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">ucNumDPMLevels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">clock_array_index</span> <span class="o">=</span> <span class="n">power_state</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">clockInfoIndex</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="cm">/* XXX this might be an inagua bug... */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">clock_array_index</span> <span class="o">&gt;=</span> <span class="n">clock_info_array</span><span class="o">-&gt;</span><span class="n">ucNumEntries</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">clock_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">pplib_clock_info</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">clock_info_array</span><span class="o">-&gt;</span><span class="n">clockInfo</span><span class="p">[</span><span class="n">clock_array_index</span> <span class="o">*</span> <span class="n">clock_info_array</span><span class="o">-&gt;</span><span class="n">ucEntrySize</span><span class="p">];</span>
				<span class="n">valid</span> <span class="o">=</span> <span class="n">radeon_atombios_parse_pplib_clock_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
									       <span class="n">state_index</span><span class="p">,</span> <span class="n">mode_index</span><span class="p">,</span>
									       <span class="n">clock_info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span>
					<span class="n">mode_index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
			<span class="n">mode_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">=</span> <span class="n">mode_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_atombios_parse_pplib_non_clock_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">state_index</span><span class="p">,</span> <span class="n">mode_index</span><span class="p">,</span>
								   <span class="n">non_clock_info</span><span class="p">);</span>
			<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if multiple clock modes, mark the lowest as no display */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">RADEON_PM_MODE_NO_DISPLAY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* first mode is usually default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">state_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atombios_get_power_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">mode_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">PowerPlayInfo</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atom_parse_data_header</span><span class="p">(</span><span class="n">mode_info</span><span class="o">-&gt;</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">state_index</span> <span class="o">=</span> <span class="n">radeon_atombios_parse_power_table_1_3</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">state_index</span> <span class="o">=</span> <span class="n">radeon_atombios_parse_power_table_4_5</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">state_index</span> <span class="o">=</span> <span class="n">radeon_atombios_parse_power_table_6</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_power_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">=</span>
				<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_pm_clock_info</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* add the default mode */</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VOLTAGE_NONE</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="n">state_index</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span> <span class="o">=</span> <span class="n">state_index</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_vddc</span> <span class="o">=</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_vddc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atom_set_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DYNAMIC_CLOCK_GATING_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DynamicClockGating</span><span class="p">);</span>

	<span class="n">args</span><span class="p">.</span><span class="n">ucEnable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">radeon_atom_get_engine_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">GET_ENGINE_CLOCK_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">GetEngineClock</span><span class="p">);</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ulReturnEngineClock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">radeon_atom_get_memory_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">GET_MEMORY_CLOCK_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">GetMemoryClock</span><span class="p">);</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ulReturnMemoryClock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atom_set_engine_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="n">eng_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_ENGINE_CLOCK_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">SetEngineClock</span><span class="p">);</span>

	<span class="n">args</span><span class="p">.</span><span class="n">ulTargetEngineClock</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">eng_clock</span><span class="p">);</span>	<span class="cm">/* 10 khz */</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atom_set_memory_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="n">mem_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_MEMORY_CLOCK_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">SetMemoryClock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">ulTargetMemoryClock</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mem_clock</span><span class="p">);</span>	<span class="cm">/* 10 khz */</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">set_voltage</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">_SET_VOLTAGE_PS_ALLOCATION</span> <span class="n">alloc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_SET_VOLTAGE_PARAMETERS</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_SET_VOLTAGE_PARAMETERS_V2</span> <span class="n">v2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_SET_VOLTAGE_PARAMETERS_V1_3</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">radeon_atom_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">voltage_level</span><span class="p">,</span> <span class="n">u8</span> <span class="n">voltage_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">set_voltage</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">SetVoltage</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">,</span> <span class="n">volt_index</span> <span class="o">=</span> <span class="n">voltage_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* 0xff01 is a flag rather then an actual voltage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voltage_level</span> <span class="o">==</span> <span class="mh">0xff01</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucVoltageType</span> <span class="o">=</span> <span class="n">voltage_type</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucVoltageMode</span> <span class="o">=</span> <span class="n">SET_ASIC_VOLTAGE_MODE_ALL_SOURCE</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucVoltageIndex</span> <span class="o">=</span> <span class="n">volt_index</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucVoltageType</span> <span class="o">=</span> <span class="n">voltage_type</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucVoltageMode</span> <span class="o">=</span> <span class="n">SET_ASIC_VOLTAGE_MODE_SET_VOLTAGE</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usVoltageLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">voltage_level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucVoltageType</span> <span class="o">=</span> <span class="n">voltage_type</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucVoltageMode</span> <span class="o">=</span> <span class="n">ATOM_SET_VOLTAGE</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usVoltageLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">voltage_level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_atom_get_max_vddc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">voltage_type</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">voltage_id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">set_voltage</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">SetVoltage</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucVoltageType</span> <span class="o">=</span> <span class="n">SET_VOLTAGE_GET_MAX_VOLTAGE</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucVoltageMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usVoltageLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

		<span class="o">*</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usVoltageLevel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucVoltageType</span> <span class="o">=</span> <span class="n">voltage_type</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucVoltageMode</span> <span class="o">=</span> <span class="n">ATOM_GET_VOLTAGE_LEVEL</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usVoltageLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">voltage_id</span><span class="p">);</span>

		<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

		<span class="o">*</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usVoltageLevel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atom_initialize_bios_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bios_2_scratch</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_2_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_2_SCRATCH</span><span class="p">);</span>
		<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_6_SCRATCH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bios_2_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_2_SCRATCH</span><span class="p">);</span>
		<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* let the bios control the backlight */</span>
	<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_VRI_BRIGHT_ENABLE</span><span class="p">;</span>

	<span class="cm">/* tell the bios not to handle mode switching */</span>
	<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_BLOCK_DISPLAY_SWITCH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_2_SCRATCH</span><span class="p">,</span> <span class="n">bios_2_scratch</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_2_SCRATCH</span><span class="p">,</span> <span class="n">bios_2_scratch</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_save_bios_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">scratch_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">scratch_reg</span> <span class="o">=</span> <span class="n">R600_BIOS_0_SCRATCH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scratch_reg</span> <span class="o">=</span> <span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_BIOS_NUM_SCRATCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_scratch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">scratch_reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_restore_bios_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">scratch_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">scratch_reg</span> <span class="o">=</span> <span class="n">R600_BIOS_0_SCRATCH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scratch_reg</span> <span class="o">=</span> <span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_BIOS_NUM_SCRATCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">scratch_reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_scratch</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_atom_output_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="n">bool</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bios_6_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_6_SCRATCH</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_CRITICAL_STATE</span><span class="p">;</span>
		<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_MODE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_CRITICAL_STATE</span><span class="p">;</span>
		<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_MODE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* at some point we may want to break this out into individual functions */</span>
<span class="kt">void</span>
<span class="nf">radeon_atombios_connected_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">connected</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span>
	    <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_0_scratch</span><span class="p">,</span> <span class="n">bios_3_scratch</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_0_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_0_SCRATCH</span><span class="p">);</span>
		<span class="n">bios_3_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_3_SCRATCH</span><span class="p">);</span>
		<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_6_SCRATCH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bios_0_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">);</span>
		<span class="n">bios_3_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">);</span>
		<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TV1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_TV1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_TV1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TV1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_TV1_MASK</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_TV1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_TV1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CV connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_CV_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_CV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CV disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_CV_MASK</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_CV_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_CV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LCD1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_LCD1</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_LCD1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_LCD1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LCD1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_LCD1</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_LCD1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_LCD1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_CRT1_COLOR</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_CRT1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_CRT1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_CRT1_MASK</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_CRT1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_CRT1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT2 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_CRT2_COLOR</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_CRT2_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_CRT2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT2 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_CRT2_MASK</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_CRT2_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_CRT2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_DFP1</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_DFP1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_DFP1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_DFP1</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP1_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_DFP1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP2 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_DFP2</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_DFP2_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_DFP2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP2 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_DFP2</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP2_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_DFP2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP3 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_DFP3</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_DFP3_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_DFP3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP3 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_DFP3</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP3_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_DFP3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP4_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP4_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP4 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_DFP4</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_DFP4_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_DFP4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP4 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_DFP4</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP4_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_DFP4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP5_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP5_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP5 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_DFP5</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_DFP5_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_DFP5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP5 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_DFP5</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP5_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_DFP5</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP6_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP6_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP6 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S0_DFP6</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S3_DFP6_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S6_ACC_REQ_DFP6</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP6 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S0_DFP6</span><span class="p">;</span>
			<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP6_ACTIVE</span><span class="p">;</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S6_ACC_REQ_DFP6</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_0_SCRATCH</span><span class="p">,</span> <span class="n">bios_0_scratch</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_3_SCRATCH</span><span class="p">,</span> <span class="n">bios_3_scratch</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">,</span> <span class="n">bios_0_scratch</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">,</span> <span class="n">bios_3_scratch</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_atombios_encoder_crtc_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_3_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">bios_3_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_3_SCRATCH</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bios_3_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_TV1_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_CV_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_CRT1_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_CRT2_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_LCD1_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP1_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP2_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_3_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S3_DFP3_CRTC_ACTIVE</span><span class="p">;</span>
		<span class="n">bios_3_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_3_SCRATCH</span><span class="p">,</span> <span class="n">bios_3_scratch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">,</span> <span class="n">bios_3_scratch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_atombios_encoder_dpms_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_2_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">bios_2_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_2_SCRATCH</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bios_2_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_2_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_TV1_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_TV1_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_CV_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_CV_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_CRT1_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_CRT1_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_CRT2_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_CRT2_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_LCD1_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_LCD1_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_DFP1_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_DFP1_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_DFP2_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_DFP2_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP3_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_DFP3_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_DFP3_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP4_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_DFP4_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_DFP4_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP5_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_2_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATOM_S2_DFP5_DPMS_STATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_2_scratch</span> <span class="o">|=</span> <span class="n">ATOM_S2_DFP5_DPMS_STATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">R600_BIOS_2_SCRATCH</span><span class="p">,</span> <span class="n">bios_2_scratch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_2_SCRATCH</span><span class="p">,</span> <span class="n">bios_2_scratch</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
