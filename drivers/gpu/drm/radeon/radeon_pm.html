<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_pm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_pm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Rafał Miłecki &lt;zajec5@gmail.com&gt;</span>
<span class="cm"> *          Alex Deucher &lt;alexdeucher@gmail.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;avivod.h&quot;</span>
<span class="cp">#include &quot;atom.h&quot;</span>
<span class="cp">#ifdef CONFIG_ACPI</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>

<span class="cp">#define RADEON_IDLE_LOOP_MS 100</span>
<span class="cp">#define RADEON_RECLOCK_DELAY_MS 200</span>
<span class="cp">#define RADEON_WAIT_VBLANK_TIMEOUT 200</span>
<span class="cp">#define RADEON_WAIT_IDLE_TIMEOUT 200</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">radeon_pm_state_type_name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Default&quot;</span><span class="p">,</span>
	<span class="s">&quot;Powersave&quot;</span><span class="p">,</span>
	<span class="s">&quot;Battery&quot;</span><span class="p">,</span>
	<span class="s">&quot;Balanced&quot;</span><span class="p">,</span>
	<span class="s">&quot;Performance&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">radeon_dynpm_idle_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radeon_debugfs_pm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">radeon_pm_in_vbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">radeon_pm_debug_check_in_vbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">finish</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">radeon_pm_update_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>

<span class="cp">#define ACPI_AC_CLASS           &quot;ac_adapter&quot;</span>

<span class="kt">int</span> <span class="nf">radeon_pm_get_type_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">radeon_pm_state_type</span> <span class="n">ps_type</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_instance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">ps_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found_instance</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found_instance</span> <span class="o">==</span> <span class="n">instance</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* return default if no match */</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_acpi_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_device</span><span class="p">,</span> <span class="n">acpi_nb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acpi_bus_event</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_bus_event</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">device_class</span><span class="p">,</span> <span class="n">ACPI_AC_CLASS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_supply_is_system_supplied</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pm: AC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pm: DC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_PROFILE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">==</span> <span class="n">PM_PROFILE_AUTO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
				<span class="n">radeon_pm_update_profile</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
				<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_update_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_PROFILE_DEFAULT</span>:
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_DEFAULT_IDX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_PROFILE_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">power_supply_is_system_supplied</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_HIGH_MH_IDX</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_HIGH_SH_IDX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_MID_MH_IDX</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_MID_SH_IDX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_PROFILE_LOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_LOW_MH_IDX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_LOW_SH_IDX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_PROFILE_MID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_MID_MH_IDX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_MID_SH_IDX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_PROFILE_HIGH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_HIGH_MH_IDX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span> <span class="o">=</span> <span class="n">PM_PROFILE_HIGH_SH_IDX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span> <span class="o">=</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span><span class="p">].</span><span class="n">dpms_off_ps_idx</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span> <span class="o">=</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span><span class="p">].</span><span class="n">dpms_off_cm_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span> <span class="o">=</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span><span class="p">].</span><span class="n">dpms_on_ps_idx</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span> <span class="o">=</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile_index</span><span class="p">].</span><span class="n">dpms_on_cm_idx</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_unmap_vram_bos</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">.</span><span class="n">objects</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">tbo</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_VRAM</span><span class="p">)</span>
			<span class="n">ttm_bo_unmap_virtual</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">tbo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_sync_with_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">vblank_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">vblank_queue</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">vblank_sync</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_WAIT_VBLANK_TIMEOUT</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_set_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sclk</span><span class="p">,</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">misc_after</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_gui_idle</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span><span class="p">].</span>
			<span class="n">clock_info</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span><span class="p">].</span><span class="n">sclk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sclk</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">)</span>
			<span class="n">sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>

		<span class="n">mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span><span class="p">].</span>
			<span class="n">clock_info</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span><span class="p">].</span><span class="n">mclk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mclk</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">)</span>
			<span class="n">mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>

		<span class="cm">/* upvolt before raising clocks, downvolt after lowering clocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sclk</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_sclk</span><span class="p">)</span>
			<span class="n">misc_after</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">radeon_sync_with_vblank</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_DYNPM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_pm_in_vbl</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">radeon_pm_prepare</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">misc_after</span><span class="p">)</span>
			<span class="cm">/* voltage, pcie lanes, etc.*/</span>
			<span class="n">radeon_pm_misc</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="cm">/* set engine clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sclk</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_sclk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_pm_debug_check_in_vbl</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">radeon_set_engine_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sclk</span><span class="p">);</span>
			<span class="n">radeon_pm_debug_check_in_vbl</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Setting: e: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sclk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* set memory clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asic</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">set_memory_clock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mclk</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_mclk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">radeon_pm_debug_check_in_vbl</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">radeon_set_memory_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mclk</span><span class="p">);</span>
			<span class="n">radeon_pm_debug_check_in_vbl</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Setting: m: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mclk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">misc_after</span><span class="p">)</span>
			<span class="cm">/* voltage, pcie lanes, etc.*/</span>
			<span class="n">radeon_pm_misc</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="n">radeon_pm_finish</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pm: GUI not idle!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_set_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* no need to take locks, etc. if nothing&#39;s going to change */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_clock_mode_index</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">requested_power_state_index</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vram_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>

	<span class="cm">/* gui idle int has issues on older chips it seems */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">installed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wait for GPU idle */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">gui_idle</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">gui_idle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">radeon_irq_set</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">idle_queue</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">gui_idle</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_WAIT_IDLE_TIMEOUT</span><span class="p">));</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">gui_idle</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">radeon_irq_set</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_fence_wait_empty_locked</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">radeon_unmap_vram_bos</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">installed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtcs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">req_vblank</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">drm_vblank_get</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">radeon_set_power_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">installed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">req_vblank</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">req_vblank</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">drm_vblank_put</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* update display watermarks based on new power state */</span>
	<span class="n">radeon_update_bandwidth_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span><span class="p">)</span>
		<span class="n">radeon_bandwidth_update</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_NONE</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vram_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_pm_print_states</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_power_state</span> <span class="o">*</span><span class="n">power_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pm_clock_info</span> <span class="o">*</span><span class="n">clock_info</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;%d Power State(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">power_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;State %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">radeon_pm_state_type_name</span><span class="p">[</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Default&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_PCIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">))</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%d PCIE Lanes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power_state</span><span class="o">-&gt;</span><span class="n">pcie_lanes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Single display only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%d Clock Mode(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power_state</span><span class="o">-&gt;</span><span class="n">num_clock_modes</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">power_state</span><span class="o">-&gt;</span><span class="n">num_clock_modes</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clock_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">power_state</span><span class="o">-&gt;</span><span class="n">clock_info</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span>
				<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%d e: %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">j</span><span class="p">,</span>
					<span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">sclk</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
					<span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_PM_MODE_NO_DISPLAY</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No display only&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%d e: %d</span><span class="se">\t</span><span class="s">m: %d</span><span class="se">\t</span><span class="s">v: %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">j</span><span class="p">,</span>
					<span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">sclk</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
					<span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
					<span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span><span class="p">,</span>
					<span class="n">clock_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_PM_MODE_NO_DISPLAY</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No display only&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radeon_get_pm_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">PM_PROFILE_AUTO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;auto&quot;</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">PM_PROFILE_LOW</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;low&quot;</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">PM_PROFILE_MID</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;mid&quot;</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">PM_PROFILE_HIGH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;high&quot;</span> <span class="o">:</span> <span class="s">&quot;default&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radeon_set_pm_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_PROFILE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_DEFAULT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;auto&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_AUTO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;low&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;low&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_LOW</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;mid&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;mid&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_MID</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;high&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;high&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_HIGH</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radeon_pm_update_profile</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radeon_get_pm_method</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">pm</span> <span class="o">==</span> <span class="n">PM_METHOD_DYNPM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;dynpm&quot;</span> <span class="o">:</span> <span class="s">&quot;profile&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radeon_set_pm_method</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;dynpm&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;dynpm&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">=</span> <span class="n">PM_METHOD_DYNPM</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_PAUSED</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_DEFAULT</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;profile&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;profile&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="cm">/* disable dynpm */</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_DISABLED</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_NONE</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">=</span> <span class="n">PM_METHOD_PROFILE</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">radeon_pm_compute_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">power_profile</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">radeon_get_pm_profile</span><span class="p">,</span> <span class="n">radeon_set_pm_profile</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">power_method</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">radeon_get_pm_method</span><span class="p">,</span> <span class="n">radeon_set_pm_method</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radeon_hwmon_show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">THERMAL_TYPE_RV6XX</span>:
		<span class="n">temp</span> <span class="o">=</span> <span class="n">rv6xx_get_temp</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">THERMAL_TYPE_RV770</span>:
		<span class="n">temp</span> <span class="o">=</span> <span class="n">rv770_get_temp</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">THERMAL_TYPE_EVERGREEN</span>:
	<span class="k">case</span> <span class="n">THERMAL_TYPE_NI</span>:
		<span class="n">temp</span> <span class="o">=</span> <span class="n">evergreen_get_temp</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">THERMAL_TYPE_SUMO</span>:
		<span class="n">temp</span> <span class="o">=</span> <span class="n">sumo_get_temp</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">THERMAL_TYPE_SI</span>:
		<span class="n">temp</span> <span class="o">=</span> <span class="n">si_get_temp</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radeon_hwmon_show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;radeon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">radeon_hwmon_show_temp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">radeon_hwmon_show_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">hwmon_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_name</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">hwmon_attrgroup</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">hwmon_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_hwmon_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">THERMAL_TYPE_RV6XX</span>:
	<span class="k">case</span> <span class="n">THERMAL_TYPE_RV770</span>:
	<span class="k">case</span> <span class="n">THERMAL_TYPE_EVERGREEN</span>:
	<span class="k">case</span> <span class="n">THERMAL_TYPE_NI</span>:
	<span class="k">case</span> <span class="n">THERMAL_TYPE_SUMO</span>:
	<span class="k">case</span> <span class="n">THERMAL_TYPE_SI</span>:
		<span class="cm">/* No support for TN yet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_ARUBA</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to register hwmon device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">hwmon_attrgroup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to create hwmon sysfs file: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_hwmon_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwmon_attrgroup</span><span class="p">);</span>
		<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_hwmon_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_pm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_DYNPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">==</span> <span class="n">DYNPM_STATE_ACTIVE</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_SUSPENDED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_pm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set up the default clocks if the MC ucode is loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddc</span><span class="p">)</span>
			<span class="n">radeon_atom_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddc</span><span class="p">,</span>
						<span class="n">SET_VOLTAGE_TYPE_ASIC_VDDC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddci</span><span class="p">)</span>
			<span class="n">radeon_atom_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddci</span><span class="p">,</span>
						<span class="n">SET_VOLTAGE_TYPE_ASIC_VDDCI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">)</span>
			<span class="n">radeon_set_engine_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">)</span>
			<span class="n">radeon_set_memory_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* asic init will reset the default power state */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_vddc</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">voltage</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_vddci</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">vddci</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_DYNPM</span>
	    <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">==</span> <span class="n">DYNPM_STATE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_ACTIVE</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">,</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_IDLE_LOOP_MS</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">radeon_pm_compute_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_pm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* default to profile method */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">=</span> <span class="n">PM_METHOD_PROFILE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_DEFAULT</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_DISABLED</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_NONE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_can_upclock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_can_downclock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">int_thermal_type</span> <span class="o">=</span> <span class="n">THERMAL_TYPE_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">is_atom_bios</span><span class="p">)</span>
			<span class="n">radeon_atombios_get_power_modes</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">radeon_combios_get_power_modes</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">radeon_pm_print_states</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">radeon_pm_init_profile</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="cm">/* set up the default clocks if the MC ucode is loaded */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc_fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddc</span><span class="p">)</span>
				<span class="n">radeon_atom_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddc</span><span class="p">,</span>
							<span class="n">SET_VOLTAGE_TYPE_ASIC_VDDC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddci</span><span class="p">)</span>
				<span class="n">radeon_atom_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_vddci</span><span class="p">,</span>
							<span class="n">SET_VOLTAGE_TYPE_ASIC_VDDCI</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">)</span>
				<span class="n">radeon_set_engine_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">)</span>
				<span class="n">radeon_set_memory_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set up the internal thermal sensor if applicable */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_hwmon_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">,</span> <span class="n">radeon_dynpm_idle_work_handler</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* where&#39;s the best place to put these? */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_power_profile</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to create device file for power profile</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_power_method</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to create device file for power method</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">acpi_nb</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">radeon_acpi_event</span><span class="p">;</span>
		<span class="n">register_acpi_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">acpi_nb</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_debugfs_pm_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register debugfs file for PM!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;radeon: power management initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_pm_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_PROFILE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">PM_PROFILE_DEFAULT</span><span class="p">;</span>
			<span class="n">radeon_pm_update_profile</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_DYNPM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset default clocks */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_DISABLED</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_DEFAULT</span><span class="p">;</span>
			<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">);</span>

		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_power_profile</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_power_method</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ACPI</span>
		<span class="n">unregister_acpi_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">acpi_nb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">);</span>

	<span class="n">radeon_hwmon_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_pm_compute_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtcs</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_PROFILE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_pm_update_profile</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">pm_method</span> <span class="o">==</span> <span class="n">PM_METHOD_DYNPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">!=</span> <span class="n">DYNPM_STATE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">==</span> <span class="n">DYNPM_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">);</span>

					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_PAUSED</span><span class="p">;</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_DEFAULT</span><span class="p">;</span>
					<span class="n">radeon_pm_get_dynpm_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
					<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

					<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;radeon: dynamic power management deactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtc_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* TODO: Increase clocks if needed for current mode */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">==</span> <span class="n">DYNPM_STATE_MINIMUM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_ACTIVE</span><span class="p">;</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_UPCLOCK</span><span class="p">;</span>
					<span class="n">radeon_pm_get_dynpm_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
					<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

					<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">,</span>
							      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_IDLE_LOOP_MS</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">==</span> <span class="n">DYNPM_STATE_PAUSED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_ACTIVE</span><span class="p">;</span>
					<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">,</span>
							      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_IDLE_LOOP_MS</span><span class="p">));</span>
					<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;radeon: dynamic power management activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* count == 0 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">!=</span> <span class="n">DYNPM_STATE_MINIMUM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">);</span>

					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">=</span> <span class="n">DYNPM_STATE_MINIMUM</span><span class="p">;</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_MINIMUM</span><span class="p">;</span>
					<span class="n">radeon_pm_get_dynpm_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
					<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_pm_in_vbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">crtc</span><span class="p">,</span> <span class="n">vpos</span><span class="p">,</span> <span class="n">hpos</span><span class="p">,</span> <span class="n">vbl_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">in_vbl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Iterate over all active crtc&#39;s. All crtc&#39;s must be in vblank,</span>
<span class="cm">	 * otherwise return in_vbl == false.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">in_vbl</span><span class="p">;</span> <span class="n">crtc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">active_crtcs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">crtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vbl_status</span> <span class="o">=</span> <span class="n">radeon_get_crtc_scanoutpos</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hpos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">vbl_status</span> <span class="o">&amp;</span> <span class="n">DRM_SCANOUTPOS_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">vbl_status</span> <span class="o">&amp;</span> <span class="n">DRM_SCANOUTPOS_INVBL</span><span class="p">))</span>
				<span class="n">in_vbl</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">in_vbl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_pm_debug_check_in_vbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">finish</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat_crtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">in_vbl</span> <span class="o">=</span> <span class="n">radeon_pm_in_vbl</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_vbl</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;not in vbl for pm change %08x at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat_crtc</span><span class="p">,</span>
			 <span class="n">finish</span> <span class="o">?</span> <span class="s">&quot;exit&quot;</span> <span class="o">:</span> <span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">in_vbl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_dynpm_idle_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resched</span><span class="p">;</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_device</span><span class="p">,</span>
				<span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">resched</span> <span class="o">=</span> <span class="n">ttm_bo_lock_delayed_workqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_state</span> <span class="o">==</span> <span class="n">DYNPM_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">not_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_NUM_RINGS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">not_processed</span> <span class="o">+=</span> <span class="n">radeon_fence_count_emitted</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">not_processed</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">not_processed</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* should upclock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">==</span> <span class="n">DYNPM_ACTION_DOWNCLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_NONE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">==</span> <span class="n">DYNPM_ACTION_NONE</span> <span class="o">&amp;&amp;</span>
				   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_can_upclock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span>
					<span class="n">DYNPM_ACTION_UPCLOCK</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_action_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_RECLOCK_DELAY_MS</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">not_processed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* should downclock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">==</span> <span class="n">DYNPM_ACTION_UPCLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span> <span class="n">DYNPM_ACTION_NONE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">==</span> <span class="n">DYNPM_ACTION_NONE</span> <span class="o">&amp;&amp;</span>
				   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_can_downclock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">=</span>
					<span class="n">DYNPM_ACTION_DOWNCLOCK</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_action_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_RECLOCK_DELAY_MS</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Note, radeon_pm_set_clocks is called with static_switch set</span>
<span class="cm">		 * to false since we want to wait for vbl to avoid flicker.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_planned_action</span> <span class="o">!=</span> <span class="n">DYNPM_ACTION_NONE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">jiffies</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_action_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_pm_get_dynpm_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="n">radeon_pm_set_clocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">dynpm_idle_work</span><span class="p">,</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RADEON_IDLE_LOOP_MS</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ttm_bo_unlock_delayed_workqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">,</span> <span class="n">resched</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debugfs info</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_debugfs_pm_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;default engine clock: %u0 kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;current engine clock: %u0 kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radeon_get_engine_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;default memory clock: %u0 kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asic</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">get_memory_clock</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;current memory clock: %u0 kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radeon_get_memory_clock</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_vddc</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;voltage: %u mV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_vddc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asic</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">get_pcie_lanes</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PCIE lanes: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radeon_get_pcie_lanes</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_info_list</span> <span class="n">radeon_pm_info_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;radeon_pm_info&quot;</span><span class="p">,</span> <span class="n">radeon_debugfs_pm_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_debugfs_pm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>
	<span class="k">return</span> <span class="n">radeon_debugfs_add_files</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">radeon_pm_info_list</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">radeon_pm_info_list</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
