<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_kms.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_kms.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> * Copyright 2009 Jerome Glisse.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> *          Jerome Glisse</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm_sarea.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>

<span class="cp">#include &lt;linux/vga_switcheroo.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="kt">int</span> <span class="nf">radeon_driver_unload_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">radeon_modeset_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">radeon_device_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_driver_load_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">acpi_status</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rdev</span><span class="p">;</span>

	<span class="cm">/* update BUS flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_pci_device_is_agp</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_AGP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_PCIE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_PCI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* radeon_device_init should report only fatal error</span>
<span class="cm">	 * like memory allocation failure or iomapping failure,</span>
<span class="cm">	 * or memory manager initialization failure, it must</span>
<span class="cm">	 * properly initialize the GPU MC controller and permit</span>
<span class="cm">	 * VRAM allocation</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_device_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fatal error during GPU init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Call ACPI methods */</span>
	<span class="n">acpi_status</span> <span class="o">=</span> <span class="n">radeon_acpi_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_status</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error during ACPI methods call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Again modeset_init should fail only on fatal error</span>
<span class="cm">	 * otherwise it should provide enough functionalities</span>
<span class="cm">	 * for shadowfb to run</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_modeset_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fatal error during modeset init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">radeon_driver_unload_kms</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_set_filp_rights</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">**</span><span class="n">owner</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">applier</span><span class="p">,</span>
				   <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wants rights */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">owner</span><span class="p">)</span>
			<span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="n">applier</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* revokes rights */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">owner</span> <span class="o">==</span> <span class="n">applier</span><span class="p">)</span>
			<span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">owner</span> <span class="o">==</span> <span class="n">applier</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Userspace get information ioctl</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_info_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_mode_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">value_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">value_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">value_ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_DEVICE_ID</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_device</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_NUM_GB_PIPES</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_NUM_Z_PIPES</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_z_pipes</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_ACCEL_WORKING</span>:
		<span class="cm">/* xf86-video-ati 6.13.0 relies on this being false for evergreen */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CEDAR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_HEMLOCK</span><span class="p">))</span>
			<span class="n">value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">accel_working</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_CRTC_FROM_ID</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crtc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="p">)</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">crtcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;unknown crtc id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_ACCEL_WORKING2</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">accel_working</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_TILING_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_TAHITI</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CEDAR</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">evergreen</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;tiling config is r6xx+ only!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_WANT_HYPERZ</span>:
		<span class="cm">/* The &quot;value&quot; here is both an input and output parameter.</span>
<span class="cm">		 * If the input value is 1, filp requests hyper-z access.</span>
<span class="cm">		 * If the input value is 0, filp revokes its hyper-z access.</span>
<span class="cm">		 *</span>
<span class="cm">		 * When returning, the value is 1 if filp owns hyper-z access,</span>
<span class="cm">		 * 0 otherwise. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;WANT_HYPERZ: invalid value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radeon_set_filp_rights</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hyperz_filp</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_WANT_CMASK</span>:
		<span class="cm">/* The same logic as Hyper-Z. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;WANT_CMASK: invalid value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radeon_set_filp_rights</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">cmask_filp</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_CLOCK_CRYSTAL_FREQ</span>:
		<span class="cm">/* return clock value in KHz */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">spll</span><span class="p">.</span><span class="n">reference_freq</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_NUM_BACKENDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_TAHITI</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">max_backends_per_se</span> <span class="o">*</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">max_shader_engines</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">max_backends_per_se</span> <span class="o">*</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">max_shader_engines</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CEDAR</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">evergreen</span><span class="p">.</span><span class="n">max_backends</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">max_backends</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">max_backends</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_NUM_TILE_PIPES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_TAHITI</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">max_tile_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">max_tile_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CEDAR</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">evergreen</span><span class="p">.</span><span class="n">max_tile_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">max_tile_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">max_tile_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_FUSION_GART_WORKING</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_BACKEND_MAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_TAHITI</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">backend_map</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">backend_map</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CEDAR</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">evergreen</span><span class="p">.</span><span class="n">backend_map</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">backend_map</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">backend_map</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_VA_START</span>:
		<span class="cm">/* this is where we report if vm is supported or not */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">RADEON_VA_RESERVED_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_IB_VM_MAX_SIZE</span>:
		<span class="cm">/* this is where we report if vm is supported or not */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">RADEON_IB_VM_MAX_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INFO_MAX_PIPES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_TAHITI</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">si</span><span class="p">.</span><span class="n">max_cu_per_sh</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">max_pipes_per_simd</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CEDAR</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">evergreen</span><span class="p">.</span><span class="n">max_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">max_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">max_pipes</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid request %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="n">value_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;copy_to_user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Outdated mess for old drm with Xorg being in charge (void function now).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_driver_firstopen_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_driver_lastclose_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vga_switcheroo_process_delayed_switch</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_driver_open_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* new gpu have virtual address space support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_fpriv</span> <span class="o">*</span><span class="n">fpriv</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">fpriv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fpriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fpriv</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_vm_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpriv</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_vm_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpriv</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fpriv</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">fpriv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_driver_postclose_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* new gpu have virtual address space support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span> <span class="o">&amp;&amp;</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_fpriv</span> <span class="o">*</span><span class="n">fpriv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

		<span class="n">radeon_vm_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpriv</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fpriv</span><span class="p">);</span>
		<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_driver_preclose_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hyperz_filp</span> <span class="o">==</span> <span class="n">file_priv</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">hyperz_filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">cmask_filp</span> <span class="o">==</span> <span class="n">file_priv</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">cmask_filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VBlank related functions.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">radeon_get_vblank_counter_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">crtc</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">radeon_get_vblank_counter</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_enable_vblank_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">crtc</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">crtc_vblank_int</span><span class="p">[</span><span class="n">crtc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">radeon_irq_set</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_disable_vblank_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">crtc</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">.</span><span class="n">crtc_vblank_int</span><span class="p">[</span><span class="n">crtc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">radeon_irq_set</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_get_vblank_timestamp_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="o">*</span><span class="n">max_error</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">vblank_time</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">drmcrtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">crtc</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_crtcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get associated drm_crtc: */</span>
	<span class="n">drmcrtc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">crtcs</span><span class="p">[</span><span class="n">crtc</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* Helper routine in DRM core does all the work: */</span>
	<span class="k">return</span> <span class="n">drm_calc_vbltimestamp_from_scanoutpos</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="n">max_error</span><span class="p">,</span>
						     <span class="n">vblank_time</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
						     <span class="n">drmcrtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOCTL.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_dma_ioctl_kms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Not valid in KMS. */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define KMS_INVALID_IOCTL(name)						\</span>
<span class="cp">int name(struct drm_device *dev, void *data, struct drm_file *file_priv)\</span>
<span class="cp">{									\</span>
<span class="cp">	DRM_ERROR(&quot;invalid ioctl with kms %s\n&quot;, __func__);		\</span>
<span class="cp">	return -EINVAL;							\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm"> * All these ioctls are invalid in kms world.</span>
<span class="cm"> */</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_init_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_start_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_stop_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_reset_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_idle_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_resume_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_engine_reset_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_fullscreen_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_swap_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_clear_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_vertex_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_indices_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_texture_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_stipple_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_indirect_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_vertex2_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_cmdbuf_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_getparam_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_flip_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_mem_alloc_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_mem_free_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_mem_init_heap_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_irq_emit_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_irq_wait_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_cp_setparam_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_surface_alloc_kms</span><span class="p">)</span>
<span class="n">KMS_INVALID_IOCTL</span><span class="p">(</span><span class="n">radeon_surface_free_kms</span><span class="p">)</span>


<span class="k">struct</span> <span class="n">drm_ioctl_desc</span> <span class="n">radeon_ioctls_kms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_INIT</span><span class="p">,</span> <span class="n">radeon_cp_init_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_START</span><span class="p">,</span> <span class="n">radeon_cp_start_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_STOP</span><span class="p">,</span> <span class="n">radeon_cp_stop_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_RESET</span><span class="p">,</span> <span class="n">radeon_cp_reset_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_IDLE</span><span class="p">,</span> <span class="n">radeon_cp_idle_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_RESUME</span><span class="p">,</span> <span class="n">radeon_cp_resume_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_RESET</span><span class="p">,</span> <span class="n">radeon_engine_reset_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_FULLSCREEN</span><span class="p">,</span> <span class="n">radeon_fullscreen_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SWAP</span><span class="p">,</span> <span class="n">radeon_cp_swap_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CLEAR</span><span class="p">,</span> <span class="n">radeon_cp_clear_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_VERTEX</span><span class="p">,</span> <span class="n">radeon_cp_vertex_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INDICES</span><span class="p">,</span> <span class="n">radeon_cp_indices_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_TEXTURE</span><span class="p">,</span> <span class="n">radeon_cp_texture_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_STIPPLE</span><span class="p">,</span> <span class="n">radeon_cp_stipple_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INDIRECT</span><span class="p">,</span> <span class="n">radeon_cp_indirect_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_VERTEX2</span><span class="p">,</span> <span class="n">radeon_cp_vertex2_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CMDBUF</span><span class="p">,</span> <span class="n">radeon_cp_cmdbuf_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GETPARAM</span><span class="p">,</span> <span class="n">radeon_cp_getparam_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_FLIP</span><span class="p">,</span> <span class="n">radeon_cp_flip_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_ALLOC</span><span class="p">,</span> <span class="n">radeon_mem_alloc_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_FREE</span><span class="p">,</span> <span class="n">radeon_mem_free_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INIT_HEAP</span><span class="p">,</span> <span class="n">radeon_mem_init_heap_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_IRQ_EMIT</span><span class="p">,</span> <span class="n">radeon_irq_emit_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_IRQ_WAIT</span><span class="p">,</span> <span class="n">radeon_irq_wait_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SETPARAM</span><span class="p">,</span> <span class="n">radeon_cp_setparam_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SURF_ALLOC</span><span class="p">,</span> <span class="n">radeon_surface_alloc_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SURF_FREE</span><span class="p">,</span> <span class="n">radeon_surface_free_kms</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="cm">/* KMS */</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_INFO</span><span class="p">,</span> <span class="n">radeon_gem_info_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_CREATE</span><span class="p">,</span> <span class="n">radeon_gem_create_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_MMAP</span><span class="p">,</span> <span class="n">radeon_gem_mmap_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_SET_DOMAIN</span><span class="p">,</span> <span class="n">radeon_gem_set_domain_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_PREAD</span><span class="p">,</span> <span class="n">radeon_gem_pread_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_PWRITE</span><span class="p">,</span> <span class="n">radeon_gem_pwrite_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_WAIT_IDLE</span><span class="p">,</span> <span class="n">radeon_gem_wait_idle_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CS</span><span class="p">,</span> <span class="n">radeon_cs_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INFO</span><span class="p">,</span> <span class="n">radeon_info_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_SET_TILING</span><span class="p">,</span> <span class="n">radeon_gem_set_tiling_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_GET_TILING</span><span class="p">,</span> <span class="n">radeon_gem_get_tiling_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_BUSY</span><span class="p">,</span> <span class="n">radeon_gem_busy_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GEM_VA</span><span class="p">,</span> <span class="n">radeon_gem_va_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="n">radeon_max_kms_ioctl</span> <span class="o">=</span> <span class="n">DRM_ARRAY_SIZE</span><span class="p">(</span><span class="n">radeon_ioctls_kms</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
