<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_combios.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_combios.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2004 ATI Technologies Inc., Markham, Ontario</span>
<span class="cm"> * Copyright 2007-8 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;atom.h&quot;</span>

<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cm">/* not sure which of these are needed */</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>

<span class="cm">/* from radeon_encoder.c */</span>
<span class="k">extern</span> <span class="kt">uint32_t</span>
<span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span>
			<span class="kt">uint8_t</span> <span class="n">dac</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">radeon_link_encoder_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* from radeon_connector.c */</span>
<span class="k">extern</span> <span class="kt">void</span>
<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="n">connector_id</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">connector_type</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="o">*</span><span class="n">i2c_bus</span><span class="p">,</span>
			    <span class="kt">uint16_t</span> <span class="n">connector_object_id</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="o">*</span><span class="n">hpd</span><span class="p">);</span>

<span class="cm">/* from radeon_legacy_encoder.c */</span>
<span class="k">extern</span> <span class="kt">void</span>
<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">encoder_enum</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">);</span>

<span class="cm">/* old legacy ATI BIOS routines */</span>

<span class="cm">/* COMBIOS table offsets */</span>
<span class="k">enum</span> <span class="n">radeon_combios_table_offset</span> <span class="p">{</span>
	<span class="cm">/* absolute offset tables */</span>
	<span class="n">COMBIOS_ASIC_INIT_1_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_BIOS_SUPPORT_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_DAC_PROGRAMMING_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_MAX_COLOR_DEPTH_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_CRTC_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_PLL_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_TV_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_DFP_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_HW_CONFIG_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_MULTIMEDIA_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_TV_STD_PATCH_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_LCD_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_MOBILE_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_PLL_INIT_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_MEM_CONFIG_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_SAVE_MASK_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_HARDCODED_EDID_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_ASIC_INIT_2_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_CONNECTOR_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_DYN_CLK_1_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_RESERVED_MEM_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_EXT_TMDS_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_MEM_CLK_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_EXT_DAC_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_MISC_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_CRT_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_COMPONENT_VIDEO_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_FAN_SPEED_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_OVERDRIVE_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_OEM_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_DYN_CLK_2_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_POWER_CONNECTOR_INFO_TABLE</span><span class="p">,</span>
	<span class="n">COMBIOS_I2C_INFO_TABLE</span><span class="p">,</span>
	<span class="cm">/* relative offset tables */</span>
	<span class="n">COMBIOS_ASIC_INIT_3_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from misc info */</span>
	<span class="n">COMBIOS_ASIC_INIT_4_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from misc info */</span>
	<span class="n">COMBIOS_DETECTED_MEM_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from misc info */</span>
	<span class="n">COMBIOS_ASIC_INIT_5_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from misc info */</span>
	<span class="n">COMBIOS_RAM_RESET_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from mem config */</span>
	<span class="n">COMBIOS_POWERPLAY_INFO_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from mobile info */</span>
	<span class="n">COMBIOS_GPIO_INFO_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from mobile info */</span>
	<span class="n">COMBIOS_LCD_DDC_INFO_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from mobile info */</span>
	<span class="n">COMBIOS_TMDS_POWER_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from mobile info */</span>
	<span class="n">COMBIOS_TMDS_POWER_ON_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from tmds power */</span>
	<span class="n">COMBIOS_TMDS_POWER_OFF_TABLE</span><span class="p">,</span>	<span class="cm">/* offset from tmds power */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">radeon_combios_ddc</span> <span class="p">{</span>
	<span class="n">DDC_NONE_DETECTED</span><span class="p">,</span>
	<span class="n">DDC_MONID</span><span class="p">,</span>
	<span class="n">DDC_DVI</span><span class="p">,</span>
	<span class="n">DDC_VGA</span><span class="p">,</span>
	<span class="n">DDC_CRT2</span><span class="p">,</span>
	<span class="n">DDC_LCD</span><span class="p">,</span>
	<span class="n">DDC_GPIO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">radeon_combios_connector</span> <span class="p">{</span>
	<span class="n">CONNECTOR_NONE_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_PROPRIETARY_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_CRT_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_DVI_I_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_DVI_D_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_CTV_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_STV_LEGACY</span><span class="p">,</span>
	<span class="n">CONNECTOR_UNSUPPORTED_LEGACY</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">legacy_connector_convert</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Composite</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
	<span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">combios_get_table_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">radeon_combios_table_offset</span> <span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">check_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* absolute offset tables */</span>
	<span class="k">case</span> <span class="n">COMBIOS_ASIC_INIT_1_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_BIOS_SUPPORT_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_DAC_PROGRAMMING_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x2a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_MAX_COLOR_DEPTH_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_CRTC_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x2e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_PLL_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_TV_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_DFP_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x34</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_HW_CONFIG_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_MULTIMEDIA_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_TV_STD_PATCH_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x3e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_LCD_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_MOBILE_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x42</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_PLL_INIT_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x46</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_MEM_CONFIG_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_SAVE_MASK_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x4a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_HARDCODED_EDID_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_ASIC_INIT_2_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x4e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_CONNECTOR_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_DYN_CLK_1_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x52</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_RESERVED_MEM_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x54</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_EXT_TMDS_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_MEM_CLK_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x5a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_EXT_DAC_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x5c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_MISC_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x5e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_CRT_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x62</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_COMPONENT_VIDEO_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_FAN_SPEED_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_OVERDRIVE_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_OEM_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x6a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_DYN_CLK_2_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x6c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_POWER_CONNECTOR_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x6e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_I2C_INFO_TABLE</span>:
		<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios_header_start</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* relative offset tables */</span>
	<span class="k">case</span> <span class="n">COMBIOS_ASIC_INIT_3_TABLE</span>:	<span class="cm">/* offset from misc info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MISC_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">check_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_ASIC_INIT_4_TABLE</span>:	<span class="cm">/* offset from misc info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MISC_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">check_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_DETECTED_MEM_TABLE</span>:	<span class="cm">/* offset from misc info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MISC_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">check_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x7</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_ASIC_INIT_5_TABLE</span>:	<span class="cm">/* offset from misc info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MISC_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">check_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_RAM_RESET_TABLE</span>:	<span class="cm">/* offset from mem config */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MEM_CONFIG_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">check_offset</span><span class="o">++</span><span class="p">));</span>
			<span class="n">check_offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_POWERPLAY_INFO_TABLE</span>:	<span class="cm">/* offset from mobile info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MOBILE_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_GPIO_INFO_TABLE</span>:	<span class="cm">/* offset from mobile info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MOBILE_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x13</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_LCD_DDC_INFO_TABLE</span>:	<span class="cm">/* offset from mobile info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MOBILE_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x15</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_TMDS_POWER_TABLE</span>:	<span class="cm">/* offset from mobile info */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MOBILE_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x17</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_TMDS_POWER_ON_TABLE</span>:	<span class="cm">/* offset from tmds power */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_TMDS_POWER_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMBIOS_TMDS_POWER_OFF_TABLE</span>:	<span class="cm">/* offset from tmds power */</span>
		<span class="n">check_offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_TMDS_POWER_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">check_offset</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_offset</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">check_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_combios_check_hardcoded_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">edid_info</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="n">edid_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">COMBIOS_HARDCODED_EDID_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edid_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">raw</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">edid_info</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">EDID_LENGTH</span> <span class="o">*</span> <span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mh">0x7e</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">edid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">edid</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_edid_is_valid</span><span class="p">(</span><span class="n">edid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid</span> <span class="o">=</span> <span class="n">edid</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this is used for atom LCDs as well */</span>
<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span>
<span class="nf">radeon_bios_get_hardcoded_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">edid</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid</span><span class="p">,</span>
			       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">bios_hardcoded_edid_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">edid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="nf">combios_setup_i2c_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						       <span class="k">enum</span> <span class="n">radeon_combios_ddc</span> <span class="n">ddc</span><span class="p">,</span>
						       <span class="n">u32</span> <span class="n">clk_mask</span><span class="p">,</span>
						       <span class="n">u32</span> <span class="n">data_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ddc_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ddc id            = mask reg</span>
<span class="cm">	 * DDC_NONE_DETECTED = none</span>
<span class="cm">	 * DDC_DVI           = RADEON_GPIO_DVI_DDC</span>
<span class="cm">	 * DDC_VGA           = RADEON_GPIO_VGA_DDC</span>
<span class="cm">	 * DDC_LCD           = RADEON_GPIOPAD_MASK</span>
<span class="cm">	 * DDC_GPIO          = RADEON_MDGPIO_MASK</span>
<span class="cm">	 * r1xx</span>
<span class="cm">	 * DDC_MONID         = RADEON_GPIO_MONID</span>
<span class="cm">	 * DDC_CRT2          = RADEON_GPIO_CRT2_DDC</span>
<span class="cm">	 * r200</span>
<span class="cm">	 * DDC_MONID         = RADEON_GPIO_MONID</span>
<span class="cm">	 * DDC_CRT2          = RADEON_GPIO_DVI_DDC</span>
<span class="cm">	 * r300/r350</span>
<span class="cm">	 * DDC_MONID         = RADEON_GPIO_DVI_DDC</span>
<span class="cm">	 * DDC_CRT2          = RADEON_GPIO_DVI_DDC</span>
<span class="cm">	 * rv2xx/rv3xx</span>
<span class="cm">	 * DDC_MONID         = RADEON_GPIO_MONID</span>
<span class="cm">	 * DDC_CRT2          = RADEON_GPIO_MONID</span>
<span class="cm">	 * rs3xx/rs4xx</span>
<span class="cm">	 * DDC_MONID         = RADEON_GPIOPAD_MASK</span>
<span class="cm">	 * DDC_CRT2          = RADEON_GPIO_MONID</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ddc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DDC_NONE_DETECTED</span>:
	<span class="nl">default:</span>
		<span class="n">ddc_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DDC_DVI</span>:
		<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_DVI_DDC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DDC_VGA</span>:
		<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_VGA_DDC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DDC_LCD</span>:
		<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DDC_GPIO</span>:
		<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DDC_MONID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS300</span> <span class="o">||</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS400</span> <span class="o">||</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS480</span><span class="p">)</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_MASK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R300</span> <span class="o">||</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R350</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_DVI_DDC</span><span class="p">;</span>
			<span class="n">ddc</span> <span class="o">=</span> <span class="n">DDC_DVI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_MONID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DDC_CRT2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R200</span> <span class="o">||</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R300</span> <span class="o">||</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R350</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_DVI_DDC</span><span class="p">;</span>
			<span class="n">ddc</span> <span class="o">=</span> <span class="n">DDC_DVI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS300</span> <span class="o">||</span>
			   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS400</span> <span class="o">||</span>
			   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS480</span><span class="p">)</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_MONID</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV350</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_MONID</span><span class="p">;</span>
			<span class="n">ddc</span> <span class="o">=</span> <span class="n">DDC_MONID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ddc_line</span> <span class="o">=</span> <span class="n">RADEON_GPIO_CRT2_DDC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddc_line</span> <span class="o">==</span> <span class="n">RADEON_GPIOPAD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_MASK</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_MASK</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_A</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_A</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_EN</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_EN</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_Y</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_reg</span> <span class="o">=</span> <span class="n">RADEON_GPIOPAD_Y</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ddc_line</span> <span class="o">==</span> <span class="n">RADEON_MDGPIO_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_MASK</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_MASK</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_A</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_A</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_EN</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_EN</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_Y</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_reg</span> <span class="o">=</span> <span class="n">RADEON_MDGPIO_Y</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_reg</span> <span class="o">=</span> <span class="n">ddc_line</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk_mask</span> <span class="o">&amp;&amp;</span> <span class="n">data_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* system specific masks */</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_mask</span> <span class="o">=</span> <span class="n">clk_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_mask</span> <span class="o">=</span> <span class="n">data_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_mask</span> <span class="o">=</span> <span class="n">clk_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_mask</span> <span class="o">=</span> <span class="n">data_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_mask</span> <span class="o">=</span> <span class="n">clk_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_mask</span> <span class="o">=</span> <span class="n">data_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_mask</span> <span class="o">=</span> <span class="n">clk_mask</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_mask</span> <span class="o">=</span> <span class="n">data_mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ddc_line</span> <span class="o">==</span> <span class="n">RADEON_GPIOPAD_MASK</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ddc_line</span> <span class="o">==</span> <span class="n">RADEON_MDGPIO_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* default gpiopad masks */</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default masks for ddc pads */</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_clk_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_MASK_1</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">mask_data_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_MASK_0</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_clk_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_A_1</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">a_data_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_A_0</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_clk_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_EN_1</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">en_data_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_EN_0</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_clk_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_Y_1</span><span class="p">;</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">y_data_mask</span> <span class="o">=</span> <span class="n">RADEON_GPIO_Y_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_R100</span>:
	<span class="k">case</span> <span class="n">CHIP_RV100</span>:
	<span class="k">case</span> <span class="n">CHIP_RS100</span>:
	<span class="k">case</span> <span class="n">CHIP_RV200</span>:
	<span class="k">case</span> <span class="n">CHIP_RS200</span>:
	<span class="k">case</span> <span class="n">CHIP_RS300</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ddc_line</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RADEON_GPIO_DVI_DDC</span>:
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_R200</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ddc_line</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RADEON_GPIO_DVI_DDC</span>:
		<span class="k">case</span> <span class="n">RADEON_GPIO_MONID</span>:
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_RV250</span>:
	<span class="k">case</span> <span class="n">CHIP_RV280</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ddc_line</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RADEON_GPIO_VGA_DDC</span>:
		<span class="k">case</span> <span class="n">RADEON_GPIO_DVI_DDC</span>:
		<span class="k">case</span> <span class="n">RADEON_GPIO_CRT2_DDC</span>:
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_R300</span>:
	<span class="k">case</span> <span class="n">CHIP_R350</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ddc_line</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RADEON_GPIO_VGA_DDC</span>:
		<span class="k">case</span> <span class="n">RADEON_GPIO_DVI_DDC</span>:
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_RV350</span>:
	<span class="k">case</span> <span class="n">CHIP_RV380</span>:
	<span class="k">case</span> <span class="n">CHIP_RS400</span>:
	<span class="k">case</span> <span class="n">CHIP_RS480</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ddc_line</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RADEON_GPIO_VGA_DDC</span>:
		<span class="k">case</span> <span class="n">RADEON_GPIO_DVI_DDC</span>:
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RADEON_GPIO_MONID</span>:
			<span class="cm">/* hw i2c on RADEON_GPIO_MONID doesn&#39;t seem to work</span>
<span class="cm">			 * reliably on some pre-r4xx hardware; not sure why.</span>
<span class="cm">			 */</span>
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">mm_i2c</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">i2c</span><span class="p">.</span><span class="n">i2c_id</span> <span class="o">=</span> <span class="n">ddc</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddc_line</span><span class="p">)</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_combios_i2c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="cm">/* actual hw pads</span>
<span class="cm">	 * r1xx/rs2xx/rs3xx</span>
<span class="cm">	 * 0x60, 0x64, 0x68, 0x6c, gpiopads, mm</span>
<span class="cm">	 * r200</span>
<span class="cm">	 * 0x60, 0x64, 0x68, mm</span>
<span class="cm">	 * r300/r350</span>
<span class="cm">	 * 0x60, 0x64, mm</span>
<span class="cm">	 * rv2xx/rv3xx/rs4xx</span>
<span class="cm">	 * 0x60, 0x64, 0x68, gpiopads, mm</span>
<span class="cm">	 */</span>

	<span class="cm">/* 0x60 */</span>
	<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;DVI_DDC&quot;</span><span class="p">);</span>
	<span class="cm">/* 0x64 */</span>
	<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;VGA_DDC&quot;</span><span class="p">);</span>

	<span class="cm">/* mm i2c */</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">mm_i2c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">i2c</span><span class="p">.</span><span class="n">i2c_id</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;MM_I2C&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R300</span> <span class="o">||</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R350</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only 2 sw i2c pads */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS300</span> <span class="o">||</span>
		   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS400</span> <span class="o">||</span>
		   <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS480</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* 0x68 */</span>
		<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_CRT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;MONID&quot;</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_I2C_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blocks</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">136</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">clk</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
					<span class="n">data</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
					<span class="cm">/* gpiopad */</span>
					<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span>
								    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">));</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;GPIOPAD_MASK&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R200</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R300</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 0x68 */</span>
		<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;MONID&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 0x68 */</span>
		<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;MONID&quot;</span><span class="p">);</span>
		<span class="cm">/* 0x6c */</span>
		<span class="n">i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_CRT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_i2c_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;CRT2_DDC&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_combios_get_clock_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">pll_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">p1pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">p1pll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">p2pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">p2pll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">spll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">spll</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_pll</span> <span class="o">*</span><span class="n">mpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">mpll</span><span class="p">;</span>
	<span class="kt">int8_t</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">sclk</span><span class="p">,</span> <span class="n">mclk</span><span class="p">;</span>

	<span class="n">pll_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_PLL_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">pll_info</span><span class="p">);</span>

		<span class="cm">/* pixel clocks */</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">reference_div</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_min</span> <span class="o">=</span> <span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span><span class="p">;</span>
		<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">lcd_pll_out_max</span> <span class="o">=</span> <span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">);</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x3a</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
			<span class="n">p1pll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">p2pll</span> <span class="o">=</span> <span class="o">*</span><span class="n">p1pll</span><span class="p">;</span>

		<span class="cm">/* system clock */</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x1a</span><span class="p">);</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">reference_div</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">);</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x1e</span><span class="p">);</span>
		<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x22</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">);</span>
			<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ??? */</span>
			<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
			<span class="n">spll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* memory clock */</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">reference_freq</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">reference_div</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_min</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x2a</span><span class="p">);</span>
		<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_out_max</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x2e</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x5a</span><span class="p">);</span>
			<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x5e</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ??? */</span>
			<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_in_min</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
			<span class="n">mpll</span><span class="o">-&gt;</span><span class="n">pll_in_max</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* default sclk/mclk */</span>
		<span class="n">sclk</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0xa</span><span class="p">);</span>
		<span class="n">mclk</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sclk</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mclk</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span> <span class="o">=</span> <span class="n">sclk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">))</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">max_pixel_clock</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">pll_info</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">max_pixel_clock</span> <span class="o">=</span> <span class="mi">35000</span><span class="p">;</span> <span class="cm">/* might need something asic specific */</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_combios_sideport_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">igp_info</span><span class="p">;</span>

	<span class="cm">/* sideport is AMD only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS400</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">igp_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">igp_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">igp_info</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">default_primarydac_adj</span><span class="p">[</span><span class="n">CHIP_LAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* r100  */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv100 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rs100 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv200 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rs200 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* r200  */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv250 */</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* rs300 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv280 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* r300  */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* r350  */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv350 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv380 */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* r420  */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* r423  */</span>
	<span class="mh">0x00000808</span><span class="p">,</span>		<span class="cm">/* rv410 */</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* rs400 */</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* rs480 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_legacy_get_primary_dac_info_from_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
							  <span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span> <span class="o">*</span><span class="n">p_dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p_dac</span><span class="o">-&gt;</span><span class="n">ps2_pdac_adj</span> <span class="o">=</span> <span class="n">default_primarydac_adj</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">];</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span> <span class="o">*</span><span class="nf">radeon_combios_get_primary_dac_info</span><span class="p">(</span><span class="k">struct</span>
								       <span class="n">radeon_encoder</span>
								       <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">dac_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">rev</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span> <span class="o">*</span><span class="n">p_dac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p_dac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_primary_dac</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dac</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* check CRT table */</span>
	<span class="n">dac_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_CRT_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dac_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">p_dac</span><span class="o">-&gt;</span><span class="n">ps2_pdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">p_dac</span><span class="o">-&gt;</span><span class="n">ps2_pdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* if the values are all zeros, use the table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_dac</span><span class="o">-&gt;</span><span class="n">ps2_pdac_adj</span><span class="p">)</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="cm">/* fallback to defaults */</span>
		<span class="n">radeon_legacy_get_primary_dac_info_from_table</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">p_dac</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p_dac</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">radeon_tv_std</span>
<span class="nf">radeon_combios_get_tv_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tv_info</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_tv_std</span> <span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC</span><span class="p">;</span>

	<span class="n">tv_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_TV_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">tv_info</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">tv_info</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL_M</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL-M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_PAL_60</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: PAL-60</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC_J</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: NTSC-J</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_SCART_PAL</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Default TV standard: SCART-PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">tv_std</span> <span class="o">=</span> <span class="n">TV_STD_NTSC</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span>
				    <span class="p">(</span><span class="s">&quot;Unknown TV standard; defaulting to NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">((</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">tv_info</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;29.498928713 MHz TV ref clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;28.636360000 MHz TV ref clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;14.318180000 MHz TV ref clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;27.000000000 MHz TV ref clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tv_std</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">default_tvdac_adj</span><span class="p">[</span><span class="n">CHIP_LAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* r100  */</span>
	<span class="mh">0x00280000</span><span class="p">,</span>		<span class="cm">/* rv100 */</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* rs100 */</span>
	<span class="mh">0x00880000</span><span class="p">,</span>		<span class="cm">/* rv200 */</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* rs200 */</span>
	<span class="mh">0x00000000</span><span class="p">,</span>		<span class="cm">/* r200  */</span>
	<span class="mh">0x00770000</span><span class="p">,</span>		<span class="cm">/* rv250 */</span>
	<span class="mh">0x00290000</span><span class="p">,</span>		<span class="cm">/* rs300 */</span>
	<span class="mh">0x00560000</span><span class="p">,</span>		<span class="cm">/* rv280 */</span>
	<span class="mh">0x00780000</span><span class="p">,</span>		<span class="cm">/* r300  */</span>
	<span class="mh">0x00770000</span><span class="p">,</span>		<span class="cm">/* r350  */</span>
	<span class="mh">0x00780000</span><span class="p">,</span>		<span class="cm">/* rv350 */</span>
	<span class="mh">0x00780000</span><span class="p">,</span>		<span class="cm">/* rv380 */</span>
	<span class="mh">0x01080000</span><span class="p">,</span>		<span class="cm">/* r420  */</span>
	<span class="mh">0x01080000</span><span class="p">,</span>		<span class="cm">/* r423  */</span>
	<span class="mh">0x01080000</span><span class="p">,</span>		<span class="cm">/* rv410 */</span>
	<span class="mh">0x00780000</span><span class="p">,</span>		<span class="cm">/* rs400 */</span>
	<span class="mh">0x00780000</span><span class="p">,</span>		<span class="cm">/* rs480 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_legacy_get_tv_dac_info_from_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span> <span class="o">*</span><span class="n">tv_dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span> <span class="n">default_tvdac_adj</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_MOBILITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RV250</span><span class="p">))</span>
		<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span> <span class="mh">0x00880000</span><span class="p">;</span>
	<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">pal_tvdac_adj</span> <span class="o">=</span> <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">;</span>
	<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ntsc_tvdac_adj</span> <span class="o">=</span> <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span> <span class="o">*</span><span class="nf">radeon_combios_get_tv_dac_info</span><span class="p">(</span><span class="k">struct</span>
							     <span class="n">radeon_encoder</span>
							     <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">dac_info</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">rev</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">dac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span> <span class="o">*</span><span class="n">tv_dac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tv_dac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_tv_dac</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_dac</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* first check TV table */</span>
	<span class="n">dac_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_TV_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dac_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">pal_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ntsc_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="cm">/* if the values are all zeros, use the table */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">)</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">pal_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

			<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ntsc_tvdac_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="cm">/* if the values are all zeros, use the table */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">)</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">tv_std</span> <span class="o">=</span> <span class="n">radeon_combios_get_tv_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* then check CRT table */</span>
		<span class="n">dac_info</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_CRT_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
				<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">pal_tvdac_adj</span> <span class="o">=</span> <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">;</span>
				<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ntsc_tvdac_adj</span> <span class="o">=</span> <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">;</span>
				<span class="cm">/* if the values are all zeros, use the table */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">)</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">dac</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">dac_info</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">bg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dac</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
				<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">pal_tvdac_adj</span> <span class="o">=</span> <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">;</span>
				<span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ntsc_tvdac_adj</span> <span class="o">=</span> <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">;</span>
				<span class="cm">/* if the values are all zeros, use the table */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">ps2_tvdac_adj</span><span class="p">)</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;No TV DAC info found in BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="cm">/* fallback to defaults */</span>
		<span class="n">radeon_legacy_get_tv_dac_info_from_table</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tv_dac</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tv_dac</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_encoder_lvds</span> <span class="o">*</span><span class="nf">radeon_legacy_get_lvds_info_from_regs</span><span class="p">(</span><span class="k">struct</span>
									 <span class="n">radeon_device</span>
									 <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_lvds</span> <span class="o">*</span><span class="n">lvds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fp_vert_stretch</span><span class="p">,</span> <span class="n">fp_horz_stretch</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ppll_div_sel</span><span class="p">,</span> <span class="n">ppll_val</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">lvds_ss_gen_cntl</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_LVDS_SS_GEN_CNTL</span><span class="p">);</span>

	<span class="n">lvds</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_lvds</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lvds</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fp_vert_stretch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_FP_VERT_STRETCH</span><span class="p">);</span>
	<span class="n">fp_horz_stretch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_FP_HORZ_STRETCH</span><span class="p">);</span>

	<span class="cm">/* These should be fail-safe defaults, fingers crossed */</span>
	<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_pwr_delay</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_vcc_delay</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>

	<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_LVDS_GEN_CNTL</span><span class="p">);</span>
	<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_digon_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">lvds_ss_gen_cntl</span> <span class="o">&gt;&gt;</span> <span class="n">RADEON_LVDS_PWRSEQ_DELAY1_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_blon_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">lvds_ss_gen_cntl</span> <span class="o">&gt;&gt;</span> <span class="n">RADEON_LVDS_PWRSEQ_DELAY2_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp_vert_stretch</span> <span class="o">&amp;</span> <span class="n">RADEON_VERT_STRETCH_ENABLE</span><span class="p">)</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">fp_vert_stretch</span> <span class="o">&amp;</span> <span class="n">RADEON_VERT_PANEL_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		     <span class="n">RADEON_VERT_PANEL_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_CRTC_V_TOTAL_DISP</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp_horz_stretch</span> <span class="o">&amp;</span> <span class="n">RADEON_HORZ_STRETCH_ENABLE</span><span class="p">)</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">=</span>
		    <span class="p">(((</span><span class="n">fp_horz_stretch</span> <span class="o">&amp;</span> <span class="n">RADEON_HORZ_PANEL_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		      <span class="n">RADEON_HORZ_PANEL_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_CRTC_H_TOTAL_DISP</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">&lt;</span> <span class="mi">640</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">&lt;</span> <span class="mi">480</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ppll_div_sel</span> <span class="o">=</span> <span class="n">RREG8</span><span class="p">(</span><span class="n">RADEON_CLOCK_CNTL_INDEX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">ppll_val</span> <span class="o">=</span> <span class="n">RREG32_PLL</span><span class="p">(</span><span class="n">RADEON_PPLL_DIV_0</span> <span class="o">+</span> <span class="n">ppll_div_sel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ppll_val</span> <span class="o">&amp;</span> <span class="mh">0x000707ff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1bb</span><span class="p">)</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">use_bios_dividers</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_ref_divider</span> <span class="o">=</span>
		    <span class="n">RREG32_PLL</span><span class="p">(</span><span class="n">RADEON_PPLL_REF_DIV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_post_divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppll_val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_fb_divider</span> <span class="o">=</span> <span class="n">ppll_val</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_ref_divider</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_fb_divider</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">use_bios_dividers</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_vcc_delay</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Panel info derived from registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Panel Size %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">,</span>
		 <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lvds</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">radeon_encoder_lvds</span> <span class="o">*</span><span class="nf">radeon_combios_get_lvds_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span>
							 <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">lcd_info</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">panel_setup</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">stmp</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_lvds</span> <span class="o">*</span><span class="n">lvds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lcd_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_LCD_INFO_TABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lvds</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_lvds</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lvds</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stmp</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Panel ID String: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stmp</span><span class="p">);</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x19</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x1b</span><span class="p">);</span>

		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Panel Size %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">,</span>
			 <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span><span class="p">);</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_vcc_delay</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_vcc_delay</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_vcc_delay</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_pwr_delay</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_digon_delay</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_blon_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_ref_divider</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x2e</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_post_divider</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_fb_divider</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x31</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_ref_divider</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">panel_fb_divider</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">use_bios_dividers</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">panel_setup</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mh">0x39</span><span class="p">);</span>
		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">panel_setup</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_PANEL_FORMAT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">panel_setup</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_PANEL_TYPE</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">panel_setup</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_NO_FM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_2_GREY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_4_GREY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">panel_setup</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_FP_POL_LOW</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">panel_setup</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_LP_POL_LOW</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">panel_setup</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_DTM_POL_LOW</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">panel_setup</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="n">RADEON_LVDS_BL_CLK_SEL</span><span class="p">;</span>

		<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">lvds_gen_cntl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">panel_setup</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">lcd_info</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">17</span><span class="p">)</span> <span class="o">-</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">19</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">21</span><span class="p">)</span> <span class="o">-</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">19</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">hsync_start</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">23</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">26</span><span class="p">));</span>
				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">+</span>
					<span class="p">((</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">-</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">26</span><span class="p">));</span>
				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">vsync_start</span> <span class="o">+</span>
					<span class="p">((</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>

				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* set crtc values */</span>
				<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">,</span> <span class="n">CRTC_INTERLACE_HALVE_V</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;No panel info found in BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lvds</span> <span class="o">=</span> <span class="n">radeon_legacy_get_lvds_info_from_regs</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lvds</span><span class="p">)</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">native_mode</span> <span class="o">=</span> <span class="n">lvds</span><span class="o">-&gt;</span><span class="n">native_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lvds</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">radeon_tmds_pll</span> <span class="n">default_tmds_pll</span><span class="p">[</span><span class="n">CHIP_LAST</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{</span><span class="mi">12000</span><span class="p">,</span> <span class="mh">0xa1b</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xa3f</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_R100  */</span>
	<span class="p">{{</span><span class="mi">12000</span><span class="p">,</span> <span class="mh">0xa1b</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xa3f</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV100 */</span>
	<span class="p">{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RS100 */</span>
	<span class="p">{{</span><span class="mi">15000</span><span class="p">,</span> <span class="mh">0xa1b</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xa3f</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV200 */</span>
	<span class="p">{{</span><span class="mi">12000</span><span class="p">,</span> <span class="mh">0xa1b</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xa3f</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RS200 */</span>
	<span class="p">{{</span><span class="mi">15000</span><span class="p">,</span> <span class="mh">0xa1b</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xa3f</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_R200  */</span>
	<span class="p">{{</span><span class="mi">15500</span><span class="p">,</span> <span class="mh">0x81b</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x83f</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV250 */</span>
	<span class="p">{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RS300 */</span>
	<span class="p">{{</span><span class="mi">13000</span><span class="p">,</span> <span class="mh">0x400f4</span><span class="p">},</span> <span class="p">{</span><span class="mi">15000</span><span class="p">,</span> <span class="mh">0x400f7</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x40111</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV280 */</span>
	<span class="p">{{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_R300  */</span>
	<span class="p">{{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_R350  */</span>
	<span class="p">{{</span><span class="mi">15000</span><span class="p">,</span> <span class="mh">0xb0155</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV350 */</span>
	<span class="p">{{</span><span class="mi">15000</span><span class="p">,</span> <span class="mh">0xb0155</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV380 */</span>
	<span class="p">{{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_R420  */</span>
	<span class="p">{{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_R423  */</span>
	<span class="p">{{</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xb01cb</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>	<span class="cm">/* CHIP_RV410 */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>	<span class="cm">/* CHIP_RS400 */</span>
	<span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>	<span class="cm">/* CHIP_RS480 */</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">radeon_legacy_get_tmds_info_from_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">radeon_encoder_int_tmds</span> <span class="o">*</span><span class="n">tmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
			<span class="n">default_tmds_pll</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="n">default_tmds_pll</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_legacy_get_tmds_info_from_combios</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">radeon_encoder_int_tmds</span> <span class="o">*</span><span class="n">tmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tmds_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ver</span><span class="p">;</span>

	<span class="n">tmds_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_DFP_INFO_TABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmds_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ver</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">tmds_info</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP table revision: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">tmds_info</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
				    <span class="n">RBIOS32</span><span class="p">(</span><span class="n">tmds_info</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
				<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
				    <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmds_info</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TMDS PLL From COMBIOS %u %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">,</span>
					  <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">tmds_info</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
				    <span class="n">RBIOS32</span><span class="p">(</span><span class="n">tmds_info</span> <span class="o">+</span> <span class="n">stride</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
				<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
				    <span class="n">RBIOS16</span><span class="p">(</span><span class="n">tmds_info</span> <span class="o">+</span> <span class="n">stride</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">stride</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">stride</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TMDS PLL From COMBIOS %u %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">,</span>
					  <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">tmds_pll</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;No TMDS info found in BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_legacy_get_ext_tmds_info_from_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">radeon_encoder_ext_tmds</span> <span class="o">*</span><span class="n">tmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c_bus</span><span class="p">;</span>

	<span class="cm">/* default for macs */</span>
	<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>

	<span class="cm">/* XXX some macs have duallink chips */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_POWERBOOK_EXTERNAL</span>:
	<span class="k">case</span> <span class="n">CT_MINI_EXTERNAL</span>:
	<span class="nl">default:</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">dvo_chip</span> <span class="o">=</span> <span class="n">DVO_SIL164</span><span class="p">;</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 7 bit addressing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_legacy_get_ext_tmds_info_from_combios</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">radeon_encoder_ext_tmds</span> <span class="o">*</span><span class="n">tmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ver</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_combios_ddc</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c_bus</span><span class="p">;</span>

	<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">dvo_chip</span> <span class="o">=</span> <span class="n">DVO_SIL164</span><span class="p">;</span>
		<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 7 bit addressing */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_EXT_TMDS_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ver</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;External TMDS Table revision: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 7 bit addressing */</span>
			<span class="n">gpio</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">==</span> <span class="n">DDC_LCD</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* MM i2c */</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">mm_i2c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">i2c_id</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;No valid Ext TMDS info found in BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_get_legacy_connector_info_from_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">ddc_i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="n">hpd</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">radeon_connector_table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">==</span> <span class="n">CT_NONE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,3&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* powerbook with VGA */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_POWERBOOK_VGA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,4&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook3,5&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* powerbook with internal tmds */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_POWERBOOK_INTERNAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,1&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,2&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,3&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,4&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,5&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* powerbook with external single link tmds (sil164) */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_POWERBOOK_EXTERNAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,6&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* powerbook with external dual or single link tmds */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_POWERBOOK_EXTERNAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,7&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,8&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook5,9&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* PowerBook6,2 ? */</span>
			<span class="cm">/* powerbook with external dual link tmds (sil1178?) */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_POWERBOOK_EXTERNAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,1&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,2&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook4,3&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook6,3&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook6,5&quot;</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook6,7&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* ibook */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_IBOOK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac4,4&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* emac */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_EMAC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac10,1&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* mini with internal tmds */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_MINI_INTERNAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac10,2&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* mini with external tmds */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_MINI_EXTERNAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac12,1&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* PowerMac8,1 ? */</span>
			<span class="cm">/* imac g5 isight */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_IMAC_G5_ISIGHT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4a48</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1002</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x4a48</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Mac X800 */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_MAC_X800</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac7,2&quot;</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac7,3&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4150</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1002</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x4150</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Mac G5 tower 9600 */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_MAC_G5_9600</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4c66</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1002</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x4c66</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* SAM440ep RV250 embedded board */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_SAM440EP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_PPC64</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_RN50</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_RN50_POWER</span><span class="p">;</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span> <span class="o">=</span> <span class="n">CT_GENERIC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_GENERIC</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (generic)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* these are the most common settings */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_SINGLE_CRTC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* VGA - primary dac */</span>
			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
									<span class="mi">1</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_MOBILITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* LVDS */</span>
			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_NONE_DETECTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
									<span class="mi">0</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>

			<span class="cm">/* VGA - primary dac */</span>
			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
									<span class="mi">1</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DVI-I - tv dac, int tmds */</span>
			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
									<span class="mi">0</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
									<span class="mi">2</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span> <span class="o">|</span>
						    <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>

			<span class="cm">/* VGA - primary dac */</span>
			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
									<span class="mi">1</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">CHIP_R100</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">CHIP_R200</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TV - tv dac */</span>
			<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
									<span class="mi">2</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_IBOOK</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (ibook)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* LVDS */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* VGA - TV DAC */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_POWERBOOK_EXTERNAL</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (powerbook external tmds)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* LVDS */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* DVI-I - primary dac, ext tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="cm">/* XXX some are SL */</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_POWERBOOK_INTERNAL</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (powerbook internal tmds)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* LVDS */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* DVI-I - primary dac, int tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_POWERBOOK_VGA</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (powerbook vga)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* LVDS */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* VGA - primary dac */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_MINI_EXTERNAL</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (mini external tmds)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* DVI-I - tv dac, ext tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_CRT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="cm">/* XXX are any DL? */</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_MINI_INTERNAL</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (mini internal tmds)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* DVI-I - tv dac, int tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_CRT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_IMAC_G5_ISIGHT</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (imac g5 isight)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* DVI-D - int tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* VGA - tv dac */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_EMAC</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (emac)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* VGA - primary dac */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* VGA - tv dac */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_CRT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_RN50_POWER</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (rn50-power)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* VGA - primary dac */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_CRT2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_MAC_X800</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (mac x800)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* DVI - primary dac, internal tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								  <span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								  <span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* DVI - tv dac, dvo */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">,</span>
								  <span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								  <span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_MAC_G5_9600</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (mac g5 9600)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* DVI - tv dac, dvo */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">,</span>
								  <span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								  <span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* ADC - primary dac, internal tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								  <span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								  <span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_SAM440EP</span>:
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector Table: %d (SAM440ep embedded board)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="cm">/* LVDS */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_NONE_DETECTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* DVI-I - secondary dac, int tmds */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span> <span class="cm">/* ??? */</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span> <span class="o">|</span>
					    <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* VGA - primary dac */</span>
		<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
					    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="cm">/* TV - TV DAC */</span>
		<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
		<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								<span class="mi">2</span><span class="p">),</span>
					  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
		<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
					    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
					    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Connector table: %d (invalid)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">connector_table</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radeon_link_encoder_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_apply_legacy_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">bios_index</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">radeon_combios_connector</span>
				       <span class="o">*</span><span class="n">legacy_connector</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="o">*</span><span class="n">ddc_i2c</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="o">*</span><span class="n">hpd</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Certain IBM chipset RN50s have a BIOS reporting two VGAs,</span>
<span class="cm">	   one with VGA DDC and one with CRT2 DDC. - kill the CRT2 DDC one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x515e</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1014</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">legacy_connector</span> <span class="o">==</span> <span class="n">CONNECTOR_CRT_LEGACY</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ddc_i2c</span><span class="o">-&gt;</span><span class="n">mask_clk_reg</span> <span class="o">==</span> <span class="n">RADEON_GPIO_CRT2_DDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* X300 card with extra non-existent DVI port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5B60</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x17af</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x201e</span> <span class="o">&amp;&amp;</span> <span class="n">bios_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">legacy_connector</span> <span class="o">==</span> <span class="n">CONNECTOR_DVI_I_LEGACY</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_apply_legacy_tv_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Acer 5102 has non-existent TV port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5975</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1025</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x009f</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* HP dc5750 has non-existent TV port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5974</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x103c</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x280a</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* MSI S270 has non-existent TV port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5955</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1462</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0131</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">combios_check_dl_dvi</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_dvi_d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ext_tmds_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_dvi_d</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext_tmds_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_EXT_TMDS_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_tmds_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">ext_tmds_info</span><span class="p">);</span>
		<span class="kt">uint8_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">ext_tmds_info</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_dvi_d</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_dvi_d</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dvi_d</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_get_legacy_connector_info_from_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">conn_info</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">devices</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">connector_object_id</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_combios_ddc</span> <span class="n">ddc_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_combios_connector</span> <span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">ddc_i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_hpd</span> <span class="n">hpd</span><span class="p">;</span>

	<span class="n">conn_info</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_CONNECTOR_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">conn_info</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

			<span class="n">connector</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="n">ddc_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ddc_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CONNECTOR_PROPRIETARY_LEGACY</span>:
			<span class="k">case</span> <span class="n">CONNECTOR_DVI_I_LEGACY</span>:
			<span class="k">case</span> <span class="n">CONNECTOR_DVI_D_LEGACY</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
					<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_apply_legacy_quirks</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hpd</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CONNECTOR_PROPRIETARY_LEGACY</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
					<span class="n">devices</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">devices</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">;</span>
				<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">radeon_get_encoder_enum</span>
							  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
							  <span class="n">devices</span><span class="p">);</span>
				<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span>
							    <span class="n">legacy_connector_convert</span>
							    <span class="p">[</span><span class="n">connector</span><span class="p">],</span>
							    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
							    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONNECTOR_CRT_LEGACY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								   <span class="mi">2</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								   <span class="mi">1</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							    <span class="n">i</span><span class="p">,</span>
							    <span class="n">devices</span><span class="p">,</span>
							    <span class="n">legacy_connector_convert</span>
							    <span class="p">[</span><span class="n">connector</span><span class="p">],</span>
							    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
							    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONNECTOR_DVI_I_LEGACY</span>:
				<span class="n">devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">|=</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">,</span>
								   <span class="mi">2</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">|=</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
								   <span class="mi">1</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">|=</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">,</span>
								   <span class="mi">0</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">);</span>
					<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">combios_check_dl_dvi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">|=</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
								   <span class="mi">0</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>
					<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							    <span class="n">i</span><span class="p">,</span>
							    <span class="n">devices</span><span class="p">,</span>
							    <span class="n">legacy_connector_convert</span>
							    <span class="p">[</span><span class="n">connector</span><span class="p">],</span>
							    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
							    <span class="n">connector_object_id</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONNECTOR_DVI_D_LEGACY</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">;</span>
					<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">combios_check_dl_dvi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devices</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">;</span>
					<span class="n">connector_object_id</span> <span class="o">=</span> <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">radeon_get_encoder_enum</span>
							  <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
							  <span class="n">devices</span><span class="p">);</span>
				<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span>
							    <span class="n">legacy_connector_convert</span>
							    <span class="p">[</span><span class="n">connector</span><span class="p">],</span>
							    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
							    <span class="n">connector_object_id</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONNECTOR_CTV_LEGACY</span>:
			<span class="k">case</span> <span class="n">CONNECTOR_STV_LEGACY</span>:
				<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">radeon_get_encoder_enum</span>
							  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
							   <span class="mi">2</span><span class="p">),</span>
							  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
				<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
							    <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
							    <span class="n">legacy_connector_convert</span>
							    <span class="p">[</span><span class="n">connector</span><span class="p">],</span>
							    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
							    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown connector type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">connector</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">tmds_info</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_DFP_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmds_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Found DFP table, assuming DVI connector</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
									<span class="mi">1</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
									<span class="mi">0</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">);</span>

			<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_DVI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_1</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span> <span class="o">|</span>
						    <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">uint16_t</span> <span class="n">crt_info</span> <span class="o">=</span>
				<span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_CRT_INFO_TABLE</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Found CRT table, assuming VGA connector</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crt_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
										<span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
										<span class="mi">1</span><span class="p">),</span>
							  <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
				<span class="n">ddc_i2c</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_VGA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
				<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							    <span class="mi">0</span><span class="p">,</span>
							    <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">,</span>
							    <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
							    <span class="n">CONNECTOR_OBJECT_ID_VGA</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;No connector info found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_MOBILITY</span> <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">lcd_info</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_LCD_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint16_t</span> <span class="n">lcd_ddc_info</span> <span class="o">=</span>
			    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="n">COMBIOS_LCD_DDC_INFO_TABLE</span><span class="p">);</span>

			<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">radeon_get_encoder_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
									<span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
									<span class="mi">0</span><span class="p">),</span>
						  <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lcd_ddc_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ddc_type</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">lcd_ddc_info</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ddc_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">DDC_LCD</span>:
					<span class="n">ddc_i2c</span> <span class="o">=</span>
						<span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
								      <span class="n">DDC_LCD</span><span class="p">,</span>
								      <span class="n">RBIOS32</span><span class="p">(</span><span class="n">lcd_ddc_info</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span>
								      <span class="n">RBIOS32</span><span class="p">(</span><span class="n">lcd_ddc_info</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>
					<span class="n">radeon_i2c_add</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span> <span class="s">&quot;LCD&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">DDC_GPIO</span>:
					<span class="n">ddc_i2c</span> <span class="o">=</span>
						<span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
								      <span class="n">DDC_GPIO</span><span class="p">,</span>
								      <span class="n">RBIOS32</span><span class="p">(</span><span class="n">lcd_ddc_info</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span>
								      <span class="n">RBIOS32</span><span class="p">(</span><span class="n">lcd_ddc_info</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>
					<span class="n">radeon_i2c_add</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span> <span class="s">&quot;LCD&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">ddc_i2c</span> <span class="o">=</span>
						<span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ddc_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LCD DDC Info Table found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
			<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mi">5</span><span class="p">,</span>
						    <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">,</span>
						    <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
						    <span class="n">CONNECTOR_OBJECT_ID_LVDS</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check TV table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">CHIP_R100</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">CHIP_R200</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">tv_info</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_TV_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">tv_info</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_apply_legacy_tv_quirks</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
					<span class="n">ddc_i2c</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">radeon_add_legacy_encoder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">radeon_get_encoder_enum</span>
								  <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								   <span class="mi">2</span><span class="p">),</span>
								  <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
					<span class="n">radeon_add_legacy_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
								    <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">,</span>
								    <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span>
								    <span class="o">&amp;</span><span class="n">ddc_i2c</span><span class="p">,</span>
								    <span class="n">CONNECTOR_OBJECT_ID_SVIDEO</span><span class="p">,</span>
								    <span class="o">&amp;</span><span class="n">hpd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">radeon_link_encoder_connector</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">thermal_controller_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;lm63&quot;</span><span class="p">,</span>
	<span class="s">&quot;adm1032&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">radeon_combios_get_power_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">misc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_i2c_bus_rec</span> <span class="n">i2c_bus</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* allocate 2 power states */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_power_state</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate 1 clock mode per state */</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_pm_clock_info</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_pm_clock_info</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">clock_info</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">pm_failed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">pm_failed</span><span class="p">;</span>

	<span class="cm">/* check for a thermal chip */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_OVERDRIVE_INFO_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">thermal_controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i2c_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clk_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thermal_controller</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">gpio</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thermal_controller</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">gpio</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thermal_controller</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">gpio</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">clk_bit</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0xa</span><span class="p">);</span>
			<span class="n">data_bit</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0xb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">thermal_controller</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">thermal_controller</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Possible %s thermal controller at 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">thermal_controller_names</span><span class="p">[</span><span class="n">thermal_controller</span><span class="p">],</span>
				 <span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">==</span> <span class="n">DDC_LCD</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* MM i2c */</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">hw_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">mm_i2c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">i2c_bus</span><span class="p">.</span><span class="n">i2c_id</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">==</span> <span class="n">DDC_GPIO</span><span class="p">)</span>
				<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk_bit</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">data_bit</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">thermal_controller_names</span><span class="p">[</span><span class="n">thermal_controller</span><span class="p">];</span>
				<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
				<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* boards with a thermal chip, but no overdrive table */</span>

		<span class="cm">/* Asus 9600xt has an f75375 on the monid bus */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4152</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1043</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0xc002</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">combios_setup_i2c_bus</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">DDC_MONID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span> <span class="o">=</span> <span class="n">radeon_i2c_lookup</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_bus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;f75375&quot;</span><span class="p">;</span>
				<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
				<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">i2c_bus</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
				<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Possible %s thermal controller at 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_MOBILITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_POWERPLAY_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">blocks</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="cm">/* power mode 0 tends to be the only valid one */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">default_mode</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">POWER_STATE_TYPE_BATTERY</span><span class="p">;</span>
			<span class="n">misc</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">misc2</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">misc2</span> <span class="o">=</span> <span class="n">misc2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VOLTAGE_GPIO</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">active_high</span> <span class="o">=</span>
						<span class="nb">false</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span>
						<span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0xb</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0xb</span><span class="p">);</span>
					<span class="n">u16</span> <span class="n">voltage_table_offset</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&amp;&amp;</span> <span class="n">voltage_table_offset</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span>
							<span class="n">RBIOS16</span><span class="p">(</span><span class="n">voltage_table_offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">voltage_table_offset</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">switch</span> <span class="p">((</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="mh">0x700</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
				<span class="nl">default:</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>:
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>:
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">132</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VOLTAGE_NONE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span>
					<span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x5</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RADEON_PM_STATE_SINGLE_DISPLAY_ONLY</span><span class="p">;</span>
			<span class="n">state_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* XXX figure out some good default low power mode for mobility cards w/out power tables */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* XXX figure out some good default low power mode for desktop cards */</span>
	<span class="p">}</span>

<span class="nl">default_mode:</span>
	<span class="cm">/* add the default mode */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span>
		<span class="n">POWER_STATE_TYPE_DEFAULT</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">num_clock_modes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_mclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sclk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">default_sclk</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">default_clock_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">VOLTAGE_GPIO</span><span class="p">))</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span> <span class="o">=</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">clock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">voltage</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VOLTAGE_NONE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">pcie_lanes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">power_state</span><span class="p">[</span><span class="n">state_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span> <span class="o">=</span> <span class="n">state_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">pm_failed:</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span> <span class="o">=</span> <span class="n">state_index</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">num_power_states</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_power_state_index</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">default_power_state_index</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">.</span><span class="n">current_clock_mode_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_external_tmds_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_ext_tmds</span> <span class="o">*</span><span class="n">tmds</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmds</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">dvo_chip</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVO_SIL164</span>:
		<span class="cm">/* sil 164 */</span>
		<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
				    <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
				    <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
				       <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
				       <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
				    <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
				    <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
				    <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
				    <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
		<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
				       <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
				       <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVO_SIL1178</span>:
		<span class="cm">/* sil 1178 - untested */</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0x0f, 0x44</span>
<span class="cm">		 * 0x0f, 0x4c</span>
<span class="cm">		 * 0x0e, 0x01</span>
<span class="cm">		 * 0x0a, 0x80</span>
<span class="cm">		 * 0x09, 0x30</span>
<span class="cm">		 * 0x0c, 0xc9</span>
<span class="cm">		 * 0x0d, 0x70</span>
<span class="cm">		 * 0x08, 0x32</span>
<span class="cm">		 * 0x08, 0x33</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="n">bool</span> <span class="nf">radeon_combios_external_tmds_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">slave_addr</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">and_mask</span><span class="p">,</span> <span class="n">or_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_ext_tmds</span> <span class="o">*</span><span class="n">tmds</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmds</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_TMDS_POWER_ON_TABLE</span><span class="p">);</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">blocks</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">id</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mi">0</span>:
						<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">2</span>:
						<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">and_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">val</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
						<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">and_mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">or_mask</span><span class="p">;</span>
						<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">3</span>:
						<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="n">udelay</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">4</span>:
						<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="n">mdelay</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">6</span>:
						<span class="n">slave_addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
						<span class="n">slave_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 7 bit addressing */</span>
						<span class="n">index</span><span class="o">++</span><span class="p">;</span>
						<span class="n">reg</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span><span class="o">++</span><span class="p">;</span>
						<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
						<span class="n">index</span><span class="o">++</span><span class="p">;</span>
						<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
								    <span class="n">slave_addr</span><span class="p">,</span>
								    <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">blocks</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_EXT_TMDS_INFO_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">and_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
					<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">and_mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">or_mask</span><span class="p">;</span>
					<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">udelay</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">5</span>:
					<span class="n">reg</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
					<span class="n">and_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">RREG32_PLL</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
					<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">and_mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">or_mask</span><span class="p">;</span>
					<span class="n">WREG32_PLL</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">6</span>:
					<span class="n">reg</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
					<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">radeon_i2c_put_byte</span><span class="p">(</span><span class="n">tmds</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">,</span>
							    <span class="n">tmds</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
							    <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">combios_parse_mmio_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">uint16_t</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">((</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
			<span class="kt">uint32_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>
			<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">,</span> <span class="n">and_mask</span><span class="p">,</span> <span class="n">or_mask</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">and_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">and_mask</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">or_mask</span><span class="p">;</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">and_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">and_mask</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">or_mask</span><span class="p">;</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">8</span>:
					<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
						    <span class="p">(</span><span class="n">RREG32_PLL</span>
						     <span class="p">(</span><span class="n">RADEON_CLK_PWRMGT_CNTL</span><span class="p">)</span> <span class="o">&amp;</span>
						     <span class="n">RADEON_MC_BUSY</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">9</span>:
					<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
						     <span class="n">RADEON_MC_IDLE</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">combios_parse_pll_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">((</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="kt">uint8_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">and_mask</span><span class="p">,</span> <span class="n">or_mask</span><span class="p">;</span>

			<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">WREG32_PLL</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">shift</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
				<span class="n">and_mask</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
				<span class="n">and_mask</span> <span class="o">|=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
				<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
				<span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
				<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG32_PLL</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">and_mask</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">or_mask</span><span class="p">;</span>
				<span class="n">WREG32_PLL</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>:
					<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
						    <span class="p">(</span><span class="n">RREG32_PLL</span>
						     <span class="p">(</span><span class="n">RADEON_CLK_PWRMGT_CNTL</span><span class="p">)</span> <span class="o">&amp;</span>
						     <span class="n">RADEON_MC_BUSY</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>:
					<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">RREG32_PLL</span>
						    <span class="p">(</span><span class="n">RADEON_CLK_PWRMGT_CNTL</span><span class="p">)</span> <span class="o">&amp;</span>
						    <span class="n">RADEON_DLL_READY</span><span class="p">)</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">5</span>:
					<span class="n">tmp</span> <span class="o">=</span>
					    <span class="n">RREG32_PLL</span><span class="p">(</span><span class="n">RADEON_CLK_PWRMGT_CNTL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RADEON_CG_NO1_DEBUG_0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">						uint32_t mclk_cntl =</span>
<span class="c">						    RREG32_PLL</span>
<span class="c">						    (RADEON_MCLK_CNTL);</span>
<span class="c">						mclk_cntl &amp;= 0xffff0000;</span>
<span class="c">						/*mclk_cntl |= 0x00001111;*//* ??? */</span>
<span class="c">						WREG32_PLL(RADEON_MCLK_CNTL,</span>
<span class="c">							   mclk_cntl);</span>
<span class="c">						mdelay(10);</span>
<span class="cp">#endif</span>
						<span class="n">WREG32_PLL</span>
						    <span class="p">(</span><span class="n">RADEON_CLK_PWRMGT_CNTL</span><span class="p">,</span>
						     <span class="n">tmp</span> <span class="o">&amp;</span>
						     <span class="o">~</span><span class="n">RADEON_CG_NO1_DEBUG_0</span><span class="p">);</span>
						<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">combios_parse_ram_reset_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">uint32_t</span> <span class="n">channel_complete_mask</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_R300</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
					<span class="n">channel_complete_mask</span> <span class="o">=</span>
					    <span class="n">R300_MEM_PWRUP_COMPLETE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">channel_complete_mask</span> <span class="o">=</span>
					    <span class="n">RADEON_MEM_PWRUP_COMPLETE</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MEM_STR_CNTL</span><span class="p">)</span> <span class="o">&amp;</span>
					     <span class="n">channel_complete_mask</span><span class="p">)</span> <span class="o">==</span>
					    <span class="n">channel_complete_mask</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">uint32_t</span> <span class="n">or_mask</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MEM_SDRAM_MODE_REG</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">RADEON_SDRAM_MODE_MASK</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">or_mask</span><span class="p">;</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

				<span class="n">or_mask</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MEM_SDRAM_MODE_REG</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">RADEON_B3MEM_RESET_MASK</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">or_mask</span><span class="p">;</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MEM_SDRAM_MODE_REG</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">combios_detect_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ram</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">mem_addr_mapping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mem_cntl</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mem_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mem_cntl</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MEM_CNTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_cntl</span> <span class="o">&amp;</span> <span class="n">RV100_HALF_MODE</span><span class="p">)</span>
		<span class="n">ram</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">ram</span><span class="p">;</span>
	<span class="n">mem_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mem_cntl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mem_addr_mapping</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MEM_CNTL</span><span class="p">,</span> <span class="n">mem_cntl</span><span class="p">);</span>
	<span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MEM_CNTL</span><span class="p">);</span>

	<span class="cm">/* sdram reset ? */</span>

	<span class="cm">/* something like this????  */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ram</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ram</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="cm">/* write to each page */</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MM_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">RADEON_MM_APER</span><span class="p">);</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MM_DATA</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">);</span>
		<span class="cm">/* read back and verify */</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MM_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">RADEON_MM_APER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_MM_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mem_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">combios_write_ram_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mem_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mem_cntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* should do something smarter here I guess... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* first check detected mem table */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_DETECTED_MEM_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem_cntl</span> <span class="o">=</span> <span class="n">RBIOS32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mem_size</span> <span class="o">=</span> <span class="n">RBIOS16</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_R200</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">ASIC_IS_RN50</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_MEM_CNTL</span><span class="p">,</span> <span class="n">mem_cntl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_MEM_CONFIG_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_R200</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ASIC_IS_RN50</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">ram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="kt">int</span> <span class="n">mem_addr_mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">while</span> <span class="p">(</span><span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">ram</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
						<span class="n">mem_addr_mapping</span> <span class="o">=</span>
						    <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">mem_addr_mapping</span> <span class="o">!=</span> <span class="mh">0x25</span><span class="p">)</span>
							<span class="n">ram</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="n">mem_size</span> <span class="o">=</span>
						    <span class="n">combios_detect_ram</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram</span><span class="p">,</span>
								       <span class="n">mem_addr_mapping</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">mem_size</span><span class="p">)</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">mem_size</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mem_size</span> <span class="o">=</span> <span class="n">RBIOS8</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">mem_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* convert to MB */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mem_size</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>	<span class="cm">/* convert to bytes */</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_CONFIG_MEMSIZE</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_combios_dyn_clk_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">dyn_clk_info</span> <span class="o">=</span>
	    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_DYN_CLK_1_TABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dyn_clk_info</span><span class="p">)</span>
		<span class="n">combios_parse_pll_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dyn_clk_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_combios_asic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">table</span><span class="p">;</span>

	<span class="cm">/* port hardcoded mac stuff from radeonfb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* ASIC INIT 1 */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_ASIC_INIT_1_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
		<span class="n">combios_parse_mmio_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="cm">/* PLL INIT */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_PLL_INIT_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
		<span class="n">combios_parse_pll_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="cm">/* ASIC INIT 2 */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_ASIC_INIT_2_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
		<span class="n">combios_parse_mmio_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ASIC INIT 4 */</span>
		<span class="n">table</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_ASIC_INIT_4_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
			<span class="n">combios_parse_mmio_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

		<span class="cm">/* RAM RESET */</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_RAM_RESET_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
			<span class="n">combios_parse_ram_reset_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

		<span class="cm">/* ASIC INIT 3 */</span>
		<span class="n">table</span> <span class="o">=</span>
		    <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_ASIC_INIT_3_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
			<span class="n">combios_parse_mmio_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

		<span class="cm">/* write CONFIG_MEMSIZE */</span>
		<span class="n">combios_write_ram_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* quirk for rs4xx HP nx6125 laptop to make it resume</span>
<span class="cm">	 * - it hangs on resume inside the dynclk 1 table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS480</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x103c</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x308b</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* quirk for rs4xx HP dv5000 laptop to make it resume</span>
<span class="cm">	 * - it hangs on resume inside the dynclk 1 table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS480</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x103c</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x30a4</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* quirk for rs4xx Compaq Presario V5245EU laptop to make it resume</span>
<span class="cm">	 * - it hangs on resume inside the dynclk 1 table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RS480</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x103c</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x30ae</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* DYN CLK 1 */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="n">combios_get_table_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">COMBIOS_DYN_CLK_1_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
		<span class="n">combios_parse_pll_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_combios_initialize_bios_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bios_0_scratch</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">,</span> <span class="n">bios_7_scratch</span><span class="p">;</span>

	<span class="n">bios_0_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">);</span>
	<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">);</span>
	<span class="n">bios_7_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_7_SCRATCH</span><span class="p">);</span>

	<span class="cm">/* let the bios control the backlight */</span>
	<span class="n">bios_0_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DRIVER_BRIGHTNESS_EN</span><span class="p">;</span>

	<span class="cm">/* tell the bios not to handle mode switching */</span>
	<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RADEON_DISPLAY_SWITCHING_DIS</span> <span class="o">|</span>
			   <span class="n">RADEON_ACC_MODE_CHANGE</span><span class="p">);</span>

	<span class="cm">/* tell the bios a driver is loaded */</span>
	<span class="n">bios_7_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DRV_LOADED</span><span class="p">;</span>

	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">,</span> <span class="n">bios_0_scratch</span><span class="p">);</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_7_SCRATCH</span><span class="p">,</span> <span class="n">bios_7_scratch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_combios_output_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="n">bool</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bios_6_scratch</span><span class="p">;</span>

	<span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DRIVER_CRITICAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DRIVER_CRITICAL</span><span class="p">;</span>

	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_combios_connected_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">connected</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span>
	    <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_4_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_4_SCRATCH</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_5_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_5_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TV1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* fix me */</span>
			<span class="n">bios_4_scratch</span> <span class="o">|=</span> <span class="n">RADEON_TV1_ATTACHED_SVIDEO</span><span class="p">;</span>
			<span class="cm">/*save-&gt;bios_4_scratch |= RADEON_TV1_ATTACHED_COMP; */</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_TV1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_ACC_REQ_TV1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TV1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_TV1_ATTACHED_MASK</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_TV1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_ACC_REQ_TV1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LCD1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">|=</span> <span class="n">RADEON_LCD1_ATTACHED</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_LCD1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_ACC_REQ_LCD1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LCD1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_LCD1_ATTACHED</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_LCD1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_ACC_REQ_LCD1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">|=</span> <span class="n">RADEON_CRT1_ATTACHED_COLOR</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_CRT1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_ACC_REQ_CRT1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT1_ATTACHED_MASK</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_ACC_REQ_CRT1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT2 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">|=</span> <span class="n">RADEON_CRT2_ATTACHED_COLOR</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_CRT2_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_ACC_REQ_CRT2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRT2 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT2_ATTACHED_MASK</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT2_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_ACC_REQ_CRT2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP1 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DFP1_ATTACHED</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DFP1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_ACC_REQ_DFP1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP1 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP1_ATTACHED</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP1_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_ACC_REQ_DFP1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP2 connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DFP2_ATTACHED</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DFP2_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="n">RADEON_ACC_REQ_DFP2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DFP2 disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bios_4_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP2_ATTACHED</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP2_ON</span><span class="p">;</span>
			<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_ACC_REQ_DFP2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_4_SCRATCH</span><span class="p">,</span> <span class="n">bios_4_scratch</span><span class="p">);</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_5_SCRATCH</span><span class="p">,</span> <span class="n">bios_5_scratch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_combios_encoder_crtc_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_5_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_5_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_TV1_CRTC_MASK</span><span class="p">;</span>
		<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_TV1_CRTC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT1_CRTC_MASK</span><span class="p">;</span>
		<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_CRT1_CRTC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT2_CRTC_MASK</span><span class="p">;</span>
		<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_CRT2_CRTC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_LCD1_CRTC_MASK</span><span class="p">;</span>
		<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_LCD1_CRTC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP1_CRTC_MASK</span><span class="p">;</span>
		<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_DFP1_CRTC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bios_5_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP2_CRTC_MASK</span><span class="p">;</span>
		<span class="n">bios_5_scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_DFP2_CRTC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_5_SCRATCH</span><span class="p">,</span> <span class="n">bios_5_scratch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_combios_encoder_dpms_scratch_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_6_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">RADEON_TV_DPMS_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_TV_DPMS_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">RADEON_CRT_DPMS_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_CRT_DPMS_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">RADEON_LCD_DPMS_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_LCD_DPMS_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">bios_6_scratch</span> <span class="o">|=</span> <span class="n">RADEON_DFP_DPMS_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bios_6_scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DFP_DPMS_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_6_SCRATCH</span><span class="p">,</span> <span class="n">bios_6_scratch</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
