<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_ring.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_ring.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> * Copyright 2009 Jerome Glisse.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> *          Jerome Glisse</span>
<span class="cm"> *          Christian König</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>
<span class="cp">#include &quot;radeon_reg.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;atom.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * IB.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">radeon_debugfs_sa_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">radeon_ib_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ring</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">radeon_ib</span> <span class="o">*</span><span class="n">ib</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_sa_bo_new</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_tmp_bo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">sa_bo</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get a new IB (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_fence_create</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create fence for new IB (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">radeon_sa_bo_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">sa_bo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">radeon_sa_bo_cpu_addr</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">sa_bo</span><span class="p">);</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">gpu_addr</span> <span class="o">=</span> <span class="n">radeon_sa_bo_gpu_addr</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">sa_bo</span><span class="p">);</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">vm_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">is_const_ib</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">semaphore</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ib_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ib</span> <span class="o">*</span><span class="n">ib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_semaphore_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">);</span>
	<span class="n">radeon_sa_bo_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">sa_bo</span><span class="p">,</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">);</span>
	<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ib_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ib</span> <span class="o">*</span><span class="n">ib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">length_dw</span> <span class="o">||</span> <span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: Nothings in the ib we should report. */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t schedule ib</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 64 dwords should be enough for fence too */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_ring_lock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scheduling IB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">radeon_ring_ib_execute</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">ib</span><span class="p">);</span>
	<span class="n">radeon_fence_emit</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">);</span>
	<span class="n">radeon_ring_unlock_commit</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ib_pool_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ib_pool_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_sa_bo_manager_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_tmp_bo</span><span class="p">,</span>
				      <span class="n">RADEON_IB_POOL_SIZE</span><span class="o">*</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
				      <span class="n">RADEON_GEM_DOMAIN_GTT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ib_pool_ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_debugfs_sa_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register debugfs file for SA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ib_pool_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ib_pool_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_sa_bo_manager_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_tmp_bo</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ib_pool_ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ib_pool_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">radeon_sa_bo_manager_start</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_tmp_bo</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ib_pool_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">radeon_sa_bo_manager_suspend</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_tmp_bo</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ib_ring_tests</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_NUM_RINGS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_ib_test</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* oh, oh, that&#39;s really bad */</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon: failed testing IB on GFX ring (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		                <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">accel_working</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* still not good, but we can live with it */</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon: failed testing IB on ring %d (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ring.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">radeon_debugfs_ring_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">radeon_ring_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if DRM_DEBUG_CODE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">count_dw</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon: writting more dword to ring than expected !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span> <span class="o">&amp;=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_mask</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">count_dw</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ring_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* r1xx-r5xx only has CP ring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">CAYMAN_RING_TYPE_CP1_INDEX</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">CAYMAN_RING_TYPE_CP1_INDEX</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ring</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">CAYMAN_RING_TYPE_CP2_INDEX</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">CAYMAN_RING_TYPE_CP2_INDEX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_free_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">rptr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">.</span><span class="n">wb</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_offs</span><span class="o">/</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">rptr</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_reg</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rptr</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_shift</span><span class="p">;</span>
	<span class="cm">/* This works because ring_size is a power of 2 */</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span> <span class="o">-=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span> <span class="o">&amp;=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">radeon_ring_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ndw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Align requested size with padding so unlock_commit can</span>
<span class="cm">	 * pad safely */</span>
	<span class="n">ndw</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndw</span> <span class="o">+</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">align_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">align_mask</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ndw</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">radeon_ring_free_size</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndw</span> <span class="o">&lt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_fence_wait_next_locked</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">radeon_ring_index</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">count_dw</span> <span class="o">=</span> <span class="n">ndw</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_old</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ring_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ndw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_ring_alloc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">ndw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">count_dw_pad</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We pad to match fetch size */</span>
	<span class="n">count_dw_pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">align_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		       <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">align_mask</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count_dw_pad</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_ring_write</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">nop</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DRM_MEMORYBARRIER</span><span class="p">();</span>
	<span class="n">WREG32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span> <span class="o">&lt;&lt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_mask</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">RREG32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_unlock_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_ring_commit</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_undo</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_old</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_unlock_undo</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_ring_undo</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_force_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">radeon_ring_free_size</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">==</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_ring_alloc</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_ring_write</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">nop</span><span class="p">);</span>
			<span class="n">radeon_ring_commit</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_lockup_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_rptr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_activity</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * radeon_ring_test_lockup() - check if ring is lockedup by recording information</span>
<span class="cm"> * @rdev:       radeon device structure</span>
<span class="cm"> * @ring:       radeon_ring structure holding ring information</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t need to initialize the lockup tracking information as we will either</span>
<span class="cm"> * have CP rptr to a different value of jiffies wrap around which will force</span>
<span class="cm"> * initialization of the lockup tracking informations.</span>
<span class="cm"> *</span>
<span class="cm"> * A possible false positivie is if we get call after while and last_cp_rptr ==</span>
<span class="cm"> * the current CP rptr, even if it&#39;s unlikely it might happen. To avoid this</span>
<span class="cm"> * if the elapsed time since last call is bigger than 2 second than we return</span>
<span class="cm"> * false and update the tracking information. Due to this the caller must call</span>
<span class="cm"> * radeon_ring_test_lockup several time in less than 2sec for lockup to be reported</span>
<span class="cm"> * the fencing code should be cautious about that.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller should write to the ring to force CP to do something so we don&#39;t get</span>
<span class="cm"> * false positive when CP is just gived nothing to do.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="n">bool</span> <span class="nf">radeon_ring_test_lockup</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cjiffies</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rptr</span><span class="p">;</span>

	<span class="n">cjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">cjiffies</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_activity</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* likely a wrap around */</span>
		<span class="n">radeon_ring_lockup_update</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rptr</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_reg</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rptr</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span> <span class="o">!=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_rptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CP is still working no lockup */</span>
		<span class="n">radeon_ring_lockup_update</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">elapsed</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">cjiffies</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_activity</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_lockup_timeout</span> <span class="o">&amp;&amp;</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">radeon_lockup_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPU lockup CP stall for more than %lumsec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* give a chance to the GPU ... */</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_ring_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ring_size</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="n">rptr_offs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rptr_reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">wptr_reg</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">ptr_reg_shift</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ptr_reg_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">=</span> <span class="n">ring_size</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_offs</span> <span class="o">=</span> <span class="n">rptr_offs</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_reg</span> <span class="o">=</span> <span class="n">rptr_reg</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_reg</span> <span class="o">=</span> <span class="n">wptr_reg</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_shift</span> <span class="o">=</span> <span class="n">ptr_reg_shift</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_reg_mask</span> <span class="o">=</span> <span class="n">ptr_reg_mask</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">nop</span> <span class="o">=</span> <span class="n">nop</span><span class="p">;</span>
	<span class="cm">/* Allocate ring buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_create</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				     <span class="n">RADEON_GEM_DOMAIN_GTT</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(%d) ring create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_reserve</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_pin</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">,</span> <span class="n">RADEON_GEM_DOMAIN_GTT</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_bo_unreserve</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(%d) ring pin failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_kmap</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
		<span class="n">radeon_bo_unreserve</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(%d) ring map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_debugfs_ring_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register debugfs file for rings !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ring_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">ring_obj</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
	<span class="n">ring_obj</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_reserve</span><span class="p">(</span><span class="n">ring_obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">radeon_bo_kunmap</span><span class="p">(</span><span class="n">ring_obj</span><span class="p">);</span>
			<span class="n">radeon_bo_unpin</span><span class="p">(</span><span class="n">ring_obj</span><span class="p">);</span>
			<span class="n">radeon_bo_unreserve</span><span class="p">(</span><span class="n">ring_obj</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">radeon_bo_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring_obj</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debugfs info</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_debugfs_ring_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ridx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">info_ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ridx</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">radeon_ring_free_size</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;wptr(0x%04x): 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_reg</span><span class="p">,</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr_reg</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rptr(0x%04x): 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_reg</span><span class="p">,</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr_reg</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;driver&#39;s copy of the wptr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">wptr</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;driver&#39;s copy of the rptr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%u free dwords in ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_free_dw</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%u dwords in ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rptr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;r[%04d]=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ptr_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">radeon_ring_type_gfx_index</span> <span class="o">=</span> <span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cayman_ring_type_cp1_index</span> <span class="o">=</span> <span class="n">CAYMAN_RING_TYPE_CP1_INDEX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cayman_ring_type_cp2_index</span> <span class="o">=</span> <span class="n">CAYMAN_RING_TYPE_CP2_INDEX</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_info_list</span> <span class="n">radeon_debugfs_ring_info_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;radeon_ring_gfx&quot;</span><span class="p">,</span> <span class="n">radeon_debugfs_ring_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_ring_type_gfx_index</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;radeon_ring_cp1&quot;</span><span class="p">,</span> <span class="n">radeon_debugfs_ring_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cayman_ring_type_cp1_index</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;radeon_ring_cp2&quot;</span><span class="p">,</span> <span class="n">radeon_debugfs_ring_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cayman_ring_type_cp2_index</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_debugfs_sa_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">radeon_sa_bo_dump_debug_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring_tmp_bo</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_info_list</span> <span class="n">radeon_debugfs_sa_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="s">&quot;radeon_sa_info&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_debugfs_sa_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">radeon_debugfs_ring_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">radeon_debugfs_ring_info_list</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_debugfs_ring_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ridx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">radeon_debugfs_ring_info_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">r</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ring</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_debugfs_add_files</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_debugfs_sa_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>
	<span class="k">return</span> <span class="n">radeon_debugfs_add_files</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">radeon_debugfs_sa_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
