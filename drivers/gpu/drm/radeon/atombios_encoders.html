<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › atombios_encoders.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>atombios_encoders.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2007-11 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;atom.h&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">atom_debug</span><span class="p">;</span>

<span class="cm">/* evil but including atombios.h is much worse */</span>
<span class="n">bool</span> <span class="n">radeon_atom_get_tv_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">);</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">radeon_encoder_is_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_atom_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* set the active encoder to connector routing */</span>
	<span class="n">radeon_encoder_set_active_device</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* hw bug */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* get the native mode for LVDS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span>
		<span class="n">radeon_panel_mode_fixup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="cm">/* get the native mode for TV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_encoder_atom_dac</span> <span class="o">*</span><span class="n">tv_dac</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv_dac</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">tv_std</span> <span class="o">==</span> <span class="n">TV_STD_NTSC</span> <span class="o">||</span>
			    <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">tv_std</span> <span class="o">==</span> <span class="n">TV_STD_NTSC_J</span> <span class="o">||</span>
			    <span class="n">tv_dac</span><span class="o">-&gt;</span><span class="n">tv_std</span> <span class="o">==</span> <span class="n">TV_STD_PAL_M</span><span class="p">)</span>
				<span class="n">radeon_atom_get_tv_timings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">radeon_atom_get_tv_timings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE3</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">radeon_encoder_get_dp_bridge_encoder_id</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ENCODER_OBJECT_ID_NONE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="n">radeon_dp_set_link_config</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atombios_dac_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">DAC_ENCODER_CONTROL_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dac</span> <span class="o">*</span><span class="n">dac_info</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DAC1EncoderControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DAC2EncoderControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">args</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ucDacStandard</span> <span class="o">=</span> <span class="n">ATOM_DAC1_PS2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ucDacStandard</span> <span class="o">=</span> <span class="n">ATOM_DAC1_CV</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">tv_std</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TV_STD_PAL</span>:
		<span class="k">case</span> <span class="n">TV_STD_PAL_M</span>:
		<span class="k">case</span> <span class="n">TV_STD_SCART_PAL</span>:
		<span class="k">case</span> <span class="n">TV_STD_SECAM</span>:
		<span class="k">case</span> <span class="n">TV_STD_PAL_CN</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">ucDacStandard</span> <span class="o">=</span> <span class="n">ATOM_DAC1_PAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_NTSC</span>:
		<span class="k">case</span> <span class="n">TV_STD_NTSC_J</span>:
		<span class="k">case</span> <span class="n">TV_STD_PAL_60</span>:
		<span class="nl">default:</span>
			<span class="n">args</span><span class="p">.</span><span class="n">ucDacStandard</span> <span class="o">=</span> <span class="n">ATOM_DAC1_NTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">args</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atombios_tv_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">TV_ENCODER_CONTROL_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dac</span> <span class="o">*</span><span class="n">dac_info</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">TVEncoderControl</span><span class="p">);</span>

	<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
		<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_CV</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dac_info</span><span class="o">-&gt;</span><span class="n">tv_std</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TV_STD_NTSC</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_NTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_PAL</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_PAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_PAL_M</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_PALM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_PAL_60</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_PAL60</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_NTSC_J</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_NTSCJ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_SCART_PAL</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_PAL</span><span class="p">;</span> <span class="cm">/* ??? */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_SECAM</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_SECAM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TV_STD_PAL_CN</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_PALCN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">ucTvStandard</span> <span class="o">=</span> <span class="n">ATOM_TV_NTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">args</span><span class="p">.</span><span class="n">sTVEncoder</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">union</span> <span class="n">dvo_encoder_control</span> <span class="p">{</span>
	<span class="n">ENABLE_EXTERNAL_TMDS_ENCODER_PS_ALLOCATION</span> <span class="n">ext_tmds</span><span class="p">;</span>
	<span class="n">DVO_ENCODER_CONTROL_PS_ALLOCATION</span> <span class="n">dvo</span><span class="p">;</span>
	<span class="n">DVO_ENCODER_CONTROL_PS_ALLOCATION_V3</span> <span class="n">dvo_v3</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">atombios_dvo_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">dvo_encoder_control</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DVOEncoderControl</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* some R4xx chips have the wrong frev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_RV410</span><span class="p">)</span>
		<span class="n">frev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* R4xx, R5xx */</span>
			<span class="n">args</span><span class="p">.</span><span class="n">ext_tmds</span><span class="p">.</span><span class="n">sXTmdsEncoder</span><span class="p">.</span><span class="n">ucEnable</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">ext_tmds</span><span class="p">.</span><span class="n">sXTmdsEncoder</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_DUAL</span><span class="p">;</span>

			<span class="n">args</span><span class="p">.</span><span class="n">ext_tmds</span><span class="p">.</span><span class="n">sXTmdsEncoder</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">ATOM_PANEL_MISC_888RGB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* RS600/690/740 */</span>
			<span class="n">args</span><span class="p">.</span><span class="n">dvo</span><span class="p">.</span><span class="n">sDVOEncoder</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">dvo</span><span class="p">.</span><span class="n">sDVOEncoder</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="cm">/* DFP1, CRT1, TV1 depending on the type of port */</span>
			<span class="n">args</span><span class="p">.</span><span class="n">dvo</span><span class="p">.</span><span class="n">sDVOEncoder</span><span class="p">.</span><span class="n">ucDeviceType</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP1_INDEX</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">dvo</span><span class="p">.</span><span class="n">sDVOEncoder</span><span class="p">.</span><span class="n">usDevAttr</span><span class="p">.</span><span class="n">sDigAttrib</span><span class="p">.</span><span class="n">ucAttribute</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_DUAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="cm">/* R6xx */</span>
			<span class="n">args</span><span class="p">.</span><span class="n">dvo_v3</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">dvo_v3</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">args</span><span class="p">.</span><span class="n">dvo_v3</span><span class="p">.</span><span class="n">ucDVOConfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XXX */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">lvds_encoder_control</span> <span class="p">{</span>
	<span class="n">LVDS_ENCODER_CONTROL_PS_ALLOCATION</span>    <span class="n">v1</span><span class="p">;</span>
	<span class="n">LVDS_ENCODER_CONTROL_PS_ALLOCATION_V2</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">atombios_digital_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">lvds_encoder_control</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdmi_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dig</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_MODE_HDMI</span><span class="p">)</span>
		<span class="n">hdmi_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">LVDSEncoderControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">TMDS1EncoderControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">LVDSEncoderControl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">TMDS2EncoderControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_detected</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_HDMI_TYPE</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_DUAL</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_DUAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_888RGB</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">ATOM_PANEL_MISC_888RGB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_TMDS_LINKB</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_DUAL</span><span class="p">;</span>
				<span class="cm">/*if (pScrn-&gt;rgbBits == 8) */</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">ATOM_PANEL_MISC_888RGB</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_COHERENT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_detected</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_HDMI_TYPE</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucTruncate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucSpatial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucTemporal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucFRC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_DUAL</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_DUAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_SPATIAL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucSpatial</span> <span class="o">=</span> <span class="n">PANEL_ENCODER_SPATIAL_DITHER_EN</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_888RGB</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucSpatial</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_SPATIAL_DITHER_DEPTH</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_TEMPORAL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucTemporal</span> <span class="o">=</span> <span class="n">PANEL_ENCODER_TEMPORAL_DITHER_EN</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&amp;</span> <span class="n">ATOM_PANEL_MISC_888RGB</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucTemporal</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_TEMPORAL_DITHER_DEPTH</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">lcd_misc</span> <span class="o">&gt;&gt;</span> <span class="n">ATOM_PANEL_MISC_GREY_LEVEL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucTemporal</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_TEMPORAL_LEVEL_4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_TMDS_LINKB</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">|=</span> <span class="n">PANEL_ENCODER_MISC_DUAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">atombios_get_encoder_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_connector_atom_dig</span> <span class="o">*</span><span class="n">dig_connector</span><span class="p">;</span>

	<span class="cm">/* dp bridges are always DP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder_get_dp_bridge_encoder_id</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ENCODER_OBJECT_ID_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DP</span><span class="p">;</span>

	<span class="cm">/* DVO is always DVO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_MODE_DVO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DVO</span><span class="p">;</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="cm">/* if we don&#39;t have an active device yet, just use one of</span>
<span class="cm">	 * the connectors tied to the encoder.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="p">)</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder_init</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_HDMIB</span>: <span class="cm">/* HDMI-B is basically DL-DVI; analog works fine */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drm_detect_hdmi_monitor</span><span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">radeon_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_HDMI</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">use_digital</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DVI</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_CRT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drm_detect_hdmi_monitor</span><span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">radeon_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_HDMI</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DVI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_LVDS</span>:
		<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_LVDS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_DisplayPort</span>:
		<span class="n">dig_connector</span> <span class="o">=</span> <span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">con_priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_sink_type</span> <span class="o">==</span> <span class="n">CONNECTOR_OBJECT_ID_DISPLAYPORT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_sink_type</span> <span class="o">==</span> <span class="n">CONNECTOR_OBJECT_ID_eDP</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">drm_detect_hdmi_monitor</span><span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">radeon_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_HDMI</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DVI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span>:
		<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_DP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_DVIA</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span>:
		<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_CRT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_Composite</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_9PinDIN</span>:
		<span class="cm">/* fix me */</span>
		<span class="k">return</span> <span class="n">ATOM_ENCODER_MODE_TV</span><span class="p">;</span>
		<span class="cm">/*return ATOM_ENCODER_MODE_CV;*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DIG Encoder/Transmitter Setup</span>
<span class="cm"> *</span>
<span class="cm"> * DCE 3.0/3.1</span>
<span class="cm"> * - 2 DIG transmitter blocks. UNIPHY (links A and B) and LVTMA.</span>
<span class="cm"> * Supports up to 3 digital outputs</span>
<span class="cm"> * - 2 DIG encoder blocks.</span>
<span class="cm"> * DIG1 can drive UNIPHY link A or link B</span>
<span class="cm"> * DIG2 can drive UNIPHY link B or LVTMA</span>
<span class="cm"> *</span>
<span class="cm"> * DCE 3.2</span>
<span class="cm"> * - 3 DIG transmitter blocks. UNIPHY0/1/2 (links A and B).</span>
<span class="cm"> * Supports up to 5 digital outputs</span>
<span class="cm"> * - 2 DIG encoder blocks.</span>
<span class="cm"> * DIG1/2 can drive UNIPHY0/1/2 link A or link B</span>
<span class="cm"> *</span>
<span class="cm"> * DCE 4.0/5.0/6.0</span>
<span class="cm"> * - 3 DIG transmitter blocks UNIPHY0/1/2 (links A and B).</span>
<span class="cm"> * Supports up to 6 digital outputs</span>
<span class="cm"> * - 6 DIG encoder blocks.</span>
<span class="cm"> * - DIG to PHY mapping is hardcoded</span>
<span class="cm"> * DIG1 drives UNIPHY0 link A, A+B</span>
<span class="cm"> * DIG2 drives UNIPHY0 link B</span>
<span class="cm"> * DIG3 drives UNIPHY1 link A, A+B</span>
<span class="cm"> * DIG4 drives UNIPHY1 link B</span>
<span class="cm"> * DIG5 drives UNIPHY2 link A, A+B</span>
<span class="cm"> * DIG6 drives UNIPHY2 link B</span>
<span class="cm"> *</span>
<span class="cm"> * DCE 4.1</span>
<span class="cm"> * - 3 DIG transmitter blocks UNIPHY0/1/2 (links A and B).</span>
<span class="cm"> * Supports up to 6 digital outputs</span>
<span class="cm"> * - 2 DIG encoder blocks.</span>
<span class="cm"> * llano</span>
<span class="cm"> * DIG1/2 can drive UNIPHY0/1/2 link A or link B</span>
<span class="cm"> * ontario</span>
<span class="cm"> * DIG1 drives UNIPHY0/1/2 link A</span>
<span class="cm"> * DIG2 drives UNIPHY0/1/2 link B</span>
<span class="cm"> *</span>
<span class="cm"> * Routing</span>
<span class="cm"> * crtc -&gt; dig encoder -&gt; UNIPHY/LVTMA (1 or 2 links)</span>
<span class="cm"> * Examples:</span>
<span class="cm"> * crtc0 -&gt; dig2 -&gt; LVTMA   links A+B -&gt; TMDS/HDMI</span>
<span class="cm"> * crtc1 -&gt; dig1 -&gt; UNIPHY0 link  B   -&gt; DP</span>
<span class="cm"> * crtc0 -&gt; dig1 -&gt; UNIPHY2 link  A   -&gt; LVDS</span>
<span class="cm"> * crtc1 -&gt; dig2 -&gt; UNIPHY1 link  B+A -&gt; TMDS/HDMI</span>
<span class="cm"> */</span>

<span class="k">union</span> <span class="n">dig_encoder_control</span> <span class="p">{</span>
	<span class="n">DIG_ENCODER_CONTROL_PS_ALLOCATION</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">DIG_ENCODER_CONTROL_PARAMETERS_V2</span> <span class="n">v2</span><span class="p">;</span>
	<span class="n">DIG_ENCODER_CONTROL_PARAMETERS_V3</span> <span class="n">v3</span><span class="p">;</span>
	<span class="n">DIG_ENCODER_CONTROL_PARAMETERS_V4</span> <span class="n">v4</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">atombios_dig_encoder_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">,</span> <span class="kt">int</span> <span class="n">panel_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">dig_encoder_control</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_lane_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hpd_id</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">radeon_connector_atom_dig</span> <span class="o">*</span><span class="n">dig_connector</span> <span class="o">=</span>
			<span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">con_priv</span><span class="p">;</span>

		<span class="n">dp_clock</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_clock</span><span class="p">;</span>
		<span class="n">dp_lane_count</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_lane_count</span><span class="p">;</span>
		<span class="n">hpd_id</span> <span class="o">=</span> <span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span><span class="p">;</span>
		<span class="n">bpc</span> <span class="o">=</span> <span class="n">radeon_get_monitor_bpc</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* no dig encoder assigned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DIGxEncoderControl</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DIG2EncoderControl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DIG1EncoderControl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_CMD_SETUP_PANEL_MODE</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucPanelMode</span> <span class="o">=</span> <span class="n">panel_mode</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">270000</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">=</span> <span class="n">ATOM_ENCODER_CONFIG_V2_TRANSMITTER1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">=</span> <span class="n">ATOM_ENCODER_CONFIG_V2_TRANSMITTER2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">=</span> <span class="n">ATOM_ENCODER_CONFIG_V2_TRANSMITTER3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_LINKB</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_LINKA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_CMD_SETUP_PANEL_MODE</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucPanelMode</span> <span class="o">=</span> <span class="n">panel_mode</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucEncoderMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">270000</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucDigSel</span> <span class="o">=</span> <span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bpc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_BPC_UNDEFINE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_6BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
			<span class="nl">default:</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_8BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_10BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_12BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_16BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_CMD_SETUP_PANEL_MODE</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucPanelMode</span> <span class="o">=</span> <span class="n">panel_mode</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucEncoderMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">270000</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_V4_DPLINKRATE_2_70GHZ</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">540000</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_V4_DPLINKRATE_5_40GHZ</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucDigSel</span> <span class="o">=</span> <span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bpc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_BPC_UNDEFINE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_6BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
			<span class="nl">default:</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_8BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_10BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_12BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_16BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpd_id</span> <span class="o">==</span> <span class="n">RADEON_HPD_NONE</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucHPD_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucHPD_ID</span> <span class="o">=</span> <span class="n">hpd_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">union</span> <span class="n">dig_transmitter_control</span> <span class="p">{</span>
	<span class="n">DIG_TRANSMITTER_CONTROL_PS_ALLOCATION</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">DIG_TRANSMITTER_CONTROL_PARAMETERS_V2</span> <span class="n">v2</span><span class="p">;</span>
	<span class="n">DIG_TRANSMITTER_CONTROL_PARAMETERS_V3</span> <span class="n">v3</span><span class="p">;</span>
	<span class="n">DIG_TRANSMITTER_CONTROL_PARAMETERS_V4</span> <span class="n">v4</span><span class="p">;</span>
	<span class="n">DIG_TRANSMITTER_CONTROL_PARAMETERS_V1_5</span> <span class="n">v5</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">lane_num</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">lane_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">dig_transmitter_control</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_dp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pll_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_lane_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connector_object_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">igp_lane_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dig_encoder</span> <span class="o">=</span> <span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hpd_id</span> <span class="o">=</span> <span class="n">RADEON_HPD_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder_init</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="cm">/* just needed to avoid bailing in the encoder check.  the encoder</span>
<span class="cm">		 * isn&#39;t used for init</span>
<span class="cm">		 */</span>
		<span class="n">dig_encoder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">radeon_connector_atom_dig</span> <span class="o">*</span><span class="n">dig_connector</span> <span class="o">=</span>
			<span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">con_priv</span><span class="p">;</span>

		<span class="n">hpd_id</span> <span class="o">=</span> <span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span><span class="p">;</span>
		<span class="n">dp_clock</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_clock</span><span class="p">;</span>
		<span class="n">dp_lane_count</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_lane_count</span><span class="p">;</span>
		<span class="n">connector_object_id</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">connector_object_id</span> <span class="o">&amp;</span> <span class="n">OBJECT_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OBJECT_ID_SHIFT</span><span class="p">;</span>
		<span class="n">igp_lane_info</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">igp_lane_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
		<span class="n">pll_id</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">pll_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* no dig encoder assigned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dig_encoder</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">)))</span>
		<span class="n">is_dp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DVOOutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">UNIPHYTransmitterControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">LVTMATransmitterControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_INIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">usInitInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">connector_object_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSel</span> <span class="o">=</span> <span class="n">lane_num</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSet</span> <span class="o">=</span> <span class="n">lane_set</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dp_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_CLKSRC_PPLL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dig_encoder</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_DIG2_ENCODER</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_DIG1_ENCODER</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">igp_lane_info</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LANE_0_3</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">igp_lane_info</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LANE_4_7</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">igp_lane_info</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LANE_8_11</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">igp_lane_info</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LANE_12_15</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">igp_lane_info</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LANE_0_7</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">igp_lane_info</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span>
						<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LANE_8_15</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LINKB</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_LINKA</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_COHERENT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_COHERENT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_TRANSMITTER_CONFIG_8LANE_LINK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_INIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usInitInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">connector_object_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSel</span> <span class="o">=</span> <span class="n">lane_num</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSet</span> <span class="o">=</span> <span class="n">lane_set</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dp_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucEncoderSel</span> <span class="o">=</span> <span class="n">dig_encoder</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucLinkSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fDPConnector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fDualLinkConnector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_INIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usInitInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">connector_object_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSel</span> <span class="o">=</span> <span class="n">lane_num</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSet</span> <span class="o">=</span> <span class="n">lane_set</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dp_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucLinkSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dig_encoder</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucEncoderSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Select the PLL for the PHY</span>
<span class="cm">			 * DP PHY should be clocked from external src if there is</span>
<span class="cm">			 * one.</span>
<span class="cm">			 */</span>
			<span class="cm">/* On DCE4, if there is an external clock, it generates the DP ref clock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">dp_extclk</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucRefClkSource</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* external src */</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucRefClkSource</span> <span class="o">=</span> <span class="n">pll_id</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* DP requires coherent */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fDualLinkConnector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_INIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">usInitInfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">connector_object_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSel</span> <span class="o">=</span> <span class="n">lane_num</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">asMode</span><span class="p">.</span><span class="n">ucLaneSet</span> <span class="o">=</span> <span class="n">lane_set</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dp_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucLinkSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dig_encoder</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucEncoderSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Select the PLL for the PHY</span>
<span class="cm">			 * DP PHY should be clocked from external src if there is</span>
<span class="cm">			 * one.</span>
<span class="cm">			 */</span>
			<span class="cm">/* On DCE5 DCPLL usually generates the DP ref clock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">dp_extclk</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucRefClkSource</span> <span class="o">=</span> <span class="n">ENCODER_REFCLK_SRC_EXTCLK</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucRefClkSource</span> <span class="o">=</span> <span class="n">ENCODER_REFCLK_SRC_DCPLL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucRefClkSource</span> <span class="o">=</span> <span class="n">pll_id</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">ucTransmitterSel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* DP requires coherent */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">acConfig</span><span class="p">.</span><span class="n">fDualLinkConnector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">usSymClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dp_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">usSymClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucPhyId</span> <span class="o">=</span> <span class="n">ATOM_PHY_ID_UNIPHYB</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucPhyId</span> <span class="o">=</span> <span class="n">ATOM_PHY_ID_UNIPHYA</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucPhyId</span> <span class="o">=</span> <span class="n">ATOM_PHY_ID_UNIPHYD</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucPhyId</span> <span class="o">=</span> <span class="n">ATOM_PHY_ID_UNIPHYC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucPhyId</span> <span class="o">=</span> <span class="n">ATOM_PHY_ID_UNIPHYF</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucPhyId</span> <span class="o">=</span> <span class="n">ATOM_PHY_ID_UNIPHYE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">&gt;</span> <span class="mi">165000</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucConnObjId</span> <span class="o">=</span> <span class="n">connector_object_id</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucDigMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">dp_extclk</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">asConfig</span><span class="p">.</span><span class="n">ucPhyClkSrcId</span> <span class="o">=</span> <span class="n">ENCODER_REFCLK_SRC_EXTCLK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">asConfig</span><span class="p">.</span><span class="n">ucPhyClkSrcId</span> <span class="o">=</span> <span class="n">pll_id</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">asConfig</span><span class="p">.</span><span class="n">ucCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* DP requires coherent */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">asConfig</span><span class="p">.</span><span class="n">ucCoherentMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpd_id</span> <span class="o">==</span> <span class="n">RADEON_HPD_NONE</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">asConfig</span><span class="p">.</span><span class="n">ucHPDSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">asConfig</span><span class="p">.</span><span class="n">ucHPDSel</span> <span class="o">=</span> <span class="n">hpd_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucDigEncoderSel</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dig_encoder</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v5</span><span class="p">.</span><span class="n">ucDPLaneSet</span> <span class="o">=</span> <span class="n">lane_set</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span>
<span class="nf">atombios_set_edp_panel_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">dig_transmitter_control</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">UNIPHYTransmitterControl</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">!=</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">action</span> <span class="o">!=</span> <span class="n">ATOM_TRANSMITTER_ACTION_POWER_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">ATOM_TRANSMITTER_ACTION_POWER_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

	<span class="cm">/* wait for the panel to power up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ATOM_TRANSMITTER_ACTION_POWER_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_hpd_sense</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">hpd</span><span class="p">.</span><span class="n">hpd</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">external_encoder_control</span> <span class="p">{</span>
	<span class="n">EXTERNAL_ENCODER_CONTROL_PS_ALLOCATION</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">EXTERNAL_ENCODER_CONTROL_PS_ALLOCATION_V3</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atombios_external_encoder_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">ext_radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">ext_encoder</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">external_encoder_control</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">ExternalEncoderControl</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dp_lane_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connector_object_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_enum</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext_radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_enum</span> <span class="o">&amp;</span> <span class="n">ENUM_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ENUM_ID_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT</span><span class="p">)</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder_init</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">radeon_connector_atom_dig</span> <span class="o">*</span><span class="n">dig_connector</span> <span class="o">=</span>
			<span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">con_priv</span><span class="p">;</span>

		<span class="n">dp_clock</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_clock</span><span class="p">;</span>
		<span class="n">dp_lane_count</span> <span class="o">=</span> <span class="n">dig_connector</span><span class="o">-&gt;</span><span class="n">dp_lane_count</span><span class="p">;</span>
		<span class="n">connector_object_id</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">connector_object_id</span> <span class="o">&amp;</span> <span class="n">OBJECT_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OBJECT_ID_SHIFT</span><span class="p">;</span>
		<span class="n">bpc</span> <span class="o">=</span> <span class="n">radeon_get_monitor_bpc</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* no params on frev 1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucEncoderMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">270000</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">sDigEncoder</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">usConnectorId</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">connector_object_id</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">usPixelClock</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucEncoderMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucEncoderMode</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">270000</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">EXTERNAL_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dp_clock</span> <span class="o">==</span> <span class="mi">540000</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">EXTERNAL_ENCODER_CONFIG_V3_DPLINKRATE_5_40GHZ</span><span class="p">;</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="n">dp_lane_count</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_dig_monitor_is_duallink</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucLaneNum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext_enum</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">GRAPH_OBJECT_ENUM_ID1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">EXTERNAL_ENCODER_CONFIG_V3_ENCODER1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GRAPH_OBJECT_ENUM_ID2</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">EXTERNAL_ENCODER_CONFIG_V3_ENCODER2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GRAPH_OBJECT_ENUM_ID3</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucConfig</span> <span class="o">|=</span> <span class="n">EXTERNAL_ENCODER_CONFIG_V3_ENCODER3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bpc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_BPC_UNDEFINE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_6BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
			<span class="nl">default:</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_8BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_10BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_12BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v3</span><span class="p">.</span><span class="n">sExtEncoder</span><span class="p">.</span><span class="n">ucBitPerColor</span> <span class="o">=</span> <span class="n">PANEL_16BIT_PER_COLOR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atombios_yuv_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">ENABLE_YUV_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">EnableYUV</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">R600_BIOS_3_SCRATCH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">;</span>

	<span class="cm">/* XXX: fix up scratch reg handling */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">ATOM_S3_TV1_ACTIVE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">ATOM_S3_CV_ACTIVE</span> <span class="o">|</span> <span class="p">(</span><span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ucEnable</span> <span class="o">=</span> <span class="n">ATOM_ENABLE</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ucCRTC</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

	<span class="n">WREG32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_encoder_dpms_avivo</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">DISPLAY_DEVICE_OUTPUT_CONTROL_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">TMDSAOutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DVOOutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">LCD1OutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">LCD1OutputControl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">LVTMAOutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">TV1OutputControl</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">CV1OutputControl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DAC1OutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">TV1OutputControl</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">CV1OutputControl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DAC2OutputControl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">ATOM_ENABLE</span><span class="p">;</span>
		<span class="cm">/* workaround for DVOOutputControl on some RS690 systems */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">);</span>
			<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ATOM_S3_DFP2I_ACTIVE</span><span class="p">);</span>
			<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
			<span class="n">WREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_3_SCRATCH</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">ATOM_LCD_BLON</span><span class="p">;</span>
			<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="n">args</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">ATOM_DISABLE</span><span class="p">;</span>
		<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">ucAction</span> <span class="o">=</span> <span class="n">ATOM_LCD_BLOFF</span><span class="p">;</span>
			<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_encoder_dpms_dig</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_connector_atom_dig</span> <span class="o">*</span><span class="n">radeon_dig_connector</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="n">radeon_dig_connector</span> <span class="o">=</span> <span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">con_priv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
		<span class="cm">/* some early dce3.2 boards have a bug in their transmitter control table */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RV710</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_RV730</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_ENABLE_OUTPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atombios_set_edp_panel_power</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							     <span class="n">ATOM_TRANSMITTER_ACTION_POWER_ON</span><span class="p">);</span>
				<span class="n">radeon_dig_connector</span><span class="o">-&gt;</span><span class="n">edp_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">radeon_dp_link_train</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">connector</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENCODER_CMD_DP_VIDEO_ON</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_LCD_BLON</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_DISABLE_OUTPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ENCODER_MODE_IS_DP</span><span class="p">(</span><span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENCODER_CMD_DP_VIDEO_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atombios_set_edp_panel_power</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							     <span class="n">ATOM_TRANSMITTER_ACTION_POWER_OFF</span><span class="p">);</span>
				<span class="n">radeon_dig_connector</span><span class="o">-&gt;</span><span class="n">edp_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_LCD_BLOFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_encoder_dpms_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE61</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
							<span class="n">EXTERNAL_ENCODER_ACTION_V3_ENABLE_OUTPUT</span><span class="p">);</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
							<span class="n">EXTERNAL_ENCODER_ACTION_V3_ENCODER_BLANKING_OFF</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE61</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
							<span class="n">EXTERNAL_ENCODER_ACTION_V3_ENCODER_BLANKING</span><span class="p">);</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
							<span class="n">EXTERNAL_ENCODER_ACTION_V3_DISABLE_OUTPUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_encoder_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span> <span class="o">=</span> <span class="n">radeon_get_external_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;encoder dpms %d to mode %d, devices %08x, active_devices %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span>
		  <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
		<span class="n">radeon_atom_encoder_dpms_avivo</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
		<span class="n">radeon_atom_encoder_dpms_dig</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
				<span class="n">atombios_dvo_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
				<span class="n">atombios_dvo_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE3</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">radeon_atom_encoder_dpms_dig</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">radeon_atom_encoder_dpms_avivo</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
				<span class="n">atombios_dac_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
			<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
				<span class="n">atombios_dac_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">radeon_atom_encoder_dpms_avivo</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_encoder</span><span class="p">)</span>
		<span class="n">radeon_atom_encoder_dpms_ext</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">radeon_atombios_encoder_dpms_scratch_regs</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">union</span> <span class="n">crtc_source_param</span> <span class="p">{</span>
	<span class="n">SELECT_CRTC_SOURCE_PS_ALLOCATION</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">SELECT_CRTC_SOURCE_PARAMETERS_V2</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atombios_set_encoder_crtc_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">crtc_source_param</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">SelectCRTC_Source</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">crev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucCRTC</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucCRTC</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucCRTC</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP1_INDEX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_LCD1_INDEX</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP3_INDEX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_DFP2_INDEX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_TV1_INDEX</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_CV_INDEX</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_CRT1_INDEX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_TV1_INDEX</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_CV_INDEX</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">ucDevice</span> <span class="o">=</span> <span class="n">ATOM_DEVICE_CRT2_INDEX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucCRTC</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder_get_dp_bridge_encoder_id</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ENCODER_OBJECT_ID_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncodeMode</span> <span class="o">=</span> <span class="n">ATOM_ENCODER_MODE_LVDS</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">)</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncodeMode</span> <span class="o">=</span> <span class="n">ATOM_ENCODER_MODE_CRT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncodeMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncodeMode</span> <span class="o">=</span> <span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
				<span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DIG1_ENCODER_ID</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DIG2_ENCODER_ID</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DIG3_ENCODER_ID</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>:
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DIG4_ENCODER_ID</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>:
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DIG5_ENCODER_ID</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">5</span>:
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DIG6_ENCODER_ID</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
				<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DVO_ENCODER_ID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_TV_ENCODER_ID</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_TV_ENCODER_ID</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DAC1_ENCODER_ID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_TV_ENCODER_ID</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_TV_ENCODER_ID</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">args</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">ucEncoderID</span> <span class="o">=</span> <span class="n">ASIC_INT_DAC2_ENCODER_ID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown table version: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

	<span class="cm">/* update scratch regs with new routing */</span>
	<span class="n">radeon_atombios_encoder_crtc_scratch_regs</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atombios_apply_encoder_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* Funky macbooks */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x71C5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x106b</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0080</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_LCD1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">lvtma_bit_depth_control</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">AVIVO_LVTMA_BIT_DEPTH_CONTROL</span><span class="p">);</span>

			<span class="n">lvtma_bit_depth_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AVIVO_LVTMA_BIT_DEPTH_CONTROL_TRUNCATE_EN</span><span class="p">;</span>
			<span class="n">lvtma_bit_depth_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AVIVO_LVTMA_BIT_DEPTH_CONTROL_SPATIAL_DITHER_EN</span><span class="p">;</span>

			<span class="n">WREG32</span><span class="p">(</span><span class="n">AVIVO_LVTMA_BIT_DEPTH_CONTROL</span><span class="p">,</span> <span class="n">lvtma_bit_depth_control</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set scaler clears this on some chips */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">EVERGREEN_DATA_FORMAT</span> <span class="o">+</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_offset</span><span class="p">,</span>
				       <span class="n">EVERGREEN_INTERLEAVE_EN</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">EVERGREEN_DATA_FORMAT</span> <span class="o">+</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">AVIVO_D1MODE_DATA_FORMAT</span> <span class="o">+</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_offset</span><span class="p">,</span>
				       <span class="n">AVIVO_D1MODE_INTERLEAVE_EN</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">WREG32</span><span class="p">(</span><span class="n">AVIVO_D1MODE_DATA_FORMAT</span> <span class="o">+</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_atom_pick_dig_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">test_encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dig_enc_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DCE4/5 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* ontario follows DCE4 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_PALM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* llano follows DCE3.2 */</span>
				<span class="k">return</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* on DCE32 and encoder can driver any block so just crtc id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE32</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* on DCE3 - LVTMA can only be driven by DIGB */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">test_encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_test_encoder</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span> <span class="o">==</span> <span class="n">test_encoder</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_encoder_is_digital</span><span class="p">(</span><span class="n">test_encoder</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">radeon_test_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">test_encoder</span><span class="p">);</span>
		<span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_test_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dig_enc_in_use</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dig_enc_in_use</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;LVDS required digital encoder 2 but it was in use - stealing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dig_enc_in_use</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This only needs to be called once at startup */</span>
<span class="kt">void</span>
<span class="nf">radeon_atom_encoder_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span> <span class="o">=</span> <span class="n">radeon_get_external_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
		<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
		<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
		<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext_encoder</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE61</span><span class="p">(</span><span class="n">rdev</span><span class="p">)))</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
							<span class="n">EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_encoder_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span> <span class="o">=</span> <span class="n">radeon_get_external_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_AVIVO</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_TV_SUPPORT</span><span class="p">))</span>
			<span class="n">atombios_yuv_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">atombios_yuv_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
		<span class="n">atombios_digital_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">PANEL_ENCODER_ACTION_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE5</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="p">)</span>
				<span class="n">dig</span><span class="o">-&gt;</span><span class="n">panel_mode</span> <span class="o">=</span> <span class="n">DP_PANEL_MODE_EXTERNAL_DP_MODE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dig</span><span class="o">-&gt;</span><span class="n">panel_mode</span> <span class="o">=</span> <span class="n">radeon_dp_get_panel_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">connector</span><span class="p">);</span>

			<span class="cm">/* setup and enable the encoder */</span>
			<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENCODER_CMD_SETUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
						   <span class="n">ATOM_ENCODER_CMD_SETUP_PANEL_MODE</span><span class="p">,</span>
						   <span class="n">dig</span><span class="o">-&gt;</span><span class="n">panel_mode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* disable the transmitter */</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* setup and enable the encoder */</span>
			<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENCODER_CMD_SETUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* enable the transmitter */</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* disable the encoder and transmitter */</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* setup and enable the encoder and transmitter */</span>
			<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_SETUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
		<span class="n">atombios_dvo_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
		<span class="n">atombios_dac_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
				<span class="n">atombios_tv_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">atombios_tv_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_encoder</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE41</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASIC_IS_DCE61</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
							<span class="n">EXTERNAL_ENCODER_ACTION_V3_ENCODER_SETUP</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span> <span class="n">ATOM_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atombios_apply_encoder_quirks</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_MODE_HDMI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r600_hdmi_enable</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE6</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="p">;</span> <span class="cm">/* TODO (use pointers instead of if-s?) */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">evergreen_hdmi_setmode</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r600_hdmi_setmode</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">atombios_dac_load_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span> <span class="o">|</span>
				       <span class="n">ATOM_DEVICE_CV_SUPPORT</span> <span class="o">|</span>
				       <span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DAC_LOAD_DETECTION_PS_ALLOCATION</span> <span class="n">args</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetIndexIntoMasterTable</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">DAC_LoadDetection</span><span class="p">);</span>
		<span class="kt">uint8_t</span> <span class="n">frev</span><span class="p">,</span> <span class="n">crev</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atom_parse_cmd_header</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crev</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span><span class="p">))</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">ucDacType</span> <span class="o">=</span> <span class="n">ATOM_DAC_A</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">ucDacType</span> <span class="o">=</span> <span class="n">ATOM_DAC_B</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">usDeviceID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">usDeviceID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">usDeviceID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">=</span> <span class="n">DAC_LOAD_MISC_YPrPb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">usDeviceID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">sDacload</span><span class="p">.</span><span class="n">ucMisc</span> <span class="o">=</span> <span class="n">DAC_LOAD_MISC_YPrPb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">atom_execute_table</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">atom_context</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">radeon_atom_dac_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">bios_0_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atombios_dac_load_detect</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">connector</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;detect returned false </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">bios_0_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_0_SCRATCH</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bios_0_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">RADEON_BIOS_0_SCRATCH</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Bios 0 scratch %x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bios_0_scratch</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="n">ATOM_S0_CRT1_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="n">ATOM_S0_CRT2_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_S0_CV_MASK</span><span class="o">|</span><span class="n">ATOM_S0_CV_MASK_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_S0_TV1_COMPOSITE</span> <span class="o">|</span> <span class="n">ATOM_S0_TV1_COMPOSITE_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span> <span class="cm">/* CTV */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_S0_TV1_SVIDEO</span> <span class="o">|</span> <span class="n">ATOM_S0_TV1_SVIDEO_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span> <span class="cm">/* STV */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">radeon_atom_dig_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span> <span class="o">=</span> <span class="n">radeon_get_external_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bios_0_scratch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_encoder</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>

	<span class="cm">/* load detect on the dp bridge */</span>
	<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
					<span class="n">EXTERNAL_ENCODER_ACTION_V3_DACLOAD_DETECTION</span><span class="p">);</span>

	<span class="n">bios_0_scratch</span> <span class="o">=</span> <span class="n">RREG32</span><span class="p">(</span><span class="n">R600_BIOS_0_SCRATCH</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Bios 0 scratch %x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bios_0_scratch</span><span class="p">,</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="n">ATOM_S0_CRT1_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CRT2_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="n">ATOM_S0_CRT2_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_S0_CV_MASK</span><span class="o">|</span><span class="n">ATOM_S0_CV_MASK_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_TV1_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_S0_TV1_COMPOSITE</span> <span class="o">|</span> <span class="n">ATOM_S0_TV1_COMPOSITE_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span> <span class="cm">/* CTV */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bios_0_scratch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_S0_TV1_SVIDEO</span> <span class="o">|</span> <span class="n">ATOM_S0_TV1_SVIDEO_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span> <span class="cm">/* STV */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_atom_ext_encoder_setup_ddc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">ext_encoder</span> <span class="o">=</span> <span class="n">radeon_get_external_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_encoder</span><span class="p">)</span>
		<span class="cm">/* ddc_setup on the dp bridge */</span>
		<span class="n">atombios_external_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ext_encoder</span><span class="p">,</span>
						<span class="n">EXTERNAL_ENCODER_ACTION_V3_DDC_SETUP</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atom_encoder_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">radeon_get_connector_for_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">ATOM_DEVICE_DFP_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">radeon_encoder_get_dp_bridge_encoder_id</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">ENCODER_OBJECT_ID_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dig</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span> <span class="o">=</span> <span class="n">radeon_atom_pick_dig_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">&amp;</span> <span class="n">ATOM_DEVICE_DFP_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
					<span class="n">dig</span><span class="o">-&gt;</span><span class="n">afmt</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">afmt</span><span class="p">[</span><span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="cm">/* RS600/690/740 have only 1 afmt block */</span>
					<span class="n">dig</span><span class="o">-&gt;</span><span class="n">afmt</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">afmt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">radeon_atom_output_lock</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">radeon_atom_encoder_dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_connector</span> <span class="o">*</span><span class="n">radeon_connector</span> <span class="o">=</span> <span class="n">to_radeon_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

		<span class="cm">/* select the clock/data port if it uses a router */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_connector</span><span class="o">-&gt;</span><span class="n">router</span><span class="p">.</span><span class="n">cd_valid</span><span class="p">)</span>
			<span class="n">radeon_router_select_cd_port</span><span class="p">(</span><span class="n">radeon_connector</span><span class="p">);</span>

		<span class="cm">/* turn eDP panel on for mode set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">)</span>
			<span class="n">atombios_set_edp_panel_power</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
						     <span class="n">ATOM_TRANSMITTER_ACTION_POWER_ON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* this is needed for the pll/ss setup to work correctly in some cases */</span>
	<span class="n">atombios_set_encoder_crtc_source</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atom_encoder_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_atom_encoder_dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
	<span class="n">radeon_atom_output_lock</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atom_encoder_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span><span class="p">;</span>

	<span class="cm">/* check for pre-DCE3 cards with shared encoders;</span>
<span class="cm">	 * can&#39;t really use the links individually, so don&#39;t disable</span>
<span class="cm">	 * the encoder if it&#39;s in use by another connector</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ASIC_IS_DCE3</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">other_encoder</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">other_radeon_encoder</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">other_encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">other_radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">other_encoder</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">==</span> <span class="n">other_radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">drm_helper_encoder_in_use</span><span class="p">(</span><span class="n">other_encoder</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">disable_done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">radeon_atom_encoder_dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
		<span class="n">atombios_digital_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">PANEL_ENCODER_ACTION_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ASIC_IS_DCE4</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="cm">/* disable the transmitter */</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* disable the encoder and transmitter */</span>
			<span class="n">atombios_dig_transmitter_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_TRANSMITTER_ACTION_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">atombios_dig_encoder_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
		<span class="n">atombios_dvo_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
		<span class="n">atombios_dac_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_TV_SUPPORT</span> <span class="o">|</span> <span class="n">ATOM_DEVICE_CV_SUPPORT</span><span class="p">))</span>
			<span class="n">atombios_tv_setup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">ATOM_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">disable_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder_is_digital</span><span class="p">(</span><span class="n">encoder</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atombios_get_encoder_mode</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATOM_ENCODER_MODE_HDMI</span><span class="p">)</span>
			<span class="n">r600_hdmi_disable</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="n">dig</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">;</span>
		<span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">active_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* these are handled by the primary encoders */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atom_ext_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atom_ext_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_ext_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_atom_ext_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">radeon_atom_ext_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_atom_ext_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">radeon_atom_ext_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">radeon_atom_ext_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">radeon_atom_ext_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">radeon_atom_ext_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">radeon_atom_ext_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">radeon_atom_ext_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">radeon_atom_ext_disable</span><span class="p">,</span>
	<span class="cm">/* no detect for TMDS/LVDS yet */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">radeon_atom_dig_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">radeon_atom_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">radeon_atom_dig_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">radeon_atom_dac_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">radeon_atom_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">radeon_atom_encoder_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">radeon_atom_dac_detect</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">radeon_enc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span><span class="p">);</span>
	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="n">radeon_atom_enc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">radeon_enc_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">radeon_encoder_atom_dac</span> <span class="o">*</span>
<span class="nf">radeon_atombios_set_dac_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dac</span> <span class="o">*</span><span class="n">dac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_atom_dac</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dac</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dac</span><span class="o">-&gt;</span><span class="n">tv_std</span> <span class="o">=</span> <span class="n">radeon_atombios_get_tv_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dac</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span>
<span class="nf">radeon_atombios_set_dig_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">encoder_enum</span> <span class="o">=</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_enum</span> <span class="o">&amp;</span> <span class="n">ENUM_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ENUM_ID_SHIFT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span> <span class="o">*</span><span class="n">dig</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder_atom_dig</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dig</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* coherent mode by default */</span>
	<span class="n">dig</span><span class="o">-&gt;</span><span class="n">coherent_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dig</span><span class="o">-&gt;</span><span class="n">dig_encoder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoder_enum</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dig</span><span class="o">-&gt;</span><span class="n">linkb</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dig</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">radeon_add_atom_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">encoder_enum</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">supported_device</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_encoder</span> <span class="o">*</span><span class="n">radeon_encoder</span><span class="p">;</span>

	<span class="cm">/* see if we already added it */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">to_radeon_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_enum</span> <span class="o">==</span> <span class="n">encoder_enum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">|=</span> <span class="n">supported_device</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* add a new one */</span>
	<span class="n">radeon_encoder</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_encoder</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_encoder</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">num_crtc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="nl">default:</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_enum</span> <span class="o">=</span> <span class="n">encoder_enum</span><span class="p">;</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">encoder_enum</span> <span class="o">&amp;</span> <span class="n">OBJECT_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">OBJECT_ID_SHIFT</span><span class="p">;</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">=</span> <span class="n">supported_device</span><span class="p">;</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">rmx_type</span> <span class="o">=</span> <span class="n">RMX_OFF</span><span class="p">;</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">underscan_type</span> <span class="o">=</span> <span class="n">UNDERSCAN_OFF</span><span class="p">;</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">is_ext_encoder</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">caps</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVDS</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_LVTM1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">rmx_type</span> <span class="o">=</span> <span class="n">RMX_FULL</span><span class="p">;</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_LVDS</span><span class="p">);</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_get_lvds_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_TMDS</span><span class="p">);</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_set_dig_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_dig_helper_funcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC1</span>:
		<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">);</span>
		<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_set_dac_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_dac_helper_funcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DAC2</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2</span>:
		<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_TVDAC</span><span class="p">);</span>
		<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_set_dac_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_dac_helper_funcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_DDI</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY1</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_INTERNAL_UNIPHY2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">rmx_type</span> <span class="o">=</span> <span class="n">RMX_FULL</span><span class="p">;</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_LVDS</span><span class="p">);</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_get_lvds_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">);</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_set_dig_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_TMDS</span><span class="p">);</span>
			<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">enc_priv</span> <span class="o">=</span> <span class="n">radeon_atombios_set_dig_info</span><span class="p">(</span><span class="n">radeon_encoder</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_dig_helper_funcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_SI170B</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_CH7303</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_EXTERNAL_SDVOA</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_EXTERNAL_SDVOB</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_TITFP513</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_VT1623</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_HDMI_SI1930</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_TRAVIS</span>:
	<span class="k">case</span> <span class="n">ENCODER_OBJECT_ID_NUTMEG</span>:
		<span class="cm">/* these are handled by the primary encoders */</span>
		<span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">is_ext_encoder</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_LCD_SUPPORT</span><span class="p">))</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_LVDS</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radeon_encoder</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATOM_DEVICE_CRT_SUPPORT</span><span class="p">))</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_enc_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_ENCODER_TMDS</span><span class="p">);</span>
		<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radeon_atom_ext_helper_funcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
