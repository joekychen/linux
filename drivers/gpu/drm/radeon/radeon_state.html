<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_state.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_state.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* radeon_state.c -- State support for Radeon -*- linux-c -*- */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright 2000 VA Linux Systems, Inc., Fremont, California.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Gareth Hughes &lt;gareth@valinux.com&gt;</span>
<span class="cm"> *    Kevin E. Martin &lt;martin@valinux.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_buffer.h&quot;</span>
<span class="cp">#include &quot;drm_sarea.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>
<span class="cp">#include &quot;radeon_drv.h&quot;</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Helper functions for client state checking and fixup</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span>
						    <span class="n">dev_priv</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span> <span class="n">file_priv</span><span class="p">,</span>
						    <span class="n">u32</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">off</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fb_end</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_driver_file_fields</span> <span class="o">*</span><span class="n">radeon_priv</span><span class="p">;</span>

	<span class="cm">/* Hrm ... the story of the offset ... So this function converts</span>
<span class="cm">	 * the various ideas of what userland clients might have for an</span>
<span class="cm">	 * offset in the card address space into an offset into the card</span>
<span class="cm">	 * address space :) So with a sane client, it should just keep</span>
<span class="cm">	 * the value intact and just do some boundary checking. However,</span>
<span class="cm">	 * not all clients are sane. Some older clients pass us 0 based</span>
<span class="cm">	 * offsets relative to the start of the framebuffer and some may</span>
<span class="cm">	 * assume the AGP aperture it appended to the framebuffer, so we</span>
<span class="cm">	 * try to detect those cases and fix them up.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: It might be a good idea here to make sure the offset lands</span>
<span class="cm">	 * in some &quot;allowed&quot; area to protect things like the PCIE GART...</span>
<span class="cm">	 */</span>

	<span class="cm">/* First, the best case, the offset already lands in either the</span>
<span class="cm">	 * framebuffer or the GART mapped space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">off</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ok, that didn&#39;t happen... now check if we have a zero based</span>
<span class="cm">	 * offset that fits in the framebuffer + gart space, apply the</span>
<span class="cm">	 * magic offset we get from SETPARAM or calculated from fb_location</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_size</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">radeon_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">radeon_priv</span><span class="o">-&gt;</span><span class="n">radeon_fb_delta</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finally, assume we aimed at a GART offset if beyond the fb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">fb_end</span><span class="p">)</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">off</span> <span class="o">-</span> <span class="n">fb_end</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">;</span>

	<span class="cm">/* Now recheck and fail if out of bounds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">off</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;offset fixed up to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">off</span><span class="p">);</span>
		<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">radeon_check_and_fixup_packets</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span>
						     <span class="n">dev_priv</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
						     <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_MISC</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="p">(</span><span class="n">RADEON_RB3D_DEPTHOFFSET</span> <span class="o">-</span> <span class="n">RADEON_PP_MISC</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid depth buffer offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">have_z_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CNTL</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="p">(</span><span class="n">RADEON_RB3D_COLOROFFSET</span> <span class="o">-</span> <span class="n">RADEON_PP_CNTL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid colour buffer offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXOFFSET_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXOFFSET_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXOFFSET_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXOFFSET_3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXOFFSET_4</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXOFFSET_5</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid R200 texture offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_TXFILTER_0</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_TXFILTER_1</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_TXFILTER_2</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="p">(</span><span class="n">RADEON_PP_TXOFFSET_0</span> <span class="o">-</span> <span class="n">RADEON_PP_TXFILTER_0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid R100 texture offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_OFFSETS_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_OFFSETS_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_OFFSETS_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_OFFSETS_3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_OFFSETS_4</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_OFFSETS_5</span>:<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
								  <span class="n">file_priv</span><span class="p">,</span>
								  <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span>
					    <span class="p">(</span><span class="s">&quot;Invalid R200 cubic texture offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CUBIC_OFFSETS_T0</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CUBIC_OFFSETS_T1</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CUBIC_OFFSETS_T2</span>:<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
								  <span class="n">file_priv</span><span class="p">,</span>
								  <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span>
					    <span class="p">(</span><span class="s">&quot;Invalid R100 cubic texture offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">R200_EMIT_VAP_CTL</span>:<span class="p">{</span>
			<span class="n">RING_LOCALS</span><span class="p">;</span>
			<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_SE_TCL_STATE_FLUSH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_EMIT_RB3D_COLORPITCH</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_RE_LINE_PATTERN</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_LINE_WIDTH</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_LUM_MATRIX</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_ROT_MATRIX_0</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_RB3D_STENCILREFMASK</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_VPORT_XSCALE</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_CNTL</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_CNTL_STATUS</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_RE_MISC</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_BORDER_COLOR_0</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_BORDER_COLOR_1</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_BORDER_COLOR_2</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_ZBIAS_FACTOR</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_TCL_OUTPUT_VTX_FMT</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_SE_TCL_MATERIAL_EMMISSIVE_RED</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_4</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_5</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_6</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCBLEND_7</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_TCL_LIGHT_MODEL_CTL_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_TFACTOR_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_VTX_FMT_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_MATRIX_SELECT_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_TEX_PROC_CTL_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_TCL_UCP_VERT_BLEND_CTL</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXFILTER_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXFILTER_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXFILTER_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXFILTER_3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXFILTER_4</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXFILTER_5</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_VTE_CNTL</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_OUTPUT_VTX_COMP_SEL</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TAM_DEBUG3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CNTL_X</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RB3D_DEPTHXY_OFFSET</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RE_AUX_SCISSOR_CNTL</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RE_SCISSOR_TL_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RE_SCISSOR_TL_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RE_SCISSOR_TL_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_SE_VAP_CNTL_STATUS</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_SE_VTX_STATE_CNTL</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RE_POINTSIZE</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_TCL_INPUT_VTX_VECTOR_ADDR_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_FACES_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_FACES_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_FACES_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_FACES_3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_FACES_4</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_CUBIC_FACES_5</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_TEX_SIZE_0</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_TEX_SIZE_1</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_TEX_SIZE_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_RB3D_BLENDCOLOR</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_TCL_POINT_SPRITE_CNTL</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CUBIC_FACES_0</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CUBIC_FACES_1</span>:
	<span class="k">case</span> <span class="n">RADEON_EMIT_PP_CUBIC_FACES_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TRI_PERF_CNTL</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_AFS_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_AFS_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_ATF_TFACTOR</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCTLALL_0</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCTLALL_1</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCTLALL_2</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCTLALL_3</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCTLALL_4</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_PP_TXCTLALL_5</span>:
	<span class="k">case</span> <span class="n">R200_EMIT_VAP_PVS_CNTL</span>:
		<span class="cm">/* These packets don&#39;t contain memory offsets */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown state packet ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_check_and_fixup_packet3</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span>
					  <span class="n">dev_priv</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
					  <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span>
					  <span class="n">cmdbuf</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cmdsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">narrays</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">RADEON_CP_PACKET_COUNT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cmdsz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xc0000000</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RADEON_CP_PACKET3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Not a type 3 packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="o">*</span><span class="n">cmdsz</span> <span class="o">&gt;</span> <span class="n">drm_buffer_unprocessed</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet size larger than size of data provided</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* XXX Are there old drivers needing other packets? */</span>

	<span class="k">case</span> <span class="n">RADEON_3D_DRAW_IMMD</span>:
	<span class="k">case</span> <span class="n">RADEON_3D_DRAW_VBUF</span>:
	<span class="k">case</span> <span class="n">RADEON_3D_DRAW_INDX</span>:
	<span class="k">case</span> <span class="n">RADEON_WAIT_FOR_IDLE</span>:
	<span class="k">case</span> <span class="n">RADEON_CP_NOP</span>:
	<span class="k">case</span> <span class="n">RADEON_3D_CLEAR_ZMASK</span>:
<span class="cm">/*	case RADEON_CP_NEXT_CHAR:</span>
<span class="cm">	case RADEON_CP_PLY_NEXTSCAN:</span>
<span class="cm">	case RADEON_CP_SET_SCISSORS: */</span> <span class="cm">/* probably safe but will never need them? */</span>
		<span class="cm">/* these packets are safe */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_CP_3D_DRAW_IMMD_2</span>:
	<span class="k">case</span> <span class="n">RADEON_CP_3D_DRAW_VBUF_2</span>:
	<span class="k">case</span> <span class="n">RADEON_CP_3D_DRAW_INDX_2</span>:
	<span class="k">case</span> <span class="n">RADEON_3D_CLEAR_HIZ</span>:
		<span class="cm">/* safe but r200 only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">!=</span> <span class="n">UCODE_R200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid 3d packet for r100-class chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_3D_LOAD_VBPNTR</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 12 arrays max */</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Too large payload in 3D_LOAD_VBPNTR (count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">count</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* carefully check packet contents */</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">narrays</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc000</span><span class="p">;</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">narrays</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* skip attribute field */</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
							  <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;Invalid offset (k=%d i=%d) in 3D_LOAD_VBPNTR packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">k</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">narrays</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* have one more to process, they come in pairs */</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
							  <span class="n">file_priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">DRM_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;Invalid offset (k=%d i=%d) in 3D_LOAD_VBPNTR packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">k</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* do the counts match what we expect ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">!=</span> <span class="n">narrays</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span>
			    <span class="p">(</span><span class="s">&quot;Malformed 3D_LOAD_VBPNTR packet (k=%d i=%d narrays=%d count+1=%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">narrays</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_3D_RNDR_GEN_INDX_PRIM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">!=</span> <span class="n">UCODE_R100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid 3d packet for r200-class chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid rndr_gen_indx offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_CP_INDX_BUFFER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">!=</span> <span class="n">UCODE_R200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid 3d packet for r100-class chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x8000ffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80000810</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid indx_buffer reg address %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid indx_buffer offset is %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RADEON_CNTL_HOSTDATA_BLT</span>:
	<span class="k">case</span> <span class="n">RADEON_CNTL_PAINT_MULTI</span>:
	<span class="k">case</span> <span class="n">RADEON_CNTL_BITBLT_MULTI</span>:
		<span class="cm">/* MSB of opcode: next DWORD GUI_CNTL */</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_GMC_SRC_PITCH_OFFSET_CNTL</span>
			      <span class="o">|</span> <span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">cmd2</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmd2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span>
			    <span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid first packet offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">cmd2</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd2</span> <span class="o">&amp;</span> <span class="mh">0xffc00000</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">RADEON_GMC_SRC_PITCH_OFFSET_CNTL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">cmd3</span> <span class="o">=</span> <span class="n">drm_buffer_pointer_to_dword</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmd3</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span>
			    <span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid second packet offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">cmd3</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd3</span> <span class="o">&amp;</span> <span class="mh">0xffc00000</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid packet type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * CP hardware state programming functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_emit_clip_rect</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span> <span class="n">box</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   box:  x1=%d y1=%d  x2=%d y2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">);</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RE_TOP_LEFT</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RE_WIDTH_HEIGHT</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Emit 1.1 state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_emit_state</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
			     <span class="n">drm_radeon_context_regs_t</span> <span class="o">*</span> <span class="n">ctx</span><span class="p">,</span>
			     <span class="n">drm_radeon_texture_regs_t</span> <span class="o">*</span> <span class="n">tex</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dirty=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dirty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_CONTEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_depthoffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid depth buffer offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_coloroffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid depth buffer offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_MISC</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pp_misc</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pp_fog_color</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">re_solid_color</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_blendcntl</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_depthoffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_depthpitch</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_zstencilcntl</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_CNTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pp_cntl</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_cntl</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_coloroffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RB3D_COLORPITCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_colorpitch</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_VERTFMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_COORD_FMT</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_coord_fmt</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_LINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RE_LINE_PATTERN</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">re_line_pattern</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">re_line_state</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_LINE_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_line_width</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_BUMPMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_LUM_MATRIX</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pp_lum_matrix</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_ROT_MATRIX_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pp_rot_matrix_0</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pp_rot_matrix_1</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_MASKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RB3D_STENCILREFMASK</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_stencilrefmask</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_ropcntl</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rb3d_planemask</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_VIEWPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_VPORT_XSCALE</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_vport_xscale</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_vport_xoffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_vport_yscale</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_vport_yoffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_vport_zscale</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_vport_zoffset</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_cntl</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_CNTL_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">se_cntl_status</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_MISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RE_MISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">re_misc</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_TEX0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_txoffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid texture offset for unit 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_TXFILTER_0</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_txfilter</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_txformat</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_txoffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_txcblend</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_txablend</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_tfactor</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_BORDER_COLOR_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pp_border_color</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_TEX1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_txoffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid texture offset for unit 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_TXFILTER_1</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_txfilter</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_txformat</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_txoffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_txcblend</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_txablend</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_tfactor</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_BORDER_COLOR_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pp_border_color</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_TEX2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_txoffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid texture offset for unit 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_TXFILTER_2</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_txfilter</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_txformat</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_txoffset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_txcblend</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_txablend</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_tfactor</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_BORDER_COLOR_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tex</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pp_border_color</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Emit 1.2 state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_emit_state2</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
			      <span class="n">drm_radeon_state_t</span> <span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">RADEON_UPLOAD_ZBIAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_ZBIAS_FACTOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">.</span><span class="n">se_zbias_factor</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">.</span><span class="n">se_zbias_constant</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">radeon_emit_state</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
				 <span class="n">state</span><span class="o">-&gt;</span><span class="n">tex</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* New (1.3) state mechanism.  3 commands (packet, scalar, vector) in</span>
<span class="cm"> * 1.3 cmdbuffers allow all previous state to be updated as well as</span>
<span class="cm"> * the tcl scalar and vector areas.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">packet</span><span class="p">[</span><span class="n">RADEON_MAX_STATE_PACKETS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">RADEON_PP_MISC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_MISC&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CNTL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_RB3D_COLORPITCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_RB3D_COLORPITCH&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_RE_LINE_PATTERN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_RE_LINE_PATTERN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_LINE_WIDTH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_SE_LINE_WIDTH&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_LUM_MATRIX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_LUM_MATRIX&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_ROT_MATRIX_0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_ROT_MATRIX_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_RB3D_STENCILREFMASK</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;RADEON_RB3D_STENCILREFMASK&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_VPORT_XSCALE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;RADEON_SE_VPORT_XSCALE&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_CNTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_SE_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_CNTL_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_SE_CNTL_STATUS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_RE_MISC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_RE_MISC&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_TXFILTER_0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_TXFILTER_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_BORDER_COLOR_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_BORDER_COLOR_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_TXFILTER_1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_TXFILTER_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_BORDER_COLOR_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_BORDER_COLOR_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_TXFILTER_2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_TXFILTER_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_BORDER_COLOR_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_BORDER_COLOR_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_ZBIAS_FACTOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_SE_ZBIAS_FACTOR&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_TCL_OUTPUT_VTX_FMT</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&quot;RADEON_SE_TCL_OUTPUT_VTX_FMT&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_SE_TCL_MATERIAL_EMMISSIVE_RED</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
		    <span class="s">&quot;RADEON_SE_TCL_MATERIAL_EMMISSIVE_RED&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_6&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXCBLEND_7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCBLEND_7&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_LIGHT_MODEL_CTL_0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_SE_TCL_LIGHT_MODEL_CTL_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TFACTOR_0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TFACTOR_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_VTX_FMT_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;R200_SE_VTX_FMT_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_VAP_CNTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_SE_VAP_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_MATRIX_SEL_0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_SE_TCL_MATRIX_SEL_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_TEX_PROC_CTL_2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_SE_TCL_TEX_PROC_CTL_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_UCP_VERT_BLEND_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_SE_TCL_UCP_VERT_BLEND_CTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXFILTER_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXFILTER_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXFILTER_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXFILTER_3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXFILTER_4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXFILTER_5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXOFFSET_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXOFFSET_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXOFFSET_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXOFFSET_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXOFFSET_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXOFFSET_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXOFFSET_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXOFFSET_3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXOFFSET_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXOFFSET_4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXOFFSET_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXOFFSET_5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_VTE_CNTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_SE_VTE_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_OUTPUT_VTX_COMP_SEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="s">&quot;R200_SE_TCL_OUTPUT_VTX_COMP_SEL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TAM_DEBUG3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_TAM_DEBUG3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CNTL_X</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CNTL_X&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RB3D_DEPTHXY_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_RB3D_DEPTHXY_OFFSET&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RE_AUX_SCISSOR_CNTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_RE_AUX_SCISSOR_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RE_SCISSOR_TL_0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;R200_RE_SCISSOR_TL_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RE_SCISSOR_TL_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;R200_RE_SCISSOR_TL_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RE_SCISSOR_TL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;R200_RE_SCISSOR_TL_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_VAP_CNTL_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_SE_VAP_CNTL_STATUS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_VTX_STATE_CNTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_SE_VTX_STATE_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RE_POINTSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_RE_POINTSIZE&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_INPUT_VTX_VECTOR_ADDR_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		    <span class="s">&quot;R200_SE_TCL_INPUT_VTX_VECTOR_ADDR_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_FACES_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_FACES_0&quot;</span><span class="p">},</span>	<span class="cm">/* 61 */</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_OFFSET_F1_0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_OFFSET_F1_0&quot;</span><span class="p">},</span> <span class="cm">/* 62 */</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_FACES_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_FACES_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_OFFSET_F1_1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_OFFSET_F1_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_FACES_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_FACES_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_OFFSET_F1_2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_OFFSET_F1_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_FACES_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_FACES_3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_OFFSET_F1_3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_OFFSET_F1_3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_FACES_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_FACES_4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_OFFSET_F1_4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_OFFSET_F1_4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_FACES_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_FACES_5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_CUBIC_OFFSET_F1_5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;R200_PP_CUBIC_OFFSET_F1_5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_TEX_SIZE_0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_TEX_SIZE_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_TEX_SIZE_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_TEX_SIZE_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_TEX_SIZE_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_TEX_SIZE_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_RB3D_BLENDCOLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;R200_RB3D_BLENDCOLOR&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_SE_TCL_POINT_SPRITE_CNTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;R200_SE_TCL_POINT_SPRITE_CNTL&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CUBIC_FACES_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CUBIC_FACES_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CUBIC_OFFSET_T0_0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CUBIC_OFFSET_T0_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CUBIC_FACES_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CUBIC_FACES_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CUBIC_OFFSET_T1_0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CUBIC_OFFSET_T1_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CUBIC_FACES_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CUBIC_FACES_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RADEON_PP_CUBIC_OFFSET_T2_0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;RADEON_PP_CUBIC_OFFSET_T2_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TRI_PERF</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;R200_PP_TRI_PERF&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_AFS_0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;R200_PP_AFS_0&quot;</span><span class="p">},</span>     <span class="cm">/* 85 */</span>
	<span class="p">{</span><span class="n">R200_PP_AFS_1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;R200_PP_AFS_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TFACTOR_0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_ATF_TFACTOR&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCTLALL_0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCTLALL_1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCTLALL_2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCTLALL_3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCTLALL_4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_PP_TXFILTER_5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;R200_PP_TXCTLALL_5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R200_VAP_PVS_CNTL_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;R200_VAP_PVS_CNTL&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Performance monitoring functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_clear_box</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">color</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">+=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x1</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">+=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">y1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_COLOR_FORMAT_RGB565</span>:
		<span class="n">color</span> <span class="o">=</span> <span class="p">(((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">g</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_COLOR_FORMAT_ARGB8888</span>:
	<span class="nl">default:</span>
		<span class="n">color</span> <span class="o">=</span> <span class="p">(((</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">b</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_DP_WRITE_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">RADEON_CNTL_PAINT_MULTI</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
		 <span class="n">RADEON_GMC_BRUSH_SOLID_COLOR</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">RADEON_GMC_SRC_DATATYPE_COLOR</span> <span class="o">|</span>
		 <span class="n">RADEON_ROP3_P</span> <span class="o">|</span> <span class="n">RADEON_GMC_CLR_CMP_CNTL_DIS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>

	<span class="n">OUT_RING</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">((</span><span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_performance_boxes</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Collapse various things into a wait flag -- trying to</span>
<span class="cm">	 * guess if userspase slept -- better just to have them tell us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">last_frame_reads</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">last_clear_reads</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">clears</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">freelist_loops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Purple box for page flipping</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">&amp;</span> <span class="n">RADEON_BOX_FLIP</span><span class="p">)</span>
		<span class="n">radeon_clear_box</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

	<span class="cm">/* Red box if we have to wait for idle at any point</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">&amp;</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">)</span>
		<span class="n">radeon_clear_box</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Blue box: lost context?</span>
<span class="cm">	 */</span>

	<span class="cm">/* Yellow box for texture swaps</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">&amp;</span> <span class="n">RADEON_BOX_TEXTURE_LOAD</span><span class="p">)</span>
		<span class="n">radeon_clear_box</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Green box if hardware never idles (as far as we can tell)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">&amp;</span> <span class="n">RADEON_BOX_DMA_IDLE</span><span class="p">))</span>
		<span class="n">radeon_clear_box</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Draw bars indicating number of buffers allocated</span>
<span class="cm">	 * (not a great measure, easily confused)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">requested_bufs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">requested_bufs</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">requested_bufs</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">radeon_clear_box</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
				 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">requested_bufs</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				 <span class="mi">196</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * CP command dispatch functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_dispatch_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
				     <span class="n">drm_radeon_clear_t</span> <span class="o">*</span> <span class="n">clear</span><span class="p">,</span>
				     <span class="n">drm_radeon_clear_rect_t</span> <span class="o">*</span> <span class="n">depth_boxes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_depth_clear_t</span> <span class="o">*</span><span class="n">depth_clear</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_clear</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">pbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rb3d_cntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rb3d_stencilrefmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;flags = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">clears</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RADEON_FRONT</span> <span class="o">|</span> <span class="n">RADEON_BACK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RADEON_FRONT</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_BACK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RADEON_BACK</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_FRONT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_DEPTH</span><span class="o">|</span><span class="n">RADEON_STENCIL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">have_z_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeon: illegal depth clear request. Buggy mesa detected - please update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RADEON_DEPTH</span> <span class="o">|</span> <span class="n">RADEON_STENCIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_FRONT</span> <span class="o">|</span> <span class="n">RADEON_BACK</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Ensure the 3D stream is idle before doing a</span>
<span class="cm">		 * 2D fill to clear the front or back buffer.</span>
<span class="cm">		 */</span>
		<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_DP_WRITE_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">color_mask</span><span class="p">);</span>

		<span class="n">ADVANCE_RING</span><span class="p">();</span>

		<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">		 */</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">ctx_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y</span><span class="p">;</span>

			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;%d,%d-%d,%d flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FRONT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span>
					 <span class="p">(</span><span class="n">RADEON_CNTL_PAINT_MULTI</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
					 <span class="n">RADEON_GMC_BRUSH_SOLID_COLOR</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span>
					  <span class="n">color_fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">RADEON_GMC_SRC_DATATYPE_COLOR</span> <span class="o">|</span>
					 <span class="n">RADEON_ROP3_P</span> <span class="o">|</span>
					 <span class="n">RADEON_GMC_CLR_CMP_CNTL_DIS</span><span class="p">);</span>

				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span><span class="p">);</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">clear_color</span><span class="p">);</span>

				<span class="n">OUT_RING</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span><span class="p">);</span>
				<span class="n">OUT_RING</span><span class="p">((</span><span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">h</span><span class="p">);</span>

				<span class="n">ADVANCE_RING</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_BACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span>
					 <span class="p">(</span><span class="n">RADEON_CNTL_PAINT_MULTI</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
					 <span class="n">RADEON_GMC_BRUSH_SOLID_COLOR</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span>
					  <span class="n">color_fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">RADEON_GMC_SRC_DATATYPE_COLOR</span> <span class="o">|</span>
					 <span class="n">RADEON_ROP3_P</span> <span class="o">|</span>
					 <span class="n">RADEON_GMC_CLR_CMP_CNTL_DIS</span><span class="p">);</span>

				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span><span class="p">);</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">clear_color</span><span class="p">);</span>

				<span class="n">OUT_RING</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span><span class="p">);</span>
				<span class="n">OUT_RING</span><span class="p">((</span><span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">h</span><span class="p">);</span>

				<span class="n">ADVANCE_RING</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* hyper z clear */</span>
	<span class="cm">/* no docs available, based on reverse engineering by Stephane Marchesin */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_DEPTH</span> <span class="o">|</span> <span class="n">RADEON_STENCIL</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CLEAR_FASTZ</span><span class="p">))</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">depthpixperline</span> <span class="o">=</span>
		    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_fmt</span> <span class="o">==</span>
		    <span class="n">RADEON_DEPTH_FORMAT_16BIT_INT_Z</span> <span class="o">?</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_pitch</span> <span class="o">/</span>
						       <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span>
							     <span class="n">depth_pitch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">u32</span> <span class="n">clearmask</span><span class="p">;</span>

		<span class="n">u32</span> <span class="n">tempRB3D_DEPTHCLEARVALUE</span> <span class="o">=</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">clear_depth</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">depth_mask</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">		 * we haven&#39;t touched any &quot;normal&quot; state - still need this?</span>
<span class="cm">		 */</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">ctx_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_HAS_HIERZ</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_USE_HIERZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* FIXME : reverse engineer that for Rx00 cards */</span>
			<span class="cm">/* FIXME : the mask supposedly contains low-res z values. So can&#39;t set</span>
<span class="cm">			   just to the max (0xff? or actually 0x3fff?), need to take z clear</span>
<span class="cm">			   value into account? */</span>
			<span class="cm">/* pattern seems to work for r100, though get slight</span>
<span class="cm">			   rendering errors with glxgears. If hierz is not enabled for r100,</span>
<span class="cm">			   only 4 bits which indicate clear (15,16,31,32, all zero) matter, the</span>
<span class="cm">			   other ones are ignored, and the same clear mask can be used. That&#39;s</span>
<span class="cm">			   very different behaviour than R200 which needs different clear mask</span>
<span class="cm">			   and different number of tiles to clear if hierz is enabled or not !?!</span>
<span class="cm">			 */</span>
			<span class="n">clearmask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x003f003f</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* clear mask : chooses the clearing pattern.</span>
<span class="cm">			   rv250: could be used to clear only parts of macrotiles</span>
<span class="cm">			   (but that would get really complicated...)?</span>
<span class="cm">			   bit 0 and 1 (either or both of them ?!?!) are used to</span>
<span class="cm">			   not clear tile (or maybe one of the bits indicates if the tile is</span>
<span class="cm">			   compressed or not), bit 2 and 3 to not clear tile 1,...,.</span>
<span class="cm">			   Pattern is as follows:</span>
<span class="cm">			   | 0,1 | 4,5 | 8,9 |12,13|16,17|20,21|24,25|28,29|</span>
<span class="cm">			   bits -------------------------------------------------</span>
<span class="cm">			   | 2,3 | 6,7 |10,11|14,15|18,19|22,23|26,27|30,31|</span>
<span class="cm">			   rv100: clearmask covers 2x8 4x1 tiles, but one clear still</span>
<span class="cm">			   covers 256 pixels ?!?</span>
<span class="cm">			 */</span>
			<span class="n">clearmask</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_DEPTHCLEARVALUE</span><span class="p">,</span>
			     <span class="n">tempRB3D_DEPTHCLEARVALUE</span><span class="p">);</span>
		<span class="cm">/* what offset is this exactly ? */</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_ZMASKOFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* need ctlstat, otherwise get some strange black flickering */</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_ZCACHE_CTLSTAT</span><span class="p">,</span>
			     <span class="n">RADEON_RB3D_ZC_FLUSH_ALL</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tileoffset</span><span class="p">,</span> <span class="n">nrtilesx</span><span class="p">,</span> <span class="n">nrtilesy</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
			<span class="cm">/* it looks like r200 needs rv-style clears, at least if hierz is not enabled? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_HAS_HIERZ</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">==</span> <span class="n">UCODE_R200</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* FIXME : figure this out for r200 (when hierz is enabled). Or</span>
<span class="cm">				   maybe r200 actually doesn&#39;t need to put the low-res z value into</span>
<span class="cm">				   the tile cache like r100, but just needs to clear the hi-level z-buffer?</span>
<span class="cm">				   Works for R100, both with hierz and without.</span>
<span class="cm">				   R100 seems to operate on 2x1 8x8 tiles, but...</span>
<span class="cm">				   odd: offset/nrtiles need to be 64 pix (4 block) aligned? Potentially</span>
<span class="cm">				   problematic with resolutions which are not 64 pix aligned? */</span>
				<span class="n">tileoffset</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">depthpixperline</span> <span class="o">+</span>
				     <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">nrtilesx</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">)</span> <span class="o">-</span>
				     <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">nrtilesy</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">nrtilesy</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span>
						 <span class="p">(</span><span class="n">RADEON_3D_CLEAR_ZMASK</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
					<span class="cm">/* first tile */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tileoffset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="cm">/* the number of tiles to clear */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">nrtilesx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
					<span class="cm">/* clear mask : chooses the clearing pattern. */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">clearmask</span><span class="p">);</span>
					<span class="n">ADVANCE_RING</span><span class="p">();</span>
					<span class="n">tileoffset</span> <span class="o">+=</span> <span class="n">depthpixperline</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">==</span> <span class="n">UCODE_R200</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* works for rv250. */</span>
				<span class="cm">/* find first macro tile (8x2 4x4 z-pixels on rv250) */</span>
				<span class="n">tileoffset</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">depthpixperline</span> <span class="o">+</span>
				     <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">nrtilesx</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
				<span class="n">nrtilesy</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">nrtilesy</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span>
						 <span class="p">(</span><span class="n">RADEON_3D_CLEAR_ZMASK</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
					<span class="cm">/* first tile */</span>
					<span class="cm">/* judging by the first tile offset needed, could possibly</span>
<span class="cm">					   directly address/clear 4x4 tiles instead of 8x2 * 4x4</span>
<span class="cm">					   macro tiles, though would still need clear mask for</span>
<span class="cm">					   right/bottom if truly 4x4 granularity is desired ? */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tileoffset</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
					<span class="cm">/* the number of tiles to clear */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">nrtilesx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="cm">/* clear mask : chooses the clearing pattern. */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">clearmask</span><span class="p">);</span>
					<span class="n">ADVANCE_RING</span><span class="p">();</span>
					<span class="n">tileoffset</span> <span class="o">+=</span> <span class="n">depthpixperline</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* rv 100 */</span>
				<span class="cm">/* rv100 might not need 64 pix alignment, who knows */</span>
				<span class="cm">/* offsets are, hmm, weird */</span>
				<span class="n">tileoffset</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">depthpixperline</span> <span class="o">+</span>
				     <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">nrtilesx</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">)</span> <span class="o">-</span>
				     <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">nrtilesy</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">nrtilesy</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span>
						 <span class="p">(</span><span class="n">RADEON_3D_CLEAR_ZMASK</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">tileoffset</span> <span class="o">*</span> <span class="mi">128</span><span class="p">);</span>
					<span class="cm">/* the number of tiles to clear */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">nrtilesx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
					<span class="cm">/* clear mask : chooses the clearing pattern. */</span>
					<span class="n">OUT_RING</span><span class="p">(</span><span class="n">clearmask</span><span class="p">);</span>
					<span class="n">ADVANCE_RING</span><span class="p">();</span>
					<span class="n">tileoffset</span> <span class="o">+=</span> <span class="n">depthpixperline</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* TODO don&#39;t always clear all hi-level z tiles */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_HAS_HIERZ</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">==</span> <span class="n">UCODE_R200</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_USE_HIERZ</span><span class="p">))</span>
			<span class="cm">/* r100 and cards without hierarchical z-buffer have no high-level z-buffer */</span>
			<span class="cm">/* FIXME : the mask supposedly contains low-res z values. So can&#39;t set</span>
<span class="cm">			   just to the max (0xff? or actually 0x3fff?), need to take z clear</span>
<span class="cm">			   value into account? */</span>
		<span class="p">{</span>
			<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">RADEON_3D_CLEAR_HIZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>	<span class="cm">/* First tile */</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x3cc0</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">((</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x003f003f</span><span class="p">);</span>
			<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We have to clear the depth and/or stencil buffers by</span>
<span class="cm">	 * rendering a quad into just those buffers.  Thus, we have to</span>
<span class="cm">	 * make sure the 3D engine is configured correctly.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">==</span> <span class="n">UCODE_R200</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_DEPTH</span> <span class="o">|</span> <span class="n">RADEON_STENCIL</span><span class="p">)))</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">tempPP_CNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempRE_CNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempRB3D_CNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempRB3D_ZSTENCILCNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempRB3D_STENCILREFMASK</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempRB3D_PLANEMASK</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempSE_CNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempSE_VTE_CNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempSE_VTX_FMT_0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempSE_VTX_FMT_1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempSE_VAP_CNTL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tempRE_AUX_SCISSOR_CNTL</span><span class="p">;</span>

		<span class="n">tempPP_CNTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tempRE_CNTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tempRB3D_CNTL</span> <span class="o">=</span> <span class="n">depth_clear</span><span class="o">-&gt;</span><span class="n">rb3d_cntl</span><span class="p">;</span>

		<span class="n">tempRB3D_ZSTENCILCNTL</span> <span class="o">=</span> <span class="n">depth_clear</span><span class="o">-&gt;</span><span class="n">rb3d_zstencilcntl</span><span class="p">;</span>
		<span class="n">tempRB3D_STENCILREFMASK</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="n">tempSE_CNTL</span> <span class="o">=</span> <span class="n">depth_clear</span><span class="o">-&gt;</span><span class="n">se_cntl</span><span class="p">;</span>

		<span class="cm">/* Disable TCL */</span>

		<span class="n">tempSE_VAP_CNTL</span> <span class="o">=</span> <span class="p">(</span>	<span class="cm">/* SE_VAP_CNTL__FORCE_W_TO_ONE_MASK |  */</span>
					  <span class="p">(</span><span class="mh">0x9</span> <span class="o">&lt;&lt;</span>
					   <span class="n">SE_VAP_CNTL__VF_MAX_VTX_NUM__SHIFT</span><span class="p">));</span>

		<span class="n">tempRB3D_PLANEMASK</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="n">tempRE_AUX_SCISSOR_CNTL</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="n">tempSE_VTE_CNTL</span> <span class="o">=</span>
		    <span class="n">SE_VTE_CNTL__VTX_XY_FMT_MASK</span> <span class="o">|</span> <span class="n">SE_VTE_CNTL__VTX_Z_FMT_MASK</span><span class="p">;</span>

		<span class="cm">/* Vertex format (X, Y, Z, W) */</span>
		<span class="n">tempSE_VTX_FMT_0</span> <span class="o">=</span>
		    <span class="n">SE_VTX_FMT_0__VTX_Z0_PRESENT_MASK</span> <span class="o">|</span>
		    <span class="n">SE_VTX_FMT_0__VTX_W0_PRESENT_MASK</span><span class="p">;</span>
		<span class="n">tempSE_VTX_FMT_1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Depth buffer specific enables</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable depth buffer */</span>
			<span class="n">tempRB3D_CNTL</span> <span class="o">|=</span> <span class="n">RADEON_Z_ENABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Disable depth buffer */</span>
			<span class="n">tempRB3D_CNTL</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_Z_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Stencil buffer specific enables</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_STENCIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempRB3D_CNTL</span> <span class="o">|=</span> <span class="n">RADEON_STENCIL_ENABLE</span><span class="p">;</span>
			<span class="n">tempRB3D_STENCILREFMASK</span> <span class="o">=</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">depth_mask</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tempRB3D_CNTL</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_STENCIL_ENABLE</span><span class="p">;</span>
			<span class="n">tempRB3D_STENCILREFMASK</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_USE_COMP_ZBUF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempRB3D_ZSTENCILCNTL</span> <span class="o">|=</span> <span class="n">RADEON_Z_COMPRESSION_ENABLE</span> <span class="o">|</span>
			    <span class="n">RADEON_Z_DECOMPRESSION_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_USE_HIERZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempRB3D_ZSTENCILCNTL</span> <span class="o">|=</span> <span class="n">RADEON_Z_HIERARCHY_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">26</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>

		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_PP_CNTL</span><span class="p">,</span> <span class="n">tempPP_CNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">R200_RE_CNTL</span><span class="p">,</span> <span class="n">tempRE_CNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_CNTL</span><span class="p">,</span> <span class="n">tempRB3D_CNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_ZSTENCILCNTL</span><span class="p">,</span> <span class="n">tempRB3D_ZSTENCILCNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_STENCILREFMASK</span><span class="p">,</span>
			     <span class="n">tempRB3D_STENCILREFMASK</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_PLANEMASK</span><span class="p">,</span> <span class="n">tempRB3D_PLANEMASK</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_SE_CNTL</span><span class="p">,</span> <span class="n">tempSE_CNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">R200_SE_VTE_CNTL</span><span class="p">,</span> <span class="n">tempSE_VTE_CNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">R200_SE_VTX_FMT_0</span><span class="p">,</span> <span class="n">tempSE_VTX_FMT_0</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">R200_SE_VTX_FMT_1</span><span class="p">,</span> <span class="n">tempSE_VTX_FMT_1</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">R200_SE_VAP_CNTL</span><span class="p">,</span> <span class="n">tempSE_VAP_CNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">R200_RE_AUX_SCISSOR_CNTL</span><span class="p">,</span> <span class="n">tempRE_AUX_SCISSOR_CNTL</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>

		<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">		 */</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">ctx_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Funny that this should be required --</span>
<span class="cm">			 *  sets top-left?</span>
<span class="cm">			 */</span>
			<span class="n">radeon_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">R200_3D_DRAW_IMMD_2</span><span class="p">,</span> <span class="mi">12</span><span class="p">));</span>
			<span class="n">OUT_RING</span><span class="p">((</span><span class="n">RADEON_PRIM_TYPE_RECT_LIST</span> <span class="o">|</span>
				  <span class="n">RADEON_PRIM_WALK_RING</span> <span class="o">|</span>
				  <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_NUM_VERTICES_SHIFT</span><span class="p">)));</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_X1</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_Y1</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_DEPTH</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x3f800000</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_X1</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_Y2</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_DEPTH</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x3f800000</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_X2</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_Y2</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_DEPTH</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x3f800000</span><span class="p">);</span>
			<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_DEPTH</span> <span class="o">|</span> <span class="n">RADEON_STENCIL</span><span class="p">)))</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">tempRB3D_ZSTENCILCNTL</span> <span class="o">=</span> <span class="n">depth_clear</span><span class="o">-&gt;</span><span class="n">rb3d_zstencilcntl</span><span class="p">;</span>

		<span class="n">rb3d_cntl</span> <span class="o">=</span> <span class="n">depth_clear</span><span class="o">-&gt;</span><span class="n">rb3d_cntl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rb3d_cntl</span> <span class="o">|=</span> <span class="n">RADEON_Z_ENABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rb3d_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_Z_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_STENCIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rb3d_cntl</span> <span class="o">|=</span> <span class="n">RADEON_STENCIL_ENABLE</span><span class="p">;</span>
			<span class="n">rb3d_stencilrefmask</span> <span class="o">=</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">depth_mask</span><span class="p">;</span>	<span class="cm">/* misnamed field */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rb3d_cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_STENCIL_ENABLE</span><span class="p">;</span>
			<span class="n">rb3d_stencilrefmask</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_USE_COMP_ZBUF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempRB3D_ZSTENCILCNTL</span> <span class="o">|=</span> <span class="n">RADEON_Z_COMPRESSION_ENABLE</span> <span class="o">|</span>
			    <span class="n">RADEON_Z_DECOMPRESSION_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_USE_HIERZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempRB3D_ZSTENCILCNTL</span> <span class="o">|=</span> <span class="n">RADEON_Z_HIERARCHY_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_PP_CNTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">rb3d_cntl</span><span class="p">);</span>

		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_ZSTENCILCNTL</span><span class="p">,</span> <span class="n">tempRB3D_ZSTENCILCNTL</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_STENCILREFMASK</span><span class="p">,</span> <span class="n">rb3d_stencilrefmask</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_RB3D_PLANEMASK</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_SE_CNTL</span><span class="p">,</span> <span class="n">depth_clear</span><span class="o">-&gt;</span><span class="n">se_cntl</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>

		<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">		 */</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">ctx_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Funny that this should be required --</span>
<span class="cm">			 *  sets top-left?</span>
<span class="cm">			 */</span>
			<span class="n">radeon_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">RADEON_3D_DRAW_IMMD</span><span class="p">,</span> <span class="mi">13</span><span class="p">));</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_VTX_Z_PRESENT</span> <span class="o">|</span>
				 <span class="n">RADEON_VTX_PKCOLOR_PRESENT</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">((</span><span class="n">RADEON_PRIM_TYPE_RECT_LIST</span> <span class="o">|</span>
				  <span class="n">RADEON_PRIM_WALK_RING</span> <span class="o">|</span>
				  <span class="n">RADEON_MAOS_ENABLE</span> <span class="o">|</span>
				  <span class="n">RADEON_VTX_FMT_RADEON_MODE</span> <span class="o">|</span>
				  <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_NUM_VERTICES_SHIFT</span><span class="p">)));</span>

			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_X1</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_Y1</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_DEPTH</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>

			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_X1</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_Y2</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_DEPTH</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>

			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_X2</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_Y2</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ui</span><span class="p">[</span><span class="n">CLEAR_DEPTH</span><span class="p">]);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>

			<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Increment the clear counter.  The client-side 3D driver must</span>
<span class="cm">	 * wait on this value before performing the clear ioctl.  We</span>
<span class="cm">	 * need this because the card&#39;s so damned fast...</span>
<span class="cm">	 */</span>
	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_clear</span><span class="o">++</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">RADEON_CLEAR_AGE</span><span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_clear</span><span class="p">);</span>
	<span class="n">RADEON_WAIT_UNTIL_IDLE</span><span class="p">();</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_dispatch_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">pbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Do some trivial performance monitoring...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">do_boxes</span><span class="p">)</span>
		<span class="n">radeon_cp_performance_boxes</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">);</span>

	<span class="cm">/* Wait for the 3D stream to idle before dispatching the bitblt.</span>
<span class="cm">	 * This will prevent data corruption between the two streams.</span>
<span class="cm">	 */</span>
	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y</span><span class="p">;</span>

		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;%d,%d-%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_DP_GUI_MASTER_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_GMC_SRC_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_BRUSH_NONE</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_SRC_DATATYPE_COLOR</span> <span class="o">|</span>
			 <span class="n">RADEON_ROP3_S</span> <span class="o">|</span>
			 <span class="n">RADEON_DP_SRC_SOURCE_MEMORY</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_CLR_CMP_CNTL_DIS</span> <span class="o">|</span> <span class="n">RADEON_GMC_WR_MSK_DIS</span><span class="p">);</span>

		<span class="cm">/* Make this work even if front &amp; back are flipped:</span>
<span class="cm">		 */</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SRC_PITCH_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SRC_X_Y</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">h</span><span class="p">);</span>

		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Increment the frame counter.  The client-side 3D driver must</span>
<span class="cm">	 * throttle the framerate by waiting for this value before</span>
<span class="cm">	 * performing the swapbuffer ioctl.</span>
<span class="cm">	 */</span>
	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="o">++</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">RADEON_FRAME_AGE</span><span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">);</span>
	<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_cp_dispatch_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_sarea</span> <span class="o">*</span><span class="n">sarea</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_sarea</span> <span class="o">*</span><span class="p">)</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="o">?</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span> <span class="o">:</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pfCurrentPage=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span><span class="p">);</span>

	<span class="cm">/* Do some trivial performance monitoring...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">do_boxes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_FLIP</span><span class="p">;</span>
		<span class="n">radeon_cp_performance_boxes</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">master_priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the frame offsets for both CRTCs</span>
<span class="cm">	 */</span>
	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>
	<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_CRTC_OFFSET</span><span class="p">,</span>
		     <span class="p">((</span><span class="n">sarea</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span> <span class="o">+</span>
		       <span class="n">sarea</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span>
		     <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_CRTC2_OFFSET</span><span class="p">,</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">crtc2_base</span>
		     <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="cm">/* Increment the frame counter.  The client-side 3D driver must</span>
<span class="cm">	 * throttle the framerate by waiting for this value before</span>
<span class="cm">	 * performing the swapbuffer ioctl.</span>
<span class="cm">	 */</span>
	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="o">++</span><span class="p">;</span>
	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">=</span>
		<span class="mi">1</span> <span class="o">-</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">RADEON_FRAME_AGE</span><span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">);</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bad_prim_vertex_nr</span><span class="p">(</span><span class="kt">int</span> <span class="n">primitive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">primitive</span> <span class="o">&amp;</span> <span class="n">RADEON_PRIM_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_NONE</span>:
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_POINT</span>:
		<span class="k">return</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_LINE</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_LINE_STRIP</span>:
		<span class="k">return</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_TRI_LIST</span>:
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_3VRT_POINT_LIST</span>:
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_3VRT_LINE_LIST</span>:
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_RECT_LIST</span>:
		<span class="k">return</span> <span class="n">nr</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_TRI_FAN</span>:
	<span class="k">case</span> <span class="n">RADEON_PRIM_TYPE_TRI_STRIP</span>:
		<span class="k">return</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">finish</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numverts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vc_format</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_radeon_tcl_prim_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_dispatch_vertex</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
				      <span class="n">drm_radeon_tcl_prim_t</span> <span class="o">*</span> <span class="n">prim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numverts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">numverts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;hwprim 0x%x vfmt 0x%x %d..%d %d verts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span>
		  <span class="n">prim</span><span class="o">-&gt;</span><span class="n">vc_format</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">numverts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bad_prim_vertex_nr</span><span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">numverts</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad prim %x numverts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">numverts</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Emit the next cliprect */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="cm">/* Emit the vertex buffer rendering commands */</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">RADEON_3D_RNDR_GEN_INDX_PRIM</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">numverts</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">vc_format</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">|</span> <span class="n">RADEON_PRIM_WALK_LIST</span> <span class="o">|</span>
			 <span class="n">RADEON_COLOR_ORDER_RGBA</span> <span class="o">|</span>
			 <span class="n">RADEON_VTX_FMT_RADEON_MODE</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">numverts</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_NUM_VERTICES_SHIFT</span><span class="p">));</span>

		<span class="n">ADVANCE_RING</span><span class="p">();</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_cp_discard_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="o">++</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span><span class="p">;</span>

	<span class="cm">/* Emit the vertex buffer age */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">R600_DISPATCH_AGE</span><span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">RADEON_DISPATCH_AGE</span><span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_dispatch_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;buf=%d s=0x%x e=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span>
			      <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">start</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">dwords</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="cm">/* Indirect buffer data must be an even number of</span>
<span class="cm">		 * dwords, so if we&#39;ve been given an odd number we must</span>
<span class="cm">		 * pad the data with a Type-2 CP packet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwords</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span>
			    <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span>
			     <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="n">dwords</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">RADEON_CP_PACKET2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fire off the indirect buffer */</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_CP_IB_BASE</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dwords</span><span class="p">);</span>

		<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_dispatch_indices</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span> <span class="n">elt_buf</span><span class="p">,</span>
				       <span class="n">drm_radeon_tcl_prim_t</span> <span class="o">*</span> <span class="n">prim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span> <span class="o">+</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dwords</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">RADEON_INDEX_PRIM_OFFSET</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;hwprim 0x%x vfmt 0x%x %d..%d offset: %x nr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span>
		  <span class="n">prim</span><span class="o">-&gt;</span><span class="n">vc_format</span><span class="p">,</span>
		  <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">numverts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bad_prim_vertex_nr</span><span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad prim %x count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">finish</span> <span class="o">||</span> <span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer prim %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwords</span> <span class="o">=</span> <span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">finish</span> <span class="o">-</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">+</span>
			<span class="n">elt_buf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">RADEON_3D_RNDR_GEN_INDX_PRIM</span><span class="p">,</span> <span class="n">dwords</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">numverts</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">vc_format</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prim</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">|</span>
		   <span class="n">RADEON_PRIM_WALK_IND</span> <span class="o">|</span>
		   <span class="n">RADEON_COLOR_ORDER_RGBA</span> <span class="o">|</span>
		   <span class="n">RADEON_VTX_FMT_RADEON_MODE</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_NUM_VERTICES_SHIFT</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">)</span>
			<span class="n">radeon_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">radeon_cp_dispatch_indirect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">elt_buf</span><span class="p">,</span>
					    <span class="n">prim</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">prim</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">);</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#define RADEON_MAX_TEXTURE_SIZE RADEON_BUFFER_SIZE</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_dispatch_texture</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
				      <span class="n">drm_radeon_texture_t</span> <span class="o">*</span> <span class="n">tex</span><span class="p">,</span>
				      <span class="n">drm_radeon_tex_image_t</span> <span class="o">*</span> <span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">dwords</span><span class="p">,</span> <span class="n">tex_width</span><span class="p">,</span> <span class="n">blit_width</span><span class="p">,</span> <span class="n">spitch</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">texpitch</span><span class="p">,</span> <span class="n">microtile</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_offset</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid destination offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_TEXTURE_LOAD</span><span class="p">;</span>

	<span class="cm">/* Flush the pixel cache.  This ensures no pixel data gets mixed</span>
<span class="cm">	 * up with the texture data from the host data blit, otherwise</span>
<span class="cm">	 * part of the texture image may be corrupted.</span>
<span class="cm">	 */</span>
	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">RADEON_FLUSH_CACHE</span><span class="p">();</span>
	<span class="n">RADEON_WAIT_UNTIL_IDLE</span><span class="p">();</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="cm">/* The compiler won&#39;t optimize away a division by a variable,</span>
<span class="cm">	 * even if the only legal values are powers of two.  Thus, we&#39;ll</span>
<span class="cm">	 * use a shift instead.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_ARGB8888</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_RGBA8888</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">RADEON_COLOR_FORMAT_ARGB8888</span><span class="p">;</span>
		<span class="n">tex_width</span> <span class="o">=</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">blit_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_AI88</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_ARGB1555</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_RGB565</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_ARGB4444</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_VYUY422</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_YVYU422</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">RADEON_COLOR_FORMAT_RGB565</span><span class="p">;</span>
		<span class="n">tex_width</span> <span class="o">=</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">blit_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_I8</span>:
	<span class="k">case</span> <span class="n">RADEON_TXFORMAT_RGB332</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">RADEON_COLOR_FORMAT_CI8</span><span class="p">;</span>
		<span class="n">tex_width</span> <span class="o">=</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">blit_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;invalid texture format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spitch</span> <span class="o">=</span> <span class="n">blit_width</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spitch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">texpitch</span> <span class="o">=</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">texpitch</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RADEON_DST_TILE_MICRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">microtile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">texpitch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RADEON_DST_TILE_MICRO</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">);</span>
			<span class="cm">/* we got tiled coordinates, untile them */</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">microtile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* this might fail for zero-sized uploads - are those illegal? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_check_offset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span>
				<span class="n">blit_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid final destination offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;tex=%dx%d blit=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tex_width</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">blit_width</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;tex: ofs=0x%x p=%d f=%d x=%hd y=%hd w=%hd h=%hd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tex</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span>
			  <span class="n">image</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

		<span class="cm">/* Make a copy of some parameters in case we have to</span>
<span class="cm">		 * update them for a multi-pass texture blit.</span>
<span class="cm">		 */</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">blit_width</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">RADEON_MAX_TEXTURE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">RADEON_MAX_TEXTURE_SIZE</span> <span class="o">/</span> <span class="n">blit_width</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">blit_width</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">radeon_freelist_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">radeon_freelist_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">image</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Dispatch the indirect buffer.</span>
<span class="cm">		 */</span>
		<span class="n">buffer</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">dwords</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#define RADEON_COPY_MT(_buf, _data, _width) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (DRM_COPY_FROM_USER(_buf, _data, (_width))) {\</span>
<span class="cp">			DRM_ERROR(&quot;EFAULT on pad, %d bytes\n&quot;, (_width)); \</span>
<span class="cp">			return -EFAULT; \</span>
<span class="cp">		} \</span>
<span class="cp">	} while(0)</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">microtile</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* texture micro tiling in use, minimum texture width is thus 16 bytes.</span>
<span class="cm">			   however, we cannot use blitter directly for texture width &lt; 64 bytes,</span>
<span class="cm">			   since minimum tex pitch is 64 bytes and we need this to match</span>
<span class="cm">			   the texture width, otherwise the blitter will tile it wrong.</span>
<span class="cm">			   Thus, tiling manually in this case. Additionally, need to special</span>
<span class="cm">			   case tex height = 1, since our actual image will have height 2</span>
<span class="cm">			   and we need to ensure we don&#39;t read beyond the texture size</span>
<span class="cm">			   from user space. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">&gt;=</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">tex_width</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">tex_width</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
						       <span class="n">data</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">&gt;=</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">tex_width</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dwords</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tex_width</span><span class="p">);</span>
					<span class="n">buffer</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">data</span> <span class="o">+=</span> <span class="n">tex_width</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* TODO: make sure this works when not fitting in one buffer</span>
<span class="cm">				   (i.e. 32bytes x 2048...) */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">data</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">data</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">data</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">data</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">buffer</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tex_width</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Texture image width is larger than the minimum, so we</span>
<span class="cm">				 * can upload it directly.</span>
<span class="cm">				 */</span>
				<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dwords</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Texture image width is less than the minimum, so we</span>
<span class="cm">				 * need to pad out each image scanline to the minimum</span>
<span class="cm">				 * width.</span>
<span class="cm">				 */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RADEON_COPY_MT</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tex_width</span><span class="p">);</span>
					<span class="n">buffer</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">data</span> <span class="o">+=</span> <span class="n">tex_width</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

<span class="cp">#undef RADEON_COPY_MT</span>
		<span class="n">byte_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">2047</span><span class="p">)</span> <span class="o">*</span> <span class="n">blit_width</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET3</span><span class="p">(</span><span class="n">RADEON_CNTL_BITBLT_MULTI</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_GMC_SRC_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_DST_PITCH_OFFSET_CNTL</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_BRUSH_NONE</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">format</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_SRC_DATATYPE_COLOR</span> <span class="o">|</span>
			 <span class="n">RADEON_ROP3_S</span> <span class="o">|</span>
			 <span class="n">RADEON_DP_SRC_SOURCE_MEMORY</span> <span class="o">|</span>
			 <span class="n">RADEON_GMC_CLR_CMP_CNTL_DIS</span> <span class="o">|</span> <span class="n">RADEON_GMC_WR_MSK_DIS</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">spitch</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">texpitch</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">byte_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">%</span> <span class="mi">2048</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">height</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="n">COMMIT_RING</span><span class="p">();</span>

		<span class="n">radeon_cp_discard_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="cm">/* Update the input parameters for next time */</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Flush the pixel cache after the blit completes.  This ensures</span>
<span class="cm">	 * the texture data is written out to memory before rendering</span>
<span class="cm">	 * continues.</span>
<span class="cm">	 */</span>
	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">RADEON_FLUSH_CACHE</span><span class="p">();</span>
	<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="n">COMMIT_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_dispatch_stipple</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">stipple</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_RE_STIPPLE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0_TABLE</span><span class="p">(</span><span class="n">RADEON_RE_STIPPLE_DATA</span><span class="p">,</span> <span class="mi">31</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">stipple</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_apply_surface_regs</span><span class="p">(</span><span class="kt">int</span> <span class="n">surf_index</span><span class="p">,</span>
				      <span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">radeon_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_INFO</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">surf_index</span><span class="p">,</span>
		     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">surf_index</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_LOWER_BOUND</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">surf_index</span><span class="p">,</span>
		     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">surf_index</span><span class="p">].</span><span class="n">lower</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_UPPER_BOUND</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">surf_index</span><span class="p">,</span>
		     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">surf_index</span><span class="p">].</span><span class="n">upper</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Allocates a virtual surface</span>
<span class="cm"> * doesn&#39;t always allocate a real surface, will stretch an existing</span>
<span class="cm"> * surface when possible.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that refcount can be at most 2, since during a free refcount=3</span>
<span class="cm"> * might mean we have to allocate a new surface which might not always</span>
<span class="cm"> * be available.</span>
<span class="cm"> * For example : we allocate three contiguous surfaces ABC. If B is</span>
<span class="cm"> * freed, we suddenly need two surfaces to store A and C, which might</span>
<span class="cm"> * not always be available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_surface</span><span class="p">(</span><span class="n">drm_radeon_surface_alloc_t</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
			 <span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_virt_surface</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">virt_surface_index</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">new_upper</span><span class="p">,</span> <span class="n">new_lower</span><span class="p">;</span>

	<span class="n">new_lower</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="n">new_upper</span> <span class="o">=</span> <span class="n">new_lower</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_lower</span> <span class="o">&gt;=</span> <span class="n">new_upper</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">new_upper</span> <span class="o">&amp;</span> <span class="n">RADEON_SURF_ADDRESS_FIXED_MASK</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">RADEON_SURF_ADDRESS_FIXED_MASK</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">new_lower</span> <span class="o">&amp;</span> <span class="n">RADEON_SURF_ADDRESS_FIXED_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* make sure there is no overlap with existing surfaces */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">new_lower</span> <span class="o">&gt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">new_lower</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">((</span><span class="n">new_lower</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">new_upper</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* find a virtual surface */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">file_priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">virt_surface_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* try to reuse an existing surface */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* extend before */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">new_upper</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">virt_surface_index</span><span class="p">]);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span> <span class="o">=</span> <span class="n">new_lower</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span> <span class="o">=</span> <span class="n">new_upper</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">;</span>
			<span class="n">radeon_apply_surface_regs</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">virt_surface_index</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* extend after */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">new_lower</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">virt_surface_index</span><span class="p">]);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span> <span class="o">=</span> <span class="n">new_lower</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span> <span class="o">=</span> <span class="n">new_upper</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span><span class="p">;</span>
			<span class="n">radeon_apply_surface_regs</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">virt_surface_index</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* okay, we need a new one */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">virt_surface_index</span><span class="p">]);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span> <span class="o">=</span> <span class="n">new_lower</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span> <span class="o">=</span> <span class="n">new_upper</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">radeon_apply_surface_regs</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">virt_surface_index</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* we didn&#39;t find anything */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">free_surface</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
			<span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">lower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_virt_surface</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* find the virtual surface */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">lower</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">file_priv</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span>
				    <span class="n">lower</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">)</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span>
					    <span class="n">lower</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span>
				    <span class="n">upper</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">upper</span><span class="p">)</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span>
					    <span class="n">upper</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">;</span>

				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span><span class="n">refcount</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span>
				    <span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">].</span>
					    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">radeon_apply_surface_regs</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface_index</span><span class="p">,</span>
							  <span class="n">dev_priv</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_surfaces_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
				    <span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">file_priv</span> <span class="o">==</span> <span class="n">file_priv</span><span class="p">)</span>
			<span class="n">free_surface</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span>
				     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * IOCTL functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_surface_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_surface_alloc_t</span> <span class="o">*</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_surface</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_surface_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_surface_free_t</span> <span class="o">*</span><span class="n">memfree</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_surface</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">memfree</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_clear_t</span> <span class="o">*</span><span class="n">clear</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">drm_radeon_clear_rect_t</span> <span class="n">depth_boxes</span><span class="p">[</span><span class="n">RADEON_NR_SAREA_CLIPRECTS</span><span class="p">];</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">RADEON_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="n">RADEON_NR_SAREA_CLIPRECTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depth_boxes</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">depth_boxes</span><span class="p">,</span>
			       <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">depth_boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">radeon_cp_dispatch_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">depth_boxes</span><span class="p">);</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Not sure why this isn&#39;t set all the time:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_init_pageflip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_CRTC_OFFSET_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CRTC_OFFSET_CNTL</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">RADEON_CRTC_OFFSET_FLIP_CNTL</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_CRTC2_OFFSET_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CRTC2_OFFSET_CNTL</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">RADEON_CRTC_OFFSET_FLIP_CNTL</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">page_flipping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Swapping and flipping are different operations, need different ioctls.</span>
<span class="cm"> * They can &amp; should be intermixed to support multiple 3d windows.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">page_flipping</span><span class="p">)</span>
		<span class="n">radeon_do_init_pageflip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="n">radeon_cp_dispatch_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">RADEON_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="n">RADEON_NR_SAREA_CLIPRECTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">r600_cp_dispatch_swap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">radeon_cp_dispatch_swap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">ctx_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_vertex</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_radeon_vertex_t</span> <span class="o">*</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">drm_radeon_tcl_prim_t</span> <span class="n">prim</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d index=%d count=%d discard=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer index %d (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">&gt;</span> <span class="n">RADEON_PRIM_TYPE_3VRT_LINE_LIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer prim %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">VB_AGE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">!=</span> <span class="n">file_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;process %d using buffer owned by %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;sending pending buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Build up a prim_t record:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>	<span class="cm">/* not used? */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RADEON_UPLOAD_CLIPRECTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_state</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">,</span>
					      <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tex_state</span><span class="p">,</span>
					      <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_state failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RADEON_UPLOAD_TEX0IMAGES</span> <span class="o">|</span>
					       <span class="n">RADEON_UPLOAD_TEX1IMAGES</span> <span class="o">|</span>
					       <span class="n">RADEON_UPLOAD_TEX2IMAGES</span> <span class="o">|</span>
					       <span class="n">RADEON_REQUIRE_QUIESCENCE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">prim</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prim</span><span class="p">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>	<span class="cm">/* unused */</span>
		<span class="n">prim</span><span class="p">.</span><span class="n">prim</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">;</span>
		<span class="n">prim</span><span class="p">.</span><span class="n">numverts</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">prim</span><span class="p">.</span><span class="n">vc_format</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">vc_format</span><span class="p">;</span>

		<span class="n">radeon_cp_dispatch_vertex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_cp_discard_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_indices</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_radeon_indices_t</span> <span class="o">*</span><span class="n">elts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">drm_radeon_tcl_prim_t</span> <span class="n">prim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d index=%d start=%d end=%d discard=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
		  <span class="n">elts</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer index %d (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">elts</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">&gt;</span> <span class="n">RADEON_PRIM_TYPE_3VRT_LINE_LIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer prim %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">VB_AGE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">!=</span> <span class="n">file_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;process %d using buffer owned by %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;sending pending buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-=</span> <span class="n">RADEON_INDEX_PRIM_OFFSET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;misaligned buffer 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;no header 0x%x - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RADEON_UPLOAD_CLIPRECTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_state</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">,</span>
				      <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tex_state</span><span class="p">,</span>
				      <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_state failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RADEON_UPLOAD_TEX0IMAGES</span> <span class="o">|</span>
				       <span class="n">RADEON_UPLOAD_TEX1IMAGES</span> <span class="o">|</span>
				       <span class="n">RADEON_UPLOAD_TEX2IMAGES</span> <span class="o">|</span>
				       <span class="n">RADEON_REQUIRE_QUIESCENCE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Build up a prim_t record:</span>
<span class="cm">	 */</span>
	<span class="n">prim</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">prim</span><span class="p">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	<span class="n">prim</span><span class="p">.</span><span class="n">prim</span> <span class="o">=</span> <span class="n">elts</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">;</span>
	<span class="n">prim</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* offset from start of dma buffers */</span>
	<span class="n">prim</span><span class="p">.</span><span class="n">numverts</span> <span class="o">=</span> <span class="n">RADEON_MAX_VB_VERTS</span><span class="p">;</span>	<span class="cm">/* duh */</span>
	<span class="n">prim</span><span class="p">.</span><span class="n">vc_format</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">vc_format</span><span class="p">;</span>

	<span class="n">radeon_cp_dispatch_indices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elts</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_cp_discard_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_texture</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_texture_t</span> <span class="o">*</span><span class="n">tex</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">drm_radeon_tex_image_t</span> <span class="n">image</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">image</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;null texture image!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">drm_radeon_tex_image_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">VB_AGE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">r600_cp_dispatch_texture</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">tex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_cp_dispatch_texture</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">tex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_stipple</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_stipple_t</span> <span class="o">*</span><span class="n">stipple</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">stipple</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">radeon_cp_dispatch_stipple</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_radeon_indirect_t</span> <span class="o">*</span><span class="n">indirect</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;idx=%d s=%d e=%d d=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
		  <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indirect</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer index %d (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">indirect</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">!=</span> <span class="n">file_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;process %d using buffer owned by %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;sending pending buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indirect</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;reusing indirect: start=0x%x actual=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">VB_AGE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Dispatch the indirect buffer full of commands from the</span>
<span class="cm">	 * X server.  This is insecure and is thus only available to</span>
<span class="cm">	 * privileged clients.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">r600_cp_dispatch_indirect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Wait for the 3D stream to idle before the indirect buffer</span>
<span class="cm">		 * containing 2D acceleration commands is processed.</span>
<span class="cm">		 */</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="n">radeon_cp_dispatch_indirect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">indirect</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indirect</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_cp_discard_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_vertex2</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_radeon_vertex2_t</span> <span class="o">*</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">laststate</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d index=%d discard=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer index %d (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">VB_AGE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">!=</span> <span class="n">file_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;process %d using buffer owned by %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;sending pending buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">RADEON_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">laststate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">nr_prims</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_radeon_prim_t</span> <span class="n">prim</span><span class="p">;</span>
		<span class="n">drm_radeon_tcl_prim_t</span> <span class="n">tclprim</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prim</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prim</span><span class="p">.</span><span class="n">stateidx</span> <span class="o">!=</span> <span class="n">laststate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_radeon_state_t</span> <span class="n">state</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">prim</span><span class="p">.</span><span class="n">stateidx</span><span class="p">],</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_state2</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_state2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">laststate</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">stateidx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tclprim</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">tclprim</span><span class="p">.</span><span class="n">finish</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">finish</span><span class="p">;</span>
		<span class="n">tclprim</span><span class="p">.</span><span class="n">prim</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">prim</span><span class="p">;</span>
		<span class="n">tclprim</span><span class="p">.</span><span class="n">vc_format</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">vc_format</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prim</span><span class="p">.</span><span class="n">prim</span> <span class="o">&amp;</span> <span class="n">RADEON_PRIM_WALK_IND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tclprim</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">numverts</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">tclprim</span><span class="p">.</span><span class="n">numverts</span> <span class="o">=</span> <span class="n">RADEON_MAX_VB_VERTS</span><span class="p">;</span>	<span class="cm">/* duh */</span>

			<span class="n">radeon_cp_dispatch_indices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tclprim</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tclprim</span><span class="p">.</span><span class="n">numverts</span> <span class="o">=</span> <span class="n">prim</span><span class="p">.</span><span class="n">numverts</span><span class="p">;</span>
			<span class="n">tclprim</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* not used */</span>

			<span class="n">radeon_cp_dispatch_vertex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tclprim</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_cp_discard_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_emit_packets</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
			       <span class="n">drm_radeon_cmd_header_t</span> <span class="n">header</span><span class="p">,</span>
			       <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">header</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">packet_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">RADEON_MAX_STATE_PACKETS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">drm_buffer_unprocessed</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet size provided larger than data provided</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_check_and_fixup_packets</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
				<span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet verification failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="n">sz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">radeon_emit_scalars</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
					  <span class="n">drm_radeon_cmd_header_t</span> <span class="n">header</span><span class="p">,</span>
					  <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">scalars</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">scalars</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">scalars</span><span class="p">.</span><span class="n">stride</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_TCL_SCALAR_INDX_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stride</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_SCAL_INDX_DWORD_STRIDE_SHIFT</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0_TABLE</span><span class="p">(</span><span class="n">RADEON_SE_TCL_SCALAR_DATA_REG</span><span class="p">,</span> <span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* God this is ugly</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">radeon_emit_scalars2</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
					   <span class="n">drm_radeon_cmd_header_t</span> <span class="n">header</span><span class="p">,</span>
					   <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">scalars</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">header</span><span class="p">.</span><span class="n">scalars</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">scalars</span><span class="p">.</span><span class="n">stride</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_TCL_SCALAR_INDX_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stride</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_SCAL_INDX_DWORD_STRIDE_SHIFT</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0_TABLE</span><span class="p">(</span><span class="n">RADEON_SE_TCL_SCALAR_DATA_REG</span><span class="p">,</span> <span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">radeon_emit_vectors</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
					  <span class="n">drm_radeon_cmd_header_t</span> <span class="n">header</span><span class="p">,</span>
					  <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">vectors</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">vectors</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">vectors</span><span class="p">.</span><span class="n">stride</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_SE_TCL_STATE_FLUSH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_TCL_VECTOR_INDX_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stride</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_VEC_INDX_OCTWORD_STRIDE_SHIFT</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0_TABLE</span><span class="p">(</span><span class="n">RADEON_SE_TCL_VECTOR_DATA_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">radeon_emit_veclinear</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
					  <span class="n">drm_radeon_cmd_header_t</span> <span class="n">header</span><span class="p">,</span>
					  <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">veclinear</span><span class="p">.</span><span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">veclinear</span><span class="p">.</span><span class="n">addr_lo</span> <span class="o">|</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">veclinear</span><span class="p">.</span><span class="n">addr_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sz</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">drm_buffer_unprocessed</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">OUT_RING_REG</span><span class="p">(</span><span class="n">RADEON_SE_TCL_STATE_FLUSH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_SE_TCL_VECTOR_INDX_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RADEON_VEC_INDX_OCTWORD_STRIDE_SHIFT</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0_TABLE</span><span class="p">(</span><span class="n">RADEON_SE_TCL_VECTOR_DATA_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_emit_packet3</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
			       <span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdsz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_check_and_fixup_packet3</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="n">cmdbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdsz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet verification failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="n">cmdsz</span><span class="p">);</span>
	<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cmdsz</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_emit_packet3_cliprect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
					<span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">orig_nbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="n">box</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdsz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="n">__user</span> <span class="o">*</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_check_and_fixup_packet3</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						  <span class="n">cmdbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdsz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet verification failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orig_nbox</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_FROM_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">box</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">box</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="cm">/* FIXME The second and subsequent times round</span>
<span class="cm">			 * this loop, send a WAIT_UNTIL_3D_IDLE before</span>
<span class="cm">			 * calling emit_clip_rect(). This fixes a</span>
<span class="cm">			 * lockup on fast machines when sending</span>
<span class="cm">			 * several cliprects with a cmdbuf, as when</span>
<span class="cm">			 * waving a 2D window over a 3D</span>
<span class="cm">			 * window. Something in the commands from user</span>
<span class="cm">			 * space seems to hang the card when they&#39;re</span>
<span class="cm">			 * sent several times in a row. That would be</span>
<span class="cm">			 * the correct place to fix it but this works</span>
<span class="cm">			 * around it until I can figure that out - Tim</span>
<span class="cm">			 * Smith */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>
				<span class="n">ADVANCE_RING</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">radeon_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">box</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="n">cmdsz</span><span class="p">);</span>
		<span class="n">OUT_RING_DRM_BUFFER</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cmdsz</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nl">out:</span>
	<span class="n">drm_buffer_advance</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cmdsz</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_emit_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_WAIT_2D</span>:
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_2D_IDLE</span><span class="p">();</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_WAIT_3D</span>:
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_3D_IDLE</span><span class="p">();</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_WAIT_2D</span> <span class="o">|</span> <span class="n">RADEON_WAIT_3D</span>:
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">RADEON_WAIT_UNTIL_IDLE</span><span class="p">();</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_cmdbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drm_radeon_cmd_header_t</span> <span class="n">stack_header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">drm_radeon_kcmd_buffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_nbox</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">RING_SPACE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">VB_AGE_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">bufsz</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">||</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">bufsz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate an in-kernel area and copy in the cmdbuf.  Do this to avoid</span>
<span class="cm">	 * races between checking values and using those values in other code,</span>
<span class="cm">	 * and simply to avoid a lot of function calls to copy in data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">bufsz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">drm_buffer_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">bufsz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">drm_buffer_copy_from_user</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
						<span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">bufsz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_buffer_free</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">orig_nbox</span> <span class="o">=</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">==</span> <span class="n">UCODE_R300</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">r300_do_cp_cmdbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">);</span>

		<span class="n">drm_buffer_free</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* microcode_version != r300 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">drm_buffer_unprocessed</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stack_header</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">drm_radeon_cmd_header_t</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
		<span class="n">header</span> <span class="o">=</span> <span class="n">drm_buffer_read_object</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">stack_header</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">stack_header</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cmd_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RADEON_CMD_PACKET</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_PACKET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_packets</span>
			    <span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_packets failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_SCALARS</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_SCALARS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_scalars</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_scalars failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_VECTORS</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_VECTORS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_vectors</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_vectors failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_DMA_DISCARD</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_DMA_DISCARD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">buf_idx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer index %d (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">idx</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">!=</span> <span class="n">file_priv</span> <span class="o">||</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad buffer %p %p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
					  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">radeon_cp_discard_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_PACKET3</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_PACKET3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_packet3</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_packet3 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_PACKET3_CLIP</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_PACKET3_CLIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_packet3_cliprect</span>
			    <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="n">orig_nbox</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_packet3_clip failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_SCALARS2</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_SCALARS2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_scalars2</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_scalars2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RADEON_CMD_WAIT</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_wait failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RADEON_CMD_VECLINEAR</span>:
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;RADEON_CMD_VECLINEAR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radeon_emit_veclinear</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;radeon_emit_veclinear failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad cmd_type %d at byte %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">header</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cmd_type</span><span class="p">,</span>
				  <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">iterator</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drm_buffer_free</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">err:</span>
	<span class="n">drm_buffer_free</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_getparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_getparam_t</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRM_CURRENTPID</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_GART_BUFFER_OFFSET</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_LAST_FRAME</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">last_frame_reads</span><span class="o">++</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">GET_SCRATCH</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_LAST_DISPATCH</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">GET_SCRATCH</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_LAST_CLEAR</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">last_clear_reads</span><span class="o">++</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">GET_SCRATCH</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_IRQ_NR</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">drm_dev_to_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_GART_BASE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_REGISTER_HANDLE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_STATUS_HANDLE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
		<span class="cm">/*</span>
<span class="cm">		 * This ioctl() doesn&#39;t work on 64-bit platforms because hw_lock is a</span>
<span class="cm">		 * pointer which can&#39;t fit into an int-sized variable.  According to</span>
<span class="cm">		 * Michel Dänzer, the ioctl() is only used on embedded platforms, so</span>
<span class="cm">		 * not supporting it shouldn&#39;t be a problem.  If the same functionality</span>
<span class="cm">		 * is needed on 64-bit platforms, a new ioctl() would have to be added,</span>
<span class="cm">		 * so backwards-compatibility for the embedded platforms can be</span>
<span class="cm">		 * maintained.  --davidm 4-Feb-2004.</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_SAREA_HANDLE</span>:
		<span class="cm">/* The lock is the first dword in the sarea. */</span>
		<span class="cm">/* no users of this parameter */</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_GART_TEX_HANDLE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_textures_offset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_SCRATCH_OFFSET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">R600_SCRATCH_REG_OFFSET</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RADEON_SCRATCH_REG_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_CARD_TYPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_PCIE</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RADEON_CARD_PCIE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RADEON_CARD_AGP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RADEON_CARD_PCI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_VBLANK_CRTC</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">radeon_vblank_crtc_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_FB_LOCATION</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">radeon_read_fb_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_NUM_GB_PIPES</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_PARAM_NUM_Z_PIPES</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_z_pipes</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;Invalid parameter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;copy_to_user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_setparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_radeon_setparam_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_driver_file_fields</span> <span class="o">*</span><span class="n">radeon_priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_SETPARAM_FB_LOCATION</span>:
		<span class="n">radeon_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
		<span class="n">radeon_priv</span><span class="o">-&gt;</span><span class="n">radeon_fb_delta</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">-</span>
		    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_SETPARAM_SWITCH_TILING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;color tiling disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DST_TILE_MACRO</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_DST_TILE_MACRO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
				<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tiling_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;color tiling enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span> <span class="o">|=</span> <span class="n">RADEON_DST_TILE_MACRO</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span> <span class="o">|=</span> <span class="n">RADEON_DST_TILE_MACRO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
				<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tiling_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_SETPARAM_PCIGART_LOCATION</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pcigart_offset</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pcigart_offset_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_SETPARAM_NEW_MEMMAP</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">new_memmap</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_SETPARAM_PCIGART_TABLE_SIZE</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">table_size</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">table_size</span> <span class="o">&lt;</span> <span class="n">RADEON_PCIGART_TABLE_SIZE</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">table_size</span> <span class="o">=</span> <span class="n">RADEON_PCIGART_TABLE_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_SETPARAM_VBLANK_CRTC</span>:
		<span class="k">return</span> <span class="n">radeon_vblank_crtc_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;Invalid parameter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* When a client dies:</span>
<span class="cm"> *    - Check for and clean up flipped page state</span>
<span class="cm"> *    - Free any alloced GART memory.</span>
<span class="cm"> *    - Free any alloced radeon surfaces.</span>
<span class="cm"> *</span>
<span class="cm"> * DRM infrastructure takes care of reclaiming dma buffers.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">radeon_driver_preclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">page_flipping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">radeon_mem_release</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_heap</span><span class="p">);</span>
		<span class="n">radeon_mem_release</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_heap</span><span class="p">);</span>
		<span class="n">radeon_surfaces_release</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_driver_lastclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_surfaces_release</span><span class="p">(</span><span class="n">PCIGART_FILE_PRIV</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">);</span>
	<span class="n">radeon_do_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_driver_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_driver_file_fields</span> <span class="o">*</span><span class="n">radeon_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">radeon_priv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">radeon_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">radeon_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span>
		<span class="n">radeon_priv</span><span class="o">-&gt;</span><span class="n">radeon_fb_delta</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">radeon_priv</span><span class="o">-&gt;</span><span class="n">radeon_fb_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_driver_postclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_radeon_driver_file_fields</span> <span class="o">*</span><span class="n">radeon_priv</span> <span class="o">=</span>
	    <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">radeon_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_ioctl_desc</span> <span class="n">radeon_ioctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_INIT</span><span class="p">,</span> <span class="n">radeon_cp_init</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_START</span><span class="p">,</span> <span class="n">radeon_cp_start</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_STOP</span><span class="p">,</span> <span class="n">radeon_cp_stop</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_RESET</span><span class="p">,</span> <span class="n">radeon_cp_reset</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_IDLE</span><span class="p">,</span> <span class="n">radeon_cp_idle</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CP_RESUME</span><span class="p">,</span> <span class="n">radeon_cp_resume</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_RESET</span><span class="p">,</span> <span class="n">radeon_engine_reset</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_FULLSCREEN</span><span class="p">,</span> <span class="n">radeon_fullscreen</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SWAP</span><span class="p">,</span> <span class="n">radeon_cp_swap</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CLEAR</span><span class="p">,</span> <span class="n">radeon_cp_clear</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_VERTEX</span><span class="p">,</span> <span class="n">radeon_cp_vertex</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INDICES</span><span class="p">,</span> <span class="n">radeon_cp_indices</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_TEXTURE</span><span class="p">,</span> <span class="n">radeon_cp_texture</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_STIPPLE</span><span class="p">,</span> <span class="n">radeon_cp_stipple</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INDIRECT</span><span class="p">,</span> <span class="n">radeon_cp_indirect</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_VERTEX2</span><span class="p">,</span> <span class="n">radeon_cp_vertex2</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CMDBUF</span><span class="p">,</span> <span class="n">radeon_cp_cmdbuf</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_GETPARAM</span><span class="p">,</span> <span class="n">radeon_cp_getparam</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_FLIP</span><span class="p">,</span> <span class="n">radeon_cp_flip</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_ALLOC</span><span class="p">,</span> <span class="n">radeon_mem_alloc</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_FREE</span><span class="p">,</span> <span class="n">radeon_mem_free</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_INIT_HEAP</span><span class="p">,</span> <span class="n">radeon_mem_init_heap</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_IRQ_EMIT</span><span class="p">,</span> <span class="n">radeon_irq_emit</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_IRQ_WAIT</span><span class="p">,</span> <span class="n">radeon_irq_wait</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SETPARAM</span><span class="p">,</span> <span class="n">radeon_cp_setparam</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SURF_ALLOC</span><span class="p">,</span> <span class="n">radeon_surface_alloc</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_SURF_FREE</span><span class="p">,</span> <span class="n">radeon_surface_free</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">RADEON_CS</span><span class="p">,</span> <span class="n">r600_cs_legacy_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">)</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">radeon_max_ioctl</span> <span class="o">=</span> <span class="n">DRM_ARRAY_SIZE</span><span class="p">(</span><span class="n">radeon_ioctls</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
